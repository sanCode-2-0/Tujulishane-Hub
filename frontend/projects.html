<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RMNCAH</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Tailwind CSS (with custom config using inline script) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',   // Custom Blue
                        secondary: '#f59e0b', // Custom Amber
                        accent: '#10b981',    // Custom Green
                        dark: '#1f2937',      // Gray-800
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- WARNING: cdn.tailwindcss.com should not be used in production. Use PostCSS or CLI for production builds. -->
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/mobile.css">
    <!-- Backend URL Configuration -->
    <script src="./config.js"></script>
    <script src="./set-base-url.js"></script>
    <!-- Modal Utilities -->
    <script src="./modal-utils.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="auth.js"></script>
    <!-- Optional: Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css" />
    <style>
        [x-cloak] { display: none !important; }
        .fade-slide-enter {
            opacity: 0;
            transform: translateY(20px);
        }

        .fade-slide-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.4s ease;
        }

        .fade-slide-leave {
            opacity: 1;
            transform: translateY(0);
        }

        .fade-slide-leave-active {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        /* Custom table tweaks for professional look */
        .modern-table {
            width: 100%;
            table-layout: auto;
        }
        .modern-table thead th {
            position: sticky;
            top: 0;
            background: #f9fafb;
            z-index: 2;
        }

        .modern-table tbody tr {
            transition: background 0.2s;
        }

        .modern-table tbody tr:nth-child(even) {
            background: #f3f4f6;
        }

        .modern-table tbody tr:hover {
            background: #e0e7ef;
        }

        /* Loading spinner */
        .projects-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            gap: 1rem;
        }
        .projects-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Custom map marker styles */
        .custom-marker-icon {
            background: transparent;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease;
        }
        
        .custom-marker-icon:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
        }
        
        .custom-marker-icon svg {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }
        
        /* Ensure markers are visible at all zoom levels */
        .leaflet-marker-icon {
            z-index: 1000 !important;
        }
    </style>

</head>

<body x-data="projectsApp()" x-init="init()" class="text-gray-800">
    <script>
        window.projectsApp = function projectsApp() {
            return {
                announcements: [],
                myProjects: [],
                organizations: [],
                myCollaborationRequests: [], // Track user's submitted requests
                chatMessages: [],
                sendingMessage: false,
                newMessage: "",
                searchText: "",
                filterStatus: "",
                sortOrder: "NEWEST",
                activeSlide: 0,
                media: [
                    { type: 'image', src: 'resources/images/main-1.jpg' },
                    { type: 'image', src: 'resources/images/main-2.jpg' },
                    { type: 'image', src: 'resources/images/main-3.jpg' }
                ],
                loading: true,
                projectsLoading: true,
                creating: false,
                submitting: false,
                showCreateModal: false,
                showDetailsModal: false,
                showRequestModal: false,
                selectedAnnouncement: null,
                userRole: null, // Will be set in init from user object
                currentUser: null, // Store current user data including email
                newAnnouncement: {
                    projectId: "",
                    title: "",
                    content: "",
                    deadline: "",
                },
                collaborationRequest: {
                    organizationId: "",
                    proposedContribution: "",
                },

                async init() {
                    // Wait for auth.js to load user data and get it directly
                    const user = await this.waitForAuth();

                    // Set user role and store user data from the returned user object
                    if (user && user.role) {
                        this.userRole = user.role;
                        this.currentUser = user; // Store full user object
                    } else {
                        // Fallback: try to read from localStorage
                        const userStr = localStorage.getItem("currentUser");
                        if (userStr) {
                            try {
                                const parsedUser = JSON.parse(userStr);
                                this.userRole = parsedUser.role;
                                this.currentUser = parsedUser;
                            } catch (e) {
                                console.error("Error parsing user data:", e);
                            }
                        }
                        // Final fallback to userRole if it exists
                        if (!this.userRole) {
                            this.userRole = localStorage.getItem("userRole");
                        }
                    }
                    console.log("üîç User Role:", this.userRole); // Debug log
                    console.log("üîç Current User:", this.currentUser); // Debug log

                    // Populate user dropdown in navigation
                    if (this.currentUser) {
                        console.log("üë§ Populating user dropdown...");
                        this.populateUserDropdown(this.currentUser);
                    }

                    await this.loadAnnouncements();

                    // Always try to load projects if user is authenticated
                    // The backend will handle authorization
                    const token = localStorage.getItem("accessToken");
                    if (token) {
                        console.log("üîç User authenticated, loading projects...");
                        this.projectsLoading = true;
                        await this.loadMyProjects();
                        this.projectsLoading = false;
                        await this.loadOrganizations();
                        // Load user's collaboration requests to prevent duplicates
                        await this.loadMyCollaborationRequests();
                    } else {
                        console.warn("‚ö†Ô∏è No access token found, skipping project load");
                        this.projectsLoading = false;
                    }
                },

                // Populate user dropdown with current user data
                populateUserDropdown(user) {
                    try {
                        const userDisplayName =
                            document.getElementById("userDisplayName");
                        const userNameDisplay =
                            document.getElementById("userNameDisplay");
                        const userEmailDisplay =
                            document.getElementById("userEmailDisplay");
                        const userRoleDisplay =
                            document.getElementById("userRoleDisplay");
                        const userStatusDisplay =
                            document.getElementById("userStatusDisplay");

                        if (userDisplayName)
                            userDisplayName.textContent = user.name || "User";
                        if (userNameDisplay)
                            userNameDisplay.textContent = user.name || "Loading...";
                        if (userEmailDisplay)
                            userEmailDisplay.textContent = user.email || "";
                        if (userRoleDisplay)
                            userRoleDisplay.textContent = user.role || "N/A";
                        if (userStatusDisplay) {
                            userStatusDisplay.textContent = user.status || "N/A";
                            // Update status color based on status
                            userStatusDisplay.className =
                                user.status === "ACTIVE"
                                    ? "font-medium text-green-600"
                                    : "font-medium text-gray-600";
                        }

                        // Show role-based navs
                        if (
                            user.role === "ADMIN" ||
                            user.role === "SUPER_ADMIN" ||
                            user.role === "SUPER_ADMIN_REVIEWER" ||
                            user.role === "SUPER_ADMIN_APPROVER" ||
                            user.role === "SUPER_ADMIN_REVIEWER" ||
                            user.role === "SUPER_ADMIN_APPROVER"
                        ) {
                            const adminNav = document.getElementById("adminNav");
                            if (adminNav) adminNav.classList.remove("hidden");
                        }
                        if (user.role === "DONOR") {
                            const donorNav = document.getElementById("donorNav");
                            if (donorNav) donorNav.classList.remove("hidden");
                        }

                        console.log("‚úÖ User dropdown populated successfully!");
                    } catch (error) {
                        console.error("‚ùå Error populating user dropdown:", error);
                    }
                },

                async waitForAuth() {
                    // Wait for AuthManager to be available and initialized
                    let attempts = 0;
                    while (attempts < 50) {
                        // Max 5 seconds
                        if (
                            window.authManager &&
                            typeof window.authManager.getCurrentUser === "function"
                        ) {
                            // Try to get current user and return it directly
                            try {
                                const user = await window.authManager.getCurrentUser();
                                return user; // Return the user object
                            } catch (e) {
                                // User not logged in or error
                                return null;
                            }
                        }
                        await new Promise((resolve) => setTimeout(resolve, 100));
                        attempts++;
                    }
                    return null; // Timeout - no auth available
                },

                async loadAnnouncements() {
                    try {
                        const response = await fetch(
                            `${window.BASE_URL}/api/announcements`
                        );
                        const data = await response.json();
                        if (data.status === 200) {
                            this.announcements = data.data;
                        }
                    } catch (error) {
                        console.error("Error loading announcements:", error);
                        await showAlert("Failed to load announcements", "Error", "error");
                    } finally {
                        this.loading = false;
                    }
                },

                async loadMyProjects() {
                    try {
                        const token = localStorage.getItem("accessToken");
                        console.log(
                            "üîç Loading my projects with token:",
                            token ? "Present" : "Missing"
                        );

                        const response = await fetch(
                            `${window.BASE_URL}/api/projects/my-projects`,
                            {
                                headers: { Authorization: `Bearer ${token}` },
                            }
                        );

                        console.log("üîç My projects response status:", response.status);

                        if (!response.ok) {
                            console.error(
                                "‚ùå Failed to load projects. Status:",
                                response.status
                            );
                            if (response.status === 403) {
                                console.error(
                                    "‚ùå 403 Forbidden - You may not have PARTNER role"
                                );
                            } else if (response.status === 401) {
                                console.error(
                                    "‚ùå 401 Unauthorized - Token may be invalid or expired"
                                );
                            }
                            this.myProjects = [];
                            return;
                        }

                        const data = await response.json();
                        console.log("üîç My projects response data:", data);

                        if (data.status === 200) {
                            this.myProjects = data.data || [];
                            console.log(
                                "‚úÖ Loaded projects:",
                                this.myProjects.length,
                                "projects"
                            );
                            console.log("üìã Projects:", this.myProjects);
                        } else {
                            console.warn("‚ö†Ô∏è Unexpected response status:", data.status);
                            this.myProjects = [];
                        }
                    } catch (error) {
                        console.error("‚ùå Error loading projects:", error);
                        this.myProjects = [];
                    }
                },

                async loadOrganizations() {
                    try {
                        const token = localStorage.getItem("accessToken");
                        const response = await fetch(
                            `${window.BASE_URL}/api/organizations`,
                            {
                                headers: { Authorization: `Bearer ${token}` },
                            }
                        );

                        // Check if response is OK before parsing JSON
                        if (!response.ok) {
                            // Silently handle 403 - organizations endpoint may be restricted
                            this.organizations = []; // Set empty array
                            return;
                        }

                        const data = await response.json();
                        if (data.status === 200) {
                            this.organizations = data.data;
                        }
                    } catch (error) {
                        // Silently handle errors - organizations are optional
                        this.organizations = []; // Set empty array on error
                    }
                },

                async loadMyCollaborationRequests() {
                    try {
                        const token = localStorage.getItem("accessToken");
                        const response = await fetch(
                            `${window.BASE_URL}/api/collaboration-requests/my-requests`,
                            {
                                headers: { Authorization: `Bearer ${token}` },
                            }
                        );

                        if (!response.ok) {
                            console.warn(
                                "Could not load collaboration requests:",
                                response.status
                            );
                            this.myCollaborationRequests = [];
                            return;
                        }

                        const data = await response.json();
                        if (data.status === 200) {
                            this.myCollaborationRequests = data.data || [];
                            console.log(
                                "‚úÖ Loaded collaboration requests:",
                                this.myCollaborationRequests.length
                            );
                        } else {
                            this.myCollaborationRequests = [];
                        }
                    } catch (error) {
                        console.error("Error loading collaboration requests:", error);
                        this.myCollaborationRequests = [];
                    }
                },

                async createAnnouncement() {
                    this.creating = true;
                    try {
                        const token = localStorage.getItem("accessToken");
                        const response = await fetch(
                            `${window.BASE_URL}/api/announcements`,
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${token}`,
                                },
                                body: JSON.stringify(this.newAnnouncement),
                            }
                        );

                        // Check if response is OK before parsing JSON
                        if (!response.ok) {
                            if (response.status === 403) {
                                await showAlert(
                                    "Permission denied. You may not have access to create announcements.",
                                    "Permission Denied",
                                    "error"
                                );
                            } else if (response.status === 401) {
                                await showAlert(
                                    "You must be logged in to create announcements.",
                                    "Authentication Required",
                                    "warning"
                                );
                            } else {
                                await showAlert(
                                    `Error: Server returned status ${response.status}`,
                                    "Error",
                                    "error"
                                );
                            }
                            return;
                        }

                        const data = await response.json();

                        if (data.status === 201) {
                            await showAlert(
                                "Announcement created successfully!",
                                "Success",
                                "success"
                            );
                            this.showCreateModal = false;
                            this.newAnnouncement = {
                                projectId: "",
                                title: "",
                                content: "",
                                deadline: "",
                            };
                            await this.loadAnnouncements();
                        } else {
                            await showAlert(
                                "Error: " + (data.message || "Unknown error occurred"),
                                "Error",
                                "error"
                            );
                        }
                    } catch (error) {
                        console.error("Error creating announcement:", error);
                        await showAlert(
                            "Failed to create announcement. Please try again.",
                            "Error",
                            "error"
                        );
                    } finally {
                        this.creating = false;
                    }
                },

                viewDetails(announcement) {
                    this.selectedAnnouncement = announcement;
                    this.showDetailsModal = true;
                    this.loadChatMessages(announcement.id);
                },

                requestCollaboration(announcement) {
                    this.selectedAnnouncement = announcement;
                    this.showRequestModal = true;
                    this.showDetailsModal = false;
                },

                async submitRequest() {
                    this.submitting = true;
                    try {
                        const token = localStorage.getItem("accessToken");

                        // Prepare request payload - only include organizationId if it's not empty
                        const payload = {
                            proposedContribution:
                                this.collaborationRequest.proposedContribution,
                        };

                        // Only add organizationId if it's set (not empty string)
                        if (this.collaborationRequest.organizationId) {
                            payload.organizationId = parseInt(
                                this.collaborationRequest.organizationId
                            );
                        }

                        const response = await fetch(
                            `${window.BASE_URL}/api/collaboration-requests/announcements/${this.selectedAnnouncement.id}`,
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${token}`,
                                },
                                body: JSON.stringify(payload),
                            }
                        );

                        // Always try to parse JSON to get the error message
                        const data = await response.json();

                        // Check if response is OK
                        if (!response.ok) {
                            if (response.status === 403) {
                                await showAlert(
                                    "Permission denied: " +
                                    (data.message ||
                                        "You may not have access to submit collaboration requests."),
                                    "Permission Denied",
                                    "error"
                                );
                            } else if (response.status === 401) {
                                await showAlert(
                                    "Authentication required: " +
                                    (data.message ||
                                        "You must be logged in to submit a collaboration request."),
                                    "Authentication Required",
                                    "warning"
                                );
                            } else if (response.status === 400) {
                                await showAlert(
                                    "Invalid request: " +
                                    (data.message ||
                                        "Please check your input and try again."),
                                    "Invalid Request",
                                    "error"
                                );
                            } else {
                                await showAlert(
                                    `Error: ${data.message ||
                                    "Server returned status " + response.status
                                    }`,
                                    "Error",
                                    "error"
                                );
                            }
                            return;
                        }

                        if (data.status === 201) {
                            await showAlert(
                                "Collaboration request submitted successfully! The Ministry of Health will review your request.",
                                "Success",
                                "success"
                            );
                            this.showRequestModal = false;
                            this.collaborationRequest = {
                                organizationId: "",
                                proposedContribution: "",
                            };
                            // Reload collaboration requests to update the UI
                            await this.loadMyCollaborationRequests();
                        } else {
                            await showAlert(
                                "Error: " + (data.message || "Unknown error occurred"),
                                "Error",
                                "error"
                            );
                        }
                    } catch (error) {
                        console.error("Error submitting request:", error);
                        await showAlert(
                            "Failed to submit collaboration request. Please try again.",
                            "Error",
                            "error"
                        );
                    } finally {
                        this.submitting = false;
                    }
                },

                // Helper method to check if announcement was created by current user
                isOwnAnnouncement(announcement) {
                    if (!this.currentUser || !announcement || !announcement.createdBy) {
                        console.log("üîç isOwnAnnouncement: Missing data", {
                            hasCurrentUser: !!this.currentUser,
                            hasAnnouncement: !!announcement,
                            hasCreatedBy: !!(announcement && announcement.createdBy),
                        });
                        return false;
                    }
                    // Compare by email as it's unique
                    const isOwn =
                        this.currentUser.email === announcement.createdBy.email;
                    console.log("üîç isOwnAnnouncement:", {
                        currentUserEmail: this.currentUser.email,
                        createdByEmail: announcement.createdBy.email,
                        isOwn: isOwn,
                    });
                    return isOwn;
                },

                // Helper method to check if user has already requested collaboration for this announcement
                hasAlreadyRequested(announcement) {
                    if (!announcement || !this.myCollaborationRequests) {
                        return false;
                    }

                    const hasRequested = this.myCollaborationRequests.some(
                        (request) =>
                            request.announcement &&
                            request.announcement.id === announcement.id
                    );

                    console.log("üîç hasAlreadyRequested:", {
                        announcementId: announcement.id,
                        totalRequests: this.myCollaborationRequests.length,
                        hasRequested: hasRequested,
                    });

                    return hasRequested;
                },

                isDeadlineImminent(deadline) {
                    if (!deadline) return false;
                    const now = new Date();
                    const deadlineDate = new Date(deadline);
                    const diffTime = deadlineDate - now;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays <= 7 && diffDays >= 0; // Imminent if within 7 days and not past
                },

                async loadChatMessages(announcementId) {
                    try {
                        const token = localStorage.getItem("accessToken");
                        const response = await fetch(`${window.BASE_URL}/api/announcements/${announcementId}/messages`, {
                            headers: { Authorization: `Bearer ${token}` }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.chatMessages = data.data || [];
                        }
                    } catch (error) {
                        console.error("Error loading chat messages:", error);
                    }
                },

                async sendMessage() {
                    if (!this.newMessage.trim()) return;
                    this.sendingMessage = true;
                    try {
                        const token = localStorage.getItem("accessToken");
                        const response = await fetch(`${window.BASE_URL}/api/announcements/${this.selectedAnnouncement.id}/messages`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: `Bearer ${token}`
                            },
                            body: JSON.stringify({ message: this.newMessage })
                        });
                        if (response.ok) {
                            this.newMessage = "";
                            await this.loadChatMessages(this.selectedAnnouncement.id);
                        } else {
                            await showAlert("Failed to send message", "Error", "error");
                        }
                    } catch (error) {
                        console.error("Error sending message:", error);
                        await showAlert("Failed to send message", "Error", "error");
                    } finally {
                        this.sendingMessage = false;
                    }
                },

                async editMessage(msg) {
                    const newMessage = prompt("Edit message:", msg.message);
                    if (newMessage && newMessage.trim() && newMessage !== msg.message) {
                        try {
                            const token = localStorage.getItem("accessToken");
                            const response = await fetch(`${window.BASE_URL}/api/announcements/${this.selectedAnnouncement.id}/messages/${msg.id}`, {
                                method: "PUT",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${token}`
                                },
                                body: JSON.stringify({ message: newMessage })
                            });
                            if (response.ok) {
                                await this.loadChatMessages(this.selectedAnnouncement.id);
                            } else {
                                await showAlert("Failed to edit message", "Error", "error");
                            }
                        } catch (error) {
                            console.error("Error editing message:", error);
                            await showAlert("Failed to edit message", "Error", "error");
                        }
                    }
                },

                async deleteMessage(msg) {
                    if (confirm("Are you sure you want to delete this message?")) {
                        try {
                            const token = localStorage.getItem("accessToken");
                            const response = await fetch(`${window.BASE_URL}/api/announcements/${this.selectedAnnouncement.id}/messages/${msg.id}`, {
                                method: "DELETE",
                                headers: {
                                    Authorization: `Bearer ${token}`
                                }
                            });
                            if (response.ok) {
                                await this.loadChatMessages(this.selectedAnnouncement.id);
                            } else {
                                await showAlert("Failed to delete message", "Error", "error");
                            }
                        } catch (error) {
                            console.error("Error deleting message:", error);
                            await showAlert("Failed to delete message", "Error", "error");
                        }
                    }
                },
            };
        };
    </script>
    <!-- Authentication Check -->
    <script>
        // Check authentication on page load
        (function () {
            const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
            if (!token) {
                console.warn('[Security] No authentication token found, redirecting to login');
                window.location.href = 'index.html';
                return;
            }

            // Verify token format (JWT should have 3 parts)
            const parts = token.split('.');
            if (parts.length !== 3) {
                console.warn('[Security] Invalid token format, redirecting to login');
                localStorage.removeItem('accessToken');
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'index.html';
                return;
            }

            console.log('[Security] Authentication check passed');
        })();
    </script>
    <!-- Nav Start -->
    <div class="" id="nav-placeholder"></div>
    <!-- Nav End -->

    <div class="min-h-screen pt-12 bg-gray-100">



        <!-- Reject Project Modal -->
        <div id="rejectProjectModal"
            class="fixed inset-0 z-[1056] hidden items-center justify-center backdrop-blur-md bg-black/50 px-4 py-6"
            role="dialog" aria-modal="true" aria-labelledby="rejectProjectTitle">
            <div class="w-full max-w-md rounded-xl bg-white shadow-2xl">
                <div class="flex items-center justify-between border-b border-gray-100 px-6 py-4">
                    <h3 class="text-lg font-semibold text-blue-900" id="rejectProjectTitle">Reject Project</h3>
                    <button type="button" class="text-gray-400 hover:text-gray-600" aria-label="Close"
                        onclick="closeRejectModal()">
                        <span class="sr-only">Close</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div class="px-6 py-5 space-y-4">
                    <p class="text-sm text-gray-600">Select a reason to reject this project. The partner will be
                        notified of the chosen reason.</p>
                    <label class="block text-sm font-medium text-gray-700" for="rejectReasonSelect">Rejection
                        reason</label>
                    <select id="rejectReasonSelect"
                        class="mt-1 block w-full rounded-md border border-gray-300 bg-white py-2 px-3 text-sm text-gray-700 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="" selected disabled>Choose a reason</option>
                        <option value="Incomplete supporting documents">Incomplete supporting documents</option>
                        <option value="Budget details are unclear">Budget details are unclear</option>
                        <option value="Project scope does not align with priorities">Project scope does not align with
                            priorities</option>
                        <option value="Missing required compliance approvals">Missing required compliance approvals
                        </option>
                        <option value="Duplicate submission or already funded">Duplicate submission or already funded
                        </option>
                    </select>
                    <p id="rejectReasonError" class="hidden text-sm text-red-600">Please choose a reason before
                        submitting.</p>
                </div>
                <div class="flex items-center justify-end gap-3 border-t border-gray-100 bg-gray-50 px-6 py-4">
                    <button type="button"
                        class="rounded-md border border-gray-200 px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100"
                        onclick="closeRejectModal()">Cancel</button>
                    <button type="button"
                        class="rounded-md bg-red-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2"
                        onclick="submitProjectRejection()">Reject project</button>
                </div>
            </div>
        </div>

        <!-- Project Details Modal -->
        <div id="projectDetailsModal"
            class="hidden fixed inset-0 z-50 flex backdrop-blur-md items-center justify-center bg-black bg-opacity-50"
            aria-hidden="true" aria-modal="true" aria-labelledby="projectDetailsTitle">
            <div class="relative w-full max-w-4xl max-h-[90vh] overflow-y-auto bg-white rounded-lg shadow-xl">
                <div class="sticky top-0 z-10 flex items-center justify-between p-5 bg-white border-b border-gray-200">
                    <h2 id="projectDetailsTitle" class="text-xl font-semibold text-blue-900">Project Details</h2>
                    <button type="button" class="text-gray-400 hover:text-gray-600"
                        onclick="closeProjectDetailsModal()">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="projectDetailsContent" class="p-6">
                    <p class="text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading...</p>
                </div>
            </div>
        </div>

        <!-- Document Viewer Modal -->
        <div id="documentViewerModal"
            class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" aria-modal="true">
            <div class="relative w-full max-w-6xl h-[90vh] bg-white rounded-lg shadow-xl overflow-hidden">
                <!-- Modal Header -->
                <div class="flex items-center justify-between p-4 bg-gray-100 border-b border-gray-200">
                    <h3 id="documentViewerFileName" class="text-lg font-semibold text-gray-800">Document Viewer</h3>
                    <div class="flex gap-2">
                        <button id="documentViewerDownloadBtn"
                            class="px-4 py-2 text-sm text-white bg-blue-600 rounded hover:bg-blue-700">
                            <i class="fas fa-download mr-1"></i>Download
                        </button>
                        <button onclick="closeDocumentViewer()"
                            class="px-4 py-2 text-sm text-gray-600 bg-gray-200 rounded hover:bg-gray-300">
                            <i class="fas fa-times mr-1"></i>Close
                        </button>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="relative w-full h-full p-4 overflow-auto">
                    <!-- Loading State -->
                    <div id="documentViewerLoading" class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                            <p class="text-gray-600">Loading document...</p>
                        </div>
                    </div>

                    <!-- PDF/Image Content -->
                    <div id="documentViewerContent" class="hidden w-full h-full"></div>

                    <!-- Office Document Content -->
                    <div id="officeDocumentViewerContent" class="hidden w-full h-full"></div>

                    <!-- Unsupported Document -->
                    <div id="unsupportedDocumentContent" class="hidden flex items-center justify-center h-full">
                        <div class="text-center">
                            <i class="fas fa-file-alt text-6xl text-gray-400 mb-4"></i>
                            <p class="text-gray-600 mb-4">This document type cannot be previewed.</p>
                            <p class="text-sm text-gray-500">Please download the file to view it.</p>
                        </div>
                    </div>

                    <!-- Error State -->
                    <div id="documentViewerError" class="hidden flex items-center justify-center h-full">
                        <div class="text-center text-red-600">
                            <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                            <p>Error loading document</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div x-show="projectsLoading" class="projects-loading">
            <div class="spinner"></div>
            <p class="text-sm text-gray-500 font-medium">Loading projects...</p>
        </div>

        <div x-show="!projectsLoading" x-cloak class="max-w-full p-8 mx-auto">
            <div class="p-6 mb-6 bg-white rounded-lg shadow-md fade fade-up">
                <div class="flex items-center mb-5 gap-4">
                    <h2 id="pageTitle"
                        class="flex items-center text-2xl font-light text-gray-900 uppercase fade fade-left show">
                        <span id="pageTitleText">Your Projects Overview</span>
                    </h2>
                    <script>
                        // Change page title for super admin approvers
                        (function () {
                            const userRole = (localStorage.getItem('userRole') || '').toUpperCase();
                            const pageTitleText = document.getElementById('pageTitleText');
                            if (pageTitleText && (userRole === 'SUPER_ADMIN_APPROVER' || userRole === 'SUPER_ADMIN')) {
                                pageTitleText.textContent = 'All Projects Overview';
                            }
                        })();
                    </script>
                    <button id="approve-projects-btn"
                        class="px-3 py-2 text-sm text-white bg-green-600 rounded hover:bg-green-700" type="button"
                        onclick="window.location.href='/frontend/admin-approvals.html'">
                        <span id="approve-projects-btn-label"></span>
                    </button>
                </div>
                <div class="flex flex-col gap-2">
                    <!-- <label class="text-sm font-medium text-gray-700">Status:</label>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="highlightMarkers('all')"
                            class="px-4 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            Show All
                        </button>
                        <button onclick="highlightMarkers('active')"
                            class="px-4 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-green-500">
                            Active
                        </button>
                        <button onclick="highlightMarkers('pending')"
                            class="px-4 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-yellow-100 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            Pending
                        </button>
                        <button onclick="highlightMarkers('stalled')"
                            class="px-4 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500">
                            Stalled
                        </button>
                        <button onclick="highlightMarkers('completed')"
                            class="px-4 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-purple-100 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            Completed
                        </button>
                    </div>
                </div> -->

                    <ul class="grid grid-cols-2 gap-4 mb-6 text-center lg:grid-cols-5" id="pills-tab" role="tablist"
                        data-twe-nav-ref>
                        <li class="flex" role="presentation">
                            <a class="fade w-full fade-up bg-green-50 transition ease-in-out duration-150 text-green-700 data-[twe-nav-active]:bg-green-900 data-[twe-nav-active]:text-white p-4 rounded-md"
                                id="pills-home-tab" data-twe-toggle="pill" data-twe-target="#pills-home"
                                data-twe-nav-active role="tab" aria-controls="pills-home" aria-selected="true">
                                <p class="text-3xl font-bold" id="count-active">0</p>
                                <p class="text-sm">Active</p>
                            </a>
                        </li>
                        <li class="flex" role="presentation">
                            <a class="fade w-full fade-up bg-yellow-50 transition ease-in-out duration-150 text-yellow-700 data-[twe-nav-active]:bg-yellow-900 data-[twe-nav-active]:text-white p-4 rounded-md"
                                id="pills-profile-tab" data-twe-toggle="pill" data-twe-target="#pills-profile"
                                role="tab">
                                <p class="text-3xl font-bold" id="count-pending">0</p>
                                <p class="text-sm">Pending</p>
                            </a>
                        </li>
                        <li class="flex" role="presentation">
                            <a class="fade w-full fade-up bg-red-50 transition ease-in-out duration-150 text-red-700 data-[twe-nav-active]:bg-red-900 data-[twe-nav-active]:text-white p-4 rounded-md"
                                id="pills-contact-tab" data-twe-toggle="pill" data-twe-target="#pills-contact"
                                role="tab">
                                <p class="text-3xl font-bold" id="count-stalled">0</p>
                                <p class="text-sm">Stalled</p>
                            </a>
                        </li>
                        <li class="flex" role="presentation">
                            <a class="fade w-full fade-up bg-blue-50 transition ease-in-out duration-150 text-blue-700 data-[twe-nav-active]:bg-blue-900 data-[twe-nav-active]:text-white p-4 rounded-md"
                                id="pills-disabled-tab" data-twe-toggle="pill" data-twe-target="#pills-disabled"
                                role="tab">
                                <p class="text-3xl font-bold" id="count-completed">0</p>
                                <p class="text-sm">Completed</p>
                            </a>
                        </li>
                    </ul>
                    <!--Pills content-->
                    <div class="mb-6">
                        <div class="hidden px-4 opacity-100 transition-opacity duration-150 ease-linear data-[twe-tab-active]:block"
                            id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab" data-twe-tab-active>
                            <div class="mx-auto">
                                <div
                                    class="inline-block max-w-7xl mx-auto min-w-full overflow-hidden rounded-2xl shadow-lg bg-white">
                                    <!-- Search and Filter Controls -->
                                    <div class="p-6 border-b border-gray-200 bg-gray-50">
                                        <div
                                            class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
                                            <div
                                                class="flex flex-col sm:flex-row gap-3 items-start sm:items-center flex-1">
                                                <!-- Search Input -->
                                                <div class="relative flex-1 max-w-md">
                                                    <div
                                                        class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                        <i class="fas fa-search text-gray-400"></i>
                                                    </div>
                                                    <input type="text"
                                                        class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm placeholder-gray-500 bg-white shadow-sm"
                                                        placeholder="Search projects..."
                                                        oninput="filterProjectTables('tbody-active')"
                                                        id="project-search-active">
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <div class="py-4 overflow-x-auto">
                                        <div class="inline-block min-w-full overflow-hidden rounded-lg">
                                            <table
                                                class="modern-table min-w-full leading-normal border-separate border-spacing-0 rounded-2xl">
                                                <thead>
                                                    <tr>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            #</th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Project No</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-active', 1, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Title</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-active', 2, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Category</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-active', 3, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Themes</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-active', 4, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Locations</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-active', 5, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Status</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-active', 6, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Start Date</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-active', 7, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>End Date</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-active', 8, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Contact Person</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-active', 9, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Budget (KES)</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-active', 10, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tbody-active"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="hidden opacity-0 transition-opacity duration-150 ease-linear data-[twe-tab-active]:block"
                            id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
                            <div class="mx-auto">
                                <div class="inline-block min-w-full overflow-hidden rounded-2xl shadow-lg bg-white">
                                    <!-- Search and Filter Controls -->
                                    <div class="p-6 border-b border-gray-200 bg-gray-50">
                                        <div
                                            class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
                                            <div
                                                class="flex flex-col sm:flex-row gap-3 items-start sm:items-center flex-1">
                                                <!-- Search Input -->
                                                <div class="relative flex-1 max-w-md">
                                                    <div
                                                        class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                        <i class="fas fa-search text-gray-400"></i>
                                                    </div>
                                                    <input type="text"
                                                        class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm placeholder-gray-500 bg-white shadow-sm"
                                                        placeholder="Search projects..."
                                                        oninput="filterProjectTables('tbody-pending')"
                                                        id="project-search-pending">
                                                </div>
                                                <!-- Super admin action buttons (hidden by default) -->
                                                <!-- Button moved to top next to page title -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="py-4 overflow-x-auto">
                                        <div class="inline-block min-w-full overflow-hidden rounded-lg">
                                            <table
                                                class="modern-table min-w-full leading-normal border-separate border-spacing-0 rounded-2xl">
                                                <thead>
                                                    <tr>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            #</th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Project No</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-pending', 1, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Title</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-pending', 2, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Category</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-pending', 3, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Themes</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-pending', 4, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Locations</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-pending', 5, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Status</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-pending', 6, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Start Date</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-pending', 7, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>End Date</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-pending', 8, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Contact Person</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-pending', 9, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Budget (KES)</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-pending', 10, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tbody-pending"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="hidden opacity-0 transition-opacity duration-150 ease-linear data-[twe-tab-active]:block"
                            id="pills-contact" role="tabpanel" aria-labelledby="pills-contact-tab">
                            <div class="mx-auto">
                                <div class="inline-block min-w-full overflow-hidden rounded-2xl shadow-lg bg-white">
                                    <!-- Search and Filter Controls -->
                                    <div class="p-6 border-b border-gray-200 bg-gray-50">
                                        <div
                                            class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
                                            <div
                                                class="flex flex-col sm:flex-row gap-3 items-start sm:items-center flex-1">
                                                <!-- Search Input -->
                                                <div class="relative flex-1 max-w-md">
                                                    <div
                                                        class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                        <i class="fas fa-search text-gray-400"></i>
                                                    </div>
                                                    <input type="text"
                                                        class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm placeholder-gray-500 bg-white shadow-sm"
                                                        placeholder="Search projects..."
                                                        oninput="filterProjectTables('tbody-stalled')"
                                                        id="project-search-stalled">
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <div class="py-4 overflow-x-auto">
                                        <div class="inline-block min-w-full overflow-hidden rounded-lg">
                                            <table
                                                class="modern-table min-w-full leading-normal border-separate border-spacing-0 rounded-2xl">
                                                <thead>
                                                    <tr>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            #</th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Project No</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-stalled', 1, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Title</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-stalled', 2, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Category</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-stalled', 3, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Themes</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-stalled', 4, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Locations</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-stalled', 5, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Status</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-stalled', 6, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Start Date</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-stalled', 7, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>End Date</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-stalled', 8, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Contact Person</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-stalled', 9, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            <div>Budget (KES)</div>
                                                            <input type="text"
                                                                class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                                placeholder="Filter..."
                                                                oninput="filterColumn('tbody-stalled', 10, this.value)">
                                                        </th>
                                                        <th
                                                            class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                            Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="tbody-stalled"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="hidden opacity-0 transition-opacity duration-150 ease-linear data-[twe-tab-active]:block"
                            id="pills-disabled" role="tabpanel" aria-labelledby="pills-disabled-tab">
                            <div class="px-4 py-4 md:px-0 sm:-mx-8">
                                <div class="inline-block min-w-full overflow-hidden rounded-2xl shadow-lg bg-white">
                                    <!-- Search and Filter Controls -->
                                    <div class="p-6 border-b border-gray-200 bg-gray-50">
                                        <div
                                            class="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
                                            <div
                                                class="flex flex-col sm:flex-row gap-3 items-start sm:items-center flex-1">
                                                <!-- Search Input -->
                                                <div class="relative flex-1 max-w-md">
                                                    <div
                                                        class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                        <i class="fas fa-search text-gray-400"></i>
                                                    </div>
                                                    <input type="text"
                                                        class="block w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm placeholder-gray-500 bg-white shadow-sm"
                                                        placeholder="Search projects..."
                                                        oninput="filterProjectTables('tbody-completed')"
                                                        id="project-search-completed">
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <table
                                        class="modern-table min-w-full leading-normal border-separate border-spacing-0 rounded-2xl">
                                        <thead>
                                            <tr>
                                                <th
                                                    class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                    #</th>
                                                <th
                                                    class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                    <div>Project No</div>
                                                    <input type="text"
                                                        class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                        placeholder="Filter..."
                                                        oninput="filterColumn('tbody-completed', 1, this.value)">
                                                </th>
                                                <th
                                                    class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                    <div>Title</div>
                                                    <input type="text"
                                                        class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                        placeholder="Filter..."
                                                        oninput="filterColumn('tbody-completed', 2, this.value)">
                                                </th>
                                                <th
                                                    class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                    <div>Category</div>
                                                    <input type="text"
                                                        class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                        placeholder="Filter..."
                                                        oninput="filterColumn('tbody-completed', 3, this.value)">
                                                </th>
                                                <th
                                                    class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                    <div>Themes</div>
                                                    <input type="text"
                                                        class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                        placeholder="Filter..."
                                                        oninput="filterColumn('tbody-completed', 4, this.value)">
                                                </th>
                                                <th
                                                    class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                    <div>Locations</div>
                                                    <input type="text"
                                                        class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                        placeholder="Filter..."
                                                        oninput="filterColumn('tbody-completed', 5, this.value)">
                                                </th>
                                                <th
                                                    class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                    <div>Status</div>
                                                    <input type="text"
                                                        class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                        placeholder="Filter..."
                                                        oninput="filterColumn('tbody-completed', 6, this.value)">
                                                </th>
                                                <th
                                                    class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                    <div>Start Date</div>
                                                    <input type="text"
                                                        class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                        placeholder="Filter..."
                                                        oninput="filterColumn('tbody-completed', 7, this.value)">
                                                </th>
                                                <th
                                                    class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                    <div>End Date</div>
                                                    <input type="text"
                                                        class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                        placeholder="Filter..."
                                                        oninput="filterColumn('tbody-completed', 8, this.value)">
                                                </th>
                                                <th
                                                    class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                    <div>Contact Person</div>
                                                    <input type="text"
                                                        class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                        placeholder="Filter..."
                                                        oninput="filterColumn('tbody-completed', 9, this.value)">
                                                </th>
                                                <th
                                                    class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                    <div>Budget (KES)</div>
                                                    <input type="text"
                                                        class="mt-1 w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                                                        placeholder="Filter..."
                                                        oninput="filterColumn('tbody-completed', 10, this.value)">
                                                </th>
                                                <th
                                                    class="px-4 py-3 text-xs font-semibold tracking-wider text-left text-gray-600 uppercase border-b border-gray-200">
                                                    Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody-completed"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Dynamic Project List, Info, and Pagination Controls -->
                        <div id="projectAccordion"></div>
                        <div id="projectInfo" class="hidden"></div>
                        <div id="paginationControls" class="my-4"></div>
                        <!-- Scripts already included in <head> -->
                        <script>
                            let API_BASE = `${window.BASE_URL}/api`;

                            const rejectModalEl = document.getElementById('rejectProjectModal');
                            const rejectReasonSelect = document.getElementById('rejectReasonSelect');
                            const rejectReasonError = document.getElementById('rejectReasonError');
                            let pendingRejectProjectId = null;

                            function resetRejectModal() {
                                if (rejectReasonSelect) {
                                    rejectReasonSelect.value = '';
                                }
                                if (rejectReasonError) {
                                    rejectReasonError.classList.add('hidden');
                                }
                            }

                            window.openRejectModal = function (projectId) {
                                pendingRejectProjectId = projectId;
                                resetRejectModal();
                                if (!rejectModalEl) {
                                    console.error('Reject modal element not found');
                                    return;
                                }
                                rejectModalEl.classList.remove('hidden');
                                rejectModalEl.classList.add('flex');
                                document.body.classList.add('overflow-hidden');
                            };

                            window.closeRejectModal = function () {
                                pendingRejectProjectId = null;
                                if (!rejectModalEl) {
                                    return;
                                }
                                rejectModalEl.classList.add('hidden');
                                rejectModalEl.classList.remove('flex');
                                document.body.classList.remove('overflow-hidden');
                            };

                            window.submitProjectRejection = async function () {
                                if (!pendingRejectProjectId) {
                                    console.error('No project selected for rejection');
                                    return;
                                }
                                const reason = rejectReasonSelect ? rejectReasonSelect.value : '';
                                if (!reason) {
                                    if (rejectReasonError) {
                                        rejectReasonError.classList.remove('hidden');
                                    }
                                    if (rejectReasonSelect) {
                                        rejectReasonSelect.focus();
                                    }
                                    return;
                                }
                                if (rejectReasonError) {
                                    rejectReasonError.classList.add('hidden');
                                }
                                await dismissProject(pendingRejectProjectId, reason);
                            };

                            document.addEventListener('keydown', (event) => {
                                if (event.key === 'Escape' && rejectModalEl && !rejectModalEl.classList.contains('hidden')) {
                                    closeRejectModal();
                                }
                            });

                            // Fetch and display project statistics
                            async function loadProjectStats() {
                                try {
                                    const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                                    const res = await fetch(`${API_BASE}/projects/statistics`, {
                                        headers: {
                                            'Authorization': `Bearer ${token}`,
                                            'Content-Type': 'application/json'
                                        }
                                    });
                                    console.log('[API] GET /projects/statistics response:', res);
                                    if (!res.ok) throw new Error('HTTP ' + res.status);
                                    const data = await res.json();
                                    console.log('[API] /projects/statistics data:', data);
                                    if (data.status === 200) {
                                        let stats = data.data.statusCounts;
                                        console.log('[Stats] FULL API RESPONSE:', data);
                                        console.log('[Stats] statusCounts:', stats);
                                        // Show raw statusCounts for debugging
                                        let debugDiv = document.getElementById('debug-statuscounts');
                                        if (!debugDiv) {
                                            debugDiv = document.createElement('div');
                                            debugDiv.id = 'debug-statuscounts';
                                            debugDiv.style.background = '#ffe';
                                            debugDiv.style.fontSize = '12px';
                                            debugDiv.style.padding = '4px';
                                            debugDiv.style.margin = '8px 0';
                                            document.body.insertBefore(debugDiv, document.body.firstChild);
                                        }
                                        // debugDiv.textContent = 'Raw statusCounts: ' + JSON.stringify(stats);

                                        // If statusCounts is an array of arrays (e.g. [['pending', 1]]), convert to object
                                        if (Array.isArray(stats)) {
                                            const obj = {};
                                            stats.forEach(s => {
                                                if (Array.isArray(s) && s.length === 2) {
                                                    obj[String(s[0]).toLowerCase()] = s[1];
                                                } else if (s && typeof s === 'object' && s.status && s.count !== undefined) {
                                                    obj[s.status.toLowerCase()] = s.count;
                                                }
                                            });
                                            stats = obj;
                                        }
                                        document.getElementById('count-active').textContent = stats.active || 0;
                                        document.getElementById('count-pending').textContent = stats.pending || 0;
                                        document.getElementById('count-stalled').textContent = stats.stalled || 0;
                                        document.getElementById('count-completed').textContent = stats.completed || 0;
                                    }
                                } catch (e) {
                                    console.error('Failed to load project stats', e);
                                }
                            }

                            // Helper to render action buttons
                            function renderActions(project, status) {
                                const userRole = (localStorage.getItem('userRole') || '').toUpperCase();
                                const isPartner = userRole === 'PARTNER';

                                let html = `<button class="px-2 py-1 text-xs text-white bg-indigo-500 rounded hover:bg-indigo-600" onclick="viewProjectDetails(${project.id})">View</button> `;

                                if (isPartner) {
                                    if (status === 'pending') {
                                        html += `<button class="px-2 py-1 text-xs text-white bg-blue-500 rounded hover:bg-blue-600" onclick="editProject(${project.id})">Edit</button> `;
                                        html += `<button class="px-2 py-1 text-xs text-white bg-red-500 rounded hover:bg-red-600" onclick="deleteProject(${project.id})">Delete</button>`;
                                    }
                                    return html;
                                }

                                if (status === 'pending') {
                                    html += `<button class="px-2 py-1 text-xs text-white bg-blue-500 rounded hover:bg-blue-600" onclick="editProject(${project.id})">Edit</button> `;

                                } else if (status === 'active') {
                                    html += `<button class="px-2 py-1 text-xs text-white bg-orange-500 rounded hover:bg-orange-600" onclick="stalledProject(${project.id})">Has Stalled</button>`;
                                    html += `<button class="px-2 py-1 text-xs text-white bg-green-500 rounded hover:bg-green-600" onclick="completedProject(${project.id})">Is Completed</button>`;
                                } else if (status === 'stalled') {
                                    html += `<button class="px-2 py-1 text-xs text-white bg-green-500 rounded hover:bg-green-600" onclick="reactivateProject(${project.id})">Re-activate</button> `;
                                } else if (status === 'completed') {
                                    html += `<button class="px-2 py-1 text-xs text-white bg-blue-500 rounded hover:bg-blue-600" onclick="submitReport(${project.id})">Submit Report</button>`;
                                }                                // Mark project as stalled (exposed globally)
                                window.stalledProject = async function (id) {
                                    const confirmed = await showConfirm('Mark this project as stalled?', 'Mark as Stalled', 'Mark as Stalled', 'Cancel');
                                    if (!confirmed) return;
                                    try {
                                        const headers = {
                                            'Content-Type': 'application/json',
                                            Authorization: 'Bearer ' + (localStorage.getItem('accessToken') || '')
                                        };
                                        const res = await fetch(`${API_BASE}/projects/admin/stall/${id}`, {
                                            method: 'POST',
                                            credentials: 'include',
                                            headers
                                        });
                                        let data = null;
                                        try {
                                            data = await res.json();
                                        } catch (jsonErr) {
                                            console.error('[completedProject] Failed to parse JSON:', jsonErr);
                                        }
                                        if (res.ok && data && data.message) {
                                            await showAlert(data.message || 'Project marked as completed', 'Success', 'success');
                                        } else {
                                            await showAlert('Failed to mark project as completed: ' + (data && data.message ? data.message : res.status), 'Error', 'error');
                                        }
                                        reloadAfterAction(['active', 'completed']);
                                    } catch (e) {
                                        console.error('[completedProject] Exception:', e);
                                        await showAlert('Failed to mark project as completed: ' + e, 'Error', 'error');
                                    }
                                }

                                return html;
                            }

                            // Mark project as completed (exposed globally)
                            window.completeProject = async function (id) {
                                const confirmed = await showConfirm('Mark this project as completed?', 'Mark as Completed', 'Mark as Completed', 'Cancel');
                                if (!confirmed) return;
                                try {
                                    const headers = {
                                        'Content-Type': 'application/json',
                                        Authorization: 'Bearer ' + (localStorage.getItem('accessToken') || '')
                                    };
                                    const res = await fetch(`${API_BASE}/projects/admin/complete/${id}`, {
                                        method: 'POST',
                                        credentials: 'include',
                                        headers
                                    });
                                    let data = null;
                                    try {
                                        data = await res.json();
                                    } catch (jsonErr) {
                                        console.error('[completeProject] Failed to parse JSON:', jsonErr);
                                    }
                                    if (res.ok && data && data.message) {
                                        await showAlert(data.message || 'Project marked as completed', 'Success', 'success');
                                    } else {
                                        await showAlert('Failed to mark project as completed: ' + (data && data.message ? data.message : res.status), 'Error', 'error');
                                    }
                                    reloadAfterAction(['active', 'completed']);
                                } catch (e) {
                                    console.error('[completeProject] Exception:', e);
                                    await showAlert('Failed to mark project as completed: ' + e, 'Error', 'error');
                                }
                            }

                            // Small helpers for rendering partner and contact safely
                            function isEmail(value) {
                                return typeof value === 'string' && /\S+@\S+\.\S+/.test(value);
                            }

                            function escapeHtml(str) {
                                if (!str && str !== 0) return '';
                                return String(str)
                                    .replace(/&/g, '&amp;')
                                    .replace(/</g, '&lt;')
                                    .replace(/>/g, '&gt;')
                                    .replace(/"/g, '&quot;')
                                    .replace(/'/g, '&#39;');
                            }

                            // Collect reviewer theme values from an object (supports many shapes)
                            function collectReviewerThemesFromObject(obj) {
                                const out = [];
                                if (!obj) return out;
                                const maybe = (obj.data && typeof obj.data === 'object') ? obj.data : obj;

                                const pushVal = v => {
                                    if (v === undefined || v === null) return;
                                    if (Array.isArray(v)) return v.forEach(pushVal);
                                    out.push(v);
                                };

                                // Prioritize new many-to-many thematicAreas array
                                if (Array.isArray(maybe.thematicAreas) && maybe.thematicAreas.length > 0) {
                                    pushVal(maybe.thematicAreas);
                                }
                                // Fallback to other fields
                                else {
                                    pushVal(maybe.thematicArea || maybe.thematic_area || maybe.thematicAreaCode || maybe.thematic_area_code || maybe.theme || maybe.themeCode || maybe.theme_code || maybe.themesManaged || maybe.themes || maybe.thematics || maybe.preference);
                                    for (const k of Object.keys(maybe || {})) {
                                        if (/theme/i.test(k) || /thematic/i.test(k)) {
                                            pushVal(maybe[k]);
                                        }
                                    }
                                }

                                return out.map(item => {
                                    if (!item && item !== 0) return '';
                                    if (typeof item === 'object') return String(item.name || item.code || item.id || JSON.stringify(item) || '');
                                    return String(item || '');
                                }).map(s => s.trim()).filter(Boolean);
                            }

                            // Attempt to update page title and reviewer tokens from localStorage; returns true when some value found
                            function updateReviewerTitleAndTokens() {
                                try {
                                    const userStr = localStorage.getItem('currentUser') || localStorage.getItem('user');
                                    if (!userStr) return false;
                                    let userObj = null;
                                    try { userObj = JSON.parse(userStr); } catch (e) { userObj = null; }
                                    const rawThemeValues = collectReviewerThemesFromObject(userObj || {});
                                    console.log('[Reviewer] raw theme values extracted from localStorage.user:', rawThemeValues);

                                    const CODE_TO_FULL_NAME = {
                                        'AYPSRH': 'Adolescent and Young People Sexual and Reproductive Health',
                                        'FP': 'Family Planning',
                                        'CH': 'Child Health',
                                        'GBV': 'Gender Based Violence',
                                        'MNH': 'Maternal and Newborn Health',
                                        'AH': 'Adolescent Health'
                                    };

                                    const themeDisplay = rawThemeValues.map(r => {
                                        if (!r) return '';
                                        const mapped = CODE_TO_FULL_NAME[String(r).toUpperCase()];
                                        return mapped || r;
                                    }).filter(Boolean);

                                    const themeNames = [];
                                    rawThemeValues.forEach(r => {
                                        if (!r) return;
                                        const raw = String(r).toLowerCase();
                                        themeNames.push(raw);
                                        const mapped = CODE_TO_FULL_NAME[String(r).toUpperCase()];
                                        if (mapped) themeNames.push(String(mapped).toLowerCase());
                                    });



                                    const titleEl = document.getElementById('pageTitle');
                                    // Safely read and parse current user from localStorage before accessing fields
                                    (function safeLogThematic() {
                                        try {
                                            const raw = localStorage.getItem('currentUser') || localStorage.getItem('user');
                                            if (!raw) { console.log('Thematic', 'no currentUser in localStorage'); return; }
                                            let cu = null;
                                            try { cu = JSON.parse(raw); } catch (e) { cu = raw; }
                                            const thematic = cu && (cu.thematicArea || cu.thematic_area || cu.theme || cu.themeCode || cu.theme_code || cu.preference) ? (cu.thematicArea || cu.thematic_area || cu.theme || cu.themeCode || cu.theme_code || cu.preference) : null;
                                            const mapped = thematic ? CODE_TO_FULL_NAME[String(thematic).toUpperCase()] : null;
                                            console.log('Thematic', mapped || thematic || 'none');
                                        } catch (e) {
                                            console.warn('safeLogThematic failed', e);
                                        }
                                    })();
                                    // if (titleEl) {
                                    //     if (themeDisplay.length === 1) {
                                    //         titleEl.innerHTML = `All Thematic Projects for theme <strong>${escapeHtml(themeDisplay[0])}</strong>`;
                                    //     } else if (themeDisplay.length > 1) {
                                    //         titleEl.innerHTML = `All Thematic Projects for themes <strong>${themeDisplay.map(escapeHtml).join(', ')}</strong>`;
                                    //     } else if (rawThemeValues.length === 1) {
                                    //         titleEl.innerHTML = `All Thematic Projects for theme <strong>${escapeHtml(rawThemeValues[0])}</strong>`;
                                    //     } else {
                                    //             // no themes found - show generic heading without an 'Unknown' theme
                                    //             titleEl.innerHTML = `All Thematic Projects`;
                                    //         }
                                    // }

                                    try { window.__reviewerThemeTokens = Array.from(new Set(themeNames)); } catch (e) { window.__reviewerThemeTokens = themeNames; }
                                    console.log('[Reviewer] theme tokens for matching:', window.__reviewerThemeTokens);

                                    return rawThemeValues.length > 0 || themeDisplay.length > 0 || (window.__reviewerThemeTokens && window.__reviewerThemeTokens.length > 0);
                                } catch (e) {
                                    console.error('Error updating reviewer title and tokens', e);
                                    return false;
                                }
                            }

                            // Retry loop to wait for auth.js to populate localStorage.user (handles race conditions)
                            function ensureReviewerThemeSetup(attempts = 10, delay = 300) {
                                let tries = 0;
                                const tick = () => {
                                    const ok = updateReviewerTitleAndTokens();
                                    if (ok) {
                                        try { filterRenderedTableRowsByReviewerTheme(); } catch (e) { console.error('Error running reviewer filter after token setup', e); }
                                        return;
                                    }
                                    tries++;
                                    if (tries < attempts) {
                                        setTimeout(tick, delay);
                                    } else {
                                        console.warn('ensureReviewerThemeSetup: no reviewer theme found after retries');
                                    }
                                };
                                tick();
                            }

                            function renderPartnerField(project) {
                                // Prefer explicit organization name
                                const orgName = project && project.organization && project.organization.name ? project.organization.name : (project && (project.organizationName || project.organization));
                                if (orgName) return escapeHtml(orgName);

                                // Try partner/sponsor but avoid showing an email there
                                const partner = project && (project.partner || project.sponsor || '');
                                if (partner && !isEmail(partner)) return escapeHtml(partner);

                                // Fallback to contact person name (if organization missing)
                                return escapeHtml(project && (project.contactPersonName || project.contactPerson || ''));
                            }

                            function renderContactField(project) {
                                const email = project && (project.contactPersonEmail || project.contactEmail || project.contact_person_mail || project.contact_person || project.contact);
                                if (email && isEmail(email)) {
                                    return `<a class="text-blue-600 underline" href="mailto:${escapeHtml(email)}">${escapeHtml(email)}</a>`;
                                }
                                // Fallback to name
                                const name = project && (project.contactPersonName || project.contactPerson || project.contact || '');
                                return escapeHtml(name);
                            }

                            // Fetch and render projects by status (ADMIN/SUPER_ADMIN only)
                            async function loadProjectsByStatus(status, tableBodyId) {
                                try {
                                    // Check if user is admin before loading
                                    const userRole = localStorage.getItem('userRole');
                                    if (userRole === 'PARTNER' || userRole === 'DONOR') {
                                        console.log('[Security] Partners/Donors should use my-projects endpoint, not status endpoint');
                                        return;
                                    }

                                    const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                                    const res = await fetch(`${API_BASE}/projects/status/${status}`, {
                                        headers: {
                                            'Authorization': `Bearer ${token}`,
                                            'Content-Type': 'application/json'
                                        }
                                    });
                                    console.log(`[API] GET /projects/status/${status} response:`, res);
                                    if (!res.ok) throw new Error('HTTP ' + res.status);
                                    const data = await res.json();
                                    console.log(`[API] /projects/status/${status} data:`, data);
                                    if (data.status === 200) {
                                        let projects = data.data || [];
                                        // If the current user is a SUPER_ADMIN_REVIEWER, filter projects to only those within their thematic areas
                                        try {
                                            const userRole = (localStorage.getItem('userRole') || '').toUpperCase();
                                            if (userRole === 'SUPER_ADMIN_REVIEWER') {
                                                const userStr = localStorage.getItem('currentUser') || localStorage.getItem('user');
                                                let userObj = null;
                                                if (userStr) {
                                                    try { userObj = JSON.parse(userStr); } catch (e) { userObj = null; }
                                                }
                                                // Build reviewer theme list (prefer single `thematicArea`)
                                                let themeListRaw = [];
                                                if (userObj) {
                                                    // Support different shapes: userObj may be the API response wrapper ({status,message,data: {...}})
                                                    const maybe = userObj.data && typeof userObj.data === 'object' ? userObj.data : userObj;
                                                    
                                                    // Prioritize new many-to-many thematicAreas array
                                                    if (Array.isArray(maybe.thematicAreas) && maybe.thematicAreas.length > 0) {
                                                        themeListRaw = maybe.thematicAreas;
                                                    }
                                                    // Fallback to legacy single thematicArea
                                                    else if (maybe.thematicArea) {
                                                        themeListRaw = [maybe.thematicArea];
                                                    }
                                                    // Other fallbacks
                                                    else if (Array.isArray(maybe.themes)) {
                                                        themeListRaw = maybe.themes;
                                                    }
                                                    else if (maybe.themesManaged) {
                                                        themeListRaw = maybe.themesManaged;
                                                    }
                                                    
                                                    console.log('[Reviewer] Extracted thematic areas:', themeListRaw);
                                                }
                                                const themeNames = (themeListRaw || []).map(t => typeof t === 'string' ? t.toLowerCase() : ((t.name || t.code || '') + '').toLowerCase()).filter(Boolean);

                                                if (themeNames.length > 0) {
                                                    projects = projects.filter(p => {
                                                        try {
                                                            // Gather all theme strings from the project
                                                            let projectThemes = [];
                                                            if (Array.isArray(p.themes)) {
                                                                p.themes.forEach(t => {
                                                                    if (!t) return;
                                                                    if (typeof t === 'string') projectThemes.push(t.toLowerCase());
                                                                    else {
                                                                        if (t.name) projectThemes.push(String(t.name).toLowerCase());
                                                                        if (t.code) projectThemes.push(String(t.code).toLowerCase());
                                                                    }
                                                                });
                                                            }
                                                            if (p.thematicArea) projectThemes.push(String(p.thematicArea).toLowerCase());
                                                            if (p.theme) {
                                                                if (typeof p.theme === 'string') projectThemes.push(p.theme.toLowerCase());
                                                                else {
                                                                    if (p.theme.name) projectThemes.push(String(p.theme.name).toLowerCase());
                                                                    if (p.theme.code) projectThemes.push(String(p.theme.code).toLowerCase());
                                                                }
                                                            }
                                                            if (p.themeCode) projectThemes.push(String(p.themeCode).toLowerCase());
                                                            if (p.themeName) projectThemes.push(String(p.themeName).toLowerCase());
                                                            projectThemes = projectThemes.filter(Boolean);
                                                            if (projectThemes.length === 0) return false;

                                                            // Partial, case-insensitive match: any project theme contains or is contained in any reviewer token
                                                            for (const tn of themeNames) {
                                                                for (const pt of projectThemes) {
                                                                    if (pt.includes(tn) || tn.includes(pt)) return true;
                                                                }
                                                            }
                                                            return false;
                                                        } catch (inner) {
                                                            return false;
                                                        }
                                                    });
                                                }
                                            }
                                        } catch (filterErr) {
                                            console.error('Error filtering projects for SUPER_ADMIN_REVIEWER', filterErr);
                                        }
                                        const tbody = document.getElementById(tableBodyId);
                                        tbody.innerHTML = '';
                                        let counter = 1;
                                        projects.forEach(project => {
                                            const themes = project.themes || [];
                                            const locations = project.locations || [];
                                            tbody.innerHTML += `
                                                <tr class="hover:bg-gray-50 transition items-center duration-150 ease-in-out">
                                                    
                                                    <td class="px-6 py-4 gap-1 items-center text-sm text-gray-600">
                                                        <span class="bg-gray-100 whitespace-nowrap text-black text-xs px-2 py-1 rounded-lg">
                                                            <span class="whitespace-nowrap font-medium text-gray-900">${counter++}</span>
                                                        </span>
                                                    </td>
                                                    <td class="px-6 py-4 gap-1 items-center text-sm text-gray-600">
                                                        <span class="bg-yellow-100 whitespace-nowrap text-black text-xs px-2 py-1 rounded-lg">
                                                            <span class="whitespace-nowrap font-medium text-gray-900">${project.projectNo || project.id || counter++}</span>
                                                        </span>
                                                    </td>
                                                    
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                                        <span class="whitespace-nowrap text-sm font-medium text-gray-900">${project.title || 'N/A'}</span>
                                                    </td>
                                                    
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                                        <span class="whitespace-nowrap text-sm font-medium text-gray-900">${project.projectCategory || 'N/A'}</span>
                                                    </td>
                                                    
                                                    <td class="px-6 py-4 text-sm text-gray-600">
                                                        <div class="flex flex-wrap gap-1">
                                                            ${themes.length > 0 ? themes.map(t => `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs whitespace-nowrap">${t.name || t.code || 'Theme'}</span>`).join('') : '<span class="text-xs italic text-gray-400">N/A</span>'}
                                                        </div>
                                                    </td>

                                                    <td class="px-6 py-4 text-sm text-gray-600">
                                                        <div class="flex flex-wrap gap-1">
                                                            ${locations.length > 0 ? locations.map(l => `
                                                                <span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs whitespace-nowrap">
                                                                    <i class="fas fa-map-marker-alt text-red-500 mr-1"></i>
                                                                    <span>${l.county || l.mapsAddress || 'Location'}</span>
                                                                </span>
                                                            `).join('') : '<span class="text-xs italic text-gray-400">N/A</span>'}
                                                        </div>
                                                    </td>
                                                    
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                        ${(() => {
                                                    const status = project.status || 'PENDING_REVIEW';
                                                    let colorClass = 'bg-yellow-100 text-yellow-800'; // Default PENDING_REVIEW / PENDING

                                                    if (status.includes('FINAL') || status === 'Ongoing') {
                                                        colorClass = 'bg-blue-100 text-blue-800';
                                                    } else if (status === 'Completed' || status === 'APPROVED') {
                                                        colorClass = 'bg-green-100 text-green-800';
                                                    }

                                                    return `<span class="px-3 py-1 ${colorClass} rounded-full text-xs font-medium">${status.replace(/_/g, ' ')}</span>`;
                                                })()}
                                                    </td>

                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                                        <div class="flex flex-col gap-1">
                                                            ${project.startDate || 'N/A'}
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                                        <div class="flex flex-col gap-1">
                                                            ${project.endDate || 'N/A'}
                                                        </div>
                                                    </td>

                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                                        ${project.contactPersonName || project.projectCategory || 'N/A'}
                                                    </td>

                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-700 font-semibold">
                                                        KES ${project.budget ? project.budget.toLocaleString() : 'N/A'}
                                                    </td>




                                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                        <div class="flex gap-2 justify-end">
                                                            <button onclick="viewProjectDetails(${project.id})"
                                                                class="text-gray-600 hover:text-gray-900 px-2 py-1 rounded border border-gray-300 hover:bg-gray-100 transition"
                                                                title="View Details">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                            ${(() => {
                                                    const userRole = (localStorage.getItem('userRole') || '').toUpperCase();
                                                    if (userRole === 'SUPER_ADMIN_REVIEWER' || userRole === 'SUPER_ADMIN_APPROVER') {
                                                        return `
                                                                        <button onclick="editProject(${project.id})"
                                                                            class="text-blue-600 hover:text-blue-800 px-2 py-1 rounded border border-blue-300 hover:bg-blue-50 transition"
                                                                            title="Edit Project">
                                                                            <i class="fas fa-edit"></i>
                                                                        </button>
                                                                        <button onclick="deleteProject(${project.id})"
                                                                            class="text-red-600 hover:text-red-800 px-2 py-1 rounded border border-red-300 hover:bg-red-50 transition"
                                                                            title="Delete Project">
                                                                            <i class="fas fa-trash"></i>
                                                                        </button>
                                                                    `;
                                                    }
                                                    return '';
                                                })()}
                                                        </div>
                                                    </td>
                                                </tr>
                                            `;
                                        });
                                        
                                        // Update the appropriate counter based on the status
                                        const counterId = `count-${status}`;
                                        const counterElement = document.getElementById(counterId);
                                        if (counterElement) {
                                            counterElement.textContent = projects.length;
                                            console.log(`[Counter Update] ${status}: ${projects.length} projects`);
                                        }
                                        
                                        // Add empty state message if no projects
                                        if (tbody.innerHTML === '') {
                                            tbody.innerHTML = `<tr><td colspan="9" class="px-4 py-3 text-sm text-gray-700">No ${status} projects found</td></tr>`;
                                        }
                                        // If reviewer, ensure rendered rows are strictly filtered by thematic area
                                        if ((localStorage.getItem('userRole') || '').toUpperCase() === 'SUPER_ADMIN_REVIEWER') {
                                            try {
                                                filterRenderedTableRowsByReviewerTheme();
                                            } catch (e) { console.error('Error enforcing reviewer theme on rendered rows', e); }
                                        }
                                    }
                                } catch (e) {
                                    console.error(`Failed to load projects for status ${status}`, e);
                                }
                            }

                            // Return true when the page should show only the current user's projects
                            function isMyProjectsView() {
                                return window.location.hash === '#my-projects';
                            }

                            // Load projects for the current authenticated user and populate the status tables
                            async function loadMyProjects() {
                                const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                                const hasAuthManager = !!(window.authManager && typeof window.authManager.apiCall === 'function');

                                const showLoginMessage = () => {
                                    const msg = '<tr><td colspan="9" class="px-4 py-3 text-sm text-gray-700">Please log in to view your projects.</td></tr>';
                                    document.getElementById('tbody-active').innerHTML = msg;
                                    document.getElementById('tbody-pending').innerHTML = msg;
                                    document.getElementById('tbody-stalled').innerHTML = msg;
                                    document.getElementById('tbody-completed').innerHTML = msg;
                                    document.getElementById('count-active').textContent = 0;
                                    document.getElementById('count-pending').textContent = 0;
                                    document.getElementById('count-stalled').textContent = 0;
                                    document.getElementById('count-completed').textContent = 0;
                                };

                                if (!hasAuthManager && !token) {
                                    showLoginMessage();
                                    return;
                                }

                                if (hasAuthManager && !authManager.isAuthenticated() && !token) {
                                    showLoginMessage();
                                    return;
                                }

                                try {
                                    let res;
                                    if (hasAuthManager && authManager.isAuthenticated()) {
                                        res = await authManager.apiCall('/api/projects/my-projects', 'GET');
                                    } else {
                                        res = await fetch(`${API_BASE}/projects/my-projects`, {
                                            method: 'GET',
                                            credentials: 'include',
                                            headers: token ? { Authorization: `Bearer ${token}` } : {}
                                        });
                                    }

                                    if (!res || !res.ok) {
                                        console.error('Failed to fetch my-projects', res);
                                        return;
                                    }

                                    const json = await res.json();
                                    console.log('[loadMyProjects] API response:', json);
                                    const projects = (json && json.data) || [];
                                    console.log('[loadMyProjects] Projects array:', projects);
                                    const userStr = localStorage.getItem('currentUser') || localStorage.getItem('user');
                                    let userEmail = '';
                                    if (userStr) {
                                        try {
                                            const userObj = JSON.parse(userStr);
                                            userEmail = userObj.email || '';
                                            console.log('[loadMyProjects] Logged in user email:', userEmail);
                                        } catch (e) {
                                            console.error('[loadMyProjects] Error parsing user from localStorage:', e);
                                        }
                                    } else {
                                        console.warn('[loadMyProjects] No user found in localStorage');
                                    }

                                    // Use the returned array directly
                                    const myProjects = projects;
                                    console.log('[loadMyProjects] Using returned projects array:', myProjects);

                                    // Clear tables
                                    const tbActive = document.getElementById('tbody-active');
                                    const tbPending = document.getElementById('tbody-pending');
                                    const tbStalled = document.getElementById('tbody-stalled');
                                    const tbCompleted = document.getElementById('tbody-completed');
                                    tbActive.innerHTML = '';
                                    tbPending.innerHTML = '';
                                    tbStalled.innerHTML = '';
                                    tbCompleted.innerHTML = '';

                                    const counts = { active: 0, pending: 0, stalled: 0, completed: 0 };

                                    let activeCounter = 1;
                                    let pendingCounter = 1;
                                    let stalledCounter = 1;
                                    let completedCounter = 1;

                                    myProjects.forEach(project => {
                                        const status = (
                                            project.approvalStatus ||
                                            project.status ||
                                            project.projectStatus ||
                                            (project.tag && project.tag.toLowerCase()) ||
                                            'active'
                                        ).toLowerCase();
                                        const themes = project.themes || [];
                                        const locations = project.locations || [];
                                        const row = `
                                            <tr class="hover:bg-gray-50 transition items-center duration-150 ease-in-out">
                                                
                                                <td class="px-6 py-4 gap-1 items-center text-sm text-gray-600">
                                                    <span class="bg-purple-100 text-black text-xs px-2 py-1 rounded-lg">
                                                        <span class="whitespace-nowrap font-medium text-gray-900">${project.projectNo || project.id || 'N/A'}</span>
                                                    </span>
                                                    <br class="my-1">
                                                    <span class="whitespace-nowrap text-sm font-medium text-gray-900">${project.title || 'Untitled Project'}</span>
                                                </td>

                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                                    ${project.partner || 'Unknown Partner'}
                                                </td>

                                                <td class="px-6 py-4 text-sm text-gray-600">
                                                    <div class="flex flex-wrap gap-1">
                                                        ${themes.map(t => `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs whitespace-nowrap">${t.name || t.code || 'Theme'}</span>`).join('')}
                                                    </div>
                                                </td>

                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-green-700 font-semibold">
                                                    KES ${project.budget ? project.budget.toLocaleString() : '0'}
                                                </td>

                                                <td class="px-6 py-4 text-sm text-gray-600">
                                                    <div class="flex flex-wrap gap-1">
                                                        ${locations.map(l => `
                                                            <span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs whitespace-nowrap">
                                                                <i class="fas fa-map-marker-alt text-red-500 mr-1"></i>
                                                                <span>${l.county || l.mapsAddress || 'Location'}</span>
                                                            </span>
                                                        `).join('')}
                                                    </div>
                                                </td>

                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                                    <div class="flex flex-col gap-1">
                                                        ${project.startDate ? `<span>Start: ${project.startDate}</span>` : ''}
                                                        ${project.endDate ? `<span>End: ${project.endDate}</span>` : ''}
                                                    </div>
                                                </td>

                                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                    ${(() => {
                                                const status = project.status || project.approvalWorkflowStatus || 'PENDING_REVIEW';
                                                let colorClass = 'bg-yellow-100 text-yellow-800'; // Default PENDING_REVIEW / PENDING

                                                if (status.includes('PENDING_FINAL') || status === 'SUBMITTED') {
                                                    colorClass = 'bg-blue-100 text-blue-800'; // Submitted/Pending Final
                                                } else if (status === 'APPROVED' || status === 'COMPLETED') {
                                                    colorClass = 'bg-green-100 text-green-800'; // Approved/Completed
                                                }

                                                return `<span class="px-3 py-1 ${colorClass} rounded-full text-xs font-medium">${status.replace(/_/g, ' ')}</span>`;
                                            })()}
                                                </td>

                                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                    <div class="flex gap-2 justify-end">
                                                        <button onclick="viewProjectDetails(${project.id})"
                                                            class="text-gray-600 hover:text-gray-900 px-2 py-1 rounded border border-gray-300 hover:bg-gray-100 transition"
                                                            title="View Details">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                        if (status === 'pending') {
                                            tbPending.innerHTML += row.replace('{{number}}', pendingCounter++);
                                            counts.pending++;
                                        } else if (status === 'stalled' || status === 'stall' || status === 'stalled project') {
                                            tbStalled.innerHTML += row.replace('{{number}}', stalledCounter++);
                                            counts.stalled++;
                                        } else if (status === 'completed') {
                                            tbCompleted.innerHTML += row.replace('{{number}}', completedCounter++);
                                            counts.completed++;
                                        } else {
                                            tbActive.innerHTML += row.replace('{{number}}', activeCounter++);
                                            counts.active++;
                                        }
                                    });

                                    document.getElementById('count-active').textContent = counts.active;
                                    document.getElementById('count-pending').textContent = counts.pending;
                                    document.getElementById('count-stalled').textContent = counts.stalled;
                                    document.getElementById('count-completed').textContent = counts.completed;

                                    // Add empty state messages
                                    if (counts.active === 0) {
                                        tbActive.innerHTML = '<tr><td colspan="9" class="px-4 py-3 text-sm text-gray-700">You have no active projects</td></tr>';
                                    }
                                    if (counts.pending === 0) {
                                        tbPending.innerHTML = '<tr><td colspan="9" class="px-4 py-3 text-sm text-gray-700">You have no pending projects</td></tr>';
                                    }
                                    if (counts.stalled === 0) {
                                        tbStalled.innerHTML = '<tr><td colspan="9" class="px-4 py-3 text-sm text-gray-700">You have no stalled projects</td></tr>';
                                    }
                                    if (counts.completed === 0) {
                                        tbCompleted.innerHTML = '<tr><td colspan="9" class="px-4 py-3 text-sm text-gray-700">You have no completed projects</td></tr>';
                                    }

                                } catch (e) {
                                    console.error('Error loading my projects', e);
                                }
                            }

                            function refreshProjectTables(statuses = ['active', 'pending', 'stalled', 'completed']) {
                                const userRole = localStorage.getItem('userRole');
                                const isPartner = userRole === 'PARTNER';
                                const isDonor = userRole === 'DONOR';

                                if (isMyProjectsView() || isPartner || isDonor) {
                                    loadMyProjects();
                                    return;
                                }

                                const tableMap = {
                                    active: 'tbody-active',
                                    pending: 'tbody-pending',
                                    stalled: 'tbody-stalled',
                                    completed: 'tbody-completed'
                                };

                                statuses.forEach(status => {
                                    const key = status.toLowerCase();
                                    const tableId = tableMap[key];
                                    if (tableId) {
                                        loadProjectsByStatus(key, tableId);
                                    }
                                });
                            }

                            function reloadAfterAction(statuses = ['active', 'pending', 'stalled', 'completed']) {
                                const userRole = localStorage.getItem('userRole');
                                if (userRole !== 'PARTNER' && userRole !== 'DONOR') {
                                    loadProjectStats();
                                }
                                refreshProjectTables(statuses);
                            }

                            // Action handlers
                            async function approveProject(id) {
                                const confirmed = await showConfirm('Approve this project?', 'Approve Project', 'Approve', 'Cancel');
                                if (!confirmed) return;
                                try {
                                    console.log('[approveProject] Sending POST to', `${API_BASE}/projects/admin/approve/${id}`);
                                    const headers = {
                                        'Content-Type': 'application/json',
                                        Authorization: 'Bearer ' + (localStorage.getItem('accessToken') || '')
                                    };
                                    const res = await fetch(`${API_BASE}/projects/admin/approve/${id}`, {
                                        method: 'POST',
                                        credentials: 'include',
                                        headers
                                    });
                                    console.log('[approveProject] Response:', res);
                                    let data = null;
                                    try {
                                        data = await res.json();
                                    } catch (jsonErr) {
                                        console.error('[approveProject] Failed to parse JSON:', jsonErr);
                                    }
                                    console.log('[approveProject] Response data:', data);
                                    if (res.ok && data && data.message) {
                                        await showAlert(data.message || 'Project approved', 'Success', 'success');
                                    } else {
                                        await showAlert('Failed to approve project: ' + (data && data.message ? data.message : res.status), 'Error', 'error');
                                    }
                                    reloadAfterAction(['pending', 'active']);
                                } catch (e) {
                                    console.error('[approveProject] Exception:', e);
                                    await showAlert('Failed to approve project: ' + e, 'Error', 'error');
                                }
                            }

                            async function dismissProject(id, reason) {
                                if (!id) {
                                    console.error('dismissProject requires a project id');
                                    return;
                                }
                                const trimmedReason = (reason || '').trim();
                                if (!trimmedReason) {
                                    if (rejectReasonError) {
                                        rejectReasonError.classList.remove('hidden');
                                    }
                                    return;
                                }

                                try {
                                    let res;
                                    if (window.authManager && typeof window.authManager.apiCall === 'function') {
                                        res = await window.authManager.apiCall(
                                            `/api/projects/admin/reject/${id}`,
                                            'POST',
                                            { reason: trimmedReason }
                                        );
                                    } else {
                                        const headers = { 'Content-Type': 'application/json' };
                                        const token = localStorage.getItem('accessToken');
                                        if (token) {
                                            headers.Authorization = `Bearer ${token}`;
                                        }
                                        res = await fetch(`${API_BASE}/projects/admin/reject/${id}`, {
                                            method: 'POST',
                                            headers,
                                            body: JSON.stringify({ reason: trimmedReason })
                                        });
                                    }
                                    let data = null;
                                    try {
                                        data = await res.json();
                                    } catch (jsonErr) {
                                        console.error('Failed to parse rejection response JSON', jsonErr);
                                    }

                                    if (res.ok) {
                                        await showAlert((data && data.message) || 'Project rejected', 'Success', 'success');
                                        closeRejectModal();
                                        reloadAfterAction(['pending']);
                                    } else {
                                        await showAlert((data && data.message) || 'Failed to reject project.', 'Error', 'error');
                                    }
                                } catch (e) {
                                    console.error('Failed to reject project', e);
                                    await showAlert('Failed to reject project', 'Error', 'error');
                                }
                            }

                            function editProject(id) {
                                // Redirect to edit page or open modal (implement as needed)
                                showAlert('Edit project ' + id, 'Edit Project', 'info');
                            }

                            function reactivateProject(id) {
                                // Implement re-activation logic as needed
                                showAlert('Re-activate project ' + id, 'Reactivate Project', 'info');
                            }

                            function submitReport(id) {
                                // Implement report submission logic as needed
                                showAlert('Submit report for project ' + id, 'Submit Report', 'info');
                            }

                            // Function to auto-fill search based on URL parameter
                            async function autoFillSearchFromURL() {
                                const urlParams = new URLSearchParams(window.location.search);
                                const projectId = urlParams.get('id');
                                
                                if (!projectId) return;
                                
                                try {
                                    // Fetch project details
                                    const token = localStorage.getItem('accessToken');
                                    const headers = {
                                        'Authorization': `Bearer ${token}`,
                                        'Content-Type': 'application/json'
                                    };
                                    
                                    const response = await fetch(`${API_BASE}/projects/${projectId}`, {
                                        headers: headers
                                    });
                                    
                                    if (!response.ok) {
                                        console.warn('Failed to fetch project details for auto-fill');
                                        return;
                                    }
                                    
                                    const data = await response.json();
                                    const project = data.data || data;
                                    
                                    if (project && project.title) {
                                        // Fill all search input fields with project title
                                        const searchInputs = [
                                            'project-search-active',
                                            'project-search-pending',
                                            'project-search-stalled',
                                            'project-search-completed'
                                        ];
                                        
                                        searchInputs.forEach(inputId => {
                                            const input = document.getElementById(inputId);
                                            if (input) {
                                                input.value = project.title;
                                                // Trigger filter for each table
                                                const tbodyId = inputId.replace('project-search-', 'tbody-');
                                                filterProjectTables(tbodyId);
                                            }
                                        });
                                        
                                        console.log(`Auto-filled search with project: ${project.title}`);
                                    }
                                } catch (error) {
                                    console.error('Error auto-filling search:', error);
                                }
                            }

                            // On page load: choose between global view and "My Projects" view
                            document.addEventListener('DOMContentLoaded', () => {
                                const userRole = localStorage.getItem('userRole');
                                const isPartner = userRole === 'PARTNER';
                                const isDonor = userRole === 'DONOR';

                                if (!isPartner && !isDonor) {
                                    loadProjectStats();
                                }

                                // Always run approve/review button logic for all users
                                (function () {
                                    function setupApproveBtnLogic() {
                                        const approveBtn = document.getElementById('approve-projects-btn');
                                        const approveBtnLabel = document.getElementById('approve-projects-btn-label');
                                        const userStr = localStorage.getItem('currentUser') || localStorage.getItem('user');
                                        let userRole = localStorage.getItem('userRole');
                                        let userObj = null;
                                        if (userStr) {
                                            try { userObj = JSON.parse(userStr); } catch (e) { userObj = null; }
                                        }
                                        if (!userRole && userObj && userObj.role) {
                                            userRole = userObj.role;
                                        }
                                        console.log('[DEBUG] approveBtn:', approveBtn);
                                        console.log('[DEBUG] approveBtnLabel:', approveBtnLabel);
                                        console.log('[DEBUG] userStr:', userStr);
                                        console.log('[DEBUG] userRole:', userRole);
                                        if (approveBtn && approveBtnLabel) {
                                            approveBtn.style.display = '';
                                            if (userRole === 'SUPER_ADMIN_APPROVER') {
                                                approveBtnLabel.textContent = 'Approve Projects';
                                            } else {
                                                approveBtnLabel.textContent = 'Review Projects';
                                            }
                                        } else if (approveBtnLabel) {
                                            approveBtnLabel.textContent = 'Review Projects';
                                        }
                                    }
                                    if (document.readyState === 'loading') {
                                        document.addEventListener('DOMContentLoaded', setupApproveBtnLogic);
                                    } else {
                                        setupApproveBtnLogic();
                                    }
                                })();
                                // If user is SUPER_ADMIN_REVIEWER show thematic title and action buttons
                                try {
                                    if (userRole === 'SUPER_ADMIN_REVIEWER') {
                                        const userStr = localStorage.getItem('currentUser') || localStorage.getItem('user');
                                        let userObj = null;
                                        if (userStr) {
                                            try { userObj = JSON.parse(userStr); } catch (e) { userObj = null; }
                                        }
                                        // ...existing code for reviewer theme display and tokens...
                                        // Show super admin action containers
                                        ['active', 'pending', 'stalled', 'completed'].forEach(s => {
                                            const el = document.getElementById(`sa-actions-${s}`);
                                            if (el) el.classList.remove('hidden');
                                        });
                                        // Ensure reviewer theme tokens and title are set (handles race with auth.js), then enforce filtering
                                        try {
                                            ensureReviewerThemeSetup(10, 500);
                                        } catch (e) { console.error('Error scheduling reviewer theme setup', e); }
                                    }
                                } catch (e) {
                                    console.error('Error initializing SUPER_ADMIN_REVIEWER UI', e);
                                }

                                refreshProjectTables();
                                
                                // Auto-fill search after a short delay to ensure tables are loaded
                                setTimeout(() => {
                                    autoFillSearchFromURL();
                                }, 1000);
                            });

                            // React to hash changes so linking to #my-projects works without reload
                            window.addEventListener('hashchange', () => {
                                refreshProjectTables();
                            });
                        </script>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
    </div>
    <script src="styles/loadNav.js"></script>
    <script src="styles/authnav.js"></script>
    <script src="styles/effects.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tw-elements/js/tw-elements.umd.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Two-Tier Approval Workflow Helper
        function getApprovalWorkflowStatus(project) {
            const status = project.approvalWorkflowStatus || 'UNKNOWN';
            const statusMap = {
                'PENDING_REVIEW': {
                    label: 'Pending Review',
                    description: 'Awaiting thematic reviewer',
                    color: 'bg-yellow-100 text-yellow-800',
                    icon: 'fa-clock'
                },
                'UNDER_REVIEW': {
                    label: 'Under Review',
                    description: 'Being reviewed by thematic reviewer',
                    color: 'bg-blue-100 text-blue-800',
                    icon: 'fa-search'
                },
                'PENDING_FINAL_APPROVAL': {
                    label: 'Pending Final Approval',
                    description: 'Reviewed, awaiting final approver',
                    color: 'bg-purple-100 text-purple-800',
                    icon: 'fa-hourglass-half'
                },
                'REVIEWED': {
                    label: 'Reviewed',
                    description: 'Passed review, ready for final approval',
                    color: 'bg-indigo-100 text-indigo-800',
                    icon: 'fa-check-circle'
                },
                'APPROVED': {
                    label: 'Approved',
                    description: 'Fully approved (both tiers)',
                    color: 'bg-green-100 text-green-800',
                    icon: 'fa-check-double'
                },
                'REJECTED_BY_REVIEWER': {
                    label: 'Rejected by Reviewer',
                    description: 'Rejected at review stage',
                    color: 'bg-red-100 text-red-800',
                    icon: 'fa-times-circle'
                },
                'REJECTED_BY_APPROVER': {
                    label: 'Rejected by Approver',
                    description: 'Rejected at final approval stage',
                    color: 'bg-red-100 text-red-800',
                    icon: 'fa-ban'
                }
            };
            return statusMap[status] || {
                label: status,
                description: 'Unknown status',
                color: 'bg-gray-100 text-gray-800',
                icon: 'fa-question-circle'
            };
        }

        let map, heatLayer;
        let projects = [];
        let filteredProjects = [];
        let sortBy = 'name';
        let sortOrder = 'asc';
        let currentPage = 1;
        const itemsPerPage = 5;
        let currentFilter = 'all';
        let searchQuery = '';
        let dateRangeFrom = null;
        let dateRangeTo = null;


        const markers = [];
        
        // Create colorful SVG icons for markers
        function createMarkerIcon(color, size = 32) {
            return L.divIcon({
                html: `
                    <svg width="${size}" height="${size * 1.2}" viewBox="0 0 32 38" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16 0C9.373 0 4 5.373 4 12c0 9 12 26 12 26s12-17 12-26c0-6.627-5.373-12-12-12z" 
                              fill="${color}" stroke="#FFFFFF" stroke-width="2"/>
                        <circle cx="16" cy="12" r="5" fill="#FFFFFF" opacity="0.9"/>
                    </svg>
                `,
                className: 'custom-marker-icon',
                iconSize: [size, size * 1.2],
                iconAnchor: [size / 2, size * 1.2],
                popupAnchor: [0, -size * 1.2]
            });
        }
        
        // Define colors for different project statuses
        const markerColors = {
            active: '#10B981',      // Green
            pending: '#F59E0B',     // Amber/Orange
            stalled: '#EF4444',     // Red
            completed: '#06B6D4',   // Cyan
            default: '#6B7280'      // Gray
        };
        
        const icons = {
            default: (tag) => createMarkerIcon(markerColors[tag] || markerColors.default, 32),
            selected: (tag) => createMarkerIcon(markerColors[tag] || markerColors.default, 48)
        };

        const bgColors = {
            active: 'bg-green-50',
            pending: 'bg-yellow-50',
            stalled: 'bg-red-50',
            completed: 'bg-cyan-100',
            default: 'bg-white'
        };

        const statusBadge = (tag) => {
            return {
                active: 'bg-green-200 text-green-800',
                pending: 'bg-yellow-200 text-yellow-800',
                stalled: 'bg-red-200 text-red-800',
                completed: 'bg-cyan-300 text-gray-800',
            }[tag] || 'bg-gray-200 text-gray-800';
        };

        // Utility function to get file icon based on file type
        const getFileIcon = (fileType) => {
            const lowerType = (fileType || '').toLowerCase();
            if (lowerType.includes('pdf')) return 'fa-file-pdf text-red-600';
            if (lowerType.includes('word') || lowerType.includes('doc')) return 'fa-file-word text-blue-600';
            if (lowerType.includes('excel') || lowerType.includes('xls') || lowerType.includes('sheet')) return 'fa-file-excel text-green-600';
            if (lowerType.includes('powerpoint') || lowerType.includes('ppt')) return 'fa-file-powerpoint text-orange-600';
            return 'fa-file text-gray-600';
        };

        // Fetch project documents from API
        async function fetchProjectDocuments(projectId) {
            try {
                console.log(`[Documents] Fetching documents for project ID: ${projectId}`);
                const token = localStorage.getItem('accessToken') || localStorage.getItem('token');

                if (!token) {
                    console.error('[Documents] No authentication token found');
                    return []; // Return empty array instead of null for better UX
                }

                const response = await fetch(`${window.BASE_URL}/api/projects/${projectId}/documents`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log(`[Documents] Response status:`, response.status);

                if (response.ok) {
                    const data = await response.json();
                    console.log(`[Documents] Response data:`, data);

                    if (data.status === 200 && data.data) {
                        console.log(`[Documents] Found ${data.data.length} documents for project ${projectId}`);
                        return data.data;
                    } else if (data.status === 200 && (!data.data || data.data.length === 0)) {
                        console.log(`[Documents] No documents found for project ${projectId}`);
                        return []; // Return empty array for no documents
                    } else {
                        console.log(`[Documents] API returned non-200 status or no data:`, data);
                        return []; // Return empty array on unexpected response
                    }
                } else {
                    // Server error (500, etc)
                    console.warn(`[Documents] API call failed with status ${response.status}`);
                    try {
                        const errorData = await response.json();
                        console.error(`[Documents] Error details:`, errorData);
                    } catch (e) {
                        // Can't parse error response
                    }
                    return []; // Return empty array instead of null
                }
            } catch (error) {
                console.error('[Documents] Error fetching documents:', error);
                return []; // Return empty array on error for better UX
            }
        }

        // Render documents as downloadable links
        function renderDocuments(documents, projectId) {
            // Handle no documents (empty array)
            if (!documents || documents.length === 0) {
                return '<p class="text-sm text-gray-500 italic">No supporting documents available</p>';
            }

            return documents.map(doc => `
                <div class="flex items-center justify-between py-2 border-b border-gray-100 hover:bg-gray-50 px-2 rounded">
                    <div class="flex items-center space-x-3">
                        <i class="fas ${getFileIcon(doc.fileType)} text-xl"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-800">${doc.fileName}</p>
                            <p class="text-xs text-gray-500">${formatFileSize(doc.fileSize || doc.size)}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button 
                           onclick="viewProjectDocument(${projectId}, ${doc.id}, '${doc.fileName}')"
                           class="px-3 py-1 text-xs font-semibold text-blue-600 bg-blue-100 rounded hover:bg-blue-200 transition">
                            <i class="fas fa-eye mr-1"></i>View
                        </button>
                        <button 
                           onclick="downloadProjectDocument(${projectId}, ${doc.id}, '${doc.fileName}')"
                           class="px-3 py-1 text-xs font-semibold text-white bg-blue-600 rounded hover:bg-blue-700 transition">
                            <i class="fas fa-download mr-1"></i>Download
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Download project document with authentication
        async function downloadProjectDocument(projectId, documentId, fileName) {
            try {
                const token = localStorage.getItem('accessToken') || localStorage.getItem('token');

                const response = await fetch(
                    `${window.BASE_URL}/api/projects/${projectId}/documents/${documentId}`,
                    {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('[Download] Error downloading document:', error);
                alert('Failed to download document. Please try again.');
            }
        }

        // Format file size for display
        function formatFileSize(bytes) {
            if (!bytes) return 'Unknown size';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        document.addEventListener("DOMContentLoaded", function () {
            map = L.map('kenyaMap', {
                center: [-0.0236, 37.9062],
                zoom: 6.3,
                scrollWheelZoom: false,
                dragging: true,
                touchZoom: false,
                doubleClickZoom: true,
                boxZoom: false,
                keyboard: false,
                zoomControl: true // keeps the + / ‚Äì buttons visible
            });

            var kenyaBounds = [
                [-4.677504, 33.893568],  // Southwest corner (Lat, Lng)
                [5.019938, 41.906895]    // Northeast corner (Lat, Lng)
            ];

            // Set initial view to Kenya
            map.fitBounds(kenyaBounds);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 22,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Restrict map so user cannot pan outside Kenya
            map.setMaxBounds(kenyaBounds);
            map.on('drag', function () {
                map.panInsideBounds(kenyaBounds, { animate: false });
            });

            // This comes from the db  -->
            const markerData = [
                { lat: -1.2921, lng: 36.8219, name: "Project 1", tag: "active" },
                { lat: -0.1023, lng: 34.7619, name: "Project 2", tag: "pending" },
                { lat: 0.3256, lng: 37.1231, name: "Project 3", tag: "stalled" },
                { lat: -1.1504, lng: 36.8907, name: "Project 4", tag: "completed" },
            ];

            // This comes from db-- >
            markerData.forEach((data) => {
                const fullDescription = `Loin ipsum dolor sit amet, leo in savanna stride, rugitus magna echoing plains. 
                    Praeterea mane hunters vigilant, acacia shade sub arbore. Serengeti felis aurum, 
                    crinibus ventis fluctuantibus, prideland auctor sapien. Ungulae zebrae cursitant, 
                    antelopae metu per campos. Territorium regale defenditur, solis ardor fulget super 
                    juba. Luna sub nocte vigil, oculi flammae micantes, silentium ruptum rugitu ${data.name}`;

                data.description = fullDescription.substring(0, 300) + "...";
                data.fullDescription = fullDescription;
                data.region = `Region ${Math.ceil(Math.random() * 10)}`;
                data.budget = `${(Math.random() * 100 + 10).toFixed(2)} million KES`;
                data.team = `${Math.ceil(Math.random() * 15 + 5)} members`;
                data.sponsor = `Sponsor for ${data.name}`;
                data.participants = Math.ceil(Math.random() * 100);
                data.start_date = new Date(Date.now() - Math.random() * 10000000000).toISOString();
                data.status = data.tag;

                const marker = L.marker([data.lat, data.lng], { icon: icons.default(data.tag) })
                    .addTo(map)
                    .bindTooltip(data.name)
                    .on("click", function () {
                        if (selectedMarker && selectedMarker !== this) {
                            selectedMarker.setIcon(icons.default(selectedMarker.tag));
                        }
                        this.setIcon(icons.selected(data.tag));
                        selectedMarker = this;
                        showProjectInfo(data);
                    });

                marker.data = data;
                marker.tag = data.tag;
                markers.push(marker);
            });


            highlightMarkers('all');

            document.getElementById('searchInput').addEventListener('input', (e) => {
                searchQuery = e.target.value.trim().toLowerCase();
                currentPage = 1;
                highlightMarkers(currentFilter);
            });

            document.getElementById('dateFrom').addEventListener('change', (e) => {
                dateRangeFrom = e.target.value ? new Date(e.target.value) : null;
                currentPage = 1;
                highlightMarkers(currentFilter);
            });

            document.getElementById('dateTo').addEventListener('change', (e) => {
                dateRangeTo = e.target.value ? new Date(e.target.value) : null;
                currentPage = 1;
                highlightMarkers(currentFilter);
            });

            document.getElementById('sortSelect').addEventListener('change', (e) => {
                sortProjects(e.target.value);
            });
        });
        // Comes From DB
        async function showProjectInfo(project) {
            const infoBox = document.getElementById("projectInfo");
            infoBox.classList.remove("hidden");

            // Show loading state
            infoBox.innerHTML = `
            <div class="flex flex-wrap">
                <h3 class="mb-4 text-xl font-bold text-gray-800">${project.name}</h3>
                <p><strong>Description:</strong> ${project.description}</p>
                <p><strong>Region:</strong> ${project.region}</p>
                <p><strong>Budget:</strong> ${project.budget}</p>
                <p><strong>Team:</strong> ${project.team}</p>
                <p><strong>Participants:</strong> ${project.participants}</p>
                <p><strong>Sponsor:</strong> ${project.sponsor}</p>
                <p><strong>Start Date:</strong> ${new Date(project.start_date).toLocaleDateString()}</p>
                <p><strong>Status:</strong> <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge(project.status)}">${project.status}</span></p>
                <div class="w-full mt-4">
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Supporting Documents</h4>
                    <div class="text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading documents...</div>
                </div>
            </div>
            `;

            // Fetch and display documents if project has an ID
            if (project.id) {
                const documents = await fetchProjectDocuments(project.id);
                infoBox.innerHTML = `
                <div class="flex flex-wrap">
                    <h3 class="mb-4 text-xl font-bold text-gray-800">${project.name}</h3>
                    <p><strong>Description:</strong> ${project.description}</p>
                    <p><strong>Region:</strong> ${project.region}</p>
                    <p><strong>Budget:</strong> ${project.budget}</p>
                    <p><strong>Team:</strong> ${project.team}</p>
                    <p><strong>Participants:</strong> ${project.participants}</p>
                    <p><strong>Sponsor:</strong> ${project.sponsor}</p>
                    <p><strong>Start Date:</strong> ${new Date(project.start_date).toLocaleDateString()}</p>
                    <p><strong>Status:</strong> <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge(project.status)}">${project.status}</span></p>
                    <div class="w-full mt-4 border-t pt-4">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                            <i class="fas fa-paperclip mr-2"></i>Supporting Documents
                        </h4>
                        <div class="space-y-2">
                            ${renderDocuments(documents, project.id)}
                        </div>
                    </div>
                </div>
                `;
            }
        }

        function focusMarker(index) {
            const marker = markers[index];
            map.setView(marker.getLatLng(), 9);
            marker.fire('click');
            document.getElementById('localMap').scrollIntoView({ behavior: 'smooth' });
        }

        function sortProjects(field) {
            if (sortBy === field) {
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                sortBy = field;
                sortOrder = 'asc';
            }
            currentPage = 1;
            highlightMarkers(currentFilter);
        }

        function highlightMarkers(tag) {
            currentFilter = tag;
            const accordion = document.getElementById("projectAccordion");
            const infoBox = document.getElementById("projectInfo");
            console.log('[highlightMarkers] tag:', tag, 'accordion:', accordion, 'infoBox:', infoBox);
            if (infoBox) infoBox.classList.add("hidden");
            if (accordion) {
                accordion.innerHTML = '';
                accordion.classList.remove("hidden");
                accordion.classList.add("opacity-0", "translate-y-4");
            }

            let filteredMarkers = markers.filter(marker => {
                const p = marker.data;
                if (tag !== 'all' && marker.tag !== tag) return false;
                if (searchQuery && !p.name.toLowerCase().includes(searchQuery)) return false;
                const pDate = new Date(p.start_date);
                if (dateRangeFrom && pDate < dateRangeFrom) return false;
                if (dateRangeTo && pDate > dateRangeTo) return false;
                return true;
            });

            filteredMarkers.sort((a, b) => {
                const aVal = sortBy === 'name' ? a.data.name : new Date(a.data.start_date);
                const bVal = sortBy === 'name' ? b.data.name : new Date(b.data.start_date);
                return sortOrder === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
            });

            const totalPages = Math.ceil(filteredMarkers.length / itemsPerPage);
            const paginated = filteredMarkers.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
            console.log('[highlightMarkers] totalPages:', totalPages, 'paginated:', paginated);
            updatePaginationControls(totalPages);

            markers.forEach(marker => {
                marker.setOpacity(filteredMarkers.includes(marker) ? 1 : 0.1);
            });

            if (accordion) {
                setTimeout(() => accordion.classList.remove("opacity-0", "translate-y-4"), 10);

                paginated.forEach((marker, idx) => {
                    const i = markers.indexOf(marker);
                    const project = marker.data;
                    const bg = bgColors[project.status] || bgColors.default;

                    const item = document.createElement("div");
                    item.className = `rounded shadow-sm ${bg}`;

                    item.innerHTML = `
                        <button class="w-full px-6 py-4 text-left border-b focus:outline-none" data-toggle="collapse-${i}">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                                <div>
                                    <h4 class="text-lg font-semibold text-gray-800">${project.name}</h4>
                                    <p id="desc-${i}" class="mt-2 text-sm text-gray-600">${project.description}</p>
                                </div>
                                <div class="flex items-center mt-2 text-sm font-semibold tracking-wider text-gray-500 sm:mt-0">
                                    ${new Date(project.start_date).toLocaleDateString()}
                                </div>
                            </div>
                        </button>
                        <div id="collapse-${i}" class="hidden px-6 py-4 bg-white">
                            <p><strong>Region:</strong> ${project.region}</p>
                            <p><strong>Budget:</strong> ${project.budget}</p>
                            <p><strong>Team:</strong> ${project.team}</p>
                            <p><strong>Participants:</strong> ${project.participants}</p>
                            <p><strong>Sponsor:</strong> ${project.sponsor}</p>
                            <p><strong>Status:</strong> 
                                <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge(project.status)}">
                                    ${project.status}
                                </span>
                            </p>
                            <div class="mt-4 pt-4 border-t">
                                <h5 class="text-md font-semibold text-gray-800 mb-2 flex items-center">
                                    <i class="fas fa-paperclip mr-2"></i>Supporting Documents
                                </h5>
                                <div id="documents-${i}" class="space-y-2">
                                    <p class="text-sm text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading documents...</p>
                                </div>
                            </div>
                            <button onclick="focusMarker(${i})" class="px-5 py-2 mt-3 text-sm font-semibold text-white transition bg-blue-600 rounded hover:bg-blue-700 hover:scale-105">
                                Show on Map
                            </button>
                        </div>
                    `;

                    accordion.appendChild(item);

                    // Toggle description between truncated and full
                    const btn = item.querySelector(`[data-toggle="collapse-${i}"]`);
                    btn.addEventListener("click", async () => {
                        const collapse = document.getElementById(`collapse-${i}`);
                        const desc = document.getElementById(`desc-${i}`);
                        if (collapse) collapse.classList.toggle("hidden");

                        if (collapse && !collapse.classList.contains("hidden")) {
                            desc.textContent = project.fullDescription; // expand

                            // Load documents when accordion is opened
                            if (project.id) {
                                const documentsContainer = document.getElementById(`documents-${i}`);
                                const documents = await fetchProjectDocuments(project.id);
                                documentsContainer.innerHTML = renderDocuments(documents, project.id);
                            }
                        } else {
                            desc.textContent = project.description; // truncate
                        }
                    });
                });
            }
        }

        function updatePaginationControls(totalPages) {
            const container = document.getElementById("paginationControls");
            console.log('[updatePaginationControls] container:', container, 'totalPages:', totalPages);
            if (!container) {
                console.warn('[updatePaginationControls] #paginationControls not found');
                return;
            }
            container.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement("button");
                btn.textContent = i;
                btn.className = `px-3 py-1 rounded ${i === currentPage ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}`;
                btn.onclick = () => {
                    currentPage = i;
                    highlightMarkers(currentFilter);
                };
                container.appendChild(btn);
            }
        }

        function exportCSV() {
            const headers = ['Name', 'Description', 'Region', 'Budget', 'Team', 'Participants', 'Sponsor', 'Start Date', 'Status'];
            const rows = markers
                .map(m => m.data)
                .filter(p => {
                    if (searchQuery && !p.name.toLowerCase().includes(searchQuery)) return false;
                    const date = new Date(p.start_date);
                    if (dateRangeFrom && date < dateRangeFrom) return false;
                    if (dateRangeTo && date > dateRangeTo) return false;
                    if (currentFilter !== 'all' && p.status !== currentFilter) return false;
                    return true;
                })
                .map(p => [
                    p.name, p.description, p.region, p.budget, p.team, p.participants,
                    p.sponsor, new Date(p.start_date).toLocaleDateString(), p.status
                ]);

            let csvContent = [headers.join(',')];
            rows.forEach(r => csvContent.push(r.map(field => `"${field}"`).join(',')));

            const blob = new Blob([csvContent.join('\n')], { type: 'text/csv' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `projects_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Filter project tables based on search
        function filterProjectTables(tbodyId) {
            const tbody = document.getElementById(tbodyId);
            if (!tbody) return;

            // Get search input for this tbody
            const searchInput = document.getElementById(`project-search-${tbodyId.replace('tbody-', '')}`);

            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';

            // Get all column filter inputs for this tbody
            const columnFilters = [];
            for (let i = 1; i <= 10; i++) { // Columns 1-10 (skip # column at index 0)
                const filterInput = document.querySelector(`input[oninput*="filterColumn('${tbodyId}', ${i},"`);
                if (filterInput) {
                    columnFilters.push({
                        index: i,
                        value: filterInput.value.toLowerCase().trim()
                    });
                }
            }

            const rows = tbody.querySelectorAll('tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');

                // Skip if it's the empty message row (has colspan)
                if (cells.length === 1 && cells[0].hasAttribute('colspan')) {
                    row.style.display = 'none'; // Hide message initially
                    return;
                }

                if (cells.length < 7) return; // Not a data row

                // Check global search term
                let matchesGlobalSearch = true;
                if (searchTerm) {
                    const projectNo = cells[1].textContent.toLowerCase();
                    const title = cells[2].textContent.toLowerCase();
                    const category = cells[3].textContent.toLowerCase();
                    const themes = cells[4].textContent.toLowerCase();
                    const locations = cells[5].textContent.toLowerCase();
                    const status = cells[6].textContent.toLowerCase();
                    const contact = cells[9].textContent.toLowerCase();
                    const budget = cells[10].textContent.toLowerCase();

                    matchesGlobalSearch = projectNo.includes(searchTerm) ||
                        title.includes(searchTerm) ||
                        category.includes(searchTerm) ||
                        themes.includes(searchTerm) ||
                        locations.includes(searchTerm) ||
                        contact.includes(searchTerm) ||
                        budget.includes(searchTerm);
                }

                // Check column filters
                let matchesColumnFilters = true;
                for (const filter of columnFilters) {
                    if (filter.value && cells[filter.index]) {
                        const cellText = cells[filter.index].textContent.toLowerCase();
                        if (!cellText.includes(filter.value)) {
                            matchesColumnFilters = false;
                            break;
                        }
                    }
                }

                // Show/hide row based on both global search and column filters
                if (matchesGlobalSearch && matchesColumnFilters) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Show empty message if no rows visible
            const messageRow = tbody.querySelector('tr td[colspan]');
            if (messageRow) {
                messageRow.parentElement.style.display = visibleCount === 0 ? '' : 'none';
            }
        }

        // Filter table by specific column
        function filterColumn(tbodyId, columnIndex, filterValue) {
            const tbody = document.getElementById(tbodyId);
            if (!tbody) return;

            const filterTerm = filterValue.toLowerCase().trim();

            // Get search input for this tbody (global search)
            const searchInput = document.getElementById(`project-search-${tbodyId.replace('tbody-', '')}`);
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';

            // Get all other column filter inputs for this tbody
            const columnFilters = [];
            for (let i = 1; i <= 10; i++) { // Columns 1-10 (skip # column at index 0)
                if (i !== columnIndex) { // Skip the current column being filtered
                    const filterInput = document.querySelector(`input[oninput*="filterColumn('${tbodyId}', ${i},"`);
                    if (filterInput) {
                        columnFilters.push({
                            index: i,
                            value: filterInput.value.toLowerCase().trim()
                        });
                    }
                }
            }

            const rows = tbody.querySelectorAll('tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');

                // Skip if it's the empty message row (has colspan)
                if (cells.length === 1 && cells[0].hasAttribute('colspan')) {
                    row.style.display = 'none'; // Hide message initially
                    return;
                }

                if (cells.length < columnIndex + 1) return; // Not a data row or column doesn't exist

                // Check global search term
                let matchesGlobalSearch = true;
                if (searchTerm) {
                    const projectNo = cells[1].textContent.toLowerCase();
                    const title = cells[2].textContent.toLowerCase();
                    const category = cells[3].textContent.toLowerCase();
                    const themes = cells[4].textContent.toLowerCase();
                    const locations = cells[5].textContent.toLowerCase();
                    const status = cells[6].textContent.toLowerCase();
                    const contact = cells[9].textContent.toLowerCase();
                    const budget = cells[10].textContent.toLowerCase();

                    matchesGlobalSearch = projectNo.includes(searchTerm) ||
                        title.includes(searchTerm) ||
                        category.includes(searchTerm) ||
                        themes.includes(searchTerm) ||
                        locations.includes(searchTerm) ||
                        contact.includes(searchTerm) ||
                        budget.includes(searchTerm);
                }

                // Check current column filter
                const cellText = cells[columnIndex].textContent.toLowerCase();
                const matchesCurrentFilter = !filterTerm || cellText.includes(filterTerm);

                // Check other column filters
                let matchesOtherFilters = true;
                for (const filter of columnFilters) {
                    if (filter.value && cells[filter.index]) {
                        const otherCellText = cells[filter.index].textContent.toLowerCase();
                        if (!otherCellText.includes(filter.value)) {
                            matchesOtherFilters = false;
                            break;
                        }
                    }
                }

                // Show/hide row based on all filters
                if (matchesGlobalSearch && matchesCurrentFilter && matchesOtherFilters) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Show empty message if no rows visible
            const messageRow = tbody.querySelector('tr td[colspan]');
            if (messageRow) {
                messageRow.parentElement.style.display = visibleCount === 0 ? '' : 'none';
            }
        }

        // Enforce reviewer thematic area on already-rendered table rows
        // Only update the reviewer thematic area title (filtering is now done on the data array)
        function filterRenderedTableRowsByReviewerTheme() {
            try {
                const userStr = localStorage.getItem('currentUser') || localStorage.getItem('user');
                if (!userStr) return;
                let userObj = null;
                try { userObj = JSON.parse(userStr); } catch (e) { return; }

                const code = (userObj && (userObj.thematicArea || userObj.thematicAreaCode || userObj.themeCode) || '').toString().trim();
                if (!code) return;

                const themeDisplayMap = {
                    'AYPSRH': 'Adolescent and Young People Sexual and Reproductive Health',
                    'FP': 'Family Planning',
                    'CH': 'Child Health',
                    'GBV': 'Gender Based Violence',
                    'MNH': 'Maternal and Newborn Health',
                    'AH': 'Adolescent Health'
                };

                // Update the title if it's just the code (show friendly name when known)
                const titleEl = document.getElementById('pageTitle');
                if (titleEl) {
                    const current = titleEl.textContent || '';
                    const displayName = themeDisplayMap[code.toUpperCase()] || code;
                    if (current.toLowerCase().includes('all thematic projects')) {
                        if (displayName && String(displayName).toLowerCase() !== 'unknown') {
                            titleEl.innerHTML = `All Thematic Projects for theme <strong>${displayName}</strong>`;
                        } else {
                            titleEl.innerHTML = `All Thematic Projects`;
                        }
                    }
                }
            } catch (e) {
                console.error('filterRenderedTableRowsByReviewerTheme error', e);
            }
        }

        // Show/hide admin collaboration menu and load pending count
        document.addEventListener('DOMContentLoaded', async function () {
            const userRole = localStorage.getItem('userRole');

            // Populate user dropdown
            let user = null;
            const userStr = localStorage.getItem('currentUser') || localStorage.getItem('user');
            if (userStr) {
                try {
                    user = JSON.parse(userStr);
                } catch (e) {
                    console.error("Error parsing user data:", e);
                }
            }

            // Populate user dropdown if user data exists
            if (user) {
                console.log("üë§ Populating user dropdown...");
                const userDisplayName = document.getElementById("userDisplayName");
                const userNameDisplay = document.getElementById("userNameDisplay");
                const userEmailDisplay = document.getElementById("userEmailDisplay");
                const userRoleDisplay = document.getElementById("userRoleDisplay");
                const userStatusDisplay = document.getElementById("userStatusDisplay");

                if (userDisplayName) userDisplayName.textContent = user.name || "User";
                if (userNameDisplay) userNameDisplay.textContent = user.name || "Loading...";
                if (userEmailDisplay) userEmailDisplay.textContent = user.email || "";
                if (userRoleDisplay) userRoleDisplay.textContent = user.role || "N/A";
                if (userStatusDisplay) {
                    userStatusDisplay.textContent = user.status || "N/A";
                    userStatusDisplay.className = user.status === "ACTIVE"
                        ? "font-medium text-green-600"
                        : "font-medium text-gray-600";
                }
                console.log("‚úÖ User dropdown populated!");
            } else {
                // Try to get user from authManager if available
                if (window.authManager && typeof window.authManager.getCurrentUser === 'function') {
                    try {
                        user = await window.authManager.getCurrentUser();
                        if (user) {
                            const userDisplayName = document.getElementById("userDisplayName");
                            const userNameDisplay = document.getElementById("userNameDisplay");
                            const userEmailDisplay = document.getElementById("userEmailDisplay");
                            const userRoleDisplay = document.getElementById("userRoleDisplay");
                            const userStatusDisplay = document.getElementById("userStatusDisplay");

                            if (userDisplayName) userDisplayName.textContent = user.name || "User";
                            if (userNameDisplay) userNameDisplay.textContent = user.name || "Loading...";
                            if (userEmailDisplay) userEmailDisplay.textContent = user.email || "";
                            if (userRoleDisplay) userRoleDisplay.textContent = user.role || "N/A";
                            if (userStatusDisplay) {
                                userStatusDisplay.textContent = user.status || "N/A";
                                userStatusDisplay.className = user.status === "ACTIVE"
                                    ? "font-medium text-green-600"
                                    : "font-medium text-gray-600";
                            }
                        }
                    } catch (e) {
                        console.log("‚ö†Ô∏è Could not load user from authManager:", e);
                    }
                }
            }

            // Show admin menu items if user is admin or super admin
            if (userRole === 'ADMIN' || userRole === 'SUPER_ADMIN') {
                const adminMenuItem = document.getElementById('admin-collab-menu');
                if (adminMenuItem) adminMenuItem.style.display = 'block';

                // Load pending collaboration requests count
                loadPendingCount();
            }
        });

        async function loadPendingCount() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${window.BASE_URL}/api/collaboration-requests/admin/pending`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.status === 200 && data.data.length > 0) {
                    const badge = document.getElementById('pending-count');
                    if (badge) {
                        badge.textContent = data.data.length;
                        badge.style.display = 'inline-block';
                    }
                }
            } catch (error) {
                console.error('Error loading pending requests count:', error);
            }
        }
    </script>
    <script>
        // Project creation form handling
        document.addEventListener('DOMContentLoaded', function () {
            let locationCounter = 0;
            const locationsContainer = document.getElementById('locationsContainer');
            const addLocationBtn = document.getElementById('addLocationBtn');
            const newProjectForm = document.getElementById('newProjectForm');

            // Initialize with one location
            addLocationEntry();

            // Add location button handler
            addLocationBtn.addEventListener('click', function () {
                addLocationEntry();
            });

            // Form submission handler
            newProjectForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                // Validate themes
                const selectedThemes = Array.from(document.querySelectorAll('input[name="themes"]:checked')).map(cb => cb.value);
                if (selectedThemes.length === 0) {
                    document.getElementById('themesError').classList.remove('hidden');
                    return;
                } else {
                    document.getElementById('themesError').classList.add('hidden');
                }

                // Validate locations
                const locationEntries = document.querySelectorAll('.location-entry');
                if (locationEntries.length === 0) {
                    document.getElementById('locationsError').classList.remove('hidden');
                    return;
                } else {
                    document.getElementById('locationsError').classList.add('hidden');
                }

                // Collect locations data
                const locations = [];
                locationEntries.forEach(entry => {
                    const county = entry.querySelector('input[name*="county"]').value;
                    const subCounty = entry.querySelector('input[name*="subcounty"]').value;
                    const mapsAddress = entry.querySelector('input[name*="maps_address"]').value;
                    const latitude = entry.querySelector('input[name*="latitude"]').value;
                    const longitude = entry.querySelector('input[name*="longitude"]').value;

                    if (county.trim()) {
                        locations.push({
                            county: county,
                            subCounty: subCounty || null,
                            mapsAddress: mapsAddress || null,
                            latitude: latitude ? parseFloat(latitude) : null,
                            longitude: longitude ? parseFloat(longitude) : null
                        });
                    }
                });

                if (locations.length === 0) {
                    document.getElementById('locationsError').classList.remove('hidden');
                    return;
                }

                // Prepare form data
                const formData = {
                    title: document.getElementById('title').value,
                    partner: document.getElementById('title').value, // Will be overridden by backend
                    themes: selectedThemes,
                    projectCategory: document.getElementById('category').value,
                    startDate: document.getElementById('starttime_period').value,
                    endDate: document.getElementById('endtime_period').value,
                    activityType: document.getElementById('activity_type').value,
                    locations: locations,
                    contactPersonName: document.getElementById('contact_person').value,
                    contactPersonRole: document.querySelector('input[name="contact_person_role"]').value,
                    contactPersonEmail: document.querySelector('input[name="contact_person_mail"]').value,
                    objectives: document.getElementById('gaps').value,
                    budget: parseFloat(document.getElementById('budget').value)
                };

                try {
                    const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                    const response = await fetch(`${window.BASE_URL || 'http://localhost:8080'}/api/projects`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(formData)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // Extract project number from response
                        const projectNumber = result.data?.projectNo || result.projectNo || 'N/A';

                        // Show success message with project number and copy option
                        const projectNumberHtml = `
                            <div class="text-center">
                                <p class="text-lg mb-4">Your project has been created successfully!</p>
                                <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-4">
                                    <p class="text-sm text-gray-600 mb-2">Your Project Number:</p>
                                    <p class="text-2xl font-bold text-blue-700" id="projectNumberDisplay">${projectNumber}</p>
                                </div>
                                <button onclick="navigator.clipboard.writeText('${projectNumber}').then(() => alert('Project number copied to clipboard!'))" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-copy mr-2"></i>Copy Project Number
                                </button>
                                <p class="text-sm text-gray-600 mt-4">‚ö†Ô∏è Please save this project number for future reference.</p>
                            </div>
                        `;

                        await showAlert(projectNumberHtml, 'Project Created Successfully!', 'success');
                        // Close modal and refresh page
                        const modal = document.getElementById('createNewProject');
                        if (modal) {
                            modal.classList.add('hidden');
                        }
                        location.reload();
                    } else {
                        await showAlert('Error creating project: ' + (result.message || 'Unknown error'), 'Error', 'error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    await showAlert('Error creating project. Please try again.', 'Error', 'error');
                }
            });

            function addLocationEntry() {
                locationCounter++;
                const locationId = `location_${locationCounter}`;

                const locationEntry = document.createElement('div');
                locationEntry.className = 'location-entry border border-gray-200 rounded-lg p-4 bg-gray-50';
                locationEntry.innerHTML = `
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-sm font-medium text-gray-700">Location ${locationCounter}</h4>
                            <button type="button" class="remove-location text-red-600 hover:text-red-800 text-sm" data-location-id="${locationId}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 011-1V4z"></path>
                                </svg>
                                Remove
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">County *</label>
                                <input type="text" name="county_${locationId}" required
                                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                    placeholder="Enter county name" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Sub-County</label>
                                <input type="text" name="subcounty_${locationId}"
                                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                    placeholder="Enter sub-county (optional)" />
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Location on Map</label>
                            <div class="text-xs text-gray-600 mb-2">
                                Search for a location or click on the map to select coordinates.
                            </div>
                            <div id="map_${locationId}" style="
                                height: 300px;
                                width: 100%;
                                border-radius: 8px;
                                margin-bottom: 8px;
                                border: 1px solid #e5e7eb;
                                background-color: #f3f4f6;
                                position: relative;
                                overflow: hidden;
                            "></div>
                            <input type="hidden" name="latitude_${locationId}" />
                            <input type="hidden" name="longitude_${locationId}" />
                            <input type="hidden" name="maps_address_${locationId}" />
                            <div class="text-sm text-gray-700 mt-2 p-2 bg-white rounded border">
                                <strong>Selected Location:</strong>
                                <span id="selectedLatLng_${locationId}" class="font-mono text-blue-600">Click on map to select location</span>
                                <br />
                                <span id="selectedCounty_${locationId}" class="text-gray-600"></span>
                            </div>
                        </div>
                    `;

                // Check if locationsContainer exists before appending
                if (typeof locationsContainer !== 'undefined' && locationsContainer) {
                    locationsContainer.appendChild(locationEntry);
                } else {
                    console.error('locationsContainer element not found. Cannot append location entry.');
                    return;
                }

                // Initialize map for this location
                initializeLocationMap(locationId);

                // Add remove handler
                locationEntry.querySelector('.remove-location').addEventListener('click', function () {
                    locationEntry.remove();
                    updateLocationNumbers();
                });

                updateLocationNumbers();
            }

            function updateLocationNumbers() {
                const entries = document.querySelectorAll('.location-entry');
                entries.forEach((entry, index) => {
                    const title = entry.querySelector('h4');
                    if (title) {
                        title.textContent = `Location ${index + 1}`;
                    }
                });
            }

            function initializeLocationMap(locationId) {
                const mapElement = document.getElementById(`map_${locationId}`);
                const latLngElement = document.getElementById(`selectedLatLng_${locationId}`);
                const countyElement = document.getElementById(`selectedCounty_${locationId}`);
                const latInput = document.querySelector(`input[name="latitude_${locationId}"]`);
                const lngInput = document.querySelector(`input[name="longitude_${locationId}"]`);
                const addressInput = document.querySelector(`input[name="maps_address_${locationId}"]`);

                // Initialize Leaflet map
                const map = L.map(mapElement).setView([-1.2864, 36.8172], 10); // Default to Nairobi

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);

                let marker;

                map.on('click', function (e) {
                    const { lat, lng } = e.latlng;

                    // Remove existing marker
                    if (marker) {
                        map.removeLayer(marker);
                    }

                    // Add new marker
                    marker = L.marker([lat, lng]).addTo(map);

                    // Update display
                    latLngElement.textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    latInput.value = lat;
                    lngInput.value = lng;

                    // Reverse geocoding to get address
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                        .then(response => response.json())
                        .then(data => {
                            const address = data.display_name || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                            addressInput.value = address;

                            // Try to extract county information
                            const county = extractCountyFromAddress(data);
                            countyElement.textContent = county ? `County: ${county}` : '';
                            const countyInput = document.querySelector(`input[name="county_${locationId}"]`);
                            if (countyInput && !countyInput.value) {
                                countyInput.value = county || '';
                            }
                        })
                        .catch(error => {
                            console.error('Error reverse geocoding:', error);
                            addressInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                        });
                });
            }

            function extractCountyFromAddress(data) {
                // Try to extract county from OpenStreetMap data
                if (data.address) {
                    return data.address.county || data.address.state || data.address.region || null;
                }
                return null;
            }

            // Project Details Modal Functions
            window.viewProjectDetails = async function (projectId) {
                const modal = document.getElementById('projectDetailsModal');
                const content = document.getElementById('projectDetailsContent');

                modal.classList.remove('hidden');
                content.innerHTML = '<p class="text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading project details...</p>';

                try {
                    const headers = {
                        'Content-Type': 'application/json',
                        Authorization: 'Bearer ' + (localStorage.getItem('accessToken') || '')
                    };

                    const res = await fetch(`${API_BASE}/projects/${projectId}`, {
                        method: 'GET',
                        credentials: 'include',
                        headers
                    });

                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const data = await res.json();

                    if (data.status === 200 && data.data) {
                        const project = data.data;

                        // Fetch documents
                        const documents = await fetchProjectDocuments(projectId);

                        // Render project details
                        content.innerHTML = `
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><strong class="text-gray-700">Project No:</strong> <span class="text-gray-900">${project.projectNo || 'N/A'}</span></div>
                                    <div><strong class="text-gray-700">Status:</strong> <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge(project.status)}">${project.status || 'N/A'}</span></div>
                                    <div><strong class="text-gray-700">Partner:</strong> <span class="text-gray-900">${project.partner || 'N/A'}</span></div>
                                    <div><strong class="text-gray-700">Budget:</strong> <span class="text-gray-900">KES ${(project.budget || 0).toLocaleString()}</span></div>
                                    <div><strong class="text-gray-700">Start Date:</strong> <span class="text-gray-900">${project.startDate || 'N/A'}</span></div>
                                    <div><strong class="text-gray-700">End Date:</strong> <span class="text-gray-900">${project.endDate || 'N/A'}</span></div>
                                    <div><strong class="text-gray-700">Activity Type:</strong> <span class="text-gray-900">${project.activityType || 'N/A'}</span></div>
                                    <div><strong class="text-gray-700">Category:</strong> <span class="text-gray-900">${project.projectCategory || 'N/A'}</span></div>
                                </div>
                                
                                <div><strong class="text-gray-700">Title:</strong> <p class="text-gray-900 mt-1">${project.title || 'N/A'}</p></div>
                                <div><strong class="text-gray-700">Objectives:</strong> <p class="text-gray-900 mt-1">${project.objectives || 'N/A'}</p></div>
                                
                                ${project.themes && project.themes.length > 0 ? `
                                    <div>
                                        <strong class="text-gray-700">Themes:</strong>
                                        <div class="flex flex-wrap gap-2 mt-2">
                                            ${project.themes.map(theme => `<span class="inline-block px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded-full">${theme.name || theme.code}</span>`).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${project.locations && project.locations.length > 0 ? `
                                        
                                    <div>
                                        <strong class="text-gray-700">Locations:</strong>
                                        <div class="mt-2 space-y-1">
                                            ${project.locations.map(loc => {
                            // Check if mapsAddress is a meaningful address (not just coordinates)
                            const isCoordinatesOnly = loc.mapsAddress && /^-?\d+\.?\d*,\s*-?\d+\.?\d*$/.test(loc.mapsAddress.trim());
                            // Show mapsAddress if available and NOT just coordinates, otherwise fallback to county
                            const displayName = (loc.mapsAddress && !isCoordinatesOnly)
                                ? loc.mapsAddress
                                : (loc.county ? `${loc.county}${loc.subCounty ? ', ' + loc.subCounty : ''}` : 'Unknown');
                            const coordinates = (loc.latitude && loc.longitude) ? `<span class="text-xs text-gray-500 ml-2">(${loc.latitude.toFixed(4)}, ${loc.longitude.toFixed(4)})</span>` : '';
                            return `<div class="text-gray-900"><i class="fas fa-map-marker-alt text-red-500 mr-2"></i>${displayName}${coordinates}</div>`;
                        }).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="pt-4 border-t">
                                    <strong class="text-gray-700">Contact Person:</strong>
                                    <div class="mt-2 space-y-1">
                                        <div class="text-gray-900"><i class="fas fa-user mr-2"></i>${project.contactPersonName || 'N/A'}</div>
                                        <div class="text-gray-900"><i class="fas fa-briefcase mr-2"></i>${project.contactPersonRole || 'N/A'}</div>
                                        <div class="text-gray-900"><i class="fas fa-envelope mr-2"></i>${project.contactPersonEmail || 'N/A'}</div>
                                    </div>
                                </div>
                                
                                <div class="pt-4 border-t">
                                    <h4 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                                        <i class="fas fa-paperclip mr-2"></i>Supporting Documents
                                    </h4>
                                    <div class="space-y-2">
                                        ${renderDocuments(documents, projectId)}
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        content.innerHTML = '<p class="text-red-600">Failed to load project details.</p>';
                    }
                } catch (error) {
                    console.error('Error loading project details:', error);
                    content.innerHTML = '<p class="text-red-600">Error loading project details: ' + error.message + '</p>';
                }
            };

            window.closeProjectDetailsModal = function () {
                const modal = document.getElementById('projectDetailsModal');
                modal.classList.add('hidden');
            };
        });
    </script>

    <!-- Global Functions for onclick handlers -->
    <script>
        // Project Details Modal Functions - Must be in global scope for onclick
        window.viewProjectDetails = async function (projectId) {
            const modal = document.getElementById('projectDetailsModal');
            const content = document.getElementById('projectDetailsContent');

            modal.classList.remove('hidden');
            content.innerHTML = '<p class="text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading project details...</p>';

            try {
                const API_BASE = window.BASE_URL || 'http://localhost:8080';
                const headers = {
                    'Content-Type': 'application/json',
                    Authorization: 'Bearer ' + (localStorage.getItem('accessToken') || '')
                };

                const res = await fetch(`${API_BASE}/api/projects/${projectId}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers
                });

                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();

                if (data.status === 200 && data.data) {
                    const project = data.data;

                    // Fetch documents
                    const documents = await fetchProjectDocuments(projectId);

                    // Render project details
                    content.innerHTML = `
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 ">
    
                            <div class="lg:col-span-2 space-y-8">
                                <h1 class="text-3xl font-extrabold text-blue-900">${project.title || 'N/A'}</h1>
                                
                                <div>
                                    <h4 class="text-xl font-bold text-gray-800 mb-3 border-b pb-1">Objectives</h4>
                                    <p class="text-gray-700 leading-relaxed">${project.objectives || 'N/A'}</p>
                                </div>
                                
                                ${project.themes && project.themes.length > 0 ? `
                                <div>
                                    <h4 class="text-xl font-bold text-gray-800 mb-3 border-b pb-1">Themes</h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${project.themes.map(theme => `<span class="inline-flex items-center px-4 py-1 text-sm bg-blue-100 text-blue-800 rounded-full font-medium"><i class="fas fa-tag mr-2"></i>${theme.name || theme.code}</span>`).join('')}
                                    </div>
                                </div>
                                ` : ''}

                                ${project.locations && project.locations.length > 0 ? `
                                <div>
                                    <h4 class="text-xl font-bold text-gray-800 mb-3 border-b pb-1">Locations</h4>
                                    <div class="mt-2 space-y-2">
                                        ${project.locations.map(loc => {
                        // Check if mapsAddress is a meaningful address (not just coordinates)
                        const isCoordinatesOnly = loc.mapsAddress && /^-?\d+\.?\d*,\s*-?\d+\.?\d*$/.test(loc.mapsAddress.trim());
                        // Show mapsAddress if available and NOT just coordinates, otherwise fallback to county/subcounty
                        const displayName = (loc.mapsAddress && !isCoordinatesOnly)
                            ? loc.mapsAddress
                            : (loc.county ? `${loc.county}${loc.subCounty ? ', ' + loc.subCounty : ''}` : 'Unknown');
                        const coordinates = (loc.latitude && loc.longitude) ? `<span class="text-xs text-gray-500 ml-6">(${loc.latitude.toFixed(4)}, ${loc.longitude.toFixed(4)})</span>` : '';
                        return `<div class="text-gray-800 flex items-start"><i class="fas fa-map-marker-alt text-red-500 mr-2 w-4 text-center mt-1"></i><div>${displayName}${coordinates}</div></div>`;
                    }).join('')}
                                    </div>
                                </div>
                                ` : ''}

                                <div class="pt-4 border-t">
                                    <h4 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                                        <i class="fas fa-paperclip mr-2 text-gray-500"></i>Supporting Documents
                                    </h4>
                                    <div class="space-y-2">
                                        ${renderDocuments(documents, projectId)}
                                    </div>
                                </div>
                            </div>

                            <div class="lg:col-span-1 bg-gray-50 p-6 rounded-lg space-y-6 h-fit border border-gray-200">
                                <h3 class="text-lg font-bold text-blue-800 border-b pb-2 mb-4">Key Details</h3>
                                
                                <dl class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <dt class="text-gray-500">Project No:</dt>
                                        <dd class="font-semibold text-gray-900">${project.projectNo || 'N/A'}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-500">Status:</dt>
                                        <dd><span class="inline-block px-3 py-1 text-xs rounded-full font-bold ${statusBadge(project.status)}">${project.status || 'N/A'}</span></dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-500">Partner:</dt>
                                        <dd class="text-gray-900">
                                            ${project.partnerName ? `
                                                ${project.partnerName}
                                            ` : 'N/A'}
                                        </dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-500">Budget:</dt>
                                        <dd class="font-bold text-green-700">KES ${(project.budget || 0).toLocaleString()}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-500">Start Date:</dt>
                                        <dd class="text-gray-900">${project.startDate || 'N/A'}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-500">End Date:</dt>
                                        <dd class="text-gray-900">${project.endDate || 'N/A'}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-500">Activity Type:</dt>
                                        <dd class="text-gray-900">${project.activityType || 'N/A'}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-500">Category:</dt>
                                        <dd class="text-gray-900">${project.projectCategory || 'N/A'}</dd>
                                    </div>
                                </dl>
                                
                                <div class="pt-4 border-t">
                                    <h4 class="text-base font-bold text-gray-700 mb-2 flex items-center"><i class="fas fa-user-tie mr-2"></i>Contact Person</h4>
                                    <div class="space-y-1 pl-4">
                                        <div class="text-gray-900 flex items-center text-sm">
                                            <i class="fas fa-user mr-2 w-4 text-center text-gray-400"></i>
                                            ${project.contactPersonName || 'N/A'}
                                        </div>
                                        <div class="text-gray-900 flex items-center text-sm">
                                            <i class="fas fa-briefcase mr-2 w-4 text-center text-gray-400"></i>
                                            ${project.contactPersonRole || 'N/A'}
                                        </div>
                                        <div class="text-gray-900 flex items-center text-sm">
                                            <i class="fas fa-envelope mr-2 w-4 text-center text-gray-400"></i>
                                            <a href="mailto:${project.contactPersonEmail}" class="text-blue-600 hover:text-blue-800">
                                                ${project.contactPersonEmail || 'N/A'}
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = '<p class="text-red-600">Failed to load project details.</p>';
                }
            } catch (error) {
                console.error('Error loading project details:', error);
                content.innerHTML = '<p class="text-red-600">Error loading project details: ' + error.message + '</p>';
            }
        };

        window.closeProjectDetailsModal = function () {
            const modal = document.getElementById('projectDetailsModal');
            modal.classList.add('hidden');
        };

        // Edit Project Function
        window.editProject = function (projectId) {
            // Navigate to new-project.html with edit mode and project ID
            window.location.href = `new-project.html?edit=${projectId}`;
        };

        // Delete Project Function
        window.deleteProject = async function (projectId) {
            if (!confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
                return;
            }

            try {
                const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                const API_BASE = window.BASE_URL || 'http://localhost:8080';

                const response = await fetch(`${API_BASE}/api/projects/${projectId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    alert('Project deleted successfully!');
                    // Reload the page to refresh the project list
                    window.location.reload();
                } else if (response.status === 404) {
                    // Project not found on server - remove it from the UI
                    const projectRow = document.querySelector(`button[onclick*="deleteProject(${projectId})"]`);
                    if (projectRow) {
                        // Find the table row (tr) containing this button
                        const row = projectRow.closest('tr');
                        if (row) {
                            row.remove();
                            alert('Project was not found on the server and has been removed from the list.');
                        } else {
                            alert('Project not found. It may have already been deleted or never existed.');
                            window.location.reload();
                        }
                    } else {
                        alert('Project not found. It may have already been deleted or never existed.');
                        window.location.reload();
                    }
                } else {
                    const errorData = await response.json();
                    alert('Failed to delete project: ' + (errorData.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting project:', error);
                alert('Error deleting project. Please try again.');
            }
        };

        // View Project Document Function
        window.viewProjectDocument = async function (projectId, documentId, fileName = 'Document') {
            const modal = document.getElementById('documentViewerModal');
            const loadingElement = document.getElementById('documentViewerLoading');
            const contentElement = document.getElementById('documentViewerContent');
            const officeContentElement = document.getElementById('officeDocumentViewerContent');
            const unsupportedElement = document.getElementById('unsupportedDocumentContent');
            const errorElement = document.getElementById('documentViewerError');
            const fileNameElement = document.getElementById('documentViewerFileName');
            const downloadBtn = document.getElementById('documentViewerDownloadBtn');

            // Show modal
            modal.classList.remove('hidden');

            // Set filename in modal title
            fileNameElement.textContent = fileName || 'Document';

            // Reset states - hide all containers
            loadingElement.classList.remove('hidden');
            contentElement.classList.add('hidden');
            officeContentElement.classList.add('hidden');
            unsupportedElement.classList.add('hidden');
            errorElement.classList.add('hidden');

            // Setup download button
            downloadBtn.onclick = async () => {
                try {
                    const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
                    const response = await fetch(
                        `${window.BASE_URL}/api/projects/${projectId}/documents/${documentId}`,
                        {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        }
                    );

                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('[Download] Error:', error);
                    alert('Failed to download document.');
                }
            };

            try {
                const token = localStorage.getItem('accessToken') || localStorage.getItem('token');

                console.log(`[Document Viewer] Fetching document ${documentId} for project ${projectId}`);
                console.log(`[Document Viewer] URL: ${window.BASE_URL}/api/projects/${projectId}/documents/${documentId}/view`);

                const response = await fetch(
                    `${window.BASE_URL}/api/projects/${projectId}/documents/${documentId}/view`,
                    {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    }
                );

                console.log(`[Document Viewer] Response status: ${response.status}`);
                console.log(`[Document Viewer] Response statusText: ${response.statusText}`);

                if (!response.ok) {
                    // Try to get error details from response
                    let errorMessage = `HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.error || errorMessage;
                        console.error('[Document Viewer] Error details:', errorData);
                    } catch (e) {
                        // Response is not JSON
                        try {
                            const errorText = await response.text();
                            if (errorText) errorMessage = errorText;
                            console.error('[Document Viewer] Error text:', errorText);
                        } catch (e2) {
                            console.error('[Document Viewer] Could not parse error response');
                        }
                    }
                    throw new Error(`Failed to view document: ${errorMessage}`);
                }

                const contentType = response.headers.get('Content-Type') || 'application/pdf';
                const contentLength = response.headers.get('Content-Length');
                console.log('Document Content-Type:', contentType);
                console.log('Document Size:', contentLength ? `${(contentLength / 1024 / 1024).toFixed(2)} MB` : 'Unknown');

                // Update loading message with size info
                if (contentLength) {
                    const sizeMB = (contentLength / 1024 / 1024).toFixed(2);
                    loadingElement.innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
                            <p class="text-gray-600 font-semibold">Loading document...</p>
                            <p class="text-sm text-gray-500 mt-2">Size: ${sizeMB} MB</p>
                            <p class="text-xs text-gray-400 mt-1">Please wait, this may take a moment for large files</p>
                        </div>
                    `;
                }

                // Convert response to blob (required for authenticated requests)
                const blob = await response.blob();
                console.log('Blob created, size:', (blob.size / 1024 / 1024).toFixed(2), 'MB');

                const url = URL.createObjectURL(blob);

                loadingElement.classList.add('hidden');

                // Handle different file types
                if (contentType.includes('pdf')) {
                    contentElement.innerHTML = `
                        <iframe 
                            src="${url}" 
                            class="w-full h-full" 
                            frameborder="0"
                            style="border: none;">
                        </iframe>
                    `;
                    contentElement.classList.remove('hidden');
                } else if (contentType.includes('image')) {
                    contentElement.innerHTML = `
                        <img 
                            src="${url}" 
                            class="max-w-full max-h-full object-contain mx-auto" 
                            alt="${fileName}" />
                    `;
                    contentElement.classList.remove('hidden');
                } else if (contentType.includes('word') || contentType.includes('excel') || contentType.includes('powerpoint') ||
                    fileName.match(/\.(docx?|xlsx?|pptx?)$/i)) {
                    // For Office documents, we need to use the direct URL with Office viewer
                    // Note: This requires the document to be publicly accessible or use a different auth method
                    const officeUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(window.BASE_URL + '/api/projects/' + projectId + '/documents/' + documentId)}`;
                    officeContentElement.innerHTML = `<iframe src="${officeUrl}" class="w-full h-full" frameborder="0"></iframe>`;
                    officeContentElement.classList.remove('hidden');
                } else {
                    unsupportedElement.classList.remove('hidden');
                }
            } catch (error) {
                console.error('[Document Viewer] Error viewing document:', error);
                loadingElement.classList.add('hidden');

                // Show detailed error message
                errorElement.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4 text-red-600"></i>
                        <p class="text-lg font-semibold mb-2">Error Loading Document</p>
                        <p class="text-sm text-gray-700 mb-4">${error.message}</p>
                        <div class="bg-gray-100 p-3 rounded text-xs text-left">
                            <p class="font-semibold mb-1">Troubleshooting:</p>
                            <ul class="list-disc list-inside space-y-1 text-gray-600">
                                <li>The document file may be corrupted or missing</li>
                                <li>The server may be experiencing issues</li>
                                <li>Try downloading the document instead</li>
                            </ul>
                        </div>
                        <button onclick="window.closeDocumentViewer()" 
                                class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Close
                        </button>
                    </div>
                `;
                errorElement.classList.remove('hidden');
            }
        };

        window.closeDocumentViewer = function () {
            const modal = document.getElementById('documentViewerModal');
            modal.classList.add('hidden');
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/tw-elements/js/tw-elements.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>

</body>

</html>