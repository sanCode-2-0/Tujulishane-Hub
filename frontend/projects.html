<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RMNCAH</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Tailwind CSS (with custom config using inline script) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e40af',   // Custom Blue
                        secondary: '#f59e0b', // Custom Amber
                        accent: '#10b981',    // Custom Green
                        dark: '#1f2937',      // Gray-800
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <!-- WARNING: cdn.tailwindcss.com should not be used in production. Use PostCSS or CLI for production builds. -->
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
        integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Optional: Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css" />
    <style>
        .fade-slide-enter {
            opacity: 0;
            transform: translateY(20px);
        }

        .fade-slide-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.4s ease;
        }

        .fade-slide-leave {
            opacity: 1;
            transform: translateY(0);
        }

        .fade-slide-leave-active {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }
    </style>

</head>

<body class="text-gray-800 ">
    <div data-twe-modal-init
        class="fixed left-0 top-0 backdrop-blur-md z-[1055] hidden h-full w-full overflow-y-auto overflow-x-hidden outline-none"
        id="createNewProject" tabindex="-1" aria-labelledby="createNewProjectTitle" aria-modal="true" role="dialog">
        <div data-twe-modal-dialog-ref
            class="pointer-events-none relative flex min-h-[calc(100%-1rem)] w-auto translate-y-[-50px] items-center opacity-0 transition-all duration-300 ease-in-out min-[576px]:mx-auto min-[576px]:mt-7 min-[576px]:max-w-[500px] min-[992px]:max-w-[800px] min-[1200px]:max-w-[1140px]">
            <div
                class="relative flex flex-col w-full text-current bg-white border-none rounded-md outline-none pointer-events-auto bg-clip-padding shadow-4">
                <div
                    class="flex items-center justify-between flex-shrink-0 p-4 border-b-2 rounded-t-md border-neutral-100">
                    <!-- Modal title -->
                    <h5 class="text-xl font-light uppercase leading-normal text-surface" id="createNewProjectTitle">
                        New Project
                    </h5>
                    <!-- Close button -->
                    <button type="button"
                        class="box-content border-none rounded-none text-neutral-500 hover:text-neutral-800 hover:no-underline focus:text-neutral-800 focus:opacity-100 focus:shadow-none focus:outline-none"
                        data-twe-modal-dismiss aria-label="Close">
                        <span class="[&>svg]:h-6 [&>svg]:w-6">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"
                                stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </span>
                    </button>
                </div>

                <!-- Modal body -->
                <div class="relative p-4">
                    <form id="newProjectForm">
                        <div class="grid grid-cols-2 gap-4 lg:grid-cols-4">
                            <!-- Map Picker for Location -->
                            <div class="col-span-2 lg:col-span-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pick Project Location on
                                    Map</label>
                                <div class="text-xs text-gray-600 mb-2">
                                    Search for a location or click on the map to select the
                                    project coordinates.
                                </div>
                                <div id="newProjectMap" style="
                          height: 400px;
                          width: 100%;
                          border-radius: 8px;
                          margin-bottom: 8px;
                          border: 1px solid #e5e7eb;
                          background-color: #f3f4f6;
                          position: relative;
                          overflow: hidden;
                        "></div>
                                <input type="hidden" id="project_latitude" name="latitude" />
                                <input type="hidden" id="project_longitude" name="longitude" />
                                <input type="hidden" id="project_county" name="county" />
                                <input type="hidden" id="project_subcounty" name="subcounty" />
                                <div class="text-sm text-gray-700 mt-2 p-2 bg-gray-50 rounded">
                                    <strong>Selected Location:</strong>
                                    <span id="selectedLatLng" class="font-mono text-blue-600">Click on map to select
                                        location</span>
                                    <br />
                                    <span id="selectedCounty" class="text-gray-600"></span>
                                </div>
                            </div>
                            <!-- Title -->
                            <div>
                                <label for="title" class="block text-sm font-medium text-gray-700">Title *</label>
                                <input required type="text" id="title" name="title"
                                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
                            </div>

                            <!-- Project Theme -->
                            <div>
                                <label for="theme" class="block text-sm font-medium text-gray-700">Project Theme
                                    *</label>
                                <select id="theme" name="theme"
                                    class="block w-full p-2 mt-1 text-black bg-white border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                    <option value="">Select Theme</option>
                                    <option value="GBV">Gender based violence</option>
                                    <option value="AYPSRH">
                                        Adolescent and Young People Sexual and Reproductive
                                        Health
                                    </option>
                                    <option value="MNH">Maternal and Newborn Health</option>
                                    <option value="FP">Family planning</option>
                                    <option value="CH">Child Health</option>
                                    <option value="AH">Adolescent Health</option>
                                </select>
                            </div>

                            <!-- Project Category -->
                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-700">Project Category
                                    *</label>
                                <select id="category" name="category"
                                    class="block w-full p-2 mt-1 text-black bg-white border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                    <option value="">Select Category</option>
                                    <option value="IMPLEMENTING">Implementing Project</option>
                                    <option value="RESEARCH">Research Project</option>
                                </select>
                            </div>

                            <!-- Time Period -->
                            <div>
                                <label for="starttime_period" class="block text-sm font-medium text-gray-700">
                                    Start *
                                </label>
                                <input required type="date" id="starttime_period" name="start_date"
                                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
                            </div>
                            <div>
                                <label for="endtime_period" class="block text-sm font-medium text-gray-700">End
                                    *</label>
                                <input type="date" id="endtime_period" name="end_date"
                                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
                            </div>
                            <!-- Activity Type -->
                            <div class="col-span-2 md:col-span-4">
                                <label for="activity_type" class="block text-sm font-medium text-gray-700">Activity Type
                                    (Description) *
                                </label>
                                <textarea required id="activity_type" name="activity_type" rows="3"
                                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                            </div>

                            <!-- County and Sub-county fields removed (not required) -->

                            <!-- Contact Person -->
                            <div>
                                <label for="contact_person" class="block text-sm font-medium text-gray-700">
                                    Contact Person Name *
                                </label>
                                <input required type="text" id="contact_person" name="contact_person_name"
                                    placeholder="Name"
                                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
                            </div>
                            <div>
                                <label for="contact_person" class="block text-sm font-medium text-gray-700">
                                    Contact Person Role *
                                </label>
                                <input required type="text" id="contact_person" name="contact_person_role"
                                    placeholder="Role"
                                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
                            </div>
                            <div>
                                <label for="contact_person" class="block text-sm font-medium text-gray-700">
                                    Contact Person Email *
                                </label>
                                <input required type="email" id="contact_person" name="contact_person_mail"
                                    placeholder="Email"
                                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
                            </div>
                            <div>
                                <label for="budget" class="block text-sm font-medium text-gray-700">
                                    Budget in KES
                                </label>
                                <input required type="number" id="budget" name="budget" placeholder="amount"
                                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
                            </div>

                            <!-- Gaps -->
                            <div class="col-span-2 lg:col-span-4">
                                <label for="gaps" class="block text-sm font-medium text-gray-700">
                                    Objectives *
                                </label>
                                <textarea required id="gaps" name="gaps" rows="3"
                                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
                            </div>
                        </div>

                        <!-- Button -->
                        <div class="mt-3">
                            <button type="submit"
                                class="inline-flex justify-center w-full px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Submit Project
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <nav x-data="{ open: false }"
        class="fixed z-50 border shadow-sm bg-white/70 top-4 left-4 right-4 backdrop-blur-md border-white/10 rounded-xl">
        <div class="flex items-center justify-between px-6 py-4">
            <a href="index.html"
                class="flex items-center justify-center space-x-2 text-2xl font-bold text-teal-700 uppercase">
                <img src="resources/images/log2.png" class="object-contain h-12" alt="Site Logo" />
                <img src="resources/images/moh.png" class="object-contain h-12" alt="Site Logo" />
            </a>

            <button @click="open = !open"
                class="text-xl lg:hidden focus:outline-none text-lime-600 hover:text-teal-800">
                <i class="fas fa-bars" x-show="!open"></i>
                <i class="fas fa-times" x-show="open" x-cloak></i>
            </button>

            <ul class="items-center hidden space-x-8 text-sm font-medium text-teal-700 lg:flex">
                <li>
                    <a href="index.html" class="uppercase transition hover:text-lime-600">Home</a>
                </li>

                <li id="projnav" class="relative" x-data="{ showprojectDropdown: false }">
                    <button @click="showprojectDropdown = !showprojectDropdown"
                        class="inline-flex items-center font-medium uppercase transition focus:outline-none hover:text-lime-600">
                        Projects <i class="ml-2 fal fa-chevron-down"></i>
                    </button>
                    <div x-show="showprojectDropdown" @click.outside="showprojectDropdown = false" x-transition
                        class="absolute z-50 w-56 mt-2 bg-white divide-y divide-gray-100 shadow-md rounded-xl"
                        style="display: none">
                        <ul class="py-2 text-sm text-left text-teal-800">
                            <li
                                class="px-4 py-2 transition hover:text-lime-600 transition ease-in-out duration-200 text-[12px] uppercase hover:bg-lime-50">
                                <a data-twe-toggle="modal" data-twe-target="#createNewProject">
                                    <i class="far fa-plus mr-3 text-emerald-500"></i>
                                    New Project
                                </a>
                            </li>
                            <li
                                class="px-4 py-2 transition hover:text-lime-600 transition ease-in-out duration-200 text-[12px] uppercase hover:bg-lime-50">
                                <a href="projects.html">
                                    <i class="far fa-user-check mr-2 text-sky-500"></i>
                                    My Projects
                                </a>
                            </li>
                            <li
                                class="px-4 py-2 transition hover:text-lime-600 transition ease-in-out duration-200 text-[12px] uppercase hover:bg-lime-50">
                                <a href="all-projects.html">
                                    <i class="far fa-folder-open mr-2 text-yellow-600"></i>
                                    All projects
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>

                <li id="adminNav" class="hidden relative" x-data="{ showDropdown: false }">
                    <button @click="showDropdown = !showDropdown"
                        class="inline-flex items-center font-medium uppercase transition focus:outline-none hover:text-lime-600">
                        Admin <i class="ml-2 fal fa-chevron-down"></i>
                    </button>
                    <div x-show="showDropdown" @click.outside="showDropdown = false" x-transition
                        class="absolute z-50 w-56 mt-2 bg-white divide-y divide-gray-100 shadow-md rounded-xl"
                        style="display: none">
                        <ul class="py-2 text-sm text-left text-teal-700">
                            <li
                                class="px-4 py-2 transition hover:text-lime-600 transition ease-in-out duration-200 text-[12px] uppercase hover:bg-lime-50">
                                <a href="dashboard.html">Dashboard</a>
                            </li>
                            <li
                                class="px-4 py-2 transition hover:text-lime-600 transition ease-in-out duration-200 text-[12px] uppercase hover:bg-lime-50">
                                <a href="projects.html">Project Management</a>
                            </li>
                            <li
                                class="px-4 py-2 transition hover:text-lime-600 transition ease-in-out duration-200 text-[12px] uppercase hover:bg-lime-50">
                                <a href="members.html">Stakeholder Management</a>
                            </li>
                        </ul>
                    </div>
                </li>

                <li id="" class=" relative" x-data="{ collapboarationDD: false }">
                    <button @click="collapboarationDD = !collapboarationDD"
                        class="inline-flex items-center font-medium uppercase transition focus:outline-none hover:text-lime-600">
                        Collaborations <i class="ml-2 fal fa-chevron-down"></i>
                    </button>
                    <div x-show="collapboarationDD" @click.outside="collapboarationDD = false" x-transition
                        class="absolute z-50 w-56 mt-2 bg-white divide-y divide-gray-100 shadow-md rounded-xl"
                        style="display: none">
                        <ul class="py-2 text-sm text-left text-teal-700">
                            <li
                                class="px-4 py-2 transition hover:text-lime-600 transition ease-in-out duration-200 text-[12px] uppercase hover:bg-lime-50">
                                <a href="my-collaborations.html">
                                    <i class="far fa-users-crown mr-2 text-fuchsia-600"></i>
                                    My Collaborations
                                </a>
                            </li>
                            <li
                                class="px-4 py-2 transition hover:text-lime-600 transition ease-in-out duration-200 text-[12px] uppercase hover:bg-lime-50">
                                <a href="announcements.html">
                                    <i class="far fa-search mr-2 text-cyan-500"></i>
                                    Find Projects
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>

                <li id="adminNav" class="hidden">
                    <a href="dashboard.html" class="uppercase transition hover:text-lime-600">Dashboard</a>
                </li>


                <li class="relative" x-data="{ showUserDropdown: false }">
                    <button @click="showUserDropdown = !showUserDropdown"
                        class="inline-flex items-center px-3 py-2 text-sm font-medium text-teal-700 transition rounded-lg hover:bg-gray-100 focus:outline-none">
                        <i class="mr-2 fas fa-user-circle text-lime-600"></i>
                        <span id="userDisplayName">User</span>
                        <i class="ml-2 fal fa-chevron-down"></i>
                    </button>
                    <div x-show="showUserDropdown" @click.outside="showUserDropdown = false" x-transition
                        class="absolute right-0 z-50 w-64 mt-2 bg-white divide-y divide-gray-100 shadow-lg rounded-xl"
                        style="display: none">
                        <div class="px-4 py-3">
                            <div class="text-base font-semibold text-teal-900" id="userNameDisplay">
                                Loading...
                            </div>
                            <div class="text-sm text-slate-500" id="userEmailDisplay"></div>
                            <div class="text-xs text-slate-400 mt-1">
                                Role: <span id="userRoleDisplay" class="font-medium text-teal-600"></span> | Status:
                                <span id="userStatusDisplay" class="font-medium text-lime-500"></span>
                            </div>
                        </div>
                        <ul class="py-2 text-sm text-teal-700">
                            <li>
                                <a href="profile.html"
                                    class="block px-4 py-2 transition hover:bg-lime-50 hover:text-lime-600"><i
                                        class="mr-2 fas fa-user"></i>Profile</a>
                            </li>
                            <li>
                                <a href="settings.html"
                                    class="block px-4 py-2 transition hover:bg-lime-50 hover:text-lime-600"><i
                                        class="mr-2 fas fa-cog"></i>Settings</a>
                            </li>
                        </ul>
                        <div class="py-2">
                            <button onclick="authManager.logout()"
                                class="block w-full px-4 py-2 text-left text-sm text-red-700 transition hover:bg-red-100">
                                <i class="mr-2 fas fa-sign-out-alt"></i>Logout
                            </button>
                        </div>
                    </div>
                </li>

            </ul>
        </div>

        <!-- Nav Links - Mobile -->
        <div x-show="open" x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform -translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100 transform translate-y-0"
            x-transition:leave-end="opacity-0 transform -translate-y-2" class="px-6 pb-6 lg:hidden">
            <ul class="flex flex-col space-y-4 font-semibold text-gray-700">
                <li>
                    <a href="/" class="block transition hover:text-blue-600">Home</a>
                </li>
                <li>
                    <a href="#about" class="block transition hover:text-blue-600">About</a>
                </li>
                <li>
                    <a href="#why-us" class="block transition hover:text-blue-600">Why Us</a>
                </li>
                <li>
                    <a href="#contact-us" class="block transition hover:text-blue-600">Contact Us</a>
                </li>
                <!-- Collaboration Links -->
                <li>
                    <a href="announcements.html" class="block transition hover:text-blue-600">
                        <i class="fas fa-bullhorn mr-2"></i>Announcements
                    </a>
                </li>
                <li>
                    <a href="my-collaborations.html" class="block transition hover:text-blue-600">
                        <i class="fas fa-users mr-2"></i>My Collaborations
                    </a>
                </li>
                <li id="admin-collab-mobile" class="block transition hover:text-blue-600" style="display: none">
                    <a href="Forms/Admin/collaboration-requests.html">
                        <i class="fas fa-handshake mr-2"></i>Manage Requests
                    </a>
                </li>
            </ul>

            <!-- CTA Button -->
            <div class="mt-6">
                <a href="/contact"
                    class="relative inline-block w-full px-4 py-2 overflow-hidden font-semibold text-center text-white bg-pink-600 rounded-full group">
                    <span
                        class="absolute inset-0 w-full h-full transition-transform duration-300 ease-out origin-left transform scale-x-0 bg-blue-700 group-hover:scale-x-100"></span>
                    <span class="relative z-10 group-hover:text-white">Collaborate</span>
                </a>
            </div>
        </div>
    </nav>
    <div class="min-h-screen pt-12 bg-gray-100">

        <!-- New Project -->
        <div data-twe-modal-init
            class="fixed left-0 top-0 backdrop-blur-md z-[1055] hidden h-full w-full overflow-y-auto overflow-x-hidden outline-none"
            id="createNewProject" tabindex="-1" aria-labelledby="createNewProjectTitle" aria-modal="true" role="dialog">
            <div data-twe-modal-dialog-ref
                class="pointer-events-none relative flex min-h-[calc(100%-1rem)] w-auto translate-y-[-50px] items-center opacity-0 transition-all duration-300 ease-in-out min-[576px]:mx-auto min-[576px]:mt-7 min-[576px]:max-w-[500px] min-[992px]:max-w-[800px] min-[1200px]:max-w-[1140px]">
                <div
                    class="relative flex flex-col w-full text-current bg-white border-none rounded-md outline-none pointer-events-auto bg-clip-padding shadow-4">
                    <div
                        class="flex items-center justify-between flex-shrink-0 p-4 border-b-2 rounded-t-md border-neutral-100">
                        <!-- Modal title -->
                        <h5 class="text-xl font-medium leading-normal text-surface" id="createNewProjectTitle">
                            New Project
                        </h5>
                        <!-- Close button -->
                        <button type="button"
                            class="box-content border-none rounded-none text-neutral-500 hover:text-neutral-800 hover:no-underline focus:text-neutral-800 focus:opacity-100 focus:shadow-none focus:outline-none"
                            data-twe-modal-dismiss aria-label="Close">
                            <span class="[&>svg]:h-6 [&>svg]:w-6">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </span>
                        </button>
                    </div>

                    <!-- Modal body -->
                    <div class="relative p-4">
                        <form id="userForm" class="space-y-5">
                            <!-- First & Last Name -->
                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">First Name</label>
                                    <input type="text" name="first_name" required
                                        class="block w-full py-2 mt-1 border-gray-600 rounded-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Last Name</label>
                                    <input type="text" name="last_name" required
                                        class="block w-full py-2 mt-1 border-gray-600 rounded-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Gender</label>
                                    <select name="gender" required
                                        class="block w-full py-2 mt-1 border-gray-600 rounded-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                        <option value="">Select...</option>
                                        <option>Male</option>
                                        <option>Female</option>
                                        <option>Other</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Country</label>
                                    <input type="text" name="country" required
                                        class="block w-full py-2 mt-1 border-gray-600 rounded-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700">County</label>
                                    <input type="text" name="county" required
                                        class="block w-full py-2 mt-1 border-gray-600 rounded-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Role</label>
                                    <select name="role" required
                                        class="block w-full py-2 mt-1 border-gray-600 rounded-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                        <option value="">Select Role...</option>
                                        <option>
                                            Super Admin
                                        </option>
                                        <option>
                                            Ei
                                        </option>
                                    </select>
                                </div>

                                <!-- Email -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Email Address</label>
                                    <input type="email" name="email" required
                                        class="block w-full py-2 mt-1 border-gray-600 rounded-sm shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                </div>

                            </div>
                            <!-- Submit -->
                            <div class="pt-4">
                                <button type="submit"
                                    class="w-full px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-1">
                                    Create User
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div data-twe-modal-init
            class="fixed left-0 top-0 backdrop-blur-md z-[1055] hidden h-full w-full overflow-y-auto overflow-x-hidden outline-none"
            id="submitReport" tabindex="-1" aria-labelledby="submitReport" aria-modal="true" role="dialog">
            <div data-twe-modal-dialog-ref
                class="pointer-events-none relative flex min-h-[calc(100%-1rem)] w-auto translate-y-[-50px] items-center opacity-0 transition-all duration-300 ease-in-out min-[576px]:mx-auto min-[576px]:mt-7 min-[576px]:max-w-[500px] min-[992px]:max-w-[800px] min-[1200px]:max-w-[1140px]">
                <div
                    class="relative flex flex-col w-full text-current bg-white border-none rounded-md outline-none pointer-events-auto bg-clip-padding shadow-4">
                    <div
                        class="flex items-center justify-between flex-shrink-0 p-4 border-b-2 rounded-t-md border-neutral-100">
                        <!-- Modal title -->
                        <h5 class="text-xl font-medium leading-normal text-surface" id="createNewProjectTitle">
                            Submit Report
                        </h5>
                        <!-- Close button -->
                        <button type="button"
                            class="box-content border-none rounded-none text-neutral-500 hover:text-neutral-800 hover:no-underline focus:text-neutral-800 focus:opacity-100 focus:shadow-none focus:outline-none"
                            data-twe-modal-dismiss aria-label="Close">
                            <span class="[&>svg]:h-6 [&>svg]:w-6">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </span>
                        </button>
                    </div>

                    <!-- Modal body -->
                    <div class="relative p-4">

                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-full p-8 mx-auto">
            <div class="p-6 mb-6 bg-white rounded-lg shadow-md fade fade-up">
                <h2 class="flex items-center mb-5 text-2xl font-light text-gray-900 uppercase fade fade-left">
                    Your Projects Overview
                </h2>
                <div class="flex flex-col gap-2">
                    <!-- <label class="text-sm font-medium text-gray-700">Status:</label>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="highlightMarkers('all')"
                            class="px-4 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            Show All
                        </button>
                        <button onclick="highlightMarkers('active')"
                            class="px-4 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-green-500">
                            Active
                        </button>
                        <button onclick="highlightMarkers('pending')"
                            class="px-4 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-yellow-100 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            Pending
                        </button>
                        <button onclick="highlightMarkers('stalled')"
                            class="px-4 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500">
                            Stalled
                        </button>
                        <button onclick="highlightMarkers('completed')"
                            class="px-4 py-2 text-sm text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-purple-100 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            Completed
                        </button>
                    </div>
                </div> -->

                    <ul class="grid grid-cols-2 gap-4 mb-6 text-center lg:grid-cols-5" id="pills-tab" role="tablist"
                        data-twe-nav-ref>
                        <li class="flex" role="presentation">
                            <a class="fade w-full fade-up bg-green-50 transition ease-in-out duration-150 text-green-700 data-[twe-nav-active]:bg-green-900 data-[twe-nav-active]:text-white p-4 rounded-md"
                                id="pills-home-tab" data-twe-toggle="pill" data-twe-target="#pills-home"
                                data-twe-nav-active role="tab" aria-controls="pills-home" aria-selected="true">
                                <p class="text-3xl font-bold" id="count-active">0</p>
                                <p class="text-sm">Active</p>
                            </a>
                        </li>
                        <li class="flex" role="presentation">
                            <a class="fade w-full fade-up bg-yellow-50 transition ease-in-out duration-150 text-yellow-700 data-[twe-nav-active]:bg-yellow-900 data-[twe-nav-active]:text-white p-4 rounded-md"
                                id="pills-profile-tab" data-twe-toggle="pill" data-twe-target="#pills-profile"
                                role="tab">
                                <p class="text-3xl font-bold" id="count-pending">0</p>
                                <p class="text-sm">Pending</p>
                            </a>
                        </li>
                        <li class="flex" role="presentation">
                            <a class="fade w-full fade-up bg-red-50 transition ease-in-out duration-150 text-red-700 data-[twe-nav-active]:bg-red-900 data-[twe-nav-active]:text-white p-4 rounded-md"
                                id="pills-contact-tab" data-twe-toggle="pill" data-twe-target="#pills-contact"
                                role="tab">
                                <p class="text-3xl font-bold" id="count-stalled">0</p>
                                <p class="text-sm">Stalled</p>
                            </a>
                        </li>
                        <li class="flex" role="presentation">
                            <a class="fade w-full fade-up bg-blue-50 transition ease-in-out duration-150 text-blue-700 data-[twe-nav-active]:bg-blue-900 data-[twe-nav-active]:text-white p-4 rounded-md"
                                id="pills-disabled-tab" data-twe-toggle="pill" data-twe-target="#pills-disabled"
                                role="tab">
                                <p class="text-3xl font-bold" id="count-completed">0</p>
                                <p class="text-sm">Completed</p>
                            </a>
                        </li>
                    </ul>
                    <!--Pills content-->
                    <div class="mb-6">
                        <div class="hidden px-4 opacity-100 transition-opacity duration-150 ease-linear data-[twe-tab-active]:block"
                            id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab" data-twe-tab-active>
                            <div class="px-4 py-4 -mx-4 overflow-x-auto md:px-0 sm:-mx-8">
                                <div class="inline-block min-w-full overflow-hidden rounded-lg">
                                    <table class="min-w-full leading-normal">
                                        <thead>
                                            <tr>
                                                <th scope="col"
                                                    class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                    Title
                                                </th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                    Partner
                                                </th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                    Theme
                                                </th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                    Location
                                                </th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                    Start
                                                </th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                    End
                                                </th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                    Contact
                                                </th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                    Actions
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody-active"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="hidden opacity-0 transition-opacity duration-150 ease-linear data-[twe-tab-active]:block"
                            id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
                            <div class="px-4 py-4 -mx-4 overflow-x-auto md:px-0 sm:-mx-8">
                                <div class="inline-block min-w-full overflow-hidden rounded-lg">
                                    <table class="min-w-full leading-normal">
                                        <thead>
                                            <tr>
                                                <th scope="col"
                                                    class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                    Title
                                                </th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                    Partner
                                                </th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                    Theme
                                                </th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                    Location
                                                </th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                    Start
                                                </th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                    End
                                                </th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                    Contact
                                                </th>
                                                <th scope="col"
                                                    class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                                    Actions
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="tbody-pending"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="hidden opacity-0 transition-opacity duration-150 ease-linear data-[twe-tab-active]:block"
                            id="pills-contact" role="tabpanel" aria-labelledby="pills-contact-tab">
                            <div class="px-4 py-4 -mx-4 overflow-x-auto md:px-0 sm:-mx-8">
                                <div class="inline-block min-w-full overflow-hidden rounded-lg">
                                    <table class="min-w-full leading-normal">
                                        <thead>
                                            <tr>
                                        <tbody id="tbody-stalled"></tbody>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-700 fade whitespace-nowrap">
                                            Partner A
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-700 fade whitespace-nowrap">
                                            Education
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-700 fade whitespace-nowrap">
                                            Nairobi, Langata
                                            <br>
                                            <span class="text-xs">St. Marys Hospital</span>
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-700 fade whitespace-nowrap">
                                            2025-01-01
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-700 fade whitespace-nowrap">
                                            2025-12-31
                                        </td>
                                        <td class="px-4 py-3 text-sm text-gray-700 fade whitespace-nowrap">
                                            Jane Doe
                                        </td>
                                        <td
                                            class="flex flex-wrap items-center gap-2 px-4 py-3 text-sm font-medium fade whitespace-nowrap">

                                            <button
                                                class="px-2 py-1 text-xs text-white bg-green-500 rounded hover:bg-green-600">
                                                Re-activate
                                            </button>
                                            <button
                                                class="px-2 py-1 text-xs text-white bg-gray-500 rounded hover:bg-gray-600">
                                                Is Completed
                                            </button>
                                        </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="hidden opacity-0 transition-opacity duration-150 ease-linear data-[twe-tab-active]:block"
                            id="pills-disabled" role="tabpanel" aria-labelledby="pills-disabled-tab">
                            <table class="min-w-full leading-normal">
                                <thead>
                                    <tr>
                                        <th scope="col"
                                            class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                            Title
                                        </th>
                                        <th scope="col"
                                            class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                            Partner
                                        </th>
                                        <th scope="col"
                                            class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                            Theme
                                        </th>
                                        <th scope="col"
                                            class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                            Location
                                        </th>
                                        <th scope="col"
                                            class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                            Start
                                        </th>
                                        <th scope="col"
                                            class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                            End
                                        </th>
                                        <th scope="col"
                                            class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                            Contact
                                        </th>
                                        <th scope="col"
                                            class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">
                                            Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-completed"></tbody>
                        </div>

                        <!-- Dynamic Project List, Info, and Pagination Controls -->
                        <div id="projectAccordion"></div>
                        <div id="projectInfo" class="hidden"></div>
                        <div id="paginationControls" class="my-4"></div>
                        <script src="config.js"></script>
                        <!-- Ensure authManager is available for user-specific views -->
                        <script src="auth.js"></script>
                        <script>
                            let API_BASE = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
                                ? 'http://localhost:8080/api'
                                : 'http://localhost:8080/api';

                            // Fetch and display project statistics
                            async function loadProjectStats() {
                                try {
                                    const res = await fetch(`${API_BASE}/projects/statistics`);
                                    console.log('[API] GET /projects/statistics response:', res);
                                    if (!res.ok) throw new Error('HTTP ' + res.status);
                                    const data = await res.json();
                                    console.log('[API] /projects/statistics data:', data);
                                    if (data.status === 200) {
                                        let stats = data.data.statusCounts;
                                        console.log('[Stats] FULL API RESPONSE:', data);
                                        console.log('[Stats] statusCounts:', stats);
                                        // Show raw statusCounts for debugging
                                        let debugDiv = document.getElementById('debug-statuscounts');
                                        if (!debugDiv) {
                                            debugDiv = document.createElement('div');
                                            debugDiv.id = 'debug-statuscounts';
                                            debugDiv.style.background = '#ffe';
                                            debugDiv.style.fontSize = '12px';
                                            debugDiv.style.padding = '4px';
                                            debugDiv.style.margin = '8px 0';
                                            document.body.insertBefore(debugDiv, document.body.firstChild);
                                        }
                                        // debugDiv.textContent = 'Raw statusCounts: ' + JSON.stringify(stats);

                                        // If statusCounts is an array of arrays (e.g. [['pending', 1]]), convert to object
                                        if (Array.isArray(stats)) {
                                            const obj = {};
                                            stats.forEach(s => {
                                                if (Array.isArray(s) && s.length === 2) {
                                                    obj[String(s[0]).toLowerCase()] = s[1];
                                                } else if (s && typeof s === 'object' && s.status && s.count !== undefined) {
                                                    obj[s.status.toLowerCase()] = s.count;
                                                }
                                            });
                                            stats = obj;
                                        }
                                        document.getElementById('count-active').textContent = stats.active || 0;
                                        document.getElementById('count-pending').textContent = stats.pending || 0;
                                        document.getElementById('count-stalled').textContent = stats.stalled || 0;
                                        document.getElementById('count-completed').textContent = stats.completed || 0;
                                    }
                                } catch (e) {
                                    console.error('Failed to load project stats', e);
                                }
                            }

                            // Helper to render action buttons
                            function renderActions(project, status) {
                                let html = '';
                                if (status === 'pending') {
                                    html += `<button class=\"px-2 py-1 text-xs text-white bg-blue-500 rounded hover:bg-blue-600\" onclick=\"editProject(${project.id})\">Edit</button> `;
                                    html += `<button class=\"px-2 py-1 text-xs text-white bg-green-500 rounded hover:bg-green-600\" onclick=\"approveProject(${project.id})\">Approve</button> `;
                                    html += `<button class=\"px-2 py-1 text-xs text-white bg-red-500 rounded hover:bg-red-600\" onclick=\"dismissProject(${project.id})\">Dismiss</button>`;
                                } else if (status === 'active') {
                                    html += `<button class=\"px-2 py-1 text-xs text-white bg-orange-500 rounded hover:bg-orange-600\" onclick=\"stalledProject(${project.id})\">Has Stalled</button>`;
                                } else if (status === 'stalled') {
                                    html += `<button class=\"px-2 py-1 text-xs text-white bg-green-500 rounded hover:bg-green-600\" onclick=\"reactivateProject(${project.id})\">Re-activate</button> `;
                                    html += `<button class=\"px-2 py-1 text-xs text-white bg-gray-500 rounded hover:bg-gray-600\" disabled>Is Completed</button>`;
                                } else if (status === 'completed') {
                                    html += `<button class=\"px-2 py-1 text-xs text-white bg-blue-500 rounded hover:bg-blue-600\" onclick=\"submitReport(${project.id})\">Submit Report</button>`;
                                }

                                // Mark project as stalled (exposed globally)
                                window.stalledProject = async function (id) {
                                    if (!confirm('Mark this project as stalled?')) return;
                                    try {
                                        const headers = {
                                            'Content-Type': 'application/json',
                                            Authorization: 'Bearer ' + (localStorage.getItem('accessToken') || '')
                                        };
                                        // Assuming your backend supports a PATCH or POST endpoint for this action
                                        const res = await fetch(`${API_BASE}/projects/admin/stall/${id}`, {
                                            method: 'POST',
                                            credentials: 'include',
                                            headers
                                        });
                                        let data = null;
                                        try {
                                            data = await res.json();
                                        } catch (jsonErr) {
                                            console.error('[stalledProject] Failed to parse JSON:', jsonErr);
                                        }
                                        if (res.ok && data && data.message) {
                                            alert(data.message || 'Project marked as stalled');
                                        } else {
                                            alert('Failed to mark project as stalled: ' + (data && data.message ? data.message : res.status));
                                        }
                                        loadProjectStats();
                                        loadProjectsByStatus('active', 'tbody-active');
                                        loadProjectsByStatus('stalled', 'tbody-stalled');
                                    } catch (e) {
                                        console.error('[stalledProject] Exception:', e);
                                        alert('Failed to mark project as stalled: ' + e);
                                    }
                                }
                                return html;
                            }

                            // Small helpers for rendering partner and contact safely
                            function isEmail(value) {
                                return typeof value === 'string' && /\S+@\S+\.\S+/.test(value);
                            }

                            function escapeHtml(str) {
                                if (!str && str !== 0) return '';
                                return String(str)
                                    .replace(/&/g, '&amp;')
                                    .replace(/</g, '&lt;')
                                    .replace(/>/g, '&gt;')
                                    .replace(/"/g, '&quot;')
                                    .replace(/'/g, '&#39;');
                            }

                            function renderPartnerField(project) {
                                // Prefer explicit organization name
                                const orgName = project && project.organization && project.organization.name ? project.organization.name : (project && (project.organizationName || project.organization));
                                if (orgName) return escapeHtml(orgName);

                                // Try partner/sponsor but avoid showing an email there
                                const partner = project && (project.partner || project.sponsor || '');
                                if (partner && !isEmail(partner)) return escapeHtml(partner);

                                // Fallback to contact person name (if organization missing)
                                return escapeHtml(project && (project.contactPersonName || project.contactPerson || ''));
                            }

                            function renderContactField(project) {
                                const email = project && (project.contactPersonEmail || project.contactEmail || project.contact_person_mail || project.contact_person || project.contact);
                                if (email && isEmail(email)) {
                                    return `<a class="text-blue-600 underline" href="mailto:${escapeHtml(email)}">${escapeHtml(email)}</a>`;
                                }
                                // Fallback to name
                                const name = project && (project.contactPersonName || project.contactPerson || project.contact || '');
                                return escapeHtml(name);
                            }

                            // Fetch and render projects by status
                            async function loadProjectsByStatus(status, tableBodyId) {
                                try {
                                    const res = await fetch(`${API_BASE}/projects/status/${status}`);
                                    console.log(`[API] GET /projects/status/${status} response:`, res);
                                    if (!res.ok) throw new Error('HTTP ' + res.status);
                                    const data = await res.json();
                                    console.log(`[API] /projects/status/${status} data:`, data);
                                    if (data.status === 200) {
                                        const projects = data.data;
                                        const tbody = document.getElementById(tableBodyId);
                                        tbody.innerHTML = '';
                                        projects.forEach(project => {
                                            tbody.innerHTML += `
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-700">${project.title || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${renderPartnerField(project)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${project.projectTheme || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${project.county || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${project.startDate || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${project.endDate || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${renderContactField(project)}</td>
                        <td class="flex flex-wrap items-center gap-2 px-4 py-3 text-sm font-medium">${renderActions(project, status)}</td>
                    </tr>
                `;
                                        });
                                    }
                                } catch (e) {
                                    console.error(`Failed to load projects for status ${status}`, e);
                                }
                            }

                            // Return true when the page should show only the current user's projects
                            function isMyProjectsView() {
                                return window.location.hash === '#my-projects';
                            }

                            // Load projects for the current authenticated user and populate the status tables
                            async function loadMyProjects() {
                                // Ensure authManager exists
                                if (!window.authManager) {
                                    console.error('authManager is not available. Cannot load user projects.');
                                    return;
                                }

                                // Require authentication; show friendly message if not authenticated
                                if (!authManager.isAuthenticated()) {
                                    const msg = '<tr><td colspan="8" class="px-4 py-3 text-sm text-gray-700">Please log in to view your projects.</td></tr>';
                                    document.getElementById('tbody-active').innerHTML = msg;
                                    document.getElementById('tbody-pending').innerHTML = msg;
                                    document.getElementById('tbody-stalled').innerHTML = msg;
                                    document.getElementById('tbody-completed').innerHTML = msg;
                                    document.getElementById('count-active').textContent = 0;
                                    document.getElementById('count-pending').textContent = 0;
                                    document.getElementById('count-stalled').textContent = 0;
                                    document.getElementById('count-completed').textContent = 0;
                                    return;
                                }

                                try {
                                    const res = await authManager.apiCall('/api/projects/my-projects', 'GET');
                                    if (!res.ok) {
                                        console.error('Failed to fetch my-projects', res);
                                        return;
                                    }
                                    const json = await res.json();
                                    const projects = json.data || [];

                                    // Clear tables
                                    const tbActive = document.getElementById('tbody-active');
                                    const tbPending = document.getElementById('tbody-pending');
                                    const tbStalled = document.getElementById('tbody-stalled');
                                    const tbCompleted = document.getElementById('tbody-completed');
                                    tbActive.innerHTML = '';
                                    tbPending.innerHTML = '';
                                    tbStalled.innerHTML = '';
                                    tbCompleted.innerHTML = '';

                                    const counts = { active: 0, pending: 0, stalled: 0, completed: 0 };

                                    projects.forEach(project => {
                                        const status = (project.status || project.projectStatus || (project.tag && project.tag.toLowerCase()) || 'active').toLowerCase();
                                        const row = `
                    <tr>
                        <td class="px-4 py-3 text-sm text-gray-700">${project.title || project.name || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${renderPartnerField(project)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${project.projectTheme || project.theme || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${project.county || project.location || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${project.startDate || project.start_date || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${project.endDate || project.end_date || ''}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${renderContactField(project)}</td>
                        <td class="flex flex-wrap items-center gap-2 px-4 py-3 text-sm font-medium">${renderActions(project, status)}</td>
                    </tr>
                `;

                                        if (status === 'pending') {
                                            tbPending.innerHTML += row;
                                            counts.pending++;
                                        } else if (status === 'stalled') {
                                            tbStalled.innerHTML += row;
                                            counts.stalled++;
                                        } else if (status === 'completed') {
                                            tbCompleted.innerHTML += row;
                                            counts.completed++;
                                        } else {
                                            tbActive.innerHTML += row;
                                            counts.active++;
                                        }
                                    });

                                    document.getElementById('count-active').textContent = counts.active;
                                    document.getElementById('count-pending').textContent = counts.pending;
                                    document.getElementById('count-stalled').textContent = counts.stalled;
                                    document.getElementById('count-completed').textContent = counts.completed;

                                } catch (e) {
                                    console.error('Error loading my projects', e);
                                }
                            }

                            // Action handlers
                            async function approveProject(id) {
                                if (!confirm('Approve this project?')) return;
                                try {
                                    console.log('[approveProject] Sending POST to', `${API_BASE}/projects/admin/approve/${id}`);
                                    const headers = {
                                        'Content-Type': 'application/json',
                                        Authorization: 'Bearer ' + (localStorage.getItem('accessToken') || '')
                                    };
                                    const res = await fetch(`${API_BASE}/projects/admin/approve/${id}`, {
                                        method: 'POST',
                                        credentials: 'include',
                                        headers
                                    });
                                    console.log('[approveProject] Response:', res);
                                    let data = null;
                                    try {
                                        data = await res.json();
                                    } catch (jsonErr) {
                                        console.error('[approveProject] Failed to parse JSON:', jsonErr);
                                    }
                                    console.log('[approveProject] Response data:', data);
                                    if (res.ok && data && data.message) {
                                        alert(data.message || 'Project approved');
                                    } else {
                                        alert('Failed to approve project: ' + (data && data.message ? data.message : res.status));
                                    }
                                    loadProjectStats();
                                    loadProjectsByStatus('pending', 'tbody-pending');
                                    loadProjectsByStatus('active', 'tbody-active');
                                } catch (e) {
                                    console.error('[approveProject] Exception:', e);
                                    alert('Failed to approve project: ' + e);
                                }
                            }

                            async function dismissProject(id) {
                                const reason = prompt('Enter reason for rejection:');
                                if (!reason) return;
                                try {
                                    const res = await fetch(`${API_BASE}/projects/admin/reject/${id}`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        credentials: 'include',
                                        body: JSON.stringify({ reason })
                                    });
                                    const data = await res.json();
                                    alert(data.message || 'Project dismissed');
                                    loadProjectStats();
                                    loadProjectsByStatus('pending', 'tbody-pending');
                                } catch (e) {
                                    alert('Failed to dismiss project');
                                }
                            }

                            function editProject(id) {
                                // Redirect to edit page or open modal (implement as needed)
                                alert('Edit project ' + id);
                            }

                            function reactivateProject(id) {
                                // Implement re-activation logic as needed
                                alert('Re-activate project ' + id);
                            }

                            function submitReport(id) {
                                // Implement report submission logic as needed
                                alert('Submit report for project ' + id);
                            }

                            // On page load: choose between global view and "My Projects" view
                            document.addEventListener('DOMContentLoaded', () => {
                                loadProjectStats();
                                if (isMyProjectsView()) {
                                    // load only current user's projects
                                    loadMyProjects();
                                } else {
                                    // default - load public/global projects by status
                                    loadProjectsByStatus('active', 'tbody-active');
                                    loadProjectsByStatus('pending', 'tbody-pending');
                                    loadProjectsByStatus('stalled', 'tbody-stalled');
                                    loadProjectsByStatus('completed', 'tbody-completed');
                                }
                            });

                            // React to hash changes so linking to #my-projects works without reload
                            window.addEventListener('hashchange', () => {
                                if (isMyProjectsView()) {
                                    loadMyProjects();
                                } else {
                                    loadProjectsByStatus('active', 'tbody-active');
                                    loadProjectsByStatus('pending', 'tbody-pending');
                                    loadProjectsByStatus('stalled', 'tbody-stalled');
                                    loadProjectsByStatus('completed', 'tbody-completed');
                                }
                            });
                        </script>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>
    </div>
    <script src="styles/effects.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tw-elements/js/tw-elements.umd.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, heatLayer;
        let projects = [];
        let filteredProjects = [];
        let sortBy = 'name';
        let sortOrder = 'asc';
        let currentPage = 1;
        const itemsPerPage = 5;
        let currentFilter = 'all';
        let searchQuery = '';
        let dateRangeFrom = null;
        let dateRangeTo = null;


        const markers = [];
        const icons = {
            default: (tag) => L.icon({ iconUrl: `resources/${tag}.png`, iconSize: [20, 20] }),
            selected: (tag) => L.icon({ iconUrl: `resources/${tag}.png`, iconSize: [40, 40] })
        };

        const bgColors = {
            active: 'bg-green-50',
            pending: 'bg-yellow-50',
            stalled: 'bg-red-50',
            completed: 'bg-cyan-100',
            default: 'bg-white'
        };

        const statusBadge = (tag) => {
            return {
                active: 'bg-green-200 text-green-800',
                pending: 'bg-yellow-200 text-yellow-800',
                stalled: 'bg-red-200 text-red-800',
                completed: 'bg-cyan-300 text-gray-800',
            }[tag] || 'bg-gray-200 text-gray-800';
        };



        document.addEventListener("DOMContentLoaded", function () {
            map = L.map('kenyaMap', {
                center: [-0.0236, 37.9062],
                zoom: 6.3,
                scrollWheelZoom: false,
                dragging: true,
                touchZoom: false,
                doubleClickZoom: true,
                boxZoom: false,
                keyboard: false,
                zoomControl: true // keeps the + / – buttons visible
            });

            var kenyaBounds = [
                [-4.677504, 33.893568],  // Southwest corner (Lat, Lng)
                [5.019938, 41.906895]    // Northeast corner (Lat, Lng)
            ];

            // Set initial view to Kenya
            map.fitBounds(kenyaBounds);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 22,
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Restrict map so user cannot pan outside Kenya
            map.setMaxBounds(kenyaBounds);
            map.on('drag', function () {
                map.panInsideBounds(kenyaBounds, { animate: false });
            });

            // This comes from the db  -->
            const markerData = [
                { lat: -1.2921, lng: 36.8219, name: "Project 1", tag: "active" },
                { lat: -0.1023, lng: 34.7619, name: "Project 2", tag: "pending" },
                { lat: 0.3256, lng: 37.1231, name: "Project 3", tag: "stalled" },
                { lat: -1.1504, lng: 36.8907, name: "Project 4", tag: "completed" },
            ];

            // This comes from db-- >
            markerData.forEach((data) => {
                const fullDescription = `Loin ipsum dolor sit amet, leo in savanna stride, rugitus magna echoing plains. 
                    Praeterea mane hunters vigilant, acacia shade sub arbore. Serengeti felis aurum, 
                    crinibus ventis fluctuantibus, prideland auctor sapien. Ungulae zebrae cursitant, 
                    antelopae metu per campos. Territorium regale defenditur, solis ardor fulget super 
                    juba. Luna sub nocte vigil, oculi flammae micantes, silentium ruptum rugitu ${data.name}`;

                data.description = fullDescription.substring(0, 300) + "...";
                data.fullDescription = fullDescription;
                data.region = `Region ${Math.ceil(Math.random() * 10)}`;
                data.budget = `${(Math.random() * 100 + 10).toFixed(2)} million KES`;
                data.team = `${Math.ceil(Math.random() * 15 + 5)} members`;
                data.sponsor = `Sponsor for ${data.name}`;
                data.participants = Math.ceil(Math.random() * 100);
                data.start_date = new Date(Date.now() - Math.random() * 10000000000).toISOString();
                data.status = data.tag;

                const marker = L.marker([data.lat, data.lng], { icon: icons.default(data.tag) })
                    .addTo(map)
                    .bindTooltip(data.name)
                    .on("click", function () {
                        if (selectedMarker && selectedMarker !== this) {
                            selectedMarker.setIcon(icons.default(selectedMarker.tag));
                        }
                        this.setIcon(icons.selected(data.tag));
                        selectedMarker = this;
                        showProjectInfo(data);
                    });

                marker.data = data;
                marker.tag = data.tag;
                markers.push(marker);
            });


            highlightMarkers('all');

            document.getElementById('searchInput').addEventListener('input', (e) => {
                searchQuery = e.target.value.trim().toLowerCase();
                currentPage = 1;
                highlightMarkers(currentFilter);
            });

            document.getElementById('dateFrom').addEventListener('change', (e) => {
                dateRangeFrom = e.target.value ? new Date(e.target.value) : null;
                currentPage = 1;
                highlightMarkers(currentFilter);
            });

            document.getElementById('dateTo').addEventListener('change', (e) => {
                dateRangeTo = e.target.value ? new Date(e.target.value) : null;
                currentPage = 1;
                highlightMarkers(currentFilter);
            });

            document.getElementById('sortSelect').addEventListener('change', (e) => {
                sortProjects(e.target.value);
            });
        });
        // Comes From DB
        function showProjectInfo(project) {
            const infoBox = document.getElementById("projectInfo");
            infoBox.classList.remove("hidden");
            infoBox.innerHTML = `
            <div class="flex flex-wrap">
                <h3 class="mb-4 text-xl font-bold text-gray-800">${project.name}</h3>
                <p><strong>Description:</strong> ${project.description}</p>
                <p><strong>Region:</strong> ${project.region}</p>
                <p><strong>Budget:</strong> ${project.budget}</p>
                <p><strong>Team:</strong> ${project.team}</p>
                <p><strong>Participants:</strong> ${project.participants}</p>
                <p><strong>Sponsor:</strong> ${project.sponsor}</p>
                <p><strong>Start Date:</strong> ${new Date(project.start_date).toLocaleDateString()}</p>
                <p><strong>Status:</strong> <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge(project.status)}">${project.status}</span></p>
            </div>
        `;
        }

        function focusMarker(index) {
            const marker = markers[index];
            map.setView(marker.getLatLng(), 9);
            marker.fire('click');
            document.getElementById('localMap').scrollIntoView({ behavior: 'smooth' });
        }

        function sortProjects(field) {
            if (sortBy === field) {
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                sortBy = field;
                sortOrder = 'asc';
            }
            currentPage = 1;
            highlightMarkers(currentFilter);
        }

        function highlightMarkers(tag) {
            currentFilter = tag;
            const accordion = document.getElementById("projectAccordion");
            const infoBox = document.getElementById("projectInfo");
            console.log('[highlightMarkers] tag:', tag, 'accordion:', accordion, 'infoBox:', infoBox);
            if (infoBox) infoBox.classList.add("hidden");
            if (accordion) {
                accordion.innerHTML = '';
                accordion.classList.remove("hidden");
                accordion.classList.add("opacity-0", "translate-y-4");
            }

            let filteredMarkers = markers.filter(marker => {
                const p = marker.data;
                if (tag !== 'all' && marker.tag !== tag) return false;
                if (searchQuery && !p.name.toLowerCase().includes(searchQuery)) return false;
                const pDate = new Date(p.start_date);
                if (dateRangeFrom && pDate < dateRangeFrom) return false;
                if (dateRangeTo && pDate > dateRangeTo) return false;
                return true;
            });

            filteredMarkers.sort((a, b) => {
                const aVal = sortBy === 'name' ? a.data.name : new Date(a.data.start_date);
                const bVal = sortBy === 'name' ? b.data.name : new Date(b.data.start_date);
                return sortOrder === 'asc' ? (aVal > bVal ? 1 : -1) : (aVal < bVal ? 1 : -1);
            });

            const totalPages = Math.ceil(filteredMarkers.length / itemsPerPage);
            const paginated = filteredMarkers.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
            console.log('[highlightMarkers] totalPages:', totalPages, 'paginated:', paginated);
            updatePaginationControls(totalPages);

            markers.forEach(marker => {
                marker.setOpacity(filteredMarkers.includes(marker) ? 1 : 0.1);
            });

            if (accordion) {
                setTimeout(() => accordion.classList.remove("opacity-0", "translate-y-4"), 10);

                paginated.forEach((marker, idx) => {
                    const i = markers.indexOf(marker);
                    const project = marker.data;
                    const bg = bgColors[project.status] || bgColors.default;

                    const item = document.createElement("div");
                    item.className = `rounded shadow-sm ${bg}`;

                    item.innerHTML = `
                        <button class="w-full px-6 py-4 text-left border-b focus:outline-none" data-toggle="collapse-${i}">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                                <div>
                                    <h4 class="text-lg font-semibold text-gray-800">${project.name}</h4>
                                    <p id="desc-${i}" class="mt-2 text-sm text-gray-600">${project.description}</p>
                                </div>
                                <div class="flex items-center mt-2 text-sm font-semibold tracking-wider text-gray-500 sm:mt-0">
                                    ${new Date(project.start_date).toLocaleDateString()}
                                </div>
                            </div>
                        </button>
                        <div id="collapse-${i}" class="hidden px-6 py-4 bg-white">
                            <p><strong>Region:</strong> ${project.region}</p>
                            <p><strong>Budget:</strong> ${project.budget}</p>
                            <p><strong>Team:</strong> ${project.team}</p>
                            <p><strong>Participants:</strong> ${project.participants}</p>
                            <p><strong>Sponsor:</strong> ${project.sponsor}</p>
                            <p><strong>Status:</strong> 
                                <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge(project.status)}">
                                    ${project.status}
                                </span>
                            </p>
                            <button onclick="focusMarker(${i})" class="px-5 py-2 mt-3 text-sm font-semibold text-white transition bg-blue-600 rounded hover:bg-blue-700 hover:scale-105">
                                Show on Map
                            </button>
                        </div>
                    `;

                    accordion.appendChild(item);

                    // Toggle description between truncated and full
                    const btn = item.querySelector(`[data-toggle="collapse-${i}"]`);
                    btn.addEventListener("click", () => {
                        const collapse = document.getElementById(`collapse-${i}`);
                        const desc = document.getElementById(`desc-${i}`);
                        if (collapse) collapse.classList.toggle("hidden");

                        if (collapse && !collapse.classList.contains("hidden")) {
                            desc.textContent = project.fullDescription; // expand
                        } else {
                            desc.textContent = project.description; // truncate
                        }
                    });
                });
            }
        }

        function updatePaginationControls(totalPages) {
            const container = document.getElementById("paginationControls");
            console.log('[updatePaginationControls] container:', container, 'totalPages:', totalPages);
            if (!container) {
                console.warn('[updatePaginationControls] #paginationControls not found');
                return;
            }
            container.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement("button");
                btn.textContent = i;
                btn.className = `px-3 py-1 rounded ${i === currentPage ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800 hover:bg-gray-200'}`;
                btn.onclick = () => {
                    currentPage = i;
                    highlightMarkers(currentFilter);
                };
                container.appendChild(btn);
            }
        }

        function exportCSV() {
            const headers = ['Name', 'Description', 'Region', 'Budget', 'Team', 'Participants', 'Sponsor', 'Start Date', 'Status'];
            const rows = markers
                .map(m => m.data)
                .filter(p => {
                    if (searchQuery && !p.name.toLowerCase().includes(searchQuery)) return false;
                    const date = new Date(p.start_date);
                    if (dateRangeFrom && date < dateRangeFrom) return false;
                    if (dateRangeTo && date > dateRangeTo) return false;
                    if (currentFilter !== 'all' && p.status !== currentFilter) return false;
                    return true;
                })
                .map(p => [
                    p.name, p.description, p.region, p.budget, p.team, p.participants,
                    p.sponsor, new Date(p.start_date).toLocaleDateString(), p.status
                ]);

            let csvContent = [headers.join(',')];
            rows.forEach(r => csvContent.push(r.map(field => `"${field}"`).join(',')));

            const blob = new Blob([csvContent.join('\n')], { type: 'text/csv' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `projects_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Show/hide admin collaboration menu and load pending count
        document.addEventListener('DOMContentLoaded', async function () {
            const userRole = localStorage.getItem('userRole');
            
            // Populate user dropdown
            let user = null;
            const userStr = localStorage.getItem('user');
            if (userStr) {
                try {
                    user = JSON.parse(userStr);
                } catch (e) {
                    console.error("Error parsing user data:", e);
                }
            }
            
            // Populate user dropdown if user data exists
            if (user) {
                console.log("👤 Populating user dropdown...");
                const userDisplayName = document.getElementById("userDisplayName");
                const userNameDisplay = document.getElementById("userNameDisplay");
                const userEmailDisplay = document.getElementById("userEmailDisplay");
                const userRoleDisplay = document.getElementById("userRoleDisplay");
                const userStatusDisplay = document.getElementById("userStatusDisplay");
                
                if (userDisplayName) userDisplayName.textContent = user.name || "User";
                if (userNameDisplay) userNameDisplay.textContent = user.name || "Loading...";
                if (userEmailDisplay) userEmailDisplay.textContent = user.email || "";
                if (userRoleDisplay) userRoleDisplay.textContent = user.role || "N/A";
                if (userStatusDisplay) {
                    userStatusDisplay.textContent = user.status || "N/A";
                    userStatusDisplay.className = user.status === "ACTIVE" 
                        ? "font-medium text-green-600" 
                        : "font-medium text-gray-600";
                }
                console.log("✅ User dropdown populated!");
            } else {
                // Try to get user from authManager if available
                if (window.authManager && typeof window.authManager.getCurrentUser === 'function') {
                    try {
                        user = await window.authManager.getCurrentUser();
                        if (user) {
                            const userDisplayName = document.getElementById("userDisplayName");
                            const userNameDisplay = document.getElementById("userNameDisplay");
                            const userEmailDisplay = document.getElementById("userEmailDisplay");
                            const userRoleDisplay = document.getElementById("userRoleDisplay");
                            const userStatusDisplay = document.getElementById("userStatusDisplay");
                            
                            if (userDisplayName) userDisplayName.textContent = user.name || "User";
                            if (userNameDisplay) userNameDisplay.textContent = user.name || "Loading...";
                            if (userEmailDisplay) userEmailDisplay.textContent = user.email || "";
                            if (userRoleDisplay) userRoleDisplay.textContent = user.role || "N/A";
                            if (userStatusDisplay) {
                                userStatusDisplay.textContent = user.status || "N/A";
                                userStatusDisplay.className = user.status === "ACTIVE" 
                                    ? "font-medium text-green-600" 
                                    : "font-medium text-gray-600";
                            }
                        }
                    } catch (e) {
                        console.log("⚠️ Could not load user from authManager:", e);
                    }
                }
            }

            // Show admin menu items if user is admin or super admin
            if (userRole === 'ADMIN' || userRole === 'SUPER_ADMIN') {
                const adminMenuItem = document.getElementById('admin-collab-menu');
                if (adminMenuItem) adminMenuItem.style.display = 'block';

                // Load pending collaboration requests count
                loadPendingCount();
            }
        });

        async function loadPendingCount() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${window.BASE_URL}/api/collaboration-requests/admin/pending`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.status === 200 && data.data.length > 0) {
                    const badge = document.getElementById('pending-count');
                    if (badge) {
                        badge.textContent = data.data.length;
                        badge.style.display = 'inline-block';
                    }
                }
            } catch (error) {
                console.error('Error loading pending requests count:', error);
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/tw-elements/js/tw-elements.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
    <!-- Leaflet JS -->


</body>

</html>