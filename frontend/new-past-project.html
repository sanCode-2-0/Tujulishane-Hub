<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New Project - RMNCAH</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Tailwind CSS (with custom config using inline script) -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#1e40af", // Custom Blue
              secondary: "#f59e0b", // Custom Amber
              accent: "#10b981", // Custom Green
              dark: "#1f2937", // Gray-800
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="styles/main.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css"
    />
    <script src="styles/main.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
      integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
    <!-- Modal Utilities -->
    <script src="modal-utils.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css"
      rel="stylesheet"
    />
    <style>
      /* Larger popup close button for better accessibility */
      .mapboxgl-popup-close-button {
        font-size: 24px !important;
        width: 32px !important;
        height: 32px !important;
        line-height: 32px !important;
        padding: 0 !important;
        color: #4b5563 !important;
      }
      .mapboxgl-popup-close-button:hover {
        background-color: #f3f4f6 !important;
        color: #1f2937 !important;
      }
    </style>
  </head>

  <body class="bg-gray-50">
    <!-- Loading Overlay -->
    <div
      id="loadingOverlay"
      class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div
        class="bg-white rounded-lg p-8 flex flex-col items-center shadow-2xl"
      >
        <div
          class="animate-spin rounded-full h-16 w-16 border-b-4 border-green-600 mb-4"
        ></div>
        <p class="text-gray-700 text-lg font-semibold">Creating project...</p>
        <p class="text-gray-500 text-sm mt-2">Please wait</p>
      </div>
    </div>

    <!-- Navigation -->
    <div class="" id="nav-placeholder"></div>

    <!-- Main Content -->
    <div class="pt-24 pb-12">
      <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-md p-8 my-10">
        <!-- Progress Header -->
        <div class="mb-8">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-semibold text-blue-900">
              Project Submission Form
            </h2>
            <div class="flex items-center gap-3">
              <!-- Auto-save indicator -->
              <div
                id="autoSaveIndicator"
                class="hidden text-sm text-gray-500 flex items-center gap-2"
              >
                <i
                  class="fas fa-circle text-green-500 animate-pulse"
                  style="font-size: 8px"
                ></i>
                <span>Draft saved</span>
              </div>
              <!-- Clear draft button -->
              <button
                type="button"
                id="clearDraftBtn"
                onclick="confirmClearDraft()"
                class="hidden text-sm text-red-600 hover:text-red-700 hover:underline flex items-center gap-1"
              >
                <i class="fas fa-trash-alt"></i>
                <span>Clear Draft</span>
              </button>
            </div>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div
              id="progressBar"
              class="bg-indigo-600 h-2.5 rounded-full"
              style="width: 16.6%"
            ></div>
          </div>
          <p id="progressText" class="text-sm text-gray-600 mt-2">
            Step 1 of 6: Project Location
          </p>
        </div>

        <!-- Form Sections -->
        <form id="projectForm" class="space-y-8">
          <!-- Step 1: Project Location -->
          <div class="form-step block" data-step="1">
            <div class="mb-4">
              <h2 class="text-xl font-bold text-gray-800 flex items-center">
                <span
                  class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3"
                  >1</span
                >
                Project Location
              </h2>
              <p class="text-sm text-gray-600 mt-1">
                Select the geographical areas where your project will be
                implemented
              </p>
              <hr class="mt-4" />
            </div>

            <!-- Location Search -->
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Search for Location
              </label>
              <p class="text-xs text-gray-500 mb-2">
                Use the search box below to find and add project locations. You can also click directly on the map.
              </p>
            </div>

            <!-- Map Section -->
            <div class="mt-2">
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Pick Project Locations on Map (Click to add multiple
                locations)</label
              >

              <!-- Map Search Bar -->
              <div class="relative mb-3">
                <div class="relative">
                  <div
                    class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                  >
                    <i class="fas fa-search text-gray-400"></i>
                  </div>
                  <input
                    type="text"
                    id="mapSearchInput"
                    placeholder="Search for a location (e.g., Nairobi, Meru County, or coordinates)"
                    class="block w-full pl-10 pr-10 py-3 text-black border border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500 sm:text-sm"
                    autocomplete="off"
                  />
                  <button
                    type="button"
                    id="clearSearchBtn"
                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 hidden"
                    title="Clear search"
                  >
                    <i class="fas fa-times"></i>
                  </button>
                </div>

                <!-- Search Results Dropdown -->
                <div
                  id="searchResults"
                  class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-64 overflow-y-auto hidden"
                >
                  <!-- Search results will be populated here -->
                </div>

                <!-- Search Info/Help Text -->
                <div
                  class="flex items-start mt-2 text-xs text-gray-500 space-x-4"
                >
                  <div class="flex items-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    <span>Search by place name, county, or coordinates</span>
                  </div>
                  <div class="flex items-center">
                    <i class="fas fa-map-marker-alt mr-1"></i>
                    <span>Click result to zoom to location</span>
                  </div>
                </div>
              </div>

              <div
                id="newProjectMap"
                style="
                  height: 400px;
                  width: 100%;
                  border-radius: 8px;
                  margin-bottom: 8px;
                  border: 1px solid #e5e7eb;
                  background-color: #f3f4f6;
                  position: relative;
                  overflow: hidden;
                "
              ></div>
              <input type="hidden" id="project_locations" name="locations" />
              <div class="text-sm text-gray-700 mt-2 p-2 bg-gray-50 rounded">
                <strong>Selected Locations:</strong>
                <div id="selectedLocationsList" class="mt-2 space-y-1">
                  <p class="text-gray-500 italic">
                    Click on map to add locations
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2: Basic Information -->
          <div class="form-step hidden" data-step="2">
            <div class="mb-4">
              <h2 class="text-xl font-bold text-gray-800 flex items-center">
                <span
                  class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3"
                  >2</span
                >
                Basic Information
              </h2>
              <p class="text-sm text-gray-600 mt-1">
                Provide essential details about your project
              </p>
              <hr class="mt-4" />
            </div>
            <!-- Title -->
            <div class="mb-6">
              <label for="title" class="block text-sm font-medium text-gray-700"
                >Project Title *</label
              >
              <input
                required
                type="text"
                id="title"
                name="title"
                class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
              />
            </div>

            <!-- Time Period -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div>
                <label
                  for="starttime_period"
                  class="block text-sm font-medium text-gray-700"
                  >Start Date *</label
                >
                <input
                  required
                  type="date"
                  id="starttime_period"
                  name="start_date"
                  class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                />
              </div>
              <div>
                <label
                  for="endtime_period"
                  class="block text-sm font-medium text-gray-700"
                  >End Date</label
                >
                <input
                  type="date"
                  id="endtime_period"
                  name="end_date"
                  class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                />
              </div>
            </div>

            <!-- Activity Type -->
            <div>
              <label
                for="activity_type"
                class="block text-sm font-medium text-gray-700"
                >Activity Type (Description) *</label
              >
              <textarea
                required
                id="activity_type"
                name="activity_type"
                rows="3"
                class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
              ></textarea>
            </div>
          </div>

          <!-- Step 3: Project Themes -->
          <div class="form-step hidden" data-step="3">
            <div class="mb-4">
              <h2 class="text-xl font-bold text-gray-800 flex items-center">
                <span
                  class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3"
                  >3</span
                >
                Project Themes
              </h2>
              <p class="text-sm text-gray-600 mt-1">
                Provide essential details about your project
              </p>
              <hr class="mt-4" />
            </div>
            <div
              class="theme-selection bg-white rounded-lg border-2 border-gray-200 p-6 transition-all duration-200 hover:border-blue-300 hover:shadow-md"
            >
              <div class="flex items-center justify-between mb-4">
                <label class="block text-lg font-semibold text-gray-800">
                  Project Themes *
                </label>
                <div
                  id="selectedThemesDisplay"
                  class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm font-medium"
                >
                  <i class="fas fa-check-circle mr-1"></i>
                  <span id="themesCount">0</span> selected
                </div>
              </div>

              <p class="text-sm text-gray-600 mb-4">
                Select all themes that apply to your project (minimum 1
                required)
              </p>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="GBV"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Gender Based Violence</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      GBV prevention and support programs
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>

                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="AYPSRH"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Adolescent & Youth SRH</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      Sexual and reproductive health for young people
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>

                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="MNH"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Maternal & Newborn Health</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      Maternal care and newborn health programs
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>

                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="FP"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Family Planning</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      Contraception and family planning services
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>

                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="CH"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Child Health</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      Child healthcare and nutrition programs
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>

                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="AH"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Adolescent Health</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      Adolescent healthcare and development
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>

                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="ADV_SBC"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Advocacy and SBC</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      Social behavior change and advocacy programs
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>

                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="MONITORING_EVALUATION"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Monitoring and Evaluation</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      Monitoring and evaluation activities
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>

                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="RESEARCH_LEARNING"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Research and Learning</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      Research and learning initiatives
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>
              </div>

              <input
                type="hidden"
                id="selected_themes"
                name="selected_themes"
                value="[]"
              />

              <div
                class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg hidden"
                id="themeValidationError"
              >
                <div class="flex items-center">
                  <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                  <span class="text-red-700 text-sm"
                    >Please select at least one project theme.</span
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- Step 4: Contact Information -->
          <div class="form-step hidden" data-step="4">
            <div class="mb-4">
              <h2 class="text-xl font-bold text-gray-800 flex items-center">
                <span
                  class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3"
                  >4</span
                >
                Contact Information
              </h2>
              <p class="text-sm text-gray-600 mt-1">
                Provide details for project coordination
              </p>
              <hr class="mt-4" />
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label
                  for="contact_person_name"
                  class="block text-sm font-medium text-gray-700"
                  >Contact Person Name *</label
                >
                <input
                  required
                  type="text"
                  id="contact_person_name"
                  name="contact_person_name"
                  placeholder="Name"
                  class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                />
              </div>
              <div>
                <label
                  for="contact_person_role"
                  class="block text-sm font-medium text-gray-700"
                  >Contact Person Role *</label
                >
                <input
                  required
                  type="text"
                  id="contact_person_role"
                  name="contact_person_role"
                  placeholder="Role"
                  class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                />
              </div>
              <div>
                <label
                  for="contact_person_email"
                  class="block text-sm font-medium text-gray-700"
                  >Contact Person Email *</label
                >
                <input
                  required
                  type="email"
                  id="contact_person_email"
                  name="contact_person_mail"
                  placeholder="Email"
                  class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                />
              </div>
            </div>
          </div>

          <!-- Step 5: Budget & Objectives -->
          <div class="form-step hidden" data-step="5">
            <div class="mb-4">
              <h2 class="text-xl font-bold text-gray-800 flex items-center">
                <span
                  class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3"
                  >5</span
                >
                Budget & Objectives
              </h2>
              <p class="text-sm text-gray-600 mt-1">
                Provide budget estimates and project goals
              </p>
              <hr class="mt-4" />
            </div>
            <div>
              <label
                for="currency"
                class="block text-sm font-medium text-gray-700"
              >
                Currency*</label
              >
              <select
                id="currency"
                name="currency"
                required
                class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
              >
                <option value="">Select Currency</option>
                <option value="EUR">Euro</option>
                <option value="KES">Kenyan Shilling</option>
                <option value="USD">US Dollar</option>
              </select>
            </div>
            <div>
              <label
                for="budget"
                class="block text-sm font-medium text-gray-700"
                >Amount *</label
              >
              <input
                required
                type="text"
                id="budget"
                name="budget"
                placeholder="1,000,000"
                class="block w-full p-2 mt-1 numbers-only text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
              />
            </div>

            <!-- Objectives -->
            <div>
              <label
                for="objectives"
                class="block text-sm font-medium text-gray-700"
                >Project Objectives *</label
              >
              <textarea
                required
                id="objectives"
                name="objectives"
                rows="3"
                class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
              ></textarea>
            </div>
          </div>

          <!-- Step 6: Completion Documents -->
          <div class="form-step hidden" data-step="6">
            <div class="mb-4">
              <h2 class="text-xl font-bold text-gray-800 flex items-center">
                <span
                  class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3"
                  >6</span
                >
                Completion Documents
              </h2>
              <p class="text-sm text-gray-600 mt-1">
                Upload completion reports, certificates, impact assessments, and
                evidence of completed work
              </p>
              <hr class="mt-4" />
            </div>
            <div
              class="supporting-documents bg-white rounded-lg border-2 border-gray-200 p-6 transition-all duration-200 hover:border-blue-300 hover:shadow-md"
            >
              <div class="flex items-center justify-between mb-4">
                <label class="block text-lg font-semibold text-gray-800">
                  Completion Documents
                  <span class="font-light text-sm ml-1" id="documentsRequiredText">(optional)</span>
                </label>
                <div
                  id="documentsCount"
                  class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm font-medium"
                >
                  <i class="fas fa-file mr-1"></i>
                  <span id="docsCount">0</span> files
                </div>
              </div>

              <!-- Conditional Required Documents for Research Theme -->
              <div id="researchRequiredDocs" class="hidden mb-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                <h4 class="text-sm font-semibold text-amber-800 mb-2 flex items-center">
                  <i class="fas fa-exclamation-triangle mr-2"></i>
                  Required Documents for Research & Learning Projects
                </h4>
                <ul class="text-sm text-amber-700 space-y-1">
                  <li class="flex items-center">
                    <i class="fas fa-check-circle mr-2 text-amber-600"></i>
                    NACOSTI Certificate (National Commission for Science, Technology and Innovation)
                  </li>
                </ul>
                <p class="text-xs text-amber-600 mt-2">
                  These documents are mandatory when "Research and Learning" theme is selected.
                </p>
              </div>

              <p class="text-sm text-gray-600 mb-4">
                Upload final reports, completion certificates, photos, or impact
                assessments (PDF, DOC, DOCX, XLS, XLSX - Max 10MB each)
              </p>

              <!-- File Upload Area -->
              <div
                class="file-upload-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 hover:bg-blue-50 transition-all duration-200 cursor-pointer"
                id="fileUploadArea"
              >
                <div class="upload-icon text-gray-400 mb-4">
                  <i class="fas fa-cloud-upload-alt text-4xl"></i>
                </div>
                <div class="upload-text">
                  <p class="text-lg font-medium text-gray-700 mb-2">
                    Drop files here or click to browse
                  </p>
                  <p class="text-sm text-gray-500">
                    Supported formats: PDF, DOC, DOCX, XLS, XLSX
                  </p>
                  <p class="text-xs text-gray-400 mt-1">
                    Maximum file size: 10MB per file
                  </p>
                </div>
                <input
                  type="file"
                  id="documentFiles"
                  name="documents"
                  multiple
                  accept=".pdf,.doc,.docx,.xls,.xlsx"
                  class="hidden"
                />
              </div>

              <!-- Selected Files Display -->
              <div id="selectedFiles" class="mt-4 space-y-2 hidden">
                <h4 class="text-sm font-medium text-gray-700 mb-3">
                  Selected Files:
                </h4>
                <div id="filesList" class="space-y-2">
                  <!-- Files will be added here dynamically -->
                </div>
              </div>

              <!-- File Upload Error -->
              <div
                class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg hidden"
                id="fileUploadError"
              >
                <div class="flex items-center">
                  <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                  <span
                    class="text-red-700 text-sm"
                    id="fileErrorMessage"
                  ></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Navigation Buttons -->
          <div class="flex justify-between mt-10">
            <button
              type="button"
              id="prevBtn"
              class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300"
            >
              Previous
            </button>
            <button
              type="button"
              id="nextBtn"
              class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700"
            >
              Next
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Scripts -->
    <script src="styles/numbersOnly.js"></script>
    <script src="styles/loadNav.js"></script>
    <script src="styles/authnav.js"></script>
    <!-- Custom step handler for past project (overrides projectSteps.js) -->
    <script>
      let currentStep = 1;
      const totalSteps = 6;

      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      const steps = document.querySelectorAll(".form-step");
      const nextBtn = document.getElementById("nextBtn");
      const prevBtn = document.getElementById("prevBtn");

      function showStep(step) {
        steps.forEach((el) => {
          el.classList.toggle("hidden", el.dataset.step != step);
        });

        const progressPercent = (step / totalSteps) * 100;
        progressBar.style.width = progressPercent + "%";

        const titles = [
          "Project Location",
          "Basic Information",
          "Project Themes",
          "Contact Information",
          "Budget & Objectives",
          "Completion Documents", // Updated for past projects
        ];

        progressText.textContent = `Step ${step} of ${totalSteps}: ${
          titles[step - 1]
        }`;

        prevBtn.style.display = step === 1 ? "none" : "inline-flex";
        nextBtn.textContent = step === totalSteps ? "Submit" : "Next";
      }

      nextBtn.addEventListener("click", () => {
        if (currentStep < totalSteps) {
          currentStep++;
          showStep(currentStep);
        } else {
          // On last step, trigger form submission
          const form = document.getElementById("projectForm");
          if (form) {
            form.dispatchEvent(
              new Event("submit", { bubbles: true, cancelable: true })
            );
          }
        }
      });

      prevBtn.addEventListener("click", () => {
        if (currentStep > 1) {
          currentStep--;
          showStep(currentStep);
        }
      });

      // Initialize
      showStep(currentStep);
    </script>
    <script src="config.js"></script>
    <script src="set-base-url.js"></script>
    <script src="auth.js"></script>
    <script src="kenya-locations.js"></script>
    <script>
      // LocalStorage key for draft
      const DRAFT_KEY = "projectFormDraft";
      const DRAFT_EXPIRY_DAYS = 7; // Keep draft for 7 days

      // Initialize everything when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        initializeMap();
        initializeMapSearch();
        initializeThemeSelection();
        initializeFileUpload();
        initializeFormProgress();
        initializeBudgetFormatting();

        // Restore draft after a short delay to ensure all initializations are complete
        setTimeout(() => {
          restoreFormDraft();
        }, 500);
      });

      // Save form data to localStorage
      function saveFormDraft() {
        try {
          const formData = {
            // Basic Information
            title: document.getElementById("title")?.value || "",
            starttime_period:
              document.getElementById("starttime_period")?.value || "",
            endtime_period:
              document.getElementById("endtime_period")?.value || "",
            activity_type:
              document.getElementById("activity_type")?.value || "",

            // Contact Information
            contact_person_name:
              document.getElementById("contact_person_name")?.value || "",
            contact_person_role:
              document.getElementById("contact_person_role")?.value || "",
            contact_person_email:
              document.getElementById("contact_person_email")?.value || "",

            // Budget & Objectives
            currency: document.getElementById("currency")?.value || "",
            budget: document.getElementById("budget")?.value || "",
            objectives: document.getElementById("objectives")?.value || "",

            // Themes (get selected checkboxes)
            themes: Array.from(
              document.querySelectorAll('input[name="themes"]:checked')
            ).map((cb) => cb.value),

            // Locations (without markers which can't be serialized)
            locations: selectedLocations.map((loc) => ({
              id: loc.id,
              lat: loc.lat,
              lng: loc.lng,
              name: loc.name || null,
              county: loc.county || null,
            })),

            // County/SubCounty selection
            county: document.getElementById("countySelect")?.value || "",
            subCounty: document.getElementById("subCountySelect")?.value || "",

            // Supporting documents metadata (file objects can't be stored, so we save metadata)
            documentsMetadata: selectedFiles.map((file) => ({
              name: file.name,
              size: file.size,
              type: file.type,
              lastModified: file.lastModified,
            })),

            // Metadata
            savedAt: new Date().toISOString(),
            expiresAt: new Date(
              Date.now() + DRAFT_EXPIRY_DAYS * 24 * 60 * 60 * 1000
            ).toISOString(),
          };

          localStorage.setItem(DRAFT_KEY, JSON.stringify(formData));

          // Also save files to sessionStorage using FileReader (limited to session only due to size)
          saveFilesToSessionStorage();

          console.log("Form draft saved to localStorage");

          // Show save indicator
          showSaveIndicator();

          // Show clear draft button
          const clearBtn = document.getElementById("clearDraftBtn");
          if (clearBtn) clearBtn.classList.remove("hidden");
        } catch (error) {
          console.error("Error saving form draft:", error);
        }
      }

      // Save files to sessionStorage (only persists for current session)
      async function saveFilesToSessionStorage() {
        try {
          const filesData = [];

          for (const file of selectedFiles) {
            // Convert file to base64
            const base64 = await fileToBase64(file);
            filesData.push({
              name: file.name,
              size: file.size,
              type: file.type,
              lastModified: file.lastModified,
              data: base64,
            });
          }

          sessionStorage.setItem("projectFormFiles", JSON.stringify(filesData));
          console.log(`Saved ${filesData.length} files to sessionStorage`);
        } catch (error) {
          console.error("Error saving files to sessionStorage:", error);
          // Don't fail the entire save if file save fails
        }
      }

      // Convert file to base64
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }

      // Restore files from sessionStorage
      async function restoreFilesFromSessionStorage() {
        try {
          const filesDataStr = sessionStorage.getItem("projectFormFiles");
          if (!filesDataStr) {
            console.log("No files found in sessionStorage");
            return;
          }

          const filesData = JSON.parse(filesDataStr);
          selectedFiles = [];

          for (const fileData of filesData) {
            // Convert base64 back to File object
            const file = await base64ToFile(
              fileData.data,
              fileData.name,
              fileData.type
            );
            selectedFiles.push(file);
          }

          // Update file display
          if (window.updateFileDisplay) {
            updateFileDisplay();
          }

          console.log(
            `Restored ${selectedFiles.length} files from sessionStorage`
          );
        } catch (error) {
          console.error("Error restoring files from sessionStorage:", error);
        }
      }

      // Convert base64 back to File object
      async function base64ToFile(base64, filename, mimeType) {
        const response = await fetch(base64);
        const blob = await response.blob();
        return new File([blob], filename, { type: mimeType });
      }

      // Show auto-save indicator
      function showSaveIndicator() {
        const indicator = document.getElementById("autoSaveIndicator");
        if (indicator) {
          indicator.classList.remove("hidden");
          // Hide after 2 seconds
          setTimeout(() => {
            indicator.classList.add("hidden");
          }, 2000);
        }
      }

      // Confirm before clearing draft
      window.confirmClearDraft = function () {
        if (
          confirm(
            "Are you sure you want to clear the saved draft? This action cannot be undone."
          )
        ) {
          clearFormDraft();

          // Hide clear button
          const clearBtn = document.getElementById("clearDraftBtn");
          if (clearBtn) clearBtn.classList.add("hidden");

          // Reset form
          document.getElementById("projectForm").reset();

          // Clear locations
          selectedLocations.forEach((loc) => {
            if (loc.marker) loc.marker.remove();
          });
          selectedLocations = [];
          markers = [];
          updateLocationsDisplay();

          showSuccessNotification("Draft cleared successfully!");
        }
      };

      // Restore form data from localStorage
      function restoreFormDraft() {
        try {
          const savedData = localStorage.getItem(DRAFT_KEY);
          if (!savedData) return;

          const formData = JSON.parse(savedData);

          // Check if draft has expired
          if (new Date(formData.expiresAt) < new Date()) {
            console.log("Draft expired, clearing...");
            clearFormDraft();
            return;
          }

          // Automatically restore without asking
          console.log(
            `Restoring draft from ${new Date(
              formData.savedAt
            ).toLocaleString()}`
          );

          // Restore basic information
          if (formData.title)
            document.getElementById("title").value = formData.title;
          if (formData.starttime_period)
            document.getElementById("starttime_period").value =
              formData.starttime_period;
          if (formData.endtime_period)
            document.getElementById("endtime_period").value =
              formData.endtime_period;
          if (formData.activity_type)
            document.getElementById("activity_type").value =
              formData.activity_type;

          // Restore contact information
          if (formData.contact_person_name)
            document.getElementById("contact_person_name").value =
              formData.contact_person_name;
          if (formData.contact_person_role)
            document.getElementById("contact_person_role").value =
              formData.contact_person_role;
          if (formData.contact_person_email)
            document.getElementById("contact_person_email").value =
              formData.contact_person_email;

          // Restore budget & objectives
          if (formData.currency)
            document.getElementById("currency").value = formData.currency;
          if (formData.budget)
            document.getElementById("budget").value = formData.budget;
          if (formData.objectives)
            document.getElementById("objectives").value = formData.objectives;

          // Restore themes
          if (formData.themes && formData.themes.length > 0) {
            formData.themes.forEach((themeValue) => {
              const checkbox = document.querySelector(
                `input[name="themes"][value="${themeValue}"]`
              );
              if (checkbox) {
                checkbox.checked = true;
                // Trigger change event to update UI
                checkbox.dispatchEvent(new Event("change"));
              }
            });
          }

          // Restore county/subcounty
          if (formData.county) {
            document.getElementById("countySelect").value = formData.county;
            // Trigger change to populate subcounties
            document
              .getElementById("countySelect")
              .dispatchEvent(new Event("change"));

            // Restore subcounty after a delay
            if (formData.subCounty) {
              setTimeout(() => {
                document.getElementById("subCountySelect").value =
                  formData.subCounty;
              }, 300);
            }
          }

          // Restore locations (will be added when map is ready)
          if (formData.locations && formData.locations.length > 0) {
            // Wait for map to be initialized
            const restoreLocationsInterval = setInterval(() => {
              if (map) {
                clearInterval(restoreLocationsInterval);
                formData.locations.forEach((loc) => {
                  const marker = new mapboxgl.Marker({
                    color: "#3B82F6",
                    draggable: true,
                  })
                    .setLngLat([loc.lng, loc.lat])
                    .addTo(map);

                  marker.on("dragend", function () {
                    updateLocation(marker, marker.getLngLat());
                  });

                  const locationData = {
                    id: loc.id,
                    lat: loc.lat,
                    lng: loc.lng,
                    marker: marker,
                    name: loc.name,
                    county: loc.county,
                  };

                  selectedLocations.push(locationData);
                  markers.push(marker);
                });

                updateLocationsDisplay();
                updateFormData();
              }
            }, 100);
          }

          console.log("Form draft restored successfully");

          // Restore files from sessionStorage
          restoreFilesFromSessionStorage();

          // Show clear draft button
          const clearBtn = document.getElementById("clearDraftBtn");
          if (clearBtn) clearBtn.classList.remove("hidden");

          // Show success message
          showSuccessNotification("Draft restored successfully!");
        } catch (error) {
          console.error("Error restoring form draft:", error);
        }
      }

      // Clear form draft from localStorage
      function clearFormDraft() {
        localStorage.removeItem(DRAFT_KEY);
        sessionStorage.removeItem("projectFormFiles");
        console.log("Form draft and files cleared");
      }

      // Auto-save form data on input changes
      function initializeAutoSave() {
        const form = document.getElementById("projectForm");
        if (!form) return;

        // Debounce function to avoid too frequent saves
        let saveTimeout;
        const debouncedSave = () => {
          clearTimeout(saveTimeout);
          saveTimeout = setTimeout(() => {
            saveFormDraft();
          }, 1000); // Save 1 second after user stops typing
        };

        // Add listeners to all form inputs
        form.addEventListener("input", debouncedSave);
        form.addEventListener("change", debouncedSave);
      }

      // Map initialization
      let map;
      let markers = [];
      let selectedLocations = [];

      function updateLocation(marker, newLngLat) {
        // Find the location in our array and update it
        const locationIndex = selectedLocations.findIndex(
          (loc) => loc.marker === marker
        );
        if (locationIndex !== -1) {
          selectedLocations[locationIndex].lat = newLngLat.lat;
          selectedLocations[locationIndex].lng = newLngLat.lng;
          updateLocationsDisplay();
          updateFormData();
          saveFormDraft(); // Save after location update
        }
      }

      function removeLocation(locationId) {
        const locationIndex = selectedLocations.findIndex(
          (loc) => loc.id === locationId
        );
        if (locationIndex !== -1) {
          // Remove marker from map
          selectedLocations[locationIndex].marker.remove();

          // Remove from arrays
          selectedLocations.splice(locationIndex, 1);
          markers.splice(locationIndex, 1);

          updateLocationsDisplay();
          updateFormData();
          saveFormDraft(); // Save after location removal
        }
      }

      function updateLocationsDisplay() {
        const container = document.getElementById("selectedLocationsList");

        if (selectedLocations.length === 0) {
          container.innerHTML =
            '<p class="text-gray-500 italic">Click on map to add locations</p>';
          return;
        }

        // Clear container first
        container.innerHTML = "";

        // Process each location
        selectedLocations.forEach((location) => {
          const locationDiv = document.createElement("div");
          locationDiv.className =
            "flex items-center justify-between bg-white p-3 rounded border border-gray-200 hover:border-blue-300 transition-colors";

          // Check if we have a pre-defined name (from hospital or search)
          if (location.name) {
            // Display with full details
            locationDiv.innerHTML = `
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <i class="fas fa-hospital text-red-500"></i>
                  <span class="text-sm font-semibold text-gray-900">${
                    location.name
                  }</span>
                </div>
                <div class="flex items-center gap-3 text-xs text-gray-500">
                  ${
                    location.county
                      ? `
                    <span class="flex items-center gap-1">
                      <i class="fas fa-map-marker-alt"></i>
                      ${location.county} County
                    </span>
                  `
                      : ""
                  }
                  <span class="flex items-center gap-1">
                    <i class="fas fa-crosshairs"></i>
                    ${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}
                  </span>
                </div>
              </div>
              <button type="button" onclick="removeLocation(${location.id})"
                      class="text-red-500 hover:text-red-700 ml-2 transition-colors"
                      title="Remove location">
                <i class="fas fa-times-circle text-lg"></i>
              </button>
            `;
            container.appendChild(locationDiv);
          } else {
            // Show loading state and fetch location details
            locationDiv.innerHTML = `
              <span class="text-sm text-blue-600">
                <i class="fas fa-spinner fa-spin mr-2"></i>Loading location...
              </span>
              <button type="button" onclick="removeLocation(${location.id})"
                      class="text-red-500 hover:text-red-700 ml-2">
                <i class="fas fa-times"></i>
              </button>
            `;
            container.appendChild(locationDiv);

            // Reverse geocode to get place name
            fetch(
              `https://api.mapbox.com/geocoding/v5/mapbox.places/${location.lng},${location.lat}.json?access_token=${mapboxgl.accessToken}&types=place,region,country,poi,locality,neighborhood`
            )
              .then((response) => response.json())
              .then((data) => {
                let placeName = `${location.lat.toFixed(
                  4
                )}, ${location.lng.toFixed(4)}`; // fallback
                let details = "";

                if (data.features && data.features.length > 0) {
                  // Try to get detailed place information
                  const poi = data.features.find((f) =>
                    f.place_type.includes("poi")
                  );
                  const neighborhood = data.features.find((f) =>
                    f.place_type.includes("neighborhood")
                  );
                  const locality = data.features.find((f) =>
                    f.place_type.includes("locality")
                  );
                  const place = data.features.find((f) =>
                    f.place_type.includes("place")
                  );
                  const region = data.features.find((f) =>
                    f.place_type.includes("region")
                  );
                  const country = data.features.find((f) =>
                    f.place_type.includes("country")
                  );

                  if (poi) {
                    placeName = poi.text;
                    details = poi.place_name;
                  } else if (neighborhood) {
                    placeName = neighborhood.text;
                    details = neighborhood.place_name;
                  } else if (locality) {
                    placeName = locality.text;
                    details = locality.place_name;
                  } else if (place) {
                    placeName = place.text;
                    details = `${place.text}, ${
                      region ? region.text : "Kenya"
                    }`;
                  } else if (region) {
                    placeName = `${region.text}`;
                    details = `${region.text}, Kenya`;
                  } else if (country) {
                    placeName = country.text;
                    details = country.text;
                  }
                }

                locationDiv.innerHTML = `
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                      <i class="fas fa-map-marker-alt text-blue-500"></i>
                      <span class="text-sm font-semibold text-gray-900">${placeName}</span>
                    </div>
                    <div class="text-xs text-gray-500">
                      ${
                        details ||
                        `${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}`
                      }
                    </div>
                  </div>
                  <button type="button" onclick="removeLocation(${location.id})"
                          class="text-red-500 hover:text-red-700 ml-2 transition-colors"
                          title="Remove location">
                    <i class="fas fa-times-circle text-lg"></i>
                  </button>
                `;
              })
              .catch((error) => {
                console.error("Geocoding error:", error);
                locationDiv.innerHTML = `
                  <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2 mb-1">
                      <i class="fas fa-map-marker-alt text-blue-500"></i>
                      <span class="text-sm font-semibold text-gray-900">Custom Location</span>
                    </div>
                    <div class="text-xs text-gray-500">
                      ${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}
                    </div>
                  </div>
                  <button type="button" onclick="removeLocation(${location.id})"
                          class="text-red-500 hover:text-red-700 ml-2 transition-colors"
                          title="Remove location">
                    <i class="fas fa-times-circle text-lg"></i>
                  </button>
                `;
              });
          }
        });
      }

      function updateFormData() {
        const locationsData = selectedLocations.map((loc) => ({
          latitude: loc.lat,
          longitude: loc.lng,
          name: loc.name || null,
          county: loc.county || null,
          mapsAddress: loc.name
            ? `${loc.name}, ${loc.county}`
            : `${loc.lat},${loc.lng}`,
        }));
        document.getElementById("project_locations").value =
          JSON.stringify(locationsData);
      }

      // Make removeLocation function globally available
      window.removeLocation = removeLocation;

      // Kenya Hospital Locations Data
      const kenyaHospitals = [
        // Nairobi County
        {
          name: "Kenyatta National Hospital",
          lat: -1.3007,
          lng: 36.8065,
          county: "Nairobi",
          type: "National Referral",
        },
        {
          name: "Nairobi Hospital",
          lat: -1.2888,
          lng: 36.8154,
          county: "Nairobi",
          type: "Private",
        },
        {
          name: "Aga Khan University Hospital",
          lat: -1.2638,
          lng: 36.8117,
          county: "Nairobi",
          type: "Private",
        },
        {
          name: "MP Shah Hospital",
          lat: -1.2676,
          lng: 36.8095,
          county: "Nairobi",
          type: "Private",
        },
        {
          name: "Gertrude's Children's Hospital",
          lat: -1.2707,
          lng: 36.809,
          county: "Nairobi",
          type: "Specialist",
        },
        {
          name: "Mater Hospital",
          lat: -1.2946,
          lng: 36.8237,
          county: "Nairobi",
          type: "Private",
        },
        {
          name: "Karen Hospital",
          lat: -1.3237,
          lng: 36.7124,
          county: "Nairobi",
          type: "Private",
        },
        {
          name: "Coptic Hospital",
          lat: -1.2961,
          lng: 36.8159,
          county: "Nairobi",
          type: "Faith-based",
        },

        // Mombasa County
        {
          name: "Coast General Hospital",
          lat: -4.0435,
          lng: 39.6682,
          county: "Mombasa",
          type: "County Referral",
        },
        {
          name: "Aga Khan Hospital Mombasa",
          lat: -4.052,
          lng: 39.6657,
          county: "Mombasa",
          type: "Private",
        },
        {
          name: "Mombasa Hospital",
          lat: -4.047,
          lng: 39.6724,
          county: "Mombasa",
          type: "Private",
        },
        {
          name: "Pandya Memorial Hospital",
          lat: -4.0611,
          lng: 39.6633,
          county: "Mombasa",
          type: "Private",
        },

        // Kisumu County
        {
          name: "Jaramogi Oginga Odinga Teaching & Referral Hospital",
          lat: -0.0917,
          lng: 34.7675,
          county: "Kisumu",
          type: "Teaching Hospital",
        },
        {
          name: "Aga Khan Hospital Kisumu",
          lat: -0.0917,
          lng: 34.754,
          county: "Kisumu",
          type: "Private",
        },
        {
          name: "Avenue Hospital Kisumu",
          lat: -0.0878,
          lng: 34.7523,
          county: "Kisumu",
          type: "Private",
        },

        // Nakuru County
        {
          name: "Nakuru Level 5 Hospital",
          lat: -0.2827,
          lng: 36.08,
          county: "Nakuru",
          type: "County Referral",
        },
        {
          name: "War Memorial Hospital Nakuru",
          lat: -0.2838,
          lng: 36.0665,
          county: "Nakuru",
          type: "Private",
        },
        {
          name: "Mediheal Hospital Nakuru",
          lat: -0.289,
          lng: 36.0766,
          county: "Nakuru",
          type: "Private",
        },

        // Eldoret (Uasin Gishu County)
        {
          name: "Moi Teaching & Referral Hospital",
          lat: 0.5199,
          lng: 35.2697,
          county: "Uasin Gishu",
          type: "Teaching Hospital",
        },
        {
          name: "Eldoret Hospital",
          lat: 0.5143,
          lng: 35.2698,
          county: "Uasin Gishu",
          type: "Private",
        },
        {
          name: "Mediheal Hospital Eldoret",
          lat: 0.5138,
          lng: 35.2827,
          county: "Uasin Gishu",
          type: "Private",
        },

        // Meru County
        {
          name: "Meru Level 5 Hospital",
          lat: 0.0469,
          lng: 37.6489,
          county: "Meru",
          type: "County Referral",
        },
        {
          name: "Consolata Hospital Nkubu",
          lat: 0.1617,
          lng: 37.727,
          county: "Meru",
          type: "Faith-based",
        },
        {
          name: "Maua Methodist Hospital",
          lat: 0.2337,
          lng: 37.9408,
          county: "Meru",
          type: "Faith-based",
        },

        // Nyeri County
        {
          name: "Nyeri County Referral Hospital",
          lat: -0.4197,
          lng: 36.9519,
          county: "Nyeri",
          type: "County Referral",
        },
        {
          name: "Outspan Hospital",
          lat: -0.4225,
          lng: 36.95,
          county: "Nyeri",
          type: "Private",
        },

        // Machakos County
        {
          name: "Machakos Level 5 Hospital",
          lat: -1.5177,
          lng: 37.2634,
          county: "Machakos",
          type: "County Referral",
        },
        {
          name: "Shalom Hospital Machakos",
          lat: -1.5219,
          lng: 37.2585,
          county: "Machakos",
          type: "Private",
        },

        // Kitui County
        {
          name: "Kitui County Referral Hospital",
          lat: -1.3667,
          lng: 38.01,
          county: "Kitui",
          type: "County Referral",
        },

        // Kiambu County
        {
          name: "Thika Level 5 Hospital",
          lat: -1.0332,
          lng: 37.0738,
          county: "Kiambu",
          type: "County Referral",
        },
        {
          name: "Nazareth Hospital Kiambu",
          lat: -1.1669,
          lng: 36.831,
          county: "Kiambu",
          type: "Faith-based",
        },

        // Kakamega County
        {
          name: "Kakamega County General Hospital",
          lat: 0.2827,
          lng: 34.7519,
          county: "Kakamega",
          type: "County Referral",
        },

        // Kisii County
        {
          name: "Kisii Teaching & Referral Hospital",
          lat: -0.6817,
          lng: 34.768,
          county: "Kisii",
          type: "Teaching Hospital",
        },

        // Bungoma County
        {
          name: "Bungoma County Referral Hospital",
          lat: 0.5635,
          lng: 34.5606,
          county: "Bungoma",
          type: "County Referral",
        },

        // Garissa County
        {
          name: "Garissa County Referral Hospital",
          lat: -0.4536,
          lng: 39.6401,
          county: "Garissa",
          type: "County Referral",
        },

        // Embu County
        {
          name: "Embu Level 5 Hospital",
          lat: -0.5316,
          lng: 37.4577,
          county: "Embu",
          type: "County Referral",
        },

        // Nyamira County
        {
          name: "Nyamira County Referral Hospital",
          lat: -0.5667,
          lng: 34.9333,
          county: "Nyamira",
          type: "County Referral",
        },

        // Kericho County
        {
          name: "Kericho County Referral Hospital",
          lat: -0.3676,
          lng: 35.2839,
          county: "Kericho",
          type: "County Referral",
        },

        // Migori County
        {
          name: "Migori County Referral Hospital",
          lat: -1.0634,
          lng: 34.4731,
          county: "Migori",
          type: "County Referral",
        },

        // Homa Bay County
        {
          name: "Homa Bay County Teaching & Referral Hospital",
          lat: -0.5273,
          lng: 34.4569,
          county: "Homa Bay",
          type: "County Referral",
        },
      ];

      // Function to add hospital markers to the map
      function addHospitalMarkers() {
        kenyaHospitals.forEach((hospital) => {
          // Create custom HTML element for hospital marker
          const el = document.createElement("div");
          el.className = "hospital-marker";
          el.innerHTML = '<i class="fas fa-hospital"></i>';
          el.style.cssText = `
            background-color: #EF4444;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: box-shadow 0.2s, border-color 0.2s;
          `;

          // Add hover effect - only change visual properties, not size
          el.addEventListener("mouseenter", function () {
            el.style.boxShadow = "0 4px 16px rgba(239, 68, 68, 0.6)";
            el.style.borderColor = "#FEE2E2";
            el.style.zIndex = "1000";
          });
          el.addEventListener("mouseleave", function () {
            el.style.boxShadow = "0 2px 8px rgba(0,0,0,0.3)";
            el.style.borderColor = "white";
            el.style.zIndex = "1";
          });

          // Create popup content
          const popupContent = `
            <div class="hospital-popup" style="min-width: 220px;">
              <div style="margin-bottom: 8px;">
                <div style="font-weight: 600; color: #1f2937; font-size: 14px; margin-bottom: 4px;">
                  ${hospital.name}
                </div>
                <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px;">
                  <i class="fas fa-map-marker-alt" style="color: #6b7280; font-size: 11px;"></i>
                  <span style="color: #6b7280; font-size: 12px;">${hospital.county} County</span>
                </div>
                <div style="display: inline-block; background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-top: 4px;">
                  ${hospital.type}
                </div>
              </div>
              <button 
                onclick="addHospitalToProject('${hospital.name}', ${hospital.lat}, ${hospital.lng}, '${hospital.county}')"
                style="
                  width: 100%;
                  padding: 8px 12px;
                  background: #2563eb;
                  color: white;
                  border: none;
                  border-radius: 6px;
                  font-size: 13px;
                  font-weight: 500;
                  cursor: pointer;
                  transition: background 0.2s;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 6px;
                "
                onmouseover="this.style.background='#1d4ed8'"
                onmouseout="this.style.background='#2563eb'"
              >
                <i class="fas fa-plus-circle"></i>
                <span>Add to Project Locations</span>
              </button>
            </div>
          `;

          // Create marker with custom element
          const marker = new mapboxgl.Marker({
            element: el,
            anchor: "center",
          })
            .setLngLat([hospital.lng, hospital.lat])
            .setPopup(
              new mapboxgl.Popup({
                offset: 25,
                closeButton: true,
                closeOnClick: false,
                maxWidth: "300px",
              }).setHTML(popupContent)
            )
            .addTo(map);

          // Open popup on click
          el.addEventListener("click", function (e) {
            e.stopPropagation();
            marker.togglePopup();
          });
        });
      }

      // Function to add hospital to project locations
      window.addHospitalToProject = function (hospitalName, lat, lng, county) {
        // Create a new project marker
        const marker = new mapboxgl.Marker({
          color: "#3B82F6",
          draggable: true,
        })
          .setLngLat([lng, lat])
          .addTo(map);

        // Add drag functionality
        marker.on("dragend", function () {
          updateLocation(marker, marker.getLngLat());
        });

        // Store the location
        const locationData = {
          id: Date.now(),
          lat: lat,
          lng: lng,
          marker: marker,
          name: hospitalName,
          county: county,
        };

        selectedLocations.push(locationData);
        markers.push(marker);

        updateLocationsDisplay();
        updateFormData();

        // Close all popups
        const popups = document.getElementsByClassName("mapboxgl-popup");
        if (popups.length) {
          for (let i = 0; i < popups.length; i++) {
            popups[i].remove();
          }
        }

        // Show success notification
        showSuccessNotification(`${hospitalName} added to project!`);

        // Zoom to the location
        map.flyTo({
          center: [lng, lat],
          zoom: 13,
          duration: 1500,
        });
      };

      // Function to show success notification
      function showSuccessNotification(message) {
        const notification = document.createElement("div");
        notification.className = "success-notification";
        notification.style.cssText = `
          position: fixed;
          top: 80px;
          right: 20px;
          background: #10b981;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 10000;
          display: flex;
          align-items: center;
          gap: 10px;
          font-size: 14px;
          font-weight: 500;
          animation: slideIn 0.3s ease-out;
        `;
        notification.innerHTML = `
          <i class="fas fa-check-circle"></i>
          <span>${message}</span>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.style.animation = "slideOut 0.3s ease-in";
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      // Add CSS animation for notifications
      const style = document.createElement("style");
      style.textContent = `
        @keyframes slideIn {
          from {
            transform: translateX(400px);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        @keyframes slideOut {
          from {
            transform: translateX(0);
            opacity: 1;
          }
          to {
            transform: translateX(400px);
            opacity: 0;
          }
        }
        .hospital-marker:hover {
          z-index: 1000 !important;
        }
      `;
      document.head.appendChild(style);

      function initializeMap() {
        try {
          mapboxgl.accessToken = window.MAPBOX_TOKEN;

          map = new mapboxgl.Map({
            container: "newProjectMap",
            style: "mapbox://styles/mapbox/streets-v11",
            center: [37.9062, -0.0236], // Center of Kenya
            zoom: 6,
          });

          map.on("click", function (e) {
            const lngLat = e.lngLat;

            // Create a new marker
            const marker = new mapboxgl.Marker({
              color: "#3B82F6",
              draggable: true,
            })
              .setLngLat(lngLat)
              .addTo(map);

            // Add drag functionality
            marker.on("dragend", function () {
              updateLocation(marker, marker.getLngLat());
            });

            // Store the location
            const locationData = {
              id: Date.now(),
              lat: lngLat.lat,
              lng: lngLat.lng,
              marker: marker,
            };

            selectedLocations.push(locationData);
            markers.push(marker);

            updateLocationsDisplay();
            updateFormData();
          });

          // Wait for map to load before adding hospital markers
          map.on("load", function () {
            addHospitalMarkers();
            // Initialize auto-save after map is ready
            initializeAutoSave();
          });
        } catch (error) {
          console.error("Map initialization failed:", error);
          document.getElementById("newProjectMap").innerHTML =
            '<div class="flex items-center justify-center h-full text-gray-500"><div class="text-center"><i class="fas fa-map-marked-alt text-4xl mb-2"></i><p>Map unavailable</p><p class="text-sm">Please check Mapbox configuration</p></div></div>';
        }
      }

      // Map search functionality
      function initializeMapSearch() {
        const searchInput = document.getElementById("mapSearchInput");
        const searchResults = document.getElementById("searchResults");
        const clearSearchBtn = document.getElementById("clearSearchBtn");
        let searchTimeout;
        let currentSearchMarker = null;

        // Search input handler with debounce
        searchInput.addEventListener("input", function (e) {
          const query = e.target.value.trim();

          // Show/hide clear button
          if (query) {
            clearSearchBtn.classList.remove("hidden");
          } else {
            clearSearchBtn.classList.add("hidden");
            searchResults.innerHTML = "";
            searchResults.classList.add("hidden");
            return;
          }

          // Debounce search
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            performSearch(query);
          }, 300);
        });

        // Clear search button
        clearSearchBtn.addEventListener("click", function () {
          searchInput.value = "";
          searchResults.innerHTML = "";
          searchResults.classList.add("hidden");
          clearSearchBtn.classList.add("hidden");

          // Remove search marker if exists
          if (currentSearchMarker) {
            currentSearchMarker.remove();
            currentSearchMarker = null;
          }
        });

        // Close search results when clicking outside
        document.addEventListener("click", function (e) {
          if (
            !searchInput.contains(e.target) &&
            !searchResults.contains(e.target)
          ) {
            searchResults.classList.add("hidden");
          }
        });

        // Show results when input is focused and has value
        searchInput.addEventListener("focus", function () {
          if (searchInput.value.trim() && searchResults.children.length > 0) {
            searchResults.classList.remove("hidden");
          }
        });

        async function performSearch(query) {
          try {
            // Show loading state
            searchResults.innerHTML = `
              <div class="p-4 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin mr-2"></i>
                Searching...
              </div>
            `;
            searchResults.classList.remove("hidden");

            // Mapbox Geocoding API - prioritize Kenya locations
            const response = await fetch(
              `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(
                query
              )}.json?access_token=${
                mapboxgl.accessToken
              }&country=KE&limit=8&types=place,locality,neighborhood,address,poi,region,district`
            );

            if (!response.ok) {
              throw new Error("Search failed");
            }

            const data = await response.json();

            if (!data.features || data.features.length === 0) {
              searchResults.innerHTML = `
                <div class="p-4 text-center text-gray-500">
                  <i class="fas fa-search mr-2"></i>
                  No results found for "${query}"
                </div>
              `;
              return;
            }

            // Display results
            displaySearchResults(data.features);
          } catch (error) {
            console.error("Search error:", error);
            searchResults.innerHTML = `
              <div class="p-4 text-center text-red-500">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Search failed. Please try again.
              </div>
            `;
          }
        }

        function displaySearchResults(features) {
          searchResults.innerHTML = "";

          features.forEach((feature) => {
            const resultItem = document.createElement("div");
            resultItem.className =
              "px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-200 last:border-b-0 transition-colors";

            // Get place type icon
            const placeType = feature.place_type[0];
            const icon = getPlaceTypeIcon(placeType);

            // Get place context (region, country)
            const context = feature.context || [];
            const region = context.find((c) => c.id.includes("region"));
            const country = context.find((c) => c.id.includes("country"));

            const placeName = feature.place_name || feature.text;
            const placeContext = feature.properties.address || "";

            resultItem.innerHTML = `
              <div class="flex items-start space-x-3">
                <div class="text-blue-500 mt-1">
                  <i class="${icon}"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="font-medium text-gray-900 truncate">
                    ${feature.text}
                  </div>
                  <div class="text-sm text-gray-500 truncate">
                    ${placeName}
                  </div>
                  ${
                    feature.properties.category
                      ? `<div class="text-xs text-gray-400 mt-1">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100">
                      ${feature.properties.category}
                    </span>
                  </div>`
                      : ""
                  }
                </div>
                <div class="text-xs text-gray-400 mt-1">
                  <i class="fas fa-chevron-right"></i>
                </div>
              </div>
            `;

            resultItem.addEventListener("click", function () {
              selectSearchResult(feature);
            });

            searchResults.appendChild(resultItem);
          });

          searchResults.classList.remove("hidden");
        }

        function getPlaceTypeIcon(placeType) {
          const iconMap = {
            place: "fas fa-city",
            locality: "fas fa-map-marker-alt",
            neighborhood: "fas fa-home",
            address: "fas fa-map-pin",
            poi: "fas fa-map-marked-alt",
            region: "fas fa-map",
            district: "fas fa-map-signs",
            country: "fas fa-flag",
          };
          return iconMap[placeType] || "fas fa-map-marker-alt";
        }

        function selectSearchResult(feature) {
          const [lng, lat] = feature.center;

          // Remove previous search marker
          if (currentSearchMarker) {
            currentSearchMarker.remove();
          }

          // Add a temporary search marker (different color)
          currentSearchMarker = new mapboxgl.Marker({
            color: "#10b981", // Green color for search results
            draggable: false,
          })
            .setLngLat([lng, lat])
            .setPopup(
              new mapboxgl.Popup({ offset: 25 }).setHTML(`
              <div class="p-2">
                <div class="font-semibold text-gray-900">${feature.text}</div>
                <div class="text-sm text-gray-600">${feature.place_name}</div>
                <button 
                  onclick="addSearchLocationToProject(${lat}, ${lng}, '${feature.text}')"
                  class="mt-2 w-full px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors"
                >
                  <i class="fas fa-plus mr-1"></i>
                  Add to Project
                </button>
              </div>
            `)
            )
            .addTo(map);

          // Open popup automatically
          currentSearchMarker.togglePopup();

          // Fly to location
          map.flyTo({
            center: [lng, lat],
            zoom: 14,
            duration: 2000,
          });

          // Update search input
          searchInput.value = feature.place_name;

          // Hide search results
          searchResults.classList.add("hidden");
        }
      }

      // Function to add search location to project (called from popup)
      window.addSearchLocationToProject = function (lat, lng, placeName) {
        // Create a new marker for the project
        const marker = new mapboxgl.Marker({
          color: "#3B82F6",
          draggable: true,
        })
          .setLngLat([lng, lat])
          .addTo(map);

        // Add drag functionality
        marker.on("dragend", function () {
          updateLocation(marker, marker.getLngLat());
        });

        // Store the location
        const locationData = {
          id: Date.now(),
          lat: lat,
          lng: lng,
          marker: marker,
          name: placeName,
        };

        selectedLocations.push(locationData);
        markers.push(marker);

        updateLocationsDisplay();
        updateFormData();

        // Close the search marker popup
        const searchMarker = map._markers?.find((m) => m.getPopup());
        if (searchMarker) {
          searchMarker.togglePopup();
        }

        // Show success message
        const successMessage = document.createElement("div");
        successMessage.className =
          "fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center space-x-2";
        successMessage.innerHTML = `
          <i class="fas fa-check-circle"></i>
          <span>Location added to project!</span>
        `;
        document.body.appendChild(successMessage);

        setTimeout(() => {
          successMessage.remove();
        }, 3000);
      };

      // Theme selection handling
      function initializeThemeSelection() {
        const themeCheckboxes = document.querySelectorAll(
          'input[name="themes"]'
        );
        const selectedThemesInput = document.getElementById("selected_themes");
        const themesCountDisplay = document.getElementById("themesCount");
        const themeValidationError = document.getElementById(
          "themeValidationError"
        );
        const selectedThemesDisplay = document.getElementById(
          "selectedThemesDisplay"
        );

        function updateSelectedThemes() {
          const selectedThemes = Array.from(themeCheckboxes)
            .filter((checkbox) => checkbox.checked)
            .map((checkbox) => checkbox.value);

          selectedThemesInput.value = JSON.stringify(selectedThemes);
          themesCountDisplay.textContent = selectedThemes.length;

          // Update visual feedback for each theme option
          themeCheckboxes.forEach((checkbox) => {
            const themeOption = checkbox.closest(".theme-option");
            const checkmark = themeOption.querySelector(".checkmark");

            if (checkbox.checked) {
              themeOption.classList.add("border-blue-500", "bg-blue-50");
              themeOption.classList.remove(
                "border-gray-200",
                "hover:border-blue-400"
              );
              checkmark.classList.remove("hidden");
            } else {
              themeOption.classList.remove("border-blue-500", "bg-blue-50");
              themeOption.classList.add("border-gray-200");
              checkmark.classList.add("hidden");
            }
          });

          // Update counter styling
          if (selectedThemes.length > 0) {
            selectedThemesDisplay.classList.remove(
              "bg-gray-100",
              "text-gray-600"
            );
            selectedThemesDisplay.classList.add("bg-blue-50", "text-blue-700");
          } else {
            selectedThemesDisplay.classList.remove(
              "bg-blue-50",
              "text-blue-700"
            );
            selectedThemesDisplay.classList.add("bg-gray-100", "text-gray-600");
          }

          // Update form validation
          const themeContainer = document.querySelector(".theme-selection");
          if (selectedThemes.length === 0) {
            themeContainer.classList.add("border-red-500");
            themeContainer.classList.remove(
              "border-gray-200",
              "hover:border-blue-300"
            );
            themeValidationError.classList.remove("hidden");
          } else {
            themeContainer.classList.remove("border-red-500");
            themeContainer.classList.add("border-gray-200");
            themeValidationError.classList.add("hidden");
          }

          // Update supporting documents section based on theme selection
          const researchRequiredDocs = document.getElementById("researchRequiredDocs");
          const documentsRequiredText = document.getElementById("documentsRequiredText");

          if (selectedThemes.includes("RESEARCH_LEARNING")) {
            researchRequiredDocs.classList.remove("hidden");
            documentsRequiredText.textContent = "(NACOSTI Certificate required)";
            documentsRequiredText.classList.add("text-amber-600", "font-medium");
            documentsRequiredText.classList.remove("font-light");
          } else {
            researchRequiredDocs.classList.add("hidden");
            documentsRequiredText.textContent = "(optional)";
            documentsRequiredText.classList.remove("text-amber-600", "font-medium");
            documentsRequiredText.classList.add("font-light");
          }
        }

        themeCheckboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", updateSelectedThemes);
        });

        // Initial update
        updateSelectedThemes();
      }

      // File upload handling
      let selectedFiles = [];

      function initializeFileUpload() {
        const fileUploadArea = document.getElementById("fileUploadArea");
        const documentFilesInput = document.getElementById("documentFiles");
        const selectedFilesDiv = document.getElementById("selectedFiles");
        const filesList = document.getElementById("filesList");
        const docsCount = document.getElementById("docsCount");
        const documentsCount = document.getElementById("documentsCount");

        // Click to open file dialog
        fileUploadArea.addEventListener("click", function () {
          documentFilesInput.click();
        });

        // Drag and drop functionality
        fileUploadArea.addEventListener("dragover", function (e) {
          e.preventDefault();
          fileUploadArea.classList.add("border-blue-500", "bg-blue-50");
        });

        fileUploadArea.addEventListener("dragleave", function (e) {
          e.preventDefault();
          fileUploadArea.classList.remove("border-blue-500", "bg-blue-50");
        });

        fileUploadArea.addEventListener("drop", function (e) {
          e.preventDefault();
          fileUploadArea.classList.remove("border-blue-500", "bg-blue-50");

          const files = Array.from(e.dataTransfer.files);
          handleFileSelection(files);
        });

        // File input change
        documentFilesInput.addEventListener("change", function (e) {
          const files = Array.from(e.target.files);
          handleFileSelection(files);
        });

        function handleFileSelection(files) {
          const validFiles = [];
          const errors = [];

          files.forEach((file) => {
            // Validate file type
            const allowedTypes = [
              "application/pdf",
              "application/msword",
              "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
              "application/vnd.ms-excel",
              "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            ];
            const allowedExtensions = [
              ".pdf",
              ".doc",
              ".docx",
              ".xls",
              ".xlsx",
            ];

            const fileExtension = file.name
              .toLowerCase()
              .substring(file.name.lastIndexOf("."));
            const isValidType =
              allowedTypes.includes(file.type) ||
              allowedExtensions.includes(fileExtension);

            if (!isValidType) {
              errors.push(
                `${file.name}: Invalid file type. Only PDF, DOC, DOCX, XLS, XLSX allowed.`
              );
              return;
            }

            // Validate file size (10MB max)
            const maxSize = 10 * 1024 * 1024; // 10MB in bytes
            if (file.size > maxSize) {
              errors.push(
                `${file.name}: File too large. Maximum size is 10MB.`
              );
              return;
            }

            // Check for duplicates
            const isDuplicate = selectedFiles.some(
              (existingFile) =>
                existingFile.name === file.name &&
                existingFile.size === file.size
            );

            if (isDuplicate) {
              errors.push(`${file.name}: File already selected.`);
              return;
            }

            validFiles.push(file);
          });

          // Show errors if any
          if (errors.length > 0) {
            showFileError(errors.join("<br>"));
            return;
          }

          // Hide error if shown
          hideFileError();

          // Add valid files
          selectedFiles.push(...validFiles);
          updateFileDisplay();

          // Clear input
          documentFilesInput.value = "";
        }

        // Make updateFileDisplay globally accessible
        window.updateFileDisplay = function () {
          if (selectedFiles.length === 0) {
            selectedFilesDiv.classList.add("hidden");
            documentsCount.classList.remove("bg-blue-50", "text-blue-700");
            documentsCount.classList.add("bg-gray-100", "text-gray-600");
          } else {
            selectedFilesDiv.classList.remove("hidden");
            documentsCount.classList.remove("bg-gray-100", "text-gray-600");
            documentsCount.classList.add("bg-blue-50", "text-blue-700");
          }

          docsCount.textContent = selectedFiles.length;

          // Clear existing list
          filesList.innerHTML = "";

          // Add files to list
          selectedFiles.forEach((file, index) => {
            const fileDiv = document.createElement("div");
            fileDiv.className =
              "flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200";

            const fileIcon = getFileIcon(file.name);
            const fileSize = formatFileSize(file.size);

            fileDiv.innerHTML = `
              <div class="flex items-center space-x-3">
                <div class="text-blue-500">
                  <i class="${fileIcon}"></i>
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-800">${file.name}</p>
                  <p class="text-xs text-gray-500">${fileSize}</p>
                </div>
              </div>
              <button type="button" onclick="removeFile(${index})" class="text-red-500 hover:text-red-700 transition-colors">
                <i class="fas fa-times"></i>
              </button>
            `;

            filesList.appendChild(fileDiv);
          });
        };

        function getFileIcon(filename) {
          const extension = filename.toLowerCase().split(".").pop();
          switch (extension) {
            case "pdf":
              return "fas fa-file-pdf";
            case "doc":
            case "docx":
              return "fas fa-file-word";
            case "xls":
            case "xlsx":
              return "fas fa-file-excel";
            default:
              return "fas fa-file";
          }
        }

        function formatFileSize(bytes) {
          if (bytes === 0) return "0 Bytes";
          const k = 1024;
          const sizes = ["Bytes", "KB", "MB", "GB"];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return (
            parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
          );
        }

        function showFileError(message) {
          const errorDiv = document.getElementById("fileUploadError");
          const errorMessage = document.getElementById("fileErrorMessage");
          errorMessage.innerHTML = message;
          errorDiv.classList.remove("hidden");
        }

        function hideFileError() {
          const errorDiv = document.getElementById("fileUploadError");
          errorDiv.classList.add("hidden");
        }

        // Make removeFile function globally available
        window.removeFile = function (index) {
          selectedFiles.splice(index, 1);
          updateFileDisplay();
        };
      }

      // Form progress tracking
      function initializeFormProgress() {
        const progressSteps = document.querySelectorAll(".progress-step");
        let currentSection = 1;

        // Update progress when user scrolls or focuses on sections
        function updateProgress() {
          const sections = document.querySelectorAll(".form-section");
          const scrollPosition = window.scrollY + 200; // Offset for header

          sections.forEach((section, index) => {
            const sectionTop = section.offsetTop;
            const sectionBottom = sectionTop + section.offsetHeight;

            if (
              scrollPosition >= sectionTop &&
              scrollPosition < sectionBottom
            ) {
              currentSection = index + 1;
              updateProgressIndicator(currentSection);
            }
          });
        }

        function updateProgressIndicator(activeSection) {
          progressSteps.forEach((step, index) => {
            const stepNumber = index + 1;

            // Remove all classes
            step.classList.remove("current", "completed", "pending");

            if (stepNumber < activeSection) {
              step.classList.add("completed");
            } else if (stepNumber === activeSection) {
              step.classList.add("current");
            } else {
              step.classList.add("pending");
            }
          });
        }

        // Add scroll listener
        window.addEventListener("scroll", updateProgress);

        // Initial progress update
        updateProgress();
      }

      // Budget input formatting
      function initializeBudgetFormatting() {
        const budgetInput = document.getElementById("budget");

        budgetInput.addEventListener("input", function (e) {
          // Remove all non-digit characters except decimal point
          let value = e.target.value.replace(/[^\d]/g, "");

          // Format with commas
          if (value) {
            value = parseInt(value).toLocaleString("en-US");
          }

          // Update the input value
          e.target.value = value;
        });

        // Prevent non-numeric input on keypress
        budgetInput.addEventListener("keypress", function (e) {
          // Allow backspace, delete, tab, escape, enter, and decimal point
          if (
            [8, 9, 27, 13, 110, 190].includes(e.keyCode) ||
            // Allow Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X, Ctrl+Z
            (e.ctrlKey && [65, 67, 86, 88, 90].includes(e.keyCode))
          ) {
            return;
          }

          // Block non-numeric characters
          if (
            (e.shiftKey || e.keyCode < 48 || e.keyCode > 57) &&
            (e.keyCode < 96 || e.keyCode > 105)
          ) {
            e.preventDefault();
          }
        });
      }

      // Add event listeners for county/sub-county dropdowns to zoom map
      document
        .getElementById("countySelect")
        .addEventListener("change", function () {
          const selectedCounty = this.value;
          if (
            selectedCounty &&
            window.countyCoordinates &&
            window.countyCoordinates[selectedCounty] &&
            map
          ) {
            const [lng, lat] = window.countyCoordinates[selectedCounty];
            map.flyTo({
              center: [lng, lat],
              zoom: 9,
            });
          }
        });

      document
        .getElementById("subCountySelect")
        .addEventListener("change", function () {
          const selectedSubCounty = this.value;
          if (
            selectedSubCounty &&
            window.subCountyCoordinates &&
            window.subCountyCoordinates[selectedSubCounty] &&
            map
          ) {
            const [lng, lat] = window.subCountyCoordinates[selectedSubCounty];
            map.flyTo({
              center: [lng, lat],
              zoom: 11,
            });
          }
        });

      // Form submission
      document
        .getElementById("projectForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Show loading overlay
          const loadingOverlay = document.getElementById("loadingOverlay");
          loadingOverlay.classList.remove("hidden");

          // Disable submit button to prevent double submission
          // Try to find the actual submit button (Next button on last step)
          const submitButton =
            this.querySelector('button[type="submit"]') ||
            document.getElementById("nextBtn");
          const originalButtonText = submitButton
            ? submitButton.innerHTML
            : "Submit";

          if (submitButton) {
            submitButton.disabled = true;
            submitButton.classList.add("opacity-50", "cursor-not-allowed");
          }

          // Helper function to re-enable submit button
          const enableSubmitButton = () => {
            if (submitButton) {
              submitButton.disabled = false;
              submitButton.classList.remove("opacity-50", "cursor-not-allowed");
            }
          };

          // Don't use FormData(this) to avoid including empty file inputs
          // Instead, collect form data manually
          const formData = new FormData();

          // Add all form fields except file inputs
          const formElements = this.querySelectorAll(
            'input:not([type="file"]), textarea, select'
          );
          formElements.forEach((element) => {
            if (element.name && element.value) {
              formData.append(element.name, element.value);
            }
          });

          // Add selected files to FormData (only valid files)
          selectedFiles
            .filter((f) => f.size > 0)
            .forEach((file) => {
              formData.append(`documents`, file);
            });

          // Get form data as object for validation and logging
          const data = {};
          for (let [key, value] of formData.entries()) {
            if (key !== "documents") {
              // Skip files for validation
              data[key] = value;
            }
          }

          console.log("=== FORM SUBMISSION DEBUG ===");
          console.log("Raw FormData entries:");
          for (let [key, value] of formData.entries()) {
            if (key === "documents") {
              console.log(
                `${key}: [File - ${value.name}, ${value.size} bytes]`
              );
            } else {
              console.log(`${key}: ${value}`);
            }
          }
          console.log("Parsed data object:", data);

          // Parse locations and themes from JSON strings
          try {
            if (data.locations) {
              data.locations = JSON.parse(data.locations);
              console.log("Parsed locations:", data.locations);
            }
            if (data.selected_themes) {
              data.themes = JSON.parse(data.selected_themes);
              formData.delete("selected_themes"); // Remove from FormData
              formData.append("themes", JSON.stringify(data.themes)); // Add parsed themes
              console.log("Parsed themes:", data.themes);
            }

            // Clean budget value (remove commas for submission)
            if (data.budget) {
              const cleanBudget = data.budget.replace(/,/g, "");
              formData.set("budget", cleanBudget);
              data.budget = cleanBudget;
              console.log("Cleaned budget:", data.budget);
            }

            // Validate required fields
            if (!data.themes || data.themes.length === 0) {
              const themeValidationError = document.getElementById(
                "themeValidationError"
              );
              themeValidationError.classList.remove("hidden");
              const themeContainer = document.querySelector(".theme-selection");
              themeContainer.classList.add("border-red-500");
              themeContainer.classList.remove(
                "border-gray-200",
                "hover:border-blue-300"
              );
              themeContainer.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });

              // Hide loading overlay and re-enable submit button
              loadingOverlay.classList.add("hidden");
              enableSubmitButton();
              return;
            }

            // Validate NACOSTI Certificate requirement for Research & Learning theme
            if (data.themes && data.themes.includes("RESEARCH_LEARNING")) {
              const hasNacostiCert = selectedFiles.some(file =>
                file.name.toLowerCase().includes("nacosti") ||
                file.name.toLowerCase().includes("certificate") ||
                file.name.toLowerCase().includes("nacosti certificate")
              );

              if (!hasNacostiCert) {
                await showAlert(
                  "For Research & Learning projects, you must upload a NACOSTI Certificate (National Commission for Science, Technology and Innovation).",
                  "Required Document Missing",
                  "warning"
                );

                // Scroll to supporting documents section
                document.querySelector(".supporting-documents").scrollIntoView({
                  behavior: "smooth",
                  block: "center",
                });

                // Hide loading overlay and re-enable submit button
                loadingOverlay.classList.add("hidden");
                enableSubmitButton();
                return;
              }
            }

            if (!data.locations || data.locations.length === 0) {
              await showAlert(
                "Please select at least one location on the map.",
                "Validation Error",
                "warning"
              );

              // Hide loading overlay and re-enable submit button
              loadingOverlay.classList.add("hidden");
              enableSubmitButton();
              return;
            }

            // Get current user for partner field
            const currentUser = JSON.parse(
              localStorage.getItem("user") || "{}"
            );

            // Create project object as expected by backend
            const projectData = {
              title: data.title,
              partner: currentUser.email || data.contact_person_mail, // Use current user email or fallback
              startDate: data.start_date,
              endDate: data.end_date,
              activityType: data.activity_type,
              budget: parseFloat(data.budget) || 0,
              objectives: data.objectives,
              locations: data.locations.map((loc) => ({
                latitude: loc.latitude,
                longitude: loc.longitude,
                county: loc.county || null,
                subCounty: loc.subCounty || null,
                mapsAddress:
                  loc.mapsAddress ||
                  loc.name ||
                  `${loc.latitude},${loc.longitude}`,
              })),
              themes: data.themes,
              contactPersonName: data.contact_person_name,
              contactPersonRole: data.contact_person_role,
              contactPersonEmail: data.contact_person_mail,
              projectCategory: "PAST_PROJECT", // Mark as past/completed project
              status: "completed", // Mark as completed past project
            };

            console.log("Project data object to send:", projectData);

            // Backend expects a 'project' field with JSON data
            const finalFormData = new FormData();

            // Add project data as a Blob with correct content-type
            const projectBlob = new Blob([JSON.stringify(projectData)], {
              type: "application/json",
            });
            finalFormData.append("project", projectBlob);

            // Add files (filter out empty files)
            selectedFiles
              .filter((f) => f.size > 0)
              .forEach((file) => {
                finalFormData.append("supporting_documents", file);
              });

            console.log("Final FormData with project field:");
            for (let [key, value] of finalFormData.entries()) {
              if (key === "supporting_documents") {
                console.log(
                  `${key}: [File - ${value.name}, ${value.size} bytes]`
                );
              } else if (key === "project") {
                console.log(
                  `${key}: [Blob - ${value.size} bytes, type: ${value.type}]`
                );
              } else {
                console.log(`${key}: ${value}`);
              }
            }

            // Debug localStorage state
            console.log("=== TOKEN DEBUGGING ===");
            console.log("localStorage keys:", Object.keys(localStorage));
            console.log(
              "localStorage.token:",
              localStorage.getItem("accessToken")
            );
            console.log("localStorage.user:", localStorage.getItem("user"));
            console.log("window.AuthManager:", window.AuthManager);
            console.log("typeof AuthManager:", typeof window.AuthManager);

            // Get fresh token - try ALL possible methods
            let token = null;

            // Method 1: Direct localStorage access
            token = localStorage.getItem("accessToken");
            console.log(
              "Method 1 (localStorage.getItem):",
              token ? "Found" : "Not found"
            );

            // Method 2: Try with window.localStorage
            if (!token) {
              token = window.localStorage.getItem("accessToken");
              console.log(
                "Method 2 (window.localStorage):",
                token ? "Found" : "Not found"
              );
            }

            // Method 3: Try AuthManager
            if (
              !token &&
              window.AuthManager &&
              typeof window.AuthManager.getToken === "function"
            ) {
              token = window.AuthManager.getToken();
              console.log(
                "Method 3 (AuthManager):",
                token ? "Found" : "Not found"
              );
            }

            // Method 4: Try to re-initialize from user data
            if (!token) {
              const userStr = localStorage.getItem("user");
              if (userStr) {
                console.log("User data exists, but no token found");
              }
            }

            console.log("Final token check:", {
              tokenExists: !!token,
              tokenLength: token ? token.length : 0,
              tokenPreview: token ? token.substring(0, 50) + "..." : "null",
            });

            if (!token) {
              console.error("=== NO AUTHENTICATION TOKEN FOUND ===");
              console.error("All methods failed to retrieve token");
              console.error("localStorage contents:", { ...localStorage });

              await showAlert(
                "Authentication session lost. Please refresh the page and try again.",
                "Authentication Error",
                "error"
              );

              // Hide loading overlay and re-enable submit button
              loadingOverlay.classList.add("hidden");
              enableSubmitButton();

              window.location.href = "index.html";
              return;
            }

            console.log(
              "Using token for request:",
              token ? "Token found" : "No token"
            );

            const response = await fetch(`${window.BASE_URL}/api/projects`, {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
              },
              body: finalFormData,
            });

            console.log("Response status:", response.status);
            console.log(
              "Response headers:",
              Object.fromEntries(response.headers.entries())
            );

            if (response.ok) {
              const result = await response.json();
              console.log("Project created successfully!", result);

              // Clear the draft from localStorage after successful submission
              clearFormDraft();

              // Hide loading overlay before showing success message
              loadingOverlay.classList.add("hidden");
              enableSubmitButton();

              // Extract project number from response
              const projectNumber = result.data?.projectNo || result.projectNo || 'N/A';
              
              // Show success message with project number and copy option
              const projectNumberHtml = `
                <div class="text-center">
                  <p class="text-lg mb-4">Your past project has been created successfully!</p>
                  <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-4">
                    <p class="text-sm text-gray-600 mb-2">Your Project Number:</p>
                    <p class="text-2xl font-bold text-blue-700" id="projectNumberDisplay">${projectNumber}</p>
                  </div>
                  <button onclick="navigator.clipboard.writeText('${projectNumber}').then(() => alert('Project number copied to clipboard!'))" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-copy mr-2"></i>Copy Project Number
                  </button>
                  <p class="text-sm text-gray-600 mt-4"> Please save this project number for future reference.</p>
                </div>
              `;
              
              await showAlert(
                projectNumberHtml,
                "Past Project Created Successfully!",
                "success"
              );
              window.location.href = "index-post-login.html";
            } else {
              let errorMessage = "Unknown error";
              let errorDetails = {};

              try {
                const errorResponse = await response.text();
                console.log("Raw error response:", errorResponse);

                try {
                  errorDetails = JSON.parse(errorResponse);
                  console.log("Parsed error response:", errorDetails);
                  errorMessage =
                    errorDetails.message || errorDetails.error || errorMessage;
                } catch (parseError) {
                  console.log("Could not parse error as JSON:", parseError);
                  errorMessage = errorResponse || errorMessage;
                }
              } catch (textError) {
                console.error("Error reading response text:", textError);
              }

              console.error("Final error message:", errorMessage);
              console.error("Full error details:", errorDetails);

              // Handle 401 Unauthorized specifically
              if (response.status === 401) {
                await showAlert(
                  "Your session has expired. Please log in again.",
                  "Session Expired",
                  "warning"
                );
                // Clear invalid token
                localStorage.removeItem("token");
                localStorage.removeItem("user");

                // Hide loading overlay and re-enable submit button
                loadingOverlay.classList.add("hidden");
                enableSubmitButton();

                // Redirect to login
                setTimeout(() => {
                  window.location.href = "index.html";
                }, 2000);
                return;
              }

              // Hide loading overlay for other errors
              loadingOverlay.classList.add("hidden");
              enableSubmitButton();

              await showAlert(
                "Failed to create project: " + errorMessage,
                "Error",
                "error"
              );
            }
          } catch (error) {
            console.error("Error processing form data:", error);
            console.error("Error stack:", error.stack);

            // Hide loading overlay and re-enable submit button
            loadingOverlay.classList.add("hidden");
            enableSubmitButton();

            await showAlert(
              "Error processing form data. Please try again. Check console for details.",
              "Error",
              "error"
            );
          }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
  </body>
</html>
