<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Donor Management - Tujulishane Hub</title>
	<script src="auth.js"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						primary: "#1e40af",
						secondary: "#f59e0b",
						accent: "#10b981",
						dark: "#1f2937",
					},
					fontFamily: {
						sans: ["Inter", "sans-serif"],
					},
				},
			},
		};
	</script>
	<link rel="stylesheet" href="styles/main.css" />
	<script src="./set-base-url.js"></script>
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
</head>

<body class="bg-gray-50">
	<div class="min-h-screen">
		<!-- Header -->
		<div class="" id="nav-placeholder"></div>

		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
			<!-- Navigation Tabs -->
			<div class="mb-8">
				<nav class="flex space-x-8" id="tabNavigation">
					<!-- Tabs will be dynamically generated based on user role -->
				</nav>
			</div>

			<!-- Donors List -->
			<div id="donorsSection" class="tab-content">
				<div class="bg-white shadow rounded-lg">
					<div class="px-4 py-5 sm:p-6">
						<h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
							All Donors
						</h3>
						<div id="donorsList" class="space-y-4">
							<!-- Donors will be loaded here -->
						</div>
					</div>
				</div>
			</div>

			<!-- My Partners Section -->
			<div id="partnersSection" class="tab-content hidden">
				<div class="bg-white shadow rounded-lg">
					<div class="px-4 py-5 sm:p-6">
						<h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
							My Partner Organizations
						</h3>
						<div id="partnersList" class="space-y-4">
							<!-- Partners will be loaded here -->
						</div>
						<div class="mt-6">
							<button onclick="showLinkPartnerModal()"
								class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
								<i class="fas fa-plus mr-2"></i>Link New Partner
							</button>
						</div>
					</div>
				</div>
			</div>

			<!-- My Donor Section (for partners) -->
			<div id="myDonorSection" class="tab-content hidden">
				<div class="bg-white shadow rounded-lg">
					<div class="px-4 py-5 sm:p-6">
						<h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">
							My Donor Organization
						</h3>
						<div id="donorInfo" class="space-y-4">
							<!-- Donor info will be loaded here -->
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Link Partner Modal -->
	<div id="linkPartnerModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
		<div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
			<div class="mt-3">
				<h3 class="text-lg font-medium text-gray-900 mb-4">
					Link Partner Organization
				</h3>
				<form id="linkPartnerForm">
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">Select Partner Organization</label>
						<select id="partnerSelect" required
							class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
							<option value="">Choose a partner...</option>
							<!-- Available partners will be loaded here -->
						</select>
						<p class="text-xs text-gray-500 mt-1">
							Only shows approved partner organizations that aren't already
							linked to a donor
						</p>
					</div>
					<div class="flex justify-end space-x-3">
						<button type="button" onclick="hideLinkPartnerModal()"
							class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
							Cancel
						</button>
						<button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
							Link Partner
						</button>
					</div>
				</form>
			</div>
		</div>
	</div>


	<script src="styles/loadNav.js"></script>
	<script>
		let currentUser = null;

		// Initialize page
		document.addEventListener("DOMContentLoaded", async function () {
			const auth = new AuthManager();
			const token = auth.getToken();

			if (!token) {
				window.location.href = "index.html";
				return;
			}

			try {
				// Get current user info
				const userResponse = await fetch(`${auth.baseUrl}/api/auth/profile`, {
					headers: { Authorization: `Bearer ${token}` },
				});

				if (!userResponse.ok) {
					throw new Error("Failed to get user info");
				}

				currentUser = await userResponse.json();
				console.log("DEBUG: Full userResponse JSON:", currentUser);
				console.log("DEBUG: currentUser.data:", currentUser.data);
				console.log("DEBUG: currentUser.role:", currentUser.role);
				console.log("DEBUG: currentUser.data.role:", currentUser.data?.role);

				// Handle both response formats (with or without data wrapper)
				const userData = currentUser.data || currentUser;
				currentUser = userData;

				console.log("DEBUG: Final currentUser object:", currentUser);
				console.log(
					"DEBUG: currentUser.role after assignment:",
					currentUser.role
				);

				document.getElementById(
					"userInfo"
				).textContent = `${currentUser.name} (${currentUser.role})`;

				// Check if user is donor or super admin
				console.log("DEBUG: Checking role access...");
				console.log("DEBUG: currentUser.role value:", currentUser.role);
				console.log(
					"DEBUG: currentUser.role === 'DONOR':",
					currentUser.role === "DONOR"
				);
				console.log(
					"DEBUG: currentUser.role === 'SUPER_ADMIN':",
					currentUser.role === "SUPER_ADMIN"
				);

				if (
					currentUser.role !== "DONOR" &&
					currentUser.role !== "SUPER_ADMIN"
				) {
					console.log("DEBUG: Access denied - role check failed");
					alert(
						"Access denied. Only donors and administrators can access this page."
					);
					window.location.href = "dashboard.html";
					return;
				}

				console.log("DEBUG: Access granted - proceeding with initialization");

				// Setup tabs based on user role
				setupTabsForRole();

				// Load initial data
				if (currentUser.role === "SUPER_ADMIN") {
					loadDonors();
				} else if (currentUser.role === "DONOR") {
					loadMyPartners();
				} else if (currentUser.role === "PARTNER") {
					loadMyDonor();
				}
			} catch (error) {
				console.error("Error initializing page:", error);
				alert("Session expired. Please login again.");
				window.location.href = "index.html";
			}
		});

		function setupTabsForRole() {
			const tabNavigation = document.getElementById("tabNavigation");

			if (currentUser.role === "SUPER_ADMIN") {
				tabNavigation.innerHTML = `
            <button id="donorsTab" class="tab-button active border-b-2 border-blue-500 text-blue-600 px-1 py-2 font-medium">
              All Donors
            </button>
            <button id="myPartnersTab" class="tab-button border-b-2 border-transparent text-gray-500 hover:text-gray-700 px-1 py-2 font-medium">
              All Partners
            </button>
          `;
			} else if (currentUser.role === "DONOR") {
				tabNavigation.innerHTML = `
            <button id="myPartnersTab" class="tab-button active border-b-2 border-blue-500 text-blue-600 px-1 py-2 font-medium">
              My Partners
            </button>
          `;
			} else if (currentUser.role === "PARTNER") {
				tabNavigation.innerHTML = `
            <button id="myDonorTab" class="tab-button active border-b-2 border-blue-500 text-blue-600 px-1 py-2 font-medium">
              My Donor
            </button>
          `;
			}

			setupTabs();
		}

		function setupTabs() {
			const tabs = document.querySelectorAll(".tab-button");
			tabs.forEach((tab) => {
				tab.addEventListener("click", function () {
					// Remove active class from all tabs
					tabs.forEach((t) => {
						t.classList.remove("active", "border-blue-500", "text-blue-600");
						t.classList.add("border-transparent", "text-gray-500");
					});

					// Add active class to clicked tab
					this.classList.add("active", "border-blue-500", "text-blue-600");
					this.classList.remove("border-transparent", "text-gray-500");

					// Show corresponding content
					const tabContents = document.querySelectorAll(".tab-content");
					tabContents.forEach((content) => content.classList.add("hidden"));

					if (this.id === "donorsTab") {
						document
							.getElementById("donorsSection")
							.classList.remove("hidden");
						loadDonors();
					} else if (this.id === "myPartnersTab") {
						document
							.getElementById("partnersSection")
							.classList.remove("hidden");
						loadMyPartners();
					} else if (this.id === "myDonorTab") {
						document
							.getElementById("myDonorSection")
							.classList.remove("hidden");
						loadMyDonor();
					}
				});
			});
		}

		async function loadDonors() {
			const auth = new AuthManager();
			const token = auth.getToken();

			try {
				const response = await fetch(`${auth.baseUrl}/api/auth/donors`, {
					headers: { Authorization: `Bearer ${token}` },
				});

				if (!response.ok) {
					throw new Error("Failed to load donors");
				}

				const donors = await response.json();
				displayDonors(donors.data || donors);
			} catch (error) {
				console.error("Error loading donors:", error);
				document.getElementById("donorsList").innerHTML =
					'<p class="text-red-600">Error loading donors</p>';
			}
		}

		async function loadMyPartners() {
			const auth = new AuthManager();
			const token = auth.getToken();

			try {
				const response = await fetch(
					`${auth.baseUrl}/api/auth/donor/${currentUser.id}/partners`,
					{
						headers: { Authorization: `Bearer ${token}` },
					}
				);

				if (!response.ok) {
					throw new Error("Failed to load partners");
				}

				const partners = await response.json();
				displayPartners(partners.data || partners);
			} catch (error) {
				console.error("Error loading partners:", error);
				document.getElementById("partnersList").innerHTML =
					'<p class="text-red-600">Error loading partners</p>';
			}
		}

		function displayDonors(donors) {
			const donorsList = document.getElementById("donorsList");

			if (!donors || donors.length === 0) {
				donorsList.innerHTML = '<p class="text-gray-500">No donors found</p>';
				return;
			}

			donorsList.innerHTML = donors
				.map(
					(donor) => `
                <div class="border rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-900">${donor.name}</h4>
                            <p class="text-sm text-gray-600">${donor.email}</p>
                            <p class="text-sm text-gray-500">Status: ${donor.approvalStatus}</p>
                        </div>
                        <div class="text-right">
                            <button onclick="viewDonorPartners(${donor.id})"
                                    class="text-blue-600 hover:text-blue-800 text-sm">
                                View Partners
                            </button>
                        </div>
                    </div>
                </div>
            `
				)
				.join("");
		}

		function displayPartners(partners) {
			const partnersList = document.getElementById("partnersList");

			if (!partners || partners.length === 0) {
				partnersList.innerHTML =
					'<p class="text-gray-500">No partners linked yet</p>';
				return;
			}

			partnersList.innerHTML = partners
				.map(
					(partner) => `
                <div class="border rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-medium text-gray-900">${partner.name}</h4>
                            <p class="text-sm text-gray-600">${partner.email}</p>
                            <p class="text-sm text-gray-500">Status: ${partner.approvalStatus}</p>
                        </div>
                        <div class="text-right">
                            <button onclick="unlinkPartner(${partner.id})"
                                    class="text-red-600 hover:text-red-800 text-sm">
                                <i class="fas fa-unlink mr-1"></i>Unlink
                            </button>
                        </div>
                    </div>
                </div>
            `
				)
				.join("");
		}

		function viewDonorPartners(donorId) {
			// This could open a modal or navigate to a detailed view
			alert("View partners functionality would be implemented here");
		}

		async function unlinkPartner(partnerId) {
			if (!confirm("Are you sure you want to unlink this partner?")) {
				return;
			}

			const auth = new AuthManager();
			const token = auth.getToken();

			try {
				const response = await fetch(
					`${auth.baseUrl}/api/auth/partner/${partnerId}/unlink-donor`,
					{
						method: "POST",
						headers: { Authorization: `Bearer ${token}` },
					}
				);

				if (!response.ok) {
					throw new Error("Failed to unlink partner");
				}

				alert("Partner unlinked successfully");
				loadMyPartners(); // Refresh the list
			} catch (error) {
				console.error("Error unlinking partner:", error);
				alert("Error unlinking partner: " + error.message);
			}
		}

		function showLinkPartnerModal() {
			document.getElementById("linkPartnerModal").classList.remove("hidden");
			loadAvailablePartners();
		}

		async function loadAvailablePartners() {
			const auth = new AuthManager();
			const token = auth.getToken();
			const select = document.getElementById("partnerSelect");

			// Clear existing options except the first one
			select.innerHTML = '<option value="">Choose a partner...</option>';

			try {
				// Get available partners (approved partners not linked to any donor)
				const response = await fetch(
					`${auth.baseUrl}/api/auth/partners/available`,
					{
						headers: { Authorization: `Bearer ${token}` },
					}
				);

				if (!response.ok) {
					throw new Error("Failed to load partners");
				}

				const result = await response.json();
				const availablePartners = result.data || result;

				if (availablePartners.length === 0) {
					select.innerHTML +=
						'<option value="" disabled>No available partners</option>';
					return;
				}

				// Add partners to dropdown
				availablePartners.forEach((partner) => {
					const option = document.createElement("option");
					option.value = partner.id;
					option.textContent = `${partner.name} (${partner.email})`;
					select.appendChild(option);
				});
			} catch (error) {
				console.error("Error loading available partners:", error);
				select.innerHTML +=
					'<option value="" disabled>Error loading partners</option>';
			}
		}

		function hideLinkPartnerModal() {
			document.getElementById("linkPartnerModal").classList.add("hidden");
			document.getElementById("linkPartnerForm").reset();
			document.getElementById("partnerSelect").innerHTML =
				'<option value="">Choose a partner...</option>';
		}

		// Handle link partner form submission
		document
			.getElementById("linkPartnerForm")
			.addEventListener("submit", async function (e) {
				e.preventDefault();

				const partnerId = document.getElementById("partnerSelect").value;

				if (!partnerId) {
					alert("Please select a partner organization");
					return;
				}

				const auth = new AuthManager();
				const token = auth.getToken();

				try {
					const response = await fetch(
						`${auth.baseUrl}/api/auth/partner/${partnerId}/link-donor/${currentUser.id}`,
						{
							method: "POST",
							headers: { Authorization: `Bearer ${token}` },
						}
					);

					if (!response.ok) {
						const errorData = await response.json();
						throw new Error(errorData.message || "Failed to link partner");
					}

					alert("Partner linked successfully");
					hideLinkPartnerModal();
					loadMyPartners(); // Refresh the list
				} catch (error) {
					console.error("Error linking partner:", error);
					alert("Error linking partner: " + error.message);
				}
			});

		function loadMyDonor() {
			const donorSection = document.getElementById("donorInfo");
			donorSection.innerHTML =
				"<p class='text-gray-600'>Loading donor information...</p>";

			fetch("/api/auth/me/donor", {
				method: "GET",
				headers: {
					Authorization: `Bearer ${authManager.getToken()}`,
					"Content-Type": "application/json",
				},
			})
				.then((response) => {
					if (!response.ok) {
						throw new Error(`HTTP error! status: ${response.status}`);
					}
					return response.json();
				})
				.then((data) => {
					const donor = data.data;
					if (donor) {
						donorSection.innerHTML = `
                <div class="bg-white rounded-lg shadow p-6">
                  <h3 class="text-lg font-semibold text-gray-900 mb-4">My Donor</h3>
                  <div class="space-y-3">
                    <div class="flex justify-between">
                      <span class="text-gray-600">Name:</span>
                      <span class="font-medium">${donor.firstName} ${donor.lastName
							}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600">Email:</span>
                      <span class="font-medium">${donor.email}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600">Organization:</span>
                      <span class="font-medium">${donor.organization || "N/A"
							}</span>
                    </div>
                    <div class="flex justify-between">
                      <span class="text-gray-600">Phone:</span>
                      <span class="font-medium">${donor.phone || "N/A"}</span>
                    </div>
                  </div>
                </div>
              `;
					} else {
						donorSection.innerHTML = `
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                  <p class="text-yellow-800">You are not linked to any donor yet.</p>
                </div>
              `;
					}
				})
				.catch((error) => {
					console.error("Error loading donor:", error);
					donorSection.innerHTML = `
              <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-red-800">Error loading donor information. Please try again.</p>
              </div>
            `;
				});
		}

		function logout() {
			const auth = new AuthManager();
			auth.logout();
			window.location.href = "index.html";
		}
	</script>
</body>

</html>