<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RMNCAH Priorities</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Tailwind CSS (with custom config using inline script) -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#1e40af", // Custom Blue
              secondary: "#f59e0b", // Custom Amber
              accent: "#10b981", // Custom Green
              dark: "#1f2937", // Gray-800
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="styles/main.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
      integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css"
      rel="stylesheet"
    />
    <!-- Alpine.js -->
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <!-- Mapbox CSS -->
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css"
      rel="stylesheet"
    />
    <!-- Mapbox JS -->
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Authentication utilities -->
    <script type="module">
      import { BASE_URL } from "./config.js";
      window.BASE_URL = BASE_URL;
    </script>
    <script src="auth.js"></script>

    <!-- Optional: Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#272E28",
              secondary: "#f59e0b",
              accent: "#00474C",
              button: "#14B04C",
              button_two: "#3482FF",
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <style>
      .fade-slide-enter {
        opacity: 0;
        transform: translateY(20px);
      }

      .fade-slide-enter-active {
        opacity: 1;
        transform: translateY(0);
        transition: all 0.4s ease;
      }

      .fade-slide-leave {
        opacity: 1;
        transform: translateY(0);
      }

      .fade-slide-leave-active {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
      }
    </style>
  </head>

  <body class="text-gray-800">
    <div
      data-twe-modal-init
      class="fixed left-0 top-0 backdrop-blur-md z-[1055] hidden h-full w-full overflow-y-auto overflow-x-hidden outline-none"
      id="createNewProject"
      tabindex="-1"
      aria-labelledby="createNewProjectTitle"
      aria-modal="true"
      role="dialog"
    >
      <div
        data-twe-modal-dialog-ref
        class="pointer-events-none relative flex min-h-[calc(100%-1rem)] w-auto translate-y-[-50px] items-center opacity-0 transition-all duration-300 ease-in-out min-[576px]:mx-auto min-[576px]:mt-7 min-[576px]:max-w-[500px] min-[992px]:max-w-[800px] min-[1200px]:max-w-[1140px]"
      >
        <div
          class="relative flex flex-col w-full text-current bg-white border-none rounded-md outline-none pointer-events-auto bg-clip-padding shadow-4"
        >
          <div
            class="flex items-center justify-between flex-shrink-0 p-4 border-b-2 rounded-t-md border-neutral-100"
          >
            <!-- Modal title -->
            <h5
              class="text-xl font-light uppercase leading-normal text-surface"
              id="createNewProjectTitle"
            >
              New Project
            </h5>
            <!-- Close button -->
            <button
              type="button"
              class="box-content border-none rounded-none text-neutral-500 hover:text-neutral-800 hover:no-underline focus:text-neutral-800 focus:opacity-100 focus:shadow-none focus:outline-none"
              data-twe-modal-dismiss
              aria-label="Close"
            >
              <span class="[&>svg]:h-6 [&>svg]:w-6">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </span>
            </button>
          </div>

          <!-- Modal body -->
          <div class="relative p-4">
            <form id="newProjectForm">
              <div class="grid grid-cols-2 gap-4 lg:grid-cols-4">
                <!-- Map Picker for Location -->
                <div class="col-span-2 lg:col-span-4">
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Pick Project Locations on Map</label
                  >
                  <div class="text-xs text-gray-600 mb-2">
                    Search for a location or click on the map to select multiple
                    project coordinates.
                  </div>
                  <div
                    id="newProjectMap"
                    style="
                      height: 400px;
                      width: 100%;
                      border-radius: 8px;
                      margin-bottom: 8px;
                      border: 1px solid #e5e7eb;
                      background-color: #f3f4f6;
                      position: relative;
                      overflow: hidden;
                    "
                  ></div>
                  <div id="locationInputs">
                    <!-- Hidden inputs for locations will be added here by JS -->
                  </div>
                  <div
                    class="text-sm text-gray-700 mt-2 p-2 bg-gray-50 rounded"
                  >
                    <strong>Selected Locations:</strong>
                    <ul
                      id="selectedLocations"
                      class="list-disc list-inside mt-1"
                    >
                      <li class="text-gray-500">No locations selected yet</li>
                    </ul>
                  </div>
                </div>
                <!-- Title -->
                <div>
                  <label
                    for="title"
                    class="block text-sm font-medium text-gray-700"
                    >Title *</label
                  >
                  <input
                    required
                    type="text"
                    id="title"
                    name="title"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>

                <!-- Project Theme -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-3"
                    >Project Theme *</label
                  >

                  <!-- Select All Option -->
                  <div class="mb-4">
                    <label class="inline-flex items-center cursor-pointer">
                      <input
                        type="checkbox"
                        id="theme_select_all"
                        class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                      />
                      <span class="ml-2 text-sm font-medium text-gray-700"
                        >Select All Themes</span
                      >
                    </label>
                  </div>

                  <!-- Theme Grid -->
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <!-- Gender Based Violence -->
                    <div class="theme-card relative">
                      <label
                        class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 hover:bg-indigo-50 transition-all duration-200"
                      >
                        <input
                          type="checkbox"
                          name="theme[]"
                          value="GBV"
                          class="theme-checkbox h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                        />
                        <div class="ml-3 flex items-center flex-1">
                          <div
                            class="flex-shrink-0 w-8 h-8 bg-red-100 rounded-full flex items-center justify-center"
                          >
                            <i
                              class="fas fa-shield-alt text-red-600 text-sm"
                            ></i>
                          </div>
                          <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">
                              Gender Based Violence
                            </div>
                            <div class="text-xs text-gray-500">
                              GBV prevention & support
                            </div>
                          </div>
                        </div>
                      </label>
                    </div>

                    <!-- Adolescent and Young People Sexual and Reproductive Health -->
                    <div class="theme-card relative">
                      <label
                        class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 hover:bg-indigo-50 transition-all duration-200"
                      >
                        <input
                          type="checkbox"
                          name="theme[]"
                          value="AYPSRH"
                          class="theme-checkbox h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                        />
                        <div class="ml-3 flex items-center flex-1">
                          <div
                            class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center"
                          >
                            <i class="fas fa-heart text-blue-600 text-sm"></i>
                          </div>
                          <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">
                              AYP Sexual & Reproductive Health
                            </div>
                            <div class="text-xs text-gray-500">
                              Adolescent health services
                            </div>
                          </div>
                        </div>
                      </label>
                    </div>

                    <!-- Maternal and Newborn Health -->
                    <div class="theme-card relative">
                      <label
                        class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 hover:bg-indigo-50 transition-all duration-200"
                      >
                        <input
                          type="checkbox"
                          name="theme[]"
                          value="MNH"
                          class="theme-checkbox h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                        />
                        <div class="ml-3 flex items-center flex-1">
                          <div
                            class="flex-shrink-0 w-8 h-8 bg-pink-100 rounded-full flex items-center justify-center"
                          >
                            <i class="fas fa-baby text-pink-600 text-sm"></i>
                          </div>
                          <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">
                              Maternal & Newborn Health
                            </div>
                            <div class="text-xs text-gray-500">
                              Maternity care & newborn support
                            </div>
                          </div>
                        </div>
                      </label>
                    </div>

                    <!-- Family Planning -->
                    <div class="theme-card relative">
                      <label
                        class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 hover:bg-indigo-50 transition-all duration-200"
                      >
                        <input
                          type="checkbox"
                          name="theme[]"
                          value="FP"
                          class="theme-checkbox h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                        />
                        <div class="ml-3 flex items-center flex-1">
                          <div
                            class="flex-shrink-0 w-8 h-8 bg-green-100 rounded-full flex items-center justify-center"
                          >
                            <i class="fas fa-users text-green-600 text-sm"></i>
                          </div>
                          <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">
                              Family Planning
                            </div>
                            <div class="text-xs text-gray-500">
                              Contraception & family services
                            </div>
                          </div>
                        </div>
                      </label>
                    </div>

                    <!-- Child Health -->
                    <div class="theme-card relative">
                      <label
                        class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 hover:bg-indigo-50 transition-all duration-200"
                      >
                        <input
                          type="checkbox"
                          name="theme[]"
                          value="CH"
                          class="theme-checkbox h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                        />
                        <div class="ml-3 flex items-center flex-1">
                          <div
                            class="flex-shrink-0 w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center"
                          >
                            <i class="fas fa-child text-purple-600 text-sm"></i>
                          </div>
                          <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">
                              Child Health
                            </div>
                            <div class="text-xs text-gray-500">
                              Pediatric care & development
                            </div>
                          </div>
                        </div>
                      </label>
                    </div>

                    <!-- Adolescent Health -->
                    <div class="theme-card relative">
                      <label
                        class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 hover:bg-indigo-50 transition-all duration-200"
                      >
                        <input
                          type="checkbox"
                          name="theme[]"
                          value="AH"
                          class="theme-checkbox h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                        />
                        <div class="ml-3 flex items-center flex-1">
                          <div
                            class="flex-shrink-0 w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center"
                          >
                            <i
                              class="fas fa-user-graduate text-orange-600 text-sm"
                            ></i>
                          </div>
                          <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">
                              Adolescent Health
                            </div>
                            <div class="text-xs text-gray-500">
                              Teen health & wellness
                            </div>
                          </div>
                        </div>
                      </label>
                    </div>
                  </div>

                  <!-- Selected Themes Counter -->
                  <div class="mt-3 text-xs text-gray-500">
                    <span id="selected-themes-count">0</span> theme(s) selected
                  </div>
                </div>

                <!-- Project Category -->
                <div>
                  <label
                    for="category"
                    class="block text-sm font-medium text-gray-700"
                    >Project Category *</label
                  >
                  <select
                    id="category"
                    name="category"
                    class="block w-full p-2 mt-1 text-black bg-white border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  >
                    <option value="">Select Category</option>
                    <option value="IMPLEMENTING">Implementing Project</option>
                    <option value="RESEARCH">Research Project</option>
                  </select>
                </div>
                <div>
                  <label
                    for="starttime_period"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Start *
                  </label>
                  <input
                    required
                    type="date"
                    id="starttime_period"
                    name="start_date"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="endtime_period"
                    class="block text-sm font-medium text-gray-700"
                    >End *</label
                  >
                  <input
                    type="date"
                    id="endtime_period"
                    name="end_date"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <!-- Activity Type -->
                <div class="col-span-2 md:col-span-4">
                  <label
                    for="activity_type"
                    class="block text-sm font-medium text-gray-700"
                    >Activity Type (Description) *
                  </label>
                  <textarea
                    required
                    id="activity_type"
                    name="activity_type"
                    rows="3"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  ></textarea>
                </div>

                <!-- County and Sub-county fields removed (not required) -->

                <!-- Contact Person -->
                <div>
                  <label
                    for="contact_person"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Contact Person Name *
                  </label>
                  <input
                    required
                    type="text"
                    id="contact_person"
                    name="contact_person_name"
                    placeholder="Name"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="contact_person"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Contact Person Role *
                  </label>
                  <input
                    required
                    type="text"
                    id="contact_person"
                    name="contact_person_role"
                    placeholder="Role"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="contact_person"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Contact Person Email *
                  </label>
                  <input
                    required
                    type="email"
                    id="contact_person"
                    name="contact_person_mail"
                    placeholder="Email"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="budget"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Budget in KES
                  </label>
                  <input
                    required
                    type="number"
                    id="budget"
                    name="budget"
                    placeholder="amount"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>

                <!-- Gaps -->
                <div class="col-span-2 lg:col-span-4">
                  <label
                    for="gaps"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Objectives *
                  </label>
                  <textarea
                    required
                    id="gaps"
                    name="gaps"
                    rows="3"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  ></textarea>
                </div>
              </div>

              <!-- Button -->
              <div class="mt-3">
                <button
                  type="submit"
                  class="inline-flex justify-center w-full px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                  Submit Project
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="" id="nav-placeholder"></div>

    <section class="relative z-0 overflow-hidden" id="top">
      <div class="w-full overflow-hidden">
        <div
          x-data="{
						activeSlide: 0,
						media: [
						{ type: 'image', src: 'resources/images/main-1.jpg' },
						{ type: 'image', src: 'resources/images/main-2.jpg' },
						{ type: 'image', src: 'resources/images/main-3.jpg' }
						]
					}"
          x-init="setInterval(() => { activeSlide = (activeSlide + 1) % media.length }, 7000)"
          class="relative w-full min-h-[75vh] md:h-[50vh] flex flex-col justify-end"
        >
          <!-- Background Image Carousel with Zoom + Fade -->
          <template x-for="(item, index) in media" :key="index">
            <div
              class="absolute inset-0 transition-all duration-1000 ease-in-out overflow-hidden"
              :class="{
										'opacity-100 z-0': activeSlide === index,
										'opacity-0 z-0 pointer-events-none': activeSlide !== index
									}"
            >
              <img
                :src="item.src"
                alt="Slide Image"
                class="w-full h-full object-cover object-center transition-transform duration-[7000ms] ease-[cubic-bezier(0.4,0,0.2,1)]"
                :class="activeSlide === index ? 'scale-105' : 'scale-100'"
              />
            </div>
          </template>

          <!-- Overlay -->
          <div class="absolute inset-0 bg-black bg-opacity-50 z-10"></div>

          <!-- Bottom Content Section -->
          <div class="relative z-20 w-full pt-16 sm:pt-0">
            <div class="mx-4 md:mx-8 text-white px-4">
              <a
                href="#"
                class="text-xs font-semibold uppercase tracking-wide mb-2 block"
              >
                Ministry of Health
              </a>
              <h1 class="text-xl sm:text-4xl font-semibold mb-4">
                <span class="tracking-wide">RMNCAH</span> Priority Projects
              </h1>
              <p class="text-sm sm:text-base mb-6 max-w-4xl">
                The projects listed here are in line with RMNCAH priorities
                identified by the Ministry of Health.
              </p>
            </div>

            <!-- Search and Stats Section -->
            <div
              class="backdrop-blur-md bg-black/30 mx-8 rounded-t-2xl border-t border-black/20"
            >
              <div
                class="px-4 py-4 flex flex-col items-center justify-between gap-4"
              >
                <!-- Icon Buttons / Stats -->
                <div
                  class="flex justify-between text-white text-xl lg:text-3xl w-full flex-wrap text-center gap-y-6"
                >
                  <div class="flex flex-col items-center w-1/2 sm:w-auto">
                    <i class="fad fa-tasks text-lg lg:text-2xl"></i>
                    <div class="mt-2">
                      <span
                        id="totalProjectsCount"
                        class="font-bold tracking-wider"
                      >
                        8
                      </span>
                      <span class="font-thin">Projects</span>
                    </div>
                  </div>
                  <div class="flex flex-col items-center w-1/2 sm:w-auto">
                    <i class="fad fa-map-marked-alt text-lg lg:text-2xl"></i>
                    <div class="mt-2">
                      <span
                        id="totalCountiesCount"
                        class="font-bold tracking-wider"
                        >7</span
                      >
                      <span class="font-thin">Counties</span>
                    </div>
                  </div>
                  <div class="flex flex-col items-center w-1/2 sm:w-auto">
                    <i class="fad fa-map-marker-alt text-lg lg:text-2xl"></i>
                    <div class="mt-2">
                      <span
                        id="totalStakeholdersCount"
                        class="font-bold tracking-wider"
                        >10</span
                      >
                      <span class="font-thin">Locations</span>
                    </div>
                  </div>
                  <div class="flex flex-col items-center w-1/2 sm:w-auto">
                    <i class="fad fa-coins text-lg lg:text-2xl"></i>
                    <div class="mt-2">
                      <span class="font-bold tracking-wider">970.24</span>
                      <span class="font-thin">M</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- end bottom section -->
        </div>
      </div>
    </section>
    <section class="p-4 lg:px-10 md:p-8">
      <div id="localMap" class="h-[450px] sm:h-[45vh] z-0 w-full"></div>
    </section>
    <section class="">
      <div class="p-4 lg:px-10 md:p-8 px-4 py-12 sm:px-6 lg:px-8">
        <!-- Status Filter Buttons -->
        <div class="grid grid-cols-1 gap-8 md:grid-cols-5 lg:grid-cols-7">
          <!-- Sticky Filter Sidebar (Right Side) -->
          <div
            class="lg:sticky p-6 bg-white rounded-lg shadow-md md:col-span-2 lg:col-span-2 fade fade-right h-fit top-6"
          >
            <h2
              class="mb-2 -mt-10 text-sm font-semibold text-left text-gray-800 transform rounded-xl"
            >
              <i
                class="p-2 text-black bg-white rounded-sm shadow fas fa-filter"
              ></i>
            </h2>

            <div class="flex flex-col gap-5">
              <!-- Search -->
              <div class="relative w-full">
                <label for="searchInput" class="sr-only"
                  >Search by name...</label
                >
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search by name..."
                  class="block w-full py-2 pl-10 pr-4 text-base text-gray-900 placeholder-gray-500 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
                <div
                  class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"
                >
                  <i class="text-gray-400 fas fa-search"></i>
                </div>
              </div>

              <!-- Sort By -->
              <div class="flex flex-col gap-2">
                <label
                  for="sortSelect"
                  class="text-sm font-medium text-gray-700"
                  >Sort By County:</label
                >
                <select
                  id="sortSelect"
                  class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="name">Name (A-Z)</option>
                  <option value="date">Date (Newest First)</option>
                </select>
              </div>

              <!-- Sort By Theme -->
              <div class="flex flex-col gap-2">
                <label
                  for="sortSelect"
                  class="text-sm font-medium text-gray-700"
                  >Thematic Areas :</label
                >
                <select
                  id="sortSelect"
                  class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="name">Name (A-Z)</option>
                  <option value="date">Date (Newest First)</option>
                </select>
              </div>

              <!-- Sort By Theme -->
              <div class="flex flex-col gap-2">
                <label for="status" class="text-sm font-medium text-gray-700"
                  >Priority Level:</label
                >
                <select
                  autocomplete="off"
                  id="status"
                  class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  onchange=""
                >
                  <option value="all">Show All</option>
                  <option value="high">High</option>
                  <option value="medium">Medium</option>
                  <option value="low">low</option>
                </select>
              </div>

              <!-- Export Button -->
              <button
                onclick="exportCSV()"
                class="flex items-center justify-center px-5 py-2 mt-6 text-base font-semibold text-white transition duration-200 bg-indigo-600 rounded-lg shadow hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
              >
                <i class="mr-2 fas fa-file-csv"></i> Export Data
              </button>
            </div>
          </div>
          <!-- Main Content Area -->
          <div class="flex flex-col md:col-span-3 fade fade-left lg:col-span-5">
            <!-- Create New Project Button -->
            <div class="mb-4">
              <button
                data-twe-target="#createNewProject"
                data-twe-toggle="modal"
                onclick="setTimeout(initializeNewProjectMap, 300)"
                class="flex items-center justify-center px-6 py-3 text-base font-semibold text-white transition duration-200 bg-indigo-600 rounded-lg shadow hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
              >
                <i class="mr-2 fas fa-plus"></i> Create New Priority Project
              </button>
            </div>
            <div
              id="featuredProjectSection"
              class="px-6 py-5 bg-green-800/5 rounded-md"
            >
              <!-- Featured priority project will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </section>
    <!--Footer container-->
    <footer
      class="flex flex-col items-center text-center bg-white text-surface"
    >
      <div class="">
        <!-- Social media icons container -->
        <div class="flex items-center justify-center mb-6 space-x-2">
          <a
            href="#!"
            type="button"
            class="p-3 font-medium leading-normal uppercase transition duration-150 ease-in-out bg-transparent rounded-full text-surface hover:bg-neutral-100 focus:outline-none focus:ring-0"
            data-twe-ripple-init
          >
            <span class="mx-auto [&>svg]:h-4 [&>svg]:w-4">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="currentColor"
                viewBox="0 0 512 512"
              >
                <!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc. -->
                <path
                  d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"
                />
              </svg>
            </span>
          </a>

          <a
            href="#!"
            type="button"
            class="p-3 font-medium leading-normal uppercase transition duration-150 ease-in-out bg-transparent rounded-full text-surface hover:bg-neutral-100 focus:outline-none focus:ring-0"
            data-twe-ripple-init
          >
            <i class="fab fa-facebook-f"></i>
          </a>

          <a
            href="#!"
            type="button"
            class="p-3 font-medium leading-normal uppercase transition duration-150 ease-in-out bg-transparent rounded-full text-surface hover:bg-neutral-100 focus:outline-none focus:ring-0"
            data-twe-ripple-init
          >
            <span class="mx-auto [&>svg]:h-4 [&>svg]:w-4">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="currentColor"
                viewBox="0 0 448 512"
              >
                <!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc. -->
                <path
                  d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"
                />
              </svg>
            </span>
          </a>

          <a
            href="#!"
            type="button"
            class="p-3 font-medium leading-normal uppercase transition duration-150 ease-in-out bg-transparent rounded-full text-surface hover:bg-neutral-100 focus:outline-none focus:ring-0"
            data-twe-ripple-init
          >
            <span class="mx-auto [&>svg]:h-4 [&>svg]:w-4">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="currentColor"
                viewBox="0 0 448 512"
              >
                <!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc. -->
                <path
                  d="M100.3 448H7.4V148.9h92.9zM53.8 108.1C24.1 108.1 0 83.5 0 53.8a53.8 53.8 0 0 1 107.6 0c0 29.7-24.1 54.3-53.8 54.3zM447.9 448h-92.7V302.4c0-34.7-.7-79.2-48.3-79.2-48.3 0-55.7 37.7-55.7 76.7V448h-92.8V148.9h89.1v40.8h1.3c12.4-23.5 42.7-48.3 87.9-48.3 94 0 111.3 61.9 111.3 142.3V448z"
                />
              </svg>
            </span>
          </a>
        </div>
      </div>

      <!--Copyright section-->
      <div class="w-full p-4 text-xs text-center bg-black/5">
        © 2025 Copyright:
        <a href=""> RMNCAH Hub </a>
      </div>
    </footer>
    <!-- Removed script that sets localStorage with undefined 'data' to fix ReferenceError. This should only be set after login. -->
    <script src="styles/effects.js"></script>
    <script src="styles/loadNav.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tw-elements/js/tw-elements.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
    <script>
      let map;
      let projects = [];
      let filteredProjects = [];
      let sortBy = "name";
      let sortOrder = "asc";
      let currentPage = 1;
      const itemsPerPage = 5;
      let currentFilter = "all";
      let searchQuery = "";
      let dateRangeFrom = null;
      let dateRangeTo = null;

      const mapMarkers = [];
      let stores = {
        type: "FeatureCollection",
        features: [],
      };

      const bgColors = {
        active: "bg-green-50",
        pending: "bg-yellow-50",
        stalled: "bg-red-50",
        completed: "bg-cyan-100",
        default: "bg-white",
      };

      const statusBadge = (tag) => {
        return (
          {
            active: "bg-green-200 text-green-800",
            pending: "bg-yellow-200 text-yellow-800",
            stalled: "bg-red-200 text-red-800",
            completed: "bg-cyan-300 text-gray-800",
          }[tag] || "bg-gray-200 text-gray-800"
        );
      };

      // Set Mapbox access token globally
      mapboxgl.accessToken =
        "pk.eyJ1IjoibG9tb2dhbnRlY2giLCJhIjoiY2xzOTcyYXdlMDUxZDJsbXRnZGh2ZmpoYyJ9.sIWvONzgGPF2rtAcECsrJQ";

      document.addEventListener("DOMContentLoaded", function () {
        // Initialize Mapbox map
        map = new mapboxgl.Map({
          container: "localMap",
          style: "mapbox://styles/lomogantech/clsa1f16r00wt01qqbnf741n6",
          center: [37.9062, -0.0236],
          zoom: 6.3,
        });

        // Add zoom and rotation controls to the map
        map.addControl(new mapboxgl.NavigationControl(), "top-right");

        // Load projects after map is initialized
        map.on("load", () => {
          loadProjectsForMap();
        });

        document
          .getElementById("searchInput")
          .addEventListener("input", (e) => {
            searchQuery = e.target.value.trim().toLowerCase();
            currentPage = 1;
            highlightMarkers(currentFilter);
          });

        document.getElementById("dateFrom").addEventListener("change", (e) => {
          dateRangeFrom = e.target.value ? new Date(e.target.value) : null;
          currentPage = 1;
          highlightMarkers(currentFilter);
        });

        document.getElementById("dateTo").addEventListener("change", (e) => {
          dateRangeTo = e.target.value ? new Date(e.target.value) : null;
          currentPage = 1;
          highlightMarkers(currentFilter);
        });

        document
          .getElementById("sortSelect")
          .addEventListener("change", (e) => {
            sortProjects(e.target.value);
          });
      });

      // Load projects and add to map
      async function loadProjectsForMap() {
        try {
          const response = await fetch(
            `${window.BASE_URL}/api/projects/with-coordinates`,
            {
              headers: {
                Authorization: `Bearer ${authManager.getToken()}`,
              },
            }
          );

          if (response.ok) {
            const data = await response.json();
            console.log("Raw API response (with-coordinates):", data);
            // Handle API response structure: { status: 200, data: [...], message: "..." }
            let projectsData = [];
            if (data.status === 200 && data.data) {
              projectsData = Array.isArray(data.data) ? data.data : [];
            } else if (Array.isArray(data)) {
              projectsData = data;
            }

            console.log("Loaded projects for map:", projectsData.length);
            console.log("Projects data (with coordinates):", projectsData);

            // Log each project's coordinates
            projectsData.forEach((project, idx) => {
              console.log(`Map Project ${idx + 1}:`, {
                name: project.projectName || project.name,
                latitude: project.latitude,
                longitude: project.longitude,
                hasCoordinates: !!(project.latitude && project.longitude),
              });
            });

            // ONLY add markers to map - don't overwrite the main projects array
            // The main projects array is managed by loadProjects() which includes ALL projects
            console.log(
              "Adding markers to map for",
              projectsData.length,
              "projects"
            );
            addMarkersToMap(projectsData);
          } else {
            console.warn("API response not OK, loading sample projects");
            loadSampleProjects();
          }
        } catch (error) {
          console.error("Error loading projects for map:", error);
          // Use sample data for demo
          loadSampleProjects();
        }
      }

      // Load sample projects for demo
      function loadSampleProjects() {
        const sampleProjects = [
          {
            id: 1,
            title: "Emergency Maternal Health Response Program",
            projectCategory: "PRIORITY",
            projectTheme: "MNH",
            latitude: -1.263,
            longitude: 36.8065,
            status: "active",
            county: "Nairobi",
            partner: "Ministry of Health - Nairobi County",
            budget: 5000000,
            objectives:
              "Reduce maternal mortality through emergency response and capacity building in Nairobi County",
            endDate: "2024-12-31",
          },
          {
            id: 2,
            title: "Adolescent Sexual Reproductive Health Initiative",
            projectCategory: "PRIORITY",
            projectTheme: "AYPSRH",
            latitude: -1.2833,
            longitude: 36.8167,
            status: "active",
            county: "Nairobi",
            partner: "UNICEF Kenya",
            budget: 3500000,
            objectives:
              "Comprehensive SRH education and services for adolescents aged 10-19 in urban slums",
            endDate: "2025-01-31",
          },
          {
            id: 3,
            title: "Modern Contraceptive Access Program",
            projectCategory: "PRIORITY",
            projectTheme: "FP",
            latitude: -1.0333,
            longitude: 37.0833,
            status: "active",
            county: "Kiambu",
            partner: "USAID Kenya",
            budget: 4200000,
            objectives:
              "Increase modern contraceptive prevalence rate by 15% through community distribution",
            endDate: "2024-11-30",
          },
          {
            id: 4,
            title: "Integrated Child Health and Nutrition Program",
            projectCategory: "PRIORITY",
            projectTheme: "CH",
            latitude: -0.3031,
            longitude: 36.08,
            status: "active",
            county: "Nakuru",
            partner: "World Health Organization",
            budget: 6100000,
            objectives:
              "Reduce child malnutrition and improve immunization coverage in rural areas",
            endDate: "2024-12-15",
          },
          {
            id: 5,
            title: "GBV Prevention and Response Network",
            projectCategory: "PRIORITY",
            projectTheme: "GBV",
            latitude: -1.2833,
            longitude: 36.8167,
            status: "active",
            county: "Nairobi",
            partner: "Amref Health Africa",
            budget: 2800000,
            objectives:
              "Establish comprehensive GBV prevention and survivor support systems",
            endDate: "2025-03-31",
          },
        ];
        projects = sampleProjects;
        addMarkersToMap(sampleProjects);
        highlightMarkers("all");
        updateFeaturedProject(sampleProjects);
      }

      // Update featured project section
      function updateFeaturedProject(projectsData) {
        const featuredSection = document.getElementById(
          "featuredProjectSection"
        );
        if (!featuredSection) return;

        // Find the first priority project or any project if no priority projects exist
        const priorityProject =
          projectsData.find((p) => p.projectCategory === "PRIORITY") ||
          projectsData[0];

        if (!priorityProject) {
          featuredSection.innerHTML = `
            <h4 class="text-lg font-semibold text-gray-800 mb-2">
              No Projects Available
            </h4>
            <p class="text-sm text-gray-700 leading-relaxed mb-3">
              No projects are currently available. Check back later or create a new project.
            </p>
          `;
          return;
        }

        const color = getStatusColor(priorityProject.status);
        const statusBg = statusBadge(priorityProject.status?.toLowerCase());
        const projectName =
          priorityProject.projectName ||
          priorityProject.title ||
          "Untitled Project";
        const description =
          priorityProject.description ||
          priorityProject.objectives ||
          "This project currently has no description provided.";
        const location =
          priorityProject.county ||
          priorityProject.region ||
          "an unspecified region";
        const partner = priorityProject.partner || "partners to be announced";
        const budget = priorityProject.budget
          ? "KES " + Number(priorityProject.budget).toLocaleString()
          : "N/A";
        const endDate = priorityProject.endDate
          ? new Date(priorityProject.endDate).toLocaleDateString()
          : "Not specified";

        featuredSection.innerHTML = `
          <div class="flex items-center gap-2 mb-2">
            <h4 class="text-lg font-semibold text-gray-800">${projectName}</h4>
            ${
              priorityProject.projectCategory === "PRIORITY"
                ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200"><i class="fas fa-star mr-1"></i>PRIORITY</span>'
                : ""
            }
          </div>

          <p class="text-sm text-gray-700 leading-relaxed mb-3">
            ${description}
          </p>

          <p class="text-sm text-gray-700 mb-2">
            Located in <strong>${location}</strong>, this project ${
          partner
            ? `is supported by <strong>${partner}</strong>`
            : "has partners to be announced"
        }
            with an estimated budget of <strong>${budget}</strong>.
          </p>

          <p class="text-sm text-gray-700 mb-2">
            Status: <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBg}">
              ${priorityProject.status || "Ongoing"}
            </span>
          </p>

          <p class="text-sm text-gray-700 mb-2">Due By: ${endDate}</p>

          <div class="flex gap-2 mt-3">
            <button onclick="focusMarker(${projectsData.indexOf(
              priorityProject
            )})" class="px-5 py-2 text-sm font-semibold text-white bg-blue-600 rounded hover:bg-blue-700 hover:scale-105 transition">
              Locate on Map
            </button>
            <button onclick="requestCollaboration(${
              priorityProject.id
            })" class="px-5 py-2 text-sm font-semibold text-white bg-green-600 rounded hover:bg-green-700 hover:scale-105 transition">
              Request Collaboration
            </button>
          </div>
        `;
      }

      // Add markers to Mapbox map (supports multiple locations per project)
      function addMarkersToMap(projectsData) {
        console.log(
          "addMarkersToMap called with",
          projectsData.length,
          "projects"
        );
        // Clear existing markers
        mapMarkers.forEach((marker) => marker.remove());
        mapMarkers.length = 0;

        // Add new markers
        projectsData.forEach((project, index) => {
          console.log(
            `Processing project ${index}:`,
            project.title || project.projectName,
            "coords:",
            project.latitude,
            project.longitude
          );
          // Determine location list: prefer project.locations array, fall back to single lat/lng
          const locs =
            Array.isArray(project.locations) && project.locations.length
              ? project.locations
              : project.latitude && project.longitude
              ? [{ latitude: project.latitude, longitude: project.longitude }]
              : [];

          console.log(`Project ${index} has ${locs.length} locations`);
          locs.forEach((loc, locIndex) => {
            const lat = loc.latitude;
            const lng = loc.longitude;
            console.log(`Location ${locIndex}: lat=${lat}, lng=${lng}`);
            if (!lat || !lng) {
              console.log("Skipping location due to missing coordinates");
              return;
            }

            // Create marker element
            const el = document.createElement("div");
            el.className = "marker";
            el.style.backgroundColor = getStatusColor(project.status);
            el.style.width = "30px";
            el.style.height = "30px";
            el.style.borderRadius = "50%";
            el.style.border = "2px solid white";
            el.style.cursor = "pointer";
            el.style.boxShadow = "0 2px 4px rgba(0,0,0,0.3)";

            // Create popup — include location-specific info when available
            const popupHtml = `
                <div style="padding: 10px; min-width: 200px;">
                  <h3 style="font-weight: bold; margin-bottom: 8px;">${
                    project.projectName || project.title || "Project"
                  }</h3>
                  <p style="margin: 4px 0;"><strong>Status:</strong> <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded ${statusBadge(
                    project.status?.toLowerCase()
                  )}">${project.status || "N/A"}</span></p>
                  <p style="margin: 4px 0;"><strong>Region/County:</strong> ${
                    loc.county ||
                    loc.region ||
                    project.region ||
                    project.county ||
                    "N/A"
                  }</p>
                  <p style="margin: 4px 0;"><strong>Budget:</strong> ${
                    project.budget || "N/A"
                  }</p>
                  <button onclick="viewProject(${
                    project.id
                  })" style="margin-top: 8px; padding: 6px 12px; background-color: #0ea5e9; color: white; border-radius: 6px; cursor: pointer; border: none;">View Details</button>
                </div>`;

            const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(popupHtml);

            // Create and add marker
            const marker = new mapboxgl.Marker(el)
              .setLngLat([lng, lat])
              .setPopup(popup)
              .addTo(map);

            // Attach data for other UI code that expects marker.data
            try {
              marker.data = Object.assign({}, project, {
                lat,
                lng,
                location: loc,
                locationIndex: locIndex,
              });
            } catch (e) {
              // ignore
            }

            // Add click event
            el.addEventListener("click", async () => {
              map.flyTo({ center: [lng, lat], zoom: 12 });

              // If county is missing, try to get it from coordinates
              if (!project.county && !project.region && (!loc || !loc.county)) {
                const countyName = await getCountyFromCoordinates(lng, lat);
                if (countyName) {
                  if (loc) loc.county = countyName;
                  else project.county = countyName;
                  const projectIndex = projects.indexOf(project);
                  if (projectIndex !== -1)
                    updateProjectAccordionItem(projectIndex);
                }
              }
            });

            mapMarkers.push(marker);
          });
        });
      }

      // Get county name from coordinates using Mapbox Geocoding API
      async function getCountyFromCoordinates(longitude, latitude) {
        try {
          const response = await fetch(
            `https://api.mapbox.com/geocoding/v5/mapbox.places/${longitude},${latitude}.json?types=region&access_token=${mapboxgl.accessToken}`
          );
          const data = await response.json();
          if (data.features && data.features.length > 0) {
            return data.features[0].text;
          }
        } catch (error) {
          console.error("Error getting county from coordinates:", error);
        }
        return null;
      }

      // Update a specific project accordion item
      function updateProjectAccordionItem(index) {
        const project = projects[index];
        const collapseDiv = document.getElementById(`collapse-${index}`);
        if (collapseDiv) {
          const statusBg = statusBadge(project.status?.toLowerCase());
          collapseDiv.innerHTML = `
            <p><strong>County:</strong> ${
              project.county || project.region || ""
            }</p>
            <p><strong>Budget:</strong> ${project.budget || ""}</p>
            <p><strong>Partner:</strong> ${project.partner || ""}</p>
            <p><strong>Status:</strong> 
                <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBg}">
                    ${project.status || ""}
                </span>
            </p>
            <button onclick="focusMarker(${index})" class="px-5 py-2 mt-3 text-sm font-semibold text-white transition bg-blue-600 rounded hover:bg-blue-700 hover:scale-105">
                Show on Map
            </button>
          `;
        }
      }

      // Get status color
      function getStatusColor(status) {
        const colors = {
          ACTIVE: "#22c55e",
          PENDING: "#eab308",
          STALLED: "#ef4444",
          COMPLETED: "#06b6d4",
        };
        return colors[status] || "#6b7280";
      }

      // Comes From DB
      function showProjectInfo(project) {
        const infoBox = document.getElementById("projectInfo");
        infoBox.classList.remove("hidden");

        const color = getStatusColor(project.status);
        const statusBg = statusBadge(project.status?.toLowerCase());

        infoBox.innerHTML = `
				<div class="px-6 py-5 mb-4 rounded-lg border-l-4 shadow-sm" 
					style="border-left-color: ${color}; background-color: ${color}10;">
					
					<h3 class="text-xl font-bold text-gray-800 mb-2">
						${project.name || project.projectName || "Unnamed Project"}
					</h3>
					
					<p class="text-sm text-gray-700 leading-relaxed mb-4">
						${project.description || "No detailed description provided for this project."}
					</p>

					<div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-2 text-sm text-gray-700">
						<p><strong>Region:</strong> ${
              project.region || project.county || "Not specified"
            }</p>
						<p><strong>Budget:</strong> ${
              project.budget
                ? "KES " + Number(project.budget).toLocaleString()
                : "N/A"
            }</p>
						<p><strong>Team:</strong> ${project.team || "Not specified"}</p>
						<p><strong>Participants:</strong> ${project.participants || "Not specified"}</p>
						<p><strong>Sponsor:</strong> ${project.sponsor || "Not specified"}</p>
						<p><strong>Start Date:</strong> ${
              project.start_date
                ? new Date(project.start_date).toLocaleDateString()
                : "Not specified"
            }</p>
						<p><strong>Status:</strong> 
							<span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBg}">
								${project.status || "Ongoing"}
							</span>
						</p>
					</div>

					<button onclick="focusMarker(${projects.findIndex((p) => p.id === project.id)})"
						class="mt-4 px-5 py-2 text-sm font-semibold text-white bg-blue-600 rounded hover:bg-blue-700 hover:scale-105 transition">
						Locate on Map
					</button>
				</div>
			`;
      }

      function focusMarker(index) {
        if (mapMarkers[index] && projects[index]) {
          const project = projects[index];
          map.flyTo({
            center: [project.longitude, project.latitude],
            zoom: 12,
          });
          mapMarkers[index].togglePopup();
          document
            .getElementById("localMap")
            .scrollIntoView({ behavior: "smooth" });
        }
      }

      function sortProjects(field) {
        if (sortBy === field) {
          sortOrder = sortOrder === "asc" ? "desc" : "asc";
        } else {
          sortBy = field;
          sortOrder = "asc";
        }
        currentPage = 1;
        highlightMarkers(currentFilter);
      }

      function highlightMarkers(tag) {
        currentFilter = tag;
        console.log("highlightMarkers called with tag:", tag);
        console.log("Total projects available:", projects.length);
        console.log("Projects:", projects);

        const accordion = document.getElementById("projectAccordion");
        const infoBox = document.getElementById("projectInfo");
        infoBox.classList.add("hidden");
        accordion.innerHTML = "";
        accordion.classList.remove("hidden");
        accordion.classList.add("opacity-0", "translate-y-4");

        let filteredProjects = projects.filter((project) => {
          if (tag !== "all" && project.status?.toLowerCase() !== tag)
            return false;
          if (
            searchQuery &&
            !project.projectName
              ?.toLowerCase()
              .includes(searchQuery.toLowerCase())
          )
            return false;
          if (
            dateRangeFrom &&
            new Date(project.startDate) < new Date(dateRangeFrom)
          )
            return false;
          if (
            dateRangeTo &&
            new Date(project.startDate) > new Date(dateRangeTo)
          )
            return false;
          return true;
        });

        console.log("Filtered projects count:", filteredProjects.length);
        console.log("Filtered projects:", filteredProjects);

        filteredProjects.sort((a, b) => {
          const aVal =
            sortBy === "name" ? a.projectName : new Date(a.startDate);
          const bVal =
            sortBy === "name" ? b.projectName : new Date(b.startDate);
          return sortOrder === "asc"
            ? aVal > bVal
              ? 1
              : -1
            : aVal < bVal
            ? 1
            : -1;
        });

        const totalPages = Math.ceil(filteredProjects.length / itemsPerPage);
        const paginated = filteredProjects.slice(
          (currentPage - 1) * itemsPerPage,
          currentPage * itemsPerPage
        );
        updatePaginationControls(totalPages);

        // Update marker visibility
        mapMarkers.forEach((marker, idx) => {
          const project = projects[idx];
          const isVisible = filteredProjects.includes(project);
          if (marker.getElement()) {
            marker.getElement().style.opacity = isVisible ? "1" : "0.2";
          }
        });

        setTimeout(
          () => accordion.classList.remove("opacity-0", "translate-y-4"),
          10
        );

        // ✅ New full-display design (no accordion)
        paginated.forEach((project, idx) => {
          const i = projects.indexOf(project);
          const color = getStatusColor(project.status);
          const bg =
            bgColors[project.status?.toLowerCase()] || bgColors.default;

          const item = document.createElement("div");
          item.className = `rounded-lg shadow-sm mb-4 border-l-4 ${bg}`;
          item.style.borderLeftColor = color;

          item.innerHTML = `
			<div class="px-6 py-5" style="background-color: ${color}10;">
				<div class="flex items-center gap-2 mb-2">
					<h4 class="text-lg font-semibold text-gray-800">${
            project.projectName || project.title || "Untitled Project"
          }</h4>
					${
            project.projectCategory === "PRIORITY"
              ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200"><i class="fas fa-star mr-1"></i>PRIORITY</span>'
              : ""
          }
				</div>
				
				<p class="text-sm text-gray-700 leading-relaxed mb-3">
					${
            project.description ||
            project.objectives ||
            "This project currently has no description provided."
          }
				</p>

				<p class="text-sm text-gray-700 mb-2">
					Located in <strong>${
            project.county || project.region || "an unspecified region"
          }</strong>,
					this project ${
            project.partner
              ? `is supported by <strong>${project.partner}</strong>`
              : "has partners to be announced"
          } 
					with an estimated budget of <strong>${
            project.budget
              ? "KES " + Number(project.budget).toLocaleString()
              : "N/A"
          }</strong>.
				</p>

				<p class="text-sm text-gray-700 mb-2">
					Status: <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge(
            project.status?.toLowerCase()
          )}">
						${project.status || "Ongoing"}
					</span>
				</p>

				<p class="text-sm text-gray-700 mb-2">
					Started on: ${
            project.startDate
              ? new Date(project.startDate).toLocaleDateString()
              : "Not specified"
          }
				</p>

				<div class="flex gap-2 mt-3">
					<button onclick="focusMarker(${i})" 
						class="px-5 py-2 text-sm font-semibold text-white bg-blue-600 rounded hover:bg-blue-700 hover:scale-105 transition">
						Locate on Map
					</button>
					<button onclick="requestCollaboration(${project.id})" 
						class="px-5 py-2 text-sm font-semibold text-white bg-green-600 rounded hover:bg-green-700 hover:scale-105 transition">
						<i class="fas fa-handshake mr-1"></i>Request Collaboration
					</button>
				</div>
			</div>
		`;

          accordion.appendChild(item);
        });
      }

      function updatePaginationControls(totalPages) {
        const container = document.getElementById("paginationControls");
        container.innerHTML = "";
        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          btn.className = `px-3 py-1 rounded ${
            i === currentPage
              ? "bg-blue-600 text-white"
              : "bg-gray-100 text-gray-800 hover:bg-gray-200"
          }`;
          btn.onclick = () => {
            currentPage = i;
            highlightMarkers(currentFilter);
          };
          container.appendChild(btn);
        }
      }

      function exportCSV() {
        const headers = [
          "Name",
          "Description",
          "Region",
          "Budget",
          "Status",
          "Start Date",
        ];
        const rows = projects
          .filter((p) => {
            if (
              searchQuery &&
              !p.projectName?.toLowerCase().includes(searchQuery.toLowerCase())
            )
              return false;
            const date = new Date(p.startDate);
            if (dateRangeFrom && date < dateRangeFrom) return false;
            if (dateRangeTo && date > dateRangeTo) return false;
            if (
              currentFilter !== "all" &&
              p.status?.toLowerCase() !== currentFilter
            )
              return false;
            return true;
          })
          .map((p) => [
            p.projectName || "",
            (p.description || "").replace(/,/g, ";"),
            p.region || p.county || "",
            p.budget || "",
            p.status || "",
            p.startDate ? new Date(p.startDate).toLocaleDateString() : "",
          ]);

        let csvContent = [headers.join(",")];
        rows.forEach((r) =>
          csvContent.push(r.map((val) => `"${val}"`).join(","))
        );

        const blob = new Blob([csvContent.join("\n")], { type: "text/csv" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `projects_${
          new Date().toISOString().split("T")[0]
        }.csv`;
        link.click();
      }

      // Initialize new project modal map
      let newProjectMap;
      let newProjectMarker;

      function initializeNewProjectMap() {
        if (newProjectMap) return; // Already initialized

        const container = document.getElementById("newProjectMap");
        if (!container) {
          console.warn("Map container not found");
          return;
        }

        try {
          console.log("Initializing new project map...");
          newProjectMap = new mapboxgl.Map({
            container: "newProjectMap",
            style: "mapbox://styles/mapbox/streets-v11",
            center: [37.9062, -0.0236], // Center on Kenya
            zoom: 6,
          });

          newProjectMap.addControl(new mapboxgl.NavigationControl());

          // Add click handler for location selection
          newProjectMap.on("click", async (e) => {
            const lng = e.lngLat.lng;
            const lat = e.lngLat.lat;

            // Update hidden inputs
            document.getElementById("project_latitude").value = lat;
            document.getElementById("project_longitude").value = lng;

            // Update display
            const latLngDisplay = document.getElementById("selectedLatLng");
            if (latLngDisplay) {
              latLngDisplay.textContent = `${lat.toFixed(6)}, ${lng.toFixed(
                6
              )}`;
            }

            // Get county from coordinates
            try {
              const county = await getCountyFromCoordinates(lng, lat);
              if (county) {
                document.getElementById("project_county").value = county;
                const countyDisplay = document.getElementById("selectedCounty");
                if (countyDisplay) {
                  countyDisplay.textContent = county;
                }
              }
            } catch (error) {
              console.error("Error getting county:", error);
            }

            // Update or create marker
            if (newProjectMarker) {
              newProjectMarker.setLngLat([lng, lat]);
            } else {
              const el = document.createElement("div");
              el.style.backgroundColor = "#3b82f6";
              el.style.width = "20px";
              el.style.height = "20px";
              el.style.borderRadius = "50%";
              el.style.border = "2px solid white";
              el.style.cursor = "pointer";

              newProjectMarker = new mapboxgl.Marker(el)
                .setLngLat([lng, lat])
                .addTo(newProjectMap);
            }
          });

          console.log("New project map initialized successfully");
        } catch (error) {
          console.error("Error initializing new project map:", error);
        }
      }

      // Handle theme selection
      document.addEventListener("DOMContentLoaded", function () {
        // Theme selection logic
        const themeSelectAll = document.getElementById("theme_select_all");
        const themeCheckboxes = document.querySelectorAll(
          'input[name="theme[]"]'
        );
        const selectedThemesCount = document.getElementById(
          "selected-themes-count"
        );

        function updateThemeCounter() {
          const checkedCount = document.querySelectorAll(
            'input[name="theme[]"]:checked'
          ).length;
          selectedThemesCount.textContent = checkedCount;
        }

        // Handle "Select All" checkbox
        if (themeSelectAll) {
          themeSelectAll.addEventListener("change", function () {
            themeCheckboxes.forEach((checkbox) => {
              checkbox.checked = this.checked;
            });
            updateThemeCounter();
          });
        }

        // Handle individual theme checkboxes
        themeCheckboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", function () {
            const allChecked = Array.from(themeCheckboxes).every(
              (cb) => cb.checked
            );
            const noneChecked = Array.from(themeCheckboxes).every(
              (cb) => !cb.checked
            );

            if (themeSelectAll) {
              themeSelectAll.checked = allChecked;
              themeSelectAll.indeterminate = !allChecked && !noneChecked;
            }

            updateThemeCounter();
          });
        });

        // Initialize counter
        updateThemeCounter();
      });

      // Handle new project form submission
      document
        .getElementById("newProjectForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          // Validate required fields by checking form data directly
          const form = e.target;
          const formDataObj = new FormData(form);

          // Collect multiple themes
          const selectedThemes = formDataObj.getAll("theme[]");

          const requiredFormFields = [
            { field: "title", label: "Title" },
            { field: "start_date", label: "Start Date" },
            { field: "activity_type", label: "Activity Type" },
            { field: "contact_person_name", label: "Contact Person Name" },
            { field: "contact_person_role", label: "Contact Person Role" },
            { field: "contact_person_mail", label: "Contact Person Email" },
            { field: "gaps", label: "Objectives" },
            { field: "budget", label: "Budget" },
            { field: "category", label: "Project Category" },
          ];

          const missingFields = requiredFormFields.filter((fieldObj) => {
            const value = formDataObj.get(fieldObj.field);
            return !value || value.trim() === "";
          });

          // Check for at least one theme
          if (selectedThemes.length === 0) {
            missingFields.push({
              field: "theme",
              label: "At least one Project Theme",
            });
          }

          // Check for at least one location (latitude/longitude from map selection)
          const latitude = document.getElementById("project_latitude")?.value;
          const longitude = document.getElementById("project_longitude")?.value;
          if (!latitude || !longitude) {
            missingFields.push({
              field: "location",
              label: "Project Location (click on map)",
            });
          }

          if (missingFields.length > 0) {
            const missingLabels = missingFields.map((f) => f.label);
            alert(
              `Please fill in all required fields:\n• ${missingLabels.join(
                "\n• "
              )}`
            );

            // Focus on the first missing field
            const firstMissingField = form.querySelector(
              `[name="${missingFields[0].field}"]`
            );
            if (firstMissingField) {
              firstMissingField.focus();
              firstMissingField.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });
            }
            return;
          }

          // Get location data
          const county = document.getElementById("project_county").value;
          const subCounty = document.getElementById("project_subcounty").value;

          // Prepare form data according to API documentation
          const formData = {
            partner: "TBD", // This should come from user's organization
            title: formDataObj.get("title"),
            themes: selectedThemes,
            projectCategory: formDataObj.get("category"),
            startDate: formDataObj.get("start_date"),
            endDate: formDataObj.get("end_date") || null,
            activityType: formDataObj.get("activity_type"),
            locations: [
              {
                county: county,
                subCounty: subCounty || null,
                latitude: parseFloat(latitude),
                longitude: parseFloat(longitude),
                mapsAddress: `${county}${
                  subCounty ? ", " + subCounty : ""
                }, Kenya`.trim(),
              },
            ],
            contactPersonName: formDataObj.get("contact_person_name"),
            contactPersonRole: formDataObj.get("contact_person_role"),
            contactPersonEmail: formDataObj.get("contact_person_mail"),
            objectives: formDataObj.get("gaps"),
            budget: parseFloat(formDataObj.get("budget")),
            isPriority: true,
          };

          try {
            // Get current user to set partner
            const user = await authManager.getCurrentUser();
            console.log("Current user data:", user);

            // Try multiple sources for organization name
            if (user) {
              if (user.organization && user.organization.name) {
                formData.partner = user.organization.name;
                console.log(
                  "Partner set from user.organization.name:",
                  formData.partner
                );
              } else if (user.organizationName) {
                formData.partner = user.organizationName;
                console.log(
                  "Partner set from user.organizationName:",
                  formData.partner
                );
              } else if (user.name) {
                // Fallback to user's name if no organization
                formData.partner = user.organization.name;
                console.log(
                  "Partner set from user.name (fallback):",
                  formData.partner
                );
              }
            }

            console.log("📡 Submitting priority project to API...");
            console.log(
              "📦 Final project data being sent:",
              JSON.stringify(formData, null, 2)
            );

            // Submit to API using authManager
            const response = await authManager.apiCall(
              "/api/projects",
              "POST",
              formData
            );

            if (response.ok) {
              const result = await response.json();
              console.log("✅ Priority project created successfully:", result);

              // Show success message
              alert(
                "Priority project created successfully! Your project has been submitted for review."
              );

              // Close modal
              const modal = document.getElementById("createNewProject");
              modal.classList.add("hidden");

              // Reset form
              document.getElementById("newProjectForm").reset();
              document.getElementById("selectedLatLng").textContent =
                "Click on map to select location";
              document.getElementById("selectedCounty").textContent = "";

              // Remove marker
              if (newProjectMarker) {
                newProjectMarker.remove();
                newProjectMarker = null;
              }

              // Refresh projects list
              loadProjectsForMap();
            } else {
              let errorMessage = "Failed to create priority project";
              // Use stored raw error text from authManager.apiCall if available
              const errorText = response.errorText || "";
              if (errorText) console.error("❌ Raw error response:", errorText);
              // Attempt to parse JSON error
              try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.message || errorMessage;
                console.error("❌ API Error:", errorData);
              } catch (_e) {
                // Not JSON, skip
              }
              alert(`Failed to create priority project: ${errorMessage}`);
            }
          } catch (error) {
            console.error("❌ Submission error:", error);
            alert(
              "An error occurred while creating the priority project. Please try again."
            );
          }
        });

      // Initialize new project modal when it's shown
      document.addEventListener("DOMContentLoaded", function () {
        // Listen for modal show events using TW Elements
        const modal = document.getElementById("createNewProject");

        // Use a more reliable approach: check when modal becomes visible
        const checkModalVisibility = () => {
          if (!modal.classList.contains("hidden") && !newProjectMap) {
            setTimeout(initializeNewProjectMap, 200);
          }
        };

        // Clean up map when modal is hidden
        const cleanupMap = () => {
          if (modal.classList.contains("hidden") && newProjectMap) {
            newProjectMap.remove();
            newProjectMap = null;
            if (newProjectMarker) {
              newProjectMarker.remove();
              newProjectMarker = null;
            }
            // Reset display
            const latLngDisplay = document.getElementById("selectedLatLng");
            if (latLngDisplay) {
              latLngDisplay.textContent = "Click on map to select location";
            }
            const countyDisplay = document.getElementById("selectedCounty");
            if (countyDisplay) {
              countyDisplay.textContent = "";
            }
          }
        };

        // Check when modal visibility changes
        const observer = new MutationObserver(() => {
          checkModalVisibility();
          cleanupMap();
        });
        observer.observe(modal, {
          attributes: true,
          attributeFilter: ["class"],
        });

        // Also check on button click as backup
        const createButton = document.querySelector(
          '[data-twe-target="#createNewProject"]'
        );
        if (createButton) {
          createButton.addEventListener("click", () => {
            setTimeout(checkModalVisibility, 300);
          });
        }
      });

      // Function to open the new project modal (keeping for compatibility)
      function openNewProjectModal() {
        const modal = document.getElementById("createNewProject");
        modal.classList.remove("hidden");
        // Initialize map when modal opens
        setTimeout(initializeNewProjectMap, 100);
      }

      // Function to request collaboration on a project
      async function requestCollaboration(projectId) {
        if (
          !confirm(
            "Are you sure you want to request collaboration on this project?"
          )
        ) {
          return;
        }

        try {
          const token = authManager.getToken();
          if (!token) {
            alert("You must be logged in to request collaboration.");
            return;
          }

          const response = await fetch(
            `${window.BASE_URL}/api/projects/${projectId}/collaborators`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({
                role: "COLLABORATOR", // Default role for new collaborators
              }),
            }
          );

          if (response.ok) {
            const result = await response.json();
            alert("Collaboration request sent successfully!");
          } else {
            const error = await response.json();
            alert(
              `Failed to request collaboration: ${
                error.message || "Unknown error"
              }`
            );
          }
        } catch (error) {
          console.error("Error requesting collaboration:", error);
          alert(
            "An error occurred while requesting collaboration. Please try again."
          );
        }
      }
    </script>
  </body>
</html>
