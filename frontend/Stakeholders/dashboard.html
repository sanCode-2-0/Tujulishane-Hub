<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RMNCAH</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Tailwind CSS (with custom config using inline script) -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#1e40af", // Custom Blue
              secondary: "#f59e0b", // Custom Amber
              accent: "#10b981", // Custom Green
              dark: "#1f2937", // Gray-800
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="../styles/main.css" />

    <!-- Backend URL Configuration - MUST BE LOADED FIRST -->
    <script src="../config.js"></script>
    <script src="../set-base-url.js"></script>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css"
    />
    <script src="../styles/effects.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
      integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css"
      rel="stylesheet"
    />
    <!-- Alpine.js -->
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <!-- Mapbox CSS -->
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css"
      rel="stylesheet"
    />
    <!-- Mapbox JS -->
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
    <!-- Mapbox GL JS (alternative version) -->
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <!-- Mapbox Geocoder Plugin -->
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
      type="text/css"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Authentication utilities -->
    <script src="../auth.js"></script>
    <!-- Ensure global markers array exists for map pickers and submission code -->
    <script>
      window.markers = window.markers || [];
    </script>
    <!-- Optional: Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css"
    />
    <style>
      /* Ensure Mapbox map renders properly */
      #newProjectMap {
        min-height: 400px;
      }

      #newProjectMap .mapboxgl-canvas {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
      }

      .mapboxgl-map {
        font-family: "Inter", sans-serif;
      }

      .fade-slide-enter {
        opacity: 0;
        transform: translateY(20px);
      }

      .fade-slide-enter-active {
        opacity: 1;
        transform: translateY(0);
        transition: all 0.4s ease;
      }

      .fade-slide-leave {
        opacity: 1;
        transform: translateY(0);
      }

      .fade-slide-leave-active {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
      }
    </style>
  </head>

  <body class="text-gray-800">
    <div
      data-twe-modal-init
      class="fixed left-0 top-0 backdrop-blur-md z-[1055] hidden h-full w-full overflow-y-auto overflow-x-hidden outline-none"
      id="createNewProject"
      tabindex="-1"
      aria-labelledby="createNewProjectTitle"
      aria-modal="true"
      role="dialog"
    >
      <div
        data-twe-modal-dialog-ref
        class="pointer-events-none relative flex min-h-[calc(100%-1rem)] w-auto translate-y-[-50px] items-center opacity-0 transition-all duration-300 ease-in-out min-[576px]:mx-auto min-[576px]:mt-7 min-[576px]:max-w-[500px] min-[992px]:max-w-[800px] min-[1200px]:max-w-[1140px]"
      >
        <div
          class="relative flex flex-col w-full text-current bg-white border-none rounded-md outline-none pointer-events-auto bg-clip-padding shadow-4"
        >
          <div
            class="flex items-center justify-between flex-shrink-0 p-4 border-b-2 rounded-t-md border-neutral-100"
          >
            <!-- Modal title -->
            <h5
              class="text-xl font-light uppercase leading-normal text-surface"
              id="createNewProjectTitle"
            >
              New Project ( Priority )
            </h5>
            <!-- Close button -->
            <button
              type="button"
              class="box-content border-none rounded-none text-neutral-500 hover:text-neutral-800 hover:no-underline focus:text-neutral-800 focus:opacity-100 focus:shadow-none focus:outline-none"
              data-twe-modal-dismiss
              aria-label="Close"
            >
              <span class="[&>svg]:h-6 [&>svg]:w-6">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </span>
            </button>
          </div>

          <!-- Modal body -->
          <div class="relative p-4">
            <form id="newProjectForm">
              <div class="grid grid-cols-2 gap-4 lg:grid-cols-4">
                <!-- Map Picker for Location -->
                <div class="col-span-2 lg:col-span-4">
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Pick Project Locations on Map</label
                  >
                  <div class="text-xs text-gray-600 mb-2">
                    Search for a location or click on the map to select multiple
                    project coordinates.
                  </div>

                  <!-- Filtering Dropdowns -->
                  <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                      <label
                        for="countyDropdown"
                        class="block text-sm font-medium text-gray-700"
                        >County</label
                      >
                      <select
                        id="countyDropdown"
                        class="block w-full p-2 mt-1 border border-gray-200 rounded-lg"
                      >
                        <option value="">All Counties</option>
                      </select>
                    </div>
                    <div>
                      <label
                        for="subCountyDropdown"
                        class="block text-sm font-medium text-gray-700"
                        >Sub-County</label
                      >
                      <select
                        id="subCountyDropdown"
                        class="block w-full p-2 mt-1 border border-gray-200 rounded-lg"
                      >
                        <option value="">All Sub-Counties</option>
                      </select>
                    </div>
                    <div>
                      <label
                        for="typeDropdown"
                        class="block text-sm font-medium text-gray-700"
                        >Facility Type</label
                      >
                      <select
                        id="typeDropdown"
                        class="block w-full p-2 mt-1 border border-gray-200 rounded-lg"
                      >
                        <option value="">All Types</option>
                      </select>
                    </div>
                    <div>
                      <label
                        for="statusDropdown"
                        class="block text-sm font-medium text-gray-700"
                        >Status</label
                      >
                      <select
                        id="statusDropdown"
                        class="block w-full p-2 mt-1 border border-gray-200 rounded-lg"
                      >
                        <option value="">All Statuses</option>
                      </select>
                    </div>
                  </div>

                  <div
                    id="newProjectMap"
                    style="
                      height: 400px;
                      width: 100%;
                      border-radius: 8px;
                      margin-bottom: 8px;
                      border: 1px solid #e5e7eb;
                      background-color: #f3f4f6;
                      position: relative;
                      overflow: hidden;
                    "
                  ></div>
                  <div id="locationInputs">
                    <!-- Hidden inputs for locations will be added here by JS -->
                  </div>
                  <div
                    class="text-sm text-gray-700 mt-2 p-2 bg-gray-50 rounded"
                  >
                    <strong>Selected Locations:</strong>
                    <ul
                      id="selectedLocations"
                      class="list-disc list-inside mt-1"
                    >
                      <li class="text-gray-500">No locations selected yet</li>
                    </ul>
                  </div>
                </div>
                <!-- Title -->
                <div>
                  <label
                    for="title"
                    class="block text-sm font-medium text-gray-700"
                    >Title *</label
                  >
                  <input
                    required
                    type="text"
                    id="title"
                    name="title"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>

                <!-- Project Theme -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-3"
                    >Project Theme *</label
                  >

                  <!-- Select All Option -->
                  <div class="mb-4">
                    <label class="inline-flex items-center cursor-pointer">
                      <input
                        type="checkbox"
                        id="theme_select_all"
                        class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                      />
                      <span class="ml-2 text-sm font-medium text-gray-700"
                        >Select All Themes</span
                      >
                    </label>
                  </div>

                  <!-- Theme Grid -->
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <!-- Gender Based Violence -->
                    <div class="theme-card relative">
                      <label
                        class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 hover:bg-indigo-50 transition-all duration-200"
                      >
                        <input
                          type="checkbox"
                          name="theme[]"
                          value="GBV"
                          class="theme-checkbox h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                        />
                        <div class="ml-3 flex items-center flex-1">
                          <div
                            class="flex-shrink-0 w-8 h-8 bg-red-100 rounded-full flex items-center justify-center"
                          >
                            <i
                              class="fas fa-shield-alt text-red-600 text-sm"
                            ></i>
                          </div>
                          <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">
                              Gender Based Violence
                            </div>
                            <div class="text-xs text-gray-500">
                              GBV prevention & support
                            </div>
                          </div>
                        </div>
                      </label>
                    </div>

                    <!-- Adolescent and Young People Sexual and Reproductive Health -->
                    <div class="theme-card relative">
                      <label
                        class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 hover:bg-indigo-50 transition-all duration-200"
                      >
                        <input
                          type="checkbox"
                          name="theme[]"
                          value="AYPSRH"
                          class="theme-checkbox h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                        />
                        <div class="ml-3 flex items-center flex-1">
                          <div
                            class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center"
                          >
                            <i class="fas fa-heart text-blue-600 text-sm"></i>
                          </div>
                          <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">
                              AYP Sexual & Reproductive Health
                            </div>
                            <div class="text-xs text-gray-500">
                              Adolescent health services
                            </div>
                          </div>
                        </div>
                      </label>
                    </div>

                    <!-- Maternal and Newborn Health -->
                    <div class="theme-card relative">
                      <label
                        class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 hover:bg-indigo-50 transition-all duration-200"
                      >
                        <input
                          type="checkbox"
                          name="theme[]"
                          value="MNH"
                          class="theme-checkbox h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                        />
                        <div class="ml-3 flex items-center flex-1">
                          <div
                            class="flex-shrink-0 w-8 h-8 bg-pink-100 rounded-full flex items-center justify-center"
                          >
                            <i class="fas fa-baby text-pink-600 text-sm"></i>
                          </div>
                          <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">
                              Maternal & Newborn Health
                            </div>
                            <div class="text-xs text-gray-500">
                              Maternity care & newborn support
                            </div>
                          </div>
                        </div>
                      </label>
                    </div>

                    <!-- Family Planning -->
                    <div class="theme-card relative">
                      <label
                        class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 hover:bg-indigo-50 transition-all duration-200"
                      >
                        <input
                          type="checkbox"
                          name="theme[]"
                          value="FP"
                          class="theme-checkbox h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                        />
                        <div class="ml-3 flex items-center flex-1">
                          <div
                            class="flex-shrink-0 w-8 h-8 bg-green-100 rounded-full flex items-center justify-center"
                          >
                            <i class="fas fa-users text-green-600 text-sm"></i>
                          </div>
                          <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">
                              Family Planning
                            </div>
                            <div class="text-xs text-gray-500">
                              Contraception & family services
                            </div>
                          </div>
                        </div>
                      </label>
                    </div>

                    <!-- Child Health -->
                    <div class="theme-card relative">
                      <label
                        class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 hover:bg-indigo-50 transition-all duration-200"
                      >
                        <input
                          type="checkbox"
                          name="theme[]"
                          value="CH"
                          class="theme-checkbox h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                        />
                        <div class="ml-3 flex items-center flex-1">
                          <div
                            class="flex-shrink-0 w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center"
                          >
                            <i class="fas fa-child text-purple-600 text-sm"></i>
                          </div>
                          <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">
                              Child Health
                            </div>
                            <div class="text-xs text-gray-500">
                              Pediatric care & development
                            </div>
                          </div>
                        </div>
                      </label>
                    </div>

                    <!-- Adolescent Health -->
                    <div class="theme-card relative">
                      <label
                        class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 hover:bg-indigo-50 transition-all duration-200"
                      >
                        <input
                          type="checkbox"
                          name="theme[]"
                          value="AH"
                          class="theme-checkbox h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                        />
                        <div class="ml-3 flex items-center flex-1">
                          <div
                            class="flex-shrink-0 w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center"
                          >
                            <i
                              class="fas fa-user-graduate text-orange-600 text-sm"
                            ></i>
                          </div>
                          <div class="ml-3">
                            <div class="text-sm font-medium text-gray-900">
                              Adolescent Health
                            </div>
                            <div class="text-xs text-gray-500">
                              Teen health & wellness
                            </div>
                          </div>
                        </div>
                      </label>
                    </div>
                  </div>

                  <!-- Selected Themes Counter -->
                  <div class="mt-3 text-xs text-gray-500">
                    <span id="selected-themes-count">0</span> theme(s) selected
                  </div>
                </div>

                <!-- Project Category -->
                <div>
                  <label
                    for="category"
                    class="block text-sm font-medium text-gray-700"
                    >Project Category *</label
                  >
                  <select
                    id="category"
                    name="category"
                    class="block w-full p-2 mt-1 text-black bg-white border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  >
                    <option value="">Select Category</option>
                    <option value="IMPLEMENTING">Implementing Project</option>
                    <option value="RESEARCH">Research Project</option>
                    <option value="PRIORITY">Priority Project</option>
                  </select>
                </div>
                <div>
                  <label
                    for="starttime_period"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Start *
                  </label>
                  <input
                    required
                    type="date"
                    id="starttime_period"
                    name="start_date"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="endtime_period"
                    class="block text-sm font-medium text-gray-700"
                    >End *</label
                  >
                  <input
                    type="date"
                    id="endtime_period"
                    name="end_date"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <!-- Supporting Documents -->
                <div class="col-span-2 md:col-span-4">
                  <label
                    for="supporting_documents"
                    class="block text-sm font-medium text-gray-700"
                    >Supporting Documents</label
                  >
                  <input
                    type="file"
                    id="supporting_documents"
                    name="supporting_documents"
                    multiple
                    accept=".pdf,.doc,.docx,image/*"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                  <p class="text-xs text-gray-500 mt-1">
                    You can upload Word documents (.doc, .docx), images, and PDF
                    files. Multiple files allowed.
                  </p>
                </div>
                <!-- Activity Type -->
                <div class="col-span-2 md:col-span-4">
                  <label
                    for="activity_type"
                    class="block text-sm font-medium text-gray-700"
                    >Activity Type (Description) *
                  </label>
                  <textarea
                    required
                    id="activity_type"
                    name="activity_type"
                    rows="3"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  ></textarea>
                </div>

                <!-- County and Sub-county fields removed (not required) -->

                <!-- Contact Person -->
                <div>
                  <label
                    for="contact_person"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Contact Person Name *
                  </label>
                  <input
                    required
                    type="text"
                    id="contact_person"
                    name="contact_person_name"
                    placeholder="Name"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="contact_person"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Contact Person Role *
                  </label>
                  <input
                    required
                    type="text"
                    id="contact_person"
                    name="contact_person_role"
                    placeholder="Role"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="contact_person"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Contact Person Email *
                  </label>
                  <input
                    required
                    type="email"
                    id="contact_person"
                    name="contact_person_mail"
                    placeholder="Email"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="budget"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Budget in KES
                  </label>
                  <input
                    required
                    type="number"
                    id="budget"
                    name="budget"
                    placeholder="amount"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>

                <!-- Gaps -->
                <div class="col-span-2 lg:col-span-4">
                  <label
                    for="gaps"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Objectives *
                  </label>
                  <textarea
                    required
                    id="gaps"
                    name="gaps"
                    rows="3"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  ></textarea>
                </div>
              </div>

              <!-- Button -->
              <div class="mt-3">
                <button
                  type="submit"
                  class="inline-flex justify-center w-full px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                  Submit Project
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <nav
      x-data="{ open: false }"
      class="fixed z-50 border shadow-sm bg-white/70 top-4 left-4 right-4 backdrop-blur-md border-white/10 rounded-xl"
    >
      <div class="flex items-center justify-between px-6 py-4">
        <a
          href="../index.html"
          class="flex items-center justify-center space-x-2 text-2xl font-bold text-teal-700 uppercase"
        >
          <img
            src="../resources/images/log2.png"
            class="object-contain h-10 lg:h-12"
            alt="Site Logo"
          />
          <img
            src="../resources/images/moh.png"
            class="object-contain h-10 lg:h-12"
            alt="Site Logo"
          />
        </a>

        <button
          @click="open = !open"
          class="text-xl lg:hidden focus:outline-none text-gray-600 hover:text-gray-800"
        >
          <i class="fal fa-bars" x-show="!open"></i>
          <i class="fal fa-times" x-show="open" x-cloak></i>
        </button>

        <ul
          class="items-center hidden space-x-8 text-sm font-medium text-gray-800 lg:flex"
        >
          <li>
            <a
              href="../index.html"
              class="uppercase transition hover:text-lime-600"
              >Home</a
            >
          </li>

          <!-- Projects Dropdown -->
          <li x-data="{ showprojectDropdown: false }" class="relative">
            <button
              @click="showprojectDropdown = !showprojectDropdown"
              class="font-semibold inline-flex items-center uppercase transition hover:text-lime-600"
            >
              Projects <i class="ml-2 fad fa-chevron-down"></i>
            </button>
            <div
              x-show="showprojectDropdown"
              @click.outside="showprojectDropdown = false"
              x-transition
              class="absolute z-50 w-64 mt-2 bg-white/90 backdrop-blur-md divide-y divide-gray-100 shadow-md rounded-xl"
            >
              <ul class="py-2 text-sm text-left text-teal-800">
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a
                    data-twe-toggle="modal"
                    data-twe-target="#createNewProject"
                  >
                    <i class="far fa-plus mr-3 text-emerald-500"></i> New
                    Project
                  </a>
                </li>
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="../projects.html#my-projects">
                    <i class="far fa-user-check mr-2 text-sky-500"></i> My
                    Projects
                  </a>
                </li>
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="../all-projects.html">
                    <i class="far fa-folder-open mr-2 text-yellow-600"></i> All
                    Projects
                  </a>
                </li>
              </ul>
            </div>
          </li>

          <!-- Collaborations Dropdown -->
          <li x-data="{ collabDropdown: false }" class="relative">
            <button
              @click="collabDropdown = !collabDropdown"
              class="font-semibold inline-flex items-center uppercase transition hover:text-lime-600"
            >
              Collaborations <i class="ml-2 fad fa-chevron-down"></i>
            </button>
            <div
              x-show="collabDropdown"
              @click.outside="collabDropdown = false"
              x-transition
              class="absolute z-50 w-64 mt-2 bg-white divide-y divide-gray-100 shadow-md rounded-xl"
            >
              <ul class="py-2 text-sm text-left text-teal-700">
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="../priorities.html">
                    <i class="far fa-star mr-2 text-orange-600"></i> RMNCAH
                    Proirities
                  </a>
                </li>
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="../my-collaborations.html">
                    <i class="far fa-users-crown mr-2 text-fuchsia-600"></i> My
                    Collaborations
                  </a>
                </li>
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="../announcements.html">
                    <i class="far fa-search mr-2 text-cyan-500"></i> Find
                    Projects
                  </a>
                </li>
              </ul>
            </div>
          </li>
        </ul>

        <!-- Right-aligned Items (Admin + User) -->
        <ul
          class="flex items-center space-x-6 text-sm hidden lg:flex font-medium text-gray-800"
        >
          <!-- Admin -->
          <li
            x-data="{ showDropdown: false }"
            class="relative hidden"
            id="adminNav"
          >
            <button
              @click="showDropdown = !showDropdown"
              class="font-semibold inline-flex items-center uppercase transition hover:text-lime-600"
            >
              Admin <i class="ml-2 fad fa-chevron-down"></i>
            </button>
            <div
              x-show="showDropdown"
              @click.outside="showDropdown = false"
              x-transition
              class="absolute z-50 w-64 mt-2 bg-white divide-y divide-gray-100 shadow-md rounded-xl"
            >
              <ul class="py-2 text-sm text-left text-teal-700">
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="../dashboard.html">Dashboard</a>
                </li>
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="../projects.html">Project Management</a>
                </li>
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="../members.html">Stakeholder Management</a>
                </li>
              </ul>
            </div>
          </li>

          <!-- User Dropdown -->
          <li x-data="{ showUserDropdown: false }" class="relative">
            <button
              @click="showUserDropdown = !showUserDropdown"
              class="font-semibold uppercase inline-flex items-center px-3 py-2 text-sm font-medium transition rounded-lg hover:bg-gray-100"
            >
              <i class="mr-2 fas fa-user-circle"></i>
              <span id="userDisplayName">User</span>
              <i class="ml-2 fad fa-chevron-down"></i>
            </button>
            <div
              x-show="showUserDropdown"
              @click.outside="showUserDropdown = false"
              x-transition
              class="absolute right-0 z-50 w-64 mt-2 bg-white divide-y divide-gray-100 shadow-lg rounded-xl"
            >
              <div class="px-4 py-3">
                <div
                  class="text-base font-semibold text-teal-900"
                  id="userNameDisplay"
                >
                  Loading...
                </div>
                <div class="text-sm text-slate-500" id="userEmailDisplay"></div>
                <div class="text-xs text-slate-400 mt-1">
                  Role:
                  <span
                    id="userRoleDisplay"
                    class="font-medium text-teal-600"
                  ></span>
                  | Status:
                  <span
                    id="userStatusDisplay"
                    class="font-medium text-lime-500"
                  ></span>
                </div>
              </div>
              <ul class="py-2 text-sm text-teal-700">
                <li>
                  <a
                    href="../profile.html"
                    class="block px-4 py-2 hover:bg-lime-50 hover:text-lime-600"
                  >
                    <i class="mr-2 fas fa-user"></i> Profile
                  </a>
                </li>
                <li>
                  <a
                    href="../settings.html"
                    class="block px-4 py-2 hover:bg-lime-50 hover:text-lime-600"
                  >
                    <i class="mr-2 fas fa-cog"></i> Settings
                  </a>
                </li>
                <li id="donorNav" class="hidden">
                  <a
                    href="../donor-management.html"
                    class="block px-4 py-2 hover:bg-lime-50 hover:text-lime-600"
                  >
                    <i class="mr-2 fas fa-hand-holding-heart"></i> Donor
                    Management
                  </a>
                </li>
              </ul>
              <div class="py-2">
                <button
                  onclick="authManager.logout()"
                  class="block w-full px-4 py-2 text-left text-sm text-red-700 hover:bg-red-100"
                >
                  <i class="mr-2 fas fa-sign-out-alt"></i> Logout
                </button>
              </div>
            </div>
          </li>

          <li>
            <a
              href="../faq.html"
              class="uppercase font-semibold transition text-blue-800 md:mr-3"
            >
              <i class="mr-2 fas fa-question-square"></i> FAQ's
            </a>
          </li>
        </ul>
      </div>

      <!-- Nav Links - Mobile -->
      <div
        x-show="open"
        x-transition:enter="transition ease-out duration-200"
        x-transition:enter-start="opacity-0 transform -translate-y-2"
        x-transition:enter-end="opacity-100 transform translate-y-0"
        x-transition:leave="transition ease-in duration-150"
        x-transition:leave-start="opacity-100 transform translate-y-0"
        x-transition:leave-end="opacity-0 transform -translate-y-2"
        class="px-6 pb-6 lg:hidden"
      >
        <ul class="items-center text-sm gap-3 grid font-medium text-gray-800">
          <li>
            <a
              href="../index.html"
              class="uppercase transition hover:text-lime-600"
              >Home</a
            >
          </li>

          <!-- Projects Dropdown -->
          <li x-data="{ showprojectDropdown: false }" class="relative">
            <button
              @click="showprojectDropdown = !showprojectDropdown"
              class="font-semibold inline-flex items-center uppercase transition hover:text-lime-600"
            >
              Projects <i class="ml-2 fad fa-chevron-down"></i>
            </button>
            <div
              x-show="showprojectDropdown"
              @click.outside="showprojectDropdown = false"
              x-transition
              class="absolute z-50 w-64 mt-2 bg-white/90 backdrop-blur-md divide-y divide-gray-100 shadow-md rounded-xl"
            >
              <ul class="py-2 text-sm text-left text-teal-800">
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a
                    data-twe-toggle="modal"
                    data-twe-target="#createNewProject"
                  >
                    <i class="far fa-plus mr-3 text-emerald-500"></i> New
                    Project
                  </a>
                </li>
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="../projects.html#my-projects">
                    <i class="far fa-user-check mr-2 text-sky-500"></i> My
                    Projects
                  </a>
                </li>
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="../all-projects.html">
                    <i class="far fa-folder-open mr-2 text-yellow-600"></i> All
                    Projects
                  </a>
                </li>
              </ul>
            </div>
          </li>

          <!-- Collaborations Dropdown -->
          <li x-data="{ collabDropdown: false }" class="relative">
            <button
              @click="collabDropdown = !collabDropdown"
              class="font-semibold inline-flex items-center uppercase transition hover:text-lime-600"
            >
              Collaborations <i class="ml-2 fad fa-chevron-down"></i>
            </button>
            <div
              x-show="collabDropdown"
              @click.outside="collabDropdown = false"
              x-transition
              class="absolute z-50 w-64 mt-2 bg-white divide-y divide-gray-100 shadow-md rounded-xl"
            >
              <ul class="py-2 text-sm text-left text-teal-700">
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="../priorities.html">
                    <i class="far fa-star mr-2 text-orange-600"></i> RMNCAH
                    Proirities
                  </a>
                </li>
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="../my-collaborations.html">
                    <i class="far fa-users-crown mr-2 text-fuchsia-600"></i> My
                    Collaborations
                  </a>
                </li>
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="../announcements.html">
                    <i class="far fa-search mr-2 text-cyan-500"></i> Find
                    Projects
                  </a>
                </li>
              </ul>
            </div>
          </li>

          <!-- Admin -->
          <li
            x-data="{ showDropdown: false }"
            class="relative hidden"
            id="adminNav"
          >
            <button
              @click="showDropdown = !showDropdown"
              class="font-semibold inline-flex items-center uppercase transition hover:text-lime-600"
            >
              Admin <i class="ml-2 fad fa-chevron-down"></i>
            </button>
            <div
              x-show="showDropdown"
              @click.outside="showDropdown = false"
              x-transition
              class="absolute z-50 w-64 mt-2 bg-white divide-y divide-gray-100 shadow-md rounded-xl"
            >
              <ul class="py-2 text-sm text-left text-teal-700">
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="../dashboard.html">Dashboard</a>
                </li>
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="../projects.html">Project Management</a>
                </li>
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="../members.html">Stakeholder Management</a>
                </li>
              </ul>
            </div>
          </li>

          <!-- User Dropdown -->
          <li x-data="{ showUserDropdown: false }" class="relative">
            <button
              @click="showUserDropdown = !showUserDropdown"
              class="font-semibold uppercase inline-flex items-center text-sm font-medium transition rounded-lg hover:bg-gray-100"
            >
              <i class="mr-2 fas fa-user-circle"></i>
              <span id="userDisplayName">User</span>
              <i class="ml-2 fad fa-chevron-down"></i>
            </button>
            <div
              x-show="showUserDropdown"
              @click.outside="showUserDropdown = false"
              x-transition
              class="absolute right-0 z-50 w-64 mt-2 bg-white divide-y divide-gray-100 shadow-lg rounded-xl"
            >
              <div class="px-4 py-3">
                <div
                  class="text-base font-semibold text-teal-900"
                  id="userNameDisplay"
                >
                  Loading...
                </div>
                <div class="text-sm text-slate-500" id="userEmailDisplay"></div>
                <div class="text-xs text-slate-400 mt-1">
                  Role:
                  <span
                    id="userRoleDisplay"
                    class="font-medium text-teal-600"
                  ></span>
                  | Status:
                  <span
                    id="userStatusDisplay"
                    class="font-medium text-lime-500"
                  ></span>
                </div>
              </div>
              <ul class="py-2 text-sm text-teal-700">
                <li>
                  <a
                    href="../profile.html"
                    class="block px-4 py-2 hover:bg-lime-50 hover:text-lime-600"
                  >
                    <i class="mr-2 fas fa-user"></i> Profile
                  </a>
                </li>
                <li>
                  <a
                    href="../settings.html"
                    class="block px-4 py-2 hover:bg-lime-50 hover:text-lime-600"
                  >
                    <i class="mr-2 fas fa-cog"></i> Settings
                  </a>
                </li>
                <li id="donorNav" class="hidden">
                  <a
                    href="../donor-management.html"
                    class="block px-4 py-2 hover:bg-lime-50 hover:text-lime-600"
                  >
                    <i class="mr-2 fas fa-hand-holding-heart"></i> Donor
                    Management
                  </a>
                </li>
              </ul>
              <div class="py-2">
                <button
                  onclick="authManager.logout()"
                  class="block w-full px-4 py-2 text-left text-sm text-red-700 hover:bg-red-100"
                >
                  <i class="mr-2 fas fa-sign-out-alt"></i> Logout
                </button>
              </div>
            </div>
          </li>

          <li>
            <a
              href="../faq.html"
              class="uppercase font-semibold transition text-blue-800 md:mr-3"
            >
              <i class="mr-2 fas fa-question-square"></i> FAQ's
            </a>
          </li>
        </ul>
      </div>
    </nav>

    <section class="pt-16 bg-cyan-800 sm:pt-20">
      <div
        class="grid max-w-6xl px-4 py-8 mx-auto sm:px-6 lg:px-8 md:grid-cols-5 bg-gray-50"
        style="background-color: #f8fafc"
      >
        <div class="md:col-span-4">
          <h1 class="mb-2 text-4xl font-semibold md:text-4xl">
            RMNCAH Hub Sponsor Dashboard
          </h1>

          <p class="text-[16px] mb-6 max-w-2xl">
            Explore and track projects across Kenya. Use filters to view
            initiatives by category, location, or status, and gain insights into
            their progress and impact.
          </p>
          <div class="flex gap-12 text-3xl">
            <div>
              <span id="stat-projects" class="font-bold tracking-wider"
                >...</span
              >
              <span class="font-thin"> Projects </span>
            </div>
            <div>
              <span id="stat-counties" class="font-bold tracking-wider"
                >...</span
              >
              <span class="font-thin"> Counties </span>
            </div>
            <div>
              <span id="stat-members" class="font-bold tracking-wider"
                >...</span
              >
              <span class="font-thin"> Team Members </span>
            </div>
          </div>
        </div>
        <div class="md:col-span-1">
          <h6
            class="mt-4 mb-1 mb-2 text-sm font-semibold leading-tight text-center uppercase text-gray-50 opacity-90"
          >
            Quick Actions
          </h6>
          <div class="grid gap-4">
            <button
              data-twe-toggle="modal"
              data-twe-target="#createNewProject"
              class="flex items-center justify-between px-4 py-2 rounded-full bg-cyan-600"
            >
              <span class="text-sm"> New Project </span>
              <span class="text-lg">
                <i class="fas fa-file-pdf"></i>
              </span>
            </button>
            <button
              data-twe-toggle="modal"
              data-twe-target="#updateProfile"
              class="flex items-center justify-between px-4 py-2 rounded-full bg-cyan-600"
            >
              <span class="text-sm"> Update Profile </span>
              <span class="text-lg">
                <i class="fas fa-clipboard-list-check"></i>
              </span>
            </button>
            <button
              data-twe-toggle="modal"
              data-twe-target="#raiseticket"
              class="flex items-center justify-between px-4 py-2 rounded-full bg-cyan-600"
            >
              <span class="text-sm"> Contact Support </span>
              <span class="text-lg">
                <i class="fas fa-headphones-alt"></i>
              </span>
            </button>

            <div
              class="invisible fixed bottom-0 right-0 backdrop-blur-lg top-0 z-[1045] flex w-full md:w-4/5 lg:w-3/4 max-w-full translate-x-full flex-col border-none bg-white bg-clip-padding text-neutral-700 shadow-sm outline-none transition duration-300 ease-in-out data-[twe-offcanvas-show]:transform-none"
              tabindex="-1"
              id="offcanvasRight"
              aria-labelledby="offcanvasRightLabel"
              data-twe-offcanvas-init
            >
              <div
                class="flex items-center justify-between p-4 backdrop-blur-lg"
              >
                <h5
                  class="mb-0 font-semibold leading-normal"
                  id="offcanvasRightLabel"
                >
                  Offcanvas right
                </h5>
                <button
                  type="button"
                  class="box-content border-none rounded-none text-neutral-500 hover:text-neutral-800 hover:no-underline focus:text-neutral-800 focus:opacity-100 focus:shadow-none focus:outline-none dark:text-neutral-400 dark:hover:text-neutral-300 dark:focus:text-neutral-300"
                  data-twe-offcanvas-dismiss
                  aria-label="Close"
                >
                  <span class="[&>svg]:h-6 [&>svg]:w-6">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </span>
                </button>
              </div>
              <div class="flex-grow p-4 overflow-y-auto offcanvas-body">
                ...
              </div>
            </div>
          </div>
        </div>
        <div
          data-twe-modal-init
          class="fixed left-0 top-0 backdrop-blur-md z-[1055] hidden h-full w-full overflow-y-auto overflow-x-hidden outline-none"
          id="updateProfile"
          tabindex="-1"
          aria-labelledby="updateProfile"
          aria-modal="true"
          role="dialog"
        >
          <div
            data-twe-modal-dialog-ref
            class="pointer-events-none relative flex min-h-[calc(100%-1rem)] w-auto translate-y-[-50px] items-center opacity-0 transition-all duration-300 ease-in-out min-[576px]:mx-auto min-[576px]:mt-7 min-[576px]:max-w-[500px] min-[992px]:max-w-[800px] min-[1200px]:max-w-[1140px]"
          >
            <div
              class="relative flex flex-col w-full text-current bg-white border-none rounded-md outline-none pointer-events-auto bg-clip-padding shadow-4"
            >
              <div
                class="flex items-center justify-between flex-shrink-0 p-4 border-b-2 rounded-t-md border-neutral-100"
              >
                <!-- Modal title -->
                <h5
                  class="text-xl font-medium leading-normal text-surface"
                  id="createNewProjectTitle"
                >
                  Update Profile
                </h5>
                <!-- Close button -->
                <button
                  type="button"
                  class="box-content border-none rounded-none text-neutral-500 hover:text-neutral-800 hover:no-underline focus:text-neutral-800 focus:opacity-100 focus:shadow-none focus:outline-none"
                  data-twe-modal-dismiss
                  aria-label="Close"
                >
                  <span class="[&>svg]:h-6 [&>svg]:w-6">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </span>
                </button>
              </div>

              <!-- Modal body -->
              <div class="relative p-4"></div>
            </div>
          </div>
        </div>
        <div
          data-twe-modal-init
          class="fixed left-0 top-0 backdrop-blur-md z-[1055] hidden h-full w-full overflow-y-auto overflow-x-hidden outline-none"
          id="raiseticket"
          tabindex="-1"
          aria-labelledby="updateProfile"
          aria-modal="true"
          role="dialog"
        >
          <div
            data-twe-modal-dialog-ref
            class="pointer-events-none relative flex min-h-[calc(100%-1rem)] w-auto translate-y-[-50px] items-center opacity-0 transition-all duration-300 ease-in-out min-[576px]:mx-auto min-[576px]:mt-7 min-[576px]:max-w-[500px] min-[992px]:max-w-[800px] min-[1200px]:max-w-[1140px]"
          >
            <div
              class="relative flex flex-col w-full text-current bg-white border-none rounded-md outline-none pointer-events-auto bg-clip-padding shadow-4"
            >
              <div
                class="flex items-center justify-between flex-shrink-0 p-4 border-b-2 rounded-t-md border-neutral-100"
              >
                <!-- Modal title -->
                <div class="">
                  <h5
                    class="text-xl font-medium leading-normal text-surface"
                    id="createNewProjectTitle"
                  >
                    Suppert Ticket
                  </h5>
                  <p class="">
                    Need help? Please describe your issue and our support team
                    will get back to you shortly.
                  </p>
                </div>
                <!-- Close button -->
                <button
                  type="button"
                  class="box-content border-none rounded-none text-neutral-500 hover:text-neutral-800 hover:no-underline focus:text-neutral-800 focus:opacity-100 focus:shadow-none focus:outline-none"
                  data-twe-modal-dismiss
                  aria-label="Close"
                >
                  <span class="[&>svg]:h-6 [&>svg]:w-6">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="currentColor"
                      viewBox="0 0 24 24"
                      stroke-width="1.5"
                      stroke="currentColor"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M6 18L18 6M6 6l12 12"
                      />
                    </svg>
                  </span>
                </button>
              </div>

              <!-- Modal body -->
              <div class="relative p-4"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <script src="../styles/effects.js"></script>
    <script src="../styles/loadNavStake.js"></script>
    <script type="module">
      // Use window.BASE_URL which is already set by config.js loaded via script tag
      const BASE_URL = window.BASE_URL;
      console.log(
        "[Stakeholders/dashboard.html] Using BASE_URL:",
        BASE_URL,
        "- Environment:",
        window.USE_PROD ? "PRODUCTION" : "DEVELOPMENT"
      );

      // Use AuthManager from auth.js
      const authManager = window.authManager || new window.AuthManager();

      async function fetchStatsAndProjects() {
        console.log(" Fetching stats and projects for status tabs...");
        try {
          // Fetch statistics
          const statsRes = await authManager.apiCall(
            "/api/projects/statistics",
            "GET"
          );
          let stats = {
            active: 0,
            pending: 0,
            stalled: 0,
            completed: 0,
            total: 0,
            counties: 0,
            members: 0,
          };

          if (statsRes.ok) {
            const data = await statsRes.json();
            const apiStats = data.data || data;
            console.log(" Statistics loaded:", apiStats);

            // Extract status counts from the API response
            if (apiStats.statusCounts && Array.isArray(apiStats.statusCounts)) {
              const statusMap = Object.fromEntries(apiStats.statusCounts);
              stats.active = statusMap.ACTIVE || 0;
              stats.pending = statusMap.PENDING || 0;
              stats.stalled = statusMap.STALLED || 0;
              stats.completed = statusMap.COMPLETED || 0;
            }

            stats.total = apiStats.totalProjects || 0;
            stats.counties = apiStats.countyCounts?.length || 0;
            stats.members = apiStats.totalStakeholders || 0;
          }

          console.log(" Processed stats:", stats);

          // Update status counts in the tabs (these are already handled by loadDashboardStatistics)
          // But we'll update them here too for redundancy
          document.getElementById("stat-active").textContent = stats.active;
          document.getElementById("stat-pending").textContent = stats.pending;
          document.getElementById("stat-stalled").textContent = stats.stalled;
          document.getElementById("stat-completed").textContent =
            stats.completed;

          // Fetch latest active projects for accordion
          console.log(" Fetching latest active projects...");
          const projectsRes = await authManager.apiCall(
            "/api/projects?status=ACTIVE&size=3&sort=createdAt,desc",
            "GET"
          );
          let projects = [];
          if (projectsRes.ok) {
            const data = await projectsRes.json();
            console.log(" Projects response:", data);

            // Extract projects array
            if (data.data) {
              if (Array.isArray(data.data)) {
                projects = data.data;
              } else if (
                data.data.content &&
                Array.isArray(data.data.content)
              ) {
                projects = data.data.content;
              }
            } else if (Array.isArray(data)) {
              projects = data;
            }

            console.log(" Extracted projects:", projects.length);
          }

          // Latest project accordion
          const latest = projects[0];
          document.getElementById("latest-project-content").innerHTML = latest
            ? `
            <strong>${latest.title}</strong><br>
            <span class="inline-block px-2 py-1 mt-2 text-xs rounded ${getStatusBadgeClass(
              latest.status
            )}">${latest.status}</span><br>
            <div class="mt-2">
              <strong>Theme:</strong> ${latest.projectTheme || "N/A"}<br>
              <strong>County:</strong> ${latest.county || "N/A"}<br>
              <strong>Partner:</strong> ${latest.partner || "N/A"}<br>
              <strong>Start Date:</strong> ${formatDate(latest.startDate)}<br>
              <strong>End Date:</strong> ${
                formatDate(latest.endDate) || "Ongoing"
              }<br>
              ${
                latest.activityType
                  ? `<strong>Activity:</strong> ${latest.activityType}<br>`
                  : ""
              }
            </div>
          `
            : "No recent active projects.";

          // Project #2 and #3
          document.getElementById("project-2-content").innerHTML = projects[1]
            ? `
            <strong>${projects[1].title}</strong><br>
            <span class="inline-block px-2 py-1 mt-2 text-xs rounded ${getStatusBadgeClass(
              projects[1].status
            )}">${projects[1].status}</span><br>
            <div class="mt-2">
              <strong>Theme:</strong> ${projects[1].projectTheme || "N/A"}<br>
              <strong>County:</strong> ${projects[1].county || "N/A"}<br>
              <strong>Partner:</strong> ${projects[1].partner || "N/A"}<br>
              <strong>Start Date:</strong> ${formatDate(
                projects[1].startDate
              )}<br>
              <strong>End Date:</strong> ${
                formatDate(projects[1].endDate) || "Ongoing"
              }<br>
            </div>
          `
            : "No data.";

          document.getElementById("project-3-content").innerHTML = projects[2]
            ? `
            <strong>${projects[2].title}</strong><br>
            <span class="inline-block px-2 py-1 mt-2 text-xs rounded ${getStatusBadgeClass(
              projects[2].status
            )}">${projects[2].status}</span><br>
            <div class="mt-2">
              <strong>Theme:</strong> ${projects[2].projectTheme || "N/A"}<br>
              <strong>County:</strong> ${projects[2].county || "N/A"}<br>
              <strong>Partner:</strong> ${projects[2].partner || "N/A"}<br>
              <strong>Start Date:</strong> ${formatDate(
                projects[2].startDate
              )}<br>
              <strong>End Date:</strong> ${
                formatDate(projects[2].endDate) || "Ongoing"
              }<br>
            </div>
          `
            : "No data.";

          // Pending, Stalled, Completed tables
          console.log(" Loading project tables...");
          await fillProjectsTable("PENDING", "pending-projects-table");
          await fillProjectsTable("STALLED", "stalled-projects-table");
          await fillProjectsTable("COMPLETED", "completed-projects-table");

          console.log(" All status tabs populated!");
        } catch (e) {
          console.error(" Failed to load dashboard data", e);
        }
      }

      // Helper function to get status badge class
      function getStatusBadgeClass(status) {
        const statusClasses = {
          ACTIVE: "bg-green-100 text-green-800",
          PENDING: "bg-yellow-100 text-yellow-800",
          STALLED: "bg-red-100 text-red-800",
          COMPLETED: "bg-blue-100 text-blue-800",
        };
        return statusClasses[status] || "bg-gray-100 text-gray-800";
      }

      // Helper function to format dates
      function formatDate(dateString) {
        if (!dateString) return null;
        try {
          const date = new Date(dateString);
          return date.toLocaleDateString("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
          });
        } catch (e) {
          return dateString;
        }
      }

      async function fillProjectsTable(status, tableId) {
        console.log(` Filling ${status} projects table...`);
        const res = await authManager.apiCall(
          `/api/projects?status=${status}&size=10&sort=createdAt,desc`,
          "GET"
        );
        let projects = [];
        if (res.ok) {
          const data = await res.json();
          console.log(` ${status} projects response:`, data);

          // Extract projects array
          if (data.data) {
            if (Array.isArray(data.data)) {
              projects = data.data;
            } else if (data.data.content && Array.isArray(data.data.content)) {
              projects = data.data.content;
            }
          } else if (Array.isArray(data)) {
            projects = data;
          }

          console.log(` Found ${projects.length} ${status} projects`);
        }

        const table = document.getElementById(tableId);
        if (!projects.length) {
          table.innerHTML = `<tr><td colspan="8" class="px-4 py-4 text-center text-gray-500">No ${status.toLowerCase()} projects.</td></tr>`;
          return;
        }
        table.innerHTML = projects
          .map(
            (p) => `
          <tr class="border-b hover:bg-gray-50">
            <td class="px-4 py-3 text-sm text-gray-700">${
              p.title || "Untitled"
            }</td>
            <td class="px-4 py-3 text-sm text-gray-700">${p.partner || "-"}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${
              p.projectTheme || "-"
            }</td>
            <td class="px-4 py-3 text-sm text-gray-700">${
              p.projectCategory || "-"
            }</td>
            <td class="px-4 py-3 text-sm text-gray-700">${
              p.county || p.region || "-"
            }</td>
            <td class="px-4 py-3 text-sm text-gray-700">${
              formatDate(p.startDate) || "-"
            }</td>
            <td class="px-4 py-3 text-sm text-gray-700">${
              formatDate(p.endDate) || "-"
            }</td>
            <td class="px-4 py-3 text-sm text-gray-700">${
              p.contactPersonName || "-"
            }</td>
            ${
              tableId === "completed-projects-table"
                ? `<td class="px-4 py-3"><button class="px-3 py-1 text-xs text-white bg-blue-500 rounded hover:bg-blue-600">View Report</button></td>`
                : ""
            }
          </tr>
        `
          )
          .join("");
      }

      document.addEventListener("DOMContentLoaded", fetchStatsAndProjects);
    </script>
    <script>
      // Initialize bar chart with empty data
      let barChartInstance = null;

      function initializeBarChart() {
        const chartElement = document.querySelector("#barChart");
        if (!chartElement) {
          console.error(" Chart element #barChart not found!");
          return;
        }

        console.log(" Initializing bar chart...");

        const options = {
          chart: {
            type: "bar",
            height: 400,
            stacked: false,
          },
          plotOptions: {
            bar: {
              horizontal: false,
              columnWidth: "50%",
              dataLabels: {
                position: "top",
              },
            },
          },
          dataLabels: {
            enabled: true,
            offsetY: -20,
            style: {
              fontSize: "12px",
              colors: ["#304758"],
            },
          },
          series: [
            {
              name: "Number of Projects",
              data: [0, 0, 0],
            },
          ],
          xaxis: {
            categories: ["Loading...", "Loading...", "Loading..."],
            title: { text: "Project Theme" },
          },
          yaxis: {
            title: { text: "Number of Projects" },
          },
          legend: {
            position: "top",
          },
          tooltip: {
            y: {
              formatter: function (val) {
                return val + " Project" + (val !== 1 ? "s" : "");
              },
            },
          },
        };

        try {
          barChartInstance = new ApexCharts(chartElement, options);
          barChartInstance.render();
          console.log(" Bar chart initialized successfully!");
        } catch (error) {
          console.error(" Failed to initialize chart:", error);
        }
      }

      // Load chart data from API
      async function loadChartData() {
        console.log(" Loading chart data...");
        try {
          const response = await authManager.apiCall(
            "/api/projects/statistics",
            "GET"
          );
          console.log(" Statistics API response:", response.status);

          if (response.ok) {
            const data = await response.json();
            const stats = data.data || data;
            console.log(" Statistics data:", stats);

            // Process theme counts
            let themeCounts = stats.themeCounts || [];
            const categories = [];
            const seriesData = [];

            if (themeCounts.length > 0) {
              // themeCounts is an array of [theme, count] arrays
              console.log(" Found themeCounts:", themeCounts);
              themeCounts.forEach(([theme, count]) => {
                categories.push(theme || "Unknown");
                seriesData.push(count);
              });
            } else {
              // If themeCounts not available, try to get projects and calculate
              console.log(
                " No themeCounts in statistics, fetching projects..."
              );
              const projectsResponse = await authManager.apiCall(
                "/api/projects?size=1000",
                "GET"
              );
              if (projectsResponse.ok) {
                const projectsData = await projectsResponse.json();
                console.log(" Raw projects response:", projectsData);

                // Extract projects array with multiple fallback paths
                let projects = [];
                if (projectsData.data) {
                  if (Array.isArray(projectsData.data)) {
                    projects = projectsData.data;
                  } else if (
                    projectsData.data.content &&
                    Array.isArray(projectsData.data.content)
                  ) {
                    projects = projectsData.data.content;
                  } else if (
                    projectsData.data.projects &&
                    Array.isArray(projectsData.data.projects)
                  ) {
                    projects = projectsData.data.projects;
                  }
                } else if (Array.isArray(projectsData)) {
                  projects = projectsData;
                }

                console.log(
                  " Extracted projects array:",
                  projects.length,
                  "projects"
                );
                console.log(" First project sample:", projects[0]);

                // Ensure projects is an array
                if (!Array.isArray(projects)) {
                  console.error(
                    " Projects is not an array:",
                    typeof projects,
                    projects
                  );
                  projects = [];
                }

                // Count by theme
                const themeMap = {};
                projects.forEach((project) => {
                  const theme = project.projectTheme || "Unknown";
                  themeMap[theme] = (themeMap[theme] || 0) + 1;
                });

                console.log(" Theme distribution:", themeMap);

                // Convert to arrays
                Object.entries(themeMap).forEach(([theme, count]) => {
                  categories.push(theme);
                  seriesData.push(count);
                });
              } else {
                console.error(
                  " Projects API failed:",
                  projectsResponse.status
                );
              }
            }

            // If still no data, show placeholder
            if (categories.length === 0) {
              console.log(" No data available, showing placeholder");
              categories.push("No Data");
              seriesData.push(0);
            }

            console.log(" Final chart data:", { categories, seriesData });

            // Update chart
            if (barChartInstance) {
              console.log(" Updating chart with data...");
              barChartInstance.updateOptions({
                xaxis: {
                  categories: categories,
                  title: { text: "Project Theme" },
                },
              });
              barChartInstance.updateSeries([
                {
                  name: "Number of Projects",
                  data: seriesData,
                },
              ]);
              console.log(" Chart updated successfully!");
            } else {
              console.error(" Bar chart instance not found!");
            }

            console.log("Chart data loaded:", { categories, seriesData });
          } else {
            console.error(
              " Statistics API response not OK:",
              response.status
            );
          }
        } catch (error) {
          console.error(" Failed to load chart data:", error);
          // Show error state in chart
          if (barChartInstance) {
            barChartInstance.updateOptions({
              xaxis: {
                categories: ["Error Loading Data"],
                title: { text: "Project Theme" },
              },
            });
            barChartInstance.updateSeries([
              {
                name: "Number of Projects",
                data: [0],
              },
            ]);
          }
        }
      }
    </script>

    <script>
      var options = {
        chart: {
          type: "donut",
          height: 350,
        },
        series: [65, 35], // Example: 65 males, 35 females
        labels: ["Male", "Female"],
        colors: ["#008FFB", "#FF4560"],
        legend: {
          position: "bottom",
        },
        dataLabels: {
          enabled: true,
          formatter: function (val, opts) {
            return opts.w.config.series[opts.seriesIndex];
          },
        },
        tooltip: {
          y: {
            formatter: function (val) {
              return val + " Members";
            },
          },
        },
      };

      var chart = new ApexCharts(document.querySelector("#teamChart"), options);
      chart.render();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/tw-elements/js/tw-elements.umd.min.js"></script>
    <script>
      // let map;
      let projects = [];
      // const mapMarkers = [];

      const bgColors = {
        active: "bg-green-50",
        pending: "bg-yellow-50",
        stalled: "bg-red-50",
        abandoned: "bg-gray-100",
        completed: "bg-cyan-100",
        default: "bg-white",
      };

      const statusBadge = (tag) => {
        return (
          {
            active: "bg-green-200 text-green-800",
            pending: "bg-yellow-200 text-yellow-800",
            stalled: "bg-red-200 text-red-800",
            abandoned: "bg-gray-300 text-gray-800",
            completed: "bg-cyan-300 text-gray-800",
          }[tag] || "bg-gray-200 text-gray-800"
        );
      };

      let sortBy = "name";
      let sortOrder = "asc";
      let currentPage = 1;
      const itemsPerPage = 5;
      let currentFilter = "all";

      let searchQuery = "";
      let dateRangeFrom = null;
      let dateRangeTo = null;

      document.addEventListener("DOMContentLoaded", function () {
        // Initialize authentication and load user data
        initializeUserSession();

        // Initialize bar chart
        if (typeof initializeBarChart === "function") {
          initializeBarChart();
        }

        // Set Mapbox access token
        mapboxgl.accessToken =
          "pk.eyJ1IjoibG9tb2dhbnRlY2giLCJhIjoiY2xzOTcyYXdlMDUxZDJsbXRnZGh2ZmpoYyJ9.sIWvONzgGPF2rtAcECsrJQ";

        // Initialize Mapbox map
        map = new mapboxgl.Map({
          container: "kenyaMap",
          style: "mapbox://styles/lomogantech/clsa1f16r00wt01qqbnf741n6",
          center: [37.9062, -0.0236],
          zoom: 6.3,
        });

        // Add zoom and rotation controls to the map
        map.addControl(new mapboxgl.NavigationControl(), "top-right");

        // Load projects after map is initialized
        map.on("load", () => {
          loadProjectsForMap();
        });
      });

      // Initialize user session
      async function initializeUserSession() {
        // Check if user is authenticated
        if (!authManager.isAuthenticated()) {
          console.warn("User not authenticated, redirecting to login...");
          window.location.href = "../index.html";
          return;
        }

        try {
          // Load current user data
          const user = await authManager.getCurrentUser();
          console.log("User session initialized:", user);

          // Populate user dropdown with user data
          if (user) {
            console.log(" Populating user dropdown...");

            // Update all user display elements
            const userDisplayName = document.getElementById("userDisplayName");
            const userNameDisplay = document.getElementById("userNameDisplay");
            const userEmailDisplay =
              document.getElementById("userEmailDisplay");
            const userRoleDisplay = document.getElementById("userRoleDisplay");
            const userStatusDisplay =
              document.getElementById("userStatusDisplay");

            if (userDisplayName)
              userDisplayName.textContent = user.name || "User";
            if (userNameDisplay)
              userNameDisplay.textContent = user.name || "Loading...";
            if (userEmailDisplay)
              userEmailDisplay.textContent = user.email || "";
            if (userRoleDisplay)
              userRoleDisplay.textContent = user.role || "N/A";
            if (userStatusDisplay) {
              userStatusDisplay.textContent = user.status || "N/A";
              // Update status color based on status
              userStatusDisplay.className =
                user.status === "ACTIVE"
                  ? "font-medium text-green-600"
                  : "font-medium text-gray-600";
            }

            console.log(" User dropdown populated successfully!");
          }

          // Load dashboard statistics if needed
          await loadDashboardStatistics();
        } catch (error) {
          console.error("Failed to load user session:", error);
        }
      }

      // Load dashboard statistics
      async function loadDashboardStatistics() {
        console.log(" Loading dashboard statistics...");
        try {
          const statsResponse = await authManager.apiCall(
            "/api/projects/statistics",
            "GET"
          );
          if (statsResponse.ok) {
            const data = await statsResponse.json();
            const stats = data.data || data;
            console.log(" Dashboard statistics loaded:", stats);

            // Update hero statistics
            document.getElementById("stat-projects").textContent =
              stats.totalProjects || "0";
            document.getElementById("stat-counties").textContent =
              stats.countyCounts?.length || "0";
            document.getElementById("stat-members").textContent =
              stats.totalStakeholders || "0";

            // Update status counts
            if (stats.statusCounts) {
              const statusMap = Object.fromEntries(stats.statusCounts);
              document.getElementById("stat-active").textContent =
                statusMap.ACTIVE || "0";
              document.getElementById("stat-pending").textContent =
                statusMap.PENDING || "0";
              document.getElementById("stat-stalled").textContent =
                statusMap.STALLED || "0";
              document.getElementById("stat-completed").textContent =
                statusMap.COMPLETED || "0";
            }

            // Load chart data if the chart is initialized
            console.log(" Checking if loadChartData exists...");
            if (typeof loadChartData === "function") {
              console.log(" Calling loadChartData...");
              await loadChartData();
            } else {
              console.error(" loadChartData function not found!");
            }
          } else {
            console.error(" Statistics API failed:", statsResponse.status);
          }
        } catch (error) {
          console.error(" Failed to load statistics:", error);
        }
      }

      // Load projects and add to map
      async function loadProjectsForMap() {
        try {
          const response = await fetch(
            `https://tujulishane-hub.onrender.com/api/projects/with-coordinates`,
            {
              headers: {
                Authorization: `Bearer ${authManager.getToken()}`,
              },
            }
          );

          if (response.ok) {
            const data = await response.json();
            console.log("Raw API response (with-coordinates):", data);
            let projectsData = [];
            if (data.status === 200 && data.data) {
              projectsData = Array.isArray(data.data) ? data.data : [];
            } else if (Array.isArray(data)) {
              projectsData = data;
            }

            console.log("Loaded projects for map:", projectsData.length);
            addMarkersToMap(projectsData);
          } else {
            console.warn("API response not OK, loading sample projects");
            loadSampleProjects();
          }
        } catch (error) {
          console.error("Error loading projects for map:", error);
          loadSampleProjects();
        }
      }

      // Load sample projects for demo
      function loadSampleProjects() {
        const sampleProjects = [
          {
            id: 1,
            projectName: "Project 1",
            latitude: -1.2921,
            longitude: 36.8219,
            status: "ACTIVE",
          },
          {
            id: 2,
            projectName: "Project 2",
            latitude: -0.1023,
            longitude: 34.7619,
            status: "PENDING",
          },
          {
            id: 3,
            projectName: "Project 3",
            latitude: 0.3256,
            longitude: 37.1231,
            status: "STALLED",
          },
          {
            id: 4,
            projectName: "Project 4",
            latitude: -1.1504,
            longitude: 36.8907,
            status: "COMPLETED",
          },
        ];
        addMarkersToMap(sampleProjects);
      }

      // Add markers to Mapbox map
      function addMarkersToMap(projectsData) {
        // Clear existing markers
        mapMarkers.forEach((marker) => marker.remove());
        mapMarkers.length = 0;

        // Add new markers
        projectsData.forEach((project) => {
          const locs =
            Array.isArray(project.locations) && project.locations.length
              ? project.locations
              : project.latitude && project.longitude
              ? [{ latitude: project.latitude, longitude: project.longitude }]
              : [];

          locs.forEach((loc, locIndex) => {
            const lat = loc.latitude;
            const lng = loc.longitude;
            if (!lat || !lng) return;

            // Create marker element
            const el = document.createElement("div");
            el.className = "marker";
            el.style.backgroundColor = getStatusColor(project.status);
            el.style.width = "30px";
            el.style.height = "30px";
            el.style.borderRadius = "50%";
            el.style.border = "2px solid white";
            el.style.cursor = "pointer";
            el.style.boxShadow = "0 2px 4px rgba(0,0,0,0.3)";

            const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(`
							<div style="padding: 10px; min-width: 200px;">
								<h3 style="font-weight: bold; margin-bottom: 8px;">${
                  project.projectName || project.title || "Project"
                }</h3>
								<p style="margin: 4px 0;"><strong>Status:</strong> <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded ${statusBadge(
                  project.status?.toLowerCase()
                )}">${project.status || "N/A"}</span></p>
								<p style="margin: 4px 0;"><strong>Region/County:</strong> ${
                  loc.county ||
                  loc.region ||
                  project.region ||
                  project.county ||
                  "N/A"
                }</p>
								<p style="margin: 4px 0;"><strong>Theme:</strong> ${
                  project.projectTheme || "N/A"
                }</p>
								<p style="margin: 4px 0;"><strong>Category:</strong> ${
                  project.projectCategory || "N/A"
                }</p>
							</div>
						`);

            const marker = new mapboxgl.Marker(el)
              .setLngLat([lng, lat])
              .setPopup(popup)
              .addTo(map);

            try {
              marker.data = Object.assign({}, project, {
                lat,
                lng,
                location: loc,
                locationIndex: locIndex,
              });
            } catch (e) {}

            el.addEventListener("click", () => {
              map.flyTo({ center: [lng, lat], zoom: 12 });
            });

            mapMarkers.push(marker);
          });
        });
      }

      // Get status color
      function getStatusColor(status) {
        const colors = {
          ACTIVE: "#22c55e",
          PENDING: "#eab308",
          STALLED: "#ef4444",
          COMPLETED: "#06b6d4",
        };
        return colors[status] || "#6b7280";
      }

      // Get county name from coordinates using Mapbox Geocoding API
      async function getCountyFromCoordinates(longitude, latitude) {
        try {
          const response = await fetch(
            `https://api.mapbox.com/geocoding/v5/mapbox.places/${longitude},${latitude}.json?types=region&access_token=${mapboxgl.accessToken}`
          );
          const data = await response.json();
          if (data.features && data.features.length > 0) {
            return data.features[0].text;
          }
        } catch (error) {
          console.error("Error getting county from coordinates:", error);
        }
        return null;
      }

      function showProjectInfo(project) {
        const infoBox = document.getElementById("projectInfo");
        infoBox.classList.remove("hidden");
        infoBox.innerHTML = `
            <h3 class="mb-4 text-xl font-bold text-gray-800">${
              project.name
            }</h3>
            <p class="mb-2"><strong>Description:</strong> ${
              project.description
            }</p>
            <p class="mb-2"><strong>Region:</strong> ${project.region}${
          project.subCounty ? ", " + project.subCounty : ""
        }</p>
            <p class="mb-2"><strong>Budget:</strong> ${project.budget}</p>
            <p class="mb-2"><strong>Theme:</strong> ${
              project.theme || "N/A"
            }</p>
            <p class="mb-2"><strong>Activity Type:</strong> ${
              project.activityType || "N/A"
            }</p>
            <p class="mb-2"><strong>Contact Person:</strong> ${project.team}</p>
            ${
              project.contactPersonEmail
                ? `<p class="mb-2"><strong>Email:</strong> ${project.contactPersonEmail}</p>`
                : ""
            }
            <p class="mb-2"><strong>Sponsor:</strong> ${project.sponsor}</p>
            <p class="mb-2"><strong>Start Date:</strong> ${new Date(
              project.start_date
            ).toLocaleDateString()}</p>
            ${
              project.end_date
                ? `<p class="mb-2"><strong>End Date:</strong> ${new Date(
                    project.end_date
                  ).toLocaleDateString()}</p>`
                : ""
            }
            <p class="mb-2"><strong>Status:</strong> <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge(
              project.status
            )}">${project.status.toUpperCase()}</span></p>
        `;
      }

      function focusMarker(index) {
        const marker = mapMarkers[index];
        if (marker && marker.data) {
          map.flyTo({ center: [marker.data.lng, marker.data.lat], zoom: 9 });
          showProjectInfo(marker.data);
          document
            .getElementById("kenyaMap")
            .scrollIntoView({ behavior: "smooth" });
        }
      }

      function sortProjects(field) {
        if (sortBy === field) {
          sortOrder = sortOrder === "asc" ? "desc" : "asc";
        } else {
          sortBy = field;
          sortOrder = "asc";
        }
        currentPage = 1;
        highlightMarkers(currentFilter);
      }

      function highlightMarkers(tag) {
        currentFilter = tag;
        const accordion = document.getElementById("projectAccordion");
        const infoBox = document.getElementById("projectInfo");
        if (infoBox) infoBox.classList.add("hidden");
        if (accordion) {
          accordion.innerHTML = "";
          accordion.classList.remove("hidden");
          accordion.classList.add("opacity-0", "translate-y-4");
        }

        let filteredMarkers = mapMarkers.filter((marker) => {
          const p = marker.data;
          if (tag !== "all" && marker.tag !== tag) return false;
          if (searchQuery && !p.name.toLowerCase().includes(searchQuery))
            return false;
          const pDate = new Date(p.start_date);
          if (dateRangeFrom && pDate < dateRangeFrom) return false;
          if (dateRangeTo && pDate > dateRangeTo) return false;
          return true;
        });

        filteredMarkers.sort((a, b) => {
          const aVal =
            sortBy === "name" ? a.data.name : new Date(a.data.start_date);
          const bVal =
            sortBy === "name" ? b.data.name : new Date(b.data.start_date);
          return sortOrder === "asc"
            ? aVal > bVal
              ? 1
              : -1
            : aVal < bVal
            ? 1
            : -1;
        });

        const totalPages = Math.ceil(filteredMarkers.length / itemsPerPage);
        const paginated = filteredMarkers.slice(
          (currentPage - 1) * itemsPerPage,
          currentPage * itemsPerPage
        );
        updatePaginationControls(totalPages);

        mapMarkers.forEach((marker) => {
          const el = marker.getElement();
          if (el) {
            el.style.opacity = filteredMarkers.includes(marker) ? "1" : "0.2";
          }
        });

        if (accordion) {
          setTimeout(
            () => accordion.classList.remove("opacity-0", "translate-y-4"),
            10
          );

          paginated.forEach((marker, idx) => {
            const i = mapMarkers.indexOf(marker);
            const project = marker.data;
            const bg = bgColors[project.status] || bgColors.default;

            const item = document.createElement("div");
            item.className = `rounded shadow-sm ${bg}`;

            item.innerHTML = `
                  <button class="w-full px-6 py-4 text-left border-b focus:outline-none" data-toggle="collapse-${i}">
                      <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                          <div>
                              <h4 class="text-lg font-semibold text-gray-800">${
                                project.name
                              }</h4>
                              <p class="text-sm text-gray-600">${
                                project.description
                              }</p>
                          </div>
                          <div class="mt-2 text-sm text-gray-500 sm:mt-0">${new Date(
                            project.start_date
                          ).toLocaleDateString()}</div>
                      </div>
                  </button>
                  <div id="collapse-${i}" class="hidden px-6 py-4 bg-white">
                      <p class="mb-2"><strong>Region:</strong> ${
                        project.region
                      }${project.subCounty ? ", " + project.subCounty : ""}</p>
                      ${
                        project.theme
                          ? `<p class="mb-2"><strong>Theme:</strong> ${project.theme}</p>`
                          : ""
                      }
                      ${
                        project.activityType
                          ? `<p class="mb-2"><strong>Activity Type:</strong> ${project.activityType}</p>`
                          : ""
                      }
                      <p class="mb-2"><strong>Budget:</strong> ${
                        project.budget
                      }</p>
                      <p class="mb-2"><strong>Contact Person:</strong> ${
                        project.team
                      }</p>
                      ${
                        project.contactPersonEmail
                          ? `<p class="mb-2"><strong>Email:</strong> ${project.contactPersonEmail}</p>`
                          : ""
                      }
                      <p class="mb-2"><strong>Sponsor:</strong> ${
                        project.sponsor
                      }</p>
                      ${
                        project.end_date
                          ? `<p class="mb-2"><strong>End Date:</strong> ${new Date(
                              project.end_date
                            ).toLocaleDateString()}</p>`
                          : ""
                      }
                      <p class="mb-2"><strong>Status:</strong> <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge(
                        project.status
                      )}">${project.status.toUpperCase()}</span></p>
                      <button onclick="focusMarker(${i})" class="px-5 py-2 mt-3 text-sm font-semibold text-white transition bg-blue-600 rounded hover:bg-blue-700 hover:scale-105">
                          Show on Map
                      </button>
                  </div>
              `;

            accordion.appendChild(item);

            item
              .querySelector(`[data-toggle="collapse-${i}"]`)
              .addEventListener("click", () => {
                document
                  .getElementById(`collapse-${i}`)
                  .classList.toggle("hidden");
              });
          });
        }
      }

      function updatePaginationControls(totalPages) {
        const container = document.getElementById("paginationControls");
        container.innerHTML = "";
        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          btn.className = `px-3 py-1 rounded ${
            i === currentPage
              ? "bg-blue-600 text-white"
              : "bg-gray-100 text-gray-800 hover:bg-gray-200"
          }`;
          btn.onclick = () => {
            currentPage = i;
            highlightMarkers(currentFilter);
          };
          container.appendChild(btn);
        }
      }

      function exportCSV() {
        const headers = [
          "ID",
          "Name",
          "Description",
          "Region",
          "Sub County",
          "Theme",
          "Activity Type",
          "Budget",
          "Contact Person",
          "Email",
          "Sponsor",
          "Start Date",
          "End Date",
          "Status",
        ];
        const rows = mapMarkers
          .map((m) => m.data)
          .filter((p) => {
            if (searchQuery && !p.name.toLowerCase().includes(searchQuery))
              return false;
            const date = new Date(p.start_date);
            if (dateRangeFrom && date < dateRangeFrom) return false;
            if (dateRangeTo && date > dateRangeTo) return false;
            if (currentFilter !== "all" && p.status !== currentFilter)
              return false;
            return true;
          })
          .map((p) => [
            p.id || "",
            p.name,
            p.description,
            p.region,
            p.subCounty || "",
            p.theme || "",
            p.activityType || "",
            p.budget,
            p.team,
            p.contactPersonEmail || "",
            p.sponsor,
            new Date(p.start_date).toLocaleDateString(),
            p.end_date ? new Date(p.end_date).toLocaleDateString() : "",
            p.status,
          ]);

        let csvContent = [headers.join(",")];
        rows.forEach((r) =>
          csvContent.push(r.map((field) => `"${field}"`).join(","))
        );

        const blob = new Blob([csvContent.join("\n")], { type: "text/csv" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `projects_${
          new Date().toISOString().split("T")[0]
        }.csv`;
        link.click();
      }

      // Helper function to capitalize words
      function capitalizeWords(str) {
        if (!str) return str;
        return str
          .split("-")
          .map(
            (word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
          )
          .join(" ");
      }

      // Handle project form submission
      async function handleProjectSubmission(event) {
        event.preventDefault(); // Prevent default form submission

        console.log(" Starting project submission...");

        // Check authentication
        if (!authManager || !authManager.isAuthenticated()) {
          alert(
            "You must be logged in to create a project. Please log in first."
          );
          window.location.href = "../index.html";
          return;
        }

        // Get form data
        const form = event.target;
        const rawFormData = new FormData(form);
        const filesInput = form.querySelector("#supporting_documents");

        // Collect multiple themes
        const selectedThemes = rawFormData.getAll("theme[]");
        // Collect multiple locations
        const latitudes = rawFormData.getAll("latitude[]");
        const longitudes = rawFormData.getAll("longitude[]");
        const counties = rawFormData.getAll("county[]");
        const subcounties = rawFormData.getAll("subcounty[]");
        const locations = [];
        for (let i = 0; i < latitudes.length; i++) {
          locations.push({
            latitude: parseFloat(latitudes[i]),
            longitude: parseFloat(longitudes[i]),
            county: counties[i] || null,
            subCounty: subcounties[i] || null,
            mapsAddress: `${counties[i] || ""}${
              subcounties[i] ? ", " + subcounties[i] : ""
            }, Kenya`.trim(),
          });
        }

        // Build the project object
        const projectObj = {
          partner: rawFormData.get("partner"),
          title: rawFormData.get("title"),
          themes: selectedThemes,
          projectCategory: rawFormData.get("category"),
          startDate: rawFormData.get("start_date"),
          endDate: rawFormData.get("end_date"),
          activityType: rawFormData.get("activity_type"),
          locations: locations,
          contactPersonName: rawFormData.get("contact_person_name"),
          contactPersonRole: rawFormData.get("contact_person_role"),
          contactPersonEmail: rawFormData.get("contact_person_mail"),
          objectives: rawFormData.get("gaps"),
          budget: parseFloat(rawFormData.get("budget")) || 0,
        };

        // Create new FormData for submission
        const submitFormData = new FormData();
        const projectBlob = new Blob([JSON.stringify(projectObj)], {
          type: "application/json",
        });
        submitFormData.append("project", projectBlob, "project.json");
        if (filesInput && filesInput.files.length > 0) {
          for (let i = 0; i < filesInput.files.length; i++) {
            submitFormData.append("supporting_documents", filesInput.files[i]);
          }
        }

        // Debug: Log all form data including files
        console.log(" FormData to be sent:");
        for (let pair of submitFormData.entries()) {
          if (pair[1] instanceof File) {
            console.log(
              `  ${pair[0]}: [File] name=${pair[1].name}, type=${pair[1].type}, size=${pair[1].size}`
            );
          } else {
            console.log(`  ${pair[0]}: "${pair[1]}"`);
          }
        }

        // Ensure global markers array exists and is usable here
        if (typeof markers === "undefined" || !Array.isArray(markers)) {
          console.warn(
            "markers not defined  initializing global markers array"
          );
          window.markers = window.markers || [];
          markers = window.markers;
        }

        // Prepare project data according to API documentation
        const projectData = {
          partner: "TBD", // This should come from user's organization
          title: rawFormData.get("title"),
          themes: selectedThemes,
          projectCategory: rawFormData.get("category"),
          startDate: rawFormData.get("start_date"),
          endDate: rawFormData.get("end_date"),
          activityType: rawFormData.get("activity_type"),
          locations: locations,
          contactPersonName: rawFormData.get("contact_person_name"),
          contactPersonRole: rawFormData.get("contact_person_role"),
          contactPersonEmail: rawFormData.get("contact_person_mail"),
          objectives: rawFormData.get("gaps"),
          budget: parseFloat(rawFormData.get("budget")) || 0,
        };

        console.log(" Project data to submit:", projectData);

        // Validate required fields by checking form data directly
        const requiredFormFields = [
          { field: "title", label: "Title" },
          { field: "category", label: "Project Category" },
          { field: "start_date", label: "Start Date" },
          { field: "end_date", label: "End Date" },
          { field: "activity_type", label: "Activity Type" },
          { field: "contact_person_name", label: "Contact Person Name" },
          { field: "contact_person_role", label: "Contact Person Role" },
          { field: "contact_person_mail", label: "Contact Person Email" },
          { field: "gaps", label: "Objectives" },
        ];

        const missingFields = requiredFormFields.filter((fieldObj) => {
          const value = rawFormData.get(fieldObj.field);
          return !value || value.trim() === "";
        });

        // Check for at least one theme
        if (selectedThemes.length === 0) {
          missingFields.push({
            field: "theme",
            label: "At least one Project Theme",
          });
        }

        // Check for at least one location
        if (locations.length === 0) {
          missingFields.push({
            field: "location",
            label: "At least one Project Location",
          });
        }

        if (missingFields.length > 0) {
          const missingLabels = missingFields.map((f) => f.label);
          alert(
            `Please fill in all required fields:\n ${missingLabels.join(
              "\n "
            )}`
          );

          // Focus on the first missing field
          const firstMissingField = form.querySelector(
            `[name="${missingFields[0].field}"]`
          );
          if (firstMissingField) {
            firstMissingField.focus();
            firstMissingField.scrollIntoView({
              behavior: "smooth",
              block: "center",
            });
          }
          return;
        }

        // Show loading state
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = "Creating Project...";

        try {
          // Get current user to set partner
          const user = await authManager.getCurrentUser();
          console.log("Current user data:", user);

          // Set partner in FormData
          if (user) {
            if (user.organization && user.organization.name) {
              submitFormData.set("partner", user.organization.name);
            } else if (user.organizationName) {
              formData.set("partner", user.organizationName);
            } else if (user.name) {
              formData.set("partner", user.name);
            }
          }

          console.log(" Submitting to API...");
          // Submit to API using fetch and FormData
          const response = await fetch(
            "https://tujulishane-hub-backend-52b7e709d99f.herokuapp.com/api/projects",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${authManager.getToken()}`,
                // Do NOT set Content-Type for FormData; browser will set it with boundary
              },
              body: submitFormData,
            }
          );

          if (response.ok) {
            const result = await response.json();
            alert(
              "Project created successfully! Your project has been submitted for review."
            );
            form.reset();
            locations.forEach((location) => {
              if (location.marker) {
                location.marker.remove();
              }
            });
            locations.length = 0;
            if (Array.isArray(markers)) markers.length = 0;
            locationInputsDiv.innerHTML = "";
            updateLocationsDisplay();
            const modal = document.querySelector("[data-twe-modal-show]");
            if (modal) {
              try {
                const closeBtn = modal.querySelector(
                  "[data-twe-modal-dismiss]"
                );
                if (closeBtn) closeBtn.click();
              } catch (e) {
                console.log("Could not close modal automatically");
              }
            }
            setTimeout(() => {
              window.location.reload();
            }, 2000);
          } else {
            let errorMessage = "Failed to create project";
            let errorDetails = "";
            try {
              const errorText = await response.text();
              console.error(" Raw error response:", errorText);
              // Try to parse JSON error
              try {
                const errorData = JSON.parse(errorText);
                errorMessage = errorData.message || errorMessage;
                errorDetails = JSON.stringify(errorData, null, 2);
              } catch (jsonErr) {
                errorDetails = errorText;
              }
            } catch (e) {
              errorDetails = String(e);
            }
            console.error(
              ` Submission failed. Status: ${response.status} ${response.statusText}`
            );
            alert(
              `Failed to create project: ${errorMessage}\nStatus: ${response.status} ${response.statusText}\nDetails: ${errorDetails}`
            );
          }
        } catch (error) {
          console.error(" Submission error:", error);
          // Log everything to trace
          try {
            // Deep diagnostic logging to trace the error source
            console.groupCollapsed(" Project submission error trace");
            console.error("Caught error:", error);
            if (error && error.stack)
              console.error("Stack trace:", error.stack);

            // Safe stringify helper to avoid circular reference crashes
            const safeStringify = (obj) => {
              try {
                return JSON.stringify(
                  obj,
                  function (k, v) {
                    if (typeof v === "function")
                      return `[Function ${v.name || "anonymous"}]`;
                    return v;
                  },
                  2
                );
              } catch (e) {
                return String(obj);
              }
            };

            // Form & payload diagnostics
            try {
              console.log("Form element:", form || "N/A");
              // Collect FormData entries
              const fd = {};
              if (formData && typeof formData.entries === "function") {
                for (const [k, v] of formData.entries()) {
                  if (!fd[k]) fd[k] = [];
                  fd[k].push(v);
                }
              }
              console.log("FormData entries:", fd);
            } catch (e) {
              console.warn("Could not enumerate FormData:", e);
            }

            console.log(
              "Project payload (projectData):",
              safeStringify(projectData)
            );
            console.log("Collected locations:", safeStringify(locations || []));
            try {
              // Provide marker positions summary if available
              const markerSummary = (markers || []).map((m, i) => {
                try {
                  const lngLat =
                    m && typeof m.getLngLat === "function"
                      ? m.getLngLat()
                      : m && (m.lng || m.longitude)
                      ? { lng: m.lng || m.longitude, lat: m.lat || m.latitude }
                      : null;
                  return {
                    index: i,
                    lng: lngLat ? lngLat.lng : null,
                    lat: lngLat ? lngLat.lat : null,
                  };
                } catch (e) {
                  return { index: i, error: String(e) };
                }
              });
              console.log("Markers summary:", markerSummary);
            } catch (e) {
              console.warn("Could not summarize markers:", e);
            }

            // Auth & environment diagnostics
            try {
              if (typeof authManager !== "undefined") {
                console.log("AuthManager (type):", typeof authManager);
                if (typeof authManager.getToken === "function") {
                  try {
                    console.log(
                      "Auth token (masked):",
                      (authManager.getToken() || "").slice(0, 8) + "(masked)"
                    );
                  } catch (e) {
                    console.warn("Could not read token:", e);
                  }
                }
                if (typeof authManager.getCurrentUser === "function") {
                  try {
                    console.log(
                      "Current user (safe):",
                      safeStringify(
                        await authManager
                          .getCurrentUser()
                          .catch((e) => ({ error: String(e) }))
                      )
                    );
                  } catch (e) {
                    console.warn("Could not read current user:", e);
                  }
                }
              } else {
                console.log("authManager is undefined");
              }
            } catch (e) {
              console.warn("Auth diagnostics failed:", e);
            }

            // Browser / network info
            try {
              console.log("Navigator info:", {
                online: navigator.onLine,
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
              });
            } catch (e) {
              console.warn("Navigator diagnostics failed:", e);
            }

            // Storage snapshot (keys only)
            try {
              console.log(
                "LocalStorage keys:",
                typeof localStorage !== "undefined"
                  ? Object.keys(localStorage)
                  : "localStorage unavailable"
              );
              console.log(
                "SessionStorage keys:",
                typeof sessionStorage !== "undefined"
                  ? Object.keys(sessionStorage)
                  : "sessionStorage unavailable"
              );
            } catch (e) {
              console.warn("Storage diagnostics failed:", e);
            }

            console.groupEnd();
          } catch (logErr) {
            // Ensure logging itself does not break the submission flow
            console.error("Error while collecting diagnostics:", logErr);
          }
          alert(
            "Failed to create project. Please check your connection and try again."
          );
        } finally {
          // Restore button state
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      }

      // Initialize authentication when page loads
      document.addEventListener("DOMContentLoaded", async function () {
        console.log(" Checking authentication...");

        if (!authManager || !authManager.isAuthenticated()) {
          console.warn(" User not authenticated, redirecting to login...");
          alert("You must be logged in to access this page.");
          window.location.href = "../index.html";
          return;
        }

        try {
          const user = await authManager.getCurrentUser();
          console.log(" Current user:", user);

          // Update UI with user info if needed
          if (user && user.name) {
            // You can update user display elements here
            console.log(`Welcome, ${user.name}!`);
          }
        } catch (error) {
          console.error("Error getting user info:", error);
        }
      });
    </script>

    <script>
      const counties = ["Nairobi", "Mombasa", "Kisumu", "Nakuru", "Eldoret"];
      const subCounties = [
        "Westlands",
        "Langata",
        "Likoni",
        "Kisumu Central",
        "Nakuru East",
        "Eldoret North",
      ];
      const types = ["Hospital", "Clinic", "Health Center", "Dispensary"];
      const statuses = ["Active", "Closed", "Pending"];

      function getRandomItem(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
      }

      async function getCoordinates(place) {
        const accessToken = mapboxgl.accessToken;
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(
          place + ", Kenya"
        )}.json?access_token=${accessToken}`;
        try {
          const response = await fetch(url);
          const data = await response.json();
          if (data.features && data.features.length > 0) {
            return data.features[0].center;
          }
        } catch (e) {
          console.error("Geocoding failed for", place, e);
        }
        // fallback to Nairobi
        return [36.8219, -1.2921];
      }

      async function generateFacilities(n = 10) {
        const facilities = [];
        for (let i = 0; i < n; i++) {
          const county = getRandomItem(counties);
          const subCounty = getRandomItem(subCounties);
          const type = getRandomItem(types);
          const status = getRandomItem(statuses);
          const place = `${subCounty}, ${county}`;
          const coords = await getCoordinates(place);
          facilities.push({
            id: i + 1,
            name: `${type} in ${subCounty}`,
            county,
            subCounty,
            type,
            status,
            longitude: coords[0],
            latitude: coords[1],
            contacts: `0700${100000 + i}`,
          });
        }
        return facilities;
      }

      let allFacilities = [];
      let filteredFacilities = [];
      let selectedFacility = null;

      // Generate facilities and initialize map pins
      async function initFacilities() {
        allFacilities = await generateFacilities(10);
        filteredFacilities = [...allFacilities];
        showFacilitiesOnMap(filteredFacilities);
      }

      function populateDropdown(id, items) {
        const dropdown = document.getElementById(id);
        items.forEach((item) => {
          const option = document.createElement("option");
          option.value = item;
          option.textContent = item;
          dropdown.appendChild(option);
        });
      }
      populateDropdown("countyDropdown", counties);
      populateDropdown("subCountyDropdown", subCounties);
      populateDropdown("typeDropdown", types);
      populateDropdown("statusDropdown", statuses);

      // Add search bar above the map
      const mapContainer = document.getElementById("newProjectMap");
      if (mapContainer) {
        const searchDiv = document.createElement("div");
        searchDiv.style.display = "flex";
        searchDiv.style.justifyContent = "center";
        searchDiv.style.marginBottom = "12px";
        searchDiv.innerHTML = `
          <input id="facilitySearchBar" type="text" placeholder="Search facilities..." style="padding:8px 16px; width:300px; border-radius:6px; border:1px solid #ccc; font-size:16px;">
        `;
        mapContainer.parentNode.insertBefore(searchDiv, mapContainer);
      }

      mapboxgl.accessToken =
        "pk.eyJ1IjoibG9tb2dhbnRlY2giLCJhIjoiY2xzOTcyYXdlMDUxZDJsbXRnZGh2ZmpoYyJ9.sIWvONzgGPF2rtAcECsrJQ";
      const map = new mapboxgl.Map({
        container: "newProjectMap",
        style: "mapbox://styles/mapbox/streets-v11",
        center: [36.8219, -1.2921],
        zoom: 7,
      });

      let mapMarkers = [];

      function clearMarkers() {
        mapMarkers.forEach((m) => m.remove());
        mapMarkers = [];
      }

      function showFacilitiesOnMap(facilities) {
        clearMarkers();
        facilities.forEach((facility) => {
          const el = document.createElement("div");
          el.className = "marker";
          el.style.background =
            selectedFacility && selectedFacility.id === facility.id
              ? "#1e40af"
              : "#f59e0b";
          el.style.width = "24px";
          el.style.height = "24px";
          el.style.borderRadius = "50%";
          el.style.border = "2px solid #fff";
          el.style.cursor = "pointer";

          const marker = new mapboxgl.Marker(el)
            .setLngLat([facility.longitude, facility.latitude])
            .setPopup(
              new mapboxgl.Popup({ offset: 25 }).setHTML(
                `<strong>${facility.name}</strong><br>County: ${facility.county}<br>Sub-County: ${facility.subCounty}<br>Type: ${facility.type}<br>Status: ${facility.status}<br>Contacts: ${facility.contacts}<br><button onclick='window.selectFacility(${facility.id})'>Select Facility</button>`
              )
            )
            .addTo(map);
          mapMarkers.push(marker);
        });
      }

      window.selectFacility = function (id) {
        selectedFacility = allFacilities.find((f) => f.id === id);
        showFacilitiesOnMap(filteredFacilities);
        document.getElementById("title").value =
          selectedFacility.name + " Project";
        document.getElementById(
          "selectedLocations"
        ).innerHTML = `<li>${selectedFacility.name} (${selectedFacility.county}, ${selectedFacility.subCounty})</li>`;
      };

      function filterFacilities() {
        const county = document.getElementById("countyDropdown").value;
        const subCounty = document.getElementById("subCountyDropdown").value;
        const type = document.getElementById("typeDropdown").value;
        const status = document.getElementById("statusDropdown").value;
        const searchText =
          document.getElementById("facilitySearchBar")?.value?.toLowerCase() ||
          "";
        filteredFacilities = allFacilities.filter(
          (f) =>
            (county === "" || f.county === county) &&
            (subCounty === "" || f.subCounty === subCounty) &&
            (type === "" || f.type === type) &&
            (status === "" || f.status === status) &&
            (searchText === "" || f.name.toLowerCase().includes(searchText))
        );
        showFacilitiesOnMap(filteredFacilities);
      }

      [
        "countyDropdown",
        "subCountyDropdown",
        "typeDropdown",
        "statusDropdown",
      ].forEach((id) => {
        document
          .getElementById(id)
          .addEventListener("change", filterFacilities);
      });

      // Add search bar event listener
      document.addEventListener("DOMContentLoaded", function () {
        const searchBar = document.getElementById("facilitySearchBar");
        if (searchBar) {
          searchBar.addEventListener("input", filterFacilities);
        }
      });

      map.on("load", () => {
        initFacilities();
      });
    </script>
  </body>
</html>
