<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RMNCAH</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Tailwind CSS (with custom config using inline script) -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#1e40af", // Custom Blue
              secondary: "#f59e0b", // Custom Amber
              accent: "#10b981", // Custom Green
              dark: "#1f2937", // Gray-800
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="styles/main.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css"
    />
    <script src="styles/main.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
      integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css"
      rel="stylesheet"
    />
    <!-- Alpine.js -->
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <!-- Leaflet JS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha384-sA+RlRzF8YK8EeQx09sEtc06CXi1K06oBJJSM6Ox9B8JeN5aZzffR28E/zTGmLXN"
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha384-O3FJxqIQW2STXQKKFePx5FKP8uXpTYBJ+Al9VwZpyaXx1V4u1ZbE1cBGTSrBocjz"
      crossorigin=""
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- Backend URL Configuration - MUST BE LOADED FIRST -->
    <script src="./config.js"></script>
    <script src="./set-base-url.js"></script>

    <!-- Optional: Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css"
    />
    <script type="module">
      // Try to load a local config override (frontend/config.local.js) if present.
      (function () {
        try {
          var s = document.createElement("script");
          s.src = "./config.local.js";
          s.async = false;
          document.head.appendChild(s);
        } catch (e) {}
      })();

      // Use window.BASE_URL which is already set by config.js loaded via script tag
      const BASE_URL = window.BASE_URL;
      console.log(
        "[dashboard.html] Using BASE_URL:",
        BASE_URL,
        "- Environment:",
        window.USE_PROD ? "PRODUCTION" : "DEVELOPMENT"
      );
    </script>
    <script src="auth.js"></script>

    <style>
      .fade-slide-enter {
        opacity: 0;
        transform: translateY(20px);
      }

      .fade-slide-enter-active {
        opacity: 1;
        transform: translateY(0);
        transition: all 0.4s ease;
      }

      .fade-slide-leave {
        opacity: 1;
        transform: translateY(0);
      }

      .fade-slide-leave-active {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
      }
    </style>
  </head>

  <body class="text-gray-800">
    <script>
      // AuthManager instance
      const authManager = new AuthManager();
      let dashboardStats = {};
      let dashboardProjects = [];
      let dashboardOrgs = [];
      let dashboardTopics = [];
      let dashboardStatusCounts = {};
      let dashboardMapProjects = [];

      document.addEventListener("DOMContentLoaded", async function () {
        if (!authManager.isAuthenticated()) {
          alert("You must be logged in to access the dashboard.");
          window.location.href = "frontend/index.html";
          return;
        }
        try {
          await loadDashboardStats();
          await loadDashboardProjects();
          renderDashboardStats();
          renderCharts();
          renderMap();
        } catch (e) {
          console.error("Dashboard load error:", e);
          showDashboardError();
        }
      });

      async function loadDashboardStats() {
        // Load statistics from /api/projects/statistics
        const resp = await authManager.apiCall(
          "/api/projects/statistics",
          "GET"
        );
        if (resp.ok) {
          const data = await resp.json();
          dashboardStats = data.data || {};
          dashboardStatusCounts = dashboardStats.statusCounts || {};
        } else {
          throw new Error("Failed to load statistics");
        }
      }

      async function loadDashboardProjects() {
        // Load all projects (for map, charts, etc)
        const resp = await authManager.apiCall("/api/projects", "GET");
        if (resp.ok) {
          const data = await resp.json();
          dashboardProjects =
            data.data && data.data.content ? data.data.content : [];
          dashboardMapProjects = dashboardProjects.filter(
            (p) => p.latitude && p.longitude
          );
        } else {
          throw new Error("Failed to load projects");
        }
      }

      function renderDashboardStats() {
        // Status summary
        const statusMap = {
          approved: dashboardStatusCounts["ACTIVE"] || 0,
          pending: dashboardStatusCounts["PENDING"] || 0,
          stalled: dashboardStatusCounts["STALLED"] || 0,
          abandoned: dashboardStatusCounts["COMPLETED"] || 0,
        };
        document
          .querySelectorAll(".p-4.bg-green-50 .text-3xl")
          .forEach((e) => (e.textContent = statusMap.approved));
        document
          .querySelectorAll(".p-4.bg-yellow-50 .text-3xl")
          .forEach((e) => (e.textContent = statusMap.pending));
        document
          .querySelectorAll(".p-4.bg-red-50 .text-3xl")
          .forEach((e) => (e.textContent = statusMap.stalled));
        document
          .querySelectorAll(".p-4.bg-gray-50 .text-3xl")
          .forEach((e) => (e.textContent = statusMap.abandoned));

        // Example: update other stats (avg cost, top county, etc) if available
        // ...
      }

      function renderCharts() {
        // Example: update ApexCharts with real data
        // You may need to re-initialize or update the chart options with dashboardProjects
        // For now, just re-render the orgChart and barChart with dummy data
        // TODO: Replace with real aggregation from dashboardProjects
        if (window.ApexCharts) {
          // Org chart (by org type)
          let orgTypeCounts = { Implementing: 0, Development: 0 };
          dashboardProjects.forEach((p) => {
            if (p.organizationType === "IMPLEMENTING")
              orgTypeCounts.Implementing++;
            else if (p.organizationType === "DEVELOPMENT")
              orgTypeCounts.Development++;
          });
          let orgChart = new ApexCharts(document.querySelector("#orgChart"), {
            chart: { type: "donut", height: 350 },
            series: [orgTypeCounts.Implementing, orgTypeCounts.Development],
            labels: ["Implementing", "Development"],
            colors: ["#A08BFB", "#FFF560"],
            legend: { position: "bottom" },
            dataLabels: { enabled: true },
          });
          orgChart.render();

          // Bar chart (by topic)
          let topicCounts = {};
          dashboardProjects.forEach((p) => {
            if (p.theme) topicCounts[p.theme] = (topicCounts[p.theme] || 0) + 1;
          });
          let topics = Object.keys(topicCounts);
          let topicVals = topics.map((t) => topicCounts[t]);
          let barChart = new ApexCharts(document.querySelector("#barChart"), {
            chart: { type: "bar", height: 400 },
            series: [{ name: "Projects", data: topicVals }],
            xaxis: { categories: topics },
            legend: { position: "top" },
          });
          barChart.render();
        }
      }

      function renderMap() {
        // Remove static markers, use dashboardMapProjects
        if (!window.L) return;
        let map = L.map("kenyaMap", {
          center: [-0.0236, 37.9062],
          zoom: 6.3,
          scrollWheelZoom: false,
          dragging: true,
          touchZoom: false,
          doubleClickZoom: true,
          boxZoom: false,
          keyboard: false,
          zoomControl: true,
        });
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);
        dashboardMapProjects.forEach((p) => {
          if (p.latitude && p.longitude) {
            L.marker([p.latitude, p.longitude])
              .addTo(map)
              .bindTooltip(p.name || p.title || "Project");
          }
        });
      }

      function showDashboardError() {
        alert("Failed to load dashboard data. Please try again later.");
      }
    </script>
    <div
      data-twe-modal-init
      class="fixed left-0 top-0 backdrop-blur-md z-[1055] hidden h-full w-full overflow-y-auto overflow-x-hidden outline-none"
      id="createNewProject"
      tabindex="-1"
      aria-labelledby="createNewProjectTitle"
      aria-modal="true"
      role="dialog"
    >
      <div
        data-twe-modal-dialog-ref
        class="pointer-events-none relative flex min-h-[calc(100%-1rem)] w-auto translate-y-[-50px] items-center opacity-0 transition-all duration-300 ease-in-out min-[576px]:mx-auto min-[576px]:mt-7 min-[576px]:max-w-[500px] min-[992px]:max-w-[800px] min-[1200px]:max-w-[1140px]"
      >
        <div
          class="relative flex flex-col w-full text-current bg-white border-none rounded-md outline-none pointer-events-auto bg-clip-padding shadow-4"
        >
          <div
            class="flex items-center justify-between flex-shrink-0 p-4 border-b-2 rounded-t-md border-neutral-100"
          >
            <!-- Modal title -->
            <h5
              class="text-xl font-light uppercase leading-normal text-surface"
              id="createNewProjectTitle"
            >
              New Project
            </h5>
            <!-- Close button -->
            <button
              type="button"
              class="box-content border-none rounded-none text-neutral-500 hover:text-neutral-800 hover:no-underline focus:text-neutral-800 focus:opacity-100 focus:shadow-none focus:outline-none"
              data-twe-modal-dismiss
              aria-label="Close"
            >
              <span class="[&>svg]:h-6 [&>svg]:w-6">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M6 18L18 6M6 6l12 12"
                  />
                </svg>
              </span>
            </button>
          </div>

          <!-- Modal body -->
          <div class="relative p-4">
            <form id="newProjectForm">
              <div class="grid grid-cols-2 gap-4 lg:grid-cols-4">
                <!-- Map Picker for Location -->
                <div class="col-span-2 lg:col-span-4">
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Pick Project Location on Map</label
                  >
                  <div class="text-xs text-gray-600 mb-2">
                    Search for a location or click on the map to select the
                    project coordinates.
                  </div>
                  <div
                    id="newProjectMap"
                    style="
                      height: 400px;
                      width: 100%;
                      border-radius: 8px;
                      margin-bottom: 8px;
                      border: 1px solid #e5e7eb;
                      background-color: #f3f4f6;
                      position: relative;
                      overflow: hidden;
                    "
                  ></div>
                  <input type="hidden" id="project_latitude" name="latitude" />
                  <input
                    type="hidden"
                    id="project_longitude"
                    name="longitude"
                  />
                  <input type="hidden" id="project_county" name="county" />
                  <input
                    type="hidden"
                    id="project_subcounty"
                    name="subcounty"
                  />
                  <div
                    class="text-sm text-gray-700 mt-2 p-2 bg-gray-50 rounded"
                  >
                    <strong>Selected Location:</strong>
                    <span id="selectedLatLng" class="font-mono text-blue-600"
                      >Click on map to select location</span
                    >
                    <br />
                    <span id="selectedCounty" class="text-gray-600"></span>
                  </div>
                </div>
                <!-- Title -->
                <div>
                  <label
                    for="title"
                    class="block text-sm font-medium text-gray-700"
                    >Title *</label
                  >
                  <input
                    required
                    type="text"
                    id="title"
                    name="title"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>

                <!-- Project Theme -->
                <div>
                  <label
                    for="theme"
                    class="block text-sm font-medium text-gray-700"
                    >Project Theme *</label
                  >
                  <select
                    id="theme"
                    name="theme"
                    class="block w-full p-2 mt-1 text-black bg-white border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  >
                    <option value="">Select Theme</option>
                    <option value="GBV">Gender based violence</option>
                    <option value="AYPSRH">
                      Adolescent and Young People Sexual and Reproductive Health
                    </option>
                    <option value="MNH">Maternal and Newborn Health</option>
                    <option value="FP">Family planning</option>
                    <option value="CH">Child Health</option>
                    <option value="AH">Adolescent Health</option>
                  </select>
                </div>

                <!-- Time Period -->
                <div>
                  <label
                    for="starttime_period"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Start *
                  </label>
                  <input
                    required
                    type="date"
                    id="starttime_period"
                    name="start_date"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="endtime_period"
                    class="block text-sm font-medium text-gray-700"
                    >End *</label
                  >
                  <input
                    type="date"
                    id="endtime_period"
                    name="end_date"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <!-- Activity Type -->
                <div class="col-span-2 md:col-span-4">
                  <label
                    for="activity_type"
                    class="block text-sm font-medium text-gray-700"
                    >Activity Type (Description) *
                  </label>
                  <textarea
                    required
                    id="activity_type"
                    name="activity_type"
                    rows="3"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  ></textarea>
                </div>

                <!-- County and Sub-county fields removed (not required) -->

                <!-- Contact Person -->
                <div>
                  <label
                    for="contact_person"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Contact Person Name *
                  </label>
                  <input
                    required
                    type="text"
                    id="contact_person"
                    name="contact_person_name"
                    placeholder="Name"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="contact_person"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Contact Person Role *
                  </label>
                  <input
                    required
                    type="text"
                    id="contact_person"
                    name="contact_person_role"
                    placeholder="Role"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="contact_person"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Contact Person Email *
                  </label>
                  <input
                    required
                    type="email"
                    id="contact_person"
                    name="contact_person_mail"
                    placeholder="Email"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="budget"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Budget in KES
                  </label>
                  <input
                    required
                    type="number"
                    id="budget"
                    name="budget"
                    placeholder="amount"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>

                <!-- Gaps -->
                <div class="col-span-2 lg:col-span-4">
                  <label
                    for="gaps"
                    class="block text-sm font-medium text-gray-700"
                  >
                    Objectives *
                  </label>
                  <textarea
                    required
                    id="gaps"
                    name="gaps"
                    rows="3"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  ></textarea>
                </div>
              </div>

              <!-- Button -->
              <div class="mt-3">
                <button
                  type="submit"
                  class="inline-flex justify-center w-full px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                  Submit Project
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="" id="nav-placeholder"></div>

    <section class="pt-16 mt-20 bg-cyan-800 sm:pt-20">
      <div
        class="grid max-w-6xl px-4 py-8 mx-auto text-white sm:px-6 lg:px-8 md:grid-cols-5"
      >
        <div class="md:col-span-4">
          <h1 class="mb-2 text-4xl font-semibold md:text-4xl">
            RMNCAH Hub Admn Portal
          </h1>
          <p class="text-[16px] mb-6 max-w-2xl">
            Welcome back, <span class="font-bold">John</span>! Here is a quick
            overview of the system statistics and your recent activities.
          </p>
        </div>
        <div class="md:col-span-1">
          <h6
            class="mt-4 mb-1 mb-2 text-sm font-semibold leading-tight text-center uppercase"
          >
            Admin Actions
          </h6>
          <div class="grid gap-4 text-white">
            <button
              data-twe-toggle="modal"
              data-twe-target="#createNewUser"
              class="flex items-center justify-between px-4 py-2 rounded-full bg-cyan-600"
            >
              <span class="text-sm"> New Admin </span>
              <span class="text-sm">
                <i class="far fa-user-plus"></i>
              </span>
            </button>
            <button
              data-twe-toggle="modal"
              data-twe-target="#createNewUser"
              class="flex items-center justify-between px-4 py-2 rounded-full bg-cyan-600"
            >
              <span class="text-sm"> Access Control </span>
              <span class="text-sm">
                <i class="far fa-user-shield"></i>
              </span>
            </button>
          </div>
        </div>
      </div>
    </section>

    <div class="min-h-screen bg-gray-100">
      <!-- New User -->
      <div
        data-twe-modal-init
        class="fixed left-0 top-0 backdrop-blur-md z-[1055] hidden h-full w-full overflow-y-auto overflow-x-hidden outline-none"
        id="createNewUser"
        tabindex="-1"
        aria-labelledby="createNewUserTitle"
        aria-modal="true"
        role="dialog"
      >
        <div
          data-twe-modal-dialog-ref
          class="pointer-events-none relative flex min-h-[calc(100%-1rem)] w-auto translate-y-[-50px] items-center opacity-0 transition-all duration-300 ease-in-out min-[576px]:mx-auto min-[576px]:mt-7 min-[576px]:max-w-[500px] min-[992px]:max-w-[800px] min-[1200px]:max-w-[1140px]"
        >
          <div
            class="relative flex flex-col w-full text-current bg-white border-none rounded-md outline-none pointer-events-auto bg-clip-padding shadow-4"
          >
            <div
              class="flex items-center justify-between flex-shrink-0 p-4 border-b-2 rounded-t-md border-neutral-100"
            >
              <!-- Modal title -->
              <h5
                class="text-xl font-medium leading-normal text-surface"
                id="createNewUserTitle"
              >
                New User
              </h5>
              <!-- Close button -->
              <button
                type="button"
                class="box-content border-none rounded-none text-neutral-500 hover:text-neutral-800 hover:no-underline focus:text-neutral-800 focus:opacity-100 focus:shadow-none focus:outline-none"
                data-twe-modal-dismiss
                aria-label="Close"
              >
                <span class="[&>svg]:h-6 [&>svg]:w-6">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                </span>
              </button>
            </div>

            <!-- Modal body -->
            <div class="relative p-4">
              <form id="userForm" class="space-y-5">
                <!-- First & Last Name -->
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                  <div>
                    <label class="block text-sm font-medium text-gray-700"
                      >First Name</label
                    >
                    <input
                      type="text"
                      name="first_name"
                      required
                      class="block w-full p-2 mt-1 border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700"
                      >Last Name</label
                    >
                    <input
                      type="text"
                      name="last_name"
                      required
                      class="block w-full p-2 mt-1 border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    />
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700"
                      >Role</label
                    >
                    <select
                      name="role"
                      required
                      class="block w-full p-2 mt-1 border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    >
                      <option value="">Select Role...</option>
                      <option>Super Admin</option>
                      <option>Ei</option>
                    </select>
                  </div>

                  <!-- Email -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700"
                      >Email Address</label
                    >
                    <input
                      type="email"
                      name="email"
                      required
                      class="block w-full p-2 mt-1 border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    />
                  </div>
                </div>
                <!-- Submit -->
                <div class="pt-4">
                  <button
                    type="submit"
                    class="w-full px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                  >
                    Create User
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- New Project -->
      <div
        data-twe-modal-init
        class="fixed left-0 top-0 backdrop-blur-md z-[1055] hidden h-full w-full overflow-y-auto overflow-x-hidden outline-none"
        id="createNewProject"
        tabindex="-1"
        aria-labelledby="createNewProjectTitle"
        aria-modal="true"
        role="dialog"
      >
        <div
          data-twe-modal-dialog-ref
          class="pointer-events-none relative flex min-h-[calc(100%-1rem)] w-auto translate-y-[-50px] items-center opacity-0 transition-all duration-300 ease-in-out min-[576px]:mx-auto min-[576px]:mt-7 min-[576px]:max-w-[500px] min-[992px]:max-w-[800px] min-[1200px]:max-w-[1140px]"
        >
          <div
            class="relative flex flex-col w-full text-current bg-white border-none rounded-md outline-none pointer-events-auto bg-clip-padding shadow-4"
          >
            <div
              class="flex items-center justify-between flex-shrink-0 p-4 border-b-2 rounded-t-md border-neutral-100"
            >
              <!-- Modal title -->
              <h5
                class="text-xl font-medium leading-normal text-surface"
                id="createNewProjectTitle"
              >
                New ADMIN Project
              </h5>
              <!-- Close button -->
              <button
                type="button"
                class="box-content border-none rounded-none text-neutral-500 hover:text-neutral-800 hover:no-underline focus:text-neutral-800 focus:opacity-100 focus:shadow-none focus:outline-none"
                data-twe-modal-dismiss
                aria-label="Close"
              >
                <span class="[&>svg]:h-6 [&>svg]:w-6">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    fill="currentColor"
                    viewBox="0 0 24 24"
                    stroke-width="1.5"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      d="M6 18L18 6M6 6l12 12"
                    />
                  </svg>
                </span>
              </button>
            </div>

            <!-- Modal body -->
            <div class="relative p-4">
              <form action="#" method="POST">
                <div
                  class="grid grid-cols-2 gap-4 lg:grid-cols-4"
                  id="newProjectFormFields"
                >
                  <!-- Map Picker for Location -->
                  <div class="col-span-2 lg:col-span-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Pick Project Location on Map</label
                    >
                    <div
                      id="newProjectMap"
                      style="
                        height: 250px;
                        width: 100%;
                        border-radius: 8px;
                        margin-bottom: 8px;
                      "
                    ></div>
                    <input
                      type="hidden"
                      id="project_latitude"
                      name="latitude"
                    />
                    <input
                      type="hidden"
                      id="project_longitude"
                      name="longitude"
                    />
                    <div class="text-xs text-gray-500 mt-1">
                      Click on the map to select the project location. Selected:
                      <span id="selectedLatLng">None</span>
                    </div>
                  </div>
                  <script>
                    // Integrate New Project form with backend
                    document.addEventListener("DOMContentLoaded", function () {
                      const form = document.querySelector(
                        "#createNewProject form"
                      );
                      if (!form) return;

                      // Map picker logic
                      let mapPicker, markerPicker;
                      const mapModal =
                        document.getElementById("createNewProject");
                      const mapDiv = document.getElementById("newProjectMap");
                      let latInput =
                        document.getElementById("project_latitude");
                      let lngInput =
                        document.getElementById("project_longitude");
                      let latLngDisplay =
                        document.getElementById("selectedLatLng");

                      // Helper to initialize map only once
                      let mapInitialized = false;
                      function initMapPicker() {
                        if (mapInitialized) return;
                        mapPicker = L.map("newProjectMap", {
                          center: [-0.0236, 37.9062],
                          zoom: 6.3,
                          scrollWheelZoom: true,
                          dragging: true,
                          doubleClickZoom: true,
                          boxZoom: true,
                          keyboard: true,
                          zoomControl: true,
                        });
                        L.tileLayer(
                          "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                          {
                            maxZoom: 19,
                            attribution: "&copy; OpenStreetMap contributors",
                          }
                        ).addTo(mapPicker);
                        mapPicker.on("click", function (e) {
                          if (markerPicker) mapPicker.removeLayer(markerPicker);
                          markerPicker = L.marker(e.latlng).addTo(mapPicker);
                          latInput.value = e.latlng.lat;
                          lngInput.value = e.latlng.lng;
                          latLngDisplay.textContent = `${e.latlng.lat.toFixed(
                            5
                          )}, ${e.latlng.lng.toFixed(5)}`;
                        });
                        mapInitialized = true;
                      }

                      // Show map when modal opens
                      mapModal.addEventListener("show.tw.modal", function () {
                        setTimeout(() => {
                          initMapPicker();
                          mapPicker.invalidateSize();
                        }, 200);
                      });
                      // Also initialize if modal is already visible (fallback)
                      if (
                        !mapInitialized &&
                        mapModal.classList.contains("show")
                      ) {
                        setTimeout(() => {
                          initMapPicker();
                          mapPicker.invalidateSize();
                        }, 200);
                      }

                      // Submission handled by centralized handler in Stakeholders/dashboard.html
                    });
                  </script>
                  <!-- Title -->
                  <div>
                    <label
                      for="title"
                      class="block text-sm font-medium text-gray-700"
                      >Title</label
                    >
                    <input
                      type="text"
                      id="title"
                      name="title"
                      class="block w-full p-2 mt-1 border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    />
                  </div>

                  <!-- Project Theme -->
                  <div>
                    <label
                      for="theme"
                      class="block text-sm font-medium text-gray-700"
                      >Project Theme</label
                    >
                    <select
                      id="theme"
                      name="theme"
                      class="block w-full p-2 mt-1 border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    >
                      <option value="">Select Theme</option>
                      <option value="GBV">Gender based violence</option>
                      <option value="AYPSRH">
                        Adolescent and Young People Sexual and Reproductive
                        Health
                      </option>
                      <option value="MNH">Maternal and Newborn Health</option>
                      <option value="FP">Family planning</option>
                      <option value="CH">Child Health</option>
                      <option value="AH">Adolescent Health</option>
                    </select>
                  </div>

                  <!-- Time Period -->
                  <div>
                    <label
                      for="starttime_period"
                      class="block text-sm font-medium text-gray-700"
                    >
                      Start
                    </label>
                    <input
                      type="date"
                      id="starttime_period"
                      name="start_date"
                      class="block w-full p-2 mt-1 border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    />
                  </div>
                  <div>
                    <label
                      for="endtime_period"
                      class="block text-sm font-medium text-gray-700"
                      >End</label
                    >
                    <input
                      type="date"
                      id="endtime_period"
                      name="end_date"
                      class="block w-full p-2 mt-1 border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    />
                  </div>
                  <!-- Activity Type -->
                  <div class="col-span-2 md:col-span-4">
                    <label
                      for="activity_type"
                      class="block text-sm font-medium text-gray-700"
                      >Activity Type (Description)</label
                    >
                    <textarea
                      id="activity_type"
                      name="activity_type"
                      rows="3"
                      class="block w-full p-2 mt-1 border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    ></textarea>
                  </div>

                  <!-- County and Sub County removed from this form -->

                  <div>
                    <label
                      for="location"
                      class="block text-sm font-medium text-gray-700"
                      >Area</label
                    >
                    <input
                      type="text"
                      id="time_period"
                      name="project_area"
                      placeholder="Where in county"
                      class="block w-full p-2 mt-1 border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    />
                  </div>

                  <div>
                    <label
                      for="location"
                      class="block text-sm font-medium text-gray-700"
                      >Maps Address</label
                    >
                    <input
                      type="text"
                      id="time_period"
                      name="maps_address"
                      placeholder="Maps Address"
                      class="block w-full p-2 mt-1 border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    />
                  </div>

                  <!-- Contact Person -->
                  <div>
                    <label
                      for="contact_person"
                      class="block text-sm font-medium text-gray-700"
                    >
                      Contact Person Name
                    </label>
                    <input
                      type="text"
                      id="contact_person"
                      name="contact_person_name"
                      placeholder="Name"
                      class="block w-full p-2 mt-1 border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    />
                  </div>
                  <div>
                    <label
                      for="contact_person"
                      class="block text-sm font-medium text-gray-700"
                    >
                      Contact Person Role
                    </label>
                    <input
                      type="text"
                      id="contact_person"
                      name="contact_person_role"
                      placeholder="Role"
                      class="block w-full p-2 mt-1 border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    />
                  </div>
                  <div>
                    <label
                      for="contact_person"
                      class="block text-sm font-medium text-gray-700"
                    >
                      Contact Person Email
                    </label>
                    <input
                      type="email"
                      id="contact_person"
                      name="contact_person_mail"
                      placeholder="Email"
                      class="block w-full p-2 mt-1 border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    />
                  </div>

                  <!-- Gaps -->
                  <div class="col-span-2 lg:col-span-4">
                    <label
                      for="gaps"
                      class="block text-sm font-medium text-gray-700"
                    >
                      Objectives
                    </label>
                    <textarea
                      id="gaps"
                      name="gaps"
                      rows="3"
                      class="block w-full p-2 mt-1 border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                    ></textarea>
                  </div>
                </div>

                <!-- Button -->
                <div class="mt-3">
                  <button
                    type="submit"
                    class="inline-flex justify-center w-full px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                  >
                    Request Info
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="max-w-6xl p-8 mx-auto">
        <div class="p-6 mb-6 bg-white rounded-lg shadow-md fade fade-up">
          <h2
            class="flex items-center mb-5 text-2xl font-light text-gray-900 uppercase fade fade-left"
          >
            Projects Overview
          </h2>
          <div id="barChart"></div>
          <h2
            class="flex items-center mb-5 text-lg font-light text-gray-900 uppercase fade fade-left"
          >
            Status Summary
          </h2>
          <div class="grid grid-cols-2 gap-4 mb-6 text-center lg:grid-cols-5">
            <button
              data-twe-toggle="modal"
              data-twe-target="#createNewProject"
              class="p-4 rounded-md fade fade-up bg-blue-50"
            >
              <p class="text-3xl font-bold text-blue-700">
                <i class="text-xl fas fa-plus-circle"></i>
              </p>
              <p class="text-sm text-blue-600">New Project</p>
            </button>
            <div class="p-4 rounded-md fade fade-up bg-green-50">
              <p class="text-3xl font-bold text-green-700">0</p>
              <p class="text-sm text-green-600">Approved</p>
            </div>
            <div class="p-4 rounded-md fade fade-up bg-yellow-50">
              <p class="text-3xl font-bold text-yellow-700">0</p>
              <p class="text-sm text-yellow-600">Pending</p>
            </div>
            <div class="p-4 rounded-md fade fade-up bg-red-50">
              <p class="text-3xl font-bold text-red-700">0</p>
              <p class="text-sm text-red-600">Stalled</p>
            </div>
            <div class="p-4 rounded-md fade fade-up bg-gray-50">
              <p class="text-3xl font-bold text-gray-700">0</p>
              <p class="text-sm text-gray-600">Abandoned</p>
            </div>
          </div>
          <ul class="space-y-2 text-base text-gray-700 fade fade-left">
            <li>
              <span class="font-medium"> Avg. Cost: </span>
              <span class="text-blue-600">
                <span class="text-xs opacity-75"> KES </span>
                25,000,000
              </span>
            </li>
            <li>
              <span class="font-medium"> Top County By Projects: </span>
              Mombasa , 378
            </li>
            <li>
              <span class="font-medium"> Top County By Project Value: </span>
              Kisumu , <span class="ml-2 text-xs">KES</span> 1,200,000
            </li>
            <li>
              <span class="font-medium"> Addressed Topics: </span>
              GBV , Community Empowerment , Community Health
            </li>
            <li>
              <span class="font-medium"> Latest Start: </span>
              June 2025 , Nakuru
            </li>
          </ul>
          <div class="flex fade fade-up">
            <a
              href="projects.html"
              class="w-full text-center bg-indigo-600 text-white py-2.5 rounded-md hover:bg-indigo-700 transition duration-200 mt-5"
            >
              <i class="mr-2 fas fa-cog"></i>
              Manage Projects
            </a>
          </div>
        </div>

        <div class="p-6 my-4 bg-white rounded-lg shadow-md fade fade-right">
          <h2
            class="flex items-center mb-5 text-2xl font-light text-gray-900 uppercase fade fade-left"
          >
            Stakeholder Overview
          </h2>
          <h3
            class="flex items-center mb-5 text-sm font-light text-gray-900 uppercase fade fade-left"
          >
            Organization Types
          </h3>
          <div id="orgChart" class="fade fade-up"></div>
          <div class="grid grid-cols-2 gap-4 mb-6 text-center fade fade-up">
            <div class="p-4 rounded-md bg-blue-50">
              <p class="text-3xl font-bold text-blue-700">100</p>
              <p class="text-sm text-blue-600">Whitelisted</p>
            </div>
            <div class="p-4 rounded-md bg-yellow-50">
              <p class="text-3xl font-bold text-yellow-700">10</p>
              <p class="text-sm text-yellow-600">Pending</p>
            </div>
            <div class="p-4 rounded-md bg-red-50">
              <p class="text-3xl font-bold text-red-700">10</p>
              <p class="text-sm text-red-600">Restricted</p>
            </div>
          </div>
          <div class="flex fade fade-up">
            <a
              href="members.html"
              class="w-full bg-blue-600 text-center text-white py-2.5 rounded-md hover:bg-blue-700 transition duration-200"
            >
              <i class="mr-2 fas fa-address-book"></i> Manage Members
            </a>
          </div>
        </div>
      </div>

      <div
        id="kenyaMap"
        class="fade fade-up h-[450px] sm:h-[550px] z-0 w-full"
      ></div>
    </div>

    <script src="styles/authnav.js"></script>
    <script>
      // User session initialization
      async function initializeUserSession() {
        console.log(
          "[DEBUG] initializeUserSession: Starting user session initialization"
        );

        // Check if user is authenticated
        if (!authManager.isAuthenticated()) {
          console.log("[DEBUG] initializeUserSession: User not authenticated");
          alert(
            "You must be logged in to access this page. (See console for details)"
          );
          // Prevent redirect for debugging
          throw new Error("Not authenticated");
        }

        console.log("[DEBUG] initializeUserSession: User is authenticated");

        // Check for demo token
        const demoToken =
          "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJkZW1vQGVtYWlsLmNvbSIsInJvbGUiOiJVU0VSIiwiaWF0IjoxNjk1ODQwMDAwLCJleHAiOjE5MDAwMDAwMDB9.dummysignature";
        const token = authManager.getToken();
        if (token === demoToken) {
          console.log("[DEBUG] initializeUserSession: Using demo token");
          // Use a fake user object for demo
          const user = {
            id: 1,
            name: "Demo User",
            email: "demo@email.com",
            role: "USER",
            approvalStatus: "APPROVED",
          };
          updateUserDisplayWhenNavReady(user);
          await loadDashboardData();
          return;
        }

        try {
          console.log(
            "[DEBUG] initializeUserSession: Attempting to load current user data"
          );
          // Load current user data
          const user = await authManager.getCurrentUser();
          console.log(
            "[DEBUG] initializeUserSession: User data loaded successfully",
            user
          );

          // Update UI with user information
          updateUserDisplayWhenNavReady(user);

          // Check if user is approved
          if (user.approvalStatus !== "APPROVED") {
            console.log(
              "[DEBUG] initializeUserSession: User not approved, status:",
              user.approvalStatus
            );
            showApprovalPendingMessage(user);
          } else {
            console.log("[DEBUG] initializeUserSession: User is approved");
          }

          // Load dashboard data
          console.log("[DEBUG] initializeUserSession: Loading dashboard data");
          await loadDashboardData();
          console.log(
            "[DEBUG] initializeUserSession: Initialization completed successfully"
          );
        } catch (error) {
          console.error(
            "[DEBUG] initializeUserSession: Failed to load user session:",
            error
          );
          alert("Failed to load user session. Please log in again.");
          authManager.logout();
        }
      }

      // Load dashboard statistics and projects from API
      async function loadDashboardData() {
        try {
          console.log("Loading dashboard data...");
          // Load project statistics
          await loadProjectStatistics();
          // Load projects list (default: all projects)
          await loadProjects();
          // Optionally, load map-only projects
          // await loadProjectsWithCoordinates();
          console.log("Dashboard data loaded successfully");
        } catch (error) {
          console.error("Failed to load dashboard data:", error);
          showDashboardError();
        }
      }

      // Load project statistics from API
      async function loadProjectStatistics() {
        try {
          const response = await authManager.apiCall(
            "/api/projects/statistics",
            "GET"
          );
          if (!response || !response.ok) {
            console.error("Failed to fetch statistics, using defaults");
            useDefaultStatistics();
            return;
          }

          const stats = await response.json();
          console.log("[DEBUG] Statistics loaded:", stats);

          // Calculate statistics from the API response
          if (stats.data) {
            const data = stats.data;

            // Calculate regions/counties from countyCounts
            const regions = data.countyCounts ? data.countyCounts.length : 0;

            // Locations is the number of projects with coordinates
            const locations =
              data.projectsWithCoordinates || data.totalProjects || 0;

            // Projects is the total number of projects
            const projects = data.totalProjects || 0;

            // Calculate total active status count
            let activeCount = 0;
            if (data.statusCounts) {
              data.statusCounts.forEach(([status, count]) => {
                if (status === "active" || status === "ACTIVE") {
                  activeCount += count;
                }
              });
            }

            // Store the statistics in a global variable for Alpine.js
            window.statsData = {
              locations: locations,
              projects: projects,
              regions: regions,
              users: activeCount || projects, // Use active projects or total as "teams"
              amount: projects * 1000000, // Estimate: 1M KES per project (adjust as needed)
            };

            console.log("[DEBUG] Calculated statsData:", window.statsData);

            // Dispatch a custom event that Alpine.js will listen to
            window.dispatchEvent(
              new CustomEvent("stats-loaded", {
                detail: window.statsData,
              })
            );

            // Update the hero statistics display with the actual data
            updateStatisticsDisplay(data);
          } else {
            console.warn("[DEBUG] No stats.data found, using defaults");
            useDefaultStatistics();
          }
        } catch (error) {
          console.error("Error loading statistics:", error);
          useDefaultStatistics();
        }
      }

      // Use default statistics if API calls fail
      function useDefaultStatistics() {
        const defaultStats = {
          totalProjects: 0,
          countyCounts: {},
          statusCounts: {},
          totalStakeholders: 0,
          totalBudget: 0,
          coordinatesCoveragePercentage: 0,
        };

        // Show message about using defaults
        console.warn(
          "⚠️ Using default statistics due to API failure - this should show 0 for all stats"
        );
        showApiConnectionWarning();

        updateStatisticsDisplay(defaultStats);
      }

      // Show API connection warning
      function showApiConnectionWarning() {
        const warningBanner = document.createElement("div");
        warningBanner.className =
          "fixed top-20 left-4 right-4 z-40 bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded";
        warningBanner.innerHTML = `
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                <strong>API Connection Issue:</strong> Unable to load live data. Showing default values.
                                This may be due to server maintenance or connectivity issues.
                            </p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-yellow-500 hover:text-yellow-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
        document.body.appendChild(warningBanner);

        setTimeout(() => {
          if (warningBanner.parentElement) {
            warningBanner.remove();
          }
        }, 10000);
      }

      // Load projects from API
      // Load all projects with pagination, sorting, and filtering
      async function loadProjects({
        page = 0,
        size = 50,
        sortBy = "id",
        sortDir = "desc",
        filters = {},
      } = {}) {
        try {
          let url = `/api/projects?page=${page}&size=${size}&sortBy=${sortBy}&sortDir=${sortDir}`;
          // Add filter params
          Object.entries(filters).forEach(([key, value]) => {
            if (value)
              url += `&${encodeURIComponent(key)}=${encodeURIComponent(value)}`;
          });
          const response = await authManager.apiCall(url, "GET");
          if (response.ok) {
            const data = await response.json();
            console.log("loadProjects API response:", data);
            if (data.status === 200 && data.data && data.data.projects) {
              const allProjects = data.data.projects;
              console.log("Loaded all projects:", allProjects.length);

              // Update the global projects array
              projects = allProjects;

              // Update the projects display (accordion)
              updateProjectsDisplay(allProjects);

              // Also add map markers for projects that have coordinates
              addMarkersToMap(
                allProjects.filter((p) => p.latitude && p.longitude)
              );

              // Trigger the accordion display
              highlightMarkers("all");
            }
          } else {
            showProjectsError();
          }
        } catch (error) {
          console.error("Error loading projects:", error);
          showProjectsError();
        }
      }

      // Load only projects with coordinates (for map)
      async function loadProjectsWithCoordinates() {
        try {
          const response = await authManager.apiCall(
            "/api/projects/with-coordinates",
            "GET"
          );
          if (response.ok) {
            const data = await response.json();
            if (data.status === 200 && data.data) {
              updateMapWithProjects(data.data);
            }
          }
        } catch (error) {
          // Optionally show error
        }
      }

      // Advanced search/filter
      async function searchProjects(filters) {
        try {
          let url = "/api/projects/search";
          const params = Object.entries(filters)
            .filter(([_, v]) => v)
            .map(
              ([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`
            )
            .join("&");
          if (params) url += `?${params}`;
          const response = await authManager.apiCall(url, "GET");
          if (response.ok) {
            const data = await response.json();
            if (data.status === 200 && data.data) {
              updateProjectsDisplay(data.data);
              updateMapWithProjects(data.data);
            }
          }
        } catch (error) {}
      }

      // Filter by status
      async function filterProjectsByStatus(status) {
        try {
          const response = await authManager.apiCall(
            `/api/projects/status/${status}`,
            "GET"
          );
          if (response.ok) {
            const data = await response.json();
            if (data.status === 200 && data.data) {
              updateProjectsDisplay(data.data);
              updateMapWithProjects(data.data);
            }
          }
        } catch (error) {}
      }

      // Filter by date range
      async function filterProjectsByDateRange(startDate, endDate) {
        try {
          const url = `/api/projects/date-range?startDate=${encodeURIComponent(
            startDate
          )}&endDate=${encodeURIComponent(endDate)}`;
          const response = await authManager.apiCall(url, "GET");
          if (response.ok) {
            const data = await response.json();
            if (data.status === 200 && data.data) {
              updateProjectsDisplay(data.data);
              updateMapWithProjects(data.data);
            }
          }
        } catch (error) {}
      }

      // Filter by bounding box (for map)
      async function filterProjectsByBounds(minLat, maxLat, minLng, maxLng) {
        try {
          const url = `/api/projects/in-bounds?minLat=${minLat}&maxLat=${maxLat}&minLng=${minLng}&maxLng=${maxLng}`;
          const response = await authManager.apiCall(url, "GET");
          if (response.ok) {
            const data = await response.json();
            if (data.status === 200 && data.data) {
              updateProjectsDisplay(data.data);
              updateMapWithProjects(data.data);
            }
          }
        } catch (error) {}
      }

      // Get project details by ID
      async function getProjectById(id) {
        try {
          const response = await authManager.apiCall(
            `/api/projects/${id}`,
            "GET"
          );
          if (response.ok) {
            const data = await response.json();
            if (data.status === 200 && data.data) {
              // Show details in modal or section
              // showProjectDetailsModal(data.data);
            }
          }
        } catch (error) {}
      }

      // Get my projects (for PARTNER)
      async function loadMyProjects() {
        try {
          const response = await authManager.apiCall(
            "/api/projects/my-projects",
            "GET"
          );
          if (response.ok) {
            const data = await response.json();
            if (data.status === 200 && data.data) {
              updateProjectsDisplay(data.data);
              updateMapWithProjects(data.data);
            }
          }
        } catch (error) {}
      }

      // Update map with real project data
      function updateMapWithProjects(projectsData) {
        console.log("updateMapWithProjects called with:", projectsData);
        console.log("Number of projects received:", projectsData.length);

        // Log all projects to see their structure
        projectsData.forEach((project, idx) => {
          console.log(`Project ${idx + 1} structure:`, {
            id: project.id,
            name: project.projectName || project.name,
            latitude: project.latitude,
            longitude: project.longitude,
            status: project.status,
            hasCoordinates: !!(project.latitude && project.longitude),
            allFields: Object.keys(project),
          });
        });

        // Find projects with coordinates
        const projectsWithCoords = projectsData.filter((p) => {
          const hasCoords = p.latitude && p.longitude;
          if (!hasCoords) {
            console.warn(
              `Project "${p.projectName || p.name}" (ID: ${
                p.id
              }) is missing coordinates!`
            );
          }
          return hasCoords;
        });

        console.log("Updating map with", projectsWithCoords.length, "projects");
        console.log("Projects with coordinates:", projectsWithCoords);

        // Add markers to Mapbox map
        addMarkersToMap(projectsWithCoords);

        // Update project list
        projects = projectsData;
      }

      // Update statistics display with real data
      function updateStatisticsDisplay(stats) {
        console.log("📊 Updating statistics display with:", stats);

        // Update hero section statistics
        const totalProjectsElement =
          document.getElementById("totalProjectsCount");
        const totalCountiesElement =
          document.getElementById("totalCountiesCount");
        const totalStakeholdersElement = document.getElementById(
          "totalStakeholdersCount"
        );

        // Calculate counties count - handle both array and object formats
        let countiesCount = 0;
        if (stats.countyCounts) {
          if (Array.isArray(stats.countyCounts)) {
            countiesCount = stats.countyCounts.length;
          } else if (typeof stats.countyCounts === "object") {
            countiesCount = Object.keys(stats.countyCounts).length;
          }
        }

        if (totalProjectsElement) {
          const projectCount = stats.totalProjects || 0;
          totalProjectsElement.textContent = projectCount;
          console.log("✅ Updated total projects count:", projectCount);
        } else {
          console.warn("⚠️ totalProjectsElement not found");
        }

        if (totalCountiesElement) {
          totalCountiesElement.textContent = countiesCount;
          console.log("✅ Updated total counties count:", countiesCount);
        } else {
          console.warn("⚠️ totalCountiesElement not found");
        }

        if (totalStakeholdersElement) {
          const stakeholdersCount = stats.totalStakeholders || 0;
          totalStakeholdersElement.textContent = stakeholdersCount;
          console.log(
            "✅ Updated total stakeholders count:",
            stakeholdersCount
          );
        } else {
          console.warn("⚠️ totalStakeholdersElement not found");
        }

        console.log("📊 Hero statistics updated:", {
          projects: stats.totalProjects,
          counties: countiesCount,
          stakeholders: stats.totalStakeholders,
        });

        // Update Alpine.js countdownStats component
        try {
          const statsComponent = Alpine.$data(
            document.querySelector('[x-data*="countdownStats"]')
          );

          if (statsComponent) {
            // Update targets with real data
            statsComponent.targets = {
              locations: stats.coordinatesCoveragePercentage || 0,
              projects: stats.totalProjects || 0,
              regions: Object.keys(stats.countyCounts || {}).length || 0,
              users: stats.totalStakeholders || 0,
              amount: stats.totalBudget || 0, // This would need to be calculated from projects
            };

            // Reset the animation values
            statsComponent.locations = 0;
            statsComponent.projects = 0;
            statsComponent.regions = 0;
            statsComponent.users = 0;
            statsComponent.amount = 0;
            statsComponent.amountDisplay = "0";

            // Restart the animation with new targets
            statsComponent.start();

            console.log(
              "Alpine.js statistics updated:",
              statsComponent.targets
            );
          } else {
            console.warn("Alpine.js countdownStats component not found");
          }
        } catch (error) {
          console.error("Error updating Alpine.js component:", error);
        }

        console.log("Hero statistics updated:", {
          projects: stats.totalProjects,
          counties: Object.keys(stats.countyCounts || {}).length,
          stakeholders: stats.totalStakeholders,
        });
      }

      // Update projects display
      function updateProjectsDisplay(projectsData) {
        console.log(
          "updateProjectsDisplay called with:",
          projectsData.length,
          "projects"
        );

        // Update global projects variable
        window.projects = projectsData;
        window.filteredProjects = projectsData;

        // Render accordion with projects
        renderProjectsList(projectsData);

        console.log(
          "Projects display updated with",
          projectsData.length,
          "projects"
        );
      }

      // Render projects accordion in the UI
      function renderProjectsList(projects) {
        console.log(
          "renderProjectsList called with:",
          projects.length,
          "projects"
        );
        const accordion = document.getElementById("projectAccordion");
        if (!accordion) {
          console.error("Accordion element not found!");
          return;
        }

        // Make sure accordion is visible
        accordion.classList.remove("hidden");
        accordion.innerHTML = "";

        if (projects.length === 0) {
          console.log("No projects to display");
          accordion.innerHTML = `
                <div class="text-center py-8">
                  <i class="fas fa-project-diagram text-gray-400 text-4xl mb-4"></i>
                  <p class="text-gray-600">No projects found.</p>
                </div>
              `;
          return;
        }

        console.log("Rendering", projects.length, "projects in accordion");
        projects.forEach((project, idx) => {
          console.log(
            `Rendering project ${idx + 1}:`,
            project.projectName || project.name
          );
          // Status color classes
          const statusBg =
            {
              active: "bg-green-50",
              pending: "bg-yellow-50",
              stalled: "bg-red-50",
              completed: "bg-cyan-100",
            }[project.status] || "bg-white";
          const statusBadge =
            {
              active: "bg-green-200 text-green-800",
              pending: "bg-yellow-200 text-yellow-800",
              stalled: "bg-red-200 text-red-800",
              completed: "bg-cyan-300 text-gray-800",
            }[project.status] || "bg-gray-200 text-gray-800";
          // Format budget
          const budget = project.budget
            ? Number(project.budget).toLocaleString("en-KE", {
                style: "currency",
                currency: "KES",
                maximumFractionDigits: 0,
              })
            : "N/A";
          // Accordion item
          const item = document.createElement("div");
          item.className = `rounded shadow-sm ${statusBg}`;
          item.innerHTML = `
                <button class=\"w-full px-6 py-4 text-left border-b focus:outline-none\" data-toggle=\"collapse-${idx}\">
                  <div class=\"flex flex-col sm:flex-row sm:justify-between sm:items-center\">
                    <div>
                      <h4 class=\"text-lg font-semibold text-gray-800\">${
                        project.title || ""
                      }</h4>
                      <p id=\"desc-${idx}\" class=\"mt-2 text-sm text-gray-600\">${
            project.objectives
              ? project.objectives.substring(0, 100) +
                (project.objectives.length > 100 ? "..." : "")
              : ""
          }</p>
                    </div>
                    <div class=\"flex items-center mt-2 text-sm font-semibold tracking-wider text-gray-500 sm:mt-0\">
                      ${
                        project.projectTheme
                          ? `<span class='px-2 py-1 rounded-full bg-gray-100 text-gray-700 mr-2'>${project.projectTheme}</span>`
                          : ""
                      }
                      ${
                        project.status
                          ? `<span class='px-2 py-1 rounded-full text-sm font-medium ${statusBadge}'>${project.status}</span>`
                          : ""
                      }
                    </div>
                  </div>
                </button>
                <div id=\"collapse-${idx}\" class=\"hidden px-6 py-4 bg-white\">
                  <p><strong>County:</strong> ${
                    project.county || "Not specified"
                  }</p>
                  <p><strong>Budget:</strong> ${budget}</p>
                  <p><strong>Partner:</strong> ${
                    project.partner && project.partner !== "TBD"
                      ? project.partner
                      : "Partner information pending"
                  }</p>
                  <p><strong>Status:</strong>
                    <span class=\"inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge}\">
                      ${project.status || ""}
                    </span>
                  </p>
                  <button onclick=\"focusMarker(${idx})\" class=\"px-5 py-2 mt-3 text-sm font-semibold text-white transition bg-blue-600 rounded hover:bg-blue-700 hover:scale-105\">
                    Show on Map
                  </button>
                </div>
              `;
          accordion.appendChild(item);
          // Toggle description between truncated and full
          const btn = item.querySelector(`[data-toggle="collapse-${idx}"]`);
          btn.addEventListener("click", () => {
            const collapse = document.getElementById(`collapse-${idx}`);
            const desc = document.getElementById(`desc-${idx}`);
            collapse.classList.toggle("hidden");
            if (!collapse.classList.contains("hidden")) {
              desc.textContent = project.objectives || "";
            } else {
              desc.textContent = project.objectives
                ? project.objectives.substring(0, 100) +
                  (project.objectives.length > 100 ? "..." : "")
                : "";
            }
          });
        });
      }

      // Create project card element
      function createProjectCard(project) {
        const card = document.createElement("div");
        card.className =
          "bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow";

        const statusClass = getStatusClass(project.status);
        const themeClass = getThemeClass(project.projectTheme);

        card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 line-clamp-2">${
                          project.title
                        }</h3>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                            ${
                              project.status.charAt(0).toUpperCase() +
                              project.status.slice(1)
                            }
                        </span>
                    </div>

                    <div class="space-y-2 mb-4">
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-building mr-2"></i>${
                              project.partner
                            }
                        </p>
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-map-marker-alt mr-2"></i>${
                              project.county
                            }${
          project.subCounty ? ", " + project.subCounty : ""
        }
                        </p>
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-calendar mr-2"></i>${
                              project.startDate
                            } - ${project.endDate}
                        </p>
                        ${
                          project.budget
                            ? `
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-dollar-sign mr-2"></i>$${project.budget.toLocaleString()}
                            </p>
                        `
                            : ""
                        }
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="px-2 py-1 rounded text-xs font-medium ${themeClass}">
                            ${project.projectTheme}
                        </span>
                        <button onclick="viewProject(${project.id})"
                            class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            View Details →
                        </button>
                    </div>
                `;

        return card;
      }

      // Helper functions for styling
      function getStatusClass(status) {
        const classes = {
          active: "bg-green-100 text-green-800",
          pending: "bg-yellow-100 text-yellow-800",
          completed: "bg-blue-100 text-blue-800",
          stalled: "bg-red-100 text-red-800",
          abandoned: "bg-gray-100 text-gray-800",
        };
        return classes[status] || "bg-gray-100 text-gray-800";
      }

      function getThemeClass(theme) {
        const classes = {
          MNH: "bg-pink-100 text-pink-800",
          FP: "bg-blue-100 text-blue-800",
          GBV: "bg-red-100 text-red-800",
          CH: "bg-green-100 text-green-800",
          AH: "bg-purple-100 text-purple-800",
          AYPSRH: "bg-indigo-100 text-indigo-800",
        };
        return classes[theme] || "bg-gray-100 text-gray-800";
      }

      // View project details
      function viewProject(projectId) {
        window.open(`project-details.html?id=${projectId}`, "_blank");
      }

      // Use default statistics if API fails
      function useDefaultStatistics() {
        console.log("Using default statistics");
        // The existing hardcoded values will be used
      }

      // Show dashboard error
      function showDashboardError() {
        const errorBanner = document.createElement("div");
        errorBanner.className =
          "fixed top-20 left-4 right-4 z-40 bg-red-100 border-l-4 border-red-500 p-4 rounded";
        errorBanner.innerHTML = `
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-circle text-red-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-red-700">
                                Failed to load some dashboard data. Showing cached or default information.
                            </p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
        document.body.appendChild(errorBanner);

        setTimeout(() => {
          if (errorBanner.parentElement) {
            errorBanner.remove();
          }
        }, 5000);
      }

      // Show projects error
      function showProjectsError() {
        const projectsContainer = document.getElementById("projects-container");
        if (projectsContainer) {
          projectsContainer.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
                            <p class="text-gray-600 mb-4">Failed to load projects. Please try again later.</p>
                            <button onclick="loadProjects()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                Retry
                            </button>
                        </div>
                    `;
        }
      }

      function updateUserDisplayWhenNavReady(user) {
        // Check if nav is already loaded
        const navPlaceholder = document.getElementById("nav-placeholder");
        if (navPlaceholder && navPlaceholder.innerHTML.trim() !== "") {
          updateUserDisplay(user);
        } else {
          // Wait for nav to be loaded
          window.addEventListener(
            "navLoaded",
            () => {
              updateUserDisplay(user);
            },
            { once: true }
          );
        }
      }

      function updateUserDisplay(user) {
        // Update navigation display
        const userDisplayName = document.getElementById("userDisplayName");
        const userNameDisplay = document.getElementById("userNameDisplay");
        const userEmailDisplay = document.getElementById("userEmailDisplay");
        const userRoleDisplay = document.getElementById("userRoleDisplay");
        const userStatusDisplay = document.getElementById("userStatusDisplay");

        if (userDisplayName) userDisplayName.textContent = user.name || "User";
        if (userNameDisplay) userNameDisplay.textContent = user.name || "N/A";
        if (userEmailDisplay)
          userEmailDisplay.textContent = user.email || "N/A";
        if (userRoleDisplay) userRoleDisplay.textContent = user.role || "N/A";
        if (userStatusDisplay) {
          userStatusDisplay.textContent = user.approvalStatus || "N/A";
          userStatusDisplay.className =
            user.approvalStatus === "APPROVED"
              ? "text-green-600"
              : user.approvalStatus === "PENDING"
              ? "text-yellow-600"
              : "text-red-600";
        }

        // Hide all role-based navs by default
        const adminNav = document.getElementById("adminNav");
        const partnerNav = document.getElementById("partnerNav");
        const donorNav = document.getElementById("donorNav");
        const myProjectsNav = document.getElementById("myProjectsNav");
        if (adminNav) adminNav.classList.add("hidden");
        if (partnerNav) partnerNav.classList.add("hidden");
        if (donorNav) donorNav.classList.add("hidden");
        if (myProjectsNav) myProjectsNav.classList.add("hidden");

        // Show navs based on role
        if (
          user.role === "SUPER_ADMIN" ||
          user.role === "SUPER_ADMIN_REVIEWER" ||
          user.role === "SUPER_ADMIN_APPROVER"
        ) {
          if (adminNav) adminNav.classList.remove("hidden");
        }
        if (user.role === "PARTNER") {
          if (partnerNav) partnerNav.classList.remove("hidden");
          if (myProjectsNav) myProjectsNav.classList.remove("hidden");
        }
        if (user.role === "DONOR") {
          if (donorNav) donorNav.classList.remove("hidden");
          // Customize dashboard for donors
          const projectsTitle = document.getElementById("projectsTitle");
          if (projectsTitle)
            projectsTitle.textContent = "Projects in Your Network";

          const projectsLabel = document.getElementById("projectsLabel");
          if (projectsLabel) projectsLabel.textContent = "Funded Projects";

          const usersLabel = document.getElementById("usersLabel");
          if (usersLabel) usersLabel.textContent = "Partners";
        }

        // Show admin collaboration menu for ADMIN or SUPER_ADMIN
        console.log("[DEBUG] User role:", user.role);
        if (
          user.role === "ADMIN" ||
          user.role === "SUPER_ADMIN" ||
          user.role === "SUPER_ADMIN_REVIEWER" ||
          user.role === "SUPER_ADMIN_APPROVER"
        ) {
          console.log("[DEBUG] User is admin, showing admin collab menu");
          const adminCollabItem = document.getElementById("admin-collab-item");
          const adminCollabMobile = document.getElementById(
            "admin-collab-mobile"
          );
          console.log("[DEBUG] adminCollabItem found:", adminCollabItem);
          console.log("[DEBUG] adminCollabMobile found:", adminCollabMobile);

          if (adminCollabItem) {
            adminCollabItem.style.display = "block";
            console.log("[DEBUG] Set adminCollabItem display to block");
          }
          if (adminCollabMobile) {
            adminCollabMobile.style.display = "block";
            console.log("[DEBUG] Set adminCollabMobile display to block");
          }
          loadPendingRequestsCount();
        } else {
          console.log("[DEBUG] User is NOT admin, role is:", user.role);
        }
        // Optionally, show/hide other navs for other roles as needed
      }

      async function loadPendingRequestsCount() {
        try {
          const token = localStorage.getItem("accessToken");
          const response = await fetch(
            `${BASE_URL}/api/collaboration-requests/admin/pending`,
            {
              method: "GET",
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );
          const data = await response.json();
          if (data.status === 200 && data.data) {
            const count = data.data.length;

            // Update Alpine.js data for the collaboration dropdown
            const collabNav = document.getElementById("collabNav");
            if (collabNav && collabNav.__x) {
              collabNav.__x.$data.pendingCount = count;
            }

            // Legacy support for old badge element if it exists
            const badge = document.getElementById("pending-badge");
            if (badge && count > 0) {
              badge.textContent = count;
              badge.style.display = "inline-block";
            }
          }
        } catch (error) {
          console.error("Error loading pending requests count:", error);
        }
      }

      function showApprovalPendingMessage(user) {
        if (user.approvalStatus === "PENDING") {
          const banner = document.createElement("div");
          banner.className =
            "fixed top-20 left-4 right-4 z-40 bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded";
          banner.innerHTML = `
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-700">
                                    Your account is pending approval. Some features may be limited until an administrator approves your account.
                                </p>
                            </div>
                            <div class="ml-auto pl-3">
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-yellow-500 hover:text-yellow-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
          document.body.appendChild(banner);

          // Auto-remove after 10 seconds
          setTimeout(() => {
            if (banner.parentElement) {
              banner.remove();
            }
          }, 10000);
        }
      }

      // Show My Projects section for PARTNER users

      // Load user's own projects (for PARTNER users)
      async function loadUserProjects() {
        try {
          console.log("Loading user projects...");
          const userId = currentUser.id;
          const response = await authManager.apiCall(
            `/api/projects/user/${userId}`,
            {
              method: "GET",
            }
          );

          if (response && response.length > 0) {
            renderUserProjectsList(response);
          } else {
            showNoUserProjectsMessage();
          }
        } catch (error) {
          console.error("Failed to load user projects:", error);
          showUserProjectsError();
        }
      }

      // Render user's projects list
      function renderUserProjectsList(projects) {
        const container = document.getElementById("projects-container");
        if (!container) return;

        container.innerHTML = `
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">My Projects</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${projects
                              .map((project) => createUserProjectCard(project))
                              .join("")}
                        </div>
                    </div>
                `;
      }

      // Create project card for user's projects
      function createUserProjectCard(project) {
        const statusColors = {
          ACTIVE: "bg-green-100 text-green-800",
          PENDING: "bg-yellow-100 text-yellow-800",
          STALLED: "bg-red-100 text-red-800",
          COMPLETED: "bg-blue-100 text-blue-800",
          ABANDONED: "bg-gray-100 text-gray-800",
        };

        return `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-semibold text-gray-800 truncate">${
                                  project.name || "Untitled Project"
                                }</h4>
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${
                                  statusColors[project.status] ||
                                  "bg-gray-100 text-gray-800"
                                }">
                                    ${project.status || "Unknown"}
                                </span>
                            </div>
                            <p class="text-gray-600 text-sm mb-4 line-clamp-3">
                                ${
                                  project.description ||
                                  "No description available"
                                }
                            </p>
                            <div class="space-y-2 text-sm text-gray-500">
                                <div class="flex justify-between">
                                    <span>Budget:</span>
                                    <span class="font-medium">$${
                                      project.budget
                                        ? project.budget.toLocaleString()
                                        : "N/A"
                                    }</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Progress:</span>
                                    <span class="font-medium">${
                                      project.progress || 0
                                    }%</span>
                                </div>
                                ${
                                  project.startDate
                                    ? `
                                <div class="flex justify-between">
                                    <span>Started:</span>
                                    <span class="font-medium">${new Date(
                                      project.startDate
                                    ).toLocaleDateString()}</span>
                                </div>
                                `
                                    : ""
                                }
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <button onclick="viewProjectDetails(${
                                  project.id
                                })"
                                        class="w-full px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
      }

      // View project details
      function viewProjectDetails(projectId) {
        // Navigate to project details page or show modal
        window.location.href = `project-details.html?id=${projectId}`;
      }
    </script>

    <script src="styles/loadNav.js"></script>
    <script src="styles/authnav.js"></script>

    <script>
      var options = {
        chart: {
          type: "donut",
          height: 350,
        },
        series: [65, 35],
        labels: ["Implementing", "Development"],
        colors: ["#A08BFB", "#FFF560"],
        legend: {
          position: "bottom",
        },
        dataLabels: {
          enabled: true,
          formatter: function (val, opts) {
            return opts.w.config.series[opts.seriesIndex];
          },
        },
        tooltip: {
          y: {
            formatter: function (val) {
              return val + " Oranizations";
            },
          },
        },
      };

      var chart = new ApexCharts(document.querySelector("#orgChart"), options);
      chart.render();
    </script>
    <script>
      var options = {
        chart: {
          type: "donut",
          height: 350,
        },
        series: [65, 35], // Example: 65 males, 35 females
        labels: ["Male", "Female"],
        colors: ["#008FFB", "#FF4560"],
        legend: {
          position: "bottom",
        },
        dataLabels: {
          enabled: true,
          formatter: function (val, opts) {
            return opts.w.config.series[opts.seriesIndex];
          },
        },
        tooltip: {
          y: {
            formatter: function (val) {
              return val + " Members";
            },
          },
        },
      };

      var chart = new ApexCharts(document.querySelector("#teamChart"), options);
      chart.render();
    </script>
    <script>
      var options = {
        chart: {
          type: "bar",
          height: 400,
          stacked: false,
        },
        plotOptions: {
          bar: {
            horizontal: false,
            columnWidth: "50%",
            dataLabels: {
              position: "top",
            },
          },
        },
        dataLabels: {
          enabled: true,
          offsetY: -20,
          style: {
            fontSize: "12px",
            colors: ["#304758"],
          },
        },
        series: [
          {
            name: "Active",
            data: [8, 12, 9],
          },
          {
            name: "Pending",
            data: [6, 10, 7],
          },
          {
            name: "Stalled",
            data: [2, 3, 4],
          },
          {
            name: "Compeleted",
            data: [12, 8, 10],
          },
        ],
        xaxis: {
          categories: ["GBV", "Community Empowerment", "Community Health"],
          title: { text: "Category" },
        },
        yaxis: {
          title: { text: "Value in Millions" },
        },
        legend: {
          position: "top",
        },
        tooltip: {
          shared: true,
          intersect: false,
          y: {
            formatter: function (val, opts) {
              let seriesName =
                opts.seriesIndex < 4 ? "Investment (M)" : "Projects";
              return val + " " + seriesName;
            },
          },
        },
      };

      var chart = new ApexCharts(document.querySelector("#barChart"), options);
      chart.render();
    </script>

    <script src="styles/effects.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tw-elements/js/tw-elements.umd.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      let map,
        selectedMarker = null;
      const markers = [];
      const icons = {
        default: (tag) =>
          L.icon({ iconUrl: `resources/${tag}.png`, iconSize: [20, 20] }),
        selected: (tag) =>
          L.icon({ iconUrl: `resources/${tag}.png`, iconSize: [40, 40] }),
      };

      const bgColors = {
        active: "bg-green-50",
        pending: "bg-yellow-50",
        stalled: "bg-red-50",
        abandoned: "bg-gray-100",
        default: "bg-white",
      };

      const statusBadge = (tag) => {
        return (
          {
            active: "bg-green-200 text-green-800",
            pending: "bg-yellow-200 text-yellow-800",
            stalled: "bg-red-200 text-red-800",
            abandoned: "bg-gray-300 text-gray-800",
          }[tag] || "bg-gray-200 text-gray-800"
        );
      };

      let sortBy = "name";
      let sortOrder = "asc";
      let currentPage = 1;
      const itemsPerPage = 5;
      let currentFilter = "all";

      let searchQuery = "";
      let dateRangeFrom = null;
      let dateRangeTo = null;

      document.addEventListener("DOMContentLoaded", function () {
        map = L.map("kenyaMap", {
          center: [-0.0236, 37.9062],
          zoom: 6.3,
          scrollWheelZoom: false,
          dragging: true,
          touchZoom: false,
          doubleClickZoom: true,
          boxZoom: false,
          keyboard: false,
          zoomControl: true, // keeps the + / – buttons visible
        });

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);

        const markerData = [
          { lat: -1.2921, lng: 36.8219, name: "Project 1", tag: "active" },
          { lat: -0.1023, lng: 34.7619, name: "Project 2", tag: "pending" },
          { lat: 0.3256, lng: 37.1231, name: "Project 3", tag: "stalled" },
          { lat: -1.1504, lng: 36.8907, name: "Project 4", tag: "abandoned" },
          { lat: 0.5673, lng: 35.2489, name: "Project 5", tag: "active" },
          { lat: -0.7584, lng: 36.9684, name: "Project 6", tag: "pending" },
          { lat: 1.0321, lng: 37.7456, name: "Project 7", tag: "stalled" },
          { lat: -0.5648, lng: 35.6892, name: "Project 8", tag: "abandoned" },
          { lat: -1.3201, lng: 36.9021, name: "Project 9", tag: "active" },
          { lat: 0.8231, lng: 36.4562, name: "Project 10", tag: "pending" },
          { lat: -0.8723, lng: 35.9231, name: "Project 11", tag: "stalled" },
          { lat: 0.2974, lng: 36.8762, name: "Project 12", tag: "abandoned" },
          { lat: 0.1492, lng: 37.5312, name: "Project 13", tag: "active" },
          { lat: -1.6754, lng: 36.1212, name: "Project 14", tag: "pending" },
          { lat: 0.9273, lng: 35.1342, name: "Project 15", tag: "stalled" },
          { lat: 0.6284, lng: 36.3173, name: "Project 16", tag: "abandoned" },
          { lat: -1.3627, lng: 36.5431, name: "Project 17", tag: "active" },
          { lat: 0.7542, lng: 35.9751, name: "Project 18", tag: "pending" },
          { lat: -0.8921, lng: 36.6519, name: "Project 19", tag: "stalled" },
          { lat: -1.0234, lng: 37.0917, name: "Project 20", tag: "abandoned" },
          { lat: 1.1023, lng: 36.8342, name: "Project 21", tag: "active" },
          { lat: 0.4132, lng: 35.8423, name: "Project 22", tag: "pending" },
          { lat: -0.5273, lng: 36.4398, name: "Project 23", tag: "stalled" },
          { lat: -1.2573, lng: 37.2812, name: "Project 24", tag: "abandoned" },
          { lat: 0.7632, lng: 35.1231, name: "Project 25", tag: "active" },
          { lat: -0.2734, lng: 36.9781, name: "Project 26", tag: "pending" },
          { lat: 1.0213, lng: 36.5341, name: "Project 27", tag: "stalled" },
          { lat: 0.6842, lng: 36.8345, name: "Project 28", tag: "abandoned" },
          { lat: -1.0214, lng: 37.2134, name: "Project 29", tag: "active" },
          { lat: 0.8123, lng: 35.7481, name: "Project 30", tag: "pending" },
          { lat: 0.9431, lng: 36.1934, name: "Project 31", tag: "stalled" },
          { lat: -0.7421, lng: 36.0298, name: "Project 32", tag: "abandoned" },
          { lat: -1.2419, lng: 36.7492, name: "Project 33", tag: "active" },
          { lat: 0.4561, lng: 35.9021, name: "Project 34", tag: "pending" },
          { lat: -0.6872, lng: 36.4983, name: "Project 35", tag: "stalled" },
          { lat: 0.9812, lng: 37.3847, name: "Project 36", tag: "abandoned" },
          { lat: -1.1023, lng: 36.9821, name: "Project 37", tag: "active" },
          { lat: 0.7421, lng: 36.4213, name: "Project 38", tag: "pending" },
          { lat: -0.3421, lng: 35.8741, name: "Project 39", tag: "stalled" },
          { lat: 0.9843, lng: 36.1321, name: "Project 40", tag: "abandoned" },
          { lat: 0.2142, lng: 37.8234, name: "Project 41", tag: "active" },
          { lat: -0.9432, lng: 36.9431, name: "Project 42", tag: "pending" },
          { lat: 1.1543, lng: 35.6212, name: "Project 43", tag: "stalled" },
          { lat: 0.5324, lng: 36.0932, name: "Project 44", tag: "abandoned" },
          { lat: -1.1932, lng: 36.8371, name: "Project 45", tag: "active" },
          { lat: 0.8934, lng: 35.8232, name: "Project 46", tag: "pending" },
          { lat: -0.4721, lng: 36.4731, name: "Project 47", tag: "stalled" },
          { lat: 0.6231, lng: 36.9512, name: "Project 48", tag: "abandoned" },
          { lat: -1.0132, lng: 36.3421, name: "Project 49", tag: "active" },
          { lat: 0.3782, lng: 35.6491, name: "Project 50", tag: "pending" },
        ];

        markerData.forEach((data) => {
          data.description = `This is a description for ${data.name}`;
          data.region = `Region ${Math.ceil(Math.random() * 10)}`;
          data.budget = `${(Math.random() * 100 + 10).toFixed(2)} million KES`;
          data.team = `${Math.ceil(Math.random() * 15 + 5)} members`;
          data.sponsor = `Sponsor for ${data.name}`;
          data.participants = Math.ceil(Math.random() * 100);
          data.start_date = new Date(
            Date.now() - Math.random() * 10000000000
          ).toISOString();
          data.status = data.tag;

          const marker = L.marker([data.lat, data.lng], {
            icon: icons.default(data.tag),
          })
            .addTo(map)
            .bindTooltip(data.name)
            .on("click", function () {
              if (selectedMarker && selectedMarker !== this) {
                selectedMarker.setIcon(icons.default(selectedMarker.tag));
              }
              this.setIcon(icons.selected(data.tag));
              selectedMarker = this;
              showProjectInfo(data);
            });

          marker.data = data;
          marker.tag = data.tag;
          markers.push(marker);
        });

        highlightMarkers("all");

        document
          .getElementById("searchInput")
          .addEventListener("input", (e) => {
            searchQuery = e.target.value.trim().toLowerCase();
            currentPage = 1;
            highlightMarkers(currentFilter);
          });

        document.getElementById("dateFrom").addEventListener("change", (e) => {
          dateRangeFrom = e.target.value ? new Date(e.target.value) : null;
          currentPage = 1;
          highlightMarkers(currentFilter);
        });

        document.getElementById("dateTo").addEventListener("change", (e) => {
          dateRangeTo = e.target.value ? new Date(e.target.value) : null;
          currentPage = 1;
          highlightMarkers(currentFilter);
        });

        document
          .getElementById("sortSelect")
          .addEventListener("change", (e) => {
            sortProjects(e.target.value);
          });
      });

      function showProjectInfo(project) {
        const infoBox = document.getElementById("projectInfo");
        infoBox.classList.remove("hidden");
        infoBox.innerHTML = `
            <h3 class="mb-4 text-xl font-bold text-gray-800">${
              project.name
            }</h3>
            <p><strong>Description:</strong> ${project.description}</p>
            <p><strong>Region:</strong> ${project.region}</p>
            <p><strong>Budget:</strong> ${project.budget}</p>
            <p><strong>Team:</strong> ${project.team}</p>
            <p><strong>Participants:</strong> ${project.participants}</p>
            <p><strong>Sponsor:</strong> ${project.sponsor}</p>
            <p><strong>Start Date:</strong> ${new Date(
              project.start_date
            ).toLocaleDateString()}</p>
            <p><strong>Status:</strong> <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge(
              project.status
            )}">${project.status}</span></p>
        `;
      }

      function focusMarker(index) {
        const marker = markers[index];
        map.setView(marker.getLatLng(), 9);
        marker.fire("click");
        document
          .getElementById("kenyaMap")
          .scrollIntoView({ behavior: "smooth" });
      }

      function sortProjects(field) {
        if (sortBy === field) {
          sortOrder = sortOrder === "asc" ? "desc" : "asc";
        } else {
          sortBy = field;
          sortOrder = "asc";
        }
        currentPage = 1;
        highlightMarkers(currentFilter);
      }

      function highlightMarkers(tag) {
        currentFilter = tag;
        const accordion = document.getElementById("projectAccordion");
        const infoBox = document.getElementById("projectInfo");
        infoBox.classList.add("hidden");
        accordion.innerHTML = "";
        accordion.classList.remove("hidden");
        accordion.classList.add("opacity-0", "translate-y-4");

        let filteredMarkers = markers.filter((marker) => {
          const p = marker.data;
          if (tag !== "all" && marker.tag !== tag) return false;
          if (searchQuery && !p.name.toLowerCase().includes(searchQuery))
            return false;
          const pDate = new Date(p.start_date);
          if (dateRangeFrom && pDate < dateRangeFrom) return false;
          if (dateRangeTo && pDate > dateRangeTo) return false;
          return true;
        });

        filteredMarkers.sort((a, b) => {
          const aVal =
            sortBy === "name" ? a.data.name : new Date(a.data.start_date);
          const bVal =
            sortBy === "name" ? b.data.name : new Date(b.data.start_date);
          return sortOrder === "asc"
            ? aVal > bVal
              ? 1
              : -1
            : aVal < bVal
            ? 1
            : -1;
        });

        const totalPages = Math.ceil(filteredMarkers.length / itemsPerPage);
        const paginated = filteredMarkers.slice(
          (currentPage - 1) * itemsPerPage,
          currentPage * itemsPerPage
        );
        updatePaginationControls(totalPages);

        markers.forEach((marker) => {
          marker.setOpacity(filteredMarkers.includes(marker) ? 1 : 0.1);
        });

        setTimeout(
          () => accordion.classList.remove("opacity-0", "translate-y-4"),
          10
        );

        paginated.forEach((marker, idx) => {
          const i = markers.indexOf(marker);
          const project = marker.data;
          const bg = bgColors[project.status] || bgColors.default;

          const item = document.createElement("div");
          item.className = `rounded shadow-sm ${bg}`;

          item.innerHTML = `
                <button class="w-full px-6 py-4 text-left border-b focus:outline-none" data-toggle="collapse-${i}">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800">${
                              project.name
                            }</h4>
                            <p class="text-sm text-gray-600">${
                              project.description
                            }</p>
                        </div>
                        <div class="mt-2 text-sm text-gray-500 sm:mt-0">${new Date(
                          project.start_date
                        ).toLocaleDateString()}</div>
                    </div>
                </button>
                <div id="collapse-${i}" class="hidden px-6 py-4 bg-white">
                    <p><strong>Region:</strong> ${project.region}</p>
                    <p><strong>Budget:</strong> ${project.budget}</p>
                    <p><strong>Team:</strong> ${project.team}</p>
                    <p><strong>Participants:</strong> ${
                      project.participants
                    }</p>
                    <p><strong>Sponsor:</strong> ${project.sponsor}</p>
                    <p><strong>Status:</strong> <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge(
                      project.status
                    )}">${project.status}</span></p>
                    <button onclick="focusMarker(${i})" class="px-5 py-2 mt-3 text-sm font-semibold text-white transition bg-blue-600 rounded hover:bg-blue-700 hover:scale-105">
                        Show on Map
                    </button>
                </div>
            `;

          accordion.appendChild(item);

          item
            .querySelector(`[data-toggle="collapse-${i}"]`)
            .addEventListener("click", () => {
              document
                .getElementById(`collapse-${i}`)
                .classList.toggle("hidden");
            });
        });
      }

      function updatePaginationControls(totalPages) {
        const container = document.getElementById("paginationControls");
        container.innerHTML = "";
        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement("button");
          btn.textContent = i;
          btn.className = `px-3 py-1 rounded ${
            i === currentPage
              ? "bg-blue-600 text-white"
              : "bg-gray-100 text-gray-800 hover:bg-gray-200"
          }`;
          btn.onclick = () => {
            currentPage = i;
            highlightMarkers(currentFilter);
          };
          container.appendChild(btn);
        }
      }

      function exportCSV() {
        const headers = [
          "Name",
          "Description",
          "Region",
          "Budget",
          "Team",
          "Participants",
          "Sponsor",
          "Start Date",
          "Status",
        ];
        const rows = markers
          .map((m) => m.data)
          .filter((p) => {
            if (searchQuery && !p.name.toLowerCase().includes(searchQuery))
              return false;
            const date = new Date(p.start_date);
            if (dateRangeFrom && date < dateRangeFrom) return false;
            if (dateRangeTo && date > dateRangeTo) return false;
            if (currentFilter !== "all" && p.status !== currentFilter)
              return false;
            return true;
          })
          .map((p) => [
            p.name,
            p.description,
            p.region,
            p.budget,
            p.team,
            p.participants,
            p.sponsor,
            new Date(p.start_date).toLocaleDateString(),
            p.status,
          ]);

        let csvContent = [headers.join(",")];
        rows.forEach((r) =>
          csvContent.push(r.map((field) => `"${field}"`).join(","))
        );

        const blob = new Blob([csvContent.join("\n")], { type: "text/csv" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `projects_${
          new Date().toISOString().split("T")[0]
        }.csv`;
        link.click();
      }

      // Show/hide admin collaboration menu and load pending count
      document.addEventListener("DOMContentLoaded", function () {
        const userRole = localStorage.getItem("userRole");

        // Show admin menu items if user is admin or super admin
        if (userRole === "ADMIN" || userRole === "SUPER_ADMIN") {
          const adminMenuItem = document.getElementById(
            "admin-collab-requests"
          );
          const adminMenuMobile = document.getElementById(
            "admin-collab-requests-mobile"
          );
          if (adminMenuItem) adminMenuItem.style.display = "block";
          if (adminMenuMobile) adminMenuMobile.style.display = "block";

          // Load pending collaboration requests count
          loadPendingRequestsCount();
        }
      });

      async function loadPendingRequestsCount() {
        try {
          const token = localStorage.getItem("accessToken");
          const response = await fetch(
            `${window.BASE_URL}/api/collaboration-requests/admin/pending`,
            {
              headers: { Authorization: `Bearer ${token}` },
            }
          );
          const data = await response.json();

          if (data.status === 200 && data.data.length > 0) {
            const badge = document.getElementById("pending-badge");
            if (badge) {
              badge.textContent = data.data.length;
              badge.style.display = "inline-block";
            }
          }
        } catch (error) {
          console.error("Error loading pending requests count:", error);
        }
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/tw-elements/js/tw-elements.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
    <!-- Leaflet JS -->
  </body>
</html>
