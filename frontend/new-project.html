<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>New Project - RMNCAH</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
		integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
		crossorigin="anonymous" referrerpolicy="no-referrer" />
	<!-- Tailwind CSS -->
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						primary: "#1e40af",
						secondary: "#f59e0b",
						accent: "#10b981",
						dark: "#1f2937",
					},
					fontFamily: {
						sans: ["Inter", "sans-serif"],
					},
				},
			},
		};
	</script>
	<link rel="stylesheet" href="styles/main.css" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800;900&display=swap"
		rel="stylesheet" />
	<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
	<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
	<link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
	<!-- Form Validation Script -->
	<script src="src/utils/form-validation.js"></script>
	<style>
		/* Larger popup close button for better accessibility */
		.mapboxgl-popup-close-button {
			font-size: 24px !important;
			width: 32px !important;
			height: 32px !important;
			line-height: 32px !important;
			padding: 0 !important;
			color: #4b5563 !important;
		}
		.mapboxgl-popup-close-button:hover {
			background-color: #f3f4f6 !important;
			color: #1f2937 !important;
		}
	</style>
</head>

<body x-data="newProjectsApp()" x-init="init()" class="text-gray-800">
	<script>
		window.newProjectsApp = function newProjectsApp() {
			return {
				announcements: [],
				myProjects: [],
				organizations: [],
				myCollaborationRequests: [], // Track user's submitted requests
				chatMessages: [],
				sendingMessage: false,
				newMessage: "",
				searchText: "",
				filterStatus: "",
				sortOrder: "NEWEST",
				activeSlide: 0,
				media: [
					{ type: 'image', src: 'resources/images/main-1.jpg' },
					{ type: 'image', src: 'resources/images/main-2.jpg' },
					{ type: 'image', src: 'resources/images/main-3.jpg' }
				],
				loading: true,
				creating: false,
				submitting: false,
				showCreateModal: false,
				showDetailsModal: false,
				showRequestModal: false,
				selectedAnnouncement: null,
				userRole: null, // Will be set in init from user object
				currentUser: null, // Store current user data including email
				newAnnouncement: {
					projectId: "",
					title: "",
					content: "",
					deadline: "",
				},
				collaborationRequest: {
					organizationId: "",
					proposedContribution: "",
				},

				async init() {
					// Wait for auth.js to load user data and get it directly
					const user = await this.waitForAuth();

					// Set user role and store user data from the returned user object
					if (user && user.role) {
						this.userRole = user.role;
						this.currentUser = user; // Store full user object
					} else {
						// Fallback: try to read from localStorage
						const userStr = localStorage.getItem("currentUser");
						if (userStr) {
							try {
								const parsedUser = JSON.parse(userStr);
								this.userRole = parsedUser.role;
								this.currentUser = parsedUser;
							} catch (e) {
								console.error("Error parsing user data:", e);
							}
						}
						// Final fallback to userRole if it exists
						if (!this.userRole) {
							this.userRole = localStorage.getItem("userRole");
						}
					}
					console.log("üîç User Role:", this.userRole); // Debug log
					console.log("üîç Current User:", this.currentUser); // Debug log

					// Show Priority option only for SUPER_ADMIN users
					const categorySelect = document.getElementById('project_category');
					if (this.userRole && this.userRole.startsWith('SUPER_ADMIN')) {
						const priorityOption = document.createElement('option');
						priorityOption.value = 'PRIORITY';
						priorityOption.textContent = 'Priority Project';
						categorySelect.appendChild(priorityOption);
					}

					// Populate user dropdown in navigation
					if (this.currentUser) {
						console.log("üë§ Populating user dropdown...");
						this.populateUserDropdown(this.currentUser);
					}

					await this.loadAnnouncements();

					// Always try to load projects if user is authenticated
					// The backend will handle authorization
					const token = localStorage.getItem("accessToken");
					if (token) {
						console.log("üîç User authenticated, loading projects...");
						await this.loadMyProjects();
						await this.loadOrganizations();
						// Load user's collaboration requests to prevent duplicates
						await this.loadMyCollaborationRequests();
					} else {
						console.warn("‚ö†Ô∏è No access token found, skipping project load");
					}
				},

				// Populate user dropdown with current user data
				populateUserDropdown(user) {
					try {
						const userDisplayName =
							document.getElementById("userDisplayName");
						const userNameDisplay =
							document.getElementById("userNameDisplay");
						const userEmailDisplay =
							document.getElementById("userEmailDisplay");
						const userRoleDisplay =
							document.getElementById("userRoleDisplay");
						const userStatusDisplay =
							document.getElementById("userStatusDisplay");

						if (userDisplayName)
							userDisplayName.textContent = user.name || "User";
						if (userNameDisplay)
							userNameDisplay.textContent = user.name || "Loading...";
						if (userEmailDisplay)
							userEmailDisplay.textContent = user.email || "";
						if (userRoleDisplay)
							userRoleDisplay.textContent = user.role || "N/A";
						if (userStatusDisplay) {
							userStatusDisplay.textContent = user.status || "N/A";
							// Update status color based on status
							userStatusDisplay.className =
								user.status === "ACTIVE"
									? "font-medium text-green-600"
									: "font-medium text-gray-600";
						}

						// Show role-based navs
						if (
							user.role === "ADMIN" ||
							user.role === "SUPER_ADMIN" ||
							user.role === "SUPER_ADMIN_REVIEWER" ||
							user.role === "SUPER_ADMIN_APPROVER" ||
							user.role === "SUPER_ADMIN_REVIEWER" ||
							user.role === "SUPER_ADMIN_APPROVER"
						) {
							const adminNav = document.getElementById("adminNav");
							if (adminNav) adminNav.classList.remove("hidden");
						}
						if (user.role === "DONOR") {
							const donorNav = document.getElementById("donorNav");
							if (donorNav) donorNav.classList.remove("hidden");
						}

						console.log("‚úÖ User dropdown populated successfully!");
					} catch (error) {
						console.error("‚ùå Error populating user dropdown:", error);
					}
				},

				async waitForAuth() {
					// Wait for AuthManager to be available and initialized
					let attempts = 0;
					while (attempts < 50) {
						// Max 5 seconds
						if (
							window.authManager &&
							typeof window.authManager.getCurrentUser === "function"
						) {
							// Try to get current user and return it directly
							try {
								const user = await window.authManager.getCurrentUser();
								return user; // Return the user object
							} catch (e) {
								// User not logged in or error
								return null;
							}
						}
						await new Promise((resolve) => setTimeout(resolve, 100));
						attempts++;
					}
					return null; // Timeout - no auth available
				},

				async loadAnnouncements() {
					try {
						const response = await fetch(
							`${window.BASE_URL}/api/announcements`
						);
						const data = await response.json();
						if (data.status === 200) {
							this.announcements = data.data;
						}
					} catch (error) {
						console.error("Error loading announcements:", error);
						await showAlert("Failed to load announcements", "Error", "error");
					} finally {
						this.loading = false;
					}
				},

				async loadMyProjects() {
					try {
						const token = localStorage.getItem("accessToken");
						console.log(
							"üîç Loading my projects with token:",
							token ? "Present" : "Missing"
						);

						const response = await fetch(
							`${window.BASE_URL}/api/projects/my-projects`,
							{
								headers: { Authorization: `Bearer ${token}` },
							}
						);

						console.log("üîç My projects response status:", response.status);

						if (!response.ok) {
							console.error(
								"‚ùå Failed to load projects. Status:",
								response.status
							);
							if (response.status === 403) {
								console.error(
									"‚ùå 403 Forbidden - You may not have PARTNER role"
								);
							} else if (response.status === 401) {
								console.error(
									"‚ùå 401 Unauthorized - Token may be invalid or expired"
								);
							}
							this.myProjects = [];
							return;
						}

						const data = await response.json();
						console.log("üîç My projects response data:", data);

						if (data.status === 200) {
							this.myProjects = data.data || [];
							console.log(
								"‚úÖ Loaded projects:",
								this.myProjects.length,
								"projects"
							);
							console.log("üìã Projects:", this.myProjects);
						} else {
							console.warn("‚ö†Ô∏è Unexpected response status:", data.status);
							this.myProjects = [];
						}
					} catch (error) {
						console.error("‚ùå Error loading projects:", error);
						this.myProjects = [];
					}
				},

				async loadOrganizations() {
					try {
						const token = localStorage.getItem("accessToken");
						const response = await fetch(
							`${window.BASE_URL}/api/organizations`,
							{
								headers: { Authorization: `Bearer ${token}` },
							}
						);

						// Check if response is OK before parsing JSON
						if (!response.ok) {
							// Silently handle 403 - organizations endpoint may be restricted
							this.organizations = []; // Set empty array
							return;
						}

						const data = await response.json();
						if (data.status === 200) {
							this.organizations = data.data;
						}
					} catch (error) {
						// Silently handle errors - organizations are optional
						this.organizations = []; // Set empty array on error
					}
				},

				async loadMyCollaborationRequests() {
					try {
						const token = localStorage.getItem("accessToken");
						const response = await fetch(
							`${window.BASE_URL}/api/collaboration-requests/my-requests`,
							{
								headers: { Authorization: `Bearer ${token}` },
							}
						);

						if (!response.ok) {
							console.warn(
								"Could not load collaboration requests:",
								response.status
							);
							this.myCollaborationRequests = [];
							return;
						}

						const data = await response.json();
						if (data.status === 200) {
							this.myCollaborationRequests = data.data || [];
							console.log(
								"‚úÖ Loaded collaboration requests:",
								this.myCollaborationRequests.length
							);
						} else {
							this.myCollaborationRequests = [];
						}
					} catch (error) {
						console.error("Error loading collaboration requests:", error);
						this.myCollaborationRequests = [];
					}
				},

				async createAnnouncement() {
					this.creating = true;
					try {
						const token = localStorage.getItem("accessToken");
						const response = await fetch(
							`${window.BASE_URL}/api/announcements`,
							{
								method: "POST",
								headers: {
									"Content-Type": "application/json",
									Authorization: `Bearer ${token}`,
								},
								body: JSON.stringify(this.newAnnouncement),
							}
						);

						// Check if response is OK before parsing JSON
						if (!response.ok) {
							if (response.status === 403) {
								await showAlert(
									"Permission denied. You may not have access to create announcements.",
									"Permission Denied",
									"error"
								);
							} else if (response.status === 401) {
								await showAlert(
									"You must be logged in to create announcements.",
									"Authentication Required",
									"warning"
								);
							} else {
								await showAlert(
									`Error: Server returned status ${response.status}`,
									"Error",
									"error"
								);
							}
							return;
						}

						const data = await response.json();

						if (data.status === 201) {
							await showAlert(
								"Announcement created successfully!",
								"Success",
								"success"
							);
							this.showCreateModal = false;
							this.newAnnouncement = {
								projectId: "",
								title: "",
								content: "",
								deadline: "",
							};
							await this.loadAnnouncements();
						} else {
							await showAlert(
								"Error: " + (data.message || "Unknown error occurred"),
								"Error",
								"error"
							);
						}
					} catch (error) {
						console.error("Error creating announcement:", error);
						await showAlert(
							"Failed to create announcement. Please try again.",
							"Error",
							"error"
						);
					} finally {
						this.creating = false;
					}
				},

				viewDetails(announcement) {
					this.selectedAnnouncement = announcement;
					this.showDetailsModal = true;
					this.loadChatMessages(announcement.id);
				},

				requestCollaboration(announcement) {
					this.selectedAnnouncement = announcement;
					this.showRequestModal = true;
					this.showDetailsModal = false;
				},

				async submitRequest() {
					this.submitting = true;
					try {
						const token = localStorage.getItem("accessToken");

						// Prepare request payload - only include organizationId if it's not empty
						const payload = {
							proposedContribution:
								this.collaborationRequest.proposedContribution,
						};

						// Only add organizationId if it's set (not empty string)
						if (this.collaborationRequest.organizationId) {
							payload.organizationId = parseInt(
								this.collaborationRequest.organizationId
							);
						}

						const response = await fetch(
							`${window.BASE_URL}/api/collaboration-requests/announcements/${this.selectedAnnouncement.id}`,
							{
								method: "POST",
								headers: {
									"Content-Type": "application/json",
									Authorization: `Bearer ${token}`,
								},
								body: JSON.stringify(payload),
							}
						);

						// Always try to parse JSON to get the error message
						const data = await response.json();

						// Check if response is OK
						if (!response.ok) {
							if (response.status === 403) {
								await showAlert(
									"Permission denied: " +
									(data.message ||
										"You may not have access to submit collaboration requests."),
									"Permission Denied",
									"error"
								);
							} else if (response.status === 401) {
								await showAlert(
									"Authentication required: " +
									(data.message ||
										"You must be logged in to submit a collaboration request."),
									"Authentication Required",
									"warning"
								);
							} else if (response.status === 400) {
								await showAlert(
									"Invalid request: " +
									(data.message ||
										"Please check your input and try again."),
									"Invalid Request",
									"error"
								);
							} else {
								await showAlert(
									`Error: ${data.message ||
									"Server returned status " + response.status
									}`,
									"Error",
									"error"
								);
							}
							return;
						}

						if (data.status === 201) {
							await showAlert(
								"Collaboration request submitted successfully! The Ministry of Health will review your request.",
								"Success",
								"success"
							);
							this.showRequestModal = false;
							this.collaborationRequest = {
								organizationId: "",
								proposedContribution: "",
							};
							// Reload collaboration requests to update the UI
							await this.loadMyCollaborationRequests();
						} else {
							await showAlert(
								"Error: " + (data.message || "Unknown error occurred"),
								"Error",
								"error"
							);
						}
					} catch (error) {
						console.error("Error submitting request:", error);
						await showAlert(
							"Failed to submit collaboration request. Please try again.",
							"Error",
							"error"
						);
					} finally {
						this.submitting = false;
					}
				},

				// Helper method to check if announcement was created by current user
				isOwnAnnouncement(announcement) {
					if (!this.currentUser || !announcement || !announcement.createdBy) {
						console.log("üîç isOwnAnnouncement: Missing data", {
							hasCurrentUser: !!this.currentUser,
							hasAnnouncement: !!announcement,
							hasCreatedBy: !!(announcement && announcement.createdBy),
						});
						return false;
					}
					// Compare by email as it's unique
					const isOwn =
						this.currentUser.email === announcement.createdBy.email;
					console.log("üîç isOwnAnnouncement:", {
						currentUserEmail: this.currentUser.email,
						createdByEmail: announcement.createdBy.email,
						isOwn: isOwn,
					});
					return isOwn;
				},

				// Helper method to check if user has already requested collaboration for this announcement
				hasAlreadyRequested(announcement) {
					if (!announcement || !this.myCollaborationRequests) {
						return false;
					}

					const hasRequested = this.myCollaborationRequests.some(
						(request) =>
							request.announcement &&
							request.announcement.id === announcement.id
					);

					console.log("üîç hasAlreadyRequested:", {
						announcementId: announcement.id,
						totalRequests: this.myCollaborationRequests.length,
						hasRequested: hasRequested,
					});

					return hasRequested;
				},

				isDeadlineImminent(deadline) {
					if (!deadline) return false;
					const now = new Date();
					const deadlineDate = new Date(deadline);
					const diffTime = deadlineDate - now;
					const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
					return diffDays <= 7 && diffDays >= 0; // Imminent if within 7 days and not past
				},

				async loadChatMessages(announcementId) {
					try {
						const token = localStorage.getItem("accessToken");
						const response = await fetch(`${window.BASE_URL}/api/announcements/${announcementId}/messages`, {
							headers: { Authorization: `Bearer ${token}` }
						});
						if (response.ok) {
							const data = await response.json();
							this.chatMessages = data.data || [];
						}
					} catch (error) {
						console.error("Error loading chat messages:", error);
					}
				},

				async sendMessage() {
					if (!this.newMessage.trim()) return;
					this.sendingMessage = true;
					try {
						const token = localStorage.getItem("accessToken");
						const response = await fetch(`${window.BASE_URL}/api/announcements/${this.selectedAnnouncement.id}/messages`, {
							method: "POST",
							headers: {
								"Content-Type": "application/json",
								Authorization: `Bearer ${token}`
							},
							body: JSON.stringify({ message: this.newMessage })
						});
						if (response.ok) {
							this.newMessage = "";
							await this.loadChatMessages(this.selectedAnnouncement.id);
						} else {
							await showAlert("Failed to send message", "Error", "error");
						}
					} catch (error) {
						console.error("Error sending message:", error);
						await showAlert("Failed to send message", "Error", "error");
					} finally {
						this.sendingMessage = false;
					}
				},

				async editMessage(msg) {
					const newMessage = prompt("Edit message:", msg.message);
					if (newMessage && newMessage.trim() && newMessage !== msg.message) {
						try {
							const token = localStorage.getItem("accessToken");
							const response = await fetch(`${window.BASE_URL}/api/announcements/${this.selectedAnnouncement.id}/messages/${msg.id}`, {
								method: "PUT",
								headers: {
									"Content-Type": "application/json",
									Authorization: `Bearer ${token}`
								},
								body: JSON.stringify({ message: newMessage })
							});
							if (response.ok) {
								await this.loadChatMessages(this.selectedAnnouncement.id);
							} else {
								await showAlert("Failed to edit message", "Error", "error");
							}
						} catch (error) {
							console.error("Error editing message:", error);
							await showAlert("Failed to edit message", "Error", "error");
						}
					}
				},

				async deleteMessage(msg) {
					if (confirm("Are you sure you want to delete this message?")) {
						try {
							const token = localStorage.getItem("accessToken");
							const response = await fetch(`${window.BASE_URL}/api/announcements/${this.selectedAnnouncement.id}/messages/${msg.id}`, {
								method: "DELETE",
								headers: {
									Authorization: `Bearer ${token}`
								}
							});
							if (response.ok) {
								await this.loadChatMessages(this.selectedAnnouncement.id);
							} else {
								await showAlert("Failed to delete message", "Error", "error");
							}
						} catch (error) {
							console.error("Error deleting message:", error);
							await showAlert("Failed to delete message", "Error", "error");
						}
					}
				},
			};
		};
	</script>
	<!-- Navigation -->
	<div class="" id="nav-placeholder"></div>

	<!-- Main Content -->
	<div class="pt-24 pb-12">

		<div class="max-w-7xl mx-auto bg-white rounded-xl shadow-md p-8 my-10">
			<!-- Progress Header -->
			<div class="mb-8">
				<h2 class="text-2xl font-semibold text-blue-900 mb-4">Project Submission Form</h2>
				<div class="w-full bg-gray-200 rounded-full h-2.5">
					<div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 14.28%"></div>
				</div>
				<p id="progressText" class="text-sm text-gray-600 mt-2">Step 1 of 7: Project Location</p>
			</div>

			<!-- Form Sections -->
			<form id="projectForm" class="space-y-8">
				<!-- Step 1: Project Location -->
				<div class="form-step block" data-step="1">
					<div class="mb-4">
						<h2 class="text-xl font-bold text-gray-800 flex items-center">
							<span
								class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3">1</span>
							Project Location
						</h2>
						<p class="text-sm text-gray-600 mt-1">
							Search and select the geographical locations where your project will be implemented
						</p>
						<hr class="mt-4">
					</div>

					<!-- Location Search -->
					<div class="mb-4">
						<label class="block text-sm font-medium text-gray-700 mb-2">
							Search for Location
						</label>
						<div class="relative mb-3">
							<div class="relative">
								<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
									<i class="fas fa-search text-gray-400"></i>
								</div>
								<input
									type="text"
									id="mapSearchInput"
									placeholder="Search for a location (e.g., Nairobi, Meru County, hospital name, or coordinates)"
									class="block w-full pl-10 pr-10 py-3 text-black border border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500 sm:text-sm"
									autocomplete="off"
								/>
								<button
									type="button"
									id="clearSearchBtn"
									class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 hidden"
									title="Clear search"
								>
									<i class="fas fa-times"></i>
								</button>
							</div>

							<!-- Search Results Dropdown -->
							<div
								id="searchResults"
								class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-64 overflow-y-auto hidden"
							>
								<!-- Search results will be populated here -->
							</div>

							<!-- Search Info/Help Text -->
							<div class="flex items-start mt-2 text-xs text-gray-500 space-x-4">
								<div class="flex items-center">
									<i class="fas fa-info-circle mr-1"></i>
									<span>Search by place name, county, or coordinates</span>
								</div>
								<div class="flex items-center">
									<i class="fas fa-map-marker-alt mr-1"></i>
									<span>Click result to add to map</span>
								</div>
							</div>
						</div>
					</div>

					<!-- Map Section -->
					<div class="mt-2">
						<label class="block text-sm font-medium text-gray-700 mb-2">Pick Project Locations on
							Map (Click to add
							multiple
							locations)</label>
						<div id="newProjectMap" style="
									height: 400px;
									width: 100%;
									border-radius: 8px;
									margin-bottom: 8px;
									border: 1px solid #e5e7eb;
									background-color: #f3f4f6;
									position: relative;
									overflow: hidden;
									"></div>
						<input type="hidden" id="project_locations" name="locations" />
						<div class="text-sm text-gray-700 mt-2 p-2 bg-gray-50 rounded">
							<strong>Selected Locations:</strong>
							<div id="selectedLocationsList" class="mt-2 space-y-1">
								<p class="text-gray-500 italic">
									Click on map to add locations
								</p>
							</div>
						</div>
					</div>
				</div>

				<!-- Step 2: Basic Information -->
				<div class="form-step hidden" data-step="2">
					<div class="mb-4">
						<h2 class="text-xl font-bold text-gray-800 flex items-center">
							<span
								class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3">2</span>
							Basic Information
						</h2>
						<p class="text-sm text-gray-600 mt-1 ">
							Provide essential details about your project
						</p>
						<hr class="mt-4">
					</div>
					<!-- Project Category -->
					<div class="mb-6">
						<label for="project_category" class="block text-sm font-medium text-gray-700">Project Category *</label>
						<select required id="project_category" name="project_category"
							class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
							<option value="IMPLEMENTING">Implementing Project</option>
							<option value="RESEARCH">Research Project</option>
						</select>
						<p class="mt-2 text-xs text-gray-600">
							<strong class="text-purple-700">Research:</strong> Systematic study and data collection to advance knowledge<br>
							<strong class="text-green-700">Implementing:</strong> Operational programs delivering services on the ground<br>
							<span id="priority-notice" class="hidden">
								<strong class="text-orange-700">Priority:</strong> Government-led initiatives addressing critical health needs
							</span>
						</p>
					</div>
					<!-- Title -->
					<div class="mb-6">
						<label for="title" class="block text-sm font-medium text-gray-700">Project Title
							*</label>
						<input required type="text" id="title" name="title" minlength="5" maxlength="200"
							placeholder="Enter a descriptive project title"
							class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
					</div>

					<!-- Time Period -->
					<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
						<div>
							<label for="starttime_period" class="block text-sm font-medium text-gray-700">Start
								Date *</label>
							<input required type="date" id="starttime_period" name="start_date"
								class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
						</div>
						<div>
							<label for="endtime_period" class="block text-sm font-medium text-gray-700">End
								Date</label>
							<input type="date" id="endtime_period" name="end_date"
								class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
						</div>
					</div>

					<!-- Activity Type -->
					<div>
						<label for="activity_type" class="block text-sm font-medium text-gray-700">Activity Type
							(Description)
							*</label>
						<textarea required id="activity_type" name="activity_type" rows="3" minlength="10" maxlength="1000"
							placeholder="Describe the type of activities this project will undertake"
							class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
					</div>
				</div>

				<!-- Step 3: Project Themes -->
				<div class="form-step hidden" data-step="3">
					<div class="mb-4">
						<h2 class="text-xl font-bold text-gray-800 flex items-center">
							<span
								class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3">3</span>
							Project Themes
						</h2>
						<p class="text-sm text-gray-600 mt-1 ">
							Provide essential details about your project
						</p>
						<hr class="mt-4">
					</div>
					<div
						class="theme-selection bg-white rounded-lg border-2 border-gray-200 p-6 transition-all duration-200 hover:border-blue-300 hover:shadow-md">
						<div class="flex items-center justify-between mb-4">
							<label class="block text-lg font-semibold text-gray-800">
								Project Themes *
							</label>
							<div id="selectedThemesDisplay"
								class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm font-medium">
								<i class="fas fa-check-circle mr-1"></i>
								<span id="themesCount">0</span> selected
							</div>
						</div>

						<p class="text-sm text-gray-600 mb-4">
							Select all themes that apply to your project (minimum 1
							required)
						</p>

						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<label
								class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group">
								<input type="checkbox" name="themes" value="GBV"
									class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3" />
								<div class="flex-1">
									<span class="font-medium text-gray-800 group-hover:text-blue-800">Gender
										Based Violence</span>
									<p class="text-xs text-gray-500 mt-1">
										GBV prevention and support programs
									</p>
								</div>
								<div class="checkmark hidden text-green-500 ml-2">
									<i class="fas fa-check"></i>
								</div>
							</label>

							<label
								class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group">
								<input type="checkbox" name="themes" value="AYPSRH"
									class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3" />
								<div class="flex-1">
									<span class="font-medium text-gray-800 group-hover:text-blue-800">Adolescent
										& Youth SRH</span>
									<p class="text-xs text-gray-500 mt-1">
										Sexual and reproductive health for young people
									</p>
								</div>
								<div class="checkmark hidden text-green-500 ml-2">
									<i class="fas fa-check"></i>
								</div>
							</label>

							<label
								class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group">
								<input type="checkbox" name="themes" value="MNH"
									class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3" />
								<div class="flex-1">
									<span class="font-medium text-gray-800 group-hover:text-blue-800">Maternal &
										Newborn Health</span>
									<p class="text-xs text-gray-500 mt-1">
										Maternal care and newborn health programs
									</p>
								</div>
								<div class="checkmark hidden text-green-500 ml-2">
									<i class="fas fa-check"></i>
								</div>
							</label>

							<label
								class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group">
								<input type="checkbox" name="themes" value="FP"
									class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3" />
								<div class="flex-1">
									<span class="font-medium text-gray-800 group-hover:text-blue-800">Family
										Planning</span>
									<p class="text-xs text-gray-500 mt-1">
										Contraception and family planning services
									</p>
								</div>
								<div class="checkmark hidden text-green-500 ml-2">
									<i class="fas fa-check"></i>
								</div>
							</label>

							<label
								class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group">
								<input type="checkbox" name="themes" value="CH"
									class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3" />
								<div class="flex-1">
									<span class="font-medium text-gray-800 group-hover:text-blue-800">Child
										Health</span>
									<p class="text-xs text-gray-500 mt-1">
										Child healthcare and nutrition programs
									</p>
								</div>
								<div class="checkmark hidden text-green-500 ml-2">
									<i class="fas fa-check"></i>
								</div>
							</label>

							<label
								class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group">
								<input type="checkbox" name="themes" value="AH"
									class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3" />
								<div class="flex-1">
									<span class="font-medium text-gray-800 group-hover:text-blue-800">Adolescent
										Health</span>
									<p class="text-xs text-gray-500 mt-1">
										Adolescent healthcare and development
									</p>
								</div>
								<div class="checkmark hidden text-green-500 ml-2">
									<i class="fas fa-check"></i>
								</div>
							</label>
						</div>

						<input type="hidden" id="selected_themes" name="selected_themes" value="[]" />

						<div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg hidden"
							id="themeValidationError">
							<div class="flex items-center">
								<i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
								<span class="text-red-700 text-sm">Please select at least one project
									theme.</span>
							</div>
						</div>
					</div>
				</div>


				<!-- Step 4: Contact Information -->
				<div class="form-step hidden" data-step="4">
					<div class="mb-4">
						<h2 class="text-xl font-bold text-gray-800 flex items-center">
							<span
								class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3">4</span>
							Contact Information
						</h2>
						<p class="text-sm text-gray-600 mt-1 ">
							Provide details for project coordination
						</p>
						<hr class="mt-4">
					</div>
					<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
						<div>
							<label for="contact_person_name" class="block text-sm font-medium text-gray-700">Contact
								Person Name
								*</label>
							<input required type="text" id="contact_person_name" name="contact_person_name"
								placeholder="Name"
								class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
						</div>
						<div>
							<label for="contact_person_role" class="block text-sm font-medium text-gray-700">Contact
								Person Role
								*</label>
							<input required type="text" id="contact_person_role" name="contact_person_role"
								placeholder="Role"
								class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
						</div>
						<div>
							<label for="contact_person_email" class="block text-sm font-medium text-gray-700">Contact
								Person
								Email *</label>
							<input required type="email" id="contact_person_email" name="contact_person_mail"
								placeholder="Email"
								class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
						</div>
					</div>
				</div>

				<!-- Step 5: Budget & Objectives -->
				<div class="form-step hidden" data-step="5">
					<div class="mb-4">
						<h2 class="text-xl font-bold text-gray-800 flex items-center">
							<span
								class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3">5</span>
							Budget & Objectives
						</h2>
						<p class="text-sm text-gray-600 mt-1 ">
							Provide budget estimates and project goals
						</p>
						<hr class="mt-4">
					</div>
					<div>
						<label for="currency" class="block text-sm font-medium text-gray-700">
							Currency*</label>
						<select id="currency" name="currency" required
							class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
							<option value="">
								Select Currency
							</option>
							<option value="EUR">
								Euro
							</option>
							<option value="KES">
								Kenyan Shilling
							</option>
							<option value="USD">
								US Dollar
							</option>
						</select>

					</div>
					<div>
						<label for="budget" class="block text-sm font-medium text-gray-700">Amount *</label>
						<input required type="text" id="budget" name="budget" placeholder="1,000,000" min="0.01"
							class="block w-full p-2 mt-1 numbers-only text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
					</div>
					<!-- Objectives -->
					<div>
						<label for="objectives" class="block text-sm font-medium text-gray-700">Project
							Objectives *</label>
						<textarea required id="objectives" name="objectives" rows="3" minlength="20" maxlength="2000"
							placeholder="Describe the main objectives and expected outcomes of this project"
							class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
					</div>
				</div>

				<!-- Step 6: Supporting Documents -->
				<div class="form-step hidden" data-step="6">
					<div class="mb-4">
						<h2 class="text-xl font-bold text-gray-800 flex items-center">
							<span
								class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3">6</span>
							Supporting Documents
						</h2>
						<p class="text-sm text-gray-600 mt-1 ">
							Upload relevant documents to support
							your project proposal
						</p>
						<hr class="mt-4">
					</div>
					<div
						class="supporting-documents bg-white rounded-lg border-2 border-gray-200 p-6 transition-all duration-200 hover:border-blue-300 hover:shadow-md">
						<div class="flex items-center justify-between mb-4">
							<label class="block text-lg font-semibold text-gray-800">
								Supporting Documents <span class="font-light text-sm ml-1">(optional)</span>

							</label>
							<div id="documentsCount"
								class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm font-medium">
								<i class="fas fa-file mr-1"></i>
								<span id="docsCount">0</span> files
							</div>
						</div>

						<p class="text-sm text-gray-600 mb-4">
							Upload relevant documents such as to support
							your project proposal
							(PDF, DOC, DOCX, XLS, XLSX - Max 10MB each)
						</p>

						<!-- File Upload Area -->
						<div class="file-upload-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 hover:bg-blue-50 transition-all duration-200 cursor-pointer"
							id="fileUploadArea">
							<div class="upload-icon text-gray-400 mb-4">
								<i class="fas fa-cloud-upload-alt text-4xl"></i>
							</div>
							<div class="upload-text">
								<p class="text-lg font-medium text-gray-700 mb-2">
									Drop files here or click to browse
								</p>
								<p class="text-sm text-gray-500">
									Supported formats: PDF, DOC, DOCX, XLS, XLSX
								</p>
								<p class="text-xs text-gray-400 mt-1">
									Maximum file size: 10MB per file
								</p>
							</div>
							<input type="file" id="documentFiles" name="documents" multiple
								accept=".pdf,.doc,.docx,.xls,.xlsx" class="hidden" />
						</div>

						<!-- Selected Files Display -->
						<div id="selectedFiles" class="mt-4 space-y-2 hidden">
							<h4 class="text-sm font-medium text-gray-700 mb-3">
								Selected Files:
							</h4>
							<div id="filesList" class="space-y-2">
								<!-- Files will be added here dynamically -->
							</div>
						</div>

						<!-- File Upload Error -->
						<div class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg hidden" id="fileUploadError">
							<div class="flex items-center">
								<i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
								<span class="text-red-700 text-sm" id="fileErrorMessage"></span>
							</div>
						</div>
					</div>
				</div>

				<!-- Step 7: Collaborators (Optional) -->
				<div class="form-step hidden" data-step="7">
					<div class="mb-4">
						<h2 class="text-xl font-bold text-gray-800 flex items-center">
							<span
								class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3">7</span>
							Project Collaborators
						</h2>
						<p class="text-sm text-gray-600 mt-1">
							Add collaborators who will have access to view and edit this project (optional)
						</p>
						<hr class="mt-4">
					</div>

					<!-- Collaborators Selection -->
					<div class="bg-white rounded-lg border-2 border-gray-200 p-6 transition-all duration-200 hover:border-blue-300 hover:shadow-md">
						<div class="mb-4">
							<label class="block text-lg font-semibold text-gray-800 mb-2">
								Select Collaborators
							</label>
							<p class="text-sm text-gray-600 mb-4">
								Choose partners who can collaborate on this project. You can add multiple collaborators.
							</p>

							<!-- Search/Filter Input -->
							<div class="mb-4">
								<input type="text" id="collaboratorSearch" 
									placeholder="Search by name or email..." 
									class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
							</div>

							<!-- Loading State -->
							<div id="collaboratorsLoading" class="text-center py-8 hidden">
								<i class="fas fa-spinner fa-spin text-3xl text-blue-600"></i>
								<p class="mt-3 text-gray-600">Loading available partners...</p>
							</div>

							<!-- Error State -->
							<div id="collaboratorsError" class="p-4 bg-red-50 border border-red-200 rounded-lg hidden">
								<div class="flex items-center">
									<i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
									<span class="text-red-700 text-sm" id="collaboratorsErrorMessage"></span>
								</div>
							</div>

							<!-- Available Collaborators List -->
							<div id="availableCollaboratorsList" class="space-y-2 max-h-96 overflow-y-auto">
								<!-- Will be populated dynamically -->
							</div>

							<!-- Empty State -->
							<div id="noCollaboratorsMessage" class="text-center py-8 text-gray-500 hidden">
								<i class="fas fa-users text-4xl mb-2"></i>
								<p>No available partners found</p>
							</div>
						</div>

						<!-- Selected Collaborators -->
						<div id="selectedCollaboratorsSection" class="mt-6 pt-6 border-t border-gray-200 hidden">
							<h3 class="text-md font-semibold text-gray-800 mb-3">
								Selected Collaborators (<span id="selectedCollaboratorsCount">0</span>)
							</h3>
							<div id="selectedCollaboratorsList" class="space-y-2">
								<!-- Will be populated dynamically -->
							</div>
						</div>
					</div>

					<!-- Hidden input to store selected collaborator emails -->
					<input type="hidden" id="selected_collaborators" name="selected_collaborators" value="[]" />
				</div>

				<!-- Navigation Buttons -->
				<div class="flex justify-between mt-10">
					<button type="button" id="prevBtn"
						class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300">Previous</button>
					<button type="button" id="nextBtn"
						class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700">Next</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Scripts -->
	<script src="styles/numbersOnly.js"></script>
	<script src="styles/loadNav.js"></script>
	<script src="styles/authnav.js"></script>
	<script src="styles/projectSteps.js"></script>
	<script src="config.local.js"></script>
	<script src="config.js"></script>
	<script src="auth.js"></script>
	<script src="kenya-locations.js"></script>
	<script src="set-base-url.js"></script>
	<script>
		// Define showAlert function globally before it's used
		window.showAlert = function(message, title = "Alert", type = "info") {
			console.log(`showAlert called: ${title} - ${message} (${type})`);

			return new Promise((resolve) => {
				// Create modal element
				const modal = document.createElement('div');
				modal.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50';

				// Set icon and color based on type
				let iconClass = 'fas fa-info-circle text-blue-500';
				let buttonClass = 'bg-blue-600 hover:bg-blue-700';

				if (type === 'error') {
					iconClass = 'fas fa-exclamation-triangle text-red-500';
					buttonClass = 'bg-red-600 hover:bg-red-700';
				} else if (type === 'success') {
					iconClass = 'fas fa-check-circle text-green-500';
					buttonClass = 'bg-green-600 hover:bg-green-700';
				} else if (type === 'warning') {
					iconClass = 'fas fa-exclamation-circle text-yellow-500';
					buttonClass = 'bg-yellow-600 hover:bg-yellow-700';
				}

				modal.innerHTML = `
					<div class='bg-white rounded-lg p-6 max-w-md mx-4 shadow-xl'>
						<div class='flex items-center mb-4'>
							<i class='${iconClass} text-xl mr-3'></i>
							<h3 class='text-lg font-semibold text-gray-900'>${title}</h3>
						</div>
						<div class='text-gray-600 mb-4'>${message}</div>
						<button id='modalCloseBtn' class='w-full ${buttonClass} text-white px-4 py-2 rounded-lg transition-colors'>
							OK
						</button>
					</div>
				`;

				document.body.appendChild(modal);

				// Resolve only when user clicks OK
				modal.querySelector('#modalCloseBtn').addEventListener('click', () => {
					modal.remove();
					resolve();
				});
			});
		};

		// Initialize everything when DOM is loaded
		document.addEventListener("DOMContentLoaded", function () {
			// Add global error handler
			window.addEventListener('error', function(event) {
				console.error('Global JavaScript error:', event.error);
				console.error('Error details:', {
					message: event.error.message,
					filename: event.error.filename,
					lineno: event.error.lineno,
					colno: event.error.colno,
					stack: event.error.stack
				});
			});

			// Add unhandled promise rejection handler
			window.addEventListener('unhandledrejection', function(event) {
				console.error('Unhandled promise rejection:', event.reason);
				console.error('Promise rejection details:', event);
			});

			initializeMap();
			initializeMapSearch();
			initializeThemeSelection();
			initializeFileUpload();
			initializeFormProgress();
			initializeBudgetFormatting();
			initializeCollaborators();
			initializeRealTimeValidation();
		});

		// Map initialization
		let map;
		let markers = [];
		let selectedLocations = [];

		function updateLocation(marker, newLngLat) {
			// Find the location in our array and update it
			const locationIndex = selectedLocations.findIndex(
				(loc) => loc.marker === marker
			);
			if (locationIndex !== -1) {
				selectedLocations[locationIndex].lat = newLngLat.lat;
				selectedLocations[locationIndex].lng = newLngLat.lng;
				updateLocationsDisplay();
				updateFormData();
			}
		}

		function removeLocation(locationId) {
			const locationIndex = selectedLocations.findIndex(
				(loc) => loc.id === locationId
			);
			if (locationIndex !== -1) {
				// Remove marker from map
				selectedLocations[locationIndex].marker.remove();

				// Remove from arrays
				selectedLocations.splice(locationIndex, 1);
				markers.splice(locationIndex, 1);

				updateLocationsDisplay();
				updateFormData();
			}
		}

		function updateLocationsDisplay() {
			const container = document.getElementById("selectedLocationsList");

			if (selectedLocations.length === 0) {
				container.innerHTML =
					'<p class="text-gray-500 italic">Search and click on locations to add them to your project</p>';
				return;
			}

			// Clear container first
			container.innerHTML = "";

			// Process each location
			selectedLocations.forEach((location) => {
				const locationDiv = document.createElement("div");
				locationDiv.className =
					"flex items-center justify-between bg-white p-2 rounded border";

				// Check if we have a pre-defined name (from search)
				if (location.name) {
					locationDiv.innerHTML = `
						<span class="text-sm text-blue-600">
							<i class="fas fa-map-marker-alt mr-2"></i>${location.name}
						</span>
						<button type="button" onclick="removeLocation(${location.id})"
								class="text-red-500 hover:text-red-700 ml-2">
							<i class="fas fa-times"></i>
						</button>
					`;
					container.appendChild(locationDiv);

					// Reverse geocode to get county/subcounty data
					fetch(
						`https://api.mapbox.com/geocoding/v5/mapbox.places/${location.lng},${location.lat}.json?access_token=${mapboxgl.accessToken}&types=place,region,district,locality`
					)
						.then((response) => response.json())
						.then((data) => {
							if (data.features && data.features.length > 0) {
								// Extract county and subcounty from the response
								const region = data.features.find((f) =>
									f.place_type.includes("region")
								);
								const district = data.features.find((f) =>
									f.place_type.includes("district")
								);
								const place = data.features.find((f) =>
									f.place_type.includes("place")
								);

								// Store the extracted data
								if (region) {
									location.county = region.text;
								}
								if (district || place) {
									location.subCounty = (district || place).text;
								}

								// Update form data with new info
								updateFormData();
							}
						})
						.catch((error) => {
							console.error("Geocoding error for county/subcounty:", error);
						});
				} else {
					// No pre-defined name, need to reverse geocode
					locationDiv.innerHTML = `
						<span class="text-sm text-blue-600">
							<i class="fas fa-spinner fa-spin mr-2"></i>Loading location...
						</span>
						<button type="button" onclick="removeLocation(${location.id})"
								class="text-red-500 hover:text-red-700 ml-2">
							<i class="fas fa-times"></i>
						</button>
					`;
					container.appendChild(locationDiv);

					// Reverse geocode to get place name and administrative data
					fetch(
						`https://api.mapbox.com/geocoding/v5/mapbox.places/${location.lng},${location.lat}.json?access_token=${mapboxgl.accessToken}&types=place,region,district,locality`
					)
						.then((response) => response.json())
						.then((data) => {
							let placeName = `${location.lat.toFixed(
								4
							)}, ${location.lng.toFixed(4)}`; // fallback

							if (data.features && data.features.length > 0) {
								// Extract county and subcounty
								const region = data.features.find((f) =>
									f.place_type.includes("region")
								);
								const district = data.features.find((f) =>
									f.place_type.includes("district")
								);
								const place = data.features.find((f) =>
									f.place_type.includes("place")
								);
								const country = data.features.find((f) =>
									f.place_type.includes("country")
								);

								// Store administrative data
								if (region) {
									location.county = region.text;
								}
								if (district || place) {
									location.subCounty = (district || place).text;
								}

								// Build place name
								if (place) {
									placeName = `${place.text}, ${country ? country.text : "Kenya"}`;
								} else if (region) {
									placeName = `${region.text}, Kenya`;
								} else if (country) {
									placeName = `${country.text}`;
								}

								location.name = placeName;
							}

							locationDiv.innerHTML = `
								<span class="text-sm text-blue-600">
									<i class="fas fa-map-marker-alt mr-2"></i>${placeName}
								</span>
								<button type="button" onclick="removeLocation(${location.id})"
										class="text-red-500 hover:text-red-700 ml-2">
									<i class="fas fa-times"></i>
								</button>
							`;

							// Update form data with new info
							updateFormData();
						})
						.catch((error) => {
							console.error("Geocoding error:", error);
							locationDiv.innerHTML = `
								<span class="text-sm text-blue-600">
									<i class="fas fa-map-marker-alt mr-2"></i>${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}
								</span>
								<button type="button" onclick="removeLocation(${location.id})"
										class="text-red-500 hover:text-red-700 ml-2">
									<i class="fas fa-times"></i>
								</button>
							`;
						});
				}
			});
		}

		function updateFormData() {
			const locationsData = selectedLocations.map((loc) => ({
				latitude: loc.lat,
				longitude: loc.lng,
				county: loc.county || null,
				subCounty: loc.subCounty || null,
				mapsAddress: loc.name || `${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)}`,
			}));
			document.getElementById("project_locations").value =
				JSON.stringify(locationsData);
		}

		// Make removeLocation function globally available
		window.removeLocation = removeLocation;

		function initializeMap() {
			try {
				mapboxgl.accessToken = window.MAPBOX_TOKEN;

				map = new mapboxgl.Map({
					container: "newProjectMap",
					style: "mapbox://styles/mapbox/streets-v11",
					center: [37.9062, -0.0236], // Center of Kenya
					zoom: 6,
				});

				map.on("click", function (e) {
					const lngLat = e.lngLat;

					// Create a new marker
					const marker = new mapboxgl.Marker({
						color: "#3B82F6",
						draggable: true,
					})
						.setLngLat(lngLat)
						.addTo(map);

					// Add drag functionality
					marker.on("dragend", function () {
						updateLocation(marker, marker.getLngLat());
					});

					// Store the location
					const locationData = {
						id: Date.now(),
						lat: lngLat.lat,
						lng: lngLat.lng,
						marker: marker,
					};

					selectedLocations.push(locationData);
					markers.push(marker);

					updateLocationsDisplay();
					updateFormData();
				});
			} catch (error) {
				console.error("Map initialization failed:", error);
				document.getElementById("newProjectMap").innerHTML =
					'<div class="flex items-center justify-center h-full text-gray-500"><div class="text-center"><i class="fas fa-map-location-dot text-4xl mb-2"></i><p>Map unavailable</p><p class="text-sm">Please check Mapbox configuration</p></div></div>';
			}
		}

		// Map search functionality
		function initializeMapSearch() {
			const searchInput = document.getElementById("mapSearchInput");
			const searchResults = document.getElementById("searchResults");
			const clearSearchBtn = document.getElementById("clearSearchBtn");
			let searchTimeout;
			let currentSearchMarker = null;

			// Search input handler with debounce
			searchInput.addEventListener("input", function (e) {
				const query = e.target.value.trim();

				// Show/hide clear button
				if (query) {
					clearSearchBtn.classList.remove("hidden");
				} else {
					searchResults.innerHTML = "";
					searchResults.classList.add("hidden");
					clearSearchBtn.classList.add("hidden");
					return;
				}

				// Debounce search
				clearTimeout(searchTimeout);
				searchTimeout = setTimeout(() => {
					performSearch(query);
				}, 300);
			});

			// Clear search button
			clearSearchBtn.addEventListener("click", function () {
				searchInput.value = "";
				searchResults.innerHTML = "";
				searchResults.classList.add("hidden");
				clearSearchBtn.classList.add("hidden");

				// Remove search marker if exists
				if (currentSearchMarker) {
					currentSearchMarker.remove();
					currentSearchMarker = null;
				}
			});

			// Close search results when clicking outside
			document.addEventListener("click", function (e) {
				if (
					!searchInput.contains(e.target) &&
					!searchResults.contains(e.target)
				) {
					searchResults.classList.add("hidden");
				}
			});

			// Show results when input is focused and has value
			searchInput.addEventListener("focus", function () {
				if (searchInput.value.trim() && searchResults.children.length > 0) {
					searchResults.classList.remove("hidden");
				}
			});

			async function performSearch(query) {
				try {
					// Show loading state
					searchResults.innerHTML = `
						<div class="p-4 text-center text-gray-500">
							<i class="fas fa-spinner fa-spin mr-2"></i>
							Searching...
						</div>
					`;
					searchResults.classList.remove("hidden");

				// Mapbox Geocoding API - prioritize Kenya locations
				const response = await fetch(
					`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(
						query
					)}.json?access_token=${
						mapboxgl.accessToken
					}&country=KE&limit=8&types=place,locality,neighborhood,address,poi,region,district`
				);					if (!response.ok) {
						throw new Error("Search failed");
					}

					const data = await response.json();

				if (!data.features || data.features.length === 0) {
					searchResults.innerHTML = `
						<div class="p-4 text-center text-gray-500">
							<i class="fas fa-search mr-2"></i>
							No results found for "${query}"
						</div>
					`;
					return;
				}					// Display results
					displaySearchResults(data.features);
			} catch (error) {
				console.error("Search error:", error);
				searchResults.innerHTML = `
					<div class="p-4 text-center text-red-500">
						<i class="fas fa-exclamation-triangle mr-2"></i>
						Search failed. Please try again.
					</div>
				`;
			}
		}			function displaySearchResults(features) {
				searchResults.innerHTML = "";

				features.forEach((feature) => {
					const resultItem = document.createElement("div");
					resultItem.className =
						"px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-200 last:border-b-0 transition-colors";

					// Get place type icon
					const placeType = feature.place_type[0];
					const icon = getPlaceTypeIcon(placeType);

				const placeName = feature.place_name || feature.text;

				resultItem.innerHTML = `
					<div class="flex items-start space-x-3">
						<div class="text-blue-500 mt-1">
							<i class="${icon}"></i>
						</div>
						<div class="flex-1 min-w-0">
							<div class="font-medium text-gray-900 truncate">
								${feature.text}
							</div>
							<div class="text-sm text-gray-500 truncate">
								${placeName}
							</div>
							${
								feature.properties.category
									? `<div class="text-xs text-gray-400 mt-1">
								<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100">
									${feature.properties.category}
								</span>
							</div>`
									: ""
							}
						</div>
						<div class="text-xs text-gray-400 mt-1">
							<i class="fas fa-chevron-right"></i>
						</div>
					</div>
				`;					resultItem.addEventListener("click", function () {
						selectSearchResult(feature);
					});

					searchResults.appendChild(resultItem);
				});

				searchResults.classList.remove("hidden");
			}

			function getPlaceTypeIcon(placeType) {
				const iconMap = {
					place: "fas fa-city",
					locality: "fas fa-map-marker-alt",
					neighborhood: "fas fa-home",
					address: "fas fa-map-pin",
					poi: "fas fa-map-location-dot",
					region: "fas fa-map",
					district: "fas fa-map-signs",
					country: "fas fa-flag",
				};
				return iconMap[placeType] || "fas fa-map-marker-alt";
			}

			function selectSearchResult(feature) {
				const [lng, lat] = feature.center;

				// Remove previous search marker
				if (currentSearchMarker) {
					currentSearchMarker.remove();
				}

				// Add a temporary search marker (different color)
				currentSearchMarker = new mapboxgl.Marker({
					color: "#10b981", // Green color for search results
					draggable: false,
				})
				.setLngLat([lng, lat])
				.setPopup(
					new mapboxgl.Popup({ offset: 25 }).setHTML(`
					<div class="p-2">
						<div class="font-semibold text-gray-900">${feature.text}</div>
						<div class="text-sm text-gray-600">${feature.place_name}</div>
						<button
							onclick="addSearchLocationToProject(${lat}, ${lng}, '${feature.text}')"
							class="mt-2 w-full px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors"
						>
							<i class="fas fa-plus mr-1"></i>
							Add to Project
						</button>
					</div>
				`)
				)
				.addTo(map);				// Open popup automatically
				currentSearchMarker.togglePopup();

				// Fly to location
				map.flyTo({
					center: [lng, lat],
					zoom: 14,
					duration: 2000,
				});

				// Update search input
				searchInput.value = feature.place_name;

				// Hide search results
				searchResults.classList.add("hidden");
			}
		}

		// Function to add search location to project (called from popup)
		window.addSearchLocationToProject = function (lat, lng, placeName) {
			// Create a new marker for the project
			const marker = new mapboxgl.Marker({
				color: "#3B82F6",
				draggable: true,
			})
				.setLngLat([lng, lat])
				.addTo(map);

			// Add drag functionality
			marker.on("dragend", function () {
				updateLocation(marker, marker.getLngLat());
			});

			// Store the location
			const locationData = {
				id: Date.now(),
				lat: lat,
				lng: lng,
				marker: marker,
				name: placeName,
			};

			selectedLocations.push(locationData);
			markers.push(marker);

			updateLocationsDisplay();
			updateFormData();

			// Close the search marker popup
			const searchMarker = map._markers?.find((m) => m.getPopup());
			if (searchMarker) {
				searchMarker.togglePopup();
			}

			// Show success message
			const successMessage = document.createElement("div");
			successMessage.className =
				"fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center space-x-2";
			successMessage.innerHTML = `
				<i class="fas fa-check-circle"></i>
				<span>Location added to project!</span>
			`;
			document.body.appendChild(successMessage);

			setTimeout(() => {
				successMessage.remove();
			}, 3000);
		};

		// Theme selection handling
		function initializeThemeSelection() {
			const themeCheckboxes = document.querySelectorAll(
				'input[name="themes"]'
			);
			const selectedThemesInput = document.getElementById("selected_themes");
			const themesCountDisplay = document.getElementById("themesCount");
			const themeValidationError = document.getElementById(
				"themeValidationError"
			);
			const selectedThemesDisplay = document.getElementById(
				"selectedThemesDisplay"
			);

			function updateSelectedThemes() {
				const selectedThemes = Array.from(themeCheckboxes)
					.filter((checkbox) => checkbox.checked)
					.map((checkbox) => checkbox.value);

				selectedThemesInput.value = JSON.stringify(selectedThemes);
				themesCountDisplay.textContent = selectedThemes.length;

				// Update visual feedback for each theme option
				themeCheckboxes.forEach((checkbox) => {
					const themeOption = checkbox.closest(".theme-option");
					const checkmark = themeOption.querySelector(".checkmark");

					if (checkbox.checked) {
						themeOption.classList.add("border-blue-500", "bg-blue-50");
						themeOption.classList.remove(
							"border-gray-200",
							"hover:border-blue-400"
						);
						checkmark.classList.remove("hidden");
					} else {
						themeOption.classList.remove("border-blue-500", "bg-blue-50");
						themeOption.classList.add("border-gray-200");
						checkmark.classList.add("hidden");
					}
				});

				// Update counter styling
				if (selectedThemes.length > 0) {
					selectedThemesDisplay.classList.remove(
						"bg-gray-100",
						"text-gray-600"
					);
					selectedThemesDisplay.classList.add("bg-blue-50", "text-blue-700");
				} else {
					selectedThemesDisplay.classList.remove(
						"bg-blue-50",
						"text-blue-700"
					);
					selectedThemesDisplay.classList.add("bg-gray-100", "text-gray-600");
				}

				// Update form validation
				const themeContainer = document.querySelector(".theme-selection");
				if (selectedThemes.length === 0) {
					themeContainer.classList.add("border-red-500");
					themeContainer.classList.remove(
						"border-gray-200",
						"hover:border-blue-300"
					);
					themeValidationError.classList.remove("hidden");
				} else {
					themeContainer.classList.remove("border-red-500");
					themeContainer.classList.add("border-gray-200");
					themeValidationError.classList.add("hidden");
				}
			}

			themeCheckboxes.forEach((checkbox) => {
				checkbox.addEventListener("change", updateSelectedThemes);
			});

			// Initial update
			updateSelectedThemes();
		}

		// File upload handling
		let selectedFiles = [];

		function initializeFileUpload() {
			const fileUploadArea = document.getElementById("fileUploadArea");
			const documentFilesInput = document.getElementById("documentFiles");
			const selectedFilesDiv = document.getElementById("selectedFiles");
			const filesList = document.getElementById("filesList");
			const docsCount = document.getElementById("docsCount");
			const documentsCount = document.getElementById("documentsCount");

			// Click to open file dialog
			fileUploadArea.addEventListener("click", function () {
				documentFilesInput.click();
			});

			// Drag and drop functionality
			fileUploadArea.addEventListener("dragover", function (e) {
				e.preventDefault();
				fileUploadArea.classList.add("border-blue-500", "bg-blue-50");
			});

			fileUploadArea.addEventListener("dragleave", function (e) {
				e.preventDefault();
				fileUploadArea.classList.remove("border-blue-500", "bg-blue-50");
			});

			fileUploadArea.addEventListener("drop", function (e) {
				e.preventDefault();
				fileUploadArea.classList.remove("border-blue-500", "bg-blue-50");

				const files = Array.from(e.dataTransfer.files);
				handleFileSelection(files);
			});

			// File input change
			documentFilesInput.addEventListener("change", function (e) {
				const files = Array.from(e.target.files);
				handleFileSelection(files);
			});

			function handleFileSelection(files) {
				const validFiles = [];
				const errors = [];

				files.forEach((file) => {
					// Validate file type
					const allowedTypes = [
						"application/pdf",
						"application/msword",
						"application/vnd.openxmlformats-officedocument.wordprocessingml.document",
						"application/vnd.ms-excel",
						"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
					];
					const allowedExtensions = [
						".pdf",
						".doc",
						".docx",
						".xls",
						".xlsx",
					];

					const fileExtension = file.name
						.toLowerCase()
						.substring(file.name.lastIndexOf("."));
					const isValidType =
						allowedTypes.includes(file.type) ||
						allowedExtensions.includes(fileExtension);

					if (!isValidType) {
						errors.push(
							`${file.name}: Invalid file type. Only PDF, DOC, DOCX, XLS, XLSX allowed.`
						);
						return;
					}

					// Validate file size (10MB max)
					const maxSize = 10 * 1024 * 1024; // 10MB in bytes
					if (file.size > maxSize) {
						errors.push(
							`${file.name}: File too large. Maximum size is 10MB.`
						);
						return;
					}

					// Check for duplicates
					const isDuplicate = selectedFiles.some(
						(existingFile) =>
							existingFile.name === file.name &&
							existingFile.size === file.size
					);

					if (isDuplicate) {
						errors.push(`${file.name}: File already selected.`);
						return;
					}

					validFiles.push(file);
				});

				// Show errors if any
				if (errors.length > 0) {
					showFileError(errors.join("<br>"));
					return;
				}

				// Hide error if shown
				hideFileError();

				// Add valid files
				selectedFiles.push(...validFiles);
				updateFileDisplay();

				// Clear input
				documentFilesInput.value = "";
			}

			function updateFileDisplay() {
				if (selectedFiles.length === 0) {
					selectedFilesDiv.classList.add("hidden");
					documentsCount.classList.remove("bg-blue-50", "text-blue-700");
					documentsCount.classList.add("bg-gray-100", "text-gray-600");
				} else {
					selectedFilesDiv.classList.remove("hidden");
					documentsCount.classList.remove("bg-gray-100", "text-gray-600");
					documentsCount.classList.add("bg-blue-50", "text-blue-700");
				}

				docsCount.textContent = selectedFiles.length;

				// Clear existing list
				filesList.innerHTML = "";

				// Add files to list
				selectedFiles.forEach((file, index) => {
					const fileDiv = document.createElement("div");
					fileDiv.className =
						"flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200";

					const fileIcon = getFileIcon(file.name);
					const fileSize = formatFileSize(file.size);

					fileDiv.innerHTML = `
              <div class="flex items-center space-x-3">
                <div class="text-blue-500">
                  <i class="${fileIcon}"></i>
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-800">${file.name}</p>
                  <p class="text-xs text-gray-500">${fileSize}</p>
                </div>
              </div>
              <button type="button" onclick="removeFile(${index})" class="text-red-500 hover:text-red-700 transition-colors">
                <i class="fas fa-times"></i>
              </button>
            `;

					filesList.appendChild(fileDiv);
				});
			}

			function getFileIcon(filename) {
				const extension = filename.toLowerCase().split(".").pop();
				switch (extension) {
					case "pdf":
						return "fas fa-file-pdf";
					case "doc":
					case "docx":
						return "fas fa-file-word";
					case "xls":
					case "xlsx":
						return "fas fa-file-excel";
					default:
						return "fas fa-file";
				}
			}

			function formatFileSize(bytes) {
				if (bytes === 0) return "0 Bytes";
				const k = 1024;
				const sizes = ["Bytes", "KB", "MB", "GB"];
				const i = Math.floor(Math.log(bytes) / Math.log(k));
				return (
					parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
				);
			}

			function showFileError(message) {
				const errorDiv = document.getElementById("fileUploadError");
				const errorMessage = document.getElementById("fileErrorMessage");
				errorMessage.innerHTML = message;
				errorDiv.classList.remove("hidden");
			}

			function hideFileError() {
				const errorDiv = document.getElementById("fileUploadError");
				errorDiv.classList.add("hidden");
			}

			// Make removeFile function globally available
			window.removeFile = function (index) {
				selectedFiles.splice(index, 1);
				updateFileDisplay();
			};
		}

		// Form progress tracking
		function initializeFormProgress() {
			const progressSteps = document.querySelectorAll('.progress-step');
			let currentSection = 1;

			// Update progress when user scrolls or focuses on sections
			function updateProgress() {
				const sections = document.querySelectorAll('.form-section');
				const scrollPosition = window.scrollY + 200; // Offset for header

				sections.forEach((section, index) => {
					const sectionTop = section.offsetTop;
					const sectionBottom = sectionTop + section.offsetHeight;

					if (scrollPosition >= sectionTop && scrollPosition < sectionBottom) {
						currentSection = index + 1;
						updateProgressIndicator(currentSection);
					}
				});
			}

			function updateProgressIndicator(activeSection) {
				progressSteps.forEach((step, index) => {
					const stepNumber = index + 1;

					// Remove all classes
					step.classList.remove('current', 'completed', 'pending');

					if (stepNumber < activeSection) {
						step.classList.add('completed');
					} else if (stepNumber === activeSection) {
						step.classList.add('current');
					} else {
						step.classList.add('pending');
					}
				});
			}

			// Add scroll listener
			window.addEventListener('scroll', updateProgress);

			// Initial progress update
			updateProgress();
		}

		// Budget input formatting
		function initializeBudgetFormatting() {
			const budgetInput = document.getElementById('budget');

			budgetInput.addEventListener('input', function (e) {
				// Remove all non-digit characters except decimal point
				let value = e.target.value.replace(/[^\d]/g, '');

				// Format with commas
				if (value) {
					value = parseInt(value).toLocaleString('en-US');
				}

				// Update the input value
				e.target.value = value;
			});

			// Prevent non-numeric input on keypress
			budgetInput.addEventListener('keypress', function (e) {
				// Allow backspace, delete, tab, escape, enter, and decimal point
				if ([8, 9, 27, 13, 110, 190].includes(e.keyCode) ||
					// Allow Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X, Ctrl+Z
					(e.ctrlKey && [65, 67, 86, 88, 90].includes(e.keyCode))) {
					return;
				}

				// Block non-numeric characters
				if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
					e.preventDefault();
				}
			});
		}

		// Collaborators management
		let availablePartners = [];
		let selectedCollaborators = [];

		async function initializeCollaborators() {
			try {
				// Show loading state
				const loadingEl = document.getElementById('collaboratorsLoading');
				const errorEl = document.getElementById('collaboratorsError');
				const listEl = document.getElementById('availableCollaboratorsList');

				loadingEl.classList.remove('hidden');
				errorEl.classList.add('hidden');

			// Fetch available partners
			const token = localStorage.getItem('accessToken') || localStorage.getItem('token');
			const response = await fetch(`${window.BASE_URL}/api/auth/partners/available`, {
				headers: {
					'Authorization': `Bearer ${token}`
				}
			});				if (!response.ok) {
					throw new Error(`Failed to load partners: ${response.status} ${response.statusText}`);
				}

				const data = await response.json();

				if (data.status === 200 && data.data) {
					availablePartners = data.data;
					console.log('Loaded available partners:', availablePartners.length);
					displayAvailableCollaborators();
				} else {
					throw new Error(data.message || 'Failed to load partners');
				}

				loadingEl.classList.add('hidden');
			} catch (error) {
				console.error('Error loading collaborators:', error);

				// Show error state
				const loadingEl = document.getElementById('collaboratorsLoading');
				const errorEl = document.getElementById('collaboratorsError');
				const errorMessageEl = document.getElementById('collaboratorsErrorMessage');

				loadingEl.classList.add('hidden');
				errorEl.classList.remove('hidden');
				errorMessageEl.textContent = error.message || 'Failed to load available partners. You can skip this step and add collaborators later.';
			}
		}

		function displayAvailableCollaborators(searchTerm = '') {
			const listEl = document.getElementById('availableCollaboratorsList');
			const noCollaboratorsEl = document.getElementById('noCollaboratorsMessage');

			// Filter partners by search term
			const filteredPartners = availablePartners.filter(partner => {
				const searchLower = searchTerm.toLowerCase();
				return partner.name.toLowerCase().includes(searchLower) ||
					   partner.email.toLowerCase().includes(searchLower);
			});

			// Filter out already selected collaborators
			const availableToSelect = filteredPartners.filter(partner =>
				!selectedCollaborators.find(sc => sc.email === partner.email)
			);

			if (availableToSelect.length === 0) {
				listEl.classList.add('hidden');
				noCollaboratorsEl.classList.remove('hidden');
				return;
			}

			listEl.classList.remove('hidden');
			noCollaboratorsEl.classList.add('hidden');

			// Render available collaborators
			listEl.innerHTML = availableToSelect.map(partner => `
				<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-blue-50 hover:border-blue-300 transition-all cursor-pointer"
					 onclick="selectCollaborator('${partner.email}')">
					<div class="flex items-center space-x-3">
						<div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">
							${partner.name.charAt(0).toUpperCase()}
						</div>
						<div>
							<p class="text-sm font-medium text-gray-800">${partner.name}</p>
							<p class="text-xs text-gray-500">${partner.email}</p>
							${partner.organization ? `<p class="text-xs text-gray-400">${partner.organization.name}</p>` : ''}
						</div>
					</div>
					<button type="button" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
						<i class="fas fa-plus mr-1"></i> Add
					</button>
				</div>
			`).join('');
		}

		function selectCollaborator(email) {
			const partner = availablePartners.find(p => p.email === email);
			if (!partner) return;

			// Check if already selected
			if (selectedCollaborators.find(sc => sc.email === email)) {
				return;
			}

			// Add to selected list
			selectedCollaborators.push(partner);

			// Update displays
			displaySelectedCollaborators();
			displayAvailableCollaborators(document.getElementById('collaboratorSearch').value);
			updateCollaboratorsFormData();
		}

		function removeCollaborator(email) {
			selectedCollaborators = selectedCollaborators.filter(sc => sc.email !== email);
			displaySelectedCollaborators();
			displayAvailableCollaborators(document.getElementById('collaboratorSearch').value);
			updateCollaboratorsFormData();
		}

		function displaySelectedCollaborators() {
			const sectionEl = document.getElementById('selectedCollaboratorsSection');
			const listEl = document.getElementById('selectedCollaboratorsList');
			const countEl = document.getElementById('selectedCollaboratorsCount');

			if (selectedCollaborators.length === 0) {
				sectionEl.classList.add('hidden');
				return;
			}

			sectionEl.classList.remove('hidden');
			countEl.textContent = selectedCollaborators.length;

			listEl.innerHTML = selectedCollaborators.map(collab => `
				<div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-200">
					<div class="flex items-center space-x-3">
						<div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">
							${collab.name.charAt(0).toUpperCase()}
						</div>
						<div>
							<p class="text-sm font-medium text-gray-800">${collab.name}</p>
							<p class="text-xs text-gray-500">${collab.email}</p>
							${collab.organization ? `<p class="text-xs text-gray-400">${collab.organization.name}</p>` : ''}
						</div>
					</div>
					<button type="button" onclick="removeCollaborator('${collab.email}')"
						class="text-red-500 hover:text-red-700 transition-colors">
						<i class="fas fa-times"></i>
					</button>
				</div>
			`).join('');
		}

		function updateCollaboratorsFormData() {
			const collaboratorEmails = selectedCollaborators.map(c => c.email);
			document.getElementById('selected_collaborators').value = JSON.stringify(collaboratorEmails);
		}

		// Search functionality for collaborators
		document.addEventListener('DOMContentLoaded', function() {
			const searchInput = document.getElementById('collaboratorSearch');
			if (searchInput) {
				searchInput.addEventListener('input', function(e) {
					displayAvailableCollaborators(e.target.value);
				});
			}
		});

		// Make functions globally available
		window.selectCollaborator = selectCollaborator;
		window.removeCollaborator = removeCollaborator;

		// Initialize real-time validation
		function initializeRealTimeValidation() {
			const validator = new FormValidator('projectForm');

			// Add real-time validation for all input fields
			const formFields = document.querySelectorAll('#projectForm input, #projectForm textarea, #projectForm select');

			formFields.forEach(field => {
				// Validate on blur (when user leaves field)
				field.addEventListener('blur', function() {
					validator.validateField(this);
				});

				// Clear error on focus (when user enters field)
				field.addEventListener('focus', function() {
					validator.clearFieldError(this);
				});
			});

			// Validate date range when dates change
			const startDateInput = document.getElementById('starttime_period');
			const endDateInput = document.getElementById('endtime_period');

			if (startDateInput && endDateInput) {
				startDateInput.addEventListener('change', () => validator.validateDateRange());
				endDateInput.addEventListener('change', () => validator.validateDateRange());
			}

			// Validate budget and currency together
			const budgetInput = document.getElementById('budget');
			const currencySelect = document.getElementById('currency');

			if (budgetInput && currencySelect) {
				budgetInput.addEventListener('blur', () => validator.validateBudget());
				currencySelect.addEventListener('change', () => validator.validateBudget());
			}

			console.log('Real-time validation initialized');
		}

		// Add event listeners for county/sub-county dropdowns to zoom map
		const countySelect = document.getElementById("countySelect");
		if (countySelect) {
			countySelect.addEventListener("change", function () {
				const selectedCounty = this.value;
				if (
					selectedCounty &&
					window.countyCoordinates &&
					window.countyCoordinates[selectedCounty] &&
					map
				) {
					const [lng, lat] = window.countyCoordinates[selectedCounty];
					map.flyTo({
						center: [lng, lat],
						zoom: 9,
					});
				}
			});
		}

		const subCountySelect = document.getElementById("subCountySelect");
		if (subCountySelect) {
			subCountySelect.addEventListener("change", function () {
				const selectedSubCounty = this.value;
				if (
					selectedSubCounty &&
					window.subCountyCoordinates &&
					window.subCountyCoordinates[selectedSubCounty] &&
					map
				) {
					const [lng, lat] = window.subCountyCoordinates[selectedSubCounty];
					map.flyTo({
						center: [lng, lat],
						zoom: 11,
					});
				}
			});
		}

		// Form submission
		document
			.getElementById("projectForm")
			.addEventListener("submit", async function (e) {
				e.preventDefault();

				// Initialize form validator
				const validator = new FormValidator('projectForm');

				// Validate all fields before submission
				console.log("Running form validation...");
				const isValid = validator.validateAll();

				if (!isValid) {
					console.error("Form validation failed:", validator.getErrors());
					validator.showErrorSummary();
					validator.scrollToFirstError();
					return;
				}

				console.log("Form validation passed");

				// Don't use FormData(this) to avoid including empty file inputs
				// Instead, collect form data manually
				const formData = new FormData();

				// Add all form fields except file inputs
				const formElements = this.querySelectorAll('input:not([type="file"]), textarea, select');
				formElements.forEach(element => {
					if (element.name && element.value) {
						formData.append(element.name, element.value);
					}
				});

				// Add selected files to FormData (only valid files)
				selectedFiles.filter(f => f.size > 0).forEach((file) => {
					formData.append(`documents`, file);
				});

				// Get form data as object for validation and logging
				const data = {};
				for (let [key, value] of formData.entries()) {
					if (key !== "documents") {
						// Skip files for validation
						data[key] = value;
					}
				}

				console.log("=== FORM SUBMISSION DEBUG ===");
				console.log("Raw FormData entries:");
				for (let [key, value] of formData.entries()) {
					if (key === "documents") {
						console.log(`${key}: [File - ${value.name}, ${value.size} bytes]`);
					} else {
						console.log(`${key}: ${value}`);
					}
				}
				console.log("Parsed data object:", data);

				// Parse locations and themes from JSON strings
				try {
					if (data.locations) {
						data.locations = JSON.parse(data.locations);
						console.log("Parsed locations:", data.locations);
					}
					if (data.selected_themes) {
						data.themes = JSON.parse(data.selected_themes);
						formData.delete("selected_themes"); // Remove from FormData
						formData.append("themes", JSON.stringify(data.themes)); // Add parsed themes
						console.log("Parsed themes:", data.themes);
					}

					// Clean budget value (remove commas for submission)
					if (data.budget) {
						const cleanBudget = data.budget.replace(/,/g, '');
						formData.set("budget", cleanBudget);
						data.budget = cleanBudget;
						console.log("Cleaned budget:", data.budget);
					}

					// Validate required fields
					if (!data.themes || data.themes.length === 0) {
						const themeValidationError = document.getElementById(
							"themeValidationError"
						);
						themeValidationError.classList.remove("hidden");
						const themeContainer = document.querySelector(".theme-selection");
						themeContainer.classList.add("border-red-500");
						themeContainer.classList.remove(
							"border-gray-200",
							"hover:border-blue-300"
						);
						themeContainer.scrollIntoView({
							behavior: "smooth",
							block: "center",
						});
						return;
					}

					if (!data.locations || data.locations.length === 0) {
						await showAlert("Please select at least one location on the map.", "Missing Location", "warning");
						return;
					}

					// Get current user for partner field
					const currentUser = JSON.parse(localStorage.getItem("user") || "{}");

					// Create project object as expected by backend
					const projectData = {
						title: data.title,
						partner: currentUser.email || data.contact_person_mail, // Use current user email or fallback
						startDate: data.start_date,
						endDate: data.end_date,
						activityType: data.activity_type,
						budget: parseFloat(data.budget) || 0,
						objectives: data.objectives,
						locations: data.locations.map(loc => ({
							latitude: loc.latitude,
							longitude: loc.longitude,
							county: loc.county || "Meru", // Default county for Kenya locations
							subCounty: loc.subCounty || null,
							mapsAddress: loc.mapsAddress || `${loc.latitude},${loc.longitude}`
						})),
						themes: data.themes,
						contactPersonName: data.contact_person_name,
						contactPersonRole: data.contact_person_role,
						contactPersonEmail: data.contact_person_mail,
						projectCategory: data.project_category || "IMPLEMENTING"
					};

					console.log("Project data object to send:", projectData);

					// Backend expects a 'project' field with JSON data
					const finalFormData = new FormData();

					// Add project data as a Blob with correct content-type
					const projectBlob = new Blob([JSON.stringify(projectData)], { type: 'application/json' });
					finalFormData.append("project", projectBlob);

					// Add files (filter out empty files)
					selectedFiles.filter(f => f.size > 0).forEach((file) => {
						finalFormData.append("supporting_documents", file);
					});

					console.log("Final FormData with project field:");
					for (let [key, value] of finalFormData.entries()) {
						if (key === "supporting_documents") {
							console.log(`${key}: [File - ${value.name}, ${value.size} bytes]`);
						} else if (key === "project") {
							console.log(`${key}: [Blob - ${value.size} bytes, type: ${value.type}]`);
						} else {
							console.log(`${key}: ${value}`);
						}
					}

					const response = await fetch(`${window.BASE_URL}/api/projects`, {
						method: "POST",
						headers: {
							Authorization: `Bearer ${localStorage.getItem("accessToken")}`,
						},
						body: finalFormData,
					});

					console.log("Response status:", response.status);
					console.log("Response headers:", Object.fromEntries(response.headers.entries()));

					if (response.ok) {
						console.log("Project created successfully!");

						// Get the created project data
						const projectResponse = await response.json();
						const createdProject = projectResponse.data;

						// Add collaborators if any were selected
						if (selectedCollaborators.length > 0 && createdProject && createdProject.id) {
							console.log(`Adding ${selectedCollaborators.length} collaborators to project ${createdProject.id}...`);

							// Add each collaborator
							const collaboratorPromises = selectedCollaborators.map(async (collaborator) => {
								try {
									const collabResponse = await fetch(
										`${window.BASE_URL}/api/projects/${createdProject.id}/collaborators?collaboratorEmail=${encodeURIComponent(collaborator.email)}&role=EDITOR`,
										{
											method: 'POST',
											headers: {
												'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
											}
										}
									);

									if (!collabResponse.ok) {
										console.warn(`Failed to add collaborator ${collaborator.email}:`, await collabResponse.text());
										return { success: false, email: collaborator.email };
									}

									console.log(`Successfully added collaborator: ${collaborator.email}`);
									return { success: true, email: collaborator.email };
								} catch (error) {
									console.error(`Error adding collaborator ${collaborator.email}:`, error);
									return { success: false, email: collaborator.email };
								}
							});

							const results = await Promise.all(collaboratorPromises);
							const failedCollaborators = results.filter(r => !r.success);

							if (failedCollaborators.length > 0) {
								console.warn(`${failedCollaborators.length} collaborators could not be added`);
								await showAlert(
									buildProjectSuccessMessage(createdProject.projectNo, `Note: ${failedCollaborators.length} out of ${selectedCollaborators.length} collaborators could not be added. You can add them later from the project page.`),
									"Project Created",
									"success"
								);
							} else {
								await showAlert(
									buildProjectSuccessMessage(createdProject.projectNo),
									"Project Created",
									"success"
								);
							}
						} else {
							await showAlert(
								buildProjectSuccessMessage(createdProject ? createdProject.projectNo : null),
								"Project Created",
								"success"
							);
						}

						window.location.href = "index-post-login.html";
					} else {
						let errorMessage = "Unknown error";
						let errorDetails = {};

						try {
							const errorResponse = await response.text();
							console.log("Raw error response:", errorResponse);

							try {
								errorDetails = JSON.parse(errorResponse);
								console.log("Parsed error response:", errorDetails);
								errorMessage = errorDetails.message || errorDetails.error || errorMessage;
							} catch (parseError) {
								console.log("Could not parse error as JSON:", parseError);
								errorMessage = errorResponse || errorMessage;
							}
						} catch (textError) {
							console.error("Error reading response text:", textError);
						}

						console.error("Final error message:", errorMessage);
						console.error("Full error details:", errorDetails);

						await showAlert("Failed to create project: " + errorMessage, "Error", "error");
					}
				} catch (error) {
					console.error("Error processing form data:", error);
					console.error("Error stack:", error.stack);
					await showAlert("Error processing form data. Please try again. Check console for details.", "Error", "error");
				}
			});

	function copyProjectNo(btn, projectNo) {
		navigator.clipboard.writeText(projectNo).then(() => {
			btn.innerHTML = '<i class="fas fa-check text-green-500"></i>';
			setTimeout(() => {
				btn.innerHTML = '<i class="far fa-copy"></i>';
			}, 2000);
		});
	}

	function buildProjectSuccessMessage(projectNo, extraNote) {
		let html = '<div class="text-center">';
		html += '<p class="text-gray-700 mb-4">Your project has been created successfully!</p>';
		if (projectNo) {
			html += '<div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-3">';
			html += '<p class="text-sm text-gray-500 mb-1">Project Number</p>';
			html += '<div class="flex items-center justify-center gap-2">';
			html += '<span class="text-xl font-bold text-teal-700">' + projectNo + '</span>';
			html += '<button onclick="copyProjectNo(this, \'' + projectNo + '\')" class="p-1.5 text-gray-400 hover:text-teal-600 transition rounded hover:bg-gray-100" title="Copy project number">';
			html += '<i class="far fa-copy"></i>';
			html += '</button>';
			html += '</div>';
			html += '</div>';
		}
		if (extraNote) {
			html += '<p class="text-sm text-amber-600 mt-2"><i class="fas fa-exclamation-triangle mr-1"></i>' + extraNote + '</p>';
		}
		html += '</div>';
		return html;
	}

	</script>

	<script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
</body>

</html>