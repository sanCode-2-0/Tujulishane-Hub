<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New Project - RMNCAH</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Tailwind CSS (with custom config using inline script) -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#1e40af", // Custom Blue
              secondary: "#f59e0b", // Custom Amber
              accent: "#10b981", // Custom Green
              dark: "#1f2937", // Gray-800
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="styles/main.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css"
    />
    <script src="styles/main.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
      integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
  </head>
  <body class="bg-gray-50">
    <!-- Navigation -->
    <nav
      x-data="{ open: false }"
      class="fixed z-50 border shadow-sm bg-white/70 top-4 left-4 right-4 backdrop-blur-md border-white/10 rounded-xl"
    >
      <div class="flex items-center justify-between px-6 py-4">
        <a
          href="index.html"
          class="flex items-center justify-center space-x-2 text-2xl font-bold text-teal-700 uppercase"
        >
          <img
            src="resources/images/log2.png"
            class="object-contain h-10 lg:h-12"
            alt="Site Logo"
          />
          <img
            src="resources/images/moh.png"
            class="object-contain h-10 lg:h-12"
            alt="Site Logo"
          />
        </a>

        <button
          @click="open = !open"
          class="text-xl lg:hidden focus:outline-none text-gray-600 hover:text-gray-800"
        >
          <i class="fal fa-bars" x-show="!open"></i>
          <i class="fal fa-times" x-show="open" x-cloak></i>
        </button>

        <ul
          class="items-center hidden space-x-8 text-sm font-medium text-gray-800 lg:flex"
        >
          <li>
            <a
              href="index.html"
              class="uppercase transition hover:text-lime-600"
              >Home</a
            >
          </li>

          <!-- Projects Dropdown -->
          <li x-data="{ showprojectDropdown: false }" class="relative">
            <button
              @click="showprojectDropdown = !showprojectDropdown"
              class="font-semibold inline-flex items-center uppercase transition hover:text-lime-600"
            >
              Projects <i class="ml-2 fad fa-chevron-down"></i>
            </button>
            <div
              x-show="showprojectDropdown"
              @click.outside="showprojectDropdown = false"
              x-transition
              class="absolute z-50 w-64 mt-2 bg-white/90 backdrop-blur-md divide-y divide-gray-100 shadow-md rounded-xl"
            >
              <ul class="py-2 text-sm text-left text-teal-800">
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="new-project.html">
                    <i class="far fa-plus mr-3 text-emerald-500"></i> New
                    Project
                  </a>
                </li>
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="projects.html#my-projects">
                    <i class="far fa-user-check mr-2 text-sky-500"></i> My
                    Projects
                  </a>
                </li>
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="all-projects.html">
                    <i class="far fa-folder-open mr-2 text-yellow-600"></i> All
                    Projects
                  </a>
                </li>
              </ul>
            </div>
          </li>

          <!-- Collaborations Dropdown -->
          <li x-data="{ collabDropdown: false }" class="relative">
            <button
              @click="collabDropdown = !collabDropdown"
              class="font-semibold inline-flex items-center uppercase transition hover:text-lime-600"
            >
              Collaborations <i class="ml-2 fad fa-chevron-down"></i>
            </button>
            <div
              x-show="collabDropdown"
              @click.outside="collabDropdown = false"
              x-transition
              class="absolute z-50 w-64 mt-2 bg-white divide-y divide-gray-100 shadow-md rounded-xl"
            >
              <ul class="py-2 text-sm text-left text-teal-700">
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="priorities.html">
                    <i class="far fa-star mr-2 text-orange-600"></i> RMNCAH
                    Priorities
                  </a>
                </li>
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="my-collaborations.html">
                    <i class="far fa-users-crown mr-2 text-fuchsia-600"></i> My
                    Collaborations
                  </a>
                </li>
                <li class="px-4 py-2 hover:bg-lime-50 text-[12px] uppercase">
                  <a href="announcements.html">
                    <i class="far fa-search mr-2 text-cyan-500"></i> Find
                    Projects
                  </a>
                </li>
              </ul>
            </div>
          </li>
        </ul>

        <!-- Mobile Menu -->
        <div
          x-show="open"
          x-transition
          class="absolute top-full left-0 right-0 z-50 bg-white/95 backdrop-blur-md border-t border-white/10 rounded-b-xl lg:hidden"
        >
          <ul
            class="flex flex-col py-4 space-y-4 text-sm font-medium text-center text-gray-800"
          >
            <li>
              <a
                href="index.html"
                class="uppercase transition hover:text-lime-600"
                >Home</a
              >
            </li>
            <li>
              <a
                href="new-project.html"
                class="uppercase transition hover:text-lime-600"
                >New Project</a
              >
            </li>
            <li>
              <a
                href="projects.html#my-projects"
                class="uppercase transition hover:text-lime-600"
                >My Projects</a
              >
            </li>
            <li>
              <a
                href="all-projects.html"
                class="uppercase transition hover:text-lime-600"
                >All Projects</a
              >
            </li>
            <li>
              <a
                href="priorities.html"
                class="uppercase transition hover:text-lime-600"
                >RMNCAH Priorities</a
              >
            </li>
            <li>
              <a
                href="my-collaborations.html"
                class="uppercase transition hover:text-lime-600"
                >My Collaborations</a
              >
            </li>
            <li>
              <a
                href="announcements.html"
                class="uppercase transition hover:text-lime-600"
                >Find Projects</a
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="pt-24 pb-12">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
          <div class="px-6 py-4 bg-gradient-to-r from-teal-600 to-teal-700">
            <h1 class="text-2xl font-bold text-white">Create New Project</h1>
            <p class="text-teal-100 mt-1">
              Fill in the details to create a new RMNCAH project
            </p>
          </div>

          <div class="p-6">
            <form id="newProjectForm" class="space-y-6">
              <!-- Location Selection -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label
                    for="countySelect"
                    class="block text-sm font-medium text-gray-700"
                    >County</label
                  >
                  <select
                    id="countySelect"
                    class="block w-full p-2 mt-1 text-black bg-white border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  >
                    <option value="">All Counties</option>
                  </select>
                </div>
                <div>
                  <label
                    for="subCountySelect"
                    class="block text-sm font-medium text-gray-700"
                    >Sub-County</label
                  >
                  <select
                    id="subCountySelect"
                    class="block w-full p-2 mt-1 text-black bg-white border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  >
                    <option value="">All Sub-Counties</option>
                  </select>
                </div>
              </div>

              <!-- Map Section -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Pick Project Locations on Map (Click to add multiple
                  locations)</label
                >
                <div
                  id="newProjectMap"
                  style="
                    height: 400px;
                    width: 100%;
                    border-radius: 8px;
                    margin-bottom: 8px;
                    border: 1px solid #e5e7eb;
                    background-color: #f3f4f6;
                    position: relative;
                    overflow: hidden;
                  "
                ></div>
                <input type="hidden" id="project_locations" name="locations" />
                <div class="text-sm text-gray-700 mt-2 p-2 bg-gray-50 rounded">
                  <strong>Selected Locations:</strong>
                  <div id="selectedLocationsList" class="mt-2 space-y-1">
                    <p class="text-gray-500 italic">
                      Click on map to add locations
                    </p>
                  </div>
                </div>
              </div>

              <!-- Title -->
              <div>
                <label
                  for="title"
                  class="block text-sm font-medium text-gray-700"
                  >Title *</label
                >
                <input
                  required
                  type="text"
                  id="title"
                  name="title"
                  class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                />
              </div>

              <!-- Project Theme -->
              <div
                class="theme-selection bg-white rounded-lg border-2 border-gray-200 p-6 transition-all duration-200 hover:border-blue-300 hover:shadow-md"
              >
                <div class="flex items-center justify-between mb-4">
                  <label class="block text-lg font-semibold text-gray-800">
                    Project Themes *
                  </label>
                  <div
                    id="selectedThemesDisplay"
                    class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm font-medium"
                  >
                    <i class="fas fa-check-circle mr-1"></i>
                    <span id="themesCount">0</span> selected
                  </div>
                </div>

                <p class="text-sm text-gray-600 mb-4">
                  Select all themes that apply to your project (minimum 1
                  required)
                </p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <label
                    class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                  >
                    <input
                      type="checkbox"
                      name="themes"
                      value="GBV"
                      class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                    />
                    <div class="flex-1">
                      <span
                        class="font-medium text-gray-800 group-hover:text-blue-800"
                        >Gender Based Violence</span
                      >
                      <p class="text-xs text-gray-500 mt-1">
                        GBV prevention and support programs
                      </p>
                    </div>
                    <div class="checkmark hidden text-green-500 ml-2">
                      <i class="fas fa-check"></i>
                    </div>
                  </label>

                  <label
                    class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                  >
                    <input
                      type="checkbox"
                      name="themes"
                      value="AYPSRH"
                      class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                    />
                    <div class="flex-1">
                      <span
                        class="font-medium text-gray-800 group-hover:text-blue-800"
                        >Adolescent & Youth SRH</span
                      >
                      <p class="text-xs text-gray-500 mt-1">
                        Sexual and reproductive health for young people
                      </p>
                    </div>
                    <div class="checkmark hidden text-green-500 ml-2">
                      <i class="fas fa-check"></i>
                    </div>
                  </label>

                  <label
                    class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                  >
                    <input
                      type="checkbox"
                      name="themes"
                      value="MNH"
                      class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                    />
                    <div class="flex-1">
                      <span
                        class="font-medium text-gray-800 group-hover:text-blue-800"
                        >Maternal & Newborn Health</span
                      >
                      <p class="text-xs text-gray-500 mt-1">
                        Maternal care and newborn health programs
                      </p>
                    </div>
                    <div class="checkmark hidden text-green-500 ml-2">
                      <i class="fas fa-check"></i>
                    </div>
                  </label>

                  <label
                    class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                  >
                    <input
                      type="checkbox"
                      name="themes"
                      value="FP"
                      class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                    />
                    <div class="flex-1">
                      <span
                        class="font-medium text-gray-800 group-hover:text-blue-800"
                        >Family Planning</span
                      >
                      <p class="text-xs text-gray-500 mt-1">
                        Contraception and family planning services
                      </p>
                    </div>
                    <div class="checkmark hidden text-green-500 ml-2">
                      <i class="fas fa-check"></i>
                    </div>
                  </label>

                  <label
                    class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                  >
                    <input
                      type="checkbox"
                      name="themes"
                      value="CH"
                      class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                    />
                    <div class="flex-1">
                      <span
                        class="font-medium text-gray-800 group-hover:text-blue-800"
                        >Child Health</span
                      >
                      <p class="text-xs text-gray-500 mt-1">
                        Child healthcare and nutrition programs
                      </p>
                    </div>
                    <div class="checkmark hidden text-green-500 ml-2">
                      <i class="fas fa-check"></i>
                    </div>
                  </label>

                  <label
                    class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                  >
                    <input
                      type="checkbox"
                      name="themes"
                      value="AH"
                      class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                    />
                    <div class="flex-1">
                      <span
                        class="font-medium text-gray-800 group-hover:text-blue-800"
                        >Adolescent Health</span
                      >
                      <p class="text-xs text-gray-500 mt-1">
                        Adolescent healthcare and development
                      </p>
                    </div>
                    <div class="checkmark hidden text-green-500 ml-2">
                      <i class="fas fa-check"></i>
                    </div>
                  </label>
                </div>

                <input
                  type="hidden"
                  id="selected_themes"
                  name="selected_themes"
                  value="[]"
                />

                <div
                  class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg hidden"
                  id="themeValidationError"
                >
                  <div class="flex items-center">
                    <i
                      class="fas fa-exclamation-triangle text-red-500 mr-2"
                    ></i>
                    <span class="text-red-700 text-sm"
                      >Please select at least one project theme.</span
                    >
                  </div>
                </div>
              </div>

              <!-- Time Period -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label
                    for="starttime_period"
                    class="block text-sm font-medium text-gray-700"
                    >Start *</label
                  >
                  <input
                    required
                    type="date"
                    id="starttime_period"
                    name="start_date"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="endtime_period"
                    class="block text-sm font-medium text-gray-700"
                    >End *</label
                  >
                  <input
                    type="date"
                    id="endtime_period"
                    name="end_date"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
              </div>

              <!-- Activity Type -->
              <div>
                <label
                  for="activity_type"
                  class="block text-sm font-medium text-gray-700"
                  >Activity Type (Description) *</label
                >
                <textarea
                  required
                  id="activity_type"
                  name="activity_type"
                  rows="3"
                  class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                ></textarea>
              </div>

              <!-- Contact Person -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label
                    for="contact_person_name"
                    class="block text-sm font-medium text-gray-700"
                    >Contact Person Name *</label
                  >
                  <input
                    required
                    type="text"
                    id="contact_person_name"
                    name="contact_person_name"
                    placeholder="Name"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="contact_person_role"
                    class="block text-sm font-medium text-gray-700"
                    >Contact Person Role *</label
                  >
                  <input
                    required
                    type="text"
                    id="contact_person_role"
                    name="contact_person_role"
                    placeholder="Role"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
                <div>
                  <label
                    for="contact_person_email"
                    class="block text-sm font-medium text-gray-700"
                    >Contact Person Email *</label
                  >
                  <input
                    required
                    type="email"
                    id="contact_person_email"
                    name="contact_person_mail"
                    placeholder="Email"
                    class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                  />
                </div>
              </div>

              <!-- Budget -->
              <div>
                <label
                  for="budget"
                  class="block text-sm font-medium text-gray-700"
                  >Budget in KES</label
                >
                <input
                  required
                  type="number"
                  id="budget"
                  name="budget"
                  placeholder="amount"
                  class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                />
              </div>

              <!-- Objectives -->
              <div>
                <label
                  for="gaps"
                  class="block text-sm font-medium text-gray-700"
                  >Objectives *</label
                >
                <textarea
                  required
                  id="gaps"
                  name="gaps"
                  rows="3"
                  class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                ></textarea>
              </div>

              <!-- Supporting Documents -->
              <div
                class="supporting-documents bg-white rounded-lg border-2 border-gray-200 p-6 transition-all duration-200 hover:border-blue-300 hover:shadow-md"
              >
                <div class="flex items-center justify-between mb-4">
                  <label class="block text-lg font-semibold text-gray-800">
                    Supporting Documents
                  </label>
                  <div
                    id="documentsCount"
                    class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm font-medium"
                  >
                    <i class="fas fa-file mr-1"></i>
                    <span id="docsCount">0</span> files
                  </div>
                </div>

                <p class="text-sm text-gray-600 mb-4">
                  Upload relevant documents to support your project proposal
                  (PDF, DOC, DOCX, XLS, XLSX - Max 10MB each)
                </p>

                <!-- File Upload Area -->
                <div
                  class="file-upload-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 hover:bg-blue-50 transition-all duration-200 cursor-pointer"
                  id="fileUploadArea"
                >
                  <div class="upload-icon text-gray-400 mb-4">
                    <i class="fas fa-cloud-upload-alt text-4xl"></i>
                  </div>
                  <div class="upload-text">
                    <p class="text-lg font-medium text-gray-700 mb-2">
                      Drop files here or click to browse
                    </p>
                    <p class="text-sm text-gray-500">
                      Supported formats: PDF, DOC, DOCX, XLS, XLSX
                    </p>
                    <p class="text-xs text-gray-400 mt-1">
                      Maximum file size: 10MB per file
                    </p>
                  </div>
                  <input
                    type="file"
                    id="documentFiles"
                    name="documents"
                    multiple
                    accept=".pdf,.doc,.docx,.xls,.xlsx"
                    class="hidden"
                  />
                </div>

                <!-- Selected Files Display -->
                <div id="selectedFiles" class="mt-4 space-y-2 hidden">
                  <h4 class="text-sm font-medium text-gray-700 mb-3">
                    Selected Files:
                  </h4>
                  <div id="filesList" class="space-y-2">
                    <!-- Files will be added here dynamically -->
                  </div>
                </div>

                <!-- File Upload Error -->
                <div
                  class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg hidden"
                  id="fileUploadError"
                >
                  <div class="flex items-center">
                    <i
                      class="fas fa-exclamation-triangle text-red-500 mr-2"
                    ></i>
                    <span
                      class="text-red-700 text-sm"
                      id="fileErrorMessage"
                    ></span>
                  </div>
                </div>
              </div>

              <!-- Submit Button -->
              <div class="pt-4">
                <button
                  type="submit"
                  class="inline-flex justify-center w-full px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                >
                  Submit Project
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="auth.js"></script>
    <script src="config.js"></script>
    <script src="kenya-locations.js"></script>
    <script src="set-base-url.js"></script>
    <script>
      // Initialize everything when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        initializeCountyDropdown("countySelect", "subCountySelect");
        initializeMap();
        initializeThemeSelection();
        initializeFileUpload();
      });

      // Map initialization
      let map;
      let markers = [];
      let selectedLocations = [];

      function updateLocation(marker, newLngLat) {
        // Find the location in our array and update it
        const locationIndex = selectedLocations.findIndex(
          (loc) => loc.marker === marker
        );
        if (locationIndex !== -1) {
          selectedLocations[locationIndex].lat = newLngLat.lat;
          selectedLocations[locationIndex].lng = newLngLat.lng;
          updateLocationsDisplay();
          updateFormData();
        }
      }

      function removeLocation(locationId) {
        const locationIndex = selectedLocations.findIndex(
          (loc) => loc.id === locationId
        );
        if (locationIndex !== -1) {
          // Remove marker from map
          selectedLocations[locationIndex].marker.remove();

          // Remove from arrays
          selectedLocations.splice(locationIndex, 1);
          markers.splice(locationIndex, 1);

          updateLocationsDisplay();
          updateFormData();
        }
      }

      function updateLocationsDisplay() {
        const container = document.getElementById("selectedLocationsList");

        if (selectedLocations.length === 0) {
          container.innerHTML =
            '<p class="text-gray-500 italic">Click on map to add locations</p>';
          return;
        }

        // Clear container first
        container.innerHTML = "";

        // Process each location
        selectedLocations.forEach((location) => {
          const locationDiv = document.createElement("div");
          locationDiv.className =
            "flex items-center justify-between bg-white p-2 rounded border";
          locationDiv.innerHTML = `
            <span class="text-sm text-blue-600">
              <i class="fas fa-spinner fa-spin mr-2"></i>Loading location...
            </span>
            <button type="button" onclick="removeLocation(${location.id})"
                    class="text-red-500 hover:text-red-700 ml-2">
              <i class="fas fa-times"></i>
            </button>
          `;
          container.appendChild(locationDiv);

          // Reverse geocode to get place name
          fetch(
            `https://api.mapbox.com/geocoding/v5/mapbox.places/${location.lng},${location.lat}.json?access_token=${mapboxgl.accessToken}&types=place,region,country`
          )
            .then((response) => response.json())
            .then((data) => {
              let placeName = `${location.lat.toFixed(
                4
              )}, ${location.lng.toFixed(4)}`; // fallback

              if (data.features && data.features.length > 0) {
                // Try to get a meaningful place name
                const place = data.features.find((f) =>
                  f.place_type.includes("place")
                );
                const region = data.features.find((f) =>
                  f.place_type.includes("region")
                );
                const country = data.features.find((f) =>
                  f.place_type.includes("country")
                );

                if (place) {
                  placeName = `${place.text}, ${
                    country ? country.text : "Kenya"
                  }`;
                } else if (region) {
                  placeName = `${region.text}, Kenya`;
                } else if (country) {
                  placeName = `${country.text}`;
                }
              }

              locationDiv.innerHTML = `
                <span class="text-sm text-blue-600">
                  ${placeName}
                </span>
                <button type="button" onclick="removeLocation(${location.id})"
                        class="text-red-500 hover:text-red-700 ml-2">
                  <i class="fas fa-times"></i>
                </button>
              `;
            })
            .catch((error) => {
              console.error("Geocoding error:", error);
              locationDiv.innerHTML = `
                <span class="text-sm text-blue-600">
                  ${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}
                </span>
                <button type="button" onclick="removeLocation(${location.id})"
                        class="text-red-500 hover:text-red-700 ml-2">
                  <i class="fas fa-times"></i>
                </button>
              `;
            });
        });
      }

      function updateFormData() {
        const locationsData = selectedLocations.map((loc) => ({
          latitude: loc.lat,
          longitude: loc.lng,
        }));
        document.getElementById("project_locations").value =
          JSON.stringify(locationsData);
      }

      // Make removeLocation function globally available
      window.removeLocation = removeLocation;

      function initializeMap() {
        try {
          mapboxgl.accessToken =
            "pk.eyJ1IjoibG9tb2dhbnRlY2giLCJhIjoiY2xzOTcyYXdlMDUxZDJsbXRnZGh2ZmpoYyJ9.sIWvONzgGPF2rtAcECsrJQ";

          map = new mapboxgl.Map({
            container: "newProjectMap",
            style: "mapbox://styles/mapbox/streets-v11",
            center: [37.9062, -0.0236], // Center of Kenya
            zoom: 6,
          });

          map.on("click", function (e) {
            const lngLat = e.lngLat;

            // Create a new marker
            const marker = new mapboxgl.Marker({
              color: "#3B82F6",
              draggable: true,
            })
              .setLngLat(lngLat)
              .addTo(map);

            // Add drag functionality
            marker.on("dragend", function () {
              updateLocation(marker, marker.getLngLat());
            });

            // Store the location
            const locationData = {
              id: Date.now(),
              lat: lngLat.lat,
              lng: lngLat.lng,
              marker: marker,
            };

            selectedLocations.push(locationData);
            markers.push(marker);

            updateLocationsDisplay();
            updateFormData();
          });
        } catch (error) {
          console.error("Map initialization failed:", error);
          document.getElementById("newProjectMap").innerHTML =
            '<div class="flex items-center justify-center h-full text-gray-500"><div class="text-center"><i class="fas fa-map-marked-alt text-4xl mb-2"></i><p>Map unavailable</p><p class="text-sm">Please check Mapbox configuration</p></div></div>';
        }
      }

      // Theme selection handling
      function initializeThemeSelection() {
        const themeCheckboxes = document.querySelectorAll(
          'input[name="themes"]'
        );
        const selectedThemesInput = document.getElementById("selected_themes");
        const themesCountDisplay = document.getElementById("themesCount");
        const themeValidationError = document.getElementById(
          "themeValidationError"
        );
        const selectedThemesDisplay = document.getElementById(
          "selectedThemesDisplay"
        );

        function updateSelectedThemes() {
          const selectedThemes = Array.from(themeCheckboxes)
            .filter((checkbox) => checkbox.checked)
            .map((checkbox) => checkbox.value);

          selectedThemesInput.value = JSON.stringify(selectedThemes);
          themesCountDisplay.textContent = selectedThemes.length;

          // Update visual feedback for each theme option
          themeCheckboxes.forEach((checkbox) => {
            const themeOption = checkbox.closest(".theme-option");
            const checkmark = themeOption.querySelector(".checkmark");

            if (checkbox.checked) {
              themeOption.classList.add("border-blue-500", "bg-blue-50");
              themeOption.classList.remove(
                "border-gray-200",
                "hover:border-blue-400"
              );
              checkmark.classList.remove("hidden");
            } else {
              themeOption.classList.remove("border-blue-500", "bg-blue-50");
              themeOption.classList.add("border-gray-200");
              checkmark.classList.add("hidden");
            }
          });

          // Update counter styling
          if (selectedThemes.length > 0) {
            selectedThemesDisplay.classList.remove(
              "bg-gray-100",
              "text-gray-600"
            );
            selectedThemesDisplay.classList.add("bg-blue-50", "text-blue-700");
          } else {
            selectedThemesDisplay.classList.remove(
              "bg-blue-50",
              "text-blue-700"
            );
            selectedThemesDisplay.classList.add("bg-gray-100", "text-gray-600");
          }

          // Update form validation
          const themeContainer = document.querySelector(".theme-selection");
          if (selectedThemes.length === 0) {
            themeContainer.classList.add("border-red-500");
            themeContainer.classList.remove(
              "border-gray-200",
              "hover:border-blue-300"
            );
            themeValidationError.classList.remove("hidden");
          } else {
            themeContainer.classList.remove("border-red-500");
            themeContainer.classList.add("border-gray-200");
            themeValidationError.classList.add("hidden");
          }
        }

        themeCheckboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", updateSelectedThemes);
        });

        // Initial update
        updateSelectedThemes();
      }

      // File upload handling
      let selectedFiles = [];

      function initializeFileUpload() {
        const fileUploadArea = document.getElementById("fileUploadArea");
        const documentFilesInput = document.getElementById("documentFiles");
        const selectedFilesDiv = document.getElementById("selectedFiles");
        const filesList = document.getElementById("filesList");
        const docsCount = document.getElementById("docsCount");
        const documentsCount = document.getElementById("documentsCount");

        // Click to open file dialog
        fileUploadArea.addEventListener("click", function () {
          documentFilesInput.click();
        });

        // Drag and drop functionality
        fileUploadArea.addEventListener("dragover", function (e) {
          e.preventDefault();
          fileUploadArea.classList.add("border-blue-500", "bg-blue-50");
        });

        fileUploadArea.addEventListener("dragleave", function (e) {
          e.preventDefault();
          fileUploadArea.classList.remove("border-blue-500", "bg-blue-50");
        });

        fileUploadArea.addEventListener("drop", function (e) {
          e.preventDefault();
          fileUploadArea.classList.remove("border-blue-500", "bg-blue-50");

          const files = Array.from(e.dataTransfer.files);
          handleFileSelection(files);
        });

        // File input change
        documentFilesInput.addEventListener("change", function (e) {
          const files = Array.from(e.target.files);
          handleFileSelection(files);
        });

        function handleFileSelection(files) {
          const validFiles = [];
          const errors = [];

          files.forEach((file) => {
            // Validate file type
            const allowedTypes = [
              "application/pdf",
              "application/msword",
              "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
              "application/vnd.ms-excel",
              "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            ];
            const allowedExtensions = [
              ".pdf",
              ".doc",
              ".docx",
              ".xls",
              ".xlsx",
            ];

            const fileExtension = file.name
              .toLowerCase()
              .substring(file.name.lastIndexOf("."));
            const isValidType =
              allowedTypes.includes(file.type) ||
              allowedExtensions.includes(fileExtension);

            if (!isValidType) {
              errors.push(
                `${file.name}: Invalid file type. Only PDF, DOC, DOCX, XLS, XLSX allowed.`
              );
              return;
            }

            // Validate file size (10MB max)
            const maxSize = 10 * 1024 * 1024; // 10MB in bytes
            if (file.size > maxSize) {
              errors.push(
                `${file.name}: File too large. Maximum size is 10MB.`
              );
              return;
            }

            // Check for duplicates
            const isDuplicate = selectedFiles.some(
              (existingFile) =>
                existingFile.name === file.name &&
                existingFile.size === file.size
            );

            if (isDuplicate) {
              errors.push(`${file.name}: File already selected.`);
              return;
            }

            validFiles.push(file);
          });

          // Show errors if any
          if (errors.length > 0) {
            showFileError(errors.join("<br>"));
            return;
          }

          // Hide error if shown
          hideFileError();

          // Add valid files
          selectedFiles.push(...validFiles);
          updateFileDisplay();

          // Clear input
          documentFilesInput.value = "";
        }

        function updateFileDisplay() {
          if (selectedFiles.length === 0) {
            selectedFilesDiv.classList.add("hidden");
            documentsCount.classList.remove("bg-blue-50", "text-blue-700");
            documentsCount.classList.add("bg-gray-100", "text-gray-600");
          } else {
            selectedFilesDiv.classList.remove("hidden");
            documentsCount.classList.remove("bg-gray-100", "text-gray-600");
            documentsCount.classList.add("bg-blue-50", "text-blue-700");
          }

          docsCount.textContent = selectedFiles.length;

          // Clear existing list
          filesList.innerHTML = "";

          // Add files to list
          selectedFiles.forEach((file, index) => {
            const fileDiv = document.createElement("div");
            fileDiv.className =
              "flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200";

            const fileIcon = getFileIcon(file.name);
            const fileSize = formatFileSize(file.size);

            fileDiv.innerHTML = `
              <div class="flex items-center space-x-3">
                <div class="text-blue-500">
                  <i class="${fileIcon}"></i>
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-800">${file.name}</p>
                  <p class="text-xs text-gray-500">${fileSize}</p>
                </div>
              </div>
              <button type="button" onclick="removeFile(${index})" class="text-red-500 hover:text-red-700 transition-colors">
                <i class="fas fa-times"></i>
              </button>
            `;

            filesList.appendChild(fileDiv);
          });
        }

        function getFileIcon(filename) {
          const extension = filename.toLowerCase().split(".").pop();
          switch (extension) {
            case "pdf":
              return "fas fa-file-pdf";
            case "doc":
            case "docx":
              return "fas fa-file-word";
            case "xls":
            case "xlsx":
              return "fas fa-file-excel";
            default:
              return "fas fa-file";
          }
        }

        function formatFileSize(bytes) {
          if (bytes === 0) return "0 Bytes";
          const k = 1024;
          const sizes = ["Bytes", "KB", "MB", "GB"];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return (
            parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
          );
        }

        function showFileError(message) {
          const errorDiv = document.getElementById("fileUploadError");
          const errorMessage = document.getElementById("fileErrorMessage");
          errorMessage.innerHTML = message;
          errorDiv.classList.remove("hidden");
        }

        function hideFileError() {
          const errorDiv = document.getElementById("fileUploadError");
          errorDiv.classList.add("hidden");
        }

        // Make removeFile function globally available
        window.removeFile = function (index) {
          selectedFiles.splice(index, 1);
          updateFileDisplay();
        };
      }

      // Add event listeners for county/sub-county dropdowns to zoom map
      document
        .getElementById("countySelect")
        .addEventListener("change", function () {
          const selectedCounty = this.value;
          if (
            selectedCounty &&
            window.countyCoordinates &&
            window.countyCoordinates[selectedCounty] &&
            map
          ) {
            const [lng, lat] = window.countyCoordinates[selectedCounty];
            map.flyTo({
              center: [lng, lat],
              zoom: 9,
            });
          }
        });

      document
        .getElementById("subCountySelect")
        .addEventListener("change", function () {
          const selectedSubCounty = this.value;
          if (
            selectedSubCounty &&
            window.subCountyCoordinates &&
            window.subCountyCoordinates[selectedSubCounty] &&
            map
          ) {
            const [lng, lat] = window.subCountyCoordinates[selectedSubCounty];
            map.flyTo({
              center: [lng, lat],
              zoom: 11,
            });
          }
        });

      // Form submission
      document
        .getElementById("newProjectForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(this);

          // Add selected files to FormData
          selectedFiles.forEach((file, index) => {
            formData.append(`documents`, file);
          });

          // Get form data as object for validation
          const data = {};
          for (let [key, value] of formData.entries()) {
            if (key !== "documents") {
              // Skip files for validation
              data[key] = value;
            }
          }

          // Parse locations and themes from JSON strings
          try {
            if (data.locations) {
              data.locations = JSON.parse(data.locations);
            }
            if (data.selected_themes) {
              data.themes = JSON.parse(data.selected_themes);
              formData.delete("selected_themes"); // Remove from FormData
              formData.append("themes", JSON.stringify(data.themes)); // Add parsed themes
            }

            // Validate required fields
            if (!data.themes || data.themes.length === 0) {
              const themeValidationError = document.getElementById(
                "themeValidationError"
              );
              themeValidationError.classList.remove("hidden");
              const themeContainer = document.querySelector(".theme-selection");
              themeContainer.classList.add("border-red-500");
              themeContainer.classList.remove(
                "border-gray-200",
                "hover:border-blue-300"
              );
              themeContainer.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });
              return;
            }

            if (!data.locations || data.locations.length === 0) {
              alert("Please select at least one location on the map.");
              return;
            }

            console.log(
              "Submitting form data with files:",
              selectedFiles.length,
              "files"
            );

            const response = await fetch(`${window.BASE_URL}/api/projects`, {
              method: "POST",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
              body: formData, // Send as FormData for file uploads
            });

            if (response.ok) {
              alert("Project created successfully!");
              window.location.href = "projects.html";
            } else {
              const error = await response.json();
              alert(
                "Failed to create project: " +
                  (error.message || "Unknown error")
              );
            }
          } catch (error) {
            console.error("Error processing form data:", error);
            alert("Error processing form data. Please try again.");
          }
        });
    </script>
  </body>
</html>
