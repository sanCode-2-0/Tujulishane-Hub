<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Past Projects - RMNCAH</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Tailwind CSS (with custom config using in          selectedProject: null,
          userEmail: "",>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#1e40af", // Custom Blue
              secondary: "#f59e0b", // Custom Amber
              accent: "#10b981", // Custom Green
              dark: "#1f2937", // Gray-800
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <!-- WARNING: cdn.tailwindcss.com should not be used in production. Use PostCSS or CLI for production builds. -->
    <link rel="stylesheet" href="styles/main.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css"
    />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
      integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css"
      rel="stylesheet"
    />
    <!-- Alpine.js -->
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Optional: Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css"
    />
    <style>
      .fade-slide-enter {
        opacity: 0;
        transform: translateY(20px);
      }

      .fade-slide-enter-active {
        opacity: 1;
        transform: translateY(0);
        transition: all 0.4s ease;
      }

      .fade-slide-leave {
        opacity: 1;
        transform: translateY(0);
      }

      .fade-slide-leave-active {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
      }
    </style>
  </head>

  <body class="text-gray-800 bg-gray-50" x-data="pastProjectsApp()">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <a href="index-post-login.html" class="flex-shrink-0">
              <img
                class="h-8 w-auto"
                src="resources/images/logo.jpg"
                alt="RMNCAH Logo"
              />
            </a>
            <div class="hidden md:block ml-10">
              <div class="flex items-baseline space-x-4">
                <a
                  href="dashboard.html"
                  class="text-gray-600 hover:text-primary px-3 py-2 rounded-md text-sm font-medium"
                  >Dashboard</a
                >
                <a
                  href="projects.html"
                  class="text-gray-600 hover:text-primary px-3 py-2 rounded-md text-sm font-medium"
                  >Active Projects</a
                >
                <a
                  href="past-projects.html"
                  class="text-primary border-b-2 border-primary px-3 py-2 rounded-md text-sm font-medium"
                  >Past Projects</a
                >
                <a
                  href="collaborations.html"
                  class="text-gray-600 hover:text-primary px-3 py-2 rounded-md text-sm font-medium"
                  >Collaborations</a
                >
                <a
                  href="organizations.html"
                  class="text-gray-600 hover:text-primary px-3 py-2 rounded-md text-sm font-medium"
                  >Organizations</a
                >
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-4">
            <span class="text-sm text-gray-700" x-text="userEmail"></span>
            <button
              @click="logout"
              class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md text-sm font-medium"
            >
              <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="md:flex md:items-center md:justify-between mb-6">
        <div class="flex-1 min-w-0">
          <h2
            class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate"
          >
            Past Projects Repository
          </h2>
          <p class="mt-1 text-sm text-gray-500">
            Past projects (completed and stalled) for learning and reference
          </p>
        </div>
      </div>

      <!-- Filters and Search -->
      <div class="bg-white shadow rounded-lg mb-6">
        <div class="px-4 py-5 sm:p-6">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Search -->
            <div>
              <label
                for="search"
                class="block text-sm font-medium text-gray-700"
                >Search</label
              >
              <input
                type="text"
                id="search"
                x-model="filters.search"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm"
                placeholder="Project title, partner..."
              />
            </div>

            <!-- Status Filter -->
            <div>
              <label
                for="status"
                class="block text-sm font-medium text-gray-700"
                >Final Status</label
              >
              <select
                id="status"
                x-model="filters.finalStatus"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm"
              >
                <option value="">All Statuses</option>
                <option value="completed">Completed</option>
                <option value="stalled">Stalled</option>
                <option value="abandoned">Abandoned</option>
              </select>
            </div>

            <!-- County Filter -->
            <div>
              <label
                for="county"
                class="block text-sm font-medium text-gray-700"
                >County</label
              >
              <input
                type="text"
                id="county"
                x-model="filters.county"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm"
                placeholder="County name"
              />
            </div>

            <!-- Theme Filter -->
            <div>
              <label for="theme" class="block text-sm font-medium text-gray-700"
                >Theme</label
              >
              <select
                id="theme"
                x-model="filters.theme"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm"
              >
                <option value="">All Themes</option>
                <option value="RMNCH">RMNCH</option>
                <option value="FP">Family Planning</option>
                <option value="ADOLESCENT_HEALTH">Adolescent Health</option>
              </select>
            </div>
          </div>

          <div class="mt-4 flex justify-end">
            <button
              @click="applyFilters"
              class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium"
            >
              <i class="fas fa-search mr-2"></i>Search
            </button>
            <button
              @click="clearFilters"
              class="ml-2 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium"
            >
              <i class="fas fa-times mr-2"></i>Clear
            </button>
          </div>
        </div>
      </div>

      <!-- Projects List -->
      <div class="bg-white shadow overflow-hidden sm:rounded-md">
        <div x-show="loading" class="text-center py-12">
          <i class="fas fa-spinner fa-spin text-4xl text-primary"></i>
          <p class="mt-4 text-gray-500">Loading past projects...</p>
        </div>

        <div
          x-show="!loading && pastProjects.length === 0"
          class="text-center py-12"
        >
          <i class="fas fa-archive text-4xl text-gray-400"></i>
          <h3 class="mt-2 text-sm font-medium text-gray-900">
            No past projects
          </h3>
          <p class="mt-1 text-sm text-gray-500">
            No archived projects match your criteria.
          </p>
        </div>

        <ul
          x-show="!loading && pastProjects.length > 0"
          class="divide-y divide-gray-200"
          x-html="renderProjectsList()"
        >

        <!-- Pagination -->
        <div
          x-show="!loading && pastProjects.length > 0"
          class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6"
        >
          <div class="flex-1 flex justify-between sm:hidden">
            <button
              @click="prevPage"
              :disabled="currentPage === 0"
              class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50"
            >
              Previous
            </button>
            <button
              @click="nextPage"
              :disabled="currentPage >= totalPages - 1"
              class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50"
            >
              Next
            </button>
          </div>
          <div
            class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between"
          >
            <div>
              <p class="text-sm text-gray-700">
                Showing
                <span
                  class="font-medium"
                  x-text="currentPage * size + 1"
                ></span>
                to
                <span
                  class="font-medium"
                  x-text="Math.min((currentPage + 1) * size, totalItems)"
                ></span>
                of <span class="font-medium" x-text="totalItems"></span> results
              </p>
            </div>
            <div>
              <nav
                class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px"
              >
                <button
                  @click="prevPage"
                  :disabled="currentPage === 0"
                  class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50"
                >
                  <i class="fas fa-chevron-left"></i>
                </button>
                <button
                  @click="nextPage"
                  :disabled="currentPage >= totalPages - 1"
                  class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50 disabled:opacity-50"
                >
                  <i class="fas fa-chevron-right"></i>
                </button>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Project Details Modal -->
    <div
      x-show="selectedProject"
      x-cloak
      class="fixed inset-0 z-50 overflow-y-auto"
      aria-labelledby="modal-title"
      role="dialog"
      aria-modal="true"
    >
      <div
        class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
      >
        <div
          class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
          @click="closeModal"
        ></div>

        <div
          class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full"
        >
          <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
            <div class="sm:flex sm:items-start">
              <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                <h3
                  class="text-lg leading-6 font-medium text-gray-900 mb-4"
                  x-text="selectedProject?.title || 'Project Details'"
                ></h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <!-- Basic Information -->
                  <div>
                    <h4 class="text-md font-medium text-gray-900 mb-3">
                      Project Information
                    </h4>
                    <dl class="space-y-2">
                      <div>
                        <dt class="text-sm font-medium text-gray-500">
                          Partner
                        </dt>
                        <dd
                          class="text-sm text-gray-900"
                          x-text="selectedProject?.partner || 'N/A'"
                        ></dd>
                      </div>
                      <div>
                        <dt class="text-sm font-medium text-gray-500">Theme</dt>
                        <dd
                          class="text-sm text-gray-900"
                          x-text="selectedProject?.projectTheme || 'N/A'"
                        ></dd>
                      </div>
                      <div>
                        <dt class="text-sm font-medium text-gray-500">
                          Location
                        </dt>
                        <dd
                          class="text-sm text-gray-900"
                          x-text="selectedProject?.county + (selectedProject?.subCounty ? ', ' + selectedProject.subCounty : '') || 'N/A'"
                        ></dd>
                      </div>
                      <div>
                        <dt class="text-sm font-medium text-gray-500">
                          Duration
                        </dt>
                        <dd
                          class="text-sm text-gray-900"
                          x-text="(selectedProject?.startDate ? formatDate(selectedProject.startDate) : 'N/A') + ' - ' + (selectedProject?.endDate ? formatDate(selectedProject.endDate) : 'N/A')"
                        ></dd>
                      </div>
                      <div>
                        <dt class="text-sm font-medium text-gray-500">
                          Final Status
                        </dt>
                        <dd
                          class="text-sm text-gray-900"
                          x-text="selectedProject?.status || 'N/A'"
                        ></dd>
                      </div>
                      <div>
                        <dt class="text-sm font-medium text-gray-500">
                          Completion %
                        </dt>
                        <dd
                          class="text-sm text-gray-900"
                          x-text="(selectedProject?.completionPercentage || 0) + '%'"
                        ></dd>
                      </div>
                    </dl>
                  </div>

                  <!-- Project Description/Objectives -->
                  <div class="mt-6">
                    <h4 class="text-md font-medium text-gray-900 mb-2">
                      Description & Objectives
                    </h4>
                    <p
                      class="text-sm text-gray-700"
                      x-text="selectedProject?.objectives || selectedProject?.description || 'Not available'"
                    ></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
            <button
              type="button"
              @click="closeModal"
              class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:ml-3 sm:w-auto sm:text-sm"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      function pastProjectsApp() {
        return {
          pastProjects: [],
          loading: false,
          currentPage: 0,
          totalPages: 0,
          totalItems: 0,
          size: 10,
          filters: {
            search: "",
            finalStatus: "",
            county: "",
            theme: "",
          },
          selectedProject: null,
          userEmail: "",
          showAddForm: false,
          newProject: {
            title: "",
            partner: "",
            county: "",
            finalStatus: "completed",
            startDate: "",
            endDate: "",
            lessonsLearned: "",
            successFactors: "",
            challenges: "",
            recommendations: "",
          },

          init() {
            this.loadUserInfo();
            this.loadPastProjects();
          },

          loadUserInfo() {
            console.log("Loading user info...");
            const token = localStorage.getItem("accessToken");
            console.log(
              "Token check in loadUserInfo:",
              token ? "present" : "not found"
            );

            if (token) {
              console.log("Decoding token...");
              // Decode token to get user info (simplified)
              try {
                const payload = JSON.parse(atob(token.split(".")[1]));
                this.userEmail = payload.sub || "User";
                console.log("User email set to:", this.userEmail);
              } catch (e) {
                console.error("Error decoding token:", e);
                this.userEmail = "User";
              }
            } else {
              console.log("No token found, setting userEmail to Guest");
              this.userEmail = "Guest";
            }
          },

          showAuthError() {
            // Show authentication required message without clearing the page
            const errorDiv = document.createElement("div");
            errorDiv.style =
              "background: #ffebee; color: #c62828; padding: 2em; margin: 2em; border-radius: 8px; text-align: center; border: 1px solid #ffcdd2;";
            errorDiv.innerHTML = `
              <i class="fas fa-lock" style="font-size: 3em; margin-bottom: 1em;"></i>
              <h3 style="margin-bottom: 1em;">Authentication Required</h3>
              <p>You must be logged in to access the Past Projects Repository.</p>
              <p>This feature requires authentication to view archived project data.</p>
              <button onclick="window.location.href='index.html'" style="margin-top: 1em; padding: 0.5em 1em; background: #c62828; color: white; border: none; border-radius: 4px; cursor: pointer;">Go to Login</button>
            `;

            // Insert after the header
            const header = document.querySelector("nav");
            if (header) {
              header.insertAdjacentElement("afterend", errorDiv);
            } else {
              document.body.insertBefore(errorDiv, document.body.firstChild);
            }
          },

          async loadPastProjects() {
            console.log("=== loadPastProjects called ===");
            console.log("Current state:", {
              pastProjects: this.pastProjects,
              loading: this.loading,
              currentPage: this.currentPage,
              totalItems: this.totalItems,
            });

            this.loading = true;
            try {
              const token = localStorage.getItem("accessToken");
              console.log(
                "Auth token from localStorage:",
                token ? "present" : "not found"
              );

              if (!token) {
                console.log("No auth token found, showing auth error");
                this.showAuthError();
                return;
              }

              console.log("Making API request to /api/past-projects");
              console.log(
                "Request URL:",
                `/api/past-projects?page=${this.currentPage}&size=${this.size}`
              );

              const response = await fetch(
                `http://localhost:8080/api/past-projects?page=${this.currentPage}&size=${this.size}`,
                {
                  headers: {
                    Authorization: `Bearer ${token}`,
                    "Content-Type": "application/json",
                  },
                }
              );

              console.log("API response status:", response.status);
              console.log("API response ok:", response.ok);
              console.log(
                "Response headers:",
                Object.fromEntries(response.headers.entries())
              );

              if (response.ok) {
                const data = await response.json();
                console.log(
                  "Full API response data:",
                  JSON.stringify(data, null, 2)
                );

                if (data && data.data) {
                  console.log("Setting pastProjects array...");
                  // Clear and repopulate the array to ensure reactivity
                  this.pastProjects.splice(0);
                  const projects = data.data.pastProjects || [];
                  for (let i = 0; i < projects.length; i++) {
                    this.pastProjects.push(projects[i]);
                  }
                  
                  this.totalItems = data.data.totalItems || 0;
                  this.totalPages = Math.ceil(this.totalItems / this.size);
                  console.log(
                    `Successfully loaded ${this.pastProjects.length} past projects`
                  );
                  console.log("Past projects data:", this.pastProjects);
                  
                  // Force Alpine.js to update
                  this.$nextTick(() => {
                    console.log("After nextTick - pastProjects:", this.pastProjects);
                    // Trigger re-render
                    this.renderProjectsList();
                    // Small delay to ensure DOM updates
                    setTimeout(() => {
                      console.log("After timeout - forcing update");
                    }, 100);
                  });
                } else {
                  console.error("Invalid response structure:", data);
                  this.pastProjects = [];
                }
              } else {
                console.error(
                  "Past projects API not available:",
                  response.status,
                  response.statusText
                );
                const errorText = await response.text();
                console.error("Error response body:", errorText);
                this.pastProjects = [];
                // Try to show a user-friendly error
                alert(
                  `Failed to load past projects: ${response.status} ${response.statusText}`
                );
              }
            } catch (error) {
              console.error("Exception in loadPastProjects:", error);
              console.error("Error stack:", error.stack);
              this.pastProjects = [];
              alert(`Error loading past projects: ${error.message}`);
            } finally {
              console.log("Setting loading to false...");
              this.loading = false;
              console.log("Loading state after setting:", this.loading);
              console.log("=== loadPastProjects completed ===");
            }
          },

          showFeatureNotAvailable() {
            // Show message that feature is coming soon
            const messageDiv = document.createElement("div");
            messageDiv.style =
              "background: #e3f2fd; color: #1976d2; padding: 2em; margin: 2em; border-radius: 8px; text-align: center; border: 1px solid #bbdefb;";
            messageDiv.innerHTML = `
              <i class="fas fa-tools" style="font-size: 3em; margin-bottom: 1em;"></i>
              <h3 style="margin-bottom: 1em;">Past Projects Repository</h3>
              <p>This feature is currently under development and will be available soon.</p>
              <p>The backend is being updated to support archiving and viewing completed and stalled projects.</p>
              <button onclick="window.location.href='index-post-login.html'" style="margin-top: 1em; padding: 0.5em 1em; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">Return to Dashboard</button>
            `;

            // Insert after the header
            const header = document.querySelector("nav");
            if (header) {
              header.insertAdjacentElement("afterend", messageDiv);
            } else {
              document.body.insertBefore(messageDiv, document.body.firstChild);
            }
          },

          applyFilters() {
            this.currentPage = 0;
            this.loadPastProjects();
          },

          clearFilters() {
            this.filters = {
              search: "",
              finalStatus: "",
              county: "",
              theme: "",
            };
            this.currentPage = 0;
            this.loadPastProjects();
          },

          prevPage() {
            if (this.currentPage > 0) {
              this.currentPage--;
              this.loadPastProjects();
            }
          },

          nextPage() {
            if (this.currentPage < this.totalPages - 1) {
              this.currentPage++;
              this.loadPastProjects();
            }
          },

          viewProjectDetails(project) {
            console.log("viewProjectDetails called with:", project);
            this.selectedProject = project || null;
          },

          renderProjectsList() {
            console.log("renderProjectsList called, projects:", this.pastProjects);
            if (!this.pastProjects || this.pastProjects.length === 0) {
              return '<li class="p-4 text-center text-gray-500">No projects to display</li>';
            }
            
            return this.pastProjects.map((project, index) => `
              <li class="px-4 py-4 sm:px-6 hover:bg-gray-50">
                <div class="text-lg font-medium text-primary">${project.title || 'Untitled Project'}</div>
                <div class="text-sm text-gray-500">Status: ${project.status || 'Unknown'}</div>
                <div class="text-sm text-gray-500">Partner: ${project.partner || 'N/A'}</div>
              </li>
            `).join('');
          },

          closeModal() {
            this.selectedProject = null;
          },

          formatDate(dateString) {
            if (!dateString) return "N/A";
            return new Date(dateString).toLocaleDateString();
          },
        };
      }
    </script>
  </body>
</html>
