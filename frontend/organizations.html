<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RMNCAH Organizations</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Tailwind CSS (with custom config using inline script) -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#1e40af", // Custom Blue
              secondary: "#f59e0b", // Custom Amber
              accent: "#10b981", // Custom Green
              dark: "#1f2937", // Gray-800
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="styles/main.css" />
    <!-- Backend URL Configuration -->
    <script src="./config.js"></script>
    <script src="./set-base-url.js"></script>
    <!-- Modal Utilities -->
    <script src="./modal-utils.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css"
    />
    <script src="styles/main.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <!-- Alpine.js -->
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
      integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <script src="auth.js"></script>
    <style>
      .hidden {
        display: none;
      }

      .error {
        color: red;
      }

      .success {
        color: green;
      }

      .admin-action {
        margin-left: 1em;
      }

      .input-field {
        @apply border border-gray-200 rounded-lg px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-400 focus:outline-none transition;
      }
    </style>
  </head>

  <body>
    <div class="" id="nav-placeholder"></div>

    <h1 class="mb-8 text-4xl font-bold tracking-wide text-center text-blue-700">
      <i class="mr-2 fa-solid fa-building-columns"></i>
      Organization Management
    </h1>

    <div id="org-message" class="mb-6 text-sm font-medium text-center"></div>

    <!-- Create Organization Form -->
    <section
      class="p-6 transition border border-gray-100 shadow-lg bg-white/80 backdrop-blur-md rounded-xl hover:shadow-xl"
    >
      <h2 class="flex items-center mb-4 text-xl font-semibold text-gray-700">
        <i class="mr-2 text-green-600 fa-solid fa-plus-circle"></i> Create
        Organization
      </h2>
      <form id="createOrgForm" class="grid grid-cols-1 gap-4 md:grid-cols-2">
        <input
          class="input-field"
          type="text"
          name="name"
          placeholder="Organization Name"
          required
        />
        <input
          class="input-field"
          type="text"
          name="organizationType"
          placeholder="Type (e.g. NGO)"
          required
        />
        <input
          class="input-field md:col-span-2"
          type="text"
          name="description"
          placeholder="Description"
        />
        <input
          class="input-field"
          type="email"
          name="contactEmail"
          placeholder="Contact Email"
          required
        />
        <input
          class="input-field"
          type="text"
          name="contactPhone"
          placeholder="Contact Phone"
        />
        <input
          class="input-field md:col-span-2"
          type="text"
          name="address"
          placeholder="Address"
        />
        <input
          class="input-field"
          type="url"
          name="websiteUrl"
          placeholder="Website URL"
        />
        <input
          class="input-field"
          type="text"
          name="registrationNumber"
          placeholder="Registration Number"
        />
        <button
          type="submit"
          class="col-span-2 px-4 py-2 font-semibold text-white transition bg-blue-600 rounded-lg hover:bg-blue-700"
        >
          <i class="mr-1 fa-solid fa-paper-plane"></i> Create
        </button>
      </form>
    </section>

    <!-- Search Organizations -->
    <section
      class="p-6 transition border border-gray-100 shadow-lg bg-white/80 backdrop-blur-md rounded-xl hover:shadow-xl"
    >
      <h2 class="flex items-center mb-4 text-xl font-semibold text-gray-700">
        <i class="mr-2 fa-solid fa-search"></i> Search Organizations
      </h2>
      <div class="flex gap-2">
        <input
          class="flex-1 input-field"
          type="text"
          id="orgSearchInput"
          placeholder="Search by name..."
        />
        <button
          onclick="searchOrganizations()"
          class="px-4 font-semibold text-white transition bg-gray-700 rounded-lg hover:bg-black"
        >
          Search
        </button>
      </div>
      <ul id="orgSearchResults" class="pl-6 mt-3 text-gray-700 list-disc"></ul>
    </section>

    <!-- List Organizations -->
    <section
      class="p-6 transition border border-gray-100 shadow-lg bg-white/80 backdrop-blur-md rounded-xl hover:shadow-xl"
    >
      <h2 class="flex items-center mb-4 text-xl font-semibold text-gray-700">
        <i class="mr-2 fa-solid fa-list"></i> All Organizations
      </h2>
      <button
        onclick="loadOrganizations()"
        class="px-4 py-2 mb-2 font-semibold text-white transition bg-purple-600 rounded-lg hover:bg-purple-700"
      >
        Refresh List
      </button>
      <ul id="orgList" class="pl-6 text-gray-700 list-disc"></ul>
    </section>

    <!-- Admin Actions -->
    <section
      id="adminSection"
      class="hidden p-6 transition border border-gray-100 shadow-lg bg-white/80 backdrop-blur-md rounded-xl hover:shadow-xl"
    >
      <h2 class="flex items-center mb-4 text-xl font-semibold text-gray-700">
        <i class="mr-2 fa-solid fa-shield-halved"></i> Admin: Pending
        Organizations
      </h2>
      <button
        onclick="loadPendingOrganizations()"
        class="px-4 py-2 mb-2 font-semibold text-white transition bg-red-600 rounded-lg hover:bg-red-700"
      >
        Load Pending
      </button>
      <ul id="pendingOrgList" class="pl-6 mb-4 text-gray-700 list-disc"></ul>

      <h2 class="flex items-center mb-4 text-xl font-semibold text-gray-700">
        <i class="mr-2 fa-solid fa-chart-bar"></i> Admin: Organization Stats
      </h2>
      <button
        onclick="loadOrgStats()"
        class="px-4 py-2 mb-2 font-semibold text-white transition bg-indigo-600 rounded-lg hover:bg-indigo-700"
      >
        Load Stats
      </button>
      <pre id="orgStats" class="p-3 bg-gray-100 rounded-md"></pre>
    </section>
    <script src="styles/authnav.js"></script>
    <script src="styles/loadNav.js"></script>
    <script>
      const API_BASE =
        window.location.hostname === "localhost" ||
        window.location.hostname === "127.0.0.1"
          ? "https://tujulishane-hub-backend-52b7e709d99f.herokuapp.com/api/organizations"
          : "https://tujulishane-hub-backend-52b7e709d99f.herokuapp.com/api/organizations";
      const messageDiv = document.getElementById("org-message");
      const orgList = document.getElementById("orgList");
      const orgSearchResults = document.getElementById("orgSearchResults");
      const pendingOrgList = document.getElementById("pendingOrgList");
      const orgStats = document.getElementById("orgStats");
      const adminSection = document.getElementById("adminSection");

      // Helper: show message
      function showMessage(msg, type = "") {
        messageDiv.textContent = msg;
        messageDiv.className = type;
      }

      // Helper: get auth token
      function getToken() {
        return window.authManager && window.authManager.getToken
          ? window.authManager.getToken()
          : localStorage.getItem("accessToken");
      }

      // Helper: is admin
      function isAdmin() {
        const user =
          window.authManager && window.authManager.getCachedUser
            ? window.authManager.getCachedUser()
            : null;
        return (
          user &&
          (user.role === "SUPER_ADMIN" ||
            user.role === "SUPER_ADMIN_REVIEWER" ||
            user.role === "SUPER_ADMIN_APPROVER" ||
            user.role === "ADMIN")
        );
      }

      // Create Organization
      document.getElementById("createOrgForm").onsubmit = async function (e) {
        e.preventDefault();
        const form = e.target;
        const data = Object.fromEntries(new FormData(form));
        try {
          const res = await fetch(API_BASE, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${getToken()}`,
            },
            body: JSON.stringify(data),
          });
          let result = null;
          const contentType = res.headers.get("content-type");
          if (contentType && contentType.includes("application/json")) {
            try {
              result = await res.json();
            } catch (jsonErr) {
              showMessage(
                `Invalid JSON response. (${res.status} ${res.statusText})`,
                "error"
              );
              return;
            }
          }
          if (res.status === 201) {
            showMessage("Organization created!", "success");
            form.reset();
            loadOrganizations();
          } else {
            let errorMsg = "Failed to create organization";
            if (result && result.message) {
              errorMsg = result.message;
            } else if (res.status && res.statusText) {
              errorMsg = `Failed to create organization (${res.status} ${res.statusText})`;
            }
            showMessage(errorMsg, "error");
          }
        } catch (err) {
          showMessage(err.message, "error");
        }
      };

      // List Organizations
      async function loadOrganizations(page = 0, size = 10) {
        orgList.innerHTML = "Loading...";
        try {
          const res = await fetch(`${API_BASE}?page=${page}&size=${size}`, {
            headers: { Authorization: `Bearer ${getToken()}` },
          });
          let data = null;
          const contentType = res.headers.get("content-type");
          if (contentType && contentType.includes("application/json")) {
            try {
              data = await res.json();
            } catch (jsonErr) {
              orgList.innerHTML = "Invalid JSON response.";
              return;
            }
          } else {
            orgList.innerHTML = "No JSON response from server.";
            return;
          }
          if (res.ok && data && data.status === 200) {
            orgList.innerHTML = "";
            const orgs =
              data.data && Array.isArray(data.data.organizations)
                ? data.data.organizations
                : [];
            orgs.forEach((org) => {
              const li = document.createElement("li");
              li.innerHTML = `<b>${org.name}</b> (${org.organizationType}) - ${org.approvalStatus} <button onclick='viewOrganization(${org.id})'>View</button>`;
              orgList.appendChild(li);
            });
          } else {
            orgList.innerHTML =
              data && data.message
                ? data.message
                : "Failed to load organizations.";
          }
        } catch (err) {
          orgList.innerHTML = err.message;
        }
      }

      // View Organization by ID
      async function viewOrganization(id) {
        showMessage("");
        try {
          const res = await fetch(`${API_BASE}/${id}`, {
            headers: { Authorization: `Bearer ${getToken()}` },
          });
          const contentType = res.headers.get("content-type");
          let data = null;
          if (contentType && contentType.includes("application/json")) {
            try {
              data = await res.json();
            } catch (jsonErr) {
              showMessage("Invalid JSON response.", "error");
              return;
            }
          }
          if (res.ok && data && data.status === 200 && data.data) {
            await showAlert(
              JSON.stringify(data.data, null, 2),
              "Organization Details",
              "info"
            );
          } else {
            showMessage(
              (data && data.message) || "Failed to load organization",
              "error"
            );
          }
        } catch (err) {
          showMessage(err.message, "error");
        }
      }

      // Search Organizations
      async function searchOrganizations() {
        const keyword = document.getElementById("orgSearchInput").value;
        orgSearchResults.innerHTML = "Searching...";
        try {
          const res = await fetch(
            `${API_BASE}/search?keyword=${encodeURIComponent(keyword)}`,
            { headers: { Authorization: `Bearer ${getToken()}` } }
          );
          const contentType = res.headers.get("content-type");
          let data = null;
          if (contentType && contentType.includes("application/json")) {
            try {
              data = await res.json();
            } catch (jsonErr) {
              orgSearchResults.innerHTML = "Invalid JSON response.";
              return;
            }
          }
          if (res.ok && data && data.status === 200) {
            orgSearchResults.innerHTML = "";
            const orgs = Array.isArray(data.data) ? data.data : [];
            orgs.forEach((org) => {
              const li = document.createElement("li");
              li.textContent = `${org.name} (${org.organizationType}) - ${org.approvalStatus}`;
              orgSearchResults.appendChild(li);
            });
          } else {
            orgSearchResults.innerHTML = "No results.";
          }
        } catch (err) {
          orgSearchResults.innerHTML = err.message;
        }
      }

      // Update Organization (example: prompt for new name)
      async function updateOrganization(id) {
        const newName = prompt("Enter new organization name:");
        if (!newName) return;
        try {
          const res = await fetch(`${API_BASE}/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${getToken()}`,
            },
            body: JSON.stringify({ name: newName }),
          });
          const data = await res.json();
          if (res.ok && data.status === 200) {
            showMessage("Organization updated!", "success");
            loadOrganizations();
          } else {
            showMessage(
              data.message || "Failed to update organization",
              "error"
            );
          }
        } catch (err) {
          showMessage(err.message, "error");
        }
      }

      // Admin: Load Pending Organizations
      async function loadPendingOrganizations() {
        pendingOrgList.innerHTML = "Loading...";
        try {
          const res = await fetch(`${API_BASE}/admin/pending`, {
            headers: { Authorization: `Bearer ${getToken()}` },
          });
          const data = await res.json();
          if (res.ok && data.status === 200) {
            pendingOrgList.innerHTML = "";
            (data.data || []).forEach((org) => {
              const li = document.createElement("li");
              li.innerHTML = `<b>${org.name}</b> (${org.organizationType}) <button class='admin-action' onclick='approveOrganization(${org.id})'>Approve</button> <button class='admin-action' onclick='rejectOrganization(${org.id})'>Reject</button> <button class='admin-action' onclick='deleteOrganization(${org.id})'>Delete</button>`;
              pendingOrgList.appendChild(li);
            });
          } else {
            pendingOrgList.innerHTML = "Failed to load pending organizations.";
          }
        } catch (err) {
          pendingOrgList.innerHTML = err.message;
        }
      }

      // Admin: Approve Organization
      async function approveOrganization(id) {
        try {
          const res = await fetch(`${API_BASE}/admin/approve/${id}`, {
            method: "POST",
            headers: { Authorization: `Bearer ${getToken()}` },
          });
          const data = await res.json();
          if (res.ok && data.status === 200) {
            showMessage("Organization approved!", "success");
            loadPendingOrganizations();
          } else {
            showMessage(
              data.message || "Failed to approve organization",
              "error"
            );
          }
        } catch (err) {
          showMessage(err.message, "error");
        }
      }

      // Admin: Reject Organization
      async function rejectOrganization(id) {
        const reason = prompt("Enter rejection reason:");
        if (!reason) return;
        try {
          const res = await fetch(`${API_BASE}/admin/reject/${id}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${getToken()}`,
            },
            body: JSON.stringify({ reason }),
          });
          const data = await res.json();
          if (res.ok && data.status === 200) {
            showMessage("Organization rejected!", "success");
            loadPendingOrganizations();
          } else {
            showMessage(
              data.message || "Failed to reject organization",
              "error"
            );
          }
        } catch (err) {
          showMessage(err.message, "error");
        }
      }

      // Admin: Delete Organization
      async function deleteOrganization(id) {
        const confirmed = await showConfirm(
          "Are you sure you want to delete this organization?",
          "Delete Organization",
          "Delete",
          "Cancel"
        );

        if (!confirmed) return;

        try {
          const res = await fetch(`${API_BASE}/admin/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${getToken()}` },
          });
          const data = await res.json();
          if (res.ok && data.status === 200) {
            showMessage("Organization deleted!", "success");
            loadPendingOrganizations();
          } else {
            showMessage(
              data.message || "Failed to delete organization",
              "error"
            );
          }
        } catch (err) {
          showMessage(err.message, "error");
        }
      }

      // Admin: Get Organization Stats
      async function loadOrgStats() {
        orgStats.textContent = "Loading...";
        try {
          const res = await fetch(`${API_BASE}/admin/stats`, {
            headers: { Authorization: `Bearer ${getToken()}` },
          });
          const data = await res.json();
          if (res.ok && data.status === 200) {
            orgStats.textContent = JSON.stringify(data.data, null, 2);
          } else {
            orgStats.textContent = data.message || "Failed to load stats.";
          }
        } catch (err) {
          orgStats.textContent = err.message;
        }
      }

      // Show admin section if user is admin
      window.addEventListener("DOMContentLoaded", () => {
        loadOrganizations();
        if (isAdmin()) {
          adminSection.classList.remove("hidden");
        }
      });
    </script>
  </body>
</html>
