<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>RMNCAH</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
		integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
		crossorigin="anonymous" referrerpolicy="no-referrer" />
	<!-- Tailwind CSS (with custom config using inline script) -->
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						primary: "#1e40af", // Custom Blue
						secondary: "#f59e0b", // Custom Amber
						accent: "#10b981", // Custom Green
						dark: "#1f2937", // Gray-800
					},
					fontFamily: {
						sans: ["Inter", "sans-serif"],
					},
				},
			},
		};
	</script>
	<link rel="stylesheet" href="styles/main.css" />
	<script src="./set-base-url.js"></script>
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css" />
	<script src="styles/main.js"></script>
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
		integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800;900&display=swap"
		rel="stylesheet" />
	<script src="auth.js"></script>
	<style>
		.hidden {
			display: none;
		}

		.error {
			color: red;
		}

		.success {
			color: green;
		}

		.admin-action {
			margin-left: 1em;
		}

		.input-field {
			@apply border border-gray-200 rounded-lg px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-400 focus:outline-none transition;
		}
	</style>
</head>

<body>
	<div data-twe-modal-init
		class="fixed left-0 top-0 backdrop-blur-md z-[1055] hidden h-full w-full overflow-y-auto overflow-x-hidden outline-none"
		id="createNewProject" tabindex="-1" aria-labelledby="createNewProjectTitle" aria-modal="true" role="dialog">
		<div data-twe-modal-dialog-ref
			class="pointer-events-none relative flex min-h-[calc(100%-1rem)] w-auto translate-y-[-50px] items-center opacity-0 transition-all duration-300 ease-in-out min-[576px]:mx-auto min-[576px]:mt-7 min-[576px]:max-w-[500px] min-[992px]:max-w-[800px] min-[1200px]:max-w-[1140px]">
			<div
				class="relative flex flex-col w-full text-current bg-white border-none rounded-md outline-none pointer-events-auto bg-clip-padding shadow-4">
				<div
					class="flex items-center justify-between flex-shrink-0 p-4 border-b-2 rounded-t-md border-neutral-100">
					<!-- Modal title -->
					<h5 class="text-xl font-light uppercase leading-normal text-surface" id="createNewProjectTitle">
						New Project
					</h5>
					<!-- Close button -->
					<button type="button"
						class="box-content border-none rounded-none text-neutral-500 hover:text-neutral-800 hover:no-underline focus:text-neutral-800 focus:opacity-100 focus:shadow-none focus:outline-none"
						data-twe-modal-dismiss aria-label="Close">
						<span class="[&>svg]:h-6 [&>svg]:w-6">
							<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"
								stroke-width="1.5" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
							</svg>
						</span>
					</button>
				</div>

				<!-- Modal body -->
				<div class="relative p-4">
					<form id="newProjectForm">
						<div class="grid grid-cols-2 gap-4 lg:grid-cols-4">
							<!-- Map Picker for Location -->
							<div class="col-span-2 lg:col-span-4">
								<label class="block text-sm font-medium text-gray-700 mb-2">Pick Project Location on
									Map</label>
								<div class="text-xs text-gray-600 mb-2">
									Search for a location or click on the map to select the
									project coordinates.
								</div>
								<div id="newProjectMap" style="
                      height: 400px;
                      width: 100%;
                      border-radius: 8px;
                      margin-bottom: 8px;
                      border: 1px solid #e5e7eb;
                      background-color: #f3f4f6;
                      position: relative;
                      overflow: hidden;
                    "></div>
								<input type="hidden" id="project_latitude" name="latitude" />
								<input type="hidden" id="project_longitude" name="longitude" />
								<input type="hidden" id="project_county" name="county" />
								<input type="hidden" id="project_subcounty" name="subcounty" />
								<div class="text-sm text-gray-700 mt-2 p-2 bg-gray-50 rounded">
									<strong>Selected Location:</strong>
									<span id="selectedLatLng" class="font-mono text-blue-600">Click on map to select
										location</span>
									<br />
									<span id="selectedCounty" class="text-gray-600"></span>
								</div>
							</div>
							<!-- Title -->
							<div>
								<label for="title" class="block text-sm font-medium text-gray-700">Title *</label>
								<input required type="text" id="title" name="title"
									class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
							</div>

							<!-- Project Theme -->
							<div>
								<label for="theme" class="block text-sm font-medium text-gray-700">Project Theme
									*</label>
								<select id="theme" name="theme"
									class="block w-full p-2 mt-1 text-black bg-white border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
									<option value="">Select Theme</option>
									<option value="GBV">Gender based violence</option>
									<option value="AYPSRH">
										Adolescent and Young People Sexual and Reproductive Health
									</option>
									<option value="MNH">Maternal and Newborn Health</option>
									<option value="FP">Family planning</option>
									<option value="CH">Child Health</option>
									<option value="AH">Adolescent Health</option>
								</select>
							</div>

							<!-- Time Period -->
							<div>
								<label for="starttime_period" class="block text-sm font-medium text-gray-700">
									Start *
								</label>
								<input required type="date" id="starttime_period" name="start_date"
									class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
							</div>
							<div>
								<label for="endtime_period" class="block text-sm font-medium text-gray-700">End
									*</label>
								<input type="date" id="endtime_period" name="end_date"
									class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
							</div>
							<!-- Activity Type -->
							<div class="col-span-2 md:col-span-4">
								<label for="activity_type" class="block text-sm font-medium text-gray-700">Activity Type
									(Description) *
								</label>
								<textarea required id="activity_type" name="activity_type" rows="3"
									class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
							</div>

							<!-- County and Sub-county fields removed (not required) -->

							<!-- Contact Person -->
							<div>
								<label for="contact_person" class="block text-sm font-medium text-gray-700">
									Contact Person Name *
								</label>
								<input required type="text" id="contact_person" name="contact_person_name"
									placeholder="Name"
									class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
							</div>
							<div>
								<label for="contact_person" class="block text-sm font-medium text-gray-700">
									Contact Person Role *
								</label>
								<input required type="text" id="contact_person" name="contact_person_role"
									placeholder="Role"
									class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
							</div>
							<div>
								<label for="contact_person" class="block text-sm font-medium text-gray-700">
									Contact Person Email *
								</label>
								<input required type="email" id="contact_person" name="contact_person_mail"
									placeholder="Email"
									class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
							</div>
							<div>
								<label for="budget" class="block text-sm font-medium text-gray-700">
									Budget in KES
								</label>
								<input required type="number" id="budget" name="budget" placeholder="amount"
									class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" />
							</div>

							<!-- Gaps -->
							<div class="col-span-2 lg:col-span-4">
								<label for="gaps" class="block text-sm font-medium text-gray-700">
									Objectives *
								</label>
								<textarea required id="gaps" name="gaps" rows="3"
									class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"></textarea>
							</div>
						</div>

						<!-- Button -->
						<div class="mt-3">
							<button type="submit"
								class="inline-flex justify-center w-full px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
								Submit Project
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<div class="" id="nav-placeholder"></div>

	<h1 class="mb-8 text-4xl font-bold tracking-wide text-center text-blue-700">
		<i class="mr-2 fa-solid fa-building-columns"></i>
		Organization Management
	</h1>

	<div id="org-message" class="mb-6 text-sm font-medium text-center"></div>

	<!-- Create Organization Form -->
	<section
		class="p-6 transition border border-gray-100 shadow-lg bg-white/80 backdrop-blur-md rounded-xl hover:shadow-xl">
		<h2 class="flex items-center mb-4 text-xl font-semibold text-gray-700">
			<i class="mr-2 text-green-600 fa-solid fa-plus-circle"></i> Create
			Organization
		</h2>
		<form id="createOrgForm" class="grid grid-cols-1 gap-4 md:grid-cols-2">
			<input class="input-field" type="text" name="name" placeholder="Organization Name" required />
			<input class="input-field" type="text" name="organizationType" placeholder="Type (e.g. NGO)" required />
			<input class="input-field md:col-span-2" type="text" name="description" placeholder="Description" />
			<input class="input-field" type="email" name="contactEmail" placeholder="Contact Email" required />
			<input class="input-field" type="text" name="contactPhone" placeholder="Contact Phone" />
			<input class="input-field md:col-span-2" type="text" name="address" placeholder="Address" />
			<input class="input-field" type="url" name="websiteUrl" placeholder="Website URL" />
			<input class="input-field" type="text" name="registrationNumber" placeholder="Registration Number" />
			<button type="submit"
				class="col-span-2 px-4 py-2 font-semibold text-white transition bg-blue-600 rounded-lg hover:bg-blue-700">
				<i class="mr-1 fa-solid fa-paper-plane"></i> Create
			</button>
		</form>
	</section>

	<!-- Search Organizations -->
	<section
		class="p-6 transition border border-gray-100 shadow-lg bg-white/80 backdrop-blur-md rounded-xl hover:shadow-xl">
		<h2 class="flex items-center mb-4 text-xl font-semibold text-gray-700">
			<i class="mr-2 fa-solid fa-search"></i> Search Organizations
		</h2>
		<div class="flex gap-2">
			<input class="flex-1 input-field" type="text" id="orgSearchInput" placeholder="Search by name..." />
			<button onclick="searchOrganizations()"
				class="px-4 font-semibold text-white transition bg-gray-700 rounded-lg hover:bg-black">
				Search
			</button>
		</div>
		<ul id="orgSearchResults" class="pl-6 mt-3 text-gray-700 list-disc"></ul>
	</section>

	<!-- List Organizations -->
	<section
		class="p-6 transition border border-gray-100 shadow-lg bg-white/80 backdrop-blur-md rounded-xl hover:shadow-xl">
		<h2 class="flex items-center mb-4 text-xl font-semibold text-gray-700">
			<i class="mr-2 fa-solid fa-list"></i> All Organizations
		</h2>
		<button onclick="loadOrganizations()"
			class="px-4 py-2 mb-2 font-semibold text-white transition bg-purple-600 rounded-lg hover:bg-purple-700">
			Refresh List
		</button>
		<ul id="orgList" class="pl-6 text-gray-700 list-disc"></ul>
	</section>

	<!-- Admin Actions -->
	<section id="adminSection"
		class="hidden p-6 transition border border-gray-100 shadow-lg bg-white/80 backdrop-blur-md rounded-xl hover:shadow-xl">
		<h2 class="flex items-center mb-4 text-xl font-semibold text-gray-700">
			<i class="mr-2 fa-solid fa-shield-halved"></i> Admin: Pending
			Organizations
		</h2>
		<button onclick="loadPendingOrganizations()"
			class="px-4 py-2 mb-2 font-semibold text-white transition bg-red-600 rounded-lg hover:bg-red-700">
			Load Pending
		</button>
		<ul id="pendingOrgList" class="pl-6 mb-4 text-gray-700 list-disc"></ul>

		<h2 class="flex items-center mb-4 text-xl font-semibold text-gray-700">
			<i class="mr-2 fa-solid fa-chart-bar"></i> Admin: Organization Stats
		</h2>
		<button onclick="loadOrgStats()"
			class="px-4 py-2 mb-2 font-semibold text-white transition bg-indigo-600 rounded-lg hover:bg-indigo-700">
			Load Stats
		</button>
		<pre id="orgStats" class="p-3 bg-gray-100 rounded-md"></pre>
	</section>
	<script src="styles/loadNav.js"></script>
	<script>
		const API_BASE =
			window.location.hostname === "localhost" ||
				window.location.hostname === "127.0.0.1"
				? "https://tujulishane-hub-backend-52b7e709d99f.herokuapp.com/api/organizations"
				: "https://tujulishane-hub-backend-52b7e709d99f.herokuapp.com/api/organizations";
		const messageDiv = document.getElementById("org-message");
		const orgList = document.getElementById("orgList");
		const orgSearchResults = document.getElementById("orgSearchResults");
		const pendingOrgList = document.getElementById("pendingOrgList");
		const orgStats = document.getElementById("orgStats");
		const adminSection = document.getElementById("adminSection");

		// Helper: show message
		function showMessage(msg, type = "") {
			messageDiv.textContent = msg;
			messageDiv.className = type;
		}

		// Helper: get auth token
		function getToken() {
			return window.authManager && window.authManager.getToken
				? window.authManager.getToken()
				: localStorage.getItem("accessToken");
		}

		// Helper: is admin
		function isAdmin() {
			const user =
				window.authManager && window.authManager.getCachedUser
					? window.authManager.getCachedUser()
					: null;
			return user && (user.role === "SUPER_ADMIN" || user.role === "ADMIN");
		}

		// Create Organization
		document.getElementById("createOrgForm").onsubmit = async function (e) {
			e.preventDefault();
			const form = e.target;
			const data = Object.fromEntries(new FormData(form));
			try {
				const res = await fetch(API_BASE, {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
						Authorization: `Bearer ${getToken()}`,
					},
					body: JSON.stringify(data),
				});
				let result = null;
				const contentType = res.headers.get("content-type");
				if (contentType && contentType.includes("application/json")) {
					try {
						result = await res.json();
					} catch (jsonErr) {
						showMessage(
							`Invalid JSON response. (${res.status} ${res.statusText})`,
							"error"
						);
						return;
					}
				}
				if (res.status === 201) {
					showMessage("Organization created!", "success");
					form.reset();
					loadOrganizations();
				} else {
					let errorMsg = "Failed to create organization";
					if (result && result.message) {
						errorMsg = result.message;
					} else if (res.status && res.statusText) {
						errorMsg = `Failed to create organization (${res.status} ${res.statusText})`;
					}
					showMessage(errorMsg, "error");
				}
			} catch (err) {
				showMessage(err.message, "error");
			}
		};

		// List Organizations
		async function loadOrganizations(page = 0, size = 10) {
			orgList.innerHTML = "Loading...";
			try {
				const res = await fetch(`${API_BASE}?page=${page}&size=${size}`, {
					headers: { Authorization: `Bearer ${getToken()}` },
				});
				let data = null;
				const contentType = res.headers.get("content-type");
				if (contentType && contentType.includes("application/json")) {
					try {
						data = await res.json();
					} catch (jsonErr) {
						orgList.innerHTML = "Invalid JSON response.";
						return;
					}
				} else {
					orgList.innerHTML = "No JSON response from server.";
					return;
				}
				if (res.ok && data && data.status === 200) {
					orgList.innerHTML = "";
					const orgs =
						data.data && Array.isArray(data.data.organizations)
							? data.data.organizations
							: [];
					orgs.forEach((org) => {
						const li = document.createElement("li");
						li.innerHTML = `<b>${org.name}</b> (${org.organizationType}) - ${org.approvalStatus} <button onclick='viewOrganization(${org.id})'>View</button>`;
						orgList.appendChild(li);
					});
				} else {
					orgList.innerHTML =
						data && data.message
							? data.message
							: "Failed to load organizations.";
				}
			} catch (err) {
				orgList.innerHTML = err.message;
			}
		}

		// View Organization by ID
		async function viewOrganization(id) {
			showMessage("");
			try {
				const res = await fetch(`${API_BASE}/${id}`, {
					headers: { Authorization: `Bearer ${getToken()}` },
				});
				const contentType = res.headers.get("content-type");
				let data = null;
				if (contentType && contentType.includes("application/json")) {
					try {
						data = await res.json();
					} catch (jsonErr) {
						showMessage("Invalid JSON response.", "error");
						return;
					}
				}
				if (res.ok && data && data.status === 200 && data.data) {
					alert(JSON.stringify(data.data, null, 2));
				} else {
					showMessage(
						(data && data.message) || "Failed to load organization",
						"error"
					);
				}
			} catch (err) {
				showMessage(err.message, "error");
			}
		}

		// Search Organizations
		async function searchOrganizations() {
			const keyword = document.getElementById("orgSearchInput").value;
			orgSearchResults.innerHTML = "Searching...";
			try {
				const res = await fetch(
					`${API_BASE}/search?keyword=${encodeURIComponent(keyword)}`,
					{ headers: { Authorization: `Bearer ${getToken()}` } }
				);
				const contentType = res.headers.get("content-type");
				let data = null;
				if (contentType && contentType.includes("application/json")) {
					try {
						data = await res.json();
					} catch (jsonErr) {
						orgSearchResults.innerHTML = "Invalid JSON response.";
						return;
					}
				}
				if (res.ok && data && data.status === 200) {
					orgSearchResults.innerHTML = "";
					const orgs = Array.isArray(data.data) ? data.data : [];
					orgs.forEach((org) => {
						const li = document.createElement("li");
						li.textContent = `${org.name} (${org.organizationType}) - ${org.approvalStatus}`;
						orgSearchResults.appendChild(li);
					});
				} else {
					orgSearchResults.innerHTML = "No results.";
				}
			} catch (err) {
				orgSearchResults.innerHTML = err.message;
			}
		}

		// Update Organization (example: prompt for new name)
		async function updateOrganization(id) {
			const newName = prompt("Enter new organization name:");
			if (!newName) return;
			try {
				const res = await fetch(`${API_BASE}/${id}`, {
					method: "PUT",
					headers: {
						"Content-Type": "application/json",
						Authorization: `Bearer ${getToken()}`,
					},
					body: JSON.stringify({ name: newName }),
				});
				const data = await res.json();
				if (res.ok && data.status === 200) {
					showMessage("Organization updated!", "success");
					loadOrganizations();
				} else {
					showMessage(
						data.message || "Failed to update organization",
						"error"
					);
				}
			} catch (err) {
				showMessage(err.message, "error");
			}
		}

		// Admin: Load Pending Organizations
		async function loadPendingOrganizations() {
			pendingOrgList.innerHTML = "Loading...";
			try {
				const res = await fetch(`${API_BASE}/admin/pending`, {
					headers: { Authorization: `Bearer ${getToken()}` },
				});
				const data = await res.json();
				if (res.ok && data.status === 200) {
					pendingOrgList.innerHTML = "";
					(data.data || []).forEach((org) => {
						const li = document.createElement("li");
						li.innerHTML = `<b>${org.name}</b> (${org.organizationType}) <button class='admin-action' onclick='approveOrganization(${org.id})'>Approve</button> <button class='admin-action' onclick='rejectOrganization(${org.id})'>Reject</button> <button class='admin-action' onclick='deleteOrganization(${org.id})'>Delete</button>`;
						pendingOrgList.appendChild(li);
					});
				} else {
					pendingOrgList.innerHTML = "Failed to load pending organizations.";
				}
			} catch (err) {
				pendingOrgList.innerHTML = err.message;
			}
		}

		// Admin: Approve Organization
		async function approveOrganization(id) {
			try {
				const res = await fetch(`${API_BASE}/admin/approve/${id}`, {
					method: "POST",
					headers: { Authorization: `Bearer ${getToken()}` },
				});
				const data = await res.json();
				if (res.ok && data.status === 200) {
					showMessage("Organization approved!", "success");
					loadPendingOrganizations();
				} else {
					showMessage(
						data.message || "Failed to approve organization",
						"error"
					);
				}
			} catch (err) {
				showMessage(err.message, "error");
			}
		}

		// Admin: Reject Organization
		async function rejectOrganization(id) {
			const reason = prompt("Enter rejection reason:");
			if (!reason) return;
			try {
				const res = await fetch(`${API_BASE}/admin/reject/${id}`, {
					method: "POST",
					headers: {
						"Content-Type": "application/json",
						Authorization: `Bearer ${getToken()}`,
					},
					body: JSON.stringify({ reason }),
				});
				const data = await res.json();
				if (res.ok && data.status === 200) {
					showMessage("Organization rejected!", "success");
					loadPendingOrganizations();
				} else {
					showMessage(
						data.message || "Failed to reject organization",
						"error"
					);
				}
			} catch (err) {
				showMessage(err.message, "error");
			}
		}

		// Admin: Delete Organization
		async function deleteOrganization(id) {
			if (!confirm("Are you sure you want to delete this organization?"))
				return;
			try {
				const res = await fetch(`${API_BASE}/admin/${id}`, {
					method: "DELETE",
					headers: { Authorization: `Bearer ${getToken()}` },
				});
				const data = await res.json();
				if (res.ok && data.status === 200) {
					showMessage("Organization deleted!", "success");
					loadPendingOrganizations();
				} else {
					showMessage(
						data.message || "Failed to delete organization",
						"error"
					);
				}
			} catch (err) {
				showMessage(err.message, "error");
			}
		}

		// Admin: Get Organization Stats
		async function loadOrgStats() {
			orgStats.textContent = "Loading...";
			try {
				const res = await fetch(`${API_BASE}/admin/stats`, {
					headers: { Authorization: `Bearer ${getToken()}` },
				});
				const data = await res.json();
				if (res.ok && data.status === 200) {
					orgStats.textContent = JSON.stringify(data.data, null, 2);
				} else {
					orgStats.textContent = data.message || "Failed to load stats.";
				}
			} catch (err) {
				orgStats.textContent = err.message;
			}
		}

		// Show admin section if user is admin
		window.addEventListener("DOMContentLoaded", () => {
			loadOrganizations();
			if (isAdmin()) {
				adminSection.classList.remove("hidden");
			}
		});
	</script>
</body>

</html>