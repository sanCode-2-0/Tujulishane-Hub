<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RMNCAH</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Tailwind CSS (with custom config using inline script) -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#1e40af", // Custom Blue
            secondary: "#f59e0b", // Custom Amber
            accent: "#10b981", // Custom Green
            dark: "#1f2937", // Gray-800
          },
          fontFamily: {
            sans: ["Inter", "sans-serif"],
          },
        },
      },
    };
  </script>
  <link rel="stylesheet" href="styles/main.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css" />
  <script src="styles/main.js"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
    integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800;900&display=swap"
    rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Mapbox CSS -->
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet" />
  <!-- Mapbox JS -->
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <!-- Authentication utilities -->
  <script type="module">
    import { BASE_URL } from "./config.js";
    window.BASE_URL = BASE_URL;
  </script>
  <script src="auth.js"></script>

  <!-- Optional: Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css" />
  <style>
    .fade-slide-enter {
      opacity: 0;
      transform: translateY(20px);
    }

    .fade-slide-enter-active {
      opacity: 1;
      transform: translateY(0);
      transition: all 0.4s ease;
    }

    .fade-slide-leave {
      opacity: 1;
      transform: translateY(0);
    }

    .fade-slide-leave-active {
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s ease;
    }
  </style>
</head>

<body class="text-gray-800">
  <nav x-data="{ open: false }"
    class="fixed z-50 border shadow-sm bg-white/70 top-4 left-4 right-4 backdrop-blur-md border-white/10 rounded-xl">
    <div class="flex items-center justify-between px-6 py-4">
      <!-- Logo -->
      <a href="/frontend/index.html"
        class="flex items-center justify-center space-x-2 text-2xl font-bold text-black uppercase">
        <img src="resources/images/log2.png" class="object-contain h-12" alt="Site Logo" />
        <img src="resources/images/moh.png" class="object-contain h-12" alt="Site Logo" />
      </a>

      <!-- Mobile Menu Toggle -->
      <button @click="open = !open" class="text-xl lg:hidden focus:outline-none">
        <i class="fas fa-bars" x-show="!open"></i>
        <i class="fas fa-times" x-show="open" x-cloak></i>
      </button>

      <!-- Nav Links - Desktop -->
      <ul class="items-center hidden space-x-8 text-sm font-medium text-gray-700 lg:flex">
        <li>
          <a href="/frontend/index.html" class="uppercase transition hover:text-blue-600">Home</a>
        </li>
        <li>
          <a href="all-projects.html" class="uppercase transition hover:text-blue-600">All Projects</a>
        </li>
        <li id="myProjectsNav" class="hidden">
          <a href="#my-projects" onclick="showMyProjects()" class="uppercase transition hover:text-blue-600">My
            Projects</a>
        </li>

        <!-- SUPER_ADMIN Nav -->
        <li id="adminNav" class="hidden relative" x-data="{ showDropdown: false }">
          <button @click="showDropdown = !showDropdown"
            class="inline-flex items-center font-medium uppercase transition focus:outline-none">
            Admin <i class="ml-2 fal fa-chevron-down"></i>
          </button>
          <div x-show="showDropdown" @click.outside="showDropdown = false" x-transition
            class="absolute z-50 w-56 mt-2 bg-white divide-y divide-gray-100 shadow-md rounded-xl"
            style="display: none">
            <ul class="py-2 text-sm text-left text-blue-800">
              <li class="px-4 py-2 transition hover:bg-blue-100">
                <a href="dashboard.html">Dashboard</a>
              </li>
              <li class="px-4 py-2 transition hover:bg-blue-100">
                <a href="Forms/Admin/new-project.html">New Project</a>
              </li>
              <li class="px-4 py-2 transition hover:bg-blue-100">
                <a href="Forms/Admin/requests/projects.html">Project Requests</a>
              </li>
              <li class="px-4 py-2 transition hover:bg-blue-100">
                <a href="Forms/Admin/requests/stakeholders.html">Stakeholder Requests</a>
              </li>
            </ul>
          </div>
        </li>

        <!-- PARTNER Nav -->
        <li id="partnerNav" class="hidden relative" x-data="{ showDropdown: false }">
          <button @click="showDropdown = !showDropdown"
            class="inline-flex items-center font-medium uppercase transition focus:outline-none">
            Stakeholder <i class="ml-2 fal fa-chevron-down"></i>
          </button>
          <div x-show="showDropdown" @click.outside="showDropdown = false" x-transition
            class="absolute z-50 w-56 mt-2 bg-white divide-y divide-gray-100 shadow-md rounded-xl"
            style="display: none">
            <ul class="py-2 text-sm text-left text-blue-800">
              <li class="px-4 py-2 transition hover:bg-blue-100">
                <a href="/frontend/Stakeholders/access.html">Login / Registration</a>
              </li>
              <li class="px-4 py-2 transition hover:bg-blue-100">
                <a href="Stakeholders/dashboard.html">Dashboard</a>
              </li>
            </ul>
          </div>
        </li>

        <!-- Collaboration Dropdown -->
        <li class="relative" x-data="{ showDropdown: false }">
          <button @click="showDropdown = !showDropdown"
            class="inline-flex items-center font-medium uppercase transition focus:outline-none hover:text-blue-600">
            Collaboration <i class="ml-2 fal fa-chevron-down"></i>
          </button>
          <div x-show="showDropdown" @click.outside="showDropdown = false" x-transition
            class="absolute z-50 w-56 mt-2 bg-white divide-y divide-gray-100 shadow-lg rounded-xl"
            style="display: none">
            <ul class="py-2 text-sm text-left text-gray-700">
              <li class="px-4 py-2 transition hover:bg-blue-50">
                <a href="announcements.html" class="flex items-center">
                  <i class="fas fa-bullhorn mr-2 text-blue-600"></i>Announcements
                </a>
              </li>
              <li class="px-4 py-2 transition hover:bg-blue-50">
                <a href="my-collaborations.html" class="flex items-center">
                  <i class="fas fa-users mr-2 text-green-600"></i>My
                  Collaborations
                </a>
              </li>
              <li id="admin-collab-requests" class="px-4 py-2 transition hover:bg-purple-50" style="display: none">
                <a href="Forms/Admin/collaboration-requests.html" class="flex items-center">
                  <i class="fas fa-handshake mr-2 text-purple-600"></i>Manage
                  Requests
                  <span id="pending-badge" class="ml-auto bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs"
                    style="display: none"></span>
                </a>
              </li>
            </ul>
          </div>
        </li>

        <!-- User Profile Dropdown -->
        <li class="relative" x-data="{ showUserDropdown: false }">
          <button @click="showUserDropdown = !showUserDropdown"
            class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 transition rounded-lg hover:bg-gray-100 focus:outline-none">
            <i class="mr-2 fas fa-user-circle"></i>
            <span id="userDisplayName">User</span>
            <i class="ml-2 fal fa-chevron-down"></i>
          </button>
          <div x-show="showUserDropdown" @click.outside="showUserDropdown = false" x-transition
            class="absolute right-0 z-50 w-64 mt-2 bg-white divide-y divide-gray-100 shadow-lg rounded-xl"
            style="display: none">
            <div class="px-4 py-3">
              <div class="text-sm font-medium text-gray-900" id="userNameDisplay">
                Loading...
              </div>
              <div class="text-sm text-gray-500" id="userEmailDisplay"></div>
              <div class="text-xs text-gray-400 mt-1">
                Role: <span id="userRoleDisplay"></span> | Status:
                <span id="userStatusDisplay"></span>
              </div>
            </div>
            <ul class="py-2 text-sm text-gray-700">
              <li>
                <a href="/frontend/profile.html" class="block px-4 py-2 transition hover:bg-gray-100"><i
                    class="mr-2 fas fa-user"></i>Profile</a>
              </li>
              <li>
                <a href="/frontend/settings.html" class="block px-4 py-2 transition hover:bg-gray-100"><i
                    class="mr-2 fas fa-cog"></i>Settings</a>
              </li>
            </ul>
            <div class="py-2">
              <button onclick="authManager.logout()"
                class="block w-full px-4 py-2 text-left text-sm text-red-600 transition hover:bg-red-50">
                <i class="mr-2 fas fa-sign-out-alt"></i>Logout
              </button>
            </div>
          </div>
        </li>
      </ul>
    </div>

    <!-- Nav Links - Mobile -->
    <div x-show="open" x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 transform -translate-y-2"
      x-transition:enter-end="opacity-100 transform translate-y-0" x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100 transform translate-y-0"
      x-transition:leave-end="opacity-0 transform -translate-y-2" class="px-6 pb-6 lg:hidden">
      <ul class="flex flex-col space-y-4 font-semibold text-gray-700">
        <li>
          <a href="/" class="block transition hover:text-blue-600">Home</a>
        </li>
        <li>
          <a href="#about" class="block transition hover:text-blue-600">About</a>
        </li>
        <li>
          <a href="#why-us" class="block transition hover:text-blue-600">Why Us</a>
        </li>
        <li>
          <a href="#contact-us" class="block transition hover:text-blue-600">Contact Us</a>
        </li>
        <!-- Collaboration Links -->
        <li>
          <a href="announcements.html" class="block transition hover:text-blue-600">
            <i class="fas fa-bullhorn mr-2"></i>Announcements
          </a>
        </li>
        <li>
          <a href="my-collaborations.html" class="block transition hover:text-blue-600">
            <i class="fas fa-users mr-2"></i>My Collaborations
          </a>
        </li>
        <li id="admin-collab-mobile" class="block transition hover:text-blue-600" style="display: none">
          <a href="Forms/Admin/collaboration-requests.html">
            <i class="fas fa-handshake mr-2"></i>Manage Requests
          </a>
        </li>
      </ul>

      <!-- CTA Button -->
      <div class="mt-6">
        <a href="/contact"
          class="relative inline-block w-full px-4 py-2 overflow-hidden font-semibold text-center text-white bg-pink-600 rounded-full group">
          <span
            class="absolute inset-0 w-full h-full transition-transform duration-300 ease-out origin-left transform scale-x-0 bg-blue-700 group-hover:scale-x-100"></span>
          <span class="relative z-10 group-hover:text-white">Collaborate</span>
        </a>
      </div>
    </div>
  </nav>

  <section class="pt-16 mt-20 bg-cyan-800 sm:pt-20">
    <div class="grid max-w-6xl px-4 py-8 mx-auto text-white sm:px-6 lg:px-8 md:grid-cols-5">
      <div class="md:col-span-4">
        <h1 class="mb-2 text-4xl font-semibold md:text-4xl">
          <span class="tracking-wide"> RMNCAH </span>
          Hub
        </h1>
        <p class="text-[16px] mb-6 max-w-2xl">
          Discover and engage with impactful projects driving change across
          Kenya. Use the filters to find projects that align with your
          interests and make a difference.
        </p>
        <div class="flex gap-12 text-3xl">
          <div class="">
            <span id="totalProjectsCount" class="font-bold tracking-wider">
              0
            </span>
            <span class="font-thin"> Projects </span>
          </div>
          <div class="">
            <span id="totalCountiesCount" class="font-bold tracking-wider">
              0
            </span>
            <span class="font-thin"> Counties </span>
          </div>
          <div class="">
            <span id="totalStakeholdersCount" class="font-bold tracking-wider">
              0
            </span>
            <span class="font-thin"> Stakeholders </span>
          </div>
        </div>
      </div>
      <div class="md:col-span-1">
        <h6 class="mt-4 mb-1 mb-2 text-sm font-semibold leading-tight text-center uppercase">
          Want to submit a data source to us?
        </h6>
        <div class="grid gap-4 text-white">
          <a href="" class="flex items-center justify-between px-4 py-2 rounded-full bg-cyan-600">
            <span class="text-sm"> Learn More </span>
            <span class="text-lg">
              <i class="fas fa-arrow-right"></i>
            </span>
          </a>
          <a href="/frontend/Stakeholders/dashboard.html" aria-label="Go to Dashboard" title="Go to Dashboard"
            class="flex items-center gap-3 px-4 py-2 rounded-full bg-blue-700 text-white shadow-sm hover:bg-blue-800 transition transform hover:-translate-y-0.5">
            <span class="inline-flex items-center justify-center w-8 h-8 bg-white/20 rounded-full">
              <i class="fas fa-folder-open"></i>
            </span>
            <span class="text-sm font-medium">Go to Dashboard</span>
          </a>
        </div>
      </div>
    </div>
  </section>

  <section class="bg-cyan-50/50">
    <!-- <svg xmlns="http://www.w3.org/2000/svg" class="rotate-180" viewBox="0 0 1000 100">
            <g fill="#155E75">
                <path
                    d="M0 0v99.7C62 69 122.4 48.7 205 66c83.8 17.6 160.5 20.4 240-12 54-22 110-26 173-10a392.2 392.2 0 0 0 222-5c55-17 110.3-36.9 160-27.2V0H0Z"
                    opacity=".5"></path>
                <path
                    d="M0 0v74.7C62 44 122.4 28.7 205 46c83.8 17.6 160.5 25.4 240-7 54-22 110-21 173-5 76.5 19.4 146.5 23.3 222 0 55-17 110.3-31.9 160-22.2V0H0Z">
                </path>
            </g>
        </svg> -->
    <div class="grid items-center max-w-6xl px-4 py-8 mx-auto sm:px-6 lg:px-8 md:grid-cols-5">
      <div class="md:col-span-4">
        <h3 class="mb-4 text-sm font-semibold leading-tight text-gray-900 uppercase">
          Explore Projects Across Kenya
        </h3>
        <h1 class="mb-2 text-4xl font-semibold md:text-4xl">
          Empowering Change Through Collaboration
        </h1>
        <h6 class="mt-4 mb-1 text-sm font-semibold leading-tight text-gray-900 uppercase opacity-70">
          Explore Projects Across Kenya
        </h6>
        <p class="text-[16px] text-gray-700 mb-6">
          Discover and engage with impactful projects driving change across
          Kenya. Use the filters to find projects that align with your
          interests and make a difference.
        </p>
      </div>
      <div class="md:col-span-1">
        <h6 class="mt-4 mb-1 mb-2 text-sm font-semibold leading-tight text-center text-gray-900 uppercase opacity-70">
          Data Hub Resources
        </h6>
        <div class="grid gap-4 text-white">
          <a href="" class="flex items-center justify-between px-4 py-2 rounded-full bg-cyan-600">
            <span class="text-sm"> FAQ Docuent </span>
            <span class="text-lg">
              <i class="fas fa-file-pdf"></i>
            </span>
          </a>
          <!-- <a href="" class="flex items-center justify-between px-4 py-2 rounded-full bg-cyan-600">
                        <span class="text-sm">
                            Methods Brief
                        </span>
                        <span class="text-lg">
                            <i class="fas fa-clipboard-list-check"></i>
                        </span>
                    </a> -->
          <a href="" class="flex items-center justify-between px-4 py-2 rounded-full bg-cyan-600">
            <span class="text-sm"> Video Tutorial </span>
            <span class="text-lg">
              <i class="fas fa-play-circle"></i>
            </span>
          </a>
        </div>
      </div>
    </div>

    <!-- <svg xmlns="http://www.w3.org/2000/svg" class="-rotate-180" viewBox="0 0 1000 100">
            <g fill="#ffff">
                <path
                    d="M0 0v99.7C62 69 122.4 48.7 205 66c83.8 17.6 160.5 20.4 240-12 54-22 110-26 173-10a392.2 392.2 0 0 0 222-5c55-17 110.3-36.9 160-27.2V0H0Z"
                    opacity=".5"></path>
                <path
                    d="M0 0v74.7C62 44 122.4 28.7 205 46c83.8 17.6 160.5 25.4 240-7 54-22 110-21 173-5 76.5 19.4 146.5 23.3 222 0 55-17 110.3-31.9 160-22.2V0H0Z">
                </path>
            </g>
        </svg> -->
    <div id="localMap" class="h-[450px] sm:h-[550px] z-0 w-full"></div>
  </section>
  <section class="bg-white">
    <div class="px-4 py-12 mx-auto max-w-7xl sm:px-6 lg:px-8">
      <!-- Status Filter Buttons -->
      <div class="grid grid-cols-1 gap-8 md:grid-cols-5 lg:grid-cols-7">
        <!-- Main Content Area -->
        <div class="flex flex-col md:col-span-3 fade fade-left lg:col-span-5">
          <!-- Project Info -->
          <div id="projectInfo" class="flex-grow hidden p-6 mb-4 bg-white border border-gray-200 shadow-lg rounded-xl">
            <h3 class="mb-4 text-xl font-semibold text-gray-800">
              Selected Project Details
            </h3>
            <p class="text-gray-700">
              Details of the selected project will appear here.
            </p>
          </div>

          <!-- Accordion -->
          <div id="projectAccordion"
            class="hidden w-full space-y-4 transition-opacity duration-500 ease-in-out transform translate-y-4 opacity-0">
            <h3 class="mb-4 text-xl font-semibold text-gray-800">
              All Projects
            </h3>
            <div class="p-6 bg-white border border-gray-200 shadow-lg rounded-xl">
              <!-- Projects will be loaded dynamically here -->
              <div id="projects-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Loading state -->
                <div class="col-span-full text-center py-8">
                  <i class="fas fa-spinner fa-spin text-gray-400 text-4xl mb-4"></i>
                  <p class="text-gray-600">Loading projects...</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sticky Filter Sidebar (Right Side) -->
        <div class="sticky p-6 bg-white rounded-lg shadow-md md:col-span-2 lg:col-span-2 fade fade-right h-fit top-6">
          <h2 class="mb-2 -mt-10 text-sm font-semibold text-right text-gray-800 transform rounded-xl">
            <i class="p-2 text-black bg-white rounded-sm shadow fas fa-filter"></i>
          </h2>

          <div class="flex flex-col gap-5">
            <!-- Search -->
            <div class="relative w-full">
              <label for="searchInput" class="sr-only">Search by name...</label>
              <input type="text" id="searchInput" placeholder="Search by name..."
                class="block w-full py-2 pl-10 pr-4 text-base text-gray-900 placeholder-gray-500 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
              <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <i class="text-gray-400 fas fa-search"></i>
              </div>
            </div>
            <div class="grid gap-2 lg:grid-cols-2">
              <!-- From Date -->
              <div class="flex flex-col gap-2">
                <label for="dateFrom" class="text-sm font-medium text-gray-700">From Date:</label>
                <input type="date" id="dateFrom"
                  class="w-full px-3 py-2 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
              </div>

              <!-- To Date -->
              <div class="flex flex-col gap-2">
                <label for="dateTo" class="text-sm font-medium text-gray-700">To Date:</label>
                <input type="date" id="dateTo"
                  class="w-full px-3 py-2 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
              </div>
            </div>

            <!-- Sort By -->
            <div class="flex flex-col gap-2">
              <label for="sortSelect" class="text-sm font-medium text-gray-700">Sort By:</label>
              <select id="sortSelect"
                class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="name">Name (A-Z)</option>
                <option value="date">Date (Newest First)</option>
              </select>
            </div>

            <!-- Sort By Theme -->
            <div class="flex flex-col gap-2">
              <label for="sortSelect" class="text-sm font-medium text-gray-700">Themes:</label>
              <select id="sortSelect"
                class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="name">Name (A-Z)</option>
                <option value="date">Date (Newest First)</option>
              </select>
            </div>

            <!-- Sort By Theme -->
            <div class="flex flex-col gap-2">
              <label for="status" class="text-sm font-medium text-gray-700">Status:</label>
              <select autocomplete="off" id="status"
                class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                onchange="highlightMarkers(this.value)">
                <option value="all">Show All</option>
                <option value="active">Active</option>
                <option value="pending">Pending</option>
                <option value="stalled">Stalled</option>
                <option value="completed">Completed</option>
              </select>
            </div>

            <!-- Export Button -->
            <button onclick="exportCSV()"
              class="flex items-center justify-center px-5 py-2 mt-6 text-base font-semibold text-white transition duration-200 bg-indigo-600 rounded-lg shadow hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
              <i class="mr-2 fas fa-file-csv"></i> Export Data
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="flex items-center justify-center px-4 my-4">
      <div id="paginationControls" class="space-x-2"></div>
    </div>

    <div class="max-w-6xl px-4 mx-auto mt-12 sm:px-6 lg:px-8">
      <h2 class="mb-10 text-xl font-light leading-tight text-center text-gray-900 uppercase opacity-70">
        Impact
      </h2>
      <div class="flex flex-wrap justify-center gap-6 mb-8" x-data="countdownStats()" x-init="start()">
        <div
          class="flex flex-col items-center justify-center p-6 text-center transition-all duration-300 ease-in-out transform bg-white rounded-2xl fade fade-up hover:scale-105">
          <div class="text-5xl font-light font-extrabold text-blue-700" x-text="locations"></div>
          <p class="mt-3 text-base font-thin font-medium text-gray-600">
            Locations
          </p>
        </div>

        <div
          class="flex flex-col items-center justify-center p-6 text-center transition-all duration-300 ease-in-out transform bg-white rounded-2xl fade fade-up hover:scale-105">
          <div class="text-5xl font-light font-extrabold text-pink-600" x-text="projects"></div>
          <p class="mt-3 text-base font-thin font-medium text-gray-600">
            Projects
          </p>
        </div>

        <div
          class="flex flex-col items-center justify-center p-6 text-center transition-all duration-300 ease-in-out transform bg-white rounded-2xl fade fade-up hover:scale-105">
          <div class="text-5xl font-light font-extrabold text-green-600" x-text="regions"></div>
          <p class="mt-3 text-base font-thin font-medium text-gray-600">
            Regions
          </p>
        </div>

        <div
          class="flex flex-col items-center justify-center p-6 text-center transition-all duration-300 ease-in-out transform bg-white rounded-2xl fade fade-up hover:scale-105">
          <div class="text-5xl font-light font-extrabold text-purple-600" x-text="users"></div>
          <p class="mt-3 text-base font-thin font-medium text-gray-600">
            Teams
          </p>
        </div>

        <div
          class="flex flex-col items-center justify-center p-6 text-center transition-all duration-300 ease-in-out transform bg-white rounded-2xl fade fade-up hover:scale-105">
          <div class="text-5xl font-light font-extrabold text-yellow-600" x-text="amountDisplay"></div>
          <p class="mt-3 text-base font-thin font-medium text-gray-600">
            Raised (KES)
          </p>
        </div>
      </div>
    </div>
  </section>
  <!--Footer container-->
  <footer class="flex flex-col items-center text-center bg-white text-surface">
    <div class="">
      <!-- Social media icons container -->
      <div class="flex items-center justify-center mb-6 space-x-2">
        <a href="#!" type="button"
          class="p-3 font-medium leading-normal uppercase transition duration-150 ease-in-out bg-transparent rounded-full text-surface hover:bg-neutral-100 focus:outline-none focus:ring-0"
          data-twe-ripple-init>
          <span class="mx-auto [&>svg]:h-4 [&>svg]:w-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 512 512">
              <!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc. -->
              <path
                d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z" />
            </svg>
          </span>
        </a>

        <a href="#!" type="button"
          class="p-3 font-medium leading-normal uppercase transition duration-150 ease-in-out bg-transparent rounded-full text-surface hover:bg-neutral-100 focus:outline-none focus:ring-0"
          data-twe-ripple-init>
          <i class="fab fa-facebook-f"></i>
        </a>

        <a href="#!" type="button"
          class="p-3 font-medium leading-normal uppercase transition duration-150 ease-in-out bg-transparent rounded-full text-surface hover:bg-neutral-100 focus:outline-none focus:ring-0"
          data-twe-ripple-init>
          <span class="mx-auto [&>svg]:h-4 [&>svg]:w-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 448 512">
              <!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc. -->
              <path
                d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z" />
            </svg>
          </span>
        </a>

        <a href="#!" type="button"
          class="p-3 font-medium leading-normal uppercase transition duration-150 ease-in-out bg-transparent rounded-full text-surface hover:bg-neutral-100 focus:outline-none focus:ring-0"
          data-twe-ripple-init>
          <span class="mx-auto [&>svg]:h-4 [&>svg]:w-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 448 512">
              <!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc. -->
              <path
                d="M100.3 448H7.4V148.9h92.9zM53.8 108.1C24.1 108.1 0 83.5 0 53.8a53.8 53.8 0 0 1 107.6 0c0 29.7-24.1 54.3-53.8 54.3zM447.9 448h-92.7V302.4c0-34.7-.7-79.2-48.3-79.2-48.3 0-55.7 37.7-55.7 76.7V448h-92.8V148.9h89.1v40.8h1.3c12.4-23.5 42.7-48.3 87.9-48.3 94 0 111.3 61.9 111.3 142.3V448z" />
            </svg>
          </span>
        </a>
      </div>
    </div>

    <!--Copyright section-->
    <div class="w-full p-4 text-xs text-center bg-black/5">
      Â© 2025 Copyright:
      <a href=""> RMNCAH Hub </a>
    </div>
  </footer>
  <!-- Removed script that sets localStorage with undefined 'data' to fix ReferenceError. This should only be set after login. -->
  <script src="styles/effects.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tw-elements/js/tw-elements.umd.min.js"></script>
  <script>
    let map;
    let projects = [];
    let filteredProjects = [];
    let sortBy = "name";
    let sortOrder = "asc";
    let currentPage = 1;
    const itemsPerPage = 5;
    let currentFilter = "all";
    let searchQuery = "";
    let dateRangeFrom = null;
    let dateRangeTo = null;

    const mapMarkers = [];
    let stores = {
      type: "FeatureCollection",
      features: [],
    };

    const bgColors = {
      active: "bg-green-50",
      pending: "bg-yellow-50",
      stalled: "bg-red-50",
      completed: "bg-cyan-100",
      default: "bg-white",
    };

    const statusBadge = (tag) => {
      return (
        {
          active: "bg-green-200 text-green-800",
          pending: "bg-yellow-200 text-yellow-800",
          stalled: "bg-red-200 text-red-800",
          completed: "bg-cyan-300 text-gray-800",
        }[tag] || "bg-gray-200 text-gray-800"
      );
    };

    document.addEventListener("DOMContentLoaded", function () {
      // Initialize authentication and load user data
      initializeUserSession();

      // Set Mapbox access token
      mapboxgl.accessToken =
        "pk.eyJ1IjoibG9tb2dhbnRlY2giLCJhIjoiY2xzOTcyYXdlMDUxZDJsbXRnZGh2ZmpoYyJ9.sIWvONzgGPF2rtAcECsrJQ";

      // Initialize Mapbox map
      map = new mapboxgl.Map({
        container: "localMap",
        style: "mapbox://styles/lomogantech/clsa1f16r00wt01qqbnf741n6",
        center: [37.9062, -0.0236],
        zoom: 6.3,
      });

      // Add zoom and rotation controls to the map
      map.addControl(new mapboxgl.NavigationControl(), "top-right");

      // Load projects after map is initialized
      map.on("load", () => {
        loadProjectsForMap();
      });

      document
        .getElementById("searchInput")
        .addEventListener("input", (e) => {
          searchQuery = e.target.value.trim().toLowerCase();
          currentPage = 1;
          highlightMarkers(currentFilter);
        });

      document.getElementById("dateFrom").addEventListener("change", (e) => {
        dateRangeFrom = e.target.value ? new Date(e.target.value) : null;
        currentPage = 1;
        highlightMarkers(currentFilter);
      });

      document.getElementById("dateTo").addEventListener("change", (e) => {
        dateRangeTo = e.target.value ? new Date(e.target.value) : null;
        currentPage = 1;
        highlightMarkers(currentFilter);
      });

      document
        .getElementById("sortSelect")
        .addEventListener("change", (e) => {
          sortProjects(e.target.value);
        });
    });

    // Load projects and add to map
    async function loadProjectsForMap() {
      try {
        const response = await fetch(
          `${window.BASE_URL}/api/projects/with-coordinates`,
          {
            headers: {
              Authorization: `Bearer ${authManager.getToken()}`,
            },
          }
        );

        if (response.ok) {
          const data = await response.json();
          console.log("Raw API response (with-coordinates):", data);
          // Handle API response structure: { status: 200, data: [...], message: "..." }
          let projectsData = [];
          if (data.status === 200 && data.data) {
            projectsData = Array.isArray(data.data) ? data.data : [];
          } else if (Array.isArray(data)) {
            projectsData = data;
          }

          console.log("Loaded projects for map:", projectsData.length);
          console.log("Projects data (with coordinates):", projectsData);

          // Log each project's coordinates
          projectsData.forEach((project, idx) => {
            console.log(`Map Project ${idx + 1}:`, {
              name: project.projectName || project.name,
              latitude: project.latitude,
              longitude: project.longitude,
              hasCoordinates: !!(project.latitude && project.longitude),
            });
          });

          // ONLY add markers to map - don't overwrite the main projects array
          // The main projects array is managed by loadProjects() which includes ALL projects
          addMarkersToMap(projectsData);
        } else {
          console.warn("API response not OK, loading sample projects");
          loadSampleProjects();
        }
      } catch (error) {
        console.error("Error loading projects for map:", error);
        // Use sample data for demo
        loadSampleProjects();
      }
    }

    // Load sample projects for demo
    function loadSampleProjects() {
      const sampleProjects = [
        {
          id: 1,
          projectName: "Project 1",
          latitude: -1.2921,
          longitude: 36.8219,
          status: "ACTIVE",
        },
        {
          id: 2,
          projectName: "Project 2",
          latitude: -0.1023,
          longitude: 34.7619,
          status: "PENDING",
        },
        {
          id: 3,
          projectName: "Project 3",
          latitude: 0.3256,
          longitude: 37.1231,
          status: "STALLED",
        },
        {
          id: 4,
          projectName: "Project 4",
          latitude: -1.1504,
          longitude: 36.8907,
          status: "COMPLETED",
        },
      ];
      projects = sampleProjects;
      updateMapWithProjects(sampleProjects);
      highlightMarkers("all");
    }

    // Add markers to Mapbox map
    function addMarkersToMap(projectsData) {
      // Clear existing markers
      mapMarkers.forEach((marker) => marker.remove());
      mapMarkers.length = 0;

      // Add new markers
      projectsData.forEach((project) => {
        if (project.latitude && project.longitude) {
          // Create marker element
          const el = document.createElement("div");
          el.className = "marker";
          el.style.backgroundColor = getStatusColor(project.status);
          el.style.width = "30px";
          el.style.height = "30px";
          el.style.borderRadius = "50%";
          el.style.border = "2px solid white";
          el.style.cursor = "pointer";
          el.style.boxShadow = "0 2px 4px rgba(0,0,0,0.3)";

          // Create popup
          const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(`
                <div style="padding: 10px; min-width: 200px;">
                  <h3 style="font-weight: bold; margin-bottom: 8px;">${project.projectName || "Project"
            }</h3>
                  <p style="margin: 4px 0;"><strong>Status:</strong> <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded ${statusBadge(
              project.status?.toLowerCase()
            )}">${project.status || "N/A"}</span></p>
                  <p style="margin: 4px 0;"><strong>Region:</strong> ${project.region || "N/A"
            }</p>
                  <p style="margin: 4px 0;"><strong>Budget:</strong> ${project.budget || "N/A"
            }</p>
                  <button onclick="viewProject(${project.id
            })" style="margin-top: 8px; padding: 6px 12px; background-color: #0ea5e9; color: white; border-radius: 6px; cursor: pointer; border: none;">View Details</button>
                </div>
              `);

          // Create and add marker
          const marker = new mapboxgl.Marker(el)
            .setLngLat([project.longitude, project.latitude])
            .setPopup(popup)
            .addTo(map);

          // Add click event
          el.addEventListener("click", async () => {
            map.flyTo({
              center: [project.longitude, project.latitude],
              zoom: 12,
            });

            // If county is missing, try to get it from coordinates
            if (!project.county && !project.region) {
              const countyName = await getCountyFromCoordinates(
                project.longitude,
                project.latitude
              );
              if (countyName) {
                project.county = countyName;
                // Update the accordion item for this project
                const projectIndex = projects.indexOf(project);
                if (projectIndex !== -1) {
                  updateProjectAccordionItem(projectIndex);
                }
              }
            }
          });

          mapMarkers.push(marker);
        }
      });
    }

    // Get county name from coordinates using Mapbox Geocoding API
    async function getCountyFromCoordinates(longitude, latitude) {
      try {
        const response = await fetch(
          `https://api.mapbox.com/geocoding/v5/mapbox.places/${longitude},${latitude}.json?types=region&access_token=${mapboxgl.accessToken}`
        );
        const data = await response.json();
        if (data.features && data.features.length > 0) {
          return data.features[0].text;
        }
      } catch (error) {
        console.error("Error getting county from coordinates:", error);
      }
      return null;
    }

    // Update a specific project accordion item
    function updateProjectAccordionItem(index) {
      const project = projects[index];
      const collapseDiv = document.getElementById(`collapse-${index}`);
      if (collapseDiv) {
        const statusBg = statusBadge(project.status?.toLowerCase());
        collapseDiv.innerHTML = `
            <p><strong>County:</strong> ${project.county || project.region || ""
          }</p>
            <p><strong>Budget:</strong> ${project.budget || ""}</p>
            <p><strong>Partner:</strong> ${project.partner || ""}</p>
            <p><strong>Status:</strong> 
                <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBg}">
                    ${project.status || ""}
                </span>
            </p>
            <button onclick="focusMarker(${index})" class="px-5 py-2 mt-3 text-sm font-semibold text-white transition bg-blue-600 rounded hover:bg-blue-700 hover:scale-105">
                Show on Map
            </button>
          `;
      }
    }

    // Get status color
    function getStatusColor(status) {
      const colors = {
        ACTIVE: "#22c55e",
        PENDING: "#eab308",
        STALLED: "#ef4444",
        COMPLETED: "#06b6d4",
      };
      return colors[status] || "#6b7280";
    }

    // Comes From DB
    function showProjectInfo(project) {
      const infoBox = document.getElementById("projectInfo");
      infoBox.classList.remove("hidden");
      infoBox.innerHTML = `
            <div class="flex flex-wrap">
                <h3 class="mb-4 text-xl font-bold text-gray-800">${project.name
        }</h3>
                <p><strong>Description:</strong> ${project.description}</p>
                <p><strong>Region:</strong> ${project.region}</p>
                <p><strong>Budget:</strong> ${project.budget}</p>
                <p><strong>Team:</strong> ${project.team}</p>
                <p><strong>Participants:</strong> ${project.participants}</p>
                <p><strong>Sponsor:</strong> ${project.sponsor}</p>
                <p><strong>Start Date:</strong> ${new Date(
          project.start_date
        ).toLocaleDateString()}</p>
                <p><strong>Status:</strong> <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge(
          project.status
        )}">${project.status}</span></p>
            </div>
        `;
    }

    function focusMarker(index) {
      if (mapMarkers[index] && projects[index]) {
        const project = projects[index];
        map.flyTo({
          center: [project.longitude, project.latitude],
          zoom: 12,
        });
        mapMarkers[index].togglePopup();
        document
          .getElementById("localMap")
          .scrollIntoView({ behavior: "smooth" });
      }
    }

    function sortProjects(field) {
      if (sortBy === field) {
        sortOrder = sortOrder === "asc" ? "desc" : "asc";
      } else {
        sortBy = field;
        sortOrder = "asc";
      }
      currentPage = 1;
      highlightMarkers(currentFilter);
    }

    function highlightMarkers(tag) {
      currentFilter = tag;
      console.log("highlightMarkers called with tag:", tag);
      console.log("Total projects available:", projects.length);
      console.log("Projects:", projects);

      const accordion = document.getElementById("projectAccordion");
      const infoBox = document.getElementById("projectInfo");
      infoBox.classList.add("hidden");
      accordion.innerHTML = "";
      accordion.classList.remove("hidden");
      accordion.classList.add("opacity-0", "translate-y-4");

      let filteredProjects = projects.filter((project) => {
        if (tag !== "all" && project.status?.toLowerCase() !== tag)
          return false;
        if (
          searchQuery &&
          !project.projectName
            ?.toLowerCase()
            .includes(searchQuery.toLowerCase())
        )
          return false;
        if (
          dateRangeFrom &&
          new Date(project.startDate) < new Date(dateRangeFrom)
        )
          return false;
        if (
          dateRangeTo &&
          new Date(project.startDate) > new Date(dateRangeTo)
        )
          return false;
        return true;
      });

      console.log("Filtered projects count:", filteredProjects.length);
      console.log("Filtered projects:", filteredProjects);

      filteredProjects.sort((a, b) => {
        const aVal =
          sortBy === "name" ? a.projectName : new Date(a.startDate);
        const bVal =
          sortBy === "name" ? b.projectName : new Date(b.startDate);
        return sortOrder === "asc"
          ? aVal > bVal
            ? 1
            : -1
          : aVal < bVal
            ? 1
            : -1;
      });

      const totalPages = Math.ceil(filteredProjects.length / itemsPerPage);
      const paginated = filteredProjects.slice(
        (currentPage - 1) * itemsPerPage,
        currentPage * itemsPerPage
      );
      console.log("Paginated projects for display:", paginated);
      updatePaginationControls(totalPages);

      // Update marker visibility
      mapMarkers.forEach((marker, idx) => {
        const project = projects[idx];
        const isVisible = filteredProjects.includes(project);
        if (marker.getElement()) {
          marker.getElement().style.opacity = isVisible ? "1" : "0.2";
        }
      });

      setTimeout(
        () => accordion.classList.remove("opacity-0", "translate-y-4"),
        10
      );

      paginated.forEach((project, idx) => {
        const i = projects.indexOf(project);
        const bg =
          bgColors[project.status?.toLowerCase()] || bgColors.default;

        const item = document.createElement("div");
        item.className = `rounded shadow-sm ${bg}`;

        item.innerHTML = `
            <button class="w-full px-6 py-4 text-left border-b focus:outline-none" data-toggle="collapse-${i}">
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800">${project.title || project.projectName || ""
          }</h4>
                        <p id="desc-${i}" class="mt-2 text-sm text-gray-600">${(
            project.objectives ||
            project.description ||
            ""
          ).substring(0, 150)}...</p>
                    </div>
                    <div class="flex items-center mt-2 text-sm font-semibold tracking-wider text-gray-500 sm:mt-0">
                        ${project.startDate
            ? new Date(project.startDate).toLocaleDateString()
            : ""
          }
                    </div>
                </div>
            </button>
            <div id="collapse-${i}" class="hidden px-6 py-4 bg-white">
                <p><strong>County:</strong> ${project.county || project.region || "Not specified"
          }</p>
                <p><strong>Budget:</strong> ${project.budget
            ? "KES " + Number(project.budget).toLocaleString()
            : "Not specified"
          }</p>
                <p><strong>Partner:</strong> ${project.partner && project.partner !== "TBD"
            ? project.partner
            : "Partner information pending"
          }</p>
                <p><strong>Status:</strong> 
                    <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge(
            project.status?.toLowerCase()
          )}">
                        ${project.status || ""}
                    </span>
                </p>
                <button onclick="focusMarker(${i})" class="px-5 py-2 mt-3 text-sm font-semibold text-white transition bg-blue-600 rounded hover:bg-blue-700 hover:scale-105">
                    Show on Map
                </button>
            </div>
          `;

        accordion.appendChild(item);

        // Toggle description between truncated and full
        const btn = item.querySelector(`[data-toggle="collapse-${i}"]`);
        btn.addEventListener("click", () => {
          const collapse = document.getElementById(`collapse-${i}`);
          const desc = document.getElementById(`desc-${i}`);
          collapse.classList.toggle("hidden");

          if (!collapse.classList.contains("hidden")) {
            desc.textContent =
              project.objectives || project.description || ""; // expand
          } else {
            desc.textContent =
              (project.objectives || project.description || "").substring(
                0,
                150
              ) + "..."; // truncate
          }
        });
      });
    }

    function updatePaginationControls(totalPages) {
      const container = document.getElementById("paginationControls");
      container.innerHTML = "";
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = `px-3 py-1 rounded ${i === currentPage
            ? "bg-blue-600 text-white"
            : "bg-gray-100 text-gray-800 hover:bg-gray-200"
          }`;
        btn.onclick = () => {
          currentPage = i;
          highlightMarkers(currentFilter);
        };
        container.appendChild(btn);
      }
    }

    function exportCSV() {
      const headers = [
        "Name",
        "Description",
        "Region",
        "Budget",
        "Status",
        "Start Date",
      ];
      const rows = projects
        .filter((p) => {
          if (
            searchQuery &&
            !p.projectName?.toLowerCase().includes(searchQuery.toLowerCase())
          )
            return false;
          const date = new Date(p.startDate);
          if (dateRangeFrom && date < dateRangeFrom) return false;
          if (dateRangeTo && date > dateRangeTo) return false;
          if (
            currentFilter !== "all" &&
            p.status?.toLowerCase() !== currentFilter
          )
            return false;
          return true;
        })
        .map((p) => [
          p.projectName || "",
          (p.description || "").replace(/,/g, ";"),
          p.region || p.county || "",
          p.budget || "",
          p.status || "",
          p.startDate ? new Date(p.startDate).toLocaleDateString() : "",
        ]);

      let csvContent = [headers.join(",")];
      rows.forEach((r) =>
        csvContent.push(r.map((val) => `"${val}"`).join(","))
      );

      const blob = new Blob([csvContent.join("\n")], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `projects_${new Date().toISOString().split("T")[0]
        }.csv`;
      link.click();
    }
  </script>

  <script>
    function countdownStats() {
      return {
        locations: 0,
        projects: 0,
        regions: 0,
        users: 0,
        amount: 0,
        amountDisplay: "0",

        targets: {
          locations: 35,
          projects: 120,
          regions: 15,
          users: 500,
          amount: 4500000,
        },

        duration: 1500, // in ms
        steps: 30,

        // number formatter
        formatAmount(value) {
          if (value >= 1e12) return (value / 1e12).toFixed(2) + "Tn";
          if (value >= 1e9) return (value / 1e9).toFixed(2) + "Bn";
          if (value >= 1e6) return (value / 1e6).toFixed(2) + "Mn";
          if (value >= 1e3) return (value / 1e3).toFixed(2) + "K";
          return value.toString();
        },

        start() {
          const interval = this.duration / this.steps;

          let currentStep = 0;
          const timer = setInterval(() => {
            currentStep++;
            const progress = currentStep / this.steps;

            this.locations = Math.floor(this.targets.locations * progress);
            this.projects = Math.floor(this.targets.projects * progress);
            this.regions = Math.floor(this.targets.regions * progress);
            this.users = Math.floor(this.targets.users * progress);
            this.amount = Math.floor(this.targets.amount * progress);

            // use formatter here
            this.amountDisplay = "" + this.formatAmount(this.amount);

            if (currentStep >= this.steps) clearInterval(timer);
          }, interval);
        },
      };
    }

    // User session initialization
    async function initializeUserSession() {
      // Check if user is authenticated
      if (!authManager.isAuthenticated()) {
        alert(
          "You must be logged in to access this page. (See console for details)"
        );
        // Prevent redirect for debugging
        throw new Error("Not authenticated");
      }

      // Check for demo token
      const demoToken =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJkZW1vQGVtYWlsLmNvbSIsInJvbGUiOiJVU0VSIiwiaWF0IjoxNjk1ODQwMDAwLCJleHAiOjE5MDAwMDAwMDB9.dummysignature";
      const token = authManager.getToken();
      if (token === demoToken) {
        // Use a fake user object for demo
        const user = {
          id: 1,
          name: "Demo User",
          email: "demo@email.com",
          role: "USER",
          approvalStatus: "APPROVED",
        };
        updateUserDisplay(user);
        await loadDashboardData();
        return;
      }

      try {
        // Load current user data
        const user = await authManager.getCurrentUser();

        // Update UI with user information
        updateUserDisplay(user);

        // Check if user is approved
        if (user.approvalStatus !== "APPROVED") {
          showApprovalPendingMessage(user);
        }

        // Load dashboard data
        await loadDashboardData();
      } catch (error) {
        console.error("Failed to load user session:", error);
        alert("Failed to load user session. Please log in again.");
        authManager.logout();
      }
    }

    // Load dashboard statistics and projects from API
    async function loadDashboardData() {
      try {
        console.log("Loading dashboard data...");
        // Load project statistics
        await loadProjectStatistics();
        // Load projects list (default: all projects)
        await loadProjects();
        // Optionally, load map-only projects
        // await loadProjectsWithCoordinates();
        console.log("Dashboard data loaded successfully");
      } catch (error) {
        console.error("Failed to load dashboard data:", error);
        showDashboardError();
      }
    }

    // Load project statistics from API
    async function loadProjectStatistics() {
      try {
        // Use the dedicated statistics endpoint
        const statsResponse = await authManager.apiCall(
          "/api/projects/statistics",
          "GET"
        );
        let stats = {
          totalProjects: 0,
          countyCounts: {},
          statusCounts: {},
          totalStakeholders: 0,
          totalBudget: 0,
          coordinatesCoveragePercentage: 0,
        };
        if (statsResponse.ok) {
          const statsData = await statsResponse.json();
          if (statsData.status === 200 && statsData.data) {
            stats = { ...stats, ...statsData.data };
          }
        }
        // Optionally fetch stakeholders/orgs if needed for counters
        // ...existing code for orgs if required...
        updateStatisticsDisplay(stats);
      } catch (error) {
        console.error("Error loading statistics:", error);
        useDefaultStatistics();
      }
    }

    // Use default statistics if API calls fail
    function useDefaultStatistics() {
      const defaultStats = {
        totalProjects: 0,
        countyCounts: {},
        statusCounts: {},
        totalStakeholders: 0,
        totalBudget: 0,
        coordinatesCoveragePercentage: 0,
      };

      // Show message about using defaults
      console.warn(
        "â ï¸ Using default statistics due to API failure - this should show 0 for all stats"
      );
      showApiConnectionWarning();

      updateStatisticsDisplay(defaultStats);
    }

    // Show API connection warning
    function showApiConnectionWarning() {
      const warningBanner = document.createElement("div");
      warningBanner.className =
        "fixed top-20 left-4 right-4 z-40 bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded";
      warningBanner.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">
                            <strong>API Connection Issue:</strong> Unable to load live data. Showing default values. 
                            This may be due to server maintenance or connectivity issues.
                        </p>
                    </div>
                    <div class="ml-auto pl-3">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-yellow-500 hover:text-yellow-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
      document.body.appendChild(warningBanner);

      setTimeout(() => {
        if (warningBanner.parentElement) {
          warningBanner.remove();
        }
      }, 10000);
    }

    // Load projects from API
    // Load all projects with pagination, sorting, and filtering
    async function loadProjects({
      page = 0,
      size = 50,
      sortBy = "id",
      sortDir = "desc",
      filters = {},
    } = {}) {
      try {
        let url = `/api/projects?page=${page}&size=${size}&sortBy=${sortBy}&sortDir=${sortDir}`;
        // Add filter params
        Object.entries(filters).forEach(([key, value]) => {
          if (value)
            url += `&${encodeURIComponent(key)}=${encodeURIComponent(value)}`;
        });
        const response = await authManager.apiCall(url, "GET");
        if (response.ok) {
          const data = await response.json();
          console.log("loadProjects API response:", data);
          if (data.status === 200 && data.data && data.data.projects) {
            const allProjects = data.data.projects;
            console.log("Loaded all projects:", allProjects.length);

            // Update the global projects array
            projects = allProjects;

            // Update the projects display (accordion)
            updateProjectsDisplay(allProjects);

            // Also add map markers for projects that have coordinates
            addMarkersToMap(
              allProjects.filter((p) => p.latitude && p.longitude)
            );

            // Trigger the accordion display
            highlightMarkers("all");
          }
        } else {
          showProjectsError();
        }
      } catch (error) {
        console.error("Error loading projects:", error);
        showProjectsError();
      }
    }

    // Load only projects with coordinates (for map)
    async function loadProjectsWithCoordinates() {
      try {
        const response = await authManager.apiCall(
          "/api/projects/with-coordinates",
          "GET"
        );
        if (response.ok) {
          const data = await response.json();
          if (data.status === 200 && data.data) {
            updateMapWithProjects(data.data);
          }
        }
      } catch (error) {
        // Optionally show error
      }
    }

    // Advanced search/filter
    async function searchProjects(filters) {
      try {
        let url = "/api/projects/search";
        const params = Object.entries(filters)
          .filter(([_, v]) => v)
          .map(
            ([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`
          )
          .join("&");
        if (params) url += `?${params}`;
        const response = await authManager.apiCall(url, "GET");
        if (response.ok) {
          const data = await response.json();
          if (data.status === 200 && data.data) {
            updateProjectsDisplay(data.data);
            updateMapWithProjects(data.data);
          }
        }
      } catch (error) { }
    }

    // Filter by status
    async function filterProjectsByStatus(status) {
      try {
        const response = await authManager.apiCall(
          `/api/projects/status/${status}`,
          "GET"
        );
        if (response.ok) {
          const data = await response.json();
          if (data.status === 200 && data.data) {
            updateProjectsDisplay(data.data);
            updateMapWithProjects(data.data);
          }
        }
      } catch (error) { }
    }

    // Filter by date range
    async function filterProjectsByDateRange(startDate, endDate) {
      try {
        const url = `/api/projects/date-range?startDate=${encodeURIComponent(
          startDate
        )}&endDate=${encodeURIComponent(endDate)}`;
        const response = await authManager.apiCall(url, "GET");
        if (response.ok) {
          const data = await response.json();
          if (data.status === 200 && data.data) {
            updateProjectsDisplay(data.data);
            updateMapWithProjects(data.data);
          }
        }
      } catch (error) { }
    }

    // Filter by bounding box (for map)
    async function filterProjectsByBounds(minLat, maxLat, minLng, maxLng) {
      try {
        const url = `/api/projects/in-bounds?minLat=${minLat}&maxLat=${maxLat}&minLng=${minLng}&maxLng=${maxLng}`;
        const response = await authManager.apiCall(url, "GET");
        if (response.ok) {
          const data = await response.json();
          if (data.status === 200 && data.data) {
            updateProjectsDisplay(data.data);
            updateMapWithProjects(data.data);
          }
        }
      } catch (error) { }
    }

    // Get project details by ID
    async function getProjectById(id) {
      try {
        const response = await authManager.apiCall(
          `/api/projects/${id}`,
          "GET"
        );
        if (response.ok) {
          const data = await response.json();
          if (data.status === 200 && data.data) {
            // Show details in modal or section
            // showProjectDetailsModal(data.data);
          }
        }
      } catch (error) { }
    }

    // Get my projects (for PARTNER)
    async function loadMyProjects() {
      try {
        const response = await authManager.apiCall(
          "/api/projects/my-projects",
          "GET"
        );
        if (response.ok) {
          const data = await response.json();
          if (data.status === 200 && data.data) {
            updateProjectsDisplay(data.data);
            updateMapWithProjects(data.data);
          }
        }
      } catch (error) { }
    }

    // Update map with real project data
    function updateMapWithProjects(projectsData) {
      console.log("updateMapWithProjects called with:", projectsData);
      console.log("Number of projects received:", projectsData.length);

      // Log all projects to see their structure
      projectsData.forEach((project, idx) => {
        console.log(`Project ${idx + 1} structure:`, {
          id: project.id,
          name: project.projectName || project.name,
          latitude: project.latitude,
          longitude: project.longitude,
          status: project.status,
          hasCoordinates: !!(project.latitude && project.longitude),
          allFields: Object.keys(project),
        });
      });

      // Find projects with coordinates
      const projectsWithCoords = projectsData.filter((p) => {
        const hasCoords = p.latitude && p.longitude;
        if (!hasCoords) {
          console.warn(
            `Project "${p.projectName || p.name}" (ID: ${p.id
            }) is missing coordinates!`
          );
        }
        return hasCoords;
      });

      console.log("Updating map with", projectsWithCoords.length, "projects");
      console.log("Projects with coordinates:", projectsWithCoords);

      // Add markers to Mapbox map
      addMarkersToMap(projectsWithCoords);

      // Update project list
      projects = projectsData;
    }

    // Update statistics display with real data
    function updateStatisticsDisplay(stats) {
      console.log("Updating statistics display with:", stats);

      // Update hero section statistics
      const totalProjectsElement =
        document.getElementById("totalProjectsCount");
      const totalCountiesElement =
        document.getElementById("totalCountiesCount");
      const totalStakeholdersElement = document.getElementById(
        "totalStakeholdersCount"
      );

      if (totalProjectsElement) {
        totalProjectsElement.textContent = stats.totalProjects || 0;
        console.log("Updated total projects count:", stats.totalProjects);
      }
      if (totalCountiesElement) {
        totalCountiesElement.textContent =
          Object.keys(stats.countyCounts || {}).length || 0;
        console.log(
          "Updated total counties count:",
          Object.keys(stats.countyCounts || {}).length
        );
      }
      if (totalStakeholdersElement) {
        totalStakeholdersElement.textContent = stats.totalStakeholders || 0;
        console.log(
          "Updated total stakeholders count:",
          stats.totalStakeholders
        );
      }

      // Update Alpine.js countdownStats component
      try {
        const statsComponent = Alpine.$data(
          document.querySelector('[x-data*="countdownStats"]')
        );

        if (statsComponent) {
          // Update targets with real data
          statsComponent.targets = {
            locations: stats.coordinatesCoveragePercentage || 0,
            projects: stats.totalProjects || 0,
            regions: Object.keys(stats.countyCounts || {}).length || 0,
            users: stats.totalStakeholders || 0,
            amount: stats.totalBudget || 0, // This would need to be calculated from projects
          };

          // Reset the animation values
          statsComponent.locations = 0;
          statsComponent.projects = 0;
          statsComponent.regions = 0;
          statsComponent.users = 0;
          statsComponent.amount = 0;
          statsComponent.amountDisplay = "0";

          // Restart the animation with new targets
          statsComponent.start();

          console.log(
            "Alpine.js statistics updated:",
            statsComponent.targets
          );
        } else {
          console.warn("Alpine.js countdownStats component not found");
        }
      } catch (error) {
        console.error("Error updating Alpine.js component:", error);
      }

      console.log("Hero statistics updated:", {
        projects: stats.totalProjects,
        counties: Object.keys(stats.countyCounts || {}).length,
        stakeholders: stats.totalStakeholders,
      });
    }

    // Update projects display
    function updateProjectsDisplay(projectsData) {
      console.log(
        "updateProjectsDisplay called with:",
        projectsData.length,
        "projects"
      );

      // Update global projects variable
      window.projects = projectsData;
      window.filteredProjects = projectsData;

      // Render accordion with projects
      renderProjectsList(projectsData);

      console.log(
        "Projects display updated with",
        projectsData.length,
        "projects"
      );
    }

    // Render projects accordion in the UI
    function renderProjectsList(projects) {
      console.log(
        "renderProjectsList called with:",
        projects.length,
        "projects"
      );
      const accordion = document.getElementById("projectAccordion");
      if (!accordion) {
        console.error("Accordion element not found!");
        return;
      }

      // Make sure accordion is visible
      accordion.classList.remove("hidden");
      accordion.innerHTML = "";

      if (projects.length === 0) {
        console.log("No projects to display");
        accordion.innerHTML = `
            <div class="text-center py-8">
              <i class="fas fa-project-diagram text-gray-400 text-4xl mb-4"></i>
              <p class="text-gray-600">No projects found.</p>
            </div>
          `;
        return;
      }

      console.log("Rendering", projects.length, "projects in accordion");
      projects.forEach((project, idx) => {
        console.log(
          `Rendering project ${idx + 1}:`,
          project.projectName || project.name
        );
        // Status color classes
        const statusBg =
          {
            active: "bg-green-50",
            pending: "bg-yellow-50",
            stalled: "bg-red-50",
            completed: "bg-cyan-100",
          }[project.status] || "bg-white";
        const statusBadge =
          {
            active: "bg-green-200 text-green-800",
            pending: "bg-yellow-200 text-yellow-800",
            stalled: "bg-red-200 text-red-800",
            completed: "bg-cyan-300 text-gray-800",
          }[project.status] || "bg-gray-200 text-gray-800";
        // Format budget
        const budget = project.budget
          ? Number(project.budget).toLocaleString("en-KE", {
            style: "currency",
            currency: "KES",
            maximumFractionDigits: 0,
          })
          : "N/A";
        // Accordion item
        const item = document.createElement("div");
        item.className = `rounded shadow-sm ${statusBg}`;
        item.innerHTML = `
            <button class=\"w-full px-6 py-4 text-left border-b focus:outline-none\" data-toggle=\"collapse-${idx}\">
              <div class=\"flex flex-col sm:flex-row sm:justify-between sm:items-center\">
                <div>
                  <h4 class=\"text-lg font-semibold text-gray-800\">${project.title || ""
          }</h4>
                  <p id=\"desc-${idx}\" class=\"mt-2 text-sm text-gray-600\">${project.objectives
            ? project.objectives.substring(0, 100) +
            (project.objectives.length > 100 ? "..." : "")
            : ""
          }</p>
                </div>
                <div class=\"flex items-center mt-2 text-sm font-semibold tracking-wider text-gray-500 sm:mt-0\">
                  ${project.projectTheme
            ? `<span class='px-2 py-1 rounded-full bg-gray-100 text-gray-700 mr-2'>${project.projectTheme}</span>`
            : ""
          }
                  ${project.status
            ? `<span class='px-2 py-1 rounded-full text-sm font-medium ${statusBadge}'>${project.status}</span>`
            : ""
          }
                </div>
              </div>
            </button>
            <div id=\"collapse-${idx}\" class=\"hidden px-6 py-4 bg-white\">
              <p><strong>County:</strong> ${project.county || "Not specified"
          }</p>
              <p><strong>Budget:</strong> ${budget}</p>
              <p><strong>Partner:</strong> ${project.partner && project.partner !== "TBD"
            ? project.partner
            : "Partner information pending"
          }</p>
              <p><strong>Status:</strong> 
                <span class=\"inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge}\">
                  ${project.status || ""}
                </span>
              </p>
              <button onclick=\"focusMarker(${idx})\" class=\"px-5 py-2 mt-3 text-sm font-semibold text-white transition bg-blue-600 rounded hover:bg-blue-700 hover:scale-105\">
                Show on Map
              </button>
            </div>
          `;
        accordion.appendChild(item);
        // Toggle description between truncated and full
        const btn = item.querySelector(`[data-toggle="collapse-${idx}"]`);
        btn.addEventListener("click", () => {
          const collapse = document.getElementById(`collapse-${idx}`);
          const desc = document.getElementById(`desc-${idx}`);
          collapse.classList.toggle("hidden");
          if (!collapse.classList.contains("hidden")) {
            desc.textContent = project.objectives || "";
          } else {
            desc.textContent = project.objectives
              ? project.objectives.substring(0, 100) +
              (project.objectives.length > 100 ? "..." : "")
              : "";
          }
        });
      });
    }

    // Create project card element
    function createProjectCard(project) {
      const card = document.createElement("div");
      card.className =
        "bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow";

      const statusClass = getStatusClass(project.status);
      const themeClass = getThemeClass(project.projectTheme);

      card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold text-gray-800 line-clamp-2">${project.title
        }</h3>
                    <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                        ${project.status.charAt(0).toUpperCase() +
        project.status.slice(1)
        }
                    </span>
                </div>
                
                <div class="space-y-2 mb-4">
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-building mr-2"></i>${project.partner}
                    </p>
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-map-marker-alt mr-2"></i>${project.county
        }${project.subCounty ? ", " + project.subCounty : ""}
                    </p>
                    <p class="text-sm text-gray-600">
                        <i class="fas fa-calendar mr-2"></i>${project.startDate
        } - ${project.endDate}
                    </p>
                    ${project.budget
          ? `
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-dollar-sign mr-2"></i>$${project.budget.toLocaleString()}
                        </p>
                    `
          : ""
        }
                </div>
                
                <div class="flex justify-between items-center">
                    <span class="px-2 py-1 rounded text-xs font-medium ${themeClass}">
                        ${project.projectTheme}
                    </span>
                    <button onclick="viewProject(${project.id})" 
                        class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        View Details â
                    </button>
                </div>
            `;

      return card;
    }

    // Helper functions for styling
    function getStatusClass(status) {
      const classes = {
        active: "bg-green-100 text-green-800",
        pending: "bg-yellow-100 text-yellow-800",
        completed: "bg-blue-100 text-blue-800",
        stalled: "bg-red-100 text-red-800",
        abandoned: "bg-gray-100 text-gray-800",
      };
      return classes[status] || "bg-gray-100 text-gray-800";
    }

    function getThemeClass(theme) {
      const classes = {
        MNH: "bg-pink-100 text-pink-800",
        FP: "bg-blue-100 text-blue-800",
        GBV: "bg-red-100 text-red-800",
        CH: "bg-green-100 text-green-800",
        AH: "bg-purple-100 text-purple-800",
        AYPSRH: "bg-indigo-100 text-indigo-800",
      };
      return classes[theme] || "bg-gray-100 text-gray-800";
    }

    // View project details
    function viewProject(projectId) {
      window.open(`/frontend/project-details.html?id=${projectId}`, "_blank");
    }

    // Use default statistics if API fails
    function useDefaultStatistics() {
      console.log("Using default statistics");
      // The existing hardcoded values will be used
    }

    // Show dashboard error
    function showDashboardError() {
      const errorBanner = document.createElement("div");
      errorBanner.className =
        "fixed top-20 left-4 right-4 z-40 bg-red-100 border-l-4 border-red-500 p-4 rounded";
      errorBanner.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-circle text-red-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700">
                            Failed to load some dashboard data. Showing cached or default information.
                        </p>
                    </div>
                    <div class="ml-auto pl-3">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
      document.body.appendChild(errorBanner);

      setTimeout(() => {
        if (errorBanner.parentElement) {
          errorBanner.remove();
        }
      }, 5000);
    }

    // Show projects error
    function showProjectsError() {
      const projectsContainer = document.getElementById("projects-container");
      if (projectsContainer) {
        projectsContainer.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
                        <p class="text-gray-600 mb-4">Failed to load projects. Please try again later.</p>
                        <button onclick="loadProjects()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                            Retry
                        </button>
                    </div>
                `;
      }
    }

    function updateUserDisplay(user) {
      // Update navigation display
      const userDisplayName = document.getElementById("userDisplayName");
      const userNameDisplay = document.getElementById("userNameDisplay");
      const userEmailDisplay = document.getElementById("userEmailDisplay");
      const userRoleDisplay = document.getElementById("userRoleDisplay");
      const userStatusDisplay = document.getElementById("userStatusDisplay");

      if (userDisplayName) userDisplayName.textContent = user.name || "User";
      if (userNameDisplay) userNameDisplay.textContent = user.name || "N/A";
      if (userEmailDisplay)
        userEmailDisplay.textContent = user.email || "N/A";
      if (userRoleDisplay) userRoleDisplay.textContent = user.role || "N/A";
      if (userStatusDisplay) {
        userStatusDisplay.textContent = user.approvalStatus || "N/A";
        userStatusDisplay.className =
          user.approvalStatus === "APPROVED"
            ? "text-green-600"
            : user.approvalStatus === "PENDING"
              ? "text-yellow-600"
              : "text-red-600";
      }

      // Hide all role-based navs by default
      const adminNav = document.getElementById("adminNav");
      const partnerNav = document.getElementById("partnerNav");
      const myProjectsNav = document.getElementById("myProjectsNav");
      if (adminNav) adminNav.classList.add("hidden");
      if (partnerNav) partnerNav.classList.add("hidden");
      if (myProjectsNav) myProjectsNav.classList.add("hidden");

      // Show navs based on role
      if (user.role === "SUPER_ADMIN") {
        if (adminNav) adminNav.classList.remove("hidden");
      }
      if (user.role === "PARTNER") {
        if (partnerNav) partnerNav.classList.remove("hidden");
        if (myProjectsNav) myProjectsNav.classList.remove("hidden");
      }

      // Show admin collaboration menu for ADMIN or SUPER_ADMIN
      if (user.role === "ADMIN" || user.role === "SUPER_ADMIN") {
        const adminCollabMenu = document.getElementById(
          "admin-collab-requests"
        );
        const adminCollabMobile = document.getElementById(
          "admin-collab-mobile"
        );
        if (adminCollabMenu) adminCollabMenu.style.display = "block";
        if (adminCollabMobile) adminCollabMobile.style.display = "block";
        loadPendingRequestsCount();
      }
      // Optionally, show/hide other navs for other roles as needed
    }

    async function loadPendingRequestsCount() {
      try {
        const token = localStorage.getItem("accessToken");
        const response = await fetch(
          `${BASE_URL}/api/collaboration-requests/admin/pending`,
          {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          }
        );
        const data = await response.json();
        if (data.status === 200 && data.data) {
          const count = data.data.length;
          const badge = document.getElementById("pending-badge");
          if (badge && count > 0) {
            badge.textContent = count;
            badge.style.display = "inline-block";
          }
        }
      } catch (error) {
        console.error("Error loading pending requests count:", error);
      }
    }

    function showApprovalPendingMessage(user) {
      if (user.approvalStatus === "PENDING") {
        const banner = document.createElement("div");
        banner.className =
          "fixed top-20 left-4 right-4 z-40 bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded";
        banner.innerHTML = `
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                Your account is pending approval. Some features may be limited until an administrator approves your account.
                            </p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-yellow-500 hover:text-yellow-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
        document.body.appendChild(banner);

        // Auto-remove after 10 seconds
        setTimeout(() => {
          if (banner.parentElement) {
            banner.remove();
          }
        }, 10000);
      }
    }

    // Show My Projects section for PARTNER users
    function showMyProjects() {
      if (currentUser && currentUser.role === "PARTNER") {
        loadUserProjects();
        // Scroll to projects section or show modal
        document
          .getElementById("projects-container")
          .scrollIntoView({ behavior: "smooth" });
      }
    }

    // Load user's own projects (for PARTNER users)
    async function loadUserProjects() {
      try {
        console.log("Loading user projects...");
        const userId = currentUser.id;
        const response = await authManager.apiCall(
          `/api/projects/user/${userId}`,
          {
            method: "GET",
          }
        );

        if (response && response.length > 0) {
          renderUserProjectsList(response);
        } else {
          showNoUserProjectsMessage();
        }
      } catch (error) {
        console.error("Failed to load user projects:", error);
        showUserProjectsError();
      }
    }

    // Render user's projects list
    function renderUserProjectsList(projects) {
      const container = document.getElementById("projects-container");
      if (!container) return;

      container.innerHTML = `
                <div class="mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">My Projects</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${projects
          .map((project) => createUserProjectCard(project))
          .join("")}
                    </div>
                </div>
            `;
    }

    // Create project card for user's projects
    function createUserProjectCard(project) {
      const statusColors = {
        ACTIVE: "bg-green-100 text-green-800",
        PENDING: "bg-yellow-100 text-yellow-800",
        STALLED: "bg-red-100 text-red-800",
        COMPLETED: "bg-blue-100 text-blue-800",
        ABANDONED: "bg-gray-100 text-gray-800",
      };

      return `
                <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-gray-800 truncate">${project.name || "Untitled Project"
        }</h4>
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[project.status] ||
        "bg-gray-100 text-gray-800"
        }">
                                ${project.status || "Unknown"}
                            </span>
                        </div>
                        <p class="text-gray-600 text-sm mb-4 line-clamp-3">
                            ${project.description || "No description available"}
                        </p>
                        <div class="space-y-2 text-sm text-gray-500">
                            <div class="flex justify-between">
                                <span>Budget:</span>
                                <span class="font-medium">$${project.budget
          ? project.budget.toLocaleString()
          : "N/A"
        }</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Progress:</span>
                                <span class="font-medium">${project.progress || 0
        }%</span>
                            </div>
                            ${project.startDate
          ? `
                            <div class="flex justify-between">
                                <span>Started:</span>
                                <span class="font-medium">${new Date(
            project.startDate
          ).toLocaleDateString()}</span>
                            </div>
                            `
          : ""
        }
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <button onclick="viewProjectDetails(${project.id})" 
                                    class="w-full px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            `;
    }

    // Show no user projects message
    function showNoUserProjectsMessage() {
      const container = document.getElementById("projects-container");
      if (!container) return;

      container.innerHTML = `
                <div class="text-center py-12">
                    <div class="mb-4">
                        <i class="fas fa-folder-open text-6xl text-gray-300"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">No Projects Yet</h3>
                    <p class="text-gray-500 mb-6">You haven't created any projects yet. Start by submitting a new project proposal.</p>
                    <a href="Forms/Admin/new-project.html" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>
                        Create New Project
                    </a>
                </div>
            `;
    }

    // Show user projects error
    function showUserProjectsError() {
      const container = document.getElementById("projects-container");
      if (!container) return;

      container.innerHTML = `
                <div class="text-center py-12">
                    <div class="mb-4">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-300"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Failed to Load Projects</h3>
                    <p class="text-gray-500 mb-6">There was an error loading your projects. Please try again.</p>
                    <button onclick="loadUserProjects()" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-refresh mr-2"></i>
                        Try Again
                    </button>
                </div>
            `;
    }

    // View project details
    function viewProjectDetails(projectId) {
      // Navigate to project details page or show modal
      window.location.href = `project-details.html?id=${projectId}`;
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
</body>

</html>