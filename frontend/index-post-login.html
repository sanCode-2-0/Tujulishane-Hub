<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>RMNCAH</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
		integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
		crossorigin="anonymous" referrerpolicy="no-referrer" />
	<!-- Tailwind CSS (with custom config using inline script) -->
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						primary: "#1e40af", // Custom Blue
						secondary: "#f59e0b", // Custom Amber
						accent: "#10b981", // Custom Green
						dark: "#1f2937", // Gray-800
					},
					fontFamily: {
						sans: ["Inter", "sans-serif"],
					},
				},
			},
		};
	</script>
	<link rel="stylesheet" href="styles/main.css" />
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css" />
	<script src="styles/main.js"></script>
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
		integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800;900&display=swap"
		rel="stylesheet" />
	<link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
	<!-- Alpine.js -->
	<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
	<!-- Mapbox CSS -->
	<link href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet" />
	<!-- Mapbox JS -->
	<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
	<!-- Backend URL Configuration - Centralized in config.js -->
	<script src="./config.js"></script>
	<script src="./set-base-url.js"></script>
	<!-- Modal Utilities -->
	<script src="./modal-utils.js"></script>
	<script src="auth.js"></script>
	<script src="kenya-locations.js"></script>

	<!-- Optional: Google Font -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css" />
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						primary: "#272E28",
						secondary: "#f59e0b",
						accent: "#00474C",
						button: "#14B04C",
						button_two: "#3482FF",
					},
					fontFamily: {
						sans: ["Inter", "sans-serif"],
					},
				},
			},
		};
	</script>
	<style>
		.fade-slide-enter {
			opacity: 0;
			transform: translateY(20px);
		}

		.fade-slide-enter-active {
			opacity: 1;
			transform: translateY(0);
			transition: all 0.4s ease;
		}

		.fade-slide-leave {
			opacity: 1;
			transform: translateY(0);
		}

		.fade-slide-leave-active {
			opacity: 0;
			transform: translateY(20px);
			transition: all 0.3s ease;
		}
	</style>
</head>

<body class="text-gray-800 overflow-x-hidden">
	<!-- Nav Start -->
	<div class="" id="nav-placeholder"></div>
	<!-- Nav End -->

	<section class="relative z-0 overflow-hidden" id="top">
		<div class="w-full overflow-hidden">
			<div x-data="{
						activeSlide: 0,
						media: [
						{ type: 'image', src: 'resources/images/main-1.jpg' },
						{ type: 'image', src: 'resources/images/main-2.jpg' },
						{ type: 'image', src: 'resources/images/main-3.jpg' }
						]
					}" x-init="setInterval(() => { activeSlide = (activeSlide + 1) % media.length }, 7000)"
				class="relative w-full min-h-[75vh] md:h-[50vh] flex flex-col justify-end">
				<!-- Background Image Carousel with Zoom + Fade -->
				<template x-for="(item, index) in media" :key="index">
					<div class="absolute inset-0 transition-all duration-1000 ease-in-out overflow-hidden" :class="{
										'opacity-100 z-0': activeSlide === index,
										'opacity-0 z-0 pointer-events-none': activeSlide !== index
									}">
						<img :src="item.src" alt="Slide Image"
							class="w-full h-full object-cover object-center transition-transform duration-[7000ms] ease-[cubic-bezier(0.4,0,0.2,1)]"
							:class="activeSlide === index ? 'scale-105' : 'scale-100'" />
					</div>
				</template>

				<!-- Overlay -->
				<div class="absolute inset-0 bg-black bg-opacity-50 z-10"></div>

				<!-- Bottom Content Section -->
				<div class="relative z-20 w-full pt-16 sm:pt-0">
					<div class="mx-4 md:mx-8 text-white px-4">
						<a href="#" class="text-xs font-semibold uppercase tracking-wide mb-2 block">
							Ministry of Health
						</a>
						<h1 class="text-xl sm:text-4xl font-semibold mb-4">
							<span class="tracking-wide">RMNCAH</span> Co-ordination Hub
						</h1>
						<p class="text-sm sm:text-base mb-6 max-w-4xl">
							Discover and engage with impactful projects driving change
							across Kenya. Use the filters to find projects that align with
							your interests and make a difference.
						</p>
					</div>

					<!-- Search and Stats Section -->
					<div class="backdrop-blur-md bg-black/30 mx-8 rounded-t-2xl border-t border-black/20">
						<div class="px-4 py-4 flex flex-col items-center justify-between gap-4">
							<!-- Icon Buttons / Stats -->
							<div
								class="flex justify-between text-white text-xl lg:text-3xl w-full flex-wrap text-center gap-y-6">
								<div class="flex flex-col items-center w-1/2 sm:w-auto">
									<i class="fad fa-tasks text-lg lg:text-2xl"></i>
									<div class="mt-2">
										<span id="totalProjectsCount" class="font-bold tracking-wider">
											8
										</span>
										<span class="font-thin">Projects</span>
									</div>
								</div>
								<div class="flex flex-col items-center w-1/2 sm:w-auto">
									<i class="fad fa-map-marker-alt text-lg lg:text-2xl"></i>
									<div class="mt-2">
										<span id="totalCountiesCount" class="font-bold tracking-wider">7</span>
										<span class="font-thin">Counties</span>
									</div>
								</div>
								<div class="flex flex-col items-center w-1/2 sm:w-auto">
									<i class="fad fa-handshake text-lg lg:text-2xl"></i>
									<div class="mt-2">
										<span id="totalStakeholdersCount" class="font-bold tracking-wider">10</span>
										<span class="font-thin">Stakeholders</span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- end bottom section -->
			</div>
		</div>
	</section>

	<section class="">
		<div class="grid items-center p-4 lg:px-10 md:p-8 md:grid-cols-5">
			<div class="md:col-span-4">
				<h3 class="mb-4 text-sm font-normal opacity-50 leading-tight text-gray-900 uppercase">
					Explore Projects Across Kenya
				</h3>
				<h1 class="mb-2 text-4xl text-blue-900 font-semibold md:text-4xl">
					Empowering Change Through Collaboration
				</h1>
				<h6 class="mt-4 mb-1 text-sm font-semibold leading-tight text-gray-900 uppercase opacity-70">
					Explore Projects Across Kenya
				</h6>
				<p class="text-[16px] text-gray-700 mb-6">
					Discover and engage with impactful projects driving change across
					Kenya. Use the filters to find projects that align with your
					interests and make a difference.
				</p>
			</div>
			<div class="md:col-span-1">
				<h6 class="my-4 text-sm font-semibold leading-tight text-center text-gray-900 uppercase opacity-70">
					Data Hub Resources
				</h6>
				<div class="flex justify-between lg:grid lg:grid-cols-1 gap-4 text-white">
					<a href=""
						class="flex items-center w-1/2 lg:w-full justify-between px-4 py-2 rounded-full bg-button">
						<span class="text-sm"> FAQ Docuent </span>
						<span class="text-lg">
							<i class="fas fa-file-pdf"></i>
						</span>
					</a>
					<!-- <a href="" class="flex items-center justify-between px-4 py-2 rounded-full bg-cyan-600">
                        <span class="text-sm">
                            Methods Brief
                        </span>
                        <span class="text-lg">
                            <i class="fas fa-clipboard-list-check"></i>
                        </span>
                    </a> -->
					<a href=""
						class="flex items-center w-1/2 lg:w-full justify-between px-4 py-2 rounded-full bg-button_two">
						<span class="text-sm"> Video Tutorial </span>
						<span class="text-lg">
							<i class="fas fa-play-circle"></i>
						</span>
					</a>
				</div>
			</div>
		</div>
	</section>

	<section class="py-20 p-4 lg:px-10 md:p-8">
		<div class="w-full">
			<h3 class="mb-4 text-sm font-normal opacity-50 leading-tight text-gray-900 uppercase">
				Thematic Areas
			</h3>
			<div id="thematicAreasContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
				<!-- Theme cards will be dynamically inserted here -->
				<div class="col-span-full text-center py-8">
					<div class="animate-pulse">
						<div class="h-4 bg-gray-200 rounded w-1/4 mx-auto mb-4"></div>
						<div class="h-32 bg-gray-200 rounded mb-4"></div>
						<div class="h-4 bg-gray-200 rounded w-1/2 mx-auto"></div>
					</div>
				</div>
			</div>
		</div>
	</section>

	<section class="p-4 lg:px-10 md:p-8">
		<!-- Map Search Controls -->
		<div class="mb-6 bg-white rounded-xl shadow-lg border border-gray-200 p-6">
			<h3 class="text-xl font-semibold text-blue-900 mb-4">
				RMNCAH Project Locations
			</h3>
			<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
				<!-- General Search -->
				<div class="relative lg:col-span-2">
					<label for="mapSearchInput" class="block text-sm font-medium text-gray-700 mb-2">
						Project Name or Number
					</label>
					<input type="text" id="mapSearchInput" placeholder="Search by project name or number..."
						class="w-full px-4 py-2 pl-10 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
					<div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none top-6">
						<i class="text-gray-400 fas fa-search"></i>
					</div>
				</div>

				<!-- County Dropdown -->
				<div class="relative">
					<label for="mapCountySelect" class="block text-sm font-medium text-gray-700 mb-2">County</label>
					<select id="mapCountySelect"
						class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
						<option value="">All Counties</option>
					</select>
				</div>

				<!-- Sub-County Dropdown -->
				<div class="relative">
					<label for="mapSubCountySelect"
						class="block text-sm font-medium text-gray-700 mb-2">Sub-County</label>
					<select id="mapSubCountySelect"
						class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
						<option value="">All Sub-Counties</option>
					</select>
				</div>

				<!-- Search Button -->
				<div class="flex items-end">
					<button id="mapSearchBtn"
						class="w-full px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
						<i class="fas fa-search mr-2"></i>Find Projects
					</button>
				</div>
			</div>

			<!-- Search Results Info -->
			<div id="searchResultsInfo" class="mt-4 text-sm text-gray-600 hidden">
				<span id="resultsCount">0</span> projects found. Click on markers for
				details.
			</div>
		</div>

		<!-- Map Container -->
		<div id="localMap" class="h-[450px] sm:h-[550px] z-0 w-full border border-gray-200 rounded-xl shadow-lg"></div>
	</section>

	<section class="bg-white">
		<div class="p-4 lg:px-10 md:p-8 px-4 py-12 sm:px-6 lg:px-8">
			<!-- Status Filter Buttons -->
			<div class="grid grid-cols-1 gap-8 md:grid-cols-5 lg:grid-cols-7">
				<!-- Sticky Filter Sidebar (Right Side) -->
				<div
					class="lg:sticky p-6 bg-white rounded-lg shadow-md md:col-span-2 lg:col-span-2 fade fade-up h-fit top-6">
					<h2 class="mb-2 -mt-10 text-sm font-semibold text-left text-gray-800 transform rounded-xl">
						<i class="p-2 text-black bg-white rounded-sm shadow fas fa-filter"></i>
					</h2>

					<div class="flex flex-col gap-5">
						<!-- Search -->
						<div class="relative w-full">
							<label for="searchInput" class="sr-only">Search by name...</label>
							<input type="text" id="searchInput" placeholder="Search by name..."
								class="block w-full py-2 pl-10 pr-4 text-base text-gray-900 placeholder-gray-500 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
							<div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
								<i class="text-gray-400 fas fa-search"></i>
							</div>
						</div>
						<div class="grid gap-2 lg:grid-cols-2">
							<!-- From Date -->
							<div class="flex flex-col gap-2">
								<label for="dateFrom" class="text-sm font-medium text-gray-700">From Date:</label>
								<input type="date" id="dateFrom"
									class="w-full px-3 py-2 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
							</div>

							<!-- To Date -->
							<div class="flex flex-col gap-2">
								<label for="dateTo" class="text-sm font-medium text-gray-700">To Date:</label>
								<input type="date" id="dateTo"
									class="w-full px-3 py-2 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
							</div>
						</div>

						<!-- Sort By -->
						<div class="flex flex-col gap-2">
							<label for="sortSelect" class="text-sm font-medium text-gray-700">Sort By:</label>
							<select id="sortSelect"
								class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
								<option value="name">Name (A-Z)</option>
								<option value="date">Date (Newest First)</option>
							</select>
						</div>

						<!-- Thematic Areas Filter -->
						<div class="flex flex-col gap-2">
							<label for="themeFilter" class="text-sm font-medium text-gray-700">Thematic Areas:</label>
							<select id="themeFilter"
								class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
								<option value="all">All Themes</option>
								<option value="GBV">Gender-Based Violence</option>
								<option value="AYPSRH">
									Adolescent and Young People Sexual and Reproductive Health
								</option>
								<option value="MNH">Maternal and Newborn Health</option>
								<option value="FP">Family Planning</option>
								<option value="CH">Child Health</option>
								<option value="AH">Adolescent Health</option>
							</select>
						</div>

						<!-- Status Filter -->
						<div class="flex flex-col gap-2">
							<label for="status" class="text-sm font-medium text-gray-700">Status:</label>
							<select id="statusFilter"
								class="w-full px-4 py-2 text-gray-900 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
								onchange="applyStatusFilter(this.value)">
								<option value="all">Show All</option>
								<option value="active">Active</option>
								<option value="pending">Pending</option>
								<option value="stalled">Stalled</option>
								<option value="completed">Completed</option>
							</select>
						</div>

						<!-- Export Button -->
						<button onclick="exportCSV()"
							class="flex items-center justify-center px-5 py-2 mt-6 text-base font-semibold text-white transition duration-200 bg-indigo-600 rounded-lg shadow hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
							<i class="mr-2 fas fa-file-csv"></i> Export Data
						</button>
					</div>
				</div>
				<!-- Main Content Area -->
				<div class="flex flex-col md:col-span-3 fade fade-left lg:col-span-5">
					<!-- Project Info -->
					<div id="projectInfo"
						class="flex-grow hidden p-6 mb-4 bg-white border border-gray-200 shadow-lg rounded-xl">
						<h3 class="mb-4 text-xl font-semibold text-gray-800">
							Selected Project Details
						</h3>
						<p class="text-gray-700">
							Details of the selected project will appear here.
						</p>
					</div>

					<!-- Accordion -->
					<div id="projectAccordion"
						class="hidden w-full space-y-4 transition-opacity duration-500 ease-in-out transform translate-y-4 opacity-0">
						<h3 class="mb-4 text-xl font-semibold text-gray-800" id="projectsTitle">
							All Projects
						</h3>
						<div class="p-6 bg-white border border-gray-200 shadow-lg rounded-xl">
							<!-- Projects will be loaded dynamically here -->
							<div id="projects-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
								<!-- Loading state -->
								<div class="col-span-full text-center py-8">
									<i class="fas fa-spinner fa-spin text-gray-400 text-4xl mb-4"></i>
									<p class="text-gray-600">Loading projects...</p>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="flex items-center justify-center px-4 my-4">
			<div id="paginationControls" class="space-x-2"></div>
		</div>

		<div class="max-w-6xl px-4 mx-auto mt-12 sm:px-6 lg:px-8">
			<h2 class="mb-10 text-xl font-light leading-tight text-center text-gray-900 uppercase opacity-70">
				Impact
			</h2>
			<div class="flex flex-wrap justify-center gap-6 mb-8" x-data="countdownStats()" x-init="start()">
				<div
					class="flex flex-col items-center justify-center p-6 text-center transition-all duration-300 ease-in-out transform bg-white rounded-2xl fade fade-up hover:scale-105">
					<div class="text-5xl font-light font-extrabold text-blue-700" x-text="locations"></div>
					<p class="mt-3 text-base font-thin font-medium text-gray-600">
						Locations
					</p>
				</div>

				<div
					class="flex flex-col items-center justify-center p-6 text-center transition-all duration-300 ease-in-out transform bg-white rounded-2xl fade fade-up hover:scale-105">
					<div class="text-5xl font-light font-extrabold text-pink-600" x-text="projects"></div>
					<p class="mt-3 text-base font-thin font-medium text-gray-600" id="projectsLabel">
						Projects
					</p>
				</div>

				<div
					class="flex flex-col items-center justify-center p-6 text-center transition-all duration-300 ease-in-out transform bg-white rounded-2xl fade fade-up hover:scale-105">
					<div class="text-5xl font-light font-extrabold text-yellow-600" x-text="amountDisplay"></div>
					<p class="mt-3 text-base font-thin font-medium text-gray-600">
						Raised (KES)
					</p>
				</div>
			</div>
		</div>
	</section>
	<!--Footer container-->
	<footer class="flex flex-col items-center text-center bg-white text-surface">
		<div class="">
			<!-- Social media icons container -->
			<div class="flex items-center justify-center mb-6 space-x-2">
				<a href="#!" type="button"
					class="p-3 font-medium leading-normal uppercase transition duration-150 ease-in-out bg-transparent rounded-full text-surface hover:bg-neutral-100 focus:outline-none focus:ring-0"
					data-twe-ripple-init>
					<span class="mx-auto [&>svg]:h-4 [&>svg]:w-4">
						<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 512 512">
							<!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc. -->
							<path
								d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z" />
						</svg>
					</span>
				</a>

				<a href="#!" type="button"
					class="p-3 font-medium leading-normal uppercase transition duration-150 ease-in-out bg-transparent rounded-full text-surface hover:bg-neutral-100 focus:outline-none focus:ring-0"
					data-twe-ripple-init>
					<i class="fab fa-facebook-f"></i>
				</a>

				<a href="#!" type="button"
					class="p-3 font-medium leading-normal uppercase transition duration-150 ease-in-out bg-transparent rounded-full text-surface hover:bg-neutral-100 focus:outline-none focus:ring-0"
					data-twe-ripple-init>
					<span class="mx-auto [&>svg]:h-4 [&>svg]:w-4">
						<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 448 512">
							<!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc. -->
							<path
								d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z" />
						</svg>
					</span>
				</a>

				<a href="#!" type="button"
					class="p-3 font-medium leading-normal uppercase transition duration-150 ease-in-out bg-transparent rounded-full text-surface hover:bg-neutral-100 focus:outline-none focus:ring-0"
					data-twe-ripple-init>
					<span class="mx-auto [&>svg]:h-4 [&>svg]:w-4">
						<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 448 512">
							<!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc. -->
							<path
								d="M100.3 448H7.4V148.9h92.9zM53.8 108.1C24.1 108.1 0 83.5 0 53.8a53.8 53.8 0 0 1 107.6 0c0 29.7-24.1 54.3-53.8 54.3zM447.9 448h-92.7V302.4c0-34.7-.7-79.2-48.3-79.2-48.3 0-55.7 37.7-55.7 76.7V448h-92.8V148.9h89.1v40.8h1.3c12.4-23.5 42.7-48.3 87.9-48.3 94 0 111.3 61.9 111.3 142.3V448z" />
						</svg>
					</span>
				</a>
			</div>
		</div>

		<!--Copyright section-->
		<div class="w-full p-4 text-xs text-center bg-black/5">
			© 2025 Copyright:
			<a href=""> RMNCAH Hub </a>
		</div>
	</footer>
	<!-- Removed script that sets localStorage with undefined 'data' to fix ReferenceError. This should only be set after login. -->

	<script src="https://cdn.jsdelivr.net/npm/tw-elements/js/tw-elements.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
	<script src="styles/effects.js"></script>
	<script src="styles/loadNav.js"></script>
	<script src="styles/authnav.js"></script>

	<script>
		let map;
		let projects = [];
		let filteredProjects = [];
		let sortBy = "name";
		let sortOrder = "asc";
		let currentPage = 1;
		const itemsPerPage = 5;
		let currentFilter = "all";
		let searchQuery = "";
		let dateRangeFrom = null;
		let dateRangeTo = null;
		let themeFilter = "all";

		const mapMarkers = [];
		let stores = {
			type: "FeatureCollection",
			features: [],
		};

		const bgColors = {
			active: "bg-green-50",
			pending: "bg-yellow-50",
			stalled: "bg-red-50",
			completed: "bg-cyan-100",
			default: "bg-white",
		};

		const statusBadge = (tag) => {
			return (
				{
					active: "bg-green-200 text-green-800",
					pending: "bg-yellow-200 text-yellow-800",
					stalled: "bg-red-200 text-red-800",
					completed: "bg-cyan-300 text-gray-800",
				}[tag] || "bg-gray-200 text-gray-800"
			);
		};

		// Utility function to get file icon based on file type
		const getFileIcon = (fileType) => {
			const lowerType = (fileType || "").toLowerCase();
			if (lowerType.includes("pdf")) return "fa-file-pdf text-red-600";
			if (lowerType.includes("word") || lowerType.includes("doc"))
				return "fa-file-word text-blue-600";
			if (
				lowerType.includes("excel") ||
				lowerType.includes("xls") ||
				lowerType.includes("sheet")
			)
				return "fa-file-excel text-green-600";
			if (lowerType.includes("powerpoint") || lowerType.includes("ppt"))
				return "fa-file-powerpoint text-orange-600";
			return "fa-file text-gray-600";
		};

		// Format file size for display
		function formatFileSize(bytes) {
			if (!bytes) return "Unknown size";
			if (bytes < 1024) return bytes + " B";
			if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
			return (bytes / 1048576).toFixed(1) + " MB";
		}

		// Fetch project documents from API
		async function fetchProjectDocuments(projectId) {
			try {
				console.log(
					`[Documents] Fetching final report documents for project ID: ${projectId}`
				);
				const response = await authManager.apiCall(
					`/api/projects/${projectId}/reports/documents`,
					"GET"
				);

				console.log(`[Documents] Response status:`, response.status);

				if (response.ok) {
					const data = await response.json();
					console.log(`[Documents] Response data:`, data);

					if (data.status === 200 && data.data) {
						console.log(
							`[Documents] Found ${data.data.length} final report documents for project ${projectId}`
						);
						return data.data;
					} else {
						console.log(
							`[Documents] API returned non-200 status or no data:`,
							data
						);
					}
				} else {
					// Server error (500, etc)
					console.warn(
						`[Documents] API call failed with status ${response.status}`
					);
					try {
						const errorData = await response.json();
						console.error(`[Documents] Error details:`, errorData);
					} catch (e) {
						// Can't parse error response
					}
					return null; // Return null to indicate server error
				}
				return [];
			} catch (error) {
				console.error("[Documents] Error fetching documents:", error);
				return null; // Return null to indicate error
			}
		}

		// Render documents as downloadable links
		function renderDocuments(documents, projectId) {
			// Handle server error (null)
			if (documents === null) {
				return `<div class="p-3 bg-amber-50 border border-amber-200 rounded">
					<p class="text-sm text-amber-800 flex items-center">
						<i class="fas fa-exclamation-triangle mr-2"></i>
						Unable to load documents at this time. The server encountered an error.
					</p>
					<p class="text-xs text-amber-600 mt-1">
						This project may have documents, but they cannot be retrieved right now.
					</p>
				</div>`;
			}

			// Handle no documents (empty array)
			if (!documents || documents.length === 0) {
				return '<p class="text-sm text-gray-500 italic">No final report available</p>';
			}

			return documents
				.map(
					(doc) => `
				<div class="flex items-center justify-between py-2 border-b border-gray-100 hover:bg-gray-50 px-2 rounded">
					<div class="flex items-center space-x-3">
						<i class="fas ${getFileIcon(doc.fileType)} text-xl"></i>
						<div>
							<p class="text-sm font-medium text-gray-800">${doc.fileName}</p>
							<p class="text-xs text-gray-500">${formatFileSize(doc.fileSize)}</p>
						</div>
					</div>
					<a href="${window.BASE_URL}/api/projects/${projectId}/reports/documents/${doc.id
						}" 
					   target="_blank"
					   class="px-3 py-1 text-xs font-semibold text-white bg-blue-600 rounded hover:bg-blue-700 transition">
						<i class="fas fa-download mr-1"></i>Download
					</a>
				</div>
			`
				)
				.join("");
		}

		document.addEventListener("DOMContentLoaded", function () {
			// Initialize authentication and load user data
			initializeUserSession();

			// Set Mapbox access token
			mapboxgl.accessToken =
				"pk.eyJ1IjoibG9tb2dhbnRlY2giLCJhIjoiY2xzOTcyYXdlMDUxZDJsbXRnZGh2ZmpoYyJ9.sIWvONzgGPF2rtAcECsrJQ";

			// Initialize Mapbox map
			map = new mapboxgl.Map({
				container: "localMap",
				style: "mapbox://styles/lomogantech/clsa1f16r00wt01qqbnf741n6",
				center: [37.9062, -0.0236],
				zoom: 6.3,
			});

			// Add zoom and rotation controls to the map
			map.addControl(new mapboxgl.NavigationControl(), "top-right");

			// Load projects after map is initialized
			map.on("load", () => {
				loadProjectsForMap();
			});

			document
				.getElementById("searchInput")
				.addEventListener("input", (e) => {
					searchQuery = e.target.value.trim().toLowerCase();
					currentPage = 1;
					highlightMarkers(currentFilter);
				});

			document.getElementById("dateFrom").addEventListener("change", (e) => {
				dateRangeFrom = e.target.value ? new Date(e.target.value) : null;
				currentPage = 1;
				highlightMarkers(currentFilter);
			});

			document.getElementById("dateTo").addEventListener("change", (e) => {
				dateRangeTo = e.target.value ? new Date(e.target.value) : null;
				currentPage = 1;
				highlightMarkers(currentFilter);
			});

			document
				.getElementById("sortSelect")
				.addEventListener("change", (e) => {
					sortProjects(e.target.value);
				});

			document
				.getElementById("themeFilter")
				.addEventListener("change", (e) => {
					themeFilter = e.target.value;
					currentPage = 1;
					highlightMarkers(currentFilter);
				});
		});

		// Initialize map search functionality
		function initializeMapSearch() {
			// Initialize county and sub-county dropdowns with fixed Kenya locations
			initializeCountyDropdown("mapCountySelect", "mapSubCountySelect");

			// Add search button event listener
			document
				.getElementById("mapSearchBtn")
				.addEventListener("click", performMapSearch);
		}

		// Perform map search and zoom
		async function performMapSearch() {
			console.log("performMapSearch called");
			console.log("Total projects available:", projects.length);
			if (projects.length > 0) {
				console.log("First project structure:", Object.keys(projects[0]));
				console.log("First project data:", projects[0]);
			}

			const searchText = document
				.getElementById("mapSearchInput")
				.value.trim()
				.toLowerCase();
			const selectedCounty = document.getElementById("mapCountySelect").value;
			const selectedSubCounty =
				document.getElementById("mapSubCountySelect").value;

			console.log("Search criteria:", {
				searchText,
				selectedCounty,
				selectedSubCounty,
			});

			// Filter projects based on search criteria
			const matchingProjects = projects.filter((project) => {
				// Text search in multiple fields
				const searchFields = [
					project.projectName,
					project.title,
					project.projectNo,
					project.id?.toString(),
					project.name,
					project.code,
					project.projectCode,
				].filter((field) => field != null);

				// Also search in all string properties as fallback
				const allStringFields = Object.values(project).filter(
					(val) =>
						typeof val === "string" && val.toLowerCase().includes(searchText)
				);

				const nameMatch =
					!searchText ||
					searchFields.some((field) =>
						field.toString().toLowerCase().includes(searchText)
					) ||
					allStringFields.length > 0;

				if (searchText && nameMatch) {
					console.log(
						"Project matched search:",
						project.id,
						"Fields checked:",
						searchFields
					);
				}

				// Sub-County filter
				let subCountyMatch = true;
				if (selectedSubCounty) {
					subCountyMatch = false;
					if (project.locations && Array.isArray(project.locations)) {
						subCountyMatch = project.locations.some(
							(loc) => loc.subCounty === selectedSubCounty
						);
					} else if (project.subCounty === selectedSubCounty) {
						subCountyMatch = true;
					}
				}

				// County filter
				let countyMatch = true;
				if (selectedCounty) {
					countyMatch = false;
					if (project.locations && Array.isArray(project.locations)) {
						countyMatch = project.locations.some(
							(loc) => loc.county === selectedCounty
						);
					} else if (project.county === selectedCounty) {
						countyMatch = true;
					}
				}

				return nameMatch && subCountyMatch && countyMatch;
			});

			console.log("Matching projects found:", matchingProjects.length);
			if (matchingProjects.length > 0) {
				console.log("Sample matching project:", matchingProjects[0]);
			}

			// Get all matching locations
			const matchingLocations = [];
			matchingProjects.forEach((project) => {
				if (project.locations && Array.isArray(project.locations)) {
					project.locations.forEach((loc) => {
						if (loc.latitude && loc.longitude) {
							// Check county and sub-county filter for this specific location
							const countyMatch =
								!selectedCounty || loc.county === selectedCounty;
							const subCountyMatch =
								!selectedSubCounty || loc.subCounty === selectedSubCounty;
							if (countyMatch && subCountyMatch) {
								matchingLocations.push({
									lat: loc.latitude,
									lng: loc.longitude,
									project: project,
								});
							}
						}
					});
				}
				// Also check for direct latitude/longitude on the project
				if (project.latitude && project.longitude) {
					// For direct coordinates, check if county and sub-county matches (if filters are applied)
					const countyMatch =
						!selectedCounty || project.county === selectedCounty;
					const subCountyMatch =
						!selectedSubCounty || project.subCounty === selectedSubCounty;
					if (countyMatch && subCountyMatch) {
						matchingLocations.push({
							lat: project.latitude,
							lng: project.longitude,
							project: project,
						});
					}
				}
			});

			console.log("Matching locations found:", matchingLocations.length);

			if (matchingLocations.length === 0) {
				await showAlert(
					"No projects found matching your search criteria.",
					"No Results",
					"info"
				);
				return;
			}

			// Update search results info
			const resultsInfo = document.getElementById("searchResultsInfo");
			const resultsCount = document.getElementById("resultsCount");
			resultsCount.textContent = matchingProjects.length;
			resultsInfo.classList.remove("hidden");

			// Calculate bounds for all matching locations
			let minLat = Infinity,
				maxLat = -Infinity,
				minLng = Infinity,
				maxLng = -Infinity;

			matchingLocations.forEach((loc) => {
				minLat = Math.min(minLat, loc.lat);
				maxLat = Math.max(maxLat, loc.lat);
				minLng = Math.min(minLng, loc.lng);
				maxLng = Math.max(maxLng, loc.lng);
			});

			// Add some padding to the bounds
			const latPadding = (maxLat - minLat) * 0.1 || 0.01;
			const lngPadding = (maxLng - minLng) * 0.1 || 0.01;

			const bounds = [
				[minLng - lngPadding, minLat - latPadding],
				[maxLng + lngPadding, maxLat + latPadding],
			];

			// Fit map to bounds
			map.fitBounds(bounds, {
				padding: 50,
				maxZoom: 12,
			});

			// Highlight matching markers
			mapMarkers.forEach((marker, index) => {
				const markerElement = marker.getElement();
				if (markerElement) {
					const project = projects[index];
					const isMatch = matchingProjects.includes(project);

					// Change marker appearance based on match
					if (isMatch) {
						markerElement.style.opacity = "1";
						markerElement.style.transform = "scale(1.2)";
						markerElement.style.zIndex = "10";
					} else {
						markerElement.style.opacity = "0.3";
						markerElement.style.transform = "scale(1)";
						markerElement.style.zIndex = "1";
					}
				}
			});

			// If only one location, zoom in closer and open popup
			if (matchingLocations.length === 1) {
				const loc = matchingLocations[0];
				setTimeout(() => {
					map.flyTo({
						center: [loc.lng, loc.lat],
						zoom: 10,
					});

					// Find and open the popup for this marker
					mapMarkers.forEach((marker, index) => {
						const project = projects[index];
						if (project.id === loc.project.id) {
							marker.togglePopup();
						}
					});
				}, 1000);
			}
		}

		// Load projects for map display
		async function loadProjectsForMap() {
			try {
				// Use centralized BASE_URL from config.js
				const baseUrl = window.BASE_URL;
				console.log("[loadProjectsForMap] Using BASE_URL:", baseUrl);

				const response = await fetch(
					`${baseUrl}/api/projects/with-coordinates`,
					{
						headers: {
							Authorization: `Bearer ${authManager.getToken()}`,
						},
					}
				);

				if (response.ok) {
					const data = await response.json();
					console.log("Raw API response (with-coordinates):", data);
					// Handle API response structure: { status: 200, data: [...], message: "..." }
					let projectsData = [];
					if (data.status === 200 && data.data) {
						projectsData = Array.isArray(data.data) ? data.data : [];
					} else if (Array.isArray(data)) {
						projectsData = data;
					}

					console.log("Loaded projects for map:", projectsData.length);
					console.log("Projects data (with coordinates):", projectsData);

					// Set global projects array for search functionality
					projects = projectsData;

					// Process projects for map display
					addMarkersToMap(projectsData);

					// Initialize map search functionality
					initializeMapSearch();
				} else {
					console.warn("API response not OK, loading sample projects");
					loadSampleProjects();
				}
			} catch (error) {
				console.error("Error loading projects for map:", error);
				// Use sample data for demo
				loadSampleProjects();
			}
		}

		// Load sample projects for demo
		function loadSampleProjects() {
			const sampleProjects = [
				{
					id: 1,
					projectName: "Project 1",
					latitude: -1.2921,
					longitude: 36.8219,
					status: "ACTIVE",
				},
				{
					id: 2,
					projectName: "Project 2",
					latitude: -0.1023,
					longitude: 34.7619,
					status: "PENDING",
				},
				{
					id: 3,
					projectName: "Project 3",
					latitude: 0.3256,
					longitude: 37.1231,
					status: "STALLED",
				},
				{
					id: 4,
					projectName: "Project 4",
					latitude: -1.1504,
					longitude: 36.8907,
					status: "COMPLETED",
				},
			];
			projects = sampleProjects;
			updateMapWithProjects(sampleProjects);
			highlightMarkers("all");
		}

		// Add markers to Mapbox map (supports multiple locations per project)
		function addMarkersToMap(projectsData) {
			console.log(
				"addMarkersToMap called with",
				projectsData.length,
				"projects"
			);

			// Clear existing markers
			mapMarkers.forEach((marker) => marker.remove());
			mapMarkers.length = 0;

			// Add new markers
			projectsData.forEach((project, projectIndex) => {
				// Determine location list: prefer project.locations array, fall back to single lat/lng
				const locs =
					Array.isArray(project.locations) && project.locations.length
						? project.locations
						: project.latitude && project.longitude
							? [{ latitude: project.latitude, longitude: project.longitude }]
							: [];

				locs.forEach(async (loc, locIndex) => {
					const lat = loc.latitude;
					const lng = loc.longitude;

					if (!lat || !lng) {
						return; // Skip invalid locations
					}

					// Get detailed location information from Mapbox
					const detailedLocation = await getDetailedLocationFromCoordinates(
						lng,
						lat
					);
					if (detailedLocation) {
						loc.neighborhood = detailedLocation.neighborhood;
						loc.locality = detailedLocation.locality;
						loc.place = detailedLocation.place;
						loc.region = detailedLocation.region;
						loc.country = detailedLocation.country;
						loc.address = detailedLocation.address;
					}

					// Create marker element
					const el = document.createElement("div");
					el.className = "marker";
					el.innerHTML = `<i class="fas fa-map-marker-alt" style="font-size: 32px; color: ${getStatusColor(project.status)};"></i>`;
					el.style.cursor = "pointer";
					el.style.filter = "drop-shadow(0 2px 4px rgba(0,0,0,0.3))";

					// Create popup — include location-specific info when available
					const statusColor =
						project.status?.toLowerCase() === "active"
							? "bg-green-100 text-green-800 border-green-200"
							: project.status?.toLowerCase() === "pending"
								? "bg-yellow-100 text-yellow-800 border-yellow-200"
								: project.status?.toLowerCase() === "completed"
									? "bg-blue-100 text-blue-800 border-blue-200"
									: project.status?.toLowerCase() === "stalled"
										? "bg-red-100 text-red-800 border-red-200"
										: "bg-gray-100 text-gray-800 border-gray-200";

					const popupHtml = `
                <div class="max-w-sm bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden relative">
                  <div class="px-4 py-3 bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="text-lg font-bold text-gray-900 leading-tight pr-2 flex-1">
                      <span class="block">${project.projectName || project.title || "Project"
						}</span>
                      ${project.projectNo
							? `<span class="text-sm font-normal text-gray-600 mt-1 block">(${project.projectNo})</span>`
							: ""
						}
                    </h3>
                    <button onclick="this.closest('.mapboxgl-popup').style.display='none'"
                      class="flex-shrink-0 w-6 h-6 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-600 hover:text-gray-800 flex items-center justify-center transition duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">
                      <i class="fas fa-times text-xs"></i>
                    </button>
                  </div>

                  <div class="px-4 py-3 space-y-2">
                    <div class="flex items-center justify-between">
                      <span class="text-sm font-medium text-gray-600">Status:</span>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-semibold border ${statusColor}">
                        ${project.status || "N/A"}
                      </span>
                    </div>

                    <div class="space-y-1">
                      <div class="flex items-center space-x-2">
                        <i class="fas fa-map-marker-alt text-gray-400 text-sm"></i>
                        <span class="text-sm text-gray-700 font-medium">${loc.subCounty ||
						loc.county ||
						loc.neighborhood ||
						loc.locality ||
						loc.place ||
						project.region ||
						project.county ||
						"N/A"
						}</span>
                      </div>
                      ${loc.county
							? `
                      <div class="flex items-center space-x-2 ml-5">
                        <i class="fas fa-map text-gray-400 text-xs"></i>
                        <span class="text-xs text-gray-600">${loc.county}</span>
                      </div>
                      `
							: ""
						}
                      ${loc.mapsAddress || loc.address
							? `
                      <div class="flex items-center space-x-2 ml-5">
                        <i class="fas fa-location-arrow text-gray-400 text-xs"></i>
                        <span class="text-xs text-gray-600">${loc.mapsAddress || loc.address
							}</span>
                      </div>
                      `
							: ""
						}
                    </div>

                    ${project.budget
							? `
                    <div class="flex items-center space-x-2">
                      <span class="text-sm font-medium text-gray-400">KES</span>
                      <span class="text-sm text-gray-700">${Number(
								project.budget
							).toLocaleString()}</span>
                    </div>
                    `
							: ""
						}

                    <div class="pt-2 border-t border-gray-100">
                      <button onclick="viewProject(${project.id})"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md transition duration-200 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <i class="fas fa-eye mr-2"></i>View Details
                      </button>
                    </div>
                  </div>
                </div>`;

					const popup = new mapboxgl.Popup({
						offset: 25,
						closeButton: false,
						closeOnClick: false,
					}).setHTML(popupHtml);

					// Create and add marker
					const marker = new mapboxgl.Marker(el)
						.setLngLat([lng, lat])
						.setPopup(popup)
						.addTo(map);

					// Attach data for other UI code that expects marker.data
					try {
						marker.data = Object.assign({}, project, {
							lat,
							lng,
							location: loc,
							locationIndex: locIndex,
						});
					} catch (e) {
						// ignore
					}

					// Add click event
					el.addEventListener("click", async () => {
						map.flyTo({ center: [lng, lat], zoom: 12 });

						// If detailed location is missing, try to get it from coordinates
						if (
							!loc.neighborhood &&
							!loc.locality &&
							!loc.place &&
							!loc.region
						) {
							const detailedLocation =
								await getDetailedLocationFromCoordinates(lng, lat);
							if (detailedLocation) {
								loc.neighborhood = detailedLocation.neighborhood;
								loc.locality = detailedLocation.locality;
								loc.place = detailedLocation.place;
								loc.region = detailedLocation.region;
								loc.country = detailedLocation.country;
								loc.address = detailedLocation.address;
								// Update popup content with new location data
								const popup = marker.getPopup();
								if (popup) {
									// Re-render popup with updated location data
									const updatedPopupHtml = popupHtml.replace(
										/loc\.neighborhood|\bloc\.locality|\bloc\.place|\bloc\.region|\bloc\.address/g,
										(match) => {
											const prop = match.split(".")[1];
											return loc[prop] || "N/A";
										}
									);
									popup.setHTML(updatedPopupHtml);
								}
							}
						}
					});

					mapMarkers.push(marker);
				});
			});
		}

		// Get detailed location info from coordinates using Mapbox Geocoding API
		async function getDetailedLocationFromCoordinates(longitude, latitude) {
			try {
				const response = await fetch(
					`https://api.mapbox.com/geocoding/v5/mapbox.places/${longitude},${latitude}.json?types=address,poi,neighborhood,locality,place,region,country&access_token=${mapboxgl.accessToken}`
				);
				const data = await response.json();
				console.log(
					`Mapbox API response for [${longitude}, ${latitude}]:`,
					data
				);
				if (data.features && data.features.length > 0) {
					const feature = data.features[0];
					const context = feature.context || [];

					// Extract different location components
					const locationInfo = {
						address: feature.place_name,
						neighborhood: null,
						locality: null,
						place: null,
						region: null,
						country: null,
					};

					// Parse context for detailed information
					context.forEach((ctx) => {
						if (ctx.id.startsWith("neighborhood.")) {
							locationInfo.neighborhood = ctx.text;
						} else if (ctx.id.startsWith("locality.")) {
							locationInfo.locality = ctx.text;
						} else if (ctx.id.startsWith("place.")) {
							locationInfo.place = ctx.text;
						} else if (ctx.id.startsWith("region.")) {
							locationInfo.region = ctx.text;
						} else if (ctx.id.startsWith("country.")) {
							locationInfo.country = ctx.text;
						}
					});

					console.log(`Parsed location info:`, locationInfo);
					return locationInfo;
				}
			} catch (error) {
				console.error(
					"Error getting detailed location from coordinates:",
					error
				);
			}
			return null;
		}

		// Update a specific project accordion item
		function updateProjectAccordionItem(index) {
			const project = projects[index];
			const collapseDiv = document.getElementById(`collapse-${index}`);
			if (collapseDiv) {
				const statusBg = statusBadge(project.status?.toLowerCase());
				collapseDiv.innerHTML = `
            <p><strong>County:</strong> ${project.county || project.region || ""
					}</p>
            <p><strong>Budget:</strong> ${project.budget || ""}</p>
            <p><strong>Partner:</strong> ${project.partner || ""}</p>
            <p><strong>Status:</strong> 
                <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBg}">
                    ${project.status || ""}
                </span>
            </p>
            <button onclick="focusMarker(${index})" class="px-5 py-2 mt-3 text-sm font-semibold text-white transition bg-blue-600 rounded hover:bg-blue-700 hover:scale-105">
                Show on Map
            </button>
          `;
			}
		}

		// Get status color
		function getStatusColor(status) {
			const colors = {
				ACTIVE: "#22c55e",
				PENDING: "#eab308",
				STALLED: "#ef4444",
				COMPLETED: "#06b6d4",
			};
			return colors[status] || "#6b7280";
		}

		// Comes From DB
		async function showProjectInfo(project) {
			const infoBox = document.getElementById("projectInfo");
			infoBox.classList.remove("hidden");

			const color = getStatusColor(project.status);
			const statusBg = statusBadge(project.status?.toLowerCase());

			// Show initial info without documents
			infoBox.innerHTML = `
				<div class="px-6 py-5 mb-4 rounded-lg border-l-4 shadow-sm" 
					style="border-left-color: ${color}; background-color: ${color}10;">
					
					<h3 class="text-xl font-bold text-gray-800 mb-2">
						${project.name || project.projectName || "Unnamed Project"}
					</h3>
					
					<p class="text-sm text-gray-700 leading-relaxed mb-4">
						${project.description || "No detailed description provided for this project."}
					</p>

					<div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-2 text-sm text-gray-700">
						<p><strong>Region:</strong> ${project.region || project.county || "Not specified"
				}</p>
						<p><strong>Budget:</strong> ${project.budget
					? "KES " + Number(project.budget).toLocaleString()
					: "N/A"
				}</p>
						<p><strong>Team:</strong> ${project.team || "Not specified"}</p>
						<p><strong>Participants:</strong> ${project.participants || "Not specified"}</p>
						<p><strong>Sponsor:</strong> ${project.sponsor || "Not specified"}</p>
						<p><strong>Start Date:</strong> ${project.start_date
					? new Date(project.start_date).toLocaleDateString()
					: "Not specified"
				}</p>
						<p><strong>Status:</strong> 
							<span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBg}">
								${project.status || "Ongoing"}
							</span>
					</p>
				</div>

				<div class="mt-4 pt-4 border-t">
					<h4 class="text-md font-semibold text-gray-800 mb-2 flex items-center">
						<i class="fas fa-paperclip mr-2"></i>Final Report
					</h4>
					<div id="project-documents-display" class="space-y-2">
						<p class="text-sm text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading documents...</p>
					</div>
				</div>					<button onclick="focusMarker(${projects.findIndex(
					(p) => p.id === project.id
				)})"
						class="mt-4 px-5 py-2 text-sm font-semibold text-white bg-blue-600 rounded hover:bg-blue-700 hover:scale-105 transition">
						Locate on Map
					</button>
				</div>
			`;

			// Fetch and display documents if project has an ID
			if (project.id) {
				const documents = await fetchProjectDocuments(project.id);
				const documentsDisplay = document.getElementById(
					"project-documents-display"
				);
				if (documentsDisplay) {
					documentsDisplay.innerHTML = renderDocuments(documents, project.id);
				}
			}
		}

		function focusMarker(index) {
			if (projects[index]) {
				const project = projects[index];

				// Get all locations for this project (similar to search logic)
				const projectLocations = [];
				if (project.locations && Array.isArray(project.locations)) {
					project.locations.forEach((loc) => {
						if (loc.latitude && loc.longitude) {
							projectLocations.push({
								lat: loc.latitude,
								lng: loc.longitude,
								project: project,
							});
						}
					});
				}
				// Also check for direct latitude/longitude on the project
				if (
					project.latitude &&
					project.longitude &&
					projectLocations.length === 0
				) {
					projectLocations.push({
						lat: project.latitude,
						lng: project.longitude,
						project: project,
					});
				}

				if (projectLocations.length === 0) {
					console.warn("No valid locations found for project:", project.id);
					return;
				}

				// Calculate bounds for all project locations
				let minLat = Infinity,
					maxLat = -Infinity,
					minLng = Infinity,
					maxLng = -Infinity;

				projectLocations.forEach((loc) => {
					minLat = Math.min(minLat, loc.lat);
					maxLat = Math.max(maxLat, loc.lat);
					minLng = Math.min(minLng, loc.lng);
					maxLng = Math.max(maxLng, loc.lng);
				});

				// Add some padding to the bounds
				const latPadding = (maxLat - minLat) * 0.1 || 0.01;
				const lngPadding = (maxLng - minLng) * 0.1 || 0.01;

				const bounds = [
					[minLng - lngPadding, minLat - latPadding],
					[maxLng + lngPadding, maxLat + latPadding],
				];

				// Fit map to bounds
				map.fitBounds(bounds, {
					padding: 50,
					maxZoom: 12,
				});

				// Highlight this project's markers
				mapMarkers.forEach((marker, markerIndex) => {
					const markerElement = marker.getElement();
					if (markerElement) {
						const markerProject = projects[markerIndex];
						const isMatch = markerProject && markerProject.id === project.id;

						// Change marker appearance based on match
						if (isMatch) {
							markerElement.style.opacity = "1";
							markerElement.style.transform = "scale(1.2)";
							markerElement.style.zIndex = "10";
						} else {
							markerElement.style.opacity = "0.3";
							markerElement.style.transform = "scale(1)";
							markerElement.style.zIndex = "1";
						}
					}
				});

				// If only one location, zoom in closer and open popup
				if (projectLocations.length === 1) {
					const loc = projectLocations[0];
					setTimeout(() => {
						map.flyTo({
							center: [loc.lng, loc.lat],
							zoom: 12,
						});

						// Find and open the popup for this marker
						mapMarkers.forEach((marker, markerIndex) => {
							const markerProject = projects[markerIndex];
							if (markerProject && markerProject.id === project.id) {
								marker.togglePopup();
							}
						});
					}, 1000);
				}

				// Scroll map into view
				document
					.getElementById("localMap")
					.scrollIntoView({ behavior: "smooth" });
			}
		}

		function sortProjects(field) {
			if (sortBy === field) {
				sortOrder = sortOrder === "asc" ? "desc" : "asc";
			} else {
				sortBy = field;
				sortOrder = "asc";
			}
			currentPage = 1;
			highlightMarkers(currentFilter);
		}

		function applyStatusFilter(status) {
			currentFilter = status;
			currentPage = 1;
			highlightMarkers(currentFilter);
		}

		function highlightMarkers(tag) {
			currentFilter = tag;
			console.log("highlightMarkers called with tag:", tag);
			console.log("Total projects available:", projects.length);
			console.log("Projects:", projects);

			const accordion = document.getElementById("projectAccordion");
			const infoBox = document.getElementById("projectInfo");
			infoBox.classList.add("hidden");
			accordion.innerHTML = "";
			accordion.classList.remove("hidden");
			accordion.classList.add("opacity-0", "translate-y-4");

			let filteredProjects = projects.filter((project) => {
				if (tag !== "all" && project.status?.toLowerCase() !== tag)
					return false;

				// Text search in multiple fields (project name, number, code, etc.)
				if (searchQuery) {
					const searchFields = [
						project.projectName,
						project.title,
						project.projectNo,
						project.id?.toString(),
						project.name,
						project.code,
						project.projectCode,
					].filter((field) => field != null);

					// Also search in all string properties as fallback
					const allStringFields = Object.values(project).filter(
						(val) =>
							typeof val === "string" &&
							val.toLowerCase().includes(searchQuery)
					);

					const nameMatch =
						searchFields.some((field) =>
							field.toString().toLowerCase().includes(searchQuery)
						) || allStringFields.length > 0;

					console.log(
						`Project ${project.id} (${project.title
						}): searchQuery="${searchQuery}", searchFields=[${searchFields.join(
							", "
						)}], allStringFields=${allStringFields.length
						}, nameMatch=${nameMatch}`
					);

					if (!nameMatch) return false;
				}

				if (
					dateRangeFrom &&
					new Date(project.startDate) < new Date(dateRangeFrom)
				)
					return false;
				if (
					dateRangeTo &&
					new Date(project.startDate) > new Date(dateRangeTo)
				)
					return false;
				// Theme filtering
				if (themeFilter !== "all") {
					let projectThemes = [];
					if (project.themes && Array.isArray(project.themes)) {
						projectThemes = project.themes;
					} else if (project.theme) {
						projectThemes = [project.theme];
					}
					const hasMatchingTheme = projectThemes.some((theme) => {
						const themeCode = typeof theme === "string" ? theme : theme?.code;
						return themeCode === themeFilter;
					});
					if (!hasMatchingTheme) return false;
				}
				return true;
			});

			console.log("Filtered projects count:", filteredProjects.length);
			console.log("Filtered projects:", filteredProjects);

			filteredProjects.sort((a, b) => {
				const aVal =
					sortBy === "name" ? a.projectName : new Date(a.startDate);
				const bVal =
					sortBy === "name" ? b.projectName : new Date(b.startDate);
				return sortOrder === "asc"
					? aVal > bVal
						? 1
						: -1
					: aVal < bVal
						? 1
						: -1;
			});

			const totalPages = Math.ceil(filteredProjects.length / itemsPerPage);
			const paginated = filteredProjects.slice(
				(currentPage - 1) * itemsPerPage,
				currentPage * itemsPerPage
			);
			updatePaginationControls(totalPages);

			// Update marker visibility (don't recreate markers)
			mapMarkers.forEach((marker, idx) => {
				const project = projects[idx];
				const isVisible = filteredProjects.includes(project);
				if (marker.getElement()) {
					marker.getElement().style.opacity = isVisible ? "1" : "0.2";
				}
			});

			setTimeout(
				() => accordion.classList.remove("opacity-0", "translate-y-4"),
				10
			);

			// ✅ New full-display design (no accordion)
			paginated.forEach((project, idx) => {
				const i = projects.indexOf(project);
				const color = getStatusColor(project.status);
				const bg =
					bgColors[project.status?.toLowerCase()] || bgColors.default;

				const item = document.createElement("div");
				item.className = `rounded-lg shadow-sm mb-4 border-l-4 ${bg}`;
				item.style.borderLeftColor = color;

				item.innerHTML = `
			<div class="px-6 py-5" style="background-color: ${color}10;">
				<span>${project.projectNo ? ` (${project.projectNo})` : ""}</span>
				<h4 class="text-lg font-semibold text-gray-800 mb-2">
					
					${project.projectName || project.title || "Untitled Project"}</h4>
				
				<p class="text-sm text-gray-700 leading-relaxed mb-3">
					${project.description ||
					project.objectives ||
					"This project currently has no description provided."
					}
				</p>

				<p class="text-sm text-gray-700 mb-2">
					Located in <strong>${(() => {
						const locationParts = [];
						// Check if project has locations array with detailed info
						if (
							project.locations &&
							Array.isArray(project.locations) &&
							project.locations.length > 0
						) {
							const primaryLoc = project.locations[0]; // Use first location for summary
							if (primaryLoc.subCounty)
								locationParts.push(primaryLoc.subCounty);
							if (primaryLoc.county) locationParts.push(primaryLoc.county);
							if (primaryLoc.region && primaryLoc.region !== primaryLoc.county)
								locationParts.push(primaryLoc.region);
						}
						// Fallback to direct project properties
						if (locationParts.length === 0) {
							if (project.subCounty) locationParts.push(project.subCounty);
							if (project.county) locationParts.push(project.county);
							if (project.region && project.region !== project.county)
								locationParts.push(project.region);
						}
						return locationParts.length > 0
							? locationParts.join(", ")
							: "an unspecified region";
					})()}</strong>,
					this project ${project.partner
						? `is supported by <strong>${project.partner}</strong>`
						: "has partners to be announced"
					} 
					with an estimated budget of <strong>${project.budget
						? "KES " + Number(project.budget).toLocaleString()
						: "N/A"
					}</strong>.
				</p>

				<p class="text-sm text-gray-700 mb-2">
					Status: <span class="inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge(
						project.status?.toLowerCase()
					)}">
						${project.status || "Ongoing"}
					</span>
				</p>

				<p class="text-sm text-gray-700 mb-2">
					Started on: ${project.startDate
						? new Date(project.startDate).toLocaleDateString()
						: "Not specified"
					}
			</p>

			${project.themes &&
						Array.isArray(project.themes) &&
						project.themes.length > 0
						? `
			<p class="text-sm text-gray-700 mb-2">
				Themes: 
				<span class="inline-flex flex-wrap gap-1">
					${project.themes
							.slice(0, 3)
							.map((theme) => {
								const themeName =
									typeof theme === "string"
										? theme
										: theme.name || theme.code || theme;
								const themeCode =
									typeof theme === "string"
										? theme
										: theme.code || theme.name || theme;
								const themeClass =
									{
										MNH: "bg-pink-100 text-pink-800",
										FP: "bg-blue-100 text-blue-800",
										GBV: "bg-red-100 text-red-800",
										CH: "bg-green-100 text-green-800",
										AH: "bg-purple-100 text-purple-800",
										AYPSRH: "bg-indigo-100 text-indigo-800",
									}[themeCode] || "bg-gray-100 text-gray-800";
								return `<span class="px-2 py-1 rounded text-xs font-medium ${themeClass}">${themeName}</span>`;
							})
							.join("")}
					${project.themes.length > 3
							? `<span class="text-xs text-gray-500">+${project.themes.length - 3
							} more</span>`
							: ""
						}
				</span>
			</p>
			`
						: ""
					}

			<div class="mt-4 pt-4 border-t border-gray-300">
				<h5 class="text-md font-semibold text-gray-800 mb-2 flex items-center">
					<i class="fas fa-paperclip mr-2"></i>Final Report
				</h5>
				<div id="project-docs-${i}" class="space-y-2">
					<p class="text-sm text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading documents...</p>
				</div>
			</div>				<button onclick="focusMarker(${i})" 
					class="mt-3 px-5 py-2 text-sm font-semibold text-white bg-blue-600 rounded hover:bg-blue-700 hover:scale-105 transition">
					Locate on Map
				</button>
			</div>
		`;

				accordion.appendChild(item);

				// Load documents asynchronously after rendering
				if (project.id) {
					fetchProjectDocuments(project.id).then((documents) => {
						const docsContainer = document.getElementById(
							`project-docs-${i}`
						);
						if (docsContainer) {
							docsContainer.innerHTML = renderDocuments(
								documents,
								project.id
							);
						}
					});
				}
			});
		}

		function updatePaginationControls(totalPages) {
			const container = document.getElementById("paginationControls");
			container.innerHTML = "";
			for (let i = 1; i <= totalPages; i++) {
				const btn = document.createElement("button");
				btn.textContent = i;
				btn.className = `px-3 py-1 rounded ${i === currentPage
					? "bg-blue-600 text-white"
					: "bg-gray-100 text-gray-800 hover:bg-gray-200"
					}`;
				btn.onclick = () => {
					currentPage = i;
					highlightMarkers(currentFilter);
				};
				container.appendChild(btn);
			}
		}

		function exportCSV() {
			const headers = [
				"Name",
				"Description",
				"Region",
				"Budget",
				"Status",
				"Start Date",
				"Themes",
			];
			const rows = projects
				.filter((p) => {
					// Text search in multiple fields (same as highlightMarkers)
					if (searchQuery) {
						const searchFields = [
							p.projectName,
							p.title,
							p.projectNo,
							p.id?.toString(),
							p.name,
							p.code,
							p.projectCode,
						].filter((field) => field != null);

						// Also search in all string properties as fallback
						const allStringFields = Object.values(p).filter(
							(val) =>
								typeof val === "string" &&
								val.toLowerCase().includes(searchQuery)
						);

						const nameMatch =
							searchFields.some((field) =>
								field.toString().toLowerCase().includes(searchQuery)
							) || allStringFields.length > 0;

						if (!nameMatch) return false;
					}

					const date = new Date(p.startDate);
					if (dateRangeFrom && date < dateRangeFrom) return false;
					if (dateRangeTo && date > dateRangeTo) return false;
					if (
						currentFilter !== "all" &&
						p.status?.toLowerCase() !== currentFilter
					)
						return false;
					// Theme filtering
					if (themeFilter !== "all") {
						let projectThemes = [];
						if (p.themes && Array.isArray(p.themes)) {
							projectThemes = p.themes;
						} else if (p.theme) {
							projectThemes = [p.theme];
						}
						const hasMatchingTheme = projectThemes.some((theme) => {
							const themeCode =
								typeof theme === "string" ? theme : theme?.code;
							return themeCode === themeFilter;
						});
						if (!hasMatchingTheme) return false;
					}
					return true;
				})
				.map((p) => {
					// Get theme names
					let projectThemes = [];
					if (p.themes && Array.isArray(p.themes)) {
						projectThemes = p.themes;
					} else if (p.theme) {
						projectThemes = [p.theme];
					}
					const themeNames = projectThemes
						.map((theme) => {
							const themeCode =
								typeof theme === "string" ? theme : theme?.code;
							return themeDefinitions[themeCode]?.name || themeCode;
						})
						.join("; ");

					return [
						p.projectName || "",
						(p.description || "").replace(/,/g, ";"),
						p.region || p.county || "",
						p.budget || "",
						p.status || "",
						p.startDate ? new Date(p.startDate).toLocaleDateString() : "",
						themeNames,
					];
				});

			let csvContent = [headers.join(",")];
			rows.forEach((r) =>
				csvContent.push(r.map((val) => `"${val}"`).join(","))
			);

			const blob = new Blob([csvContent.join("\n")], { type: "text/csv" });
			const link = document.createElement("a");
			link.href = URL.createObjectURL(blob);
			link.download = `projects_${new Date().toISOString().split("T")[0]
				}.csv`;
			link.click();
		}
	</script>

	<script>
		function countdownStats() {
			return {
				locations: 0,
				projects: 0,
				regions: 0,
				users: 0,
				amount: 0,
				amountDisplay: "Loading...",

				targets: {
					locations: 0,
					projects: 0,
					regions: 0,
					users: 0,
					amount: 0,
				},

				duration: 1500, // in ms
				steps: 30,

				// Handle stats loaded event
				handleStatsLoaded(data) {
					console.log("[DEBUG] handleStatsLoaded called with:", data);
					this.targets = { ...data };
					this.start();
				},

				// number formatter
				formatAmount(value) {
					if (value >= 1e12) return (value / 1e12).toFixed(2) + "Tn";
					if (value >= 1e9) return (value / 1e9).toFixed(2) + "Bn";
					if (value >= 1e6) return (value / 1e6).toFixed(2) + "Mn";
					if (value >= 1e3) return (value / 1e3).toFixed(2) + "K";
					return value.toString();
				},

				start() {
					console.log("[DEBUG] start() called with targets:", this.targets);

					// Update targets if statsData is available
					if (window.statsData) {
						this.targets = { ...window.statsData };
						console.log(
							"[DEBUG] Updated targets from statsData:",
							this.targets
						);
					}

					const interval = this.duration / this.steps;

					let currentStep = 0;
					const timer = setInterval(() => {
						currentStep++;
						const progress = currentStep / this.steps;

						this.locations = Math.floor(this.targets.locations * progress);
						this.projects = Math.floor(this.targets.projects * progress);
						this.regions = Math.floor(this.targets.regions * progress);
						this.users = Math.floor(this.targets.users * progress);
						this.amount = Math.floor(this.targets.amount * progress);

						// use formatter here
						this.amountDisplay = "" + this.formatAmount(this.amount);

						if (currentStep >= this.steps) {
							// Ensure final values are exact
							this.locations = this.targets.locations;
							this.projects = this.targets.projects;
							this.regions = this.targets.regions;
							this.users = this.targets.users;
							this.amount = this.targets.amount;
							this.amountDisplay = "" + this.formatAmount(this.amount);
							console.log("[DEBUG] Animation complete. Final values:", {
								locations: this.locations,
								projects: this.projects,
								regions: this.regions,
								users: this.users,
								amount: this.amount,
								amountDisplay: this.amountDisplay,
							});
							clearInterval(timer);
						}
					}, interval);
				},
			};
		}

		// User session initialization
		async function initializeUserSession() {
			console.log(
				"[DEBUG] initializeUserSession: Starting user session initialization"
			);

			// Check if user is authenticated
			if (!authManager.isAuthenticated()) {
				console.log("[DEBUG] initializeUserSession: User not authenticated");
				await showAlert(
					"You must be logged in to access this page. (See console for details)",
					"Authentication Required",
					"warning"
				);
				// Redirect to index.html if not logged in
				window.location.href = "index.html";
				return;
			}

			console.log("[DEBUG] initializeUserSession: User is authenticated");

			// Check for demo token
			const demoToken =
				"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJkZW1vQGVtYWlsLmNvbSIsInJvbGUiOiJVU0VSIiwiaWF0IjoxNjk1ODQwMDAwLCJleHAiOjE5MDAwMDAwMDB9.dummysignature";
			const token = authManager.getToken();
			if (token === demoToken) {
				console.log("[DEBUG] initializeUserSession: Using demo token");
				// Use a fake user object for demo
				const user = {
					id: 1,
					name: "Demo User",
					email: "demo@email.com",
					role: "USER",
					approvalStatus: "APPROVED",
				};
				updateUserDisplayWhenNavReady(user);
				await loadDashboardData();
				return;
			}

			try {
				console.log(
					"[DEBUG] initializeUserSession: Attempting to load current user data"
				);
				// Load current user data
				const user = await authManager.getCurrentUser();
				console.log(
					"[DEBUG] initializeUserSession: User data loaded successfully",
					user
				);

				// Update UI with user information
				updateUserDisplayWhenNavReady(user);

				// Check if user is approved
				if (user.approvalStatus !== "APPROVED") {
					console.log(
						"[DEBUG] initializeUserSession: User not approved, status:",
						user.approvalStatus
					);
					showApprovalPendingMessage(user);
				} else {
					console.log("[DEBUG] initializeUserSession: User is approved");
				}

				// Load dashboard data
				console.log("[DEBUG] initializeUserSession: Loading dashboard data");
				await loadDashboardData();
				console.log(
					"[DEBUG] initializeUserSession: Initialization completed successfully"
				);
			} catch (error) {
				console.error(
					"[DEBUG] initializeUserSession: Failed to load user session:",
					error
				);
				await showAlert(
					"Failed to load user session. Please log in again.",
					"Session Error",
					"error"
				);
				authManager.logout();
			}
		}

		// Load dashboard statistics and projects from API
		async function loadDashboardData() {
			try {
				console.log("Loading dashboard data...");
				// Load project statistics
				await loadProjectStatistics();
				// Load projects list (default: all projects)
				await loadProjects();
				// Load theme statistics (after projects are loaded)
				await loadThemeStatistics();
				// Optionally, load map-only projects
				// await loadProjectsWithCoordinates();
				console.log("Dashboard data loaded successfully");
			} catch (error) {
				console.error("Failed to load dashboard data:", error);
				showDashboardError();
			}
		}

		// Theme definitions with metadata
		const themeDefinitions = {
			GBV: {
				name: "Gender-Based Violence",
				description:
					"Programs focused on preventing and responding to gender-based violence across communities.",
				icon: "far fa-venus-mars",
				color: "text-pink-400",
			},
			AYPSRH: {
				name: "Adolescent and Young People Sexual and Reproductive Health",
				description:
					"Comprehensive sexual and reproductive health services for adolescents and young people.",
				icon: "far fa-heart px-2",
				color: "text-red-400",
			},
			MNH: {
				name: "Maternal and Newborn Health",
				description:
					"Programs dedicated to improving maternal and newborn health outcomes.",
				icon: "far fa-baby",
				color: "text-blue-400",
			},
			FP: {
				name: "Family Planning",
				description:
					"Family planning services and education to support reproductive choices.",
				icon: "far fa-users",
				color: "text-green-400",
			},
			CH: {
				name: "Child Health",
				description: "Comprehensive child health programs and interventions.",
				icon: "far fa-child",
				color: "text-purple-400",
			},
			AH: {
				name: "Adolescent Health",
				description: "Health programs specifically designed for adolescents.",
				icon: "far fa-user-graduate",
				color: "text-orange-400",
			},
		};

		// Load theme statistics from projects
		async function loadThemeStatistics() {
			try {
				console.log("Loading theme statistics...");

				// Use the projects that are already loaded by loadProjects
				if (!projects || projects.length === 0) {
					console.warn(
						"No projects loaded yet, using defaults for theme statistics"
					);
					renderDefaultThematicAreas();
					return;
				}

				console.log(
					"Calculating theme statistics from",
					projects.length,
					"projects"
				);

				// Calculate theme statistics
				const themeStats = {};

				// Initialize all themes with zero counts
				Object.keys(themeDefinitions).forEach((themeCode) => {
					themeStats[themeCode] = {
						projectCount: 0,
						locationCount: 0,
						locations: new Set(),
					};
				});

				// Count projects and locations per theme
				projects.forEach((project) => {
					// Handle both single theme (legacy) and multiple themes
					let projectThemes = [];
					if (project.themes && Array.isArray(project.themes)) {
						projectThemes = project.themes;
					} else if (project.theme) {
						// Legacy single theme support
						projectThemes = [project.theme];
					}

					console.log(
						"Project:",
						project.title || project.name,
						"themes:",
						projectThemes
					);

					projectThemes.forEach((theme) => {
						// Extract theme code - handle both string and object formats
						let themeCode;
						if (typeof theme === "string") {
							themeCode = theme;
						} else if (theme && theme.code) {
							themeCode = theme.code;
						} else {
							return; // Skip invalid theme entries
						}

						if (themeStats[themeCode]) {
							themeStats[themeCode].projectCount++;

							// Count unique locations for this theme
							if (project.locations && Array.isArray(project.locations)) {
								project.locations.forEach((location) => {
									if (location.county) {
										themeStats[themeCode].locations.add(location.county);
									}
								});
							} else if (project.county) {
								// Legacy single location support
								themeStats[themeCode].locations.add(project.county);
							}
						}
					});
				});

				// Update location counts
				Object.keys(themeStats).forEach((themeCode) => {
					themeStats[themeCode].locationCount =
						themeStats[themeCode].locations.size;
				});

				console.log("Calculated theme statistics:", themeStats);

				// Render thematic areas
				renderThematicAreas(themeStats);
			} catch (error) {
				console.error("Error loading theme statistics:", error);
				renderDefaultThematicAreas();
			}
		}

		// Render thematic areas with dynamic data
		function renderThematicAreas(themeStats) {
			const container = document.getElementById("thematicAreasContainer");
			if (!container) {
				console.error("Thematic areas container not found");
				return;
			}

			let html = "";

			Object.keys(themeDefinitions).forEach((themeCode) => {
				const theme = themeDefinitions[themeCode];

				html += `
            <div class="bg-gray-50 rounded-xl shadow hover:shadow-md transition p-6 flex flex-col justify-between">
              <div class="flex items-center">
                <div class="text-left rounded-lg h-9 w-9 bg-gray-100/70 shadow-md flex items-center text-white justify-center mb-2">
                  <i class="${theme.icon} ${theme.color} text-lg"></i>
                </div>
                <h3 class="text-xl ml-3 font-medium uppercase text-black">
                  ${theme.name}
                </h3>
              </div>
              <hr class="my-2" />
              <p class="text-lg text-gray-600">
                ${theme.description}
              </p>
            </div>
          `;
			});

			container.innerHTML = html;
			console.log("Rendered thematic areas with definitions only");
		}

		// Render default thematic areas when API fails
		function renderDefaultThematicAreas() {
			const container = document.getElementById("thematicAreasContainer");
			if (!container) return;

			let html = "";

			Object.keys(themeDefinitions).forEach((themeCode) => {
				const theme = themeDefinitions[themeCode];

				html += `
            <div class="bg-gray-50 rounded-xl shadow hover:shadow-md transition p-6 flex flex-col justify-between">
              <div class="flex items-center">
                <div class="text-left rounded-lg h-9 w-9 bg-gray-100/70 shadow-md flex items-center text-white justify-center mb-2">
                  <i class="${theme.icon} ${theme.color} text-lg"></i>
                </div>
                <h3 class="text-xl ml-3 font-medium uppercase text-black">
                  ${theme.name}
                </h3>
              </div>
              <hr class="my-2" />
              <p class="text-lg text-gray-600">
                ${theme.description}
              </p>
            </div>
          `;
			});

			container.innerHTML = html;
			console.log("Rendered default thematic areas");
		}

		// Load project statistics from API
		async function loadProjectStatistics() {
			try {
				const response = await authManager.apiCall(
					"/api/projects/statistics",
					"GET"
				);
				if (!response || !response.ok) {
					console.error("Failed to fetch statistics, using defaults");
					useDefaultStatistics();
					return;
				}

				const stats = await response.json();
				console.log("[DEBUG] Statistics loaded:", stats);

				// Calculate statistics from the API response
				if (stats.data) {
					const data = stats.data;

					// Calculate regions/counties from countyCounts
					const regions = data.countyCounts ? data.countyCounts.length : 0;

					// Locations is the number of projects with coordinates
					const locations =
						data.projectsWithCoordinates || data.totalProjects || 0;

					// Projects is the total number of projects
					const projects = data.totalProjects || 0;

					// Calculate total active status count
					let activeCount = 0;
					if (data.statusCounts) {
						data.statusCounts.forEach(([status, count]) => {
							if (status === "active" || status === "ACTIVE") {
								activeCount += count;
							}
						});
					}

					// Calculate total budget by fetching all projects
					let totalBudget = 0;
					try {
						const projectsResponse = await authManager.apiCall(
							"/api/projects?page=0&size=1000&sortBy=id&sortDir=desc",
							"GET"
						);
						if (projectsResponse.ok) {
							const projectsData = await projectsResponse.json();
							if (
								projectsData.status === 200 &&
								projectsData.data &&
								projectsData.data.projects
							) {
								const allProjects = projectsData.data.projects;
								totalBudget = allProjects.reduce((sum, project) => {
									return sum + (project.budget || 0);
								}, 0);
								console.log(
									"[DEBUG] Total budget calculated from",
									allProjects.length,
									"projects:",
									totalBudget
								);
							}
						}
					} catch (budgetError) {
						console.error(
							"Error fetching projects for budget calculation:",
							budgetError
						);
						totalBudget = 0;
					}

					// Store the statistics in a global variable for Alpine.js
					window.statsData = {
						locations: locations,
						projects: projects,
						regions: regions,
						users: data.totalStakeholders || activeCount || projects, // Use stakeholders for animated users count
						amount: totalBudget, // Use actual total budget instead of estimate
					};

					console.log("[DEBUG] Calculated statsData:", window.statsData);

					// Dispatch a custom event that Alpine.js will listen to
					window.dispatchEvent(
						new CustomEvent("stats-loaded", {
							detail: window.statsData,
						})
					);

					// Update the hero statistics display with the actual data
					updateStatisticsDisplay(data);

					// Try to load user statistics if user is admin
					await loadUserStatistics(data);

					// Update display again with user statistics included
					updateStatisticsDisplay(data);
				} else {
					console.warn("[DEBUG] No stats.data found, using defaults");
					useDefaultStatistics();
				}
			} catch (error) {
				console.error("Error loading statistics:", error);
				useDefaultStatistics();
			}
		}

		// Load user statistics from API (admin only)
		async function loadUserStatistics(statsData) {
			try {
				const user = authManager.getCachedUser();
				console.log("[DEBUG] Current user for statistics:", user);
				console.log("[DEBUG] User role:", user?.role);

				if (!user || (user.role !== "ADMIN" && user.role !== "SUPER_ADMIN")) {
					console.log(
						"[DEBUG] User is not admin, using estimated stakeholders count. Role:",
						user?.role
					);
					// For non-admin users, estimate stakeholders as a portion of total projects
					// or use a default value
					const estimatedStakeholders = Math.max(
						1,
						Math.floor((statsData.totalProjects || 0) * 0.3)
					); // Estimate 30% of projects have stakeholders
					statsData.totalStakeholders = estimatedStakeholders;

					// Update the display
					const totalStakeholdersElement = document.getElementById(
						"totalStakeholdersCount"
					);
					if (totalStakeholdersElement) {
						totalStakeholdersElement.textContent = estimatedStakeholders;
						console.log(
							"✅ Updated total stakeholders count (estimated):",
							estimatedStakeholders
						);
					}
					return;
				}

				console.log(
					"[DEBUG] User is admin, proceeding with user statistics load"
				);

				console.log("[DEBUG] Loading user statistics...");
				const response = await fetch(
					`${window.BASE_URL}/api/auth/admin/users`,
					{
						headers: {
							Authorization: `Bearer ${authManager.getToken()}`,
						},
					}
				);

				if (response.ok) {
					const usersData = await response.json();
					console.log("[DEBUG] Users API response status:", response.status);
					console.log("[DEBUG] Users data loaded:", usersData);
					console.log("[DEBUG] Users data structure:", {
						hasData: !!usersData.data,
						isArray: Array.isArray(usersData.data),
						dataLength: usersData.data?.length,
					});

					if (usersData.data && Array.isArray(usersData.data)) {
						const totalUsers = usersData.data.length;
						statsData.totalUsers = totalUsers;

						// Debug: Log all unique roles and organization types
						const roles = [...new Set(usersData.data.map((u) => u.role))];
						const orgTypes = [
							...new Set(
								usersData.data
									.map((u) => u.organization?.organizationType)
									.filter(Boolean)
							),
						];
						console.log("[DEBUG] Available user roles:", roles);
						console.log("[DEBUG] Available organization types:", orgTypes);
						console.log(
							"[DEBUG] Sample user data:",
							usersData.data.slice(0, 3)
						);

						// Calculate stakeholders as partners + donors
						// Stakeholders = PARTNER role users + users from DONOR_AGENCY organizations
						const stakeholders = usersData.data.filter((user) => {
							const isPartner = user.role === "PARTNER";
							const isFromDonorAgency =
								user.organization &&
								(user.organization.organizationType === "DONOR_AGENCY" ||
									user.organization.type === "DONOR_AGENCY");
							return isPartner || isFromDonorAgency;
						}).length;
						console.log("[DEBUG] Stakeholders calculation:", {
							totalUsers,
							stakeholders,
							partnerCount: usersData.data.filter((u) => u.role === "PARTNER")
								.length,
							donorAgencyUsersCount: usersData.data.filter((u) => {
								const org = u.organization;
								return (
									org &&
									(org.organizationType === "DONOR_AGENCY" ||
										org.type === "DONOR_AGENCY")
								);
							}).length,
							filteredStakeholders: usersData.data
								.filter((user) => {
									const isPartner = user.role === "PARTNER";
									const isFromDonorAgency =
										user.organization &&
										(user.organization.organizationType === "DONOR_AGENCY" ||
											user.organization.type === "DONOR_AGENCY");
									return isPartner || isFromDonorAgency;
								})
								.map((u) => ({
									id: u.id,
									role: u.role,
									orgType:
										u.organization?.organizationType || u.organization?.type,
								})),
						});
						statsData.totalStakeholders = stakeholders;

						// Update stakeholders count
						const totalStakeholdersElement = document.getElementById(
							"totalStakeholdersCount"
						);
						if (totalStakeholdersElement) {
							totalStakeholdersElement.textContent = stakeholders;
							console.log(
								"✅ Updated total stakeholders count from API:",
								stakeholders
							);
						}

						// Update Alpine.js stats data
						if (window.statsData) {
							window.statsData.users = stakeholders;
							window.statsData.stakeholders = stakeholders;
							window.dispatchEvent(
								new CustomEvent("stats-loaded", {
									detail: window.statsData,
								})
							);
						}
					}
				} else {
					console.warn(
						"[DEBUG] Failed to load user statistics, keeping default"
					);
				}
			} catch (error) {
				console.error("Error loading user statistics:", error);
			}
		}

		// Use default statistics if API calls fail
		function useDefaultStatistics() {
			const defaultStats = {
				totalProjects: 0,
				countyCounts: {},
				statusCounts: {},
				totalStakeholders: 5, // Default stakeholders count
				totalUsers: 97, // Default users count for Alpine.js
				totalBudget: 0,
				coordinatesCoveragePercentage: 0,
			};

			// Show message about using defaults
			console.warn(
				"⚠️ Using default statistics due to API failure - this should show 0 for all stats"
			);
			showApiConnectionWarning();

			updateStatisticsDisplay(defaultStats);
		}

		// Show API connection warning
		function showApiConnectionWarning() {
			const warningBanner = document.createElement("div");
			warningBanner.className =
				"fixed top-20 left-4 right-4 z-40 bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded";
			warningBanner.innerHTML = `
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                <strong>API Connection Issue:</strong> Unable to load live data. Showing default values.
                                This may be due to server maintenance or connectivity issues.
                            </p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-yellow-500 hover:text-yellow-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
			document.body.appendChild(warningBanner);

			setTimeout(() => {
				if (warningBanner.parentElement) {
					warningBanner.remove();
				}
			}, 10000);
		}

		// Load projects from API
		// Load all projects with pagination, sorting, and filtering
		async function loadProjects({
			page = 0,
			size = 50,
			sortBy = "id",
			sortDir = "desc",
			filters = {},
		} = {}) {
			try {
				let url = `/api/projects?page=${page}&size=${size}&sortBy=${sortBy}&sortDir=${sortDir}`;
				// Add filter params
				Object.entries(filters).forEach(([key, value]) => {
					if (value)
						url += `&${encodeURIComponent(key)}=${encodeURIComponent(value)}`;
				});
				const response = await authManager.apiCall(url, "GET");
				if (response.ok) {
					const data = await response.json();
					console.log("loadProjects API response:", data);
					if (data.status === 200 && data.data && data.data.projects) {
						const allProjects = data.data.projects;
						console.log("Loaded all projects:", allProjects.length);

						// Update the global projects array
						projects = allProjects;

						// Update the projects display (accordion)
						updateProjectsDisplay(allProjects);

						// NOTE: Map markers are managed by loadProjectsForMap() which loads only projects with coordinates
						// Don't add markers here to avoid conflicts

						// Trigger the accordion display
						highlightMarkers("all");
					}
				} else {
					showProjectsError();
				}
			} catch (error) {
				console.error("Error loading projects:", error);
				showProjectsError();
			}
		}

		// Load only projects with coordinates (for map)
		async function loadProjectsWithCoordinates() {
			try {
				const response = await authManager.apiCall(
					"/api/projects/with-coordinates",
					"GET"
				);
				if (response.ok) {
					const data = await response.json();
					if (data.status === 200 && data.data) {
						updateMapWithProjects(data.data);
					}
				}
			} catch (error) {
				// Optionally show error
			}
		}

		// Advanced search/filter
		async function searchProjects(filters) {
			try {
				let url = "/api/projects/search";
				const params = Object.entries(filters)
					.filter(([_, v]) => v)
					.map(
						([k, v]) => `${encodeURIComponent(k)}=${encodeURIComponent(v)}`
					)
					.join("&");
				if (params) url += `?${params}`;
				const response = await authManager.apiCall(url, "GET");
				if (response.ok) {
					const data = await response.json();
					if (data.status === 200 && data.data) {
						updateProjectsDisplay(data.data);
						updateMapWithProjects(data.data);
					}
				}
			} catch (error) { }
		}

		// Filter by status
		async function filterProjectsByStatus(status) {
			try {
				const response = await authManager.apiCall(
					`/api/projects/status/${status}`,
					"GET"
				);
				if (response.ok) {
					const data = await response.json();
					if (data.status === 200 && data.data) {
						updateProjectsDisplay(data.data);
						updateMapWithProjects(data.data);
					}
				}
			} catch (error) { }
		}

		// Filter by date range
		async function filterProjectsByDateRange(startDate, endDate) {
			try {
				const url = `/api/projects/date-range?startDate=${encodeURIComponent(
					startDate
				)}&endDate=${encodeURIComponent(endDate)}`;
				const response = await authManager.apiCall(url, "GET");
				if (response.ok) {
					const data = await response.json();
					if (data.status === 200 && data.data) {
						updateProjectsDisplay(data.data);
						updateMapWithProjects(data.data);
					}
				}
			} catch (error) { }
		}

		// Filter by bounding box (for map)
		async function filterProjectsByBounds(minLat, maxLat, minLng, maxLng) {
			try {
				const url = `/api/projects/in-bounds?minLat=${minLat}&maxLat=${maxLat}&minLng=${minLng}&maxLng=${maxLng}`;
				const response = await authManager.apiCall(url, "GET");
				if (response.ok) {
					const data = await response.json();
					if (data.status === 200 && data.data) {
						updateProjectsDisplay(data.data);
						updateMapWithProjects(data.data);
					}
				}
			} catch (error) { }
		}

		// Get project details by ID
		async function getProjectById(id) {
			try {
				const response = await authManager.apiCall(
					`/api/projects/${id}`,
					"GET"
				);
				if (response.ok) {
					const data = await response.json();
					if (data.status === 200 && data.data) {
						// Show details in modal or section
						// showProjectDetailsModal(data.data);
					}
				}
			} catch (error) { }
		}

		// Get my projects (for PARTNER)
		async function loadMyProjects() {
			try {
				const response = await authManager.apiCall(
					"/api/projects/my-projects",
					"GET"
				);
				if (response.ok) {
					const data = await response.json();
					if (data.status === 200 && data.data) {
						updateProjectsDisplay(data.data);
						updateMapWithProjects(data.data);
					}
				}
			} catch (error) { }
		}

		// Update map with real project data
		function updateMapWithProjects(projectsData) {
			console.log("updateMapWithProjects called with:", projectsData);
			console.log("Number of projects received:", projectsData.length);

			// Log all projects to see their structure
			projectsData.forEach((project, idx) => {
				console.log(`Project ${idx + 1} structure:`, {
					id: project.id,
					name: project.projectName || project.name,
					latitude: project.latitude,
					longitude: project.longitude,
					status: project.status,
					hasCoordinates: !!(project.latitude && project.longitude),
					allFields: Object.keys(project),
				});
			});

			// Find projects with coordinates
			const projectsWithCoords = projectsData.filter((p) => {
				const hasCoords = p.latitude && p.longitude;
				if (!hasCoords) {
					console.warn(
						`Project "${p.projectName || p.name}" (ID: ${p.id
						}) is missing coordinates!`
					);
				}
				return hasCoords;
			});

			console.log("Updating map with", projectsWithCoords.length, "projects");
			console.log("Projects with coordinates:", projectsWithCoords);

			// NOTE: Map markers are managed separately by loadProjectsForMap()
			// Don't add markers here to avoid conflicts

			// Update project list
			projects = projectsData;
		}

		// Update statistics display with real data
		function updateStatisticsDisplay(stats) {
			console.log("📊 Updating statistics display with:", stats);

			// Update hero section statistics
			const totalProjectsElement =
				document.getElementById("totalProjectsCount");
			const totalCountiesElement =
				document.getElementById("totalCountiesCount");
			const totalStakeholdersElement = document.getElementById(
				"totalStakeholdersCount"
			);

			// Calculate counties count - handle both array and object formats
			let countiesCount = 0;
			if (stats.countyCounts) {
				if (Array.isArray(stats.countyCounts)) {
					countiesCount = stats.countyCounts.length;
				} else if (typeof stats.countyCounts === "object") {
					countiesCount = Object.keys(stats.countyCounts).length;
				}
			}

			if (totalProjectsElement) {
				const projectCount = stats.totalProjects || 0;
				totalProjectsElement.textContent = projectCount;
				console.log("✅ Updated total projects count:", projectCount);
			} else {
				console.warn("⚠️ totalProjectsElement not found");
			}

			if (totalCountiesElement) {
				totalCountiesElement.textContent = countiesCount;
				console.log("✅ Updated total counties count:", countiesCount);
			} else {
				console.warn("⚠️ totalCountiesElement not found");
			}

			if (totalStakeholdersElement) {
				const stakeholdersCount = stats.totalStakeholders || 0;
				totalStakeholdersElement.textContent = stakeholdersCount;
				console.log(
					"✅ Updated total stakeholders count:",
					stakeholdersCount
				);
			} else {
				console.warn("⚠️ totalStakeholdersElement not found");
			}

			console.log("📊 Hero statistics updated:", {
				projects: stats.totalProjects,
				counties: countiesCount,
				stakeholders: stats.totalStakeholders,
			});

			// Update Alpine.js countdownStats component
			try {
				const statsComponent = Alpine.$data(
					document.querySelector('[x-data*="countdownStats"]')
				);

				if (statsComponent) {
					// Update targets with real data
					statsComponent.targets = {
						locations: stats.coordinatesCoveragePercentage || 0,
						projects: stats.totalProjects || 0,
						regions: Object.keys(stats.countyCounts || {}).length || 0,
						users: stats.totalStakeholders || 0,
						amount: stats.totalBudget || 0, // This would need to be calculated from projects
					};

					// Reset the animation values
					statsComponent.locations = 0;
					statsComponent.projects = 0;
					statsComponent.regions = 0;
					statsComponent.users = 0;
					statsComponent.amount = 0;
					statsComponent.amountDisplay = "0";

					// Restart the animation with new targets
					statsComponent.start();

					console.log(
						"Alpine.js statistics updated:",
						statsComponent.targets
					);
				} else {
					console.warn("Alpine.js countdownStats component not found");
				}
			} catch (error) {
				console.error("Error updating Alpine.js component:", error);
			}

			console.log("Hero statistics updated:", {
				projects: stats.totalProjects,
				counties: Object.keys(stats.countyCounts || {}).length,
				stakeholders: stats.totalStakeholders,
			});
		}

		// Update projects display
		function updateProjectsDisplay(projectsData) {
			console.log(
				"updateProjectsDisplay called with:",
				projectsData.length,
				"projects"
			);

			// Update global projects variable
			window.projects = projectsData;
			window.filteredProjects = projectsData;

			// Render accordion with projects
			renderProjectsList(projectsData);

			console.log(
				"Projects display updated with",
				projectsData.length,
				"projects"
			);
		}

		// Render projects accordion in the UI
		function renderProjectsList(projects) {
			console.log(
				"renderProjectsList called with:",
				projects.length,
				"projects"
			);
			const accordion = document.getElementById("projectAccordion");
			if (!accordion) {
				console.error("Accordion element not found!");
				return;
			}

			// Make sure accordion is visible
			accordion.classList.remove("hidden");
			accordion.innerHTML = "";

			if (projects.length === 0) {
				console.log("No projects to display");
				accordion.innerHTML = `
                <div class="text-center py-8">
                  <i class="fas fa-project-diagram text-gray-400 text-4xl mb-4"></i>
                  <p class="text-gray-600">No projects found.</p>
                </div>
              `;
				return;
			}

			console.log("Rendering", projects.length, "projects in accordion");
			projects.forEach((project, idx) => {
				console.log(
					`Rendering project ${idx + 1}:`,
					project.projectName || project.name
				);
				// Status color classes
				const statusBg =
					{
						active: "bg-green-50",
						pending: "bg-yellow-50",
						stalled: "bg-red-50",
						completed: "bg-cyan-100",
					}[project.status] || "bg-white";
				const statusBadge =
					{
						active: "bg-green-200 text-green-800",
						pending: "bg-yellow-200 text-yellow-800",
						stalled: "bg-red-200 text-red-800",
						completed: "bg-cyan-300 text-gray-800",
					}[project.status] || "bg-gray-200 text-gray-800";
				// Format budget
				const budget = project.budget
					? Number(project.budget).toLocaleString("en-KE", {
						style: "currency",
						currency: "KES",
						maximumFractionDigits: 0,
					})
					: "N/A";
				// Accordion item
				const item = document.createElement("div");
				item.className = `rounded shadow-sm ${statusBg}`;
				item.innerHTML = `
                <button class=\"w-full px-6 py-4 text-left border-b focus:outline-none\" data-toggle=\"collapse-${idx}\">
                  <div class=\"flex flex-col sm:flex-row sm:justify-between sm:items-center\">
                    <div>
                      <h4 class=\"text-lg font-semibold text-gray-800\">${project.title || ""
					}</h4>
                      <p id=\"desc-${idx}\" class=\"mt-2 text-sm text-gray-600\">${project.objectives
						? project.objectives.substring(0, 100) +
						(project.objectives.length > 100 ? "..." : "")
						: ""
					}</p>
                    </div>
                    <div class=\"flex items-center mt-2 text-sm font-semibold tracking-wider text-gray-500 sm:mt-0\">
                      ${project.projectTheme
						? `<span class='px-2 py-1 rounded-full bg-gray-100 text-gray-700 mr-2'>${project.projectTheme}</span>`
						: ""
					}
                      ${project.status
						? `<span class='px-2 py-1 rounded-full text-sm font-medium ${statusBadge}'>${project.status}</span>`
						: ""
					}
                    </div>
                  </div>
                </button>
                <div id=\"collapse-${idx}\" class=\"hidden px-6 py-4 bg-white\">
                  <p><strong>County:</strong> ${project.county || "Not specified"
					}</p>
                  <p><strong>Budget:</strong> ${budget}</p>
                  <p><strong>Partner:</strong> ${project.partner && project.partner !== "TBD"
						? project.partner
						: "Partner information pending"
					}</p>
                  <p><strong>Status:</strong>
                    <span class=\"inline-block px-2 py-1 rounded-full text-sm font-medium ${statusBadge}\">
                      ${project.status || ""}
                    </span>
                  </p>
                  <div class=\"mt-4 pt-4 border-t\">
                    <h5 class=\"text-md font-semibold text-gray-800 mb-2 flex items-center\">
                      <i class=\"fas fa-paperclip mr-2\"></i>Final Report
                    </h5>
                    <div id=\"documents-${idx}\" class=\"space-y-2\">
                      <p class=\"text-sm text-gray-500\"><i class=\"fas fa-spinner fa-spin\"></i> Loading documents...</p>
                    </div>
                  </div>
                  <button onclick=\"focusMarker(${idx})\" class=\"px-5 py-2 mt-3 text-sm font-semibold text-white transition bg-blue-600 rounded hover:bg-blue-700 hover:scale-105\">
                    Show on Map
                  </button>
                </div>
              `;
				accordion.appendChild(item);
				// Toggle description between truncated and full
				const btn = item.querySelector(`[data-toggle="collapse-${idx}"]`);
				btn.addEventListener("click", async () => {
					const collapse = document.getElementById(`collapse-${idx}`);
					const desc = document.getElementById(`desc-${idx}`);
					collapse.classList.toggle("hidden");
					if (!collapse.classList.contains("hidden")) {
						desc.textContent = project.objectives || "";

						// Load documents when accordion is opened
						if (project.id) {
							const documentsContainer = document.getElementById(
								`documents-${idx}`
							);
							const documents = await fetchProjectDocuments(project.id);
							documentsContainer.innerHTML = renderDocuments(
								documents,
								project.id
							);
						}
					} else {
						desc.textContent = project.objectives
							? project.objectives.substring(0, 100) +
							(project.objectives.length > 100 ? "..." : "")
							: "";
					}
				});
			});
		}

		// Create project card element
		function createProjectCard(project) {
			const card = document.createElement("div");
			card.className =
				"bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow";

			const statusClass = getStatusClass(project.status);

			card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 line-clamp-2">${project.title
				}</h3>
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
                            ${project.status.charAt(0).toUpperCase() +
				project.status.slice(1)
				}
                        </span>
                    </div>

                    <div class="space-y-2 mb-4">
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-building mr-2"></i>${project.partner
				}
                        </p>
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-map-marker-alt mr-2"></i>${project.county
				}${project.subCounty ? ", " + project.subCounty : ""
				}
                        </p>
                        <p class="text-sm text-gray-600">
                            <i class="fas fa-calendar mr-2"></i>${project.startDate
				} - ${project.endDate}
                        </p>
                        ${project.budget
					? `
                            <p class="text-sm text-gray-600">
                                <i class="fas fa-dollar-sign mr-2"></i>$${project.budget.toLocaleString()}
                            </p>
                        `
					: ""
				}
                    </div>

                    <div class="flex justify-between items-center">
                        <div class="flex flex-wrap gap-1">
                            ${(project.themes || [])
					.slice(0, 2)
					.map((theme) => {
						const themeName =
							typeof theme === "string"
								? theme
								: theme.name || theme.code || theme;
						const themeCode =
							typeof theme === "string"
								? theme
								: theme.code || theme.name || theme;
						return `<span class="px-2 py-1 rounded text-xs font-medium ${getThemeClass(
							themeCode
						)}">${themeName}</span>`;
					})
					.join("")}
                            ${(project.themes || []).length > 2
					? `<span class="text-xs text-gray-500">+${(project.themes || []).length - 2
					} more</span>`
					: ""
				}
                        </div>
                        <button onclick="viewProject(${project.id})"
                            class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            View Details →
                        </button>
                    </div>
                `;

			return card;
		}

		// Helper functions for styling
		function getStatusClass(status) {
			const classes = {
				active: "bg-green-100 text-green-800",
				pending: "bg-yellow-100 text-yellow-800",
				completed: "bg-blue-100 text-blue-800",
				stalled: "bg-red-100 text-red-800",
				abandoned: "bg-gray-100 text-gray-800",
			};
			return classes[status] || "bg-gray-100 text-gray-800";
		}

		function getThemeClass(theme) {
			const classes = {
				MNH: "bg-pink-100 text-pink-800",
				FP: "bg-blue-100 text-blue-800",
				GBV: "bg-red-100 text-red-800",
				CH: "bg-green-100 text-green-800",
				AH: "bg-purple-100 text-purple-800",
				AYPSRH: "bg-indigo-100 text-indigo-800",
			};
			return classes[theme] || "bg-gray-100 text-gray-800";
		}

		// View project details
		function viewProject(projectId) {
			window.open(`project-details.html?id=${projectId}`, "_blank");
		}

		// Use default statistics if API fails
		function useDefaultStatistics() {
			console.log("Using default statistics");
			// The existing hardcoded values will be used
		}

		// Show dashboard error
		function showDashboardError() {
			const errorBanner = document.createElement("div");
			errorBanner.className =
				"fixed top-20 left-4 right-4 z-40 bg-red-100 border-l-4 border-red-500 p-4 rounded";
			errorBanner.innerHTML = `
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-circle text-red-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-red-700">
                                Failed to load some dashboard data. Showing cached or default information.
                            </p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
			document.body.appendChild(errorBanner);

			setTimeout(() => {
				if (errorBanner.parentElement) {
					errorBanner.remove();
				}
			}, 5000);
		}

		// Show projects error
		function showProjectsError() {
			const projectsContainer = document.getElementById("projects-container");
			if (projectsContainer) {
				projectsContainer.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-exclamation-triangle text-yellow-500 text-4xl mb-4"></i>
                            <p class="text-gray-600 mb-4">Failed to load projects. Please try again later.</p>
                            <button onclick="loadProjects()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                Retry
                            </button>
                        </div>
                    `;
			}
		}

		function updateUserDisplayWhenNavReady(user) {
			// Check if nav is already loaded
			const navPlaceholder = document.getElementById("nav-placeholder");
			if (navPlaceholder && navPlaceholder.innerHTML.trim() !== "") {
				updateUserDisplay(user);
			} else {
				// Wait for nav to be loaded
				window.addEventListener(
					"navLoaded",
					() => {
						updateUserDisplay(user);
					},
					{ once: true }
				);
			}
		}

		function updateUserDisplay(user) {
			// Update navigation display
			const userDisplayName = document.getElementById("userDisplayName");
			const userNameDisplay = document.getElementById("userNameDisplay");
			const userEmailDisplay = document.getElementById("userEmailDisplay");
			const userRoleDisplay = document.getElementById("userRoleDisplay");
			const userStatusDisplay = document.getElementById("userStatusDisplay");

			if (userDisplayName) userDisplayName.textContent = user.name || "User";
			if (userNameDisplay) userNameDisplay.textContent = user.name || "N/A";
			if (userEmailDisplay)
				userEmailDisplay.textContent = user.email || "N/A";
			if (userRoleDisplay) userRoleDisplay.textContent = user.role || "N/A";
			if (userStatusDisplay) {
				userStatusDisplay.textContent = user.approvalStatus || "N/A";
				userStatusDisplay.className =
					user.approvalStatus === "APPROVED"
						? "text-green-600"
						: user.approvalStatus === "PENDING"
							? "text-yellow-600"
							: "text-red-600";
			}

			// Hide all role-based navs by default
			const adminNav = document.getElementById("adminNav");
			const partnerNav = document.getElementById("partnerNav");
			const donorNav = document.getElementById("donorNav");
			const myProjectsNav = document.getElementById("myProjectsNav");
			if (adminNav) adminNav.classList.add("hidden");
			if (partnerNav) partnerNav.classList.add("hidden");
			if (donorNav) donorNav.classList.add("hidden");
			if (myProjectsNav) myProjectsNav.classList.add("hidden");

			// Show navs based on role
			if (
				user.role === "SUPER_ADMIN" ||
				user.role === "SUPER_ADMIN_REVIEWER" ||
				user.role === "SUPER_ADMIN_APPROVER"
			) {
				if (adminNav) adminNav.classList.remove("hidden");
			}
			if (user.role === "PARTNER") {
				if (partnerNav) partnerNav.classList.remove("hidden");
				if (myProjectsNav) myProjectsNav.classList.remove("hidden");
			}
			if (user.role === "DONOR") {
				if (donorNav) donorNav.classList.remove("hidden");
				// Customize dashboard for donors
				const projectsTitle = document.getElementById("projectsTitle");
				if (projectsTitle)
					projectsTitle.textContent = "Projects in Your Network";

				const projectsLabel = document.getElementById("projectsLabel");
				if (projectsLabel) projectsLabel.textContent = "Funded Projects";

				const usersLabel = document.getElementById("usersLabel");
				if (usersLabel) usersLabel.textContent = "Partners";
			}

			// Show admin collaboration menu for ADMIN or SUPER_ADMIN
			console.log("[DEBUG] User role:", user.role);
			if (
				user.role === "ADMIN" ||
				user.role === "SUPER_ADMIN" ||
				user.role === "SUPER_ADMIN_REVIEWER" ||
				user.role === "SUPER_ADMIN_APPROVER"
			) {
				console.log("[DEBUG] User is admin, showing admin collab menu");
				const adminCollabItem = document.getElementById("admin-collab-item");
				const adminCollabMobile = document.getElementById(
					"admin-collab-mobile"
				);
				console.log("[DEBUG] adminCollabItem found:", adminCollabItem);
				console.log("[DEBUG] adminCollabMobile found:", adminCollabMobile);

				if (adminCollabItem) {
					adminCollabItem.style.display = "block";
					console.log("[DEBUG] Set adminCollabItem display to block");
				}
				if (adminCollabMobile) {
					adminCollabMobile.style.display = "block";
					console.log("[DEBUG] Set adminCollabMobile display to block");
				}
				loadPendingRequestsCount();
			} else {
				console.log("[DEBUG] User is NOT admin, role is:", user.role);
			}
			// Optionally, show/hide other navs for other roles as needed
		}

		async function loadPendingRequestsCount() {
			try {
				const token = localStorage.getItem("accessToken");
				const response = await fetch(
					`${BASE_URL}/api/collaboration-requests/admin/pending`,
					{
						method: "GET",
						headers: {
							Authorization: `Bearer ${token}`,
						},
					}
				);
				const data = await response.json();
				if (data.status === 200 && data.data) {
					const count = data.data.length;

					// Update Alpine.js data for the collaboration dropdown
					const collabNav = document.getElementById("collabNav");
					if (collabNav && collabNav.__x) {
						collabNav.__x.$data.pendingCount = count;
					}

					// Legacy support for old badge element if it exists
					const badge = document.getElementById("pending-badge");
					if (badge && count > 0) {
						badge.textContent = count;
						badge.style.display = "inline-block";
					}
				}
			} catch (error) {
				console.error("Error loading pending requests count:", error);
			}
		}

		function showApprovalPendingMessage(user) {
			if (user.approvalStatus === "PENDING") {
				const banner = document.createElement("div");
				banner.className =
					"fixed top-20 left-4 right-4 z-40 bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded";
				banner.innerHTML = `
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-yellow-500"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-700">
                                    Your account is pending approval. Some features may be limited until an administrator approves your account.
                                </p>
                            </div>
                            <div class="ml-auto pl-3">
                                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-yellow-500 hover:text-yellow-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
				document.body.appendChild(banner);

				// Auto-remove after 10 seconds
				setTimeout(() => {
					if (banner.parentElement) {
						banner.remove();
					}
				}, 10000);
			}
		}

		// Show My Projects section for PARTNER users
		function showMyProjects() {
			if (currentUser && currentUser.role === "PARTNER") {
				loadUserProjects();
				// Scroll to projects section or show modal
				document
					.getElementById("projects-container")
					.scrollIntoView({ behavior: "smooth" });
			}
		}

		// Load user's own projects (for PARTNER users)
		async function loadUserProjects() {
			try {
				console.log("Loading user projects...");
				const userId = currentUser.id;
				const response = await authManager.apiCall(
					`/api/projects/user/${userId}`,
					{
						method: "GET",
					}
				);

				if (response && response.length > 0) {
					renderUserProjectsList(response);
				} else {
					showNoUserProjectsMessage();
				}
			} catch (error) {
				console.error("Failed to load user projects:", error);
				showUserProjectsError();
			}
		}

		// Render user's projects list
		function renderUserProjectsList(projects) {
			const container = document.getElementById("projects-container");
			if (!container) return;

			container.innerHTML = `
                    <div class="mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">My Projects</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${projects
					.map((project) => createUserProjectCard(project))
					.join("")}
                        </div>
                    </div>
                `;
		}

		// Create project card for user's projects
		function createUserProjectCard(project) {
			const statusColors = {
				ACTIVE: "bg-green-100 text-green-800",
				PENDING: "bg-yellow-100 text-yellow-800",
				STALLED: "bg-red-100 text-red-800",
				COMPLETED: "bg-blue-100 text-blue-800",
				ABANDONED: "bg-gray-100 text-gray-800",
			};

			return `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
                        <div class="p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="text-lg font-semibold text-gray-800 truncate">${project.name || "Untitled Project"
				}</h4>
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[project.status] ||
				"bg-gray-100 text-gray-800"
				}">
                                    ${project.status || "Unknown"}
                                </span>
                            </div>
                            <p class="text-gray-600 text-sm mb-4 line-clamp-3">
                                ${project.description ||
				"No description available"
				}
                            </p>
                            <div class="space-y-2 text-sm text-gray-500">
                                <div class="flex justify-between">
                                    <span>Budget:</span>
                                    <span class="font-medium">$${project.budget
					? project.budget.toLocaleString()
					: "N/A"
				}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Progress:</span>
                                    <span class="font-medium">${project.progress || 0
				}%</span>
                                </div>
                                ${project.startDate
					? `
                                <div class="flex justify-between">
                                    <span>Started:</span>
                                    <span class="font-medium">${new Date(
						project.startDate
					).toLocaleDateString()}</span>
                                </div>
                                `
					: ""
				}
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <button onclick="viewProjectDetails(${project.id
				})"
                                        class="w-full px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors">
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
		}

		// Show no user projects message
		function showNoUserProjectsMessage() {
			const container = document.getElementById("projects-container");
			if (!container) return;

			container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="mb-4">
                            <i class="fas fa-folder-open text-6xl text-gray-300"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No Projects Yet</h3>
                        <p class="text-gray-500 mb-6">You haven't created any projects yet. Start by submitting a new project proposal.</p>
                        <a href="Forms/Admin/new-project.html" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>
                            Create New Project
                        </a>
                    </div>
                `;
		}

		// Show user projects error
		function showUserProjectsError() {
			const container = document.getElementById("projects-container");
			if (!container) return;

			container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="mb-4">
                            <i class="fas fa-exclamation-triangle text-6xl text-red-300"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">Failed to Load Projects</h3>
                        <p class="text-gray-500 mb-6">There was an error loading your projects. Please try again.</p>
                        <button onclick="loadUserProjects()" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-refresh mr-2"></i>
                            Try Again
                        </button>
                    </div>
                `;
		}

		// View project details
		function viewProjectDetails(projectId) {
			// Navigate to project details page or show modal
			window.location.href = `project-details.html?id=${projectId}`;
		}
	</script>
</body>

</html>