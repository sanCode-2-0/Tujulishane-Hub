<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>New Project - RMNCAH</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- Tailwind CSS (with custom config using inline script) -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#1e40af", // Custom Blue
              secondary: "#f59e0b", // Custom Amber
              accent: "#10b981", // Custom Green
              dark: "#1f2937", // Gray-800
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="styles/main.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css"
    />
    <script src="styles/main.js"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      rel="stylesheet"
      href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
      integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p"
      crossorigin="anonymous"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
    <!-- Modal Utilities -->
    <script src="modal-utils.js"></script>
  </head>

  <body class="bg-gray-50">
    <!-- Navigation -->
    <div class="" id="nav-placeholder"></div>

    <!-- Main Content -->
    <div class="pt-24 pb-12">
      <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-md p-8 my-10">
        <!-- Progress Header -->
        <div class="mb-8">
          <h2 class="text-2xl font-semibold text-blue-900 mb-4">
            Project Submission Form
          </h2>
          <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div
              id="progressBar"
              class="bg-indigo-600 h-2.5 rounded-full"
              style="width: 16.6%"
            ></div>
          </div>
          <p id="progressText" class="text-sm text-gray-600 mt-2">
            Step 1 of 6: Project Location
          </p>
        </div>

        <!-- Form Sections -->
        <form id="projectForm" class="space-y-8">
          <!-- Step 1: Project Location -->
          <div class="form-step block" data-step="1">
            <div class="mb-4">
              <h2 class="text-xl font-bold text-gray-800 flex items-center">
                <span
                  class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3"
                  >1</span
                >
                Project Location
              </h2>
              <p class="text-sm text-gray-600 mt-1">
                Select the geographical areas where your project will be
                implemented
              </p>
              <hr class="mt-4" />
            </div>
            <!-- Location Selection -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label
                  for="countySelect"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >County</label
                >
                <select
                  id="countySelect"
                  class="block w-full p-2 mt-1 text-black bg-white border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                >
                  <option value="">All Counties</option>
                </select>
              </div>
              <div>
                <label
                  for="subCountySelect"
                  class="block text-sm font-medium text-gray-700 mb-2"
                  >Sub-County</label
                >
                <select
                  id="subCountySelect"
                  class="block w-full p-2 mt-1 text-black bg-white border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                >
                  <option value="">All Sub-Counties</option>
                </select>
              </div>
            </div>

            <!-- Map Section -->
            <div class="mt-2">
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Pick Project Locations on Map (Click to add multiple
                locations)</label
              >

              <!-- Map Search Bar -->
              <div class="relative mb-3">
                <div class="relative">
                  <div
                    class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                  >
                    <i class="fas fa-search text-gray-400"></i>
                  </div>
                  <input
                    type="text"
                    id="mapSearchInput"
                    placeholder="Search for a location (e.g., Nairobi, Meru County, or coordinates)"
                    class="block w-full pl-10 pr-10 py-3 text-black border border-gray-300 rounded-lg shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500 sm:text-sm"
                    autocomplete="off"
                  />
                  <button
                    type="button"
                    id="clearSearchBtn"
                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 hidden"
                    title="Clear search"
                  >
                    <i class="fas fa-times"></i>
                  </button>
                </div>

                <!-- Search Results Dropdown -->
                <div
                  id="searchResults"
                  class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-64 overflow-y-auto hidden"
                >
                  <!-- Search results will be populated here -->
                </div>

                <!-- Search Info/Help Text -->
                <div
                  class="flex items-start mt-2 text-xs text-gray-500 space-x-4"
                >
                  <div class="flex items-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    <span>Search by place name, county, or coordinates</span>
                  </div>
                  <div class="flex items-center">
                    <i class="fas fa-map-marker-alt mr-1"></i>
                    <span>Click result to zoom to location</span>
                  </div>
                </div>
              </div>

              <div
                id="newProjectMap"
                style="
                  height: 400px;
                  width: 100%;
                  border-radius: 8px;
                  margin-bottom: 8px;
                  border: 1px solid #e5e7eb;
                  background-color: #f3f4f6;
                  position: relative;
                  overflow: hidden;
                "
              ></div>
              <input type="hidden" id="project_locations" name="locations" />
              <div class="text-sm text-gray-700 mt-2 p-2 bg-gray-50 rounded">
                <strong>Selected Locations:</strong>
                <div id="selectedLocationsList" class="mt-2 space-y-1">
                  <p class="text-gray-500 italic">
                    Click on map to add locations
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 2: Basic Information -->
          <div class="form-step hidden" data-step="2">
            <div class="mb-4">
              <h2 class="text-xl font-bold text-gray-800 flex items-center">
                <span
                  class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3"
                  >2</span
                >
                Basic Information
              </h2>
              <p class="text-sm text-gray-600 mt-1">
                Provide essential details about your project
              </p>
              <hr class="mt-4" />
            </div>
            <!-- Title -->
            <div class="mb-6">
              <label for="title" class="block text-sm font-medium text-gray-700"
                >Project Title *</label
              >
              <input
                required
                type="text"
                id="title"
                name="title"
                class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
              />
            </div>

            <!-- Activity Type -->
            <div>
              <label
                for="activity_type"
                class="block text-sm font-medium text-gray-700"
                >Activity Type (Description) *</label
              >
              <textarea
                required
                id="activity_type"
                name="activity_type"
                rows="3"
                class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
              ></textarea>
            </div>
          </div>

          <!-- Step 3: Project Themes -->
          <div class="form-step hidden" data-step="3">
            <div class="mb-4">
              <h2 class="text-xl font-bold text-gray-800 flex items-center">
                <span
                  class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3"
                  >3</span
                >
                Project Themes<span class="font-light text-sm ml-1"
                  >(optional)</span
                >
              </h2>
              <p class="text-sm text-gray-600 mt-1">
                Provide essential details about your project
              </p>
              <hr class="mt-4" />
            </div>
            <div
              class="theme-selection bg-white rounded-lg border-2 border-gray-200 p-6 transition-all duration-200 hover:border-blue-300 hover:shadow-md"
            >
              <div class="flex items-center justify-between mb-4">
                <label class="block text-lg font-semibold text-gray-800">
                </label>
                <div
                  id="selectedThemesDisplay"
                  class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm font-medium"
                >
                  <i class="fas fa-check-circle mr-1"></i>
                  <span id="themesCount">0</span> selected
                </div>
              </div>

              <p class="text-sm text-gray-600 mb-4">
                Select all themes that apply to your project (minimum 1
                required)
              </p>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="GBV"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Gender Based Violence</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      GBV prevention and support programs
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>

                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="AYPSRH"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Adolescent & Youth SRH</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      Sexual and reproductive health for young people
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>

                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="MNH"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Maternal & Newborn Health</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      Maternal care and newborn health programs
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>

                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="FP"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Family Planning</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      Contraception and family planning services
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>

                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="CH"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Child Health</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      Child healthcare and nutrition programs
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>

                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="AH"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Adolescent Health</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      Adolescent healthcare and development
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>

                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="ADV_SBC"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Advocacy and SBC</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      Social behavior change and advocacy programs
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>

                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="MONITORING_EVALUATION"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Monitoring and Evaluation</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      Monitoring and evaluation activities
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>

                <label
                  class="theme-option flex items-center p-3 rounded-lg border-2 border-gray-200 hover:border-blue-400 hover:bg-blue-50 cursor-pointer transition-all duration-200 group"
                >
                  <input
                    type="checkbox"
                    name="themes"
                    value="RESEARCH_LEARNING"
                    class="theme-checkbox rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 mr-3"
                  />
                  <div class="flex-1">
                    <span
                      class="font-medium text-gray-800 group-hover:text-blue-800"
                      >Research and Learning</span
                    >
                    <p class="text-xs text-gray-500 mt-1">
                      Research and learning initiatives
                    </p>
                  </div>
                  <div class="checkmark hidden text-green-500 ml-2">
                    <i class="fas fa-check"></i>
                  </div>
                </label>
              </div>

              <input
                type="hidden"
                id="selected_themes"
                name="selected_themes"
                value="[]"
              />

              <div
                class="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg hidden"
                id="themeValidationError"
              >
                <div class="flex items-center">
                  <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                  <span class="text-red-700 text-sm"
                    >Please select at least one project theme.</span
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- Step 4: Contact Information -->
          <div class="form-step hidden" data-step="4">
            <div class="mb-4">
              <h2 class="text-xl font-bold text-gray-800 flex items-center">
                <span
                  class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3"
                  >4</span
                >
                Contact Information
              </h2>
              <p class="text-sm text-gray-600 mt-1">
                Provide details for project coordination
              </p>
              <hr class="mt-4" />
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label
                  for="contact_person_name"
                  class="block text-sm font-medium text-gray-700"
                  >Contact Person Name *</label
                >
                <input
                  required
                  type="text"
                  id="contact_person_name"
                  name="contact_person_name"
                  placeholder="Name"
                  class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                />
              </div>
              <div>
                <label
                  for="contact_person_role"
                  class="block text-sm font-medium text-gray-700"
                  >Contact Person Role *</label
                >
                <input
                  required
                  type="text"
                  id="contact_person_role"
                  name="contact_person_role"
                  placeholder="Role"
                  class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                />
              </div>
              <div>
                <label
                  for="contact_person_email"
                  class="block text-sm font-medium text-gray-700"
                  >Contact Person Email *</label
                >
                <input
                  required
                  type="email"
                  id="contact_person_email"
                  name="contact_person_mail"
                  placeholder="Email"
                  class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                />
              </div>
            </div>
          </div>

          <!-- Step 5: Budget & Objectives -->
          <div class="form-step hidden" data-step="5">
            <div class="mb-4">
              <h2 class="text-xl font-bold text-gray-800 flex items-center">
                <span
                  class="bg-blue-600 text-white rounded-md w-5 h-5 flex items-center justify-center text-sm font-bold mr-3"
                  >5</span
                >
                Budget & Objectives
                <span class="font-light text-sm ml-1">(optional)</span>
              </h2>
              <p class="text-sm text-gray-600 mt-1">
                Provide budget estimates and project goals
              </p>
              <hr class="mt-4" />
            </div>
            <div>
              <label
                for="currency"
                class="block text-sm font-medium text-gray-700"
              >
                Currency</label
              >
              <select
                id="currency"
                name="currency"
                required
                class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
              >
                <option value="">Select Currency</option>
                <option value="EUR">Euro</option>
                <option value="KES">Kenyan Shilling</option>
                <option value="USD">US Dollar</option>
              </select>
            </div>
            <div>
              <label
                for="budget"
                class="block text-sm font-medium text-gray-700"
                >Amount
              </label>
              <input
                required
                type="text"
                id="budget"
                name="budget"
                placeholder="1,000,000"
                class="block w-full p-2 numbers-only mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
              />
            </div>

            <!-- Objectives -->
            <div>
              <label
                for="objectives"
                class="block text-sm font-medium text-gray-700"
                >Project Objectives
              </label>
              <textarea
                required
                id="objectives"
                name="objectives"
                rows="3"
                class="block w-full p-2 mt-1 text-black border border-gray-200 rounded-sm rounded-lg shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
              ></textarea>
            </div>
          </div>
          <!-- Navigation Buttons -->
          <div class="flex justify-between mt-10">
            <button
              type="button"
              id="prevBtn"
              class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300"
            >
              Previous
            </button>
            <button
              type="button"
              id="nextBtn"
              class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700"
            >
              Next
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Scripts -->
    <script src="styles/numbersOnly.js"></script>
    <script src="styles/loadNav.js"></script>
    <script src="styles/authnav.js"></script>
    <script src="styles/prioritySteps.js"></script>
    <script src="auth.js"></script>
    <script src="config.js"></script>
    <script src="kenya-locations.js"></script>
    <script src="set-base-url.js"></script>
    <script>
      // Initialize everything when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        console.log("ðŸ” Checking authentication status...");
        console.log(
          "localStorage.token:",
          localStorage.getItem("token") ? "EXISTS" : "NOT FOUND"
        );
        console.log(
          "localStorage.accessToken:",
          localStorage.getItem("accessToken") ? "EXISTS" : "NOT FOUND"
        );
        console.log(
          "localStorage.user:",
          localStorage.getItem("user") ? "EXISTS" : "NOT FOUND"
        );

        const user = localStorage.getItem("user");
        if (user) {
          try {
            const userData = JSON.parse(user);
            console.log(
              "ðŸ‘¤ Current user:",
              userData.email,
              "Role:",
              userData.role
            );
          } catch (e) {
            console.error("Failed to parse user data:", e);
          }
        }

        initializeCountyDropdown("countySelect", "subCountySelect");
        initializeMap();
        initializeThemeSelection();
        initializeFileUpload();
        initializeFormProgress();
        initializeBudgetFormatting();
      });

      // Map initialization
      let map;
      let markers = [];
      let selectedLocations = [];

      function updateLocation(marker, newLngLat) {
        // Find the location in our array and update it
        const locationIndex = selectedLocations.findIndex(
          (loc) => loc.marker === marker
        );
        if (locationIndex !== -1) {
          selectedLocations[locationIndex].lat = newLngLat.lat;
          selectedLocations[locationIndex].lng = newLngLat.lng;
          updateLocationsDisplay();
          updateFormData();
        }
      }

      function removeLocation(locationId) {
        const locationIndex = selectedLocations.findIndex(
          (loc) => loc.id === locationId
        );
        if (locationIndex !== -1) {
          // Remove marker from map
          selectedLocations[locationIndex].marker.remove();

          // Remove from arrays
          selectedLocations.splice(locationIndex, 1);
          markers.splice(locationIndex, 1);

          updateLocationsDisplay();
          updateFormData();
        }
      }

      function updateLocationsDisplay() {
        const container = document.getElementById("selectedLocationsList");

        if (selectedLocations.length === 0) {
          container.innerHTML =
            '<p class="text-gray-500 italic">Click on map to add locations</p>';
          return;
        }

        // Clear container first
        container.innerHTML = "";

        // Process each location
        selectedLocations.forEach((location) => {
          const locationDiv = document.createElement("div");
          locationDiv.className =
            "flex items-center justify-between bg-white p-2 rounded border";

          // Check if we have a pre-defined name (from hospital or search)
          if (location.name) {
            // Display hospital or named location with detailed info
            locationDiv.innerHTML = `
              <div class="flex-1">
                <div class="text-sm font-semibold text-blue-600">
                  ${location.name}
                </div>
                ${location.county ? `<div class="text-xs text-gray-500">${location.county} County</div>` : ''}
                <div class="text-xs text-gray-400">${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}</div>
              </div>
              <button type="button" onclick="removeLocation(${location.id})"
                      class="text-red-500 hover:text-red-700 ml-2">
                <i class="fas fa-times"></i>
              </button>
            `;
            container.appendChild(locationDiv);
          } else {
            // Need to reverse geocode for unnamed locations
            locationDiv.innerHTML = `
              <span class="text-sm text-blue-600">
                <i class="fas fa-spinner fa-spin mr-2"></i>Loading location...
              </span>
              <button type="button" onclick="removeLocation(${location.id})"
                      class="text-red-500 hover:text-red-700 ml-2">
                <i class="fas fa-times"></i>
              </button>
            `;
            container.appendChild(locationDiv);

            // Reverse geocode to get place name
            fetch(
              `https://api.mapbox.com/geocoding/v5/mapbox.places/${location.lng},${location.lat}.json?access_token=${mapboxgl.accessToken}&types=place,region,country`
            )
              .then((response) => response.json())
              .then((data) => {
                let placeName = `${location.lat.toFixed(
                  4
                )}, ${location.lng.toFixed(4)}`; // fallback

                if (data.features && data.features.length > 0) {
                  // Try to get a meaningful place name
                  const place = data.features.find((f) =>
                    f.place_type.includes("place")
                  );
                  const region = data.features.find((f) =>
                    f.place_type.includes("region")
                  );
                  const country = data.features.find((f) =>
                    f.place_type.includes("country")
                  );

                  if (place) {
                    placeName = `${place.text}, ${
                      country ? country.text : "Kenya"
                    }`;
                  } else if (region) {
                    placeName = `${region.text}, Kenya`;
                  } else if (country) {
                    placeName = `${country.text}`;
                  }
                }

                locationDiv.innerHTML = `
                  <div class="flex-1">
                    <div class="text-sm font-semibold text-blue-600">
                      ${placeName}
                    </div>
                    <div class="text-xs text-gray-400">${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}</div>
                  </div>
                  <button type="button" onclick="removeLocation(${location.id})"
                          class="text-red-500 hover:text-red-700 ml-2">
                    <i class="fas fa-times"></i>
                  </button>
                `;
              })
              .catch((error) => {
                console.error("Geocoding error:", error);
                locationDiv.innerHTML = `
                  <div class="flex-1">
                    <div class="text-sm font-semibold text-blue-600">
                      ${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}
                    </div>
                    <div class="text-xs text-gray-400">Custom Location</div>
                  </div>
                  <button type="button" onclick="removeLocation(${location.id})"
                          class="text-red-500 hover:text-red-700 ml-2">
                    <i class="fas fa-times"></i>
                  </button>
                `;
              });
          }
        });
      }

      function updateFormData() {
        const locationsData = selectedLocations.map((loc) => ({
          latitude: loc.lat,
          longitude: loc.lng,
          county: loc.county || null,
          subCounty: loc.subCounty || null,
          mapsAddress: loc.name
            ? `${loc.name}, ${loc.county || ''}`.trim()
            : `${loc.lat},${loc.lng}`,
        }));
        document.getElementById("project_locations").value =
          JSON.stringify(locationsData);
      }

      // Make removeLocation function globally available
      window.removeLocation = removeLocation;

      function initializeMap() {
        try {
          mapboxgl.accessToken =
            "pk.eyJ1IjoibG9tb2dhbnRlY2giLCJhIjoiY2xzOTcyYXdlMDUxZDJsbXRnZGh2ZmpoYyJ9.sIWvONzgGPF2rtAcECsrJQ";

          map = new mapboxgl.Map({
            container: "newProjectMap",
            style: "mapbox://styles/mapbox/streets-v11",
            center: [37.9062, -0.0236], // Center of Kenya
            zoom: 6,
          });

          map.on("click", function (e) {
            const lngLat = e.lngLat;

            // Create a new marker
            const marker = new mapboxgl.Marker({
              color: "#3B82F6",
              draggable: true,
            })
              .setLngLat(lngLat)
              .addTo(map);

            // Add drag functionality
            marker.on("dragend", function () {
              updateLocation(marker, marker.getLngLat());
            });

            // Store the location
            const locationData = {
              id: Date.now(),
              lat: lngLat.lat,
              lng: lngLat.lng,
              marker: marker,
            };

            selectedLocations.push(locationData);
            markers.push(marker);

            updateLocationsDisplay();
            updateFormData();
          });

          // Wait for map to load before adding hospital markers and initializing search
          map.on("load", function () {
            addHospitalMarkers();
            initializeMapSearch();
          });
        } catch (error) {
          console.error("Map initialization failed:", error);
          document.getElementById("newProjectMap").innerHTML =
            '<div class="flex items-center justify-center h-full text-gray-500"><div class="text-center"><i class="fas fa-map-marked-alt text-4xl mb-2"></i><p>Map unavailable</p><p class="text-sm">Please check Mapbox configuration</p></div></div>';
        }
      }

      // Map search functionality
      function initializeMapSearch() {
        const searchInput = document.getElementById("mapSearchInput");
        const searchResults = document.getElementById("searchResults");
        const clearSearchBtn = document.getElementById("clearSearchBtn");
        let searchTimeout;
        let currentSearchMarker = null;

        // Search input handler with debounce
        searchInput.addEventListener("input", function (e) {
          const query = e.target.value.trim();

          // Show/hide clear button
          if (query) {
            clearSearchBtn.classList.remove("hidden");
          } else {
            clearSearchBtn.classList.add("hidden");
            searchResults.innerHTML = "";
            searchResults.classList.add("hidden");
            return;
          }

          // Debounce search
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            performSearch(query);
          }, 300);
        });

        // Clear search button
        clearSearchBtn.addEventListener("click", function () {
          searchInput.value = "";
          searchResults.innerHTML = "";
          searchResults.classList.add("hidden");
          clearSearchBtn.classList.add("hidden");

          // Remove search marker if exists
          if (currentSearchMarker) {
            currentSearchMarker.remove();
            currentSearchMarker = null;
          }
        });

        // Close search results when clicking outside
        document.addEventListener("click", function (e) {
          if (
            !searchInput.contains(e.target) &&
            !searchResults.contains(e.target)
          ) {
            searchResults.classList.add("hidden");
          }
        });

        // Show results when input is focused and has value
        searchInput.addEventListener("focus", function () {
          if (searchInput.value.trim() && searchResults.children.length > 0) {
            searchResults.classList.remove("hidden");
          }
        });

        async function performSearch(query) {
          try {
            // Show loading state
            searchResults.innerHTML = `
              <div class="p-4 text-center text-gray-500">
                <i class="fas fa-spinner fa-spin mr-2"></i>
                Searching...
              </div>
            `;
            searchResults.classList.remove("hidden");

            // Mapbox Geocoding API - prioritize Kenya locations
            const response = await fetch(
              `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(
                query
              )}.json?access_token=${
                mapboxgl.accessToken
              }&country=KE&limit=8&types=place,locality,neighborhood,address,poi,region,district`
            );

            if (!response.ok) {
              throw new Error("Search failed");
            }

            const data = await response.json();

            if (!data.features || data.features.length === 0) {
              searchResults.innerHTML = `
                <div class="p-4 text-center text-gray-500">
                  <i class="fas fa-search mr-2"></i>
                  No results found for "${query}"
                </div>
              `;
              return;
            }

            // Display results
            displaySearchResults(data.features);
          } catch (error) {
            console.error("Search error:", error);
            searchResults.innerHTML = `
              <div class="p-4 text-center text-red-500">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Search failed. Please try again.
              </div>
            `;
          }
        }

        function displaySearchResults(features) {
          searchResults.innerHTML = "";

          features.forEach((feature) => {
            const resultItem = document.createElement("div");
            resultItem.className =
              "px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-200 last:border-b-0 transition-colors";

            // Get place type icon
            const placeType = feature.place_type[0];
            const icon = getPlaceTypeIcon(placeType);

            const placeName = feature.place_name || feature.text;

            resultItem.innerHTML = `
              <div class="flex items-start space-x-3">
                <div class="text-blue-500 mt-1">
                  <i class="${icon}"></i>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="font-medium text-gray-900 truncate">
                    ${feature.text}
                  </div>
                  <div class="text-sm text-gray-500 truncate">
                    ${placeName}
                  </div>
                  ${
                    feature.properties.category
                      ? `<div class="text-xs text-gray-400 mt-1">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100">
                      ${feature.properties.category}
                    </span>
                  </div>`
                      : ""
                  }
                </div>
                <div class="text-xs text-gray-400 mt-1">
                  <i class="fas fa-chevron-right"></i>
                </div>
              </div>
            `;

            resultItem.addEventListener("click", function () {
              selectSearchResult(feature);
            });

            searchResults.appendChild(resultItem);
          });

          searchResults.classList.remove("hidden");
        }

        function getPlaceTypeIcon(placeType) {
          const iconMap = {
            place: "fas fa-city",
            locality: "fas fa-map-marker-alt",
            neighborhood: "fas fa-home",
            address: "fas fa-map-pin",
            poi: "fas fa-map-marked-alt",
            region: "fas fa-map",
            district: "fas fa-map-signs",
            country: "fas fa-flag",
          };
          return iconMap[placeType] || "fas fa-map-marker-alt";
        }

        function selectSearchResult(feature) {
          const [lng, lat] = feature.center;

          // Remove previous search marker
          if (currentSearchMarker) {
            currentSearchMarker.remove();
          }

          // Add a temporary search marker (different color)
          currentSearchMarker = new mapboxgl.Marker({
            color: "#10b981", // Green color for search results
            draggable: false,
          })
            .setLngLat([lng, lat])
            .setPopup(
              new mapboxgl.Popup({ offset: 25 }).setHTML(`
              <div class="p-2">
                <div class="font-semibold text-gray-900">${feature.text}</div>
                <div class="text-sm text-gray-600">${feature.place_name}</div>
                <button 
                  onclick="addSearchLocationToProject(${lat}, ${lng}, '${feature.text}')"
                  class="mt-2 w-full px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors"
                >
                  <i class="fas fa-plus mr-1"></i>
                  Add to Project
                </button>
              </div>
            `)
            )
            .addTo(map);

          // Open popup automatically
          currentSearchMarker.togglePopup();

          // Fly to location
          map.flyTo({
            center: [lng, lat],
            zoom: 14,
            duration: 2000,
          });

          // Update search input
          searchInput.value = feature.place_name;

          // Hide search results
          searchResults.classList.add("hidden");
        }
      }

      // Function to add search location to project (called from popup)
      window.addSearchLocationToProject = function (lat, lng, placeName) {
        // Create a new marker for the project
        const marker = new mapboxgl.Marker({
          color: "#3B82F6",
          draggable: true,
        })
          .setLngLat([lng, lat])
          .addTo(map);

        // Add drag functionality
        marker.on("dragend", function () {
          updateLocation(marker, marker.getLngLat());
        });

        // Store the location
        const locationData = {
          id: Date.now(),
          lat: lat,
          lng: lng,
          marker: marker,
          name: placeName,
        };

        selectedLocations.push(locationData);
        markers.push(marker);

        updateLocationsDisplay();
        updateFormData();

        // Close the search marker popup
        const searchMarker = map._markers?.find((m) => m.getPopup());
        if (searchMarker) {
          searchMarker.togglePopup();
        }

        // Show success message
        const successMessage = document.createElement("div");
        successMessage.className =
          "fixed top-20 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 flex items-center space-x-2";
        successMessage.innerHTML = `
          <i class="fas fa-check-circle"></i>
          <span>Location added to project!</span>
        `;
        document.body.appendChild(successMessage);

        setTimeout(() => {
          successMessage.remove();
        }, 3000);
      };

      // Kenya Hospitals Data for markers
      const kenyaHospitals = [
        {
          name: "Kenyatta National Hospital",
          county: "Nairobi",
          lat: -1.3009,
          lng: 36.8073,
          type: "National Referral",
        },
        {
          name: "Moi Teaching and Referral Hospital",
          county: "Uasin Gishu",
          lat: 0.5199,
          lng: 35.2697,
          type: "National Referral",
        },
        {
          name: "Coast General Hospital",
          county: "Mombasa",
          lat: -4.0465,
          lng: 39.6683,
          type: "County Referral",
        },
        {
          name: "Kisumu County Referral Hospital",
          county: "Kisumu",
          lat: -0.0917,
          lng: 34.768,
          type: "County Referral",
        },
        {
          name: "Nakuru Level 5 Hospital",
          county: "Nakuru",
          lat: -0.2827,
          lng: 36.08,
          type: "County Referral",
        },
        {
          name: "Nyeri County Referral Hospital",
          county: "Nyeri",
          lat: -0.4197,
          lng: 36.9519,
          type: "County Referral",
        },
        {
          name: "Garissa County Referral Hospital",
          county: "Garissa",
          lat: -0.4569,
          lng: 39.6582,
          type: "County Referral",
        },
        {
          name: "Machakos Level 5 Hospital",
          county: "Machakos",
          lat: -1.5177,
          lng: 37.2634,
          type: "County Referral",
        },
        {
          name: "Kakamega County General Hospital",
          county: "Kakamega",
          lat: 0.2827,
          lng: 34.7519,
          type: "County Referral",
        },
        {
          name: "Kitale County Referral Hospital",
          county: "Trans-Nzoia",
          lat: 0.9997,
          lng: 35.0067,
          type: "County Referral",
        },
        {
          name: "Embu Level 5 Hospital",
          county: "Embu",
          lat: -0.5317,
          lng: 37.4571,
          type: "County Referral",
        },
        {
          name: "Meru Level 5 Hospital",
          county: "Meru",
          lat: 0.0467,
          lng: 37.655,
          type: "County Referral",
        },
        {
          name: "Eldoret Hospital",
          county: "Uasin Gishu",
          lat: 0.5143,
          lng: 35.2698,
          type: "County Referral",
        },
      ];

      // Function to add hospital markers to the map
      function addHospitalMarkers() {
        kenyaHospitals.forEach((hospital) => {
          // Create custom HTML element for hospital marker
          const el = document.createElement("div");
          el.className = "hospital-marker";
          el.innerHTML = '<i class="fas fa-hospital"></i>';
          el.style.cssText = `
            background-color: #EF4444;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: box-shadow 0.2s, border-color 0.2s;
          `;

          // Add hover effect
          el.addEventListener("mouseenter", function () {
            el.style.boxShadow = "0 4px 16px rgba(239, 68, 68, 0.6)";
            el.style.borderColor = "#FEE2E2";
            el.style.zIndex = "1000";
          });
          el.addEventListener("mouseleave", function () {
            el.style.boxShadow = "0 2px 8px rgba(0,0,0,0.3)";
            el.style.borderColor = "white";
            el.style.zIndex = "1";
          });

          // Create popup content
          const popupContent = `
            <div class="hospital-popup" style="min-width: 220px;">
              <div style="margin-bottom: 8px;">
                <div style="font-weight: 600; color: #1f2937; font-size: 14px; margin-bottom: 4px;">
                  ${hospital.name}
                </div>
                <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px;">
                  <i class="fas fa-map-marker-alt" style="color: #6b7280; font-size: 11px;"></i>
                  <span style="color: #6b7280; font-size: 12px;">${hospital.county} County</span>
                </div>
                <div style="display: inline-block; background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-top: 4px;">
                  ${hospital.type}
                </div>
              </div>
              <button 
                onclick="addHospitalToProject('${hospital.name}', ${hospital.lat}, ${hospital.lng}, '${hospital.county}')"
                style="
                  width: 100%;
                  padding: 8px 12px;
                  background: #2563eb;
                  color: white;
                  border: none;
                  border-radius: 6px;
                  font-size: 13px;
                  font-weight: 500;
                  cursor: pointer;
                  transition: background 0.2s;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  gap: 6px;
                "
                onmouseover="this.style.background='#1d4ed8'"
                onmouseout="this.style.background='#2563eb'"
              >
                <i class="fas fa-plus-circle"></i>
                <span>Add to Project Locations</span>
              </button>
            </div>
          `;

          // Create marker with custom element
          const marker = new mapboxgl.Marker({
            element: el,
            anchor: "center",
          })
            .setLngLat([hospital.lng, hospital.lat])
            .setPopup(
              new mapboxgl.Popup({
                offset: 25,
                closeButton: true,
                closeOnClick: false,
                maxWidth: "300px",
              }).setHTML(popupContent)
            )
            .addTo(map);

          // Open popup on click
          el.addEventListener("click", function (e) {
            e.stopPropagation();
            marker.togglePopup();
          });
        });
      }

      // Function to add hospital to project locations
      window.addHospitalToProject = function (hospitalName, lat, lng, county) {
        // Create a new project marker
        const marker = new mapboxgl.Marker({
          color: "#3B82F6",
          draggable: true,
        })
          .setLngLat([lng, lat])
          .addTo(map);

        // Add drag functionality
        marker.on("dragend", function () {
          updateLocation(marker, marker.getLngLat());
        });

        // Store the location
        const locationData = {
          id: Date.now(),
          lat: lat,
          lng: lng,
          marker: marker,
          name: hospitalName,
          county: county,
        };

        selectedLocations.push(locationData);
        markers.push(marker);

        updateLocationsDisplay();
        updateFormData();

        // Close all popups
        const popups = document.getElementsByClassName("mapboxgl-popup");
        if (popups.length) {
          for (let i = 0; i < popups.length; i++) {
            popups[i].remove();
          }
        }

        // Show success notification
        const notification = document.createElement("div");
        notification.style.cssText = `
          position: fixed;
          top: 80px;
          right: 20px;
          background: #10b981;
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          z-index: 10000;
          display: flex;
          align-items: center;
          gap: 10px;
          font-size: 14px;
          font-weight: 500;
        `;
        notification.innerHTML = `
          <i class="fas fa-check-circle"></i>
          <span>${hospitalName} added to project!</span>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
          notification.remove();
        }, 3000);

        // Zoom to the location
        map.flyTo({
          center: [lng, lat],
          zoom: 13,
          duration: 1500,
        });
      };

      // Theme selection handling
      function initializeThemeSelection() {
        const themeCheckboxes = document.querySelectorAll(
          'input[name="themes"]'
        );
        const selectedThemesInput = document.getElementById("selected_themes");
        const themesCountDisplay = document.getElementById("themesCount");
        const themeValidationError = document.getElementById(
          "themeValidationError"
        );
        const selectedThemesDisplay = document.getElementById(
          "selectedThemesDisplay"
        );

        function updateSelectedThemes() {
          const selectedThemes = Array.from(themeCheckboxes)
            .filter((checkbox) => checkbox.checked)
            .map((checkbox) => checkbox.value);

          selectedThemesInput.value = JSON.stringify(selectedThemes);
          themesCountDisplay.textContent = selectedThemes.length;

          // Update visual feedback for each theme option
          themeCheckboxes.forEach((checkbox) => {
            const themeOption = checkbox.closest(".theme-option");
            const checkmark = themeOption.querySelector(".checkmark");

            if (checkbox.checked) {
              themeOption.classList.add("border-blue-500", "bg-blue-50");
              themeOption.classList.remove(
                "border-gray-200",
                "hover:border-blue-400"
              );
              checkmark.classList.remove("hidden");
            } else {
              themeOption.classList.remove("border-blue-500", "bg-blue-50");
              themeOption.classList.add("border-gray-200");
              checkmark.classList.add("hidden");
            }
          });

          // Update counter styling
          if (selectedThemes.length > 0) {
            selectedThemesDisplay.classList.remove(
              "bg-gray-100",
              "text-gray-600"
            );
            selectedThemesDisplay.classList.add("bg-blue-50", "text-blue-700");
          } else {
            selectedThemesDisplay.classList.remove(
              "bg-blue-50",
              "text-blue-700"
            );
            selectedThemesDisplay.classList.add("bg-gray-100", "text-gray-600");
          }

          // Update form validation
          const themeContainer = document.querySelector(".theme-selection");
          if (selectedThemes.length === 0) {
            themeContainer.classList.add("border-red-500");
            themeContainer.classList.remove(
              "border-gray-200",
              "hover:border-blue-300"
            );
            themeValidationError.classList.remove("hidden");
          } else {
            themeContainer.classList.remove("border-red-500");
            themeContainer.classList.add("border-gray-200");
            themeValidationError.classList.add("hidden");
          }

          // Update file upload section based on theme selection
          // Note: new-priority.html doesn't have a separate supporting documents step,
          // but we can still validate NACOSTI requirement during submission
        }

        themeCheckboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", updateSelectedThemes);
        });

        // Initial update
        updateSelectedThemes();
      }

      // File upload handling
      let selectedFiles = [];

      function initializeFileUpload() {
        const fileUploadArea = document.getElementById("fileUploadArea");
        const documentFilesInput = document.getElementById("documentFiles");
        const selectedFilesDiv = document.getElementById("selectedFiles");
        const filesList = document.getElementById("filesList");
        const docsCount = document.getElementById("docsCount");
        const documentsCount = document.getElementById("documentsCount");

        // Click to open file dialog
        fileUploadArea.addEventListener("click", function () {
          documentFilesInput.click();
        });

        // Drag and drop functionality
        fileUploadArea.addEventListener("dragover", function (e) {
          e.preventDefault();
          fileUploadArea.classList.add("border-blue-500", "bg-blue-50");
        });

        fileUploadArea.addEventListener("dragleave", function (e) {
          e.preventDefault();
          fileUploadArea.classList.remove("border-blue-500", "bg-blue-50");
        });

        fileUploadArea.addEventListener("drop", function (e) {
          e.preventDefault();
          fileUploadArea.classList.remove("border-blue-500", "bg-blue-50");

          const files = Array.from(e.dataTransfer.files);
          handleFileSelection(files);
        });

        // File input change
        documentFilesInput.addEventListener("change", function (e) {
          const files = Array.from(e.target.files);
          handleFileSelection(files);
        });

        function handleFileSelection(files) {
          const validFiles = [];
          const errors = [];

          files.forEach((file) => {
            // Validate file type
            const allowedTypes = [
              "application/pdf",
              "application/msword",
              "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
              "application/vnd.ms-excel",
              "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            ];
            const allowedExtensions = [
              ".pdf",
              ".doc",
              ".docx",
              ".xls",
              ".xlsx",
            ];

            const fileExtension = file.name
              .toLowerCase()
              .substring(file.name.lastIndexOf("."));
            const isValidType =
              allowedTypes.includes(file.type) ||
              allowedExtensions.includes(fileExtension);

            if (!isValidType) {
              errors.push(
                `${file.name}: Invalid file type. Only PDF, DOC, DOCX, XLS, XLSX allowed.`
              );
              return;
            }

            // Validate file size (10MB max)
            const maxSize = 10 * 1024 * 1024; // 10MB in bytes
            if (file.size > maxSize) {
              errors.push(
                `${file.name}: File too large. Maximum size is 10MB.`
              );
              return;
            }

            // Check for duplicates
            const isDuplicate = selectedFiles.some(
              (existingFile) =>
                existingFile.name === file.name &&
                existingFile.size === file.size
            );

            if (isDuplicate) {
              errors.push(`${file.name}: File already selected.`);
              return;
            }

            validFiles.push(file);
          });

          // Show errors if any
          if (errors.length > 0) {
            showFileError(errors.join("<br>"));
            return;
          }

          // Hide error if shown
          hideFileError();

          // Add valid files
          selectedFiles.push(...validFiles);
          updateFileDisplay();

          // Clear input
          documentFilesInput.value = "";
        }

        function updateFileDisplay() {
          if (selectedFiles.length === 0) {
            selectedFilesDiv.classList.add("hidden");
            documentsCount.classList.remove("bg-blue-50", "text-blue-700");
            documentsCount.classList.add("bg-gray-100", "text-gray-600");
          } else {
            selectedFilesDiv.classList.remove("hidden");
            documentsCount.classList.remove("bg-gray-100", "text-gray-600");
            documentsCount.classList.add("bg-blue-50", "text-blue-700");
          }

          docsCount.textContent = selectedFiles.length;

          // Clear existing list
          filesList.innerHTML = "";

          // Add files to list
          selectedFiles.forEach((file, index) => {
            const fileDiv = document.createElement("div");
            fileDiv.className =
              "flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200";

            const fileIcon = getFileIcon(file.name);
            const fileSize = formatFileSize(file.size);

            fileDiv.innerHTML = `
              <div class="flex items-center space-x-3">
                <div class="text-blue-500">
                  <i class="${fileIcon}"></i>
                </div>
                <div>
                  <p class="text-sm font-medium text-gray-800">${file.name}</p>
                  <p class="text-xs text-gray-500">${fileSize}</p>
                </div>
              </div>
              <button type="button" onclick="removeFile(${index})" class="text-red-500 hover:text-red-700 transition-colors">
                <i class="fas fa-times"></i>
              </button>
            `;

            filesList.appendChild(fileDiv);
          });
        }

        function getFileIcon(filename) {
          const extension = filename.toLowerCase().split(".").pop();
          switch (extension) {
            case "pdf":
              return "fas fa-file-pdf";
            case "doc":
            case "docx":
              return "fas fa-file-word";
            case "xls":
            case "xlsx":
              return "fas fa-file-excel";
            default:
              return "fas fa-file";
          }
        }

        function formatFileSize(bytes) {
          if (bytes === 0) return "0 Bytes";
          const k = 1024;
          const sizes = ["Bytes", "KB", "MB", "GB"];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return (
            parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
          );
        }

        function showFileError(message) {
          const errorDiv = document.getElementById("fileUploadError");
          const errorMessage = document.getElementById("fileErrorMessage");
          errorMessage.innerHTML = message;
          errorDiv.classList.remove("hidden");
        }

        function hideFileError() {
          const errorDiv = document.getElementById("fileUploadError");
          errorDiv.classList.add("hidden");
        }

        // Make removeFile function globally available
        window.removeFile = function (index) {
          selectedFiles.splice(index, 1);
          updateFileDisplay();
        };
      }

      // Form progress tracking
      function initializeFormProgress() {
        const progressSteps = document.querySelectorAll(".progress-step");
        let currentSection = 1;

        // Update progress when user scrolls or focuses on sections
        function updateProgress() {
          const sections = document.querySelectorAll(".form-section");
          const scrollPosition = window.scrollY + 200; // Offset for header

          sections.forEach((section, index) => {
            const sectionTop = section.offsetTop;
            const sectionBottom = sectionTop + section.offsetHeight;

            if (
              scrollPosition >= sectionTop &&
              scrollPosition < sectionBottom
            ) {
              currentSection = index + 1;
              updateProgressIndicator(currentSection);
            }
          });
        }

        function updateProgressIndicator(activeSection) {
          progressSteps.forEach((step, index) => {
            const stepNumber = index + 1;

            // Remove all classes
            step.classList.remove("current", "completed", "pending");

            if (stepNumber < activeSection) {
              step.classList.add("completed");
            } else if (stepNumber === activeSection) {
              step.classList.add("current");
            } else {
              step.classList.add("pending");
            }
          });
        }

        // Add scroll listener
        window.addEventListener("scroll", updateProgress);

        // Initial progress update
        updateProgress();
      }

      // Budget input formatting
      function initializeBudgetFormatting() {
        const budgetInput = document.getElementById("budget");

        budgetInput.addEventListener("input", function (e) {
          // Remove all non-digit characters except decimal point
          let value = e.target.value.replace(/[^\d]/g, "");

          // Format with commas
          if (value) {
            value = parseInt(value).toLocaleString("en-US");
          }

          // Update the input value
          e.target.value = value;
        });

        // Prevent non-numeric input on keypress
        budgetInput.addEventListener("keypress", function (e) {
          // Allow backspace, delete, tab, escape, enter, and decimal point
          if (
            [8, 9, 27, 13, 110, 190].includes(e.keyCode) ||
            // Allow Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X, Ctrl+Z
            (e.ctrlKey && [65, 67, 86, 88, 90].includes(e.keyCode))
          ) {
            return;
          }

          // Block non-numeric characters
          if (
            (e.shiftKey || e.keyCode < 48 || e.keyCode > 57) &&
            (e.keyCode < 96 || e.keyCode > 105)
          ) {
            e.preventDefault();
          }
        });
      }

      // Add event listeners for county/sub-county dropdowns to zoom map
      document
        .getElementById("countySelect")
        .addEventListener("change", function () {
          const selectedCounty = this.value;
          if (
            selectedCounty &&
            window.countyCoordinates &&
            window.countyCoordinates[selectedCounty] &&
            map
          ) {
            const [lng, lat] = window.countyCoordinates[selectedCounty];
            map.flyTo({
              center: [lng, lat],
              zoom: 9,
            });
          }
        });

      document
        .getElementById("subCountySelect")
        .addEventListener("change", function () {
          const selectedSubCounty = this.value;
          if (
            selectedSubCounty &&
            window.subCountyCoordinates &&
            window.subCountyCoordinates[selectedSubCounty] &&
            map
          ) {
            const [lng, lat] = window.subCountyCoordinates[selectedSubCounty];
            map.flyTo({
              center: [lng, lat],
              zoom: 11,
            });
          }
        });

      // Form submission
      document
        .getElementById("projectForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          console.log("ðŸš€ FORM SUBMISSION STARTED");
          console.log("Form event triggered at:", new Date().toISOString());

          // Don't use FormData(this) to avoid including empty file inputs
          // Instead, collect form data manually
          const formData = new FormData();

          // Add all form fields except file inputs
          const formElements = this.querySelectorAll(
            'input:not([type="file"]), textarea, select'
          );
          formElements.forEach((element) => {
            if (element.name && element.value) {
              formData.append(element.name, element.value);
            }
          });

          // Add selected files to FormData (only valid files)
          selectedFiles
            .filter((f) => f.size > 0)
            .forEach((file) => {
              formData.append(`documents`, file);
            });

          // Get form data as object for validation and logging
          const data = {};
          for (let [key, value] of formData.entries()) {
            if (key !== "documents") {
              // Skip files for validation
              data[key] = value;
            }
          }

          console.log("=== FORM SUBMISSION DEBUG ===");
          console.log("Raw FormData entries:");
          for (let [key, value] of formData.entries()) {
            if (key === "documents") {
              console.log(
                `${key}: [File - ${value.name}, ${value.size} bytes]`
              );
            } else {
              console.log(`${key}: ${value}`);
            }
          }
          console.log("Parsed data object:", data);

          // Parse locations and themes from JSON strings
          try {
            if (data.locations) {
              data.locations = JSON.parse(data.locations);
              console.log("Parsed locations:", data.locations);
            }
            if (data.selected_themes) {
              data.themes = JSON.parse(data.selected_themes);
              formData.delete("selected_themes"); // Remove from FormData
              formData.append("themes", JSON.stringify(data.themes)); // Add parsed themes
              console.log("Parsed themes:", data.themes);
            }

            // Clean budget value (remove commas for submission)
            if (data.budget) {
              const cleanBudget = data.budget.replace(/,/g, "");
              formData.set("budget", cleanBudget);
              data.budget = cleanBudget;
              console.log("Cleaned budget:", data.budget);
            }

            // Validate required fields
            if (!data.themes || data.themes.length === 0) {
              const themeValidationError = document.getElementById(
                "themeValidationError"
              );
              themeValidationError.classList.remove("hidden");
              const themeContainer = document.querySelector(".theme-selection");
              themeContainer.classList.add("border-red-500");
              themeContainer.classList.remove(
                "border-gray-200",
                "hover:border-blue-300"
              );
              themeContainer.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });
              return;
            }

            // Validate NACOSTI Certificate requirement for Research & Learning theme
            if (data.themes && data.themes.includes("RESEARCH_LEARNING")) {
              const hasNacostiCert = selectedFiles.some(file =>
                file.name.toLowerCase().includes("nacosti") ||
                file.name.toLowerCase().includes("certificate") ||
                file.name.toLowerCase().includes("nacosti certificate")
              );

              if (!hasNacostiCert) {
                await showAlert(
                  "For Research & Learning projects, you must upload a NACOSTI Certificate (National Commission for Science, Technology and Innovation).",
                  "Required Document Missing",
                  "warning"
                );

                // Scroll to the bottom of the form where files would be uploaded
                window.scrollTo({
                  top: document.body.scrollHeight,
                  behavior: "smooth",
                });

                // Hide loading overlay and re-enable submit button
                loadingOverlay.classList.add("hidden");
                enableSubmitButton();
                return;
              }
            }

            if (!data.locations || data.locations.length === 0) {
              await showAlert(
                "Please select at least one location on the map.",
                "Validation Error",
                "warning"
              );
              return;
            }

            // Get current user for partner field
            const currentUser = JSON.parse(
              localStorage.getItem("user") || "{}"
            );

            // Create project object as expected by backend
            const projectData = {
              title: data.title,
              partner: currentUser.email || data.contact_person_mail, // Use current user email or fallback
              startDate: data.start_date,
              endDate: data.end_date,
              activityType: data.activity_type,
              budget: parseFloat(data.budget) || 0,
              objectives: data.objectives,
              locations: data.locations.map((loc) => ({
                latitude: loc.latitude,
                longitude: loc.longitude,
                county: loc.county || null, // Don't default to incorrect county
                subCounty: loc.subCounty || null,
                mapsAddress:
                  loc.mapsAddress || `${loc.latitude},${loc.longitude}`,
              })),
              themes: data.themes,
              contactPersonName: data.contact_person_name,
              contactPersonRole: data.contact_person_role,
              contactPersonEmail: data.contact_person_mail,
              projectCategory: "PRIORITY", // Set as PRIORITY project
            };

            console.log("Project data object to send:", projectData);

            // Backend expects a 'project' field with JSON data
            const finalFormData = new FormData();

            // Add project data as a Blob with correct content-type
            const projectBlob = new Blob([JSON.stringify(projectData)], {
              type: "application/json",
            });
            finalFormData.append("project", projectBlob);

            // Add files (filter out empty files)
            selectedFiles
              .filter((f) => f.size > 0)
              .forEach((file) => {
                finalFormData.append("supporting_documents", file);
              });

            console.log("Final FormData with project field:");
            for (let [key, value] of finalFormData.entries()) {
              if (key === "supporting_documents") {
                console.log(
                  `${key}: [File - ${value.name}, ${value.size} bytes]`
                );
              } else if (key === "project") {
                console.log(
                  `${key}: [Blob - ${value.size} bytes, type: ${value.type}]`
                );
              } else {
                console.log(`${key}: ${value}`);
              }
            }

            // Get authentication token
            const token =
              localStorage.getItem("token") ||
              localStorage.getItem("accessToken");
            console.log(
              "ðŸ” Authentication token found:",
              token ? "Yes (length: " + token.length + ")" : "No"
            );

            if (!token) {
              console.error("âŒ No authentication token found!");
              await showAlert(
                "You must be logged in to create a project. Please log in first.",
                "Authentication Required",
                "warning"
              );
              window.location.href = "index.html";
              return;
            }

            console.log(
              "ðŸ“¡ Sending request to:",
              `${window.BASE_URL}/api/projects`
            );
            const response = await fetch(`${window.BASE_URL}/api/projects`, {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
              },
              body: finalFormData,
            });

            console.log("Response status:", response.status);
            console.log(
              "Response headers:",
              Object.fromEntries(response.headers.entries())
            );

            if (response.ok) {
              const result = await response.json();
              console.log("Project created successfully!", result);
              
              // Extract project number from response
              const projectNumber = result.data?.projectNo || result.projectNo || 'N/A';
              
              // Show success message with project number and copy option
              const projectNumberHtml = `
                <div class="text-center">
                  <p class="text-lg mb-4">Your priority project has been created successfully!</p>
                  <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-4">
                    <p class="text-sm text-gray-600 mb-2">Your Project Number:</p>
                    <p class="text-2xl font-bold text-blue-700" id="projectNumberDisplay">${projectNumber}</p>
                  </div>
                  <button onclick="navigator.clipboard.writeText('${projectNumber}').then(() => alert('Project number copied to clipboard!'))" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                    <i class="fas fa-copy mr-2"></i>Copy Project Number
                  </button>
                  <p class="text-sm text-gray-600 mt-4">âš ï¸ Please save this project number for future reference.</p>
                </div>
              `;
              
              await showAlert(
                projectNumberHtml,
                "Priority Project Created Successfully!",
                "success"
              );
              window.location.href = "projects.html";
            } else {
              let errorMessage = "Unknown error";
              let errorDetails = {};

              try {
                const errorResponse = await response.text();
                console.log("Raw error response:", errorResponse);

                try {
                  errorDetails = JSON.parse(errorResponse);
                  console.log("Parsed error response:", errorDetails);
                  errorMessage =
                    errorDetails.message || errorDetails.error || errorMessage;
                } catch (parseError) {
                  console.log("Could not parse error as JSON:", parseError);
                  errorMessage = errorResponse || errorMessage;
                }
              } catch (textError) {
                console.error("Error reading response text:", textError);
              }

              console.error("Final error message:", errorMessage);
              console.error("Full error details:", errorDetails);

              await showAlert(
                "Failed to create project: " + errorMessage,
                "Error",
                "error"
              );
            }
          } catch (error) {
            console.error("Error processing form data:", error);
            console.error("Error stack:", error.stack);
            await showAlert(
              "Error processing form data. Please try again. Check console for details.",
              "Error",
              "error"
            );
          }
        });
    </script>
  </body>
</html>
