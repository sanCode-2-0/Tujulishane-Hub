<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>New Project - RMNCAH</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
		integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
		crossorigin="anonymous" referrerpolicy="no-referrer" />
	<!-- Tailwind CSS (with custom config using inline script) -->
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						primary: "#1e40af", // Custom Blue
						secondary: "#f59e0b", // Custom Amber
						accent: "#10b981", // Custom Green
						dark: "#1f2937", // Gray-800
					},
					fontFamily: {
						sans: ["Inter", "sans-serif"],
					},
				},
			},
		};
	</script>
	<link rel="stylesheet" href="styles/main.css" />
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css" />
	<!-- Modal Utilities -->
	<script src="modal-utils.js"></script>
	<script src="auth.js"></script>
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
		integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800;900&display=swap"
		rel="stylesheet" />
	<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
	<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
	<link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
</head>

<body x-data="adminApprovalsApp()" x-init="init()" class="text-gray-800">
	<script>
		window.adminApprovalsApp = function adminApprovalsApp() {
			return {
				announcements: [],
				myProjects: [],
				organizations: [],
				myCollaborationRequests: [], // Track user's submitted requests
				chatMessages: [],
				sendingMessage: false,
				newMessage: "",
				searchText: "",
				filterStatus: "",
				sortOrder: "NEWEST",
				activeSlide: 0,
				media: [
					{ type: 'image', src: 'resources/images/main-1.jpg' },
					{ type: 'image', src: 'resources/images/main-2.jpg' },
					{ type: 'image', src: 'resources/images/main-3.jpg' }
				],
				loading: true,
				creating: false,
				submitting: false,
				showCreateModal: false,
				showDetailsModal: false,
				showRequestModal: false,
				selectedAnnouncement: null,
				userRole: null, // Will be set in init from user object
				currentUser: null, // Store current user data including email
				newAnnouncement: {
					projectId: "",
					title: "",
					content: "",
					deadline: "",
				},
				collaborationRequest: {
					organizationId: "",
					proposedContribution: "",
				},

				async init() {
					// Wait for auth.js to load user data and get it directly
					const user = await this.waitForAuth();

					// Set user role and store user data from the returned user object
					if (user && user.role) {
						this.userRole = user.role;
						this.currentUser = user; // Store full user object
					} else {
						// Fallback: try to read from localStorage
						const userStr = localStorage.getItem("currentUser");
						if (userStr) {
							try {
								const parsedUser = JSON.parse(userStr);
								this.userRole = parsedUser.role;
								this.currentUser = parsedUser;
							} catch (e) {
								console.error("Error parsing user data:", e);
							}
						}
						// Final fallback to userRole if it exists
						if (!this.userRole) {
							this.userRole = localStorage.getItem("userRole");
						}
					}
					console.log("üîç User Role:", this.userRole); // Debug log
					console.log("üîç Current User:", this.currentUser); // Debug log

					// Populate user dropdown in navigation
					if (this.currentUser) {
						console.log("üë§ Populating user dropdown...");
						this.populateUserDropdown(this.currentUser);
					}

					await this.loadAnnouncements();

					// Always try to load projects if user is authenticated
					// The backend will handle authorization
					const token = localStorage.getItem("accessToken");
					if (token) {
						console.log("üîç User authenticated, loading projects...");
						await this.loadMyProjects();
						await this.loadOrganizations();
						// Load user's collaboration requests to prevent duplicates
						await this.loadMyCollaborationRequests();
					} else {
						console.warn("‚ö†Ô∏è No access token found, skipping project load");
					}
				},

				// Populate user dropdown with current user data
				populateUserDropdown(user) {
					try {
						const userDisplayName =
							document.getElementById("userDisplayName");
						const userNameDisplay =
							document.getElementById("userNameDisplay");
						const userEmailDisplay =
							document.getElementById("userEmailDisplay");
						const userRoleDisplay =
							document.getElementById("userRoleDisplay");
						const userStatusDisplay =
							document.getElementById("userStatusDisplay");

						if (userDisplayName)
							userDisplayName.textContent = user.name || "User";
						if (userNameDisplay)
							userNameDisplay.textContent = user.name || "Loading...";
						if (userEmailDisplay)
							userEmailDisplay.textContent = user.email || "";
						if (userRoleDisplay)
							userRoleDisplay.textContent = user.role || "N/A";
						if (userStatusDisplay) {
							userStatusDisplay.textContent = user.status || "N/A";
							// Update status color based on status
							userStatusDisplay.className =
								user.status === "ACTIVE"
									? "font-medium text-green-600"
									: "font-medium text-gray-600";
						}

						// Show role-based navs
						if (
							user.role === "ADMIN" ||
							user.role === "SUPER_ADMIN" ||
							user.role === "SUPER_ADMIN_REVIEWER" ||
							user.role === "SUPER_ADMIN_APPROVER" ||
							user.role === "SUPER_ADMIN_REVIEWER" ||
							user.role === "SUPER_ADMIN_APPROVER"
						) {
							const adminNav = document.getElementById("adminNav");
							if (adminNav) adminNav.classList.remove("hidden");
						}
						if (user.role === "DONOR") {
							const donorNav = document.getElementById("donorNav");
							if (donorNav) donorNav.classList.remove("hidden");
						}

						console.log("‚úÖ User dropdown populated successfully!");
					} catch (error) {
						console.error("‚ùå Error populating user dropdown:", error);
					}
				},

				async waitForAuth() {
					// Wait for AuthManager to be available and initialized
					let attempts = 0;
					while (attempts < 50) {
						// Max 5 seconds
						if (
							window.authManager &&
							typeof window.authManager.getCurrentUser === "function"
						) {
							// Try to get current user and return it directly
							try {
								const user = await window.authManager.getCurrentUser();
								return user; // Return the user object
							} catch (e) {
								// User not logged in or error
								return null;
							}
						}
						await new Promise((resolve) => setTimeout(resolve, 100));
						attempts++;
					}
					return null; // Timeout - no auth available
				},

				async loadAnnouncements() {
					try {
						const response = await fetch(
							`${window.BASE_URL}/api/announcements`
						);
						
						if (!response.ok) {
							console.warn("Failed to load announcements:", response.status);
							return; // Silently fail - announcements are not critical
						}
						
						const data = await response.json();
						if (data.status === 200) {
							this.announcements = data.data;
						}
					} catch (error) {
						console.error("Error loading announcements:", error);
						// Don't show alert - announcements are optional feature
					} finally {
						this.loading = false;
					}
				},

				async loadMyProjects() {
					try {
						const token = localStorage.getItem("accessToken");
						console.log(
							"üîç Loading my projects with token:",
							token ? "Present" : "Missing"
						);

						const response = await fetch(
							`${window.BASE_URL}/api/projects/my-projects`,
							{
								headers: { Authorization: `Bearer ${token}` },
							}
						);

						console.log("üîç My projects response status:", response.status);

						if (!response.ok) {
							console.error(
								"‚ùå Failed to load projects. Status:",
								response.status
							);
							if (response.status === 403) {
								console.error(
									"‚ùå 403 Forbidden - You may not have PARTNER role"
								);
							} else if (response.status === 401) {
								console.error(
									"‚ùå 401 Unauthorized - Token may be invalid or expired"
								);
							}
							this.myProjects = [];
							return;
						}

						const data = await response.json();
						console.log("üîç My projects response data:", data);

						if (data.status === 200) {
							this.myProjects = data.data || [];
							console.log(
								"‚úÖ Loaded projects:",
								this.myProjects.length,
								"projects"
							);
							console.log("üìã Projects:", this.myProjects);
						} else {
							console.warn("‚ö†Ô∏è Unexpected response status:", data.status);
							this.myProjects = [];
						}
					} catch (error) {
						console.error("‚ùå Error loading projects:", error);
						this.myProjects = [];
					}
				},

				async loadOrganizations() {
					try {
						const token = localStorage.getItem("accessToken");
						const response = await fetch(
							`${window.BASE_URL}/api/organizations`,
							{
								headers: { Authorization: `Bearer ${token}` },
							}
						);

						// Check if response is OK before parsing JSON
						if (!response.ok) {
							// Silently handle 403 - organizations endpoint may be restricted
							this.organizations = []; // Set empty array
							return;
						}

						const data = await response.json();
						if (data.status === 200) {
							this.organizations = data.data;
						}
					} catch (error) {
						// Silently handle errors - organizations are optional
						this.organizations = []; // Set empty array on error
					}
				},

				async loadMyCollaborationRequests() {
					try {
						const token = localStorage.getItem("accessToken");
						const response = await fetch(
							`${window.BASE_URL}/api/collaboration-requests/my-requests`,
							{
								headers: { Authorization: `Bearer ${token}` },
							}
						);

						if (!response.ok) {
							console.warn(
								"Could not load collaboration requests:",
								response.status
							);
							this.myCollaborationRequests = [];
							return;
						}

						const data = await response.json();
						if (data.status === 200) {
							this.myCollaborationRequests = data.data || [];
							console.log(
								"‚úÖ Loaded collaboration requests:",
								this.myCollaborationRequests.length
							);
						} else {
							this.myCollaborationRequests = [];
						}
					} catch (error) {
						console.error("Error loading collaboration requests:", error);
						this.myCollaborationRequests = [];
					}
				},

				async createAnnouncement() {
					this.creating = true;
					try {
						const token = localStorage.getItem("accessToken");
						const response = await fetch(
							`${window.BASE_URL}/api/announcements`,
							{
								method: "POST",
								headers: {
									"Content-Type": "application/json",
									Authorization: `Bearer ${token}`,
								},
								body: JSON.stringify(this.newAnnouncement),
							}
						);

						// Check if response is OK before parsing JSON
						if (!response.ok) {
							if (response.status === 403) {
								await showAlert(
									"Permission denied. You may not have access to create announcements.",
									"Permission Denied",
									"error"
								);
							} else if (response.status === 401) {
								await showAlert(
									"You must be logged in to create announcements.",
									"Authentication Required",
									"warning"
								);
							} else {
								await showAlert(
									`Error: Server returned status ${response.status}`,
									"Error",
									"error"
								);
							}
							return;
						}

						const data = await response.json();

						if (data.status === 201) {
							await showAlert(
								"Announcement created successfully!",
								"Success",
								"success"
							);
							this.showCreateModal = false;
							this.newAnnouncement = {
								projectId: "",
								title: "",
								content: "",
								deadline: "",
							};
							await this.loadAnnouncements();
						} else {
							await showAlert(
								"Error: " + (data.message || "Unknown error occurred"),
								"Error",
								"error"
							);
						}
					} catch (error) {
						console.error("Error creating announcement:", error);
						await showAlert(
							"Failed to create announcement. Please try again.",
							"Error",
							"error"
						);
					} finally {
						this.creating = false;
					}
				},

				viewDetails(announcement) {
					this.selectedAnnouncement = announcement;
					this.showDetailsModal = true;
					this.loadChatMessages(announcement.id);
				},

				requestCollaboration(announcement) {
					this.selectedAnnouncement = announcement;
					this.showRequestModal = true;
					this.showDetailsModal = false;
				},

				async submitRequest() {
					this.submitting = true;
					try {
						const token = localStorage.getItem("accessToken");

						// Prepare request payload - only include organizationId if it's not empty
						const payload = {
							proposedContribution:
								this.collaborationRequest.proposedContribution,
						};

						// Only add organizationId if it's set (not empty string)
						if (this.collaborationRequest.organizationId) {
							payload.organizationId = parseInt(
								this.collaborationRequest.organizationId
							);
						}

						const response = await fetch(
							`${window.BASE_URL}/api/collaboration-requests/announcements/${this.selectedAnnouncement.id}`,
							{
								method: "POST",
								headers: {
									"Content-Type": "application/json",
									Authorization: `Bearer ${token}`,
								},
								body: JSON.stringify(payload),
							}
						);

						// Always try to parse JSON to get the error message
						const data = await response.json();

						// Check if response is OK
						if (!response.ok) {
							if (response.status === 403) {
								await showAlert(
									"Permission denied: " +
									(data.message ||
										"You may not have access to submit collaboration requests."),
									"Permission Denied",
									"error"
								);
							} else if (response.status === 401) {
								await showAlert(
									"Authentication required: " +
									(data.message ||
										"You must be logged in to submit a collaboration request."),
									"Authentication Required",
									"warning"
								);
							} else if (response.status === 400) {
								await showAlert(
									"Invalid request: " +
									(data.message ||
										"Please check your input and try again."),
									"Invalid Request",
									"error"
								);
							} else {
								await showAlert(
									`Error: ${data.message ||
									"Server returned status " + response.status
									}`,
									"Error",
									"error"
								);
							}
							return;
						}

						if (data.status === 201) {
							await showAlert(
								"Collaboration request submitted successfully! The Ministry of Health will review your request.",
								"Success",
								"success"
							);
							this.showRequestModal = false;
							this.collaborationRequest = {
								organizationId: "",
								proposedContribution: "",
							};
							// Reload collaboration requests to update the UI
							await this.loadMyCollaborationRequests();
						} else {
							await showAlert(
								"Error: " + (data.message || "Unknown error occurred"),
								"Error",
								"error"
							);
						}
					} catch (error) {
						console.error("Error submitting request:", error);
						await showAlert(
							"Failed to submit collaboration request. Please try again.",
							"Error",
							"error"
						);
					} finally {
						this.submitting = false;
					}
				},

				// Helper method to check if announcement was created by current user
				isOwnAnnouncement(announcement) {
					if (!this.currentUser || !announcement || !announcement.createdBy) {
						console.log("üîç isOwnAnnouncement: Missing data", {
							hasCurrentUser: !!this.currentUser,
							hasAnnouncement: !!announcement,
							hasCreatedBy: !!(announcement && announcement.createdBy),
						});
						return false;
					}
					// Compare by email as it's unique
					const isOwn =
						this.currentUser.email === announcement.createdBy.email;
					console.log("üîç isOwnAnnouncement:", {
						currentUserEmail: this.currentUser.email,
						createdByEmail: announcement.createdBy.email,
						isOwn: isOwn,
					});
					return isOwn;
				},

				// Helper method to check if user has already requested collaboration for this announcement
				hasAlreadyRequested(announcement) {
					if (!announcement || !this.myCollaborationRequests) {
						return false;
					}

					const hasRequested = this.myCollaborationRequests.some(
						(request) =>
							request.announcement &&
							request.announcement.id === announcement.id
					);

					console.log("üîç hasAlreadyRequested:", {
						announcementId: announcement.id,
						totalRequests: this.myCollaborationRequests.length,
						hasRequested: hasRequested,
					});

					return hasRequested;
				},

				isDeadlineImminent(deadline) {
					if (!deadline) return false;
					const now = new Date();
					const deadlineDate = new Date(deadline);
					const diffTime = deadlineDate - now;
					const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
					return diffDays <= 7 && diffDays >= 0; // Imminent if within 7 days and not past
				},

				async loadChatMessages(announcementId) {
					try {
						const token = localStorage.getItem("accessToken");
						const response = await fetch(`${window.BASE_URL}/api/announcements/${announcementId}/messages`, {
							headers: { Authorization: `Bearer ${token}` }
						});
						if (response.ok) {
							const data = await response.json();
							this.chatMessages = data.data || [];
						}
					} catch (error) {
						console.error("Error loading chat messages:", error);
					}
				},

				async sendMessage() {
					if (!this.newMessage.trim()) return;
					this.sendingMessage = true;
					try {
						const token = localStorage.getItem("accessToken");
						const response = await fetch(`${window.BASE_URL}/api/announcements/${this.selectedAnnouncement.id}/messages`, {
							method: "POST",
							headers: {
								"Content-Type": "application/json",
								Authorization: `Bearer ${token}`
							},
							body: JSON.stringify({ message: this.newMessage })
						});
						if (response.ok) {
							this.newMessage = "";
							await this.loadChatMessages(this.selectedAnnouncement.id);
						} else {
							await showAlert("Failed to send message", "Error", "error");
						}
					} catch (error) {
						console.error("Error sending message:", error);
						await showAlert("Failed to send message", "Error", "error");
					} finally {
						this.sendingMessage = false;
					}
				},

				async editMessage(msg) {
					const newMessage = prompt("Edit message:", msg.message);
					if (newMessage && newMessage.trim() && newMessage !== msg.message) {
						try {
							const token = localStorage.getItem("accessToken");
							const response = await fetch(`${window.BASE_URL}/api/announcements/${this.selectedAnnouncement.id}/messages/${msg.id}`, {
								method: "PUT",
								headers: {
									"Content-Type": "application/json",
									Authorization: `Bearer ${token}`
								},
								body: JSON.stringify({ message: newMessage })
							});
							if (response.ok) {
								await this.loadChatMessages(this.selectedAnnouncement.id);
							} else {
								await showAlert("Failed to edit message", "Error", "error");
							}
						} catch (error) {
							console.error("Error editing message:", error);
							await showAlert("Failed to edit message", "Error", "error");
						}
					}
				},

				async deleteMessage(msg) {
					if (confirm("Are you sure you want to delete this message?")) {
						try {
							const token = localStorage.getItem("accessToken");
							const response = await fetch(`${window.BASE_URL}/api/announcements/${this.selectedAnnouncement.id}/messages/${msg.id}`, {
								method: "DELETE",
								headers: {
									Authorization: `Bearer ${token}`
								}
							});
							if (response.ok) {
								await this.loadChatMessages(this.selectedAnnouncement.id);
							} else {
								await showAlert("Failed to delete message", "Error", "error");
							}
						} catch (error) {
							console.error("Error deleting message:", error);
							await showAlert("Failed to delete message", "Error", "error");
						}
					}
				},
			};
		};
	</script>
	<div id="nav-placeholder"></div>
	<div x-data="approvalApp()" x-init="init()">
		<!-- Navigation -->

		<!-- Loading Overlay -->
		<div x-show="loading" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center">
			<div class="text-center">
				<i class="fas fa-spinner fa-spin text-4xl text-white"></i>
				<p class="text-white mt-4">Loading...</p>
			</div>
		</div>

		<!-- Toast Notification -->
		<div x-show="toast.show" x-transition :class="toast.type === 'success' ? 'bg-green-500' : 'bg-red-500'"
			class="fixed top-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg z-50">
			<span x-text="toast.message"></span>
		</div>

		<!-- Main Content -->
		<div class=" mx-auto px-4 py-8">

			<!-- Role-based tabs -->
			<div class="mb-6 mt-12 pt-3">
				<ul class="flex flex-wrap justify-between max-w-5xl mt-6 mx-auto" role="tablist">
					<li x-show="userRole === 'SUPER_ADMIN_REVIEWER' || userRole === 'SUPER_ADMIN'" class="mr-2">
						<button @click="activeTab = 'for-review'"
							:class="activeTab === 'for-review' ? 'border-b-2 border-primary text-white bg-primary shadow-md rounded-md' : 'text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-md'"
							class="px-4 py-2 font-medium transition duration-200 ease-in-out">
							Projects for Review
							<span class="ml-2 px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs"
								x-text="projectsForReview.length"></span>
						</button>
					</li>

					<li x-show="userRole === 'SUPER_ADMIN_APPROVER' || userRole === 'SUPER_ADMIN'" class="mr-2">
						<button @click="activeTab = 'all-pending'"
							:class="activeTab === 'all-pending' ? 'border-b-2 border-primary text-white bg-primary shadow-md rounded-md' : 'text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-md'"
							class="px-4 py-2 font-medium transition duration-200 ease-in-out">
							All Pending Approvals
							<span class="ml-2 px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs"
								x-text="allPendingProjects.length"></span>
						</button>
					</li>

					<li x-show="userRole === 'SUPER_ADMIN_APPROVER' || userRole === 'SUPER_ADMIN'" class="mr-2">
						<button @click="activeTab = 'for-approval'"
							:class="activeTab === 'for-approval' ? 'border-b-2 border-primary text-white bg-primary shadow-md rounded-md' : 'text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-md'"
							class="px-4 py-2 font-medium transition duration-200 ease-in-out">
							Awaiting Final Approval
							<span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs"
								x-text="projectsForApproval.length"></span>
						</button>
					</li>

					<li x-show="userRole === 'SUPER_ADMIN_APPROVER' || userRole === 'SUPER_ADMIN'" class="mr-2">
						<button @click="activeTab = 'reviewers'"
							:class="activeTab === 'reviewers' ? 'border-b-2 border-primary text-white bg-primary shadow-md rounded-md' : 'text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-md'"
							class="px-4 py-2 font-medium transition duration-200 ease-in-out">
							Manage Reviewers
						</button>
					</li>
				</ul>
			</div>

			<!-- Projects for Review (Reviewer View) -->
			<div x-show="activeTab === 'for-review'" class="space-y-4">
				<div class="bg-white rounded-lg shadow p-6">
					<h2 class="text-xl font-bold mb-4">
						Projects in Your Thematic Area
					</h2>
					<p class="text-sm text-gray-600 mb-4">
						<span x-show="userThematicAreas.length > 0">
							Your thematic areas:
							<span class="font-semibold" x-text="userThematicAreas.join(', ')"></span>
						</span>
						<span x-show="userThematicAreas.length === 0">
							Your thematic area:
							<span class="font-semibold" x-text="userThematicArea"></span>
						</span>
					</p>

					<template x-if="projectsForReview.length === 0">
						<div class="text-center py-8 text-gray-500">
							<i class="fas fa-inbox text-4xl mb-2"></i>
							<p>No projects awaiting review</p>
						</div>
					</template>

					<div id="project-dashboard">

						<div class="mb-4">
							<div class="relative w-full md:w-1/2 lg:w-1/3">
								<input type="text" id="search-input"
									placeholder="Search projects by title, partner, or status..."
									oninput="filterTable()"
									class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
								<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
									<i class="fas fa-search text-gray-400"></i>
								</div>
							</div>
						</div>

						<div class="overflow-x-auto shadow-lg rounded-lg">
							<table id="project-table" class="min-w-full divide-y divide-gray-200">
								<thead class="bg-gray-50">
									<tr>
										<th scope="col"
											class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
											Project Title
										</th>
										<th scope="col"
											class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
											Partner
										</th>
										<th scope="col"
											class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
											Themes
										</th>
										<th scope="col"
											class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
											Budget (KES)
										</th>
										<th scope="col"
											class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
											Locations
										</th>
										<th scope="col"
											class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
											Dates
										</th>
										<th scope="col"
											class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
											Status
										</th>
										<th scope="col" class="relative px-6 py-3">
											<span class="sr-only">Actions</span>
										</th>
									</tr>
								</thead>
								<tbody id="table-body" class="bg-white divide-y divide-gray-200">
									<template x-for="project in projectsForReview" :key="project.id">
										<tr class="hover:bg-gray-50 transition items-center duration-150 ease-in-out">
											<td class="px-6 py-4 gap-1 items-center text-sm text-gray-600">
												<span class="bg-yellow-100 text-black text-xs px-2 py-1 rounded-lg ">
													#<span class="whitespace-nowrap font-medium text-gray-900"
														x-text="project.id">
													</span>
												</span><br class="my-1">
												<span class="whitespace-nowrap text-sm font-medium text-gray-900"
													x-text="project.title">
												</span>
											</td>
											<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600"
												x-text="project.partner"></td>

											<td class="px-6 py-4 text-sm text-gray-600">
												<div class="flex flex-wrap gap-1">
													<template x-for="theme in project.themes" :key="theme.code">
														<span
															class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs whitespace-nowrap"
															x-text="theme.name || theme.displayName"></span>
													</template>
												</div>
											</td>

											<td
												class="px-6 py-4 whitespace-nowrap text-sm text-green-700 font-semibold">
												KES <span x-text="(project.budget || 0).toLocaleString()"></span>
											</td>

											<td class="px-6 py-4 text-sm text-gray-600">
												<div class="flex flex-wrap gap-1"
													x-show="project.locations && project.locations.length > 0">
													<template x-for="location in project.locations" :key="location.id">
														<span
															class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs whitespace-nowrap">
															<i class="fas fa-map-marker-alt text-red-500 mr-1"></i>
															<span
																x-text="location.county || location.mapsAddress || 'Unknown'"></span>
														</span>
													</template>
												</div>
											</td>

											<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
												<div class="flex flex-col gap-1">
													<span x-show="project.startDate">
														Start: <span x-text="project.startDate"></span>
													</span>
													<span x-show="project.endDate">
														End: <span x-text="project.endDate"></span>
													</span>
												</div>
											</td>

											<td class="px-6 py-4 whitespace-nowrap text-sm">
												<span
													class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium"
													x-text="project.approvalWorkflowStatus || project.approvalStatus || 'PENDING_REVIEW'"></span>
											</td>

											<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
												<div class="flex gap-2 justify-end">
													<button @click="viewProjectDetails(project.id)"
														class="text-gray-600 hover:text-gray-900 px-2 py-1 rounded border border-gray-300 hover:bg-gray-100 transition"
														title="View Details">
														<i class="fas fa-eye"></i>
													</button>
													<button @click="openReviewModal(project)"
														class="text-white bg-blue-600 hover:bg-green-600 px-2 py-1 rounded transition"
														title="Review Project">
														<i class="fas fa-check-circle"></i>
													</button>
												</div>
											</td>
										</tr>
									</template>
								</tbody>
							</table>
							<div id="no-results" class="px-6 py-8 text-center text-gray-500 italic hidden">
								No projects found matching your search term.
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- All Pending Approvals (Overview for Approvers) -->
			<div x-show="activeTab === 'all-pending'" class="space-y-4">
				<div class="bg-white rounded-lg shadow p-6">
					<h2 class="text-xl font-bold mb-4">
						All Projects in Approval Pipeline
					</h2>
					<p class="text-sm text-gray-600 mb-4">
						Overview of all projects at different stages of the two-tier
						approval process
					</p>

					<template x-if="allPendingProjects.length === 0">
						<div class="text-center py-8 text-gray-500">
							<i class="fas fa-inbox text-4xl mb-2"></i>
							<p>No projects in approval pipeline</p>
						</div>
					</template>

					<div id="projects-dashboards">
						<div class="mb-4">
							<div class="relative w-full md:w-1/2 lg:w-1/3">
								<input type="text" id="search-input-pending"
									placeholder="Search all pending projects..."
									oninput="filterTabled('search-input-pending', 'table-body-pending', 'no-results-pending')"
									class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
								<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
									<i class="fas fa-search text-gray-400"></i>
								</div>
							</div>
						</div>

						<div class="overflow-x-auto shadow-lg rounded-lg">
							<table id="project-table-pending" class="min-w-full divide-y divide-gray-200">
								<thead class="bg-gray-50">
									<tr>
										<th scope="col"
											class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
											Project Title</th>
										<th scope="col"
											class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
											Partner</th>
										<th scope="col"
											class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
											Themes</th>
										<th scope="col"
											class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
											Budget (KES)</th>
										<th scope="col"
											class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
											Locations</th>
										<th scope="col"
											class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
											Dates</th>
										<th scope="col"
											class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
											Status</th>
										<th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span>
										</th>
									</tr>
								</thead>
								<tbody id="table-body-pending" class="bg-white divide-y divide-gray-200">
									<template x-for="project in allPendingProjects" :key="project.id">
										<tr class="hover:bg-gray-50 transition items-center duration-150 ease-in-out">
											<td class="px-6 py-4 gap-1 items-center text-sm text-gray-600">
												<span class="bg-purple-100 text-black text-xs px-2 py-1 rounded-lg">
													#<span class="whitespace-nowrap font-medium text-gray-900"
														x-text="project.id"></span>
												</span><br class="my-1">
												<span class="whitespace-nowrap text-sm font-medium text-gray-900"
													x-text="project.title"></span>
											</td>

											<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600"
												x-text="project.partner"></td>

											<td class="px-6 py-4 text-sm text-gray-600">
												<div class="flex flex-wrap gap-1">
													<template x-for="theme in project.themes" :key="theme.code">
														<span
															class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs whitespace-nowrap"
															x-text="theme.name || theme.displayName"></span>
													</template>
												</div>
											</td>

											<td
												class="px-6 py-4 whitespace-nowrap text-sm text-green-700 font-semibold">
												KES <span x-text="(project.budget || 0).toLocaleString()"></span>
											</td>

											<td class="px-6 py-4 text-sm text-gray-600">
												<div class="flex flex-wrap gap-1"
													x-show="project.locations && project.locations.length > 0">
													<template x-for="location in project.locations" :key="location.id">
														<span
															class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs whitespace-nowrap">
															<i class="fas fa-map-marker-alt text-red-500 mr-1"></i>
															<span
																x-text="location.county || location.mapsAddress || 'Unknown'"></span>
														</span>
													</template>
												</div>
											</td>

											<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
												<div class="flex flex-col gap-1">
													<span x-show="project.startDate">Start: <span
															x-text="project.startDate"></span></span>
													<span x-show="project.endDate">End: <span
															x-text="project.endDate"></span></span>
												</div>
											</td>

											<td class="px-6 py-4 whitespace-nowrap text-sm">
												<span :class="{
                                'bg-yellow-100 text-yellow-800': project.approvalWorkflowStatus?.includes('PENDING_REVIEW') || project.approvalStatus === 'PENDING',
                                'bg-blue-100 text-blue-800': project.approvalWorkflowStatus?.includes('PENDING_FINAL') || project.approvalStatus === 'SUBMITTED',
                                'bg-purple-100 text-purple-800': project.approvalWorkflowStatus && !project.approvalWorkflowStatus.includes('PENDING')
                            }" class="px-3 py-1 rounded-full text-xs font-medium"
													x-text="project.approvalWorkflowStatus || project.approvalStatus || 'PENDING'"></span>
											</td>

											<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
												<div class="flex gap-2 justify-end">
													<button @click="viewProjectDetails(project.id)"
														class="text-gray-600 hover:text-gray-900 px-2 py-1 rounded border border-gray-300 hover:bg-gray-100 transition"
														title="View Details">
														<i class="fas fa-eye"></i>
													</button>
													<button
														x-show="project.approvalWorkflowStatus?.includes('PENDING_FINAL')"
														@click="openUnifiedApprovalModal(project)"
														class="text-white bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded transition"
														title="Review & Take Action">
														<i class="fas fa-tasks mr-1"></i>
														Take Action
													</button>
												</div>
											</td>
										</tr>
									</template>
								</tbody>
							</table>
							<div id="no-results-pending" class="px-6 py-8 text-center text-gray-500 italic hidden">
								No pending projects found matching your search term.
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Projects Awaiting Final Approval (Approver View) -->
			<div x-show="activeTab === 'for-approval'" class="space-y-4">
				<div class="bg-white rounded-lg shadow p-6">
					<h2 class="text-xl font-bold mb-4">
						Projects Awaiting Final Approval
					</h2>

					<template x-if="projectsForApproval.length === 0">
						<div class="text-center py-8 text-gray-500">
							<i class="fas fa-inbox text-4xl mb-2"></i>
							<p>No projects awaiting final approval</p>
						</div>
					</template>

					<div class="space-y-4">
						<div id="project-approval-dashboard">

							<div class="mb-4">
								<div class="relative w-full md:w-1/2 lg:w-1/3">
									<input type="text" id="search-input-approval"
										placeholder="Search projects for final approval..."
										oninput="filterTable('search-input-approval', 'table-body-approval', 'no-results-approval')"
										class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm transition">
									<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
										<i class="fas fa-search text-gray-400"></i>
									</div>
								</div>
							</div>

							<div class="overflow-x-auto shadow-lg rounded-lg">
								<table id="project-table-approval" class="min-w-full divide-y divide-gray-200">
									<thead class="bg-gray-50">
										<tr>
											<th scope="col"
												class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
												Project & Partner
											</th>
											<th scope="col"
												class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
												Themes
											</th>
											<th scope="col"
												class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
												Review Status
											</th>
											<th scope="col"
												class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
												Workflow Status
											</th>
											<th scope="col" class="relative px-6 py-3">
												<span class="sr-only">Actions</span>
											</th>
										</tr>
									</thead>
									<tbody id="table-body-approval" class="bg-white divide-y divide-gray-200">
										<template x-for="project in projectsForApproval" :key="project.id">
											<tr
												class="hover:bg-gray-50 transition items-center duration-150 ease-in-out">
												<td class="px-6 py-4 text-sm text-gray-600">
													<span class="whitespace-nowrap font-semibold text-gray-900"
														x-text="project.title"></span>
													<p class="text-xs text-gray-500 mt-1">
														Partner: <span class="whitespace-nowrap"
															x-text="project.partner"></span>
													</p>
												</td>

											<td class="px-6 py-4 text-sm text-gray-600">
												<div class="flex flex-wrap gap-1">
													<template x-if="project.themes && project.themes.length > 0">
														<template x-for="theme in project.themes" :key="theme.code">
															<span
																class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs whitespace-nowrap"
																x-text="theme.displayName || theme.name || theme"></span>
														</template>
													</template>
													<template x-if="!project.themes || project.themes.length === 0">
														<span class="text-xs text-gray-400 italic">No themes</span>
													</template>
												</div>
											</td>

											<td class="px-6 py-4 whitespace-nowrap text-sm">
												<!-- Review Status Badge -->
												<div class="flex items-center gap-2">
													<!-- Rejected by Reviewer -->
													<span x-show="project.approvalWorkflowStatus === 'REJECTED_BY_REVIEWER' || project.approvalStatus === 'REJECTED' || project.status === 'rejected'"
														class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium flex items-center gap-1">
														<i class="fas fa-times-circle"></i>
														Rejected
													</span>
													<!-- Approved by Reviewer -->
													<span x-show="project.approvalWorkflowStatus === 'PENDING_FINAL_APPROVAL' || (project.approvalWorkflowStatus?.includes('PENDING_FINAL') && project.reviewedBy) || project.approvalStatus === 'APPROVED'"
														class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium flex items-center gap-1">
														<i class="fas fa-check-circle"></i>
														Approved
													</span>
													<!-- Not Yet Reviewed -->
													<span x-show="project.approvalWorkflowStatus !== 'REJECTED_BY_REVIEWER' && project.approvalWorkflowStatus !== 'PENDING_FINAL_APPROVAL' && !project.approvalWorkflowStatus?.includes('PENDING_FINAL') && project.approvalStatus !== 'REJECTED' && project.approvalStatus !== 'APPROVED' && project.status !== 'rejected' && !project.reviewedBy"
														class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium flex items-center gap-1">
														<i class="fas fa-clock"></i>
														Not Reviewed
													</span>
												</div>
											</td>											<td class="px-6 py-4 whitespace-nowrap text-sm">
												<span
													class="px-3 py-1 rounded-full text-xs font-medium"
													:class="{
														'bg-blue-100 text-blue-800': project.approvalWorkflowStatus?.includes('PENDING_FINAL'),
														'bg-green-100 text-green-800': project.approvalWorkflowStatus === 'REVIEWED',
														'bg-red-100 text-red-800': project.approvalWorkflowStatus === 'REJECTED_BY_REVIEWER',
														'bg-gray-100 text-gray-600': !project.approvalWorkflowStatus
													}"
													x-text="project.approvalWorkflowStatus || 'PENDING'"></span>
											</td>												<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
													<div class="flex gap-2 justify-end">
														<button @click="viewProjectDetails(project.id)"
															class="text-gray-600 hover:text-gray-900 px-2 py-1 rounded border border-gray-300 hover:bg-gray-100 transition"
															title="View Full Details">
															<i class="fas fa-eye"></i>
														</button>
														<button @click="openUnifiedApprovalModal(project)"
															class="text-white bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded transition"
															title="Review & Take Action">
															<i class="fas fa-tasks mr-1"></i>
															Take Action
														</button>
													</div>
												</td>
											</tr>
										</template>
									</tbody>
								</table>
								<div id="no-results-approval" class="px-6 py-8 text-center text-gray-500 italic hidden">
									No projects for final approval found matching your search term.
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- Reviewer Management (Approver/SUPER_ADMIN Only) -->
			<div x-show="activeTab === 'reviewers'" class="space-y-4">
				<div class="bg-white rounded-lg shadow p-6">
					<div class="flex justify-between items-center mb-4">
						<h2 class="text-xl font-bold">Manage Reviewers</h2>
						<button
							@click="openAddReviewerModal()"
							class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2 shadow-md"
						>
							<i class="fas fa-user-plus"></i> Add New Reviewer
						</button>
					</div>

					<!-- Thematic Area Filter -->
					<div class="mb-4">
						<label class="block text-sm font-medium mb-2">Filter by Thematic Area:</label>
						<select x-model="selectedThemeFilter" @change="filterReviewers()"
							class="px-4 py-2 border rounded">
							<option value="">All Reviewers</option>
							<option value="GBV">GBV - Gender-Based Violence</option>
							<option value="AYPSRH">
								AYPSRH - Adolescent and Young People SRH
							</option>
							<option value="MNH">MNH - Maternal and Newborn Health</option>
							<option value="FP">FP - Family Planning</option>
							<option value="CH">CH - Child Health</option>
							<option value="AH">AH - Adolescent Health</option>
							<option value="ADV_SBC">ADV_SBC - Advocacy and SBC</option>
							<option value="MONITORING_EVALUATION">MONITORING_EVALUATION - Monitoring and Evaluation
							</option>
							<option value="RESEARCH_LEARNING">RESEARCH_LEARNING - Research and Learning</option>
						</select>
					</div>

					<div class="overflow-x-auto">
						<table class="min-w-full divide-y divide-gray-200">
							<thead class="bg-gray-50">
								<tr>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
										Name
									</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
										Email
									</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
										Thematic Area
									</th>
									<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
										Actions
									</th>
								</tr>
							</thead>
							<tbody class="bg-white divide-y divide-gray-200">
								<template x-for="reviewer in filteredReviewers" :key="reviewer.id">
									<tr>
										<td class="px-6 py-4 whitespace-nowrap" x-text="reviewer.name"></td>
										<td class="px-6 py-4 whitespace-nowrap" x-text="reviewer.email"></td>
										<td class="px-6 py-4">
											<!-- Display multiple thematic areas -->
											<div class="flex flex-wrap gap-1">
												<template x-if="reviewer.thematicAreas && reviewer.thematicAreas.length > 0">
													<template x-for="area in reviewer.thematicAreas" :key="area">
														<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs" x-text="area"></span>
													</template>
												</template>
												<template x-if="!reviewer.thematicAreas || reviewer.thematicAreas.length === 0">
													<span class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs">
														<span x-text="reviewer.thematicArea || 'Not Assigned'"></span>
													</span>
												</template>
											</div>
										</td>
										<td class="px-6 py-4 whitespace-nowrap">
											<button @click="openAssignThemeModal(reviewer)"
												class="text-blue-600 hover:text-green-700">
												<i class="fas fa-edit mr-1"></i> Manage Areas
											</button>
										</td>
									</tr>
								</template>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

		<!-- Review Modal -->
		<div x-show="showReviewModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
			<div class="flex items-center justify-center min-h-screen px-4">
				<div class="fixed inset-0 bg-black opacity-50" @click="showReviewModal = false"></div>
				<div class="relative bg-white rounded-lg p-8 max-w-2xl w-full">
					<h3 class="text-2xl font-bold mb-4">Review Project</h3>
					<p class="mb-4">
						<strong>Project:</strong>
						<span x-text="selectedProject?.title"></span>
					</p>

					<div class="mb-6">
						<label class="block text-sm font-medium mb-3">Your Decision:</label>
						<div class="space-y-3">
							<label class="flex items-start p-4 bg-white border-2 rounded-lg cursor-pointer transition-all duration-200 hover:shadow-md"
								:class="{
									'border-green-500 bg-green-50': reviewDecision === 'approve',
									'border-gray-300': reviewDecision !== 'approve'
								}">
								<input type="radio" x-model="reviewDecision" value="approve" 
									class="mt-1 h-5 w-5 text-green-600 border-gray-300 focus:ring-green-500" />
								<div class="ml-3 flex-1">
									<span class="text-base font-semibold text-gray-900 flex items-center">
										<i class="fas fa-check-circle text-green-600 mr-2"></i>
										Approve for Final Review
									</span>
									<p class="text-sm text-gray-600 mt-1">Send to approver for final decision</p>
								</div>
							</label>
							<label class="flex items-start p-4 bg-white border-2 rounded-lg cursor-pointer transition-all duration-200 hover:shadow-md"
								:class="{
									'border-red-500 bg-red-50': reviewDecision === 'reject',
									'border-gray-300': reviewDecision !== 'reject'
								}">
								<input type="radio" x-model="reviewDecision" value="reject" 
									class="mt-1 h-5 w-5 text-red-600 border-gray-300 focus:ring-red-500" />
								<div class="ml-3 flex-1">
									<span class="text-base font-semibold text-gray-900 flex items-center">
										<i class="fas fa-times-circle text-red-600 mr-2"></i>
										Reject (Needs Revision)
									</span>
									<p class="text-sm text-gray-600 mt-1">Request changes from submitter</p>
								</div>
							</label>
						</div>
					</div>

					<div class="mb-6">
						<label class="block text-sm font-medium mb-2">Comments:</label>
						<select x-model="reviewComments" 
							class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition">
							<option value="">Select a comment...</option>
							<option value="Project meets all requirements and is ready for final approval.">Project meets all requirements</option>
							<option value="Excellent project design and implementation plan.">Excellent project design</option>
							<option value="Good alignment with thematic priorities.">Good thematic alignment</option>
							<option value="Budget needs clarification and more detail.">Budget needs clarification</option>
							<option value="Project scope needs to be more specific.">Project scope needs refinement</option>
							<option value="Missing key project documentation.">Missing documentation</option>
							<option value="Project timeline is unrealistic.">Timeline unrealistic</option>
							<option value="Thematic alignment needs improvement.">Thematic alignment issues</option>
							<option value="Please provide more detailed implementation plan.">Need detailed implementation plan</option>
							<option value="Custom">Custom comment...</option>
						</select>
						
						<!-- Custom comment textarea (shown when "Custom" is selected) -->
						<textarea x-show="reviewComments === 'Custom'" x-model="customReviewComment" rows="4" 
							class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition mt-3"
							placeholder="Enter your custom comment..."></textarea>
					</div>

					<div class="flex gap-2 justify-end">
						<button @click="showReviewModal = false"
							class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
							Cancel
						</button>
						<button @click="submitReview()"
							class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
							<i class="fas fa-paper-plane mr-2"></i>
							Submit Review
						</button>
					</div>
				</div>
			</div>
		</div>

		<div x-show="showFinalApprovalModal"
			class="fixed backdrop-blur-md inset-0 z-50 overflow-y-auto transition-opacity duration-300 ease-out" x-cloak
			x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0"
			x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200"
			x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">

			<div class="flex items-center justify-center min-h-screen p-4">

				<div class="fixed inset-0 bg-gray-900 bg-opacity-70" @click="showFinalApprovalModal = false"></div>

				<div class="relative bg-white rounded-xl shadow-2xl transform transition-all sm:my-8 max-w-3xl w-full"
					x-transition:enter="ease-out duration-300"
					x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
					x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
					x-transition:leave="ease-in duration-200"
					x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
					x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">

					<div class="px-6 py-4 border-b border-gray-100 bg-green-50 rounded-t-xl">
						<h3 class="text-xl font-extrabold text-green-800 flex items-center">
							<i class="fas fa-certificate mr-3 text-green-600"></i>
							Grant Final Approval
						</h3>
					</div>

					<div class="p-6">
						<div class="mb-5 p-3 bg-gray-50 rounded-lg border border-gray-200">
							<p class="text-sm font-semibold text-gray-700 mb-1">Project Title:</p>
							<p class="text-lg font-bold text-gray-900" x-text="selectedProject?.title"></p>
						</div>

						<div class="mb-6">
							<label for="final-comments" class="block text-sm font-bold text-gray-700 mb-2">
								<i class="fas fa-comment-alt mr-1 text-gray-500"></i>
								Final Comments (Optional):
							</label>
							<textarea id="final-comments" x-model="finalComments" rows="3"
								class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-green-500 focus:border-green-500 transition"
								placeholder="Add any final comments for the records..."></textarea>
						</div>
					</div>

					<div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end gap-3 border-t border-gray-100">
						<button @click="showFinalApprovalModal = false"
							class="flex items-center px-5 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-100 transition duration-150">
							<i class="fas fa-times mr-2"></i>
							Cancel
						</button>
						<button @click="submitFinalApproval()"
							class="flex items-center px-5 py-2 text-sm font-medium text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700 transition duration-150">
							<i class="fas fa-check-double mr-2"></i>
							Grant Final Approval
						</button>
					</div>
				</div>
			</div>
		</div>

		<div x-show="showFinalRejectModal"
			class="fixed backdrop-blur-md inset-0 z-50 overflow-y-auto transition-opacity duration-300 ease-out" x-cloak
			x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0"
			x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200"
			x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">

			<div class="flex items-center justify-center min-h-screen p-4">

				<div class="fixed inset-0 bg-gray-900 bg-opacity-70" @click="showFinalRejectModal = false"></div>

				<div class="relative bg-white rounded-xl shadow-2xl transform transition-all sm:my-8 max-w-3xl w-full"
					x-transition:enter="ease-out duration-300"
					x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
					x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
					x-transition:leave="ease-in duration-200"
					x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
					x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">

					<div class="px-6 py-4 border-b border-gray-100 bg-red-50 rounded-t-xl">
						<h3 class="text-xl font-extrabold text-red-800 flex items-center">
							<i class="fas fa-exclamation-triangle mr-3 text-red-600"></i>
							Reject Project
						</h3>
					</div>

					<div class="p-6">
						<div class="mb-5 p-3 bg-red-50 rounded-lg border border-red-200">
							<p class="text-sm font-semibold text-red-700 mb-1">Project Title:</p>
							<p class="text-lg font-bold text-red-900" x-text="selectedProject?.title"></p>
						</div>

						<div class="mb-6">
							<label for="rejection-reason" class="block text-sm font-bold text-gray-700 mb-2">
								<i class="fas fa-exclamation-circle mr-1 text-red-500"></i>
								Rejection Reason (Required):
							</label>
							<textarea id="rejection-reason" x-model="rejectionReason" rows="4"
								class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500 transition"
								placeholder="Provide detailed, constructive reason for rejection..."
								required></textarea>
						</div>
					</div>

					<div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end gap-3 border-t border-gray-100">
						<button @click="showFinalRejectModal = false"
							class="flex items-center px-5 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-100 transition duration-150">
							<i class="fas fa-undo mr-2"></i>
							Cancel
						</button>
						<button @click="submitFinalRejection()" :disabled="!rejectionReason"
							class="flex items-center px-5 py-2 text-sm font-medium text-white bg-red-600 rounded-lg shadow-md hover:bg-red-700 disabled:opacity-50 transition duration-150">
							<i class="fas fa-times-circle mr-2"></i>
							Reject Project
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Final Reject Modal -->
		<div x-show="showFinalRejectModal" class="fixed inset-0 z-50 overflow-y-auto" x-cloak>
			<div class="flex items-center justify-center min-h-screen px-4">
				<div class="fixed inset-0 bg-black opacity-50" @click="showFinalRejectModal = false"></div>
				<div class="relative bg-white rounded-lg p-8 max-w-2xl w-full">
					<h3 class="text-2xl font-bold mb-4 text-red-600">Reject Project</h3>
					<p class="mb-4">
						<strong>Project:</strong>
						<span x-text="selectedProject?.title"></span>
					</p>

					<div class="mb-4">
						<label class="block text-sm font-medium mb-2">Rejection Reason (Required):</label>
						<textarea x-model="rejectionReason" rows="4" class="w-full px-3 py-2 border rounded"
							placeholder="Provide detailed reason for rejection..." required></textarea>
					</div>

					<div class="flex gap-2 justify-end">
						<button @click="showFinalRejectModal = false"
							class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
							Cancel
						</button>
						<button @click="submitFinalRejection()"
							class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
							<i class="fas fa-times-circle mr-2"></i> Reject Project
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Unified Approval Action Modal with Radio Buttons -->
		<div x-show="showUnifiedApprovalModal"
			class="fixed backdrop-blur-md inset-0 z-50 overflow-y-auto transition-opacity duration-300 ease-out" x-cloak
			x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0"
			x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200"
			x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">

			<div class="flex items-center justify-center min-h-screen p-4">

				<div class="fixed inset-0 bg-gray-900 bg-opacity-70" @click="showUnifiedApprovalModal = false"></div>

				<div class="relative bg-white rounded-xl shadow-2xl transform transition-all sm:my-8 max-w-3xl w-full"
					x-transition:enter="ease-out duration-300"
					x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
					x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
					x-transition:leave="ease-in duration-200"
					x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
					x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">

					<div class="px-6 py-4 border-b border-gray-100 bg-blue-50 rounded-t-xl">
						<h3 class="text-xl font-extrabold text-blue-800 flex items-center">
							<i class="fas fa-clipboard-check mr-3 text-blue-600"></i>
							Review & Take Action
						</h3>
					</div>

					<div class="p-6">
						<!-- Project Info -->
						<div class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
							<p class="text-sm font-semibold text-gray-700 mb-1">Project Title:</p>
							<p class="text-lg font-bold text-gray-900" x-text="selectedProject?.title"></p>
							<p class="text-xs text-gray-500 mt-2">
								Partner: <span class="font-medium" x-text="selectedProject?.partner"></span>
							</p>
						</div>

						<!-- Warning for Rejected Projects -->
						<div x-show="selectedProject?.approvalWorkflowStatus === 'REJECTED_BY_REVIEWER'" 
							class="mb-6 p-4 bg-red-50 rounded-lg border-l-4 border-red-500">
							<p class="text-sm font-bold text-red-800 mb-2">
								<i class="fas fa-exclamation-triangle mr-2"></i>
								This project was rejected by the reviewer
							</p>
							<p class="text-xs text-red-700">
								As the approver, you can override the reviewer's decision if you believe the project has merit, or you can confirm the rejection.
							</p>
						</div>

						<!-- Reviewer Details (if available) -->
						<div x-show="selectedProject?.reviewedBy" class="mb-6 p-3 rounded-lg border"
							:class="{
								'bg-green-50 border-green-200': selectedProject?.approvalWorkflowStatus !== 'REJECTED_BY_REVIEWER',
								'bg-red-50 border-red-200': selectedProject?.approvalWorkflowStatus === 'REJECTED_BY_REVIEWER'
							}">
							<p class="text-sm font-semibold mb-2"
								:class="{
									'text-green-800': selectedProject?.approvalWorkflowStatus !== 'REJECTED_BY_REVIEWER',
									'text-red-800': selectedProject?.approvalWorkflowStatus === 'REJECTED_BY_REVIEWER'
								}">
								<i class="fas mr-1"
									:class="{
										'fa-user-check': selectedProject?.approvalWorkflowStatus !== 'REJECTED_BY_REVIEWER',
										'fa-user-times': selectedProject?.approvalWorkflowStatus === 'REJECTED_BY_REVIEWER'
									}"></i>
								<span x-show="selectedProject?.approvalWorkflowStatus !== 'REJECTED_BY_REVIEWER'">Reviewer Feedback:</span>
								<span x-show="selectedProject?.approvalWorkflowStatus === 'REJECTED_BY_REVIEWER'">Reviewer Rejection Reason:</span>
							</p>
							<p class="text-xs text-gray-700">
								<span class="font-medium" x-text="getReviewerName(selectedProject?.reviewedBy) || `User #${selectedProject?.reviewedBy}`"></span>
								<span x-show="selectedProject?.reviewedAt"> - <span x-text="formatDate(selectedProject?.reviewedAt)"></span></span>
							</p>
							<p class="text-sm text-gray-600 mt-2 italic" x-show="selectedProject?.reviewerComments"
								x-text="selectedProject?.reviewerComments">
							</p>
							<p class="text-sm text-gray-400 mt-2 italic" x-show="!selectedProject?.reviewerComments">
								No comments provided.
							</p>
						</div>						<!-- Action Selection - Radio Buttons -->
						<div class="mb-6">
							<label class="block text-sm font-bold text-gray-700 mb-3">
								<i class="fas fa-hand-pointer mr-1"></i>
								Select Action: <span class="text-red-500">*</span>
							</label>
							<div class="space-y-3">
								<!-- Approve Option -->
								<label class="flex items-start p-4 bg-white border-2 rounded-lg cursor-pointer transition-all duration-200 hover:shadow-md"
									:class="{
										'border-green-500 bg-green-50': approvalAction === 'approve',
										'border-gray-300': approvalAction !== 'approve'
									}">
									<input type="radio" name="approval-action" value="approve" x-model="approvalAction"
										class="mt-1 h-5 w-5 text-green-600 border-gray-300 focus:ring-green-500">
									<div class="ml-3 flex-1">
										<span class="text-base font-semibold text-gray-900 flex items-center">
											<i class="fas fa-check-circle text-green-600 mr-2"></i>
											Approve
										</span>
										<p class="text-sm text-gray-600 mt-1">Grant final approval for this project</p>
									</div>
								</label>

								<!-- Reject Option -->
								<label class="flex items-start p-4 bg-white border-2 rounded-lg cursor-pointer transition-all duration-200 hover:shadow-md"
									:class="{
										'border-red-500 bg-red-50': approvalAction === 'reject',
										'border-gray-300': approvalAction !== 'reject'
									}">
									<input type="radio" name="approval-action" value="reject" x-model="approvalAction"
										class="mt-1 h-5 w-5 text-red-600 border-gray-300 focus:ring-red-500">
									<div class="ml-3 flex-1">
										<span class="text-base font-semibold text-gray-900 flex items-center">
											<i class="fas fa-times-circle text-red-600 mr-2"></i>
											Reject
										</span>
										<p class="text-sm text-gray-600 mt-1">Reject this project with a reason</p>
									</div>
								</label>

								<!-- Request Changes Option -->
								<label class="flex items-start p-4 bg-white border-2 rounded-lg cursor-pointer transition-all duration-200 hover:shadow-md"
									:class="{
										'border-yellow-500 bg-yellow-50': approvalAction === 'request_changes',
										'border-gray-300': approvalAction !== 'request_changes'
									}">
									<input type="radio" name="approval-action" value="request_changes" x-model="approvalAction"
										class="mt-1 h-5 w-5 text-yellow-600 border-gray-300 focus:ring-yellow-500">
									<div class="ml-3 flex-1">
										<span class="text-base font-semibold text-gray-900 flex items-center">
											<i class="fas fa-edit text-yellow-600 mr-2"></i>
											Request Changes
										</span>
										<p class="text-sm text-gray-600 mt-1">Ask for revisions before final decision</p>
									</div>
								</label>
							</div>
						</div>

						<!-- Comments/Reason Dropdown & Textarea -->
						<div class="mb-6">
						<label for="approval-comments-dropdown" class="block text-sm font-bold text-gray-700 mb-2">
						<i class="fas fa-comment-alt mr-1 text-gray-500"></i>
						<span x-show="approvalAction === 'approve'">Comments (Optional):</span>
						<span x-show="approvalAction === 'reject'">Rejection Reason (Required): <span class="text-red-500">*</span></span>
						<span x-show="approvalAction === 'request_changes'">Changes Requested (Required): <span class="text-red-500">*</span></span>
						</label>
						
						<!-- Dropdown with preset options -->
						<select id="approval-comments-dropdown" x-model="selectedCommentOption" 
						@change="if (selectedCommentOption !== 'custom') { approvalComments = selectedCommentOption; }"
						class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition mb-3"
						:class="{
						'border-red-300 focus:border-red-500 focus:ring-red-500': approvalAction === 'reject' && !approvalComments.trim(),
						'border-yellow-300 focus:border-yellow-500 focus:ring-yellow-500': approvalAction === 'request_changes' && !approvalComments.trim()
						}">
						<option value="">-- Select an option --</option>
						
						<!-- Approval Comments -->
						<template x-if="approvalAction === 'approve'">
						<optgroup label="Approval Comments">
						<option value="Project meets all requirements and is approved for implementation">Project meets all requirements and is approved for implementation</option>
						<option value="Well-structured project with clear objectives and outcomes">Well-structured project with clear objectives and outcomes</option>
						<option value="Budget and timeline are reasonable and well-justified">Budget and timeline are reasonable and well-justified</option>
						<option value="Strong community impact potential">Strong community impact potential</option>
						<option value="Approved with minor recommendations for implementation phase">Approved with minor recommendations for implementation phase</option>
						<option value="custom">Custom comment...</option>
						</optgroup>
						</template>
						
						<!-- Rejection Reasons -->
						<template x-if="approvalAction === 'reject'">
						<optgroup label="Rejection Reasons">
						<option value="Insufficient budget justification or unrealistic cost estimates">Insufficient budget justification or unrealistic cost estimates</option>
						<option value="Project objectives not clearly defined or measurable">Project objectives not clearly defined or measurable</option>
						<option value="Inadequate risk assessment or mitigation strategies">Inadequate risk assessment or mitigation strategies</option>
						<option value="Timeline is not realistic for proposed activities">Timeline is not realistic for proposed activities</option>
						<option value="Does not align with current organizational priorities">Does not align with current organizational priorities</option>
						<option value="Insufficient stakeholder engagement or community buy-in">Insufficient stakeholder engagement or community buy-in</option>
						<option value="Missing critical supporting documentation">Missing critical supporting documentation</option>
						<option value="Sustainability plan is inadequate or unclear">Sustainability plan is inadequate or unclear</option>
						<option value="custom">Custom reason...</option>
						</optgroup>
						</template>
						
						<!-- Change Requests -->
						<template x-if="approvalAction === 'request_changes'">
						<optgroup label="Changes Requested">
						<option value="Please provide more detailed budget breakdown and justification">Please provide more detailed budget breakdown and justification</option>
						<option value="Clarify project objectives and expected outcomes with specific metrics">Clarify project objectives and expected outcomes with specific metrics</option>
						<option value="Revise timeline to be more realistic for proposed activities">Revise timeline to be more realistic for proposed activities</option>
						<option value="Add or update risk assessment and mitigation strategies">Add or update risk assessment and mitigation strategies</option>
						<option value="Provide missing supporting documentation">Provide missing supporting documentation</option>
						<option value="Enhance sustainability plan with more concrete strategies">Enhance sustainability plan with more concrete strategies</option>
						<option value="Improve stakeholder engagement and community involvement plan">Improve stakeholder engagement and community involvement plan</option>
						<option value="Align project activities more closely with organizational priorities">Align project activities more closely with organizational priorities</option>
						<option value="custom">Custom changes...</option>
						</optgroup>
						</template>
						</select>
						
						<!-- Custom comment textarea (shown when "custom" is selected) -->
						<div x-show="selectedCommentOption === 'custom'">
						<textarea id="approval-comments-custom" x-model="approvalComments" rows="4"
						class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition"
						:class="{
						'border-red-300 focus:border-red-500 focus:ring-red-500': approvalAction === 'reject' && !approvalComments.trim(),
						'border-yellow-300 focus:border-yellow-500 focus:ring-yellow-500': approvalAction === 'request_changes' && !approvalComments.trim()
						}"
						:placeholder="approvalAction === 'approve' ? 'Add any final comments for the records...' : 
						 approvalAction === 'reject' ? 'Provide detailed, constructive reason for rejection...' : 
						 'Specify what changes are needed...'"
						:required="approvalAction !== 'approve'"></textarea>
						</div>
						
						<p x-show="approvalAction === 'reject' && !approvalComments.trim()" class="text-xs text-red-600 mt-1">
						<i class="fas fa-exclamation-circle mr-1"></i>
						Rejection reason is required
						</p>
						<p x-show="approvalAction === 'request_changes' && !approvalComments.trim()" class="text-xs text-yellow-600 mt-1">
						<i class="fas fa-exclamation-circle mr-1"></i>
						Please specify what changes are needed
						</p>
						</div>
					</div>

					<!-- Footer Actions -->
					<div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end gap-3 border-t border-gray-100">
						<button @click="showUnifiedApprovalModal = false"
							class="flex items-center px-5 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-100 transition duration-150">
							<i class="fas fa-times mr-2"></i>
							Cancel
						</button>
						<button @click="submitUnifiedApprovalAction()"
							:disabled="(approvalAction === 'reject' || approvalAction === 'request_changes') && !approvalComments.trim()"
							class="flex items-center px-5 py-2 text-sm font-medium text-white rounded-lg shadow-md transition duration-150"
							:class="{
								'bg-green-600 hover:bg-green-700': approvalAction === 'approve',
								'bg-red-600 hover:bg-red-700': approvalAction === 'reject',
								'bg-yellow-600 hover:bg-yellow-700': approvalAction === 'request_changes',
								'opacity-50 cursor-not-allowed': (approvalAction === 'reject' || approvalAction === 'request_changes') && !approvalComments.trim()
							}">
							<i class="mr-2" :class="{
								'fas fa-check-double': approvalAction === 'approve',
								'fas fa-times-circle': approvalAction === 'reject',
								'fas fa-edit': approvalAction === 'request_changes'
							}"></i>
							<span x-show="approvalAction === 'approve'">Grant Approval</span>
							<span x-show="approvalAction === 'reject'">Reject Project</span>
							<span x-show="approvalAction === 'request_changes'">Request Changes</span>
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Assign Theme Modal -->
		<div x-show="showAssignThemeModal"
			class="fixed backdrop-blur-md inset-0 z-50 overflow-y-auto transition-opacity duration-300 ease-out" x-cloak
			x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0"
			x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200"
			x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">

			<div class="flex items-center justify-center min-h-screen p-4">

				<div class="fixed inset-0 bg-gray-900 bg-opacity-70" @click="showAssignThemeModal = false"></div>

				<div class="relative bg-white rounded-xl shadow-2xl transform transition-all sm:my-8 max-w-3xl w-full"
					x-transition:enter="ease-out duration-300"
					x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
					x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
					x-transition:leave="ease-in duration-200"
					x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
					x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">

					<div class="px-6 py-4 border-b border-gray-100 bg-blue-50 rounded-t-xl">
						<h3 class="text-xl font-extrabold text-blue-800 flex items-center">
							<i class="fas fa-tags mr-3 text-blue-600"></i>
							Assign Thematic Area
						</h3>
					</div>

					<div class="p-6">
						<div class="mb-5 p-3 bg-gray-50 rounded-lg border border-gray-200">
							<p class="text-xs font-normal text-gray-700">
								<i class="fas fa-user-tag text-gray-500 mr-2"></i>
								Reviewer to Assign:
							</p>
							<p class="text-lg font-bold text-gray-900 ml-5" x-text="selectedReviewer?.name || 'N/A'">
							</p>
						</div>

						<div class="mb-6">
							<label class="block text-md font-bold text-gray-700 mb-3 border-b pb-2">Select
								Specializations:</label>
							<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-60 overflow-y-auto pr-2">
								<label
									class="flex items-center p-2 bg-white rounded-lg border cursor-pointer hover:bg-blue-50 transition duration-150">
									<input type="checkbox" x-model="assignedThemes" value="GBV"
										class="h-5 w-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
									<span class="ml-3 text-sm font-medium text-gray-700">GBV - Gender-Based
										Violence</span>
								</label>
								<label
									class="flex items-center p-2 bg-white rounded-lg border cursor-pointer hover:bg-blue-50 transition duration-150">
									<input type="checkbox" x-model="assignedThemes" value="AYPSRH"
										class="h-5 w-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
									<span class="ml-3 text-sm font-medium text-gray-700">AYPSRH - Adolescent/Young
										People SRH</span>
								</label>
								<label
									class="flex items-center p-2 bg-white rounded-lg border cursor-pointer hover:bg-blue-50 transition duration-150">
									<input type="checkbox" x-model="assignedThemes" value="MNH"
										class="h-5 w-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
									<span class="ml-3 text-sm font-medium text-gray-700">MNH - Maternal and Newborn
										Health</span>
								</label>
								<label
									class="flex items-center p-2 bg-white rounded-lg border cursor-pointer hover:bg-blue-50 transition duration-150">
									<input type="checkbox" x-model="assignedThemes" value="FP"
										class="h-5 w-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
									<span class="ml-3 text-sm font-medium text-gray-700">FP - Family Planning</span>
								</label>
								<label
									class="flex items-center p-2 bg-white rounded-lg border cursor-pointer hover:bg-blue-50 transition duration-150">
									<input type="checkbox" x-model="assignedThemes" value="CH"
										class="h-5 w-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
									<span class="ml-3 text-sm font-medium text-gray-700">CH - Child Health</span>
								</label>
								<label
									class="flex items-center p-2 bg-white rounded-lg border cursor-pointer hover:bg-blue-50 transition duration-150">
									<input type="checkbox" x-model="assignedThemes" value="AH"
										class="h-5 w-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
									<span class="ml-3 text-sm font-medium text-gray-700">AH - Adolescent
										Health</span>
								</label>
							</div>
						</div>
					</div>

					<div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end gap-3 border-t border-gray-100">
						<button @click="showAssignThemeModal = false"
							class="flex items-center px-5 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-100 transition duration-150">
							<i class="fas fa-times mr-2"></i>
							Cancel
						</button>
						<button @click="submitAssignTheme()" :disabled="assignedThemes.length === 0"
							class="flex items-center px-5 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 disabled:opacity-50 transition duration-150">
							<i class="fas fa-arrow-circle-right mr-2"></i>
							Assign (<span x-text="assignedThemes.length"></span>)
						</button>
					</div>

				</div>
			</div>
		</div>

		<!-- Add/Convert Reviewer Modal -->
		<div x-show="showAddReviewerModal" class="fixed inset-0 z-50 overflow-y-auto backdrop-blur-md" x-cloak>
			<div class="flex items-center justify-center min-h-screen px-4">
				<div class="fixed inset-0 bg-black opacity-50" @click="closeAddReviewerModal()"></div>
				<div class="relative bg-white rounded-lg p-8 max-w-2xl w-full">
					<div class="flex justify-between items-center mb-6">
						<h3 class="text-2xl font-bold">Add New Reviewer</h3>
						<button @click="closeAddReviewerModal()" class="text-gray-400 hover:text-gray-600">
							<i class="fas fa-times text-xl"></i>
						</button>
					</div>

					<!-- Option Selection Tabs -->
					<div class="mb-6">
						<div class="border-b border-gray-200">
							<nav class="-mb-px flex space-x-8" aria-label="Tabs">
								<button @click="reviewerModalTab = 'convert'"
									:class="reviewerModalTab === 'convert' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
									class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
									Convert Existing User
								</button>
								<button @click="reviewerModalTab = 'create'"
									:class="reviewerModalTab === 'create' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
									class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
									Create New Reviewer
								</button>
							</nav>
						</div>
					</div>

					<!-- Convert Existing User Tab -->
					<div x-show="reviewerModalTab === 'convert'" class="space-y-4">
						<p class="text-sm text-gray-600 mb-4">
							Select an existing user and convert them to a reviewer role.
						</p>


					<div class="mb-4">
						<label class="block text-sm font-medium mb-2">Select User <span
								class="text-red-500">*</span></label>
						<select
							x-model.number="selectedUserToConvertId"
							class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-600">
							<option value="">-- Select a user --</option>
							<template x-for="user in userSearchResults" :key="user.id">
								<option :value="user.id" x-text="`${user.name} (${user.email}) - ${user.role}`"></option>
							</template>
						</select>
						<p class="text-xs text-gray-500 mt-1">Only users who are not already reviewers or approvers are shown</p>
					</div>
						<div class="mb-4">
							<label class="block text-sm font-medium mb-2">Assign Thematic Areas <span
									class="text-red-500">*</span></label>
							<div class="grid grid-cols-2 gap-2">
								<template x-for="theme in thematicAreaOptions" :key="theme.code">
									<label
										class="flex items-center space-x-2 p-2 border rounded hover:bg-gray-50 cursor-pointer">
										<input type="checkbox" :value="theme.code" x-model="selectedThematicAreas"
											class="rounded text-blue-600 focus:ring-blue-600" />
										<span class="text-sm" x-text="theme.label"></span>
									</label>
								</template>
							</div>
						</div>

						<div class="flex gap-2 justify-end pt-4 border-t">
							<button @click="closeAddReviewerModal()"
								class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
								Cancel
							</button>
							<button @click="convertUserToReviewer()"
								:disabled="!selectedUserToConvertId || selectedThematicAreas.length === 0"
								class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
								<i class="fas fa-user-check mr-2"></i> Convert to Reviewer
							</button>
						</div>
					</div>

					<!-- Create New Reviewer Tab -->
					<div x-show="reviewerModalTab === 'create'" class="space-y-4">
						<p class="text-sm text-gray-600 mb-4">
							Create a new reviewer account. An invitation email will be sent to the provided email
							address.
						</p>

						<div class="mb-4">
							<label class="block text-sm font-medium mb-2">Full Name <span
									class="text-red-500">*</span></label>
							<input type="text" x-model="newReviewerName" placeholder="Enter full name"
								class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-600" required />
						</div>

						<div class="mb-4">
							<label class="block text-sm font-medium mb-2">Email Address <span
									class="text-red-500">*</span></label>
							<input type="email" x-model="newReviewerEmail" @blur="validateEmail()"
								placeholder="reviewer@example.com"
								class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-blue-600"
								:class="emailValidationError ? 'border-red-500' : ''" required />
							<p x-show="emailValidationError" class="text-red-500 text-xs mt-1"
								x-text="emailValidationError"></p>
						</div>

						<div class="mb-4">
							<label class="block text-sm font-medium mb-2">Assign Thematic Areas <span
									class="text-red-500">*</span></label>
							<div class="grid grid-cols-2 gap-2">
								<template x-for="theme in thematicAreaOptions" :key="theme.code">
									<label
										class="flex items-center space-x-2 p-2 border rounded hover:bg-gray-50 cursor-pointer">
										<input type="checkbox" :value="theme.code" x-model="selectedThematicAreas"
											class="rounded text-blue-600 focus:ring-blue-600" />
										<span class="text-sm" x-text="theme.label"></span>
									</label>
								</template>
							</div>
						</div>

						<div class="flex gap-2 justify-end pt-4 border-t">
							<button @click="closeAddReviewerModal()"
								class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
								Cancel
							</button>
							<button @click="createNewReviewer()"
								:disabled="newReviewerName === '' || newReviewerEmail === '' || selectedThematicAreas.length === 0 || emailValidationError !== ''"
								class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
								<i class="fas fa-paper-plane mr-2"></i> Create & Send Invitation
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Project Details Modal -->
		<div id="projectDetailsModal"
			class="hidden fixed inset-0 z-50 flex backdrop-blur-md items-center justify-center bg-black bg-opacity-50"
			aria-hidden="true" aria-modal="true" aria-labelledby="projectDetailsTitle">
			<div class="relative w-full max-w-4xl max-h-[90vh] overflow-y-auto bg-white rounded-lg shadow-xl">
				<div class="sticky top-0 z-10 flex items-center justify-between p-5 bg-white border-b border-gray-200">
					<h2 id="projectDetailsTitle" class="text-xl font-semibold text-blue-900">
						Project Details
					</h2>
					<button type="button" class="text-gray-400 hover:text-gray-600"
						onclick="closeProjectDetailsModal()">
						<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								d="M6 18L18 6M6 6l12 12"></path>
						</svg>
					</button>
				</div>
				<div id="projectDetailsContent" class="p-6">
					<p class="text-gray-500">
						<i class="fas fa-spinner fa-spin"></i> Loading...
					</p>
				</div>
			</div>
		</div>

		<!-- Document Viewer Modal -->
		<div id="documentViewerModal"
			class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" aria-modal="true">
			<div class="relative w-full max-w-6xl h-[90vh] bg-white rounded-lg shadow-xl overflow-hidden">
				<!-- Modal Header -->
				<div class="flex items-center justify-between p-4 bg-gray-100 border-b border-gray-200">
					<h3 id="documentViewerFileName" class="text-lg font-semibold text-gray-800">
						Document Viewer
					</h3>
					<div class="flex gap-2">
						<button id="documentViewerDownloadBtn"
							class="px-4 py-2 text-sm text-white bg-blue-600 rounded hover:bg-blue-700">
							<i class="fas fa-download mr-1"></i>Download
						</button>
						<button onclick="closeDocumentViewer()"
							class="px-4 py-2 text-sm text-gray-600 bg-gray-200 rounded hover:bg-gray-300">
							<i class="fas fa-times mr-1"></i>Close
						</button>
					</div>
				</div>

				<!-- Modal Body -->
				<div class="relative w-full h-full p-4 overflow-auto">
					<!-- Loading State -->
					<div id="documentViewerLoading" class="flex items-center justify-center h-full">
						<div class="text-center">
							<i class="fas fa-spinner fa-spin text-4xl text-blue-600 mb-4"></i>
							<p class="text-gray-600">Loading document...</p>
						</div>
					</div>

					<!-- PDF/Image Content -->
					<div id="documentViewerContent" class="hidden w-full h-full"></div>

					<!-- Office Document Content -->
					<div id="officeDocumentViewerContent" class="hidden w-full h-full"></div>

					<!-- Unsupported Document -->
					<div id="unsupportedDocumentContent" class="hidden flex items-center justify-center h-full">
						<div class="text-center">
							<i class="fas fa-file-alt text-6xl text-gray-400 mb-4"></i>
							<p class="text-gray-600 mb-4">
								This document type cannot be previewed.
							</p>
							<p class="text-sm text-gray-500">
								Please download the file to view it.
							</p>
						</div>
					</div>

					<!-- Error State -->
					<div id="documentViewerError" class="hidden flex items-center justify-center h-full">
						<div class="text-center text-red-600">
							<i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
							<p>Error loading document</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- NAVIGATION LOADER DISABLED FOR DEBUGGING -->
	<!-- <script src="styles/loadNav.js"></script> -->

	<script>

		function filterTabled(inputId, tbodyId, noResultsId) {
			// 1. Get elements and search term
			const input = document.getElementById(inputId);
			const filter = input.value.toUpperCase();

			const tbody = document.getElementById(tbodyId);
			// Safely get all <tr> elements within the <tbody>, ignoring the Alpine <template>
			const trs = Array.from(tbody.children).filter(el => el.tagName === 'TR');
			const noResults = document.getElementById(noResultsId);

			let foundMatch = false;

			// 2. Iterate and filter rows
			for (let i = 0; i < trs.length; i++) {
				const row = trs[i];
				const tds = row.getElementsByTagName('td');
				let rowText = '';

				// Concatenate all cell text for broad search matching
				for (let j = 0; j < tds.length; j++) {
					rowText += tds[j].innerText + ' ';
				}

				// Show/Hide row based on match
				if (rowText.toUpperCase().indexOf(filter) > -1) {
					row.style.display = "";
					foundMatch = true;
				} else {
					row.style.display = "none";
				}
			}

			// 3. Handle "No Results" message visibility
			if (noResults) {
				noResults.style.display = foundMatch ? 'none' : 'block';
			}
		}
	</script>
	<script>
		function filterTable() {
			// 1. Get the current search term and convert it to lower case
			const input = document.getElementById('search-input');
			const filter = input.value.toUpperCase();

			// 2. Get the table body and all its rows
			const tbody = document.getElementById('table-body');
			const trs = tbody.getElementsByTagName('tr');

			let foundMatch = false;

			// 3. Iterate through all table rows, starting after the template element
			for (let i = 0; i < trs.length; i++) {
				const row = trs[i];

				// Get all cells in the current row
				const tds = row.getElementsByTagName('td');
				let rowText = '';

				// Concatenate all text content from visible columns (tds)
				for (let j = 0; j < tds.length; j++) {
					// Get the displayed text content of the cell
					rowText += tds[j].innerText + ' ';
				}

				// Check if the row's combined text includes the filter term
				if (rowText.toUpperCase().indexOf(filter) > -1) {
					row.style.display = ""; // Show the row
					foundMatch = true;
				} else {
					row.style.display = "none"; // Hide the row
				}
			}

			// 4. Handle "No Results" message visibility
			const noResults = document.getElementById('no-results');
			if (noResults) {
				noResults.style.display = foundMatch ? 'none' : 'block';
			}
		}

		// Optional: You might need to call this once if the initial list is empty or if you load data dynamically.
		// window.onload = filterTable;
	</script>
	<script src="https://cdn.jsdelivr.net/npm/tw-elements/js/tw-elements.umd.min.js"></script>
	<script src="styles/authnav.js"></script>
	<script src="styles/loadNav.js"></script>
	<script>
		function approvalApp() {
			return {
				loading: false,
				activeTab: "for-review",
				userRole: "",
				userThematicArea: "",
				userThematicAreas: [], // NEW: Support for multiple thematic areas

				// Projects data
				projectsForReview: [],
				projectsForApproval: [],
				allPendingProjects: [], // Combined view for SUPER_ADMIN_APPROVER

				// Reviewers data
				allReviewers: [],
				filteredReviewers: [],
				selectedThemeFilter: "",

				// Modal states
				showReviewModal: false,
				showFinalApprovalModal: false,
				showFinalRejectModal: false,
				showAssignThemeModal: false,
				showAddReviewerModal: false,
				showUnifiedApprovalModal: false, // NEW: Unified modal for all approval actions

				// Form data
				selectedProject: null,
				reviewDecision: "approve",
				reviewComments: "",
				customReviewComment: "", // NEW: For custom review comments
				finalComments: "",
				rejectionReason: "",
				approvalAction: "approve", // NEW: Radio button selection (approve, reject, request_changes)
				approvalComments: "", // NEW: Comments for the selected action
				selectedCommentOption: "", // NEW: Selected preset comment option

				selectedReviewer: null,
				assignedTheme: "",
				assignedThemes: [], // NEW: Support for multiple thematic areas

				// Add/Convert Reviewer Modal Data
				reviewerModalTab: 'convert',
				userSearchQuery: '',
				userSearchResults: [],
				selectedUserToConvert: null,
				selectedUserToConvertId: '',
				newReviewerName: '',
				newReviewerEmail: '',
				emailValidationError: '',
				selectedThematicAreas: [],
				thematicAreaOptions: [
					{ code: 'GBV', label: 'GBV - Gender-Based Violence' },
					{ code: 'AYPSRH', label: 'AYPSRH - Adolescent & Youth SRH' },
					{ code: 'MNH', label: 'MNH - Maternal & Newborn Health' },
					{ code: 'FP', label: 'FP - Family Planning' },
					{ code: 'CH', label: 'CH - Child Health' },
					{ code: 'AH', label: 'AH - Adolescent Health' },
					{ code: 'ADV_SBC', label: 'ADV_SBC - Advocacy & SBC' },
					{ code: 'MONITORING_EVALUATION', label: 'Monitoring & Evaluation' },
					{ code: 'RESEARCH_LEARNING', label: 'Research & Learning' }
				],

				// Toast notification
				toast: {
					show: false,
					message: "",
					type: "success",
				},

				async init() {
					await this.checkAuth();
					await this.loadData();
				},

				async checkAuth() {
					// Wait for BASE_URL to be set
					let retries = 0;
					while (!window.BASE_URL && retries < 10) {
						console.log("Waiting for BASE_URL to be set...");
						await new Promise((resolve) => setTimeout(resolve, 100));
						retries++;
					}

					if (!window.BASE_URL) {
						console.error("BASE_URL not set after waiting!");
						window.BASE_URL =
							"https://api-tujulishane-hub.onrender.com"; // Fallback
					}

					console.log("Using BASE_URL:", window.BASE_URL);

					try {
						const token = localStorage.getItem("accessToken");
						if (!token) {
							console.warn("No access token found");
							window.location.href = "index.html";
							return;
						}

						// Use /api/auth/profile instead of /api/auth/me (which returns 500)
						const response = await fetch(
							`${window.BASE_URL}/api/auth/profile`,
							{
								headers: {
									Authorization: `Bearer ${token}`,
								},
							}
						);

						if (response.ok) {
							const data = await response.json();
							console.log("User data:", data);
							// Handle both response structures: data.data or direct data
							const userData = data.data || data;
							this.userRole = userData.role;
							
							// Support both legacy single thematic area and new multiple thematic areas
							this.userThematicArea = userData.thematicArea || "Not Assigned";
							this.userThematicAreas = userData.thematicAreas || [];
							
							console.log("User thematic areas:", this.userThematicAreas);

							// Set initial tab based on role
							if (this.userRole === "SUPER_ADMIN_REVIEWER") {
								this.activeTab = "for-review";
							} else if (this.userRole === "SUPER_ADMIN_APPROVER") {
								this.activeTab = "all-pending"; // Start with overview
							}

							// Restrict access if not authorized
							if (
								![
									"SUPER_ADMIN",
									"SUPER_ADMIN_REVIEWER",
									"SUPER_ADMIN_APPROVER",
								].includes(this.userRole)
							) {
								console.warn("Access denied. User role:", this.userRole);
								alert(
									"Access denied. You do not have permission to access this page."
								);
								window.location.href = "dashboard.html";
							}
						} else {
							console.error(
								"Auth response not OK:",
								response.status,
								response.statusText
							);
							window.location.href = "index.html";
						}
					} catch (error) {
						console.error("Auth check failed:", error);
						window.location.href = "index.html";
					}
				},

				async loadData() {
					this.loading = true;
					console.log("Loading data... User role:", this.userRole);
					try {
						await Promise.all([
							this.loadProjectsForReview(),
							this.loadProjectsForApproval(),
							this.loadAllPendingProjects(),
							this.loadReviewers(),
						]);
						console.log("All data loaded successfully");
					} catch (error) {
						console.error("Error loading data:", error);
					} finally {
						this.loading = false;
					}
				},

				async loadProjectsForReview() {
					if (
						!["SUPER_ADMIN_REVIEWER", "SUPER_ADMIN"].includes(this.userRole)
					) {
						console.log(
							"Skipping loadProjectsForReview - role not authorized"
						);
						this.projectsForReview = []; // Set to empty array
						return;
					}

					console.log("Loading projects for review...");
					try {
						const response = await this.apiCall(
							"/api/projects/admin/projects-for-review"
						);
						this.projectsForReview = response.data || [];
						console.log(
							"Projects for review loaded:",
							this.projectsForReview.length
						);
					} catch (error) {
						console.error("Error loading projects for review:", error);
						// Don't show error toast if it's just a permissions issue
						if (!error.message.includes("insufficient permissions")) {
							this.showToast(
								"Failed to load projects for review: " + error.message,
								"error"
							);
						}
						this.projectsForReview = []; // Set to empty array on error
					}
				},

				async loadProjectsForApproval() {
					if (
						!["SUPER_ADMIN_APPROVER", "SUPER_ADMIN"].includes(this.userRole)
					) {
						console.log(
							"Skipping loadProjectsForApproval - role not authorized"
						);
						this.projectsForApproval = []; // Set to empty array
						return;
					}

					console.log("Loading projects for approval...");
					try {
						const response = await this.apiCall(
							"/api/projects/admin/projects-awaiting-final-approval"
						);
						this.projectsForApproval = response.data || [];
						console.log(
							"Projects for approval loaded:",
							this.projectsForApproval.length
						);
					} catch (error) {
						console.error("Error loading projects for approval:", error);
						// Don't show error toast if it's just a permissions issue
						if (!error.message.includes("insufficient permissions")) {
							this.showToast(
								"Failed to load projects for approval: " + error.message,
								"error"
							);
						}
						this.projectsForApproval = []; // Set to empty array on error
					}
				},

				async loadAllPendingProjects() {
					if (
						!["SUPER_ADMIN_APPROVER", "SUPER_ADMIN"].includes(this.userRole)
					) {
						console.log(
							"Skipping loadAllPendingProjects - role not authorized"
						);
						this.allPendingProjects = []; // Set to empty array
						return;
					}

					console.log("Loading all pending projects...");
					try {
						// Fetch all projects with large page size to get comprehensive view
						const allProjectsResponse = await this.apiCall(
							"/api/projects?page=0&size=1000"
						);

						const allProjects = allProjectsResponse.data?.projects || [];

						// Filter for projects in pending states (both new two-tier workflow and legacy approval status)
						const pendingWorkflowStatuses = [
							"PENDING_REVIEW",
							"UNDER_REVIEW",
							"REVIEWED",
							"PENDING_FINAL_APPROVAL",
						];

						const pendingApprovalStatuses = ["PENDING", "SUBMITTED"];

						this.allPendingProjects = allProjects.filter((project) => {
							// Check new two-tier workflow status first
							if (
								project.approvalWorkflowStatus &&
								pendingWorkflowStatuses.includes(
									project.approvalWorkflowStatus
								)
							) {
								return true;
							}

							// Fallback to legacy approval status for projects not yet migrated
							if (
								project.approvalStatus &&
								pendingApprovalStatuses.includes(project.approvalStatus)
							) {
								return true;
							}

							return false;
						});

						console.log(
							"All pending projects loaded:",
							this.allPendingProjects.length,
							"projects in approval pipeline out of",
							allProjects.length,
							"total projects",
							`(${this.allPendingProjects.filter(
								(p) => p.approvalWorkflowStatus
							).length
							} with workflow status,`,
							`${this.allPendingProjects.filter(
								(p) => !p.approvalWorkflowStatus && p.approvalStatus
							).length
							} legacy pending)`
						);
					} catch (error) {
						console.error("Error loading all pending projects:", error);
						// Don't show error toast if it's just a permissions issue
						if (!error.message.includes("insufficient permissions")) {
							this.showToast(
								"Failed to load pending projects: " + error.message,
								"error"
							);
						}
						this.allPendingProjects = []; // Set to empty array on error
					}
				},

				async loadReviewers() {
					if (
						!["SUPER_ADMIN_APPROVER", "SUPER_ADMIN"].includes(this.userRole)
					) {
						console.log("Skipping loadReviewers - role not authorized");
						this.allReviewers = []; // Set to empty array
						this.filteredReviewers = []; // Set to empty array
						return;
					}

					console.log("Loading reviewers...");
					try {
						const response = await this.apiCall("/api/auth/admin/reviewers");
						this.allReviewers = response.data || [];
						this.filteredReviewers = this.allReviewers;
						console.log("Reviewers loaded:", this.allReviewers.length);
					} catch (error) {
						console.error("Error loading reviewers:", error);
						// Don't show error toast if it's just a permissions issue
						if (!error.message.includes("insufficient permissions")) {
							this.showToast(
								"Failed to load reviewers: " + error.message,
								"error"
							);
						}
						this.allReviewers = []; // Set to empty array on error
						this.filteredReviewers = []; // Set to empty array on error
					}
				},

				filterReviewers() {
					if (!this.selectedThemeFilter) {
						this.filteredReviewers = this.allReviewers;
					} else {
						this.filteredReviewers = this.allReviewers.filter(
							(r) => r.thematicArea === this.selectedThemeFilter
						);
					}
				},

				openReviewModal(project) {
					this.selectedProject = project;
					this.reviewDecision = "approve";
					this.reviewComments = "";
					this.customReviewComment = "";
					this.showReviewModal = true;
				},

				openFinalApprovalModal(project) {
					this.selectedProject = project;
					this.finalComments = "";
					this.showFinalApprovalModal = true;
				},

				openFinalRejectModal(project) {
					this.selectedProject = project;
					this.rejectionReason = "";
					this.showFinalRejectModal = true;
				},

				openUnifiedApprovalModal(project) {
					this.selectedProject = project;
					this.approvalAction = "approve"; // Default to approve
					this.approvalComments = "";
					this.showUnifiedApprovalModal = true;
				},

			openAssignThemeModal(reviewer) {
				this.selectedReviewer = reviewer;
				// Clear and repopulate assignedThemes for proper Alpine reactivity
				this.assignedThemes.length = 0;
				if (reviewer.thematicAreas && Array.isArray(reviewer.thematicAreas)) {
					// New many-to-many relationship
					reviewer.thematicAreas.forEach(area => this.assignedThemes.push(area));
				} else if (reviewer.thematicArea) {
					// Legacy single thematic area
					this.assignedThemes.push(reviewer.thematicArea);
				}
				this.showAssignThemeModal = true;
			},				async submitReview() {
					// Determine the final comment to send
					const finalComment = this.reviewComments === "Custom" 
						? this.customReviewComment 
						: this.reviewComments;

					if (!finalComment.trim()) {
						this.showToast("Please provide review comments", "error");
						return;
					}

					this.loading = true;
					try {
						await this.apiCall(
							`/api/projects/admin/review/${this.selectedProject.id}`,
							"POST",
							{
								approved: this.reviewDecision === "approve",
								comments: finalComment,
							}
						);

						this.showToast(
							this.reviewDecision === "approve"
								? "Project approved for final review!"
								: "Review completed - revisions requested",
							"success"
						);

						this.showReviewModal = false;
						await this.loadProjectsForReview();
						await this.loadAllPendingProjects(); // Refresh combined view
					} catch (error) {
						console.error("Error submitting review:", error);
						this.showToast(
							error.message || "Failed to submit review",
							"error"
						);
					} finally {
						this.loading = false;
					}
				},

				async submitFinalApproval() {
					this.loading = true;
					try {
						await this.apiCall(
							`/api/projects/admin/final-approve/${this.selectedProject.id}`,
							"POST",
							{
								comments: this.finalComments,
							}
						);

						this.showToast(
							"Project finally approved successfully!",
							"success"
						);
						this.showFinalApprovalModal = false;
						await this.loadProjectsForApproval();
						await this.loadAllPendingProjects(); // Refresh combined view
					} catch (error) {
						console.error("Error submitting final approval:", error);
						this.showToast(
							error.message || "Failed to approve project",
							"error"
						);
					} finally {
						this.loading = false;
					}
				},

				async submitUnifiedApprovalAction() {
					// Validate required fields
					if ((this.approvalAction === 'reject' || this.approvalAction === 'request_changes') && !this.approvalComments.trim()) {
						this.showToast("Please provide a reason for your decision", "error");
						return;
					}

					this.loading = true;
					try {
						if (this.approvalAction === 'approve') {
							// Final approval
							await this.apiCall(
								`/api/projects/admin/final-approve/${this.selectedProject.id}`,
								"POST",
								{
									comments: this.approvalComments,
								}
							);
							this.showToast("Project finally approved successfully!", "success");
						} else if (this.approvalAction === 'reject') {
							// Final rejection
							await this.apiCall(
								`/api/projects/admin/final-reject/${this.selectedProject.id}`,
								"POST",
								{
									reason: this.approvalComments,
								}
							);
							this.showToast("Project rejected", "success");
						} else if (this.approvalAction === 'request_changes') {
							// Request changes by rejecting with comments asking for revisions
							await this.apiCall(
								`/api/projects/admin/final-reject/${this.selectedProject.id}`,
								"POST",
								{
									reason: `Changes Requested: ${this.approvalComments}`,
								}
							);
							this.showToast("Changes requested - project rejected with feedback", "success");
						}

						this.showUnifiedApprovalModal = false;
						this.approvalAction = "approve"; // Reset
						this.approvalComments = ""; // Reset
						this.selectedCommentOption = ""; // Reset dropdown
						await this.loadProjectsForApproval();
						await this.loadAllPendingProjects(); // Refresh combined view
					} catch (error) {
						console.error("Error submitting approval action:", error);
						this.showToast(
							error.message || "Failed to submit approval action",
							"error"
						);
					} finally {
						this.loading = false;
					}
				},

				async submitFinalRejection() {
					if (!this.rejectionReason.trim()) {
						this.showToast("Please provide a rejection reason", "error");
						return;
					}

					this.loading = true;
					try {
						await this.apiCall(
							`/api/projects/admin/final-reject/${this.selectedProject.id}`,
							"POST",
							{
								reason: this.rejectionReason,
							}
						);

						this.showToast("Project rejected", "success");
						this.showFinalRejectModal = false;
						await this.loadProjectsForApproval();
						await this.loadAllPendingProjects(); // Refresh combined view
					} catch (error) {
						console.error("Error rejecting project:", error);
						this.showToast(
							error.message || "Failed to reject project",
							"error"
						);
					} finally {
						this.loading = false;
					}
				},

				async submitAssignTheme() {
					if (this.assignedThemes.length === 0) {
						this.showToast("Please select at least one thematic area", "error");
						return;
					}

					this.loading = true;
					try {
						// Use new endpoint that supports multiple thematic areas
						await this.apiCall(
							`/api/auth/admin/assign-thematic-areas/${this.selectedReviewer.id}`,
							"POST",
							{
								thematicAreas: this.assignedThemes,
							}
						);

						this.showToast(
							`${this.assignedThemes.length} thematic area${this.assignedThemes.length > 1 ? 's' : ''} assigned successfully!`,
							"success"
						);
						this.showAssignThemeModal = false;
						this.assignedThemes = []; // Reset selection
						await this.loadReviewers();
					} catch (error) {
						console.error("Error assigning themes:", error);
						this.showToast(
							error.message || "Failed to assign thematic areas",
							"error"
						);
					} finally {
						this.loading = false;
					}
				},

				async openAddReviewerModal() {
					this.showAddReviewerModal = true;
					this.reviewerModalTab = 'convert';
					this.resetReviewerModalData();
					await this.loadEligibleUsers();
				},

				closeAddReviewerModal() {
					this.showAddReviewerModal = false;
					this.resetReviewerModalData();
				},

				resetReviewerModalData() {
					this.userSearchQuery = '';
					this.userSearchResults = [];
					this.selectedUserToConvert = null;
					this.selectedUserToConvertId = '';
					this.newReviewerName = '';
					this.newReviewerEmail = '';
					this.emailValidationError = '';
					this.selectedThematicAreas = [];
				},

				async loadEligibleUsers() {
					try {
						const response = await this.apiCall('/api/auth/admin/users');
						// Filter out users who are already reviewers or approvers
						this.userSearchResults = (response.data || []).filter(
							user => !['SUPER_ADMIN_REVIEWER', 'SUPER_ADMIN_APPROVER', 'SUPER_ADMIN'].includes(user.role)
						);
					} catch (error) {
						console.error('Error loading eligible users:', error);
						this.userSearchResults = [];
						this.showToast('Failed to load users', 'error');
					}
				},

				async convertUserToReviewer() {
					if (!this.selectedUserToConvertId || this.selectedThematicAreas.length === 0) {
						this.showToast('Please select a user and at least one thematic area', 'error');
						return;
					}

					const selectedUser = this.userSearchResults.find(u => u.id === this.selectedUserToConvertId);
					if (!selectedUser) {
						this.showToast('Selected user not found', 'error');
						return;
					}

					this.loading = true;
					try {
						await this.apiCall(
							`/api/auth/admin/convert-to-reviewer/${this.selectedUserToConvertId}`,
							'POST',
							{
								thematicAreas: this.selectedThematicAreas
							}
						);

						this.showToast(
							`${selectedUser.name} successfully converted to reviewer!`,
							'success'
						);
						this.closeAddReviewerModal();
						await this.loadReviewers();
					} catch (error) {
						console.error('Error converting user to reviewer:', error);
						this.showToast(
							error.message || 'Failed to convert user to reviewer',
							'error'
						);
					} finally {
						this.loading = false;
					}
				},

				async createNewReviewer() {
					console.log('[DEBUG] createNewReviewer called');
					console.log('[DEBUG] newReviewerName:', this.newReviewerName);
					console.log('[DEBUG] newReviewerEmail:', this.newReviewerEmail);
					console.log('[DEBUG] selectedThematicAreas:', this.selectedThematicAreas);
					console.log('[DEBUG] emailValidationError:', this.emailValidationError);

					if (!this.newReviewerName || !this.newReviewerEmail || this.selectedThematicAreas.length === 0) {
						this.showToast('Please fill in all required fields', 'error');
						return;
					}

					if (this.emailValidationError) {
						this.showToast('Please provide a valid email address', 'error');
						return;
					}

					this.loading = true;
					try {
						await this.apiCall(
							'/api/auth/admin/create-reviewer',
							'POST',
							{
								name: this.newReviewerName,
								email: this.newReviewerEmail,
								thematicAreas: this.selectedThematicAreas
							}
						);

						this.showToast(
							`Reviewer created successfully! Invitation sent to ${this.newReviewerEmail}`,
							'success'
						);
						this.closeAddReviewerModal();
						await this.loadReviewers();
					} catch (error) {
						console.error('Error creating reviewer:', error);
						this.showToast(
							error.message || 'Failed to create reviewer',
							'error'
						);
					} finally {
						this.loading = false;
					}
				},

				validateEmail() {
					const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
					if (!this.newReviewerEmail) {
						this.emailValidationError = '';
						return;
					}
					if (!emailRegex.test(this.newReviewerEmail)) {
						this.emailValidationError = 'Please enter a valid email address';
					} else {
						this.emailValidationError = '';
					}
				},

				async viewProjectDetails(projectId) {
					const modal = document.getElementById("projectDetailsModal");
					const content = document.getElementById("projectDetailsContent");

					modal.classList.remove("hidden");
					content.innerHTML =
						'<p class="text-gray-500"><i class="fas fa-spinner fa-spin"></i> Loading project details...</p>';

					try {
						const data = await this.apiCall(`/api/projects/${projectId}`);

						if (data.status === 200 && data.data) {
							const project = data.data;

							// Fetch documents
							const documents = await this.fetchProjectDocuments(projectId);

							// Render project details
							content.innerHTML = `
                  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 space-y-8">
                      <h1 class="text-3xl font-extrabold text-blue-900">${project.title || "N/A"
								}</h1>
                      
                      <div>
                        <h4 class="text-xl font-bold text-gray-800 mb-3 border-b pb-1">Objectives</h4>
                        <p class="text-gray-700 leading-relaxed">${project.objectives || "N/A"
								}</p>
                      </div>
                      
                      ${project.themes && project.themes.length > 0
									? `
                      <div>
                        <h4 class="text-xl font-bold text-gray-800 mb-3 border-b pb-1">Themes</h4>
                        <div class="flex flex-wrap gap-2">
                          ${project.themes
										.map(
											(theme) =>
												`<span class="inline-flex items-center px-4 py-1 text-sm bg-blue-100 text-blue-800 rounded-full font-medium"><i class="fas fa-tag mr-2"></i>${theme.name || theme.code
												}</span>`
										)
										.join("")}
                        </div>
                      </div>
                      `
									: ""
								}

                      ${project.locations && project.locations.length > 0
									? `
                      <div>
                        <h4 class="text-xl font-bold text-gray-800 mb-3 border-b pb-1">Locations</h4>
                        <div class="mt-2 space-y-2">
                          ${project.locations
										.map((loc) => {
											const isCoordinatesOnly =
												loc.mapsAddress &&
												/^-?\d+\.?\d*,\s*-?\d+\.?\d*$/.test(
													loc.mapsAddress.trim()
												);
											const displayName =
												loc.mapsAddress && !isCoordinatesOnly
													? loc.mapsAddress
													: loc.county
														? `${loc.county}${loc.subCounty ? ", " + loc.subCounty : ""
														}`
														: "Unknown";
											const coordinates =
												loc.latitude && loc.longitude
													? `<span class="text-xs text-gray-500 ml-6">(${loc.latitude.toFixed(
														4
													)}, ${loc.longitude.toFixed(4)})</span>`
													: "";
											return `<div class="text-gray-800 flex items-start"><i class="fas fa-map-marker-alt text-red-500 mr-2 w-4 text-center mt-1"></i><div>${displayName}${coordinates}</div></div>`;
										})
										.join("")}
                        </div>
                      </div>
                      `
									: ""
								}

                      <div class="pt-4 border-t">
                        <h4 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                          <i class="fas fa-paperclip mr-2 text-gray-500"></i>Supporting Documents
                        </h4>
                        <div class="space-y-2">
                          ${this.renderDocuments(documents, projectId)}
                        </div>
                      </div>
                    </div>

                    <div class="lg:col-span-1 bg-gray-50 p-6 rounded-lg space-y-6 h-fit border border-gray-200">
                      <h3 class="text-lg font-bold text-blue-800 border-b pb-2 mb-4">Key Details</h3>
                      
                      <dl class="space-y-3 text-sm">
                        <div class="flex justify-between">
                          <dt class="text-gray-500">Project No:</dt>
                          <dd class="font-semibold text-gray-900">${project.projectNo || "N/A"
								}</dd>
                        </div>
                        <div class="flex justify-between">
                          <dt class="text-gray-500">Status:</dt>
                          <dd><span class="inline-block px-3 py-1 text-xs rounded-full font-bold ${this.statusBadge(
									project.status
								)}">${project.status || "N/A"}</span></dd>
                        </div>
                        <div class="flex justify-between">
                          <dt class="text-gray-500">Budget:</dt>
                          <dd class="font-bold text-green-700">KES ${(
									project.budget || 0
								).toLocaleString()}</dd>
                        </div>
                        <div class="flex justify-between">
                          <dt class="text-gray-500">Start Date:</dt>
                          <dd class="text-gray-900">${project.startDate || "N/A"
								}</dd>
                        </div>
                        <div class="flex justify-between">
                          <dt class="text-gray-500">End Date:</dt>
                          <dd class="text-gray-900">${project.endDate || "N/A"
								}</dd>
                        </div>
                        <div class="flex justify-between">
                          <dt class="text-gray-500">Activity Type:</dt>
                          <dd class="text-gray-900">${project.activityType || "N/A"
								}</dd>
                        </div>
                        <div class="flex justify-between">
                          <dt class="text-gray-500">Category:</dt>
                          <dd class="text-gray-900">${project.projectCategory || "N/A"
								}</dd>
                        </div>
                      </dl>
                      
                      <div class="pt-4 border-t">
                        <h4 class="text-base font-bold text-gray-700 mb-2 flex items-center"><i class="fas fa-user-tie mr-2"></i>Contact Person</h4>
                        <div class="space-y-1 pl-4">
                          <div class="text-gray-900 flex items-center text-sm">
                            <i class="fas fa-user mr-2 w-4 text-center text-gray-400"></i>
                            ${project.contactPersonName || "N/A"}
                          </div>
                          <div class="text-gray-900 flex items-center text-sm">
                            <i class="fas fa-briefcase mr-2 w-4 text-center text-gray-400"></i>
                            ${project.contactPersonRole || "N/A"}
                          </div>
                          <div class="text-gray-900 flex items-center text-sm">
                            <i class="fas fa-envelope mr-2 w-4 text-center text-gray-400"></i>
                            <a href="mailto:${project.contactPersonEmail
								}" class="text-blue-600 hover:text-blue-800">
                              ${project.contactPersonEmail || "N/A"}
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
						} else {
							content.innerHTML =
								'<p class="text-red-600">Failed to load project details.</p>';
						}
					} catch (error) {
						console.error("Error loading project details:", error);
						content.innerHTML =
							'<p class="text-red-600">Error loading project details: ' +
							error.message +
							"</p>";
					}
				},

				statusBadge(tag) {
					const badges = {
						active: "bg-green-200 text-green-800",
						pending: "bg-yellow-200 text-yellow-800",
						stalled: "bg-red-200 text-red-800",
						completed: "bg-cyan-300 text-gray-800",
					};
					return badges[tag] || "bg-gray-200 text-gray-800";
				},

				getFileIcon(fileType) {
					const lowerType = (fileType || "").toLowerCase();
					if (lowerType.includes("pdf")) return "fa-file-pdf text-red-600";
					if (lowerType.includes("word") || lowerType.includes("doc"))
						return "fa-file-word text-blue-600";
					if (
						lowerType.includes("excel") ||
						lowerType.includes("xls") ||
						lowerType.includes("sheet")
					)
						return "fa-file-excel text-green-600";
					if (lowerType.includes("powerpoint") || lowerType.includes("ppt"))
						return "fa-file-powerpoint text-orange-600";
					return "fa-file text-gray-600";
				},

				async fetchProjectDocuments(projectId) {
					try {
						console.log(
							`[Documents] Fetching documents for project ID: ${projectId}`
						);
						const token =
							localStorage.getItem("accessToken") ||
							localStorage.getItem("token");

						if (!token) {
							console.error("[Documents] No authentication token found");
							return null;
						}

						const response = await fetch(
							`${window.BASE_URL}/api/projects/${projectId}/documents`,
							{
								method: "GET",
								headers: {
									Authorization: `Bearer ${token}`,
									"Content-Type": "application/json",
								},
							}
						);

						console.log(`[Documents] Response status:`, response.status);

						if (response.ok) {
							const data = await response.json();
							console.log(`[Documents] Response data:`, data);

							if (data.status === 200 && data.data) {
								console.log(
									`[Documents] Found ${data.data.length} documents for project ${projectId}`
								);
								return data.data;
							} else {
								console.log(
									`[Documents] API returned non-200 status or no data:`,
									data
								);
							}
						} else {
							console.warn(
								`[Documents] API call failed with status ${response.status}`
							);
							try {
								const errorData = await response.json();
								console.error(`[Documents] Error details:`, errorData);
							} catch (e) {
								// Can't parse error response
							}
							return null;
						}
						return [];
					} catch (error) {
						console.error("[Documents] Error fetching documents:", error);
						return null;
					}
				},

				renderDocuments(documents, projectId) {
					if (documents === null) {
						return `<div class="p-3 bg-amber-50 border border-amber-200 rounded">
                <p class="text-sm text-amber-800 flex items-center">
                  <i class="fas fa-exclamation-triangle mr-2"></i>
                  Unable to load documents at this time. The server encountered an error.
                </p>
                <p class="text-xs text-amber-600 mt-1">
                  This project may have documents, but they cannot be retrieved right now.
                </p>
              </div>`;
					}

					if (!documents || documents.length === 0) {
						return '<p class="text-sm text-gray-500 italic">No supporting documents available</p>';
					}

					return documents
						.map(
							(doc) => `
              <div class="flex items-center justify-between py-2 border-b border-gray-100 hover:bg-gray-50 px-2 rounded">
                <div class="flex items-center space-x-3">
                  <i class="fas ${this.getFileIcon(doc.fileType)} text-xl"></i>
                  <div>
                    <p class="text-sm font-medium text-gray-800">${doc.fileName
								}</p>
                    <p class="text-xs text-gray-500">${this.formatFileSize(
									doc.fileSize || doc.size
								)}</p>
                  </div>
                </div>
                <div class="flex gap-2">
                  <button 
                     onclick="viewProjectDocument(${projectId}, ${doc.id}, '${doc.fileName
								}')"
                     class="px-3 py-1 text-xs font-semibold text-blue-600 bg-blue-100 rounded hover:bg-blue-200 transition">
                      <i class="fas fa-eye mr-1"></i>View
                  </button>
                  <button 
                     onclick="downloadProjectDocument(${projectId}, ${doc.id
								}, '${doc.fileName}')"
                     class="px-3 py-1 text-xs font-semibold text-white bg-blue-600 rounded hover:bg-blue-700 transition">
                      <i class="fas fa-download mr-1"></i>Download
                  </button>
                </div>
              </div>
            `
						)
						.join("");
				},

				formatFileSize(bytes) {
					if (!bytes) return "Unknown size";
					if (bytes < 1024) return bytes + " B";
					if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
					return (bytes / 1048576).toFixed(1) + " MB";
				},

				async apiCall(endpoint, method = "GET", body = null) {
					const token = localStorage.getItem("accessToken");
					const options = {
						method,
						headers: {
							Authorization: `Bearer ${token}`,
							"Content-Type": "application/json",
						},
					};

					if (body) {
						options.body = JSON.stringify(body);
					}

					console.log(`API Call: ${method} ${endpoint}`, body);

					try {
						const response = await fetch(
							`${window.BASE_URL}${endpoint}`,
							options
						);
						console.log(
							`API Response: ${response.status} ${response.statusText}`
						);

						const data = await response.json();
						console.log("API Data:", data);

						if (!response.ok) {
							console.error("API Error:", data);
							throw new Error(data.message || "API call failed");
						}

						return data;
					} catch (error) {
						console.error("API Call Exception:", error);
						throw error;
					}
				},

				formatDate(dateString) {
					if (!dateString) return "N/A";
					const date = new Date(dateString);
					return date.toLocaleDateString("en-US", {
						year: "numeric",
						month: "short",
						day: "numeric",
						hour: "2-digit",
						minute: "2-digit",
					});
				},

				getReviewerName(reviewerId) {
					if (!reviewerId) return null;
					// Find reviewer in the allReviewers list
					const reviewer = this.allReviewers.find((r) => r.id === reviewerId);
					if (reviewer) {
						return reviewer.name || reviewer.email || `User #${reviewerId}`;
					}
					return null;
				},

				showToast(message, type = "success") {
					this.toast.message = message;
					this.toast.type = type;
					this.toast.show = true;
					setTimeout(() => {
						this.toast.show = false;
					}, 3000);
				},
			};
		}

		// Global functions for onclick handlers
		window.closeProjectDetailsModal = function () {
			const modal = document.getElementById("projectDetailsModal");
			modal.classList.add("hidden");
		};

		window.closeDocumentViewer = function () {
			const modal = document.getElementById("documentViewerModal");
			modal.classList.add("hidden");
		};

		window.viewProjectDocument = async function (
			projectId,
			documentId,
			fileName = "Document"
		) {
			const modal = document.getElementById("documentViewerModal");
			const loadingElement = document.getElementById("documentViewerLoading");
			const contentElement = document.getElementById("documentViewerContent");
			const officeContentElement = document.getElementById(
				"officeDocumentViewerContent"
			);
			const unsupportedElement = document.getElementById(
				"unsupportedDocumentContent"
			);
			const errorElement = document.getElementById("documentViewerError");
			const fileNameElement = document.getElementById(
				"documentViewerFileName"
			);
			const downloadBtn = document.getElementById(
				"documentViewerDownloadBtn"
			);

			// Show modal
			modal.classList.remove("hidden");

			// Set filename in modal title
			fileNameElement.textContent = fileName || "Document";

			// Reset states - hide all containers
			loadingElement.classList.remove("hidden");
			contentElement.classList.add("hidden");
			officeContentElement.classList.add("hidden");
			unsupportedElement.classList.add("hidden");
			errorElement.classList.add("hidden");

			// Setup download button
			downloadBtn.onclick = () =>
				window.downloadProjectDocument(projectId, documentId, fileName);

			try {
				const token =
					localStorage.getItem("accessToken") ||
					localStorage.getItem("token");
				const response = await fetch(
					`${window.BASE_URL}/api/projects/${projectId}/documents/${documentId}`,
					{
						method: "GET",
						headers: {
							Authorization: `Bearer ${token}`,
						},
					}
				);

				if (!response.ok) throw new Error(`HTTP ${response.status}`);

				const blob = await response.blob();
				const fileType = blob.type.toLowerCase();

				// Hide loading
				loadingElement.classList.add("hidden");

				// Handle PDF files
				if (fileType.includes("pdf")) {
					const url = URL.createObjectURL(blob);
					contentElement.innerHTML = `<iframe src="${url}" class="w-full h-full" style="min-height: 600px;"></iframe>`;
					contentElement.classList.remove("hidden");
				}
				// Handle images
				else if (fileType.includes("image")) {
					const url = URL.createObjectURL(blob);
					contentElement.innerHTML = `<img src="${url}" class="max-w-full h-auto mx-auto" alt="${fileName}">`;
					contentElement.classList.remove("hidden");
				}
				// Handle Office documents (Word, Excel, PowerPoint)
				else if (
					fileType.includes("word") ||
					fileType.includes("document") ||
					fileType.includes("sheet") ||
					fileType.includes("excel") ||
					fileType.includes("presentation") ||
					fileType.includes("powerpoint")
				) {
					const url = URL.createObjectURL(blob);
					const encodedUrl = encodeURIComponent(url);
					officeContentElement.innerHTML = `
              <iframe 
                src="https://view.officeapps.live.com/op/embed.aspx?src=${encodedUrl}" 
                class="w-full h-full" 
                style="min-height: 600px;"
                frameborder="0">
              </iframe>
            `;
					officeContentElement.classList.remove("hidden");
				}
				// Unsupported file type
				else {
					unsupportedElement.classList.remove("hidden");
				}
			} catch (error) {
				console.error("[Viewer] Error loading document:", error);
				loadingElement.classList.add("hidden");
				errorElement.innerHTML = `
            <div class="text-center text-red-600">
              <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
              <p class="text-lg font-semibold mb-2">Error loading document</p>
              <p class="text-sm">${error.message}</p>
              <button onclick="window.closeDocumentViewer()" 
                      class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                Close
              </button>
            </div>
          `;
				errorElement.classList.remove("hidden");
			}
		};

		window.downloadProjectDocument = async function (
			projectId,
			documentId,
			fileName
		) {
			try {
				const token =
					localStorage.getItem("accessToken") ||
					localStorage.getItem("token");

				const response = await fetch(
					`${window.BASE_URL}/api/projects/${projectId}/documents/${documentId}`,
					{
						method: "GET",
						headers: {
							Authorization: `Bearer ${token}`,
						},
					}
				);

				if (!response.ok) {
					throw new Error(`HTTP ${response.status}`);
				}

				const blob = await response.blob();
				const url = URL.createObjectURL(blob);
				const link = document.createElement("a");
				link.href = url;
				link.download = fileName;
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
				URL.revokeObjectURL(url);
			} catch (error) {
				console.error("[Download] Error downloading document:", error);
				alert("Failed to download document. Please try again.");
			}
		};
	</script>
	<style>
		[x-cloak] {
			display: none !important;
		}
	</style>
</body>

</html>