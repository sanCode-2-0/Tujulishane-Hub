<!DOCTYPE html>
<html class="light" lang="en">

<head>
	<meta charset="utf-8" />
	<meta content="width=device-width, initial-scale=1.0" name="viewport" />
	<title>Organization Profile</title>
	<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
	<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&amp;display=swap"
		rel="stylesheet" />
	<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
	<!-- Alpine.js -->
	<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						"primary": "#137fec",
						"background-light": "#f6f7f8",
						"background-dark": "#101922",
					},
					fontFamily: {
						"display": ["Manrope", "sans-serif"]
					},
					borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
				},
			},
		}
	</script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
		integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
		crossorigin="anonymous" referrerpolicy="no-referrer" />
	<!-- Tailwind CSS (with custom config using inline script) -->
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						primary: "#1e40af", // Custom Blue
						secondary: "#f59e0b", // Custom Amber
						accent: "#10b981", // Custom Green
						dark: "#1f2937", // Gray-800
					},
					fontFamily: {
						sans: ["Inter", "sans-serif"],
					},
				},
			},
		};
	</script>
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
		integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
	<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;300;400;500;600;700;800;900&display=swap"
		rel="stylesheet" />
	<link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
	<!-- Alpine.js -->
	<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
	<!-- Mapbox CSS -->
	<link href="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet" />
	<!-- Mapbox JS -->
	<script src="https://api.tiles.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
	
	<!-- Backend URL Configuration - MUST BE LOADED FIRST -->
	<script src="./config.js"></script>
	<script src="./set-base-url.js"></script>
	
	<link rel="stylesheet" href="styles/main.css" />
	<!-- Authentication utilities -->
	<script type="module">
		// Try to load a local config override (frontend/config.local.js) if present.
		(function () {
			try {
				var s = document.createElement("script");
				s.src = "./config.local.js";
				s.async = false;
				document.head.appendChild(s);
			} catch (e) { }
		})();

		// Use window.BASE_URL which is already set by config.js loaded via script tag
		const BASE_URL = window.BASE_URL;
		console.log("[profile.html] Using BASE_URL:", BASE_URL, "- Environment:", window.USE_PROD ? "PRODUCTION" : "DEVELOPMENT");
	</script>

	<!-- Optional: Google Font -->
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tw-elements/css/tw-elements.min.css" />
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						primary: "#272E28",
						secondary: "#f59e0b",
						accent: "#00474C",
						button: "#14B04C",
						button_two: "#3482FF",
					},
					fontFamily: {
						sans: ["Inter", "sans-serif"],
					},
				},
			},
		};
	</script>
	<style>
		.fade-slide-enter {
			opacity: 0;
			transform: translateY(20px);
		}

		.fade-slide-enter-active {
			opacity: 1;
			transform: translateY(0);
			transition: all 0.4s ease;
		}

		.fade-slide-leave {
			opacity: 1;
			transform: translateY(0);
		}

		.fade-slide-leave-active {
			opacity: 0;
			transform: translateY(20px);
			transition: all 0.3s ease;
		}
	</style>
</head>

<body class="bg-background-light font-display text-slate-800">
	<!-- Nav Start -->
	<div id="nav-placeholder"></div>
	<!-- Nav End -->
	<div class="mt-20 relative flex min-h-screen w-full flex-col group/design-root">
		<div class="layout-container flex h-full grow flex-col">
			<main class="flex-1 p-4 sm:p-6 lg:p-8">
				<div class="mx-auto flex max-w-7xl grid lg:grid-cols-3 flex-col gap-8">
					<div class="w-full lg:sticky">
						<div class="rounded-xl border border-slate-200 bg-white">
							<div class="p-6 border-b border-slate-200">
								<h2 class="text-2xl font-bold text-blue-900">Organization Details</h2>
								<p class="mt-1 text-slate-500">Update your organization's logo and details.</p>
							</div>
							<form class="p-6 space-y-6">
								<div class="flex flex-col items-start gap-6">
									<div class="relative shrink-0 group">
										<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-lg size-32"
											data-alt="Organization's logo"
											style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuBZmlcTeocMS5Cy_Kj5WDA7yLMeakj6iTdSfavV_ZdTeWvLr2dWdcaiv5O6NlZwcYFbMi2Xvoo_5f9WldLW9PCvMeuscLoP6MmqFJTG2Id-A3E8QT0J-3-V_o8nPt7dMac0aRhJuNO5Dcf-FDRZRGe9uFOIdkrYKzbWUQsPHxko0dEFnvNNZXFgPbhrLSaGgLKsXlWnAU7_BBsu5_72ugnb2yIlWV2QQ-lYc_foyK-Tb7FKVTWBGZnmwXHGKxt0Avx4ouklsAdw2I1w');">
										</div>
										<div
											class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
											<span class="material-symbols-outlined text-white"
												style="font-size: 36px;">photo_camera</span>
										</div>
									</div>
									<div class="flex-grow w-full">
										<label class="flex flex-col">
											<p class="text-base font-medium pb-2 text-slate-800">Organization Name</p>
											<input id="orgNameInput"
												class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-slate-900 focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-slate-300 bg-white focus:border-primary h-12 px-4 text-base font-normal"
												value="" />
										</label>
									</div>
								</div>
								<div class="grid grid-cols-1 gap-6">
									<label class="flex flex-col">
										<p class="text-base font-medium pb-2 text-slate-800">Primary Contact Email</p>
										<input id="orgEmailInput"
											class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-slate-900 focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-slate-300 bg-white focus:border-primary h-12 px-4 text-base font-normal"
											type="email" value="" />
									</label>
									<label class="flex flex-col">
										<p class="text-base font-medium pb-2 text-slate-800">Organization Type</p>
										<select id="orgTypeSelect"
											class="form-select flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-slate-900 focus:outline-0 focus:ring-2 focus:ring-primary/50 border border-slate-300 bg-white focus:border-primary h-12 px-3 text-base font-normal">
											<option>Technology</option>
											<option selected="">Non-Profit</option>
											<option>Education</option>
											<option>Healthcare</option>
										</select>
									</label>
									<label class="flex flex-col">
										<p class="text-base font-medium pb-2 text-slate-800">Account Status</p>
										<div class="flex items-center h-12 px-4 rounded-lg ">
											<div id="orgStatusDiv"
												class="inline-flex items-center gap-2 rounded-full bg-green-100 px-3 py-1 text-sm font-medium text-green-700">
												<span class="size-2 rounded-full bg-green-500"></span>
												Active
											</div>
										</div>
									</label>
								</div>
								<div class="flex justify-end pt-4">
									<button
										class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-5 py-2.5 text-base font-semibold text-white transition-colors hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:ring-offset-2"
										type="submit">
										Save Changes
									</button>
								</div>
							</form>
						</div>
					</div>
					<div class="w-full lg:col-span-2">
						<div class="rounded-xl border border-slate-200 bg-white">
							<div class="p-6 border-b border-slate-200">
								<h2 class="text-2xl font-bold text-blue-900">Recent Activity</h2>
								<p class="mt-1 text-slate-500">A log of recent changes and updates to the organization's
									account.</p>
							</div>
							<div class="p-6">
								<div class="flow-root">
									<ul class="-mb-8">
										<li>
											<div class="relative pb-8">
												<span aria-hidden="true"
													class="absolute left-4 top-4 -ml-px h-full w-0.5 bg-slate-200"></span>
												<div class="relative flex space-x-3">
													<div>
														<span
															class="h-8 w-8 rounded-full bg-slate-100 flex items-center justify-center ring-8 ring-white">
															<span
																class="material-symbols-outlined text-slate-500 text-lg">person</span>
														</span>
													</div>
													<div class="flex min-w-0 flex-1 justify-between space-x-4 pt-1.5">
														<div>
															<p class="text-sm text-slate-500"><strong
																	class="font-medium text-slate-900">Aria
																	Montgomery</strong> updated the primary contact
																email.</p>
														</div>
														<div
															class="text-right text-sm whitespace-nowrap text-slate-500">
															<time>2 days ago</time>
														</div>
													</div>
												</div>
											</div>
										</li>
										<li>
											<div class="relative pb-8">
												<span aria-hidden="true"
													class="absolute left-4 top-4 -ml-px h-full w-0.5 bg-slate-200 dark:bg-slate-700"></span>
												<script src="styles/authnav.js"></script>
												<script src="styles/loadNav.js"></script>
												<script src="auth.js"></script>
												<script>
													document.addEventListener("DOMContentLoaded", async function () {
														if (!authManager.isAuthenticated()) {
															// Redirect to login if not authenticated
															window.location.href = "index.html";
															return;
														}
														try {
															const org = await authManager.getCurrentUser();
															if (org) {
																// Organization Details
																document.getElementById('orgNameInput').value = org.organizationName || org.name || "";
																document.getElementById('orgEmailInput').value = org.email || "";
																const typeSelect = document.getElementById('orgTypeSelect');
																if (typeSelect && org.organizationType) {
																	Array.from(typeSelect.options).forEach(opt => {
																		opt.selected = (opt.text === org.organizationType);
																	});
																}
																// Account Status
																const statusDiv = document.getElementById('orgStatusDiv');
																if (statusDiv) {
																	if (org.approvalStatus === 'APPROVED') {
																		statusDiv.className = 'inline-flex items-center gap-2 rounded-full bg-green-100 px-3 py-1 text-sm font-medium text-green-700';
																		statusDiv.innerHTML = '<span class="size-2 rounded-full bg-green-500"></span> Active';
																	} else {
																		statusDiv.className = 'inline-flex items-center gap-2 rounded-full bg-yellow-100 px-3 py-1 text-sm font-medium text-yellow-700';
																		statusDiv.innerHTML = '<span class="size-2 rounded-full bg-yellow-500"></span> ' + (org.approvalStatus || 'Pending');
																	}
																}
																// Recent Activity (account created, last login, etc)
																const activityList = document.querySelector('.flow-root ul');
																if (activityList) {
																	activityList.innerHTML = '';
																	// Account Created
																	if (org.createdAt) {
																		const li = document.createElement('li');
																		li.innerHTML = `<div class="relative pb-8">
																				<span aria-hidden="true" class="absolute left-4 top-4 -ml-px h-full w-0.5 bg-slate-200"></span>
																				<div class="relative flex space-x-3">
																				<div>
																					<span class="h-8 w-8 rounded-full bg-slate-100 flex items-center justify-center ring-8 ring-white">
																					<span class="material-symbols-outlined text-slate-500 text-lg">person_add</span>
																					</span>
																				</div>
																				<div class="flex min-w-0 flex-1 justify-between space-x-4 pt-1.5">
																					<div>
																					<p class="text-sm text-slate-500"><strong class="font-medium text-slate-900">${org.name || org.organizationName}</strong> account created.</p>
																					</div>
																					<div class="text-right text-sm whitespace-nowrap text-slate-500">
																					<time>${new Date(org.createdAt).toLocaleString()}</time>
																					</div>
																				</div>
																				</div>
																			</div>`;
																		activityList.appendChild(li);
																	}
																	// Last Login
																	if (org.lastLogin) {
																		const li = document.createElement('li');
																		li.innerHTML = `<div class="relative pb-8">
																				<span aria-hidden="true" class="absolute left-4 top-4 -ml-px h-full w-0.5 bg-slate-200"></span>
																				<div class="relative flex space-x-3">
																				<div>
																					<span class="h-8 w-8 rounded-full bg-slate-100 flex items-center justify-center ring-8 ring-white">
																					<span class="material-symbols-outlined text-slate-500 text-lg">login</span>
																					</span>
																				</div>
																				<div class="flex min-w-0 flex-1 justify-between space-x-4 pt-1.5">
																					<div>
																					<p class="text-sm text-slate-500"><strong class="font-medium text-slate-900">${org.name || org.organizationName}</strong> last login.</p>
																					</div>
																					<div class="text-right text-sm whitespace-nowrap text-slate-500">
																					<time>${new Date(org.lastLogin).toLocaleString()}</time>
																					</div>
																				</div>
																				</div>
																			</div>`;
																		activityList.appendChild(li);
																	}
																	// If no activity
																	if (!org.createdAt && !org.lastLogin) {
																		activityList.innerHTML = '<li><div class="relative"><div class="flex min-w-0 flex-1 justify-between space-x-4 pt-1.5"><div><p class="text-sm text-slate-500">No recent activity.</p></div></div></div></li>';
																	}
																}
															}
														} catch (error) {
															console.error("Failed to load user profile:", error);
															// Optionally show an error message or redirect
															alert("Failed to load profile. Please try logging in again.");
															authManager.logout();
														}
													});
												</script>
												<script>
													// Populate user dropdown with data from authManager
													document.addEventListener("DOMContentLoaded", function () {
														(async function () {
															let user = authManager.getCachedUser();
															if (!user) {
																try {
																	await authManager.getCurrentUser();
																	user = authManager.getCachedUser();
																} catch (err) {
																	console.error("[ERROR] Could not fetch user profile:", err);
																}
															}
															// Wait a bit for authManager to initialize
															setTimeout(() => {
																const user = authManager.getCachedUser();
																console.log("[DEBUG] Loading user data for dropdown:", user);

																if (user) {
																	// Update user display name in button
																	const userDisplayName =
																		document.getElementById("userDisplayName");
																	if (userDisplayName) {
																		userDisplayName.textContent = user.name || user.email || "User";
																	}

																	// Update user name in dropdown
																	const userNameDisplay =
																		document.getElementById("userNameDisplay");
																	if (userNameDisplay) {
																		userNameDisplay.textContent = user.name || "User";
																	}

																	// Update email
																	const userEmailDisplay =
																		document.getElementById("userEmailDisplay");
																	if (userEmailDisplay) {
																		userEmailDisplay.textContent = user.email || "";
																	}

																	// Update role
																	const userRoleDisplay =
																		document.getElementById("userRoleDisplay");
																	if (userRoleDisplay) {
																		userRoleDisplay.textContent = user.role || "USER";
																	}

																	// Update status
																	const userStatusDisplay =
																		document.getElementById("userStatusDisplay");
																	if (userStatusDisplay) {
																		userStatusDisplay.textContent =
																			user.approvalStatus || "PENDING";
																	}

																	// Show admin nav if user is admin
																	console.log("[DEBUG] DOMContentLoaded - User role:", user.role);
																	if (user.role === "ADMIN" || user.role === "SUPER_ADMIN" || user.role === "SUPER_ADMIN_REVIEWER" || user.role === "SUPER_ADMIN_APPROVER") {
																		console.log(
																			"[DEBUG] DOMContentLoaded - User is admin, showing admin elements"
																		);

																		const adminNavItems = document.querySelectorAll("#adminNav");
																		adminNavItems.forEach((nav) => nav.classList.remove("hidden"));

																		// Show admin collaboration menu item
																		const adminCollabItem =
																			document.getElementById("admin-collab-item");
																		if (adminCollabItem) {
																			adminCollabItem.style.display = "block";
																			console.log(
																				"[DEBUG] DOMContentLoaded - Set adminCollabItem display to block"
																			);
																		}

																		const adminCollabMobile = document.getElementById(
																			"admin-collab-mobile"
																		);
																		if (adminCollabMobile) {
																			adminCollabMobile.style.display = "block";
																			console.log(
																				"[DEBUG] DOMContentLoaded - Set adminCollabMobile display to block"
																			);
																		}

																		// Load pending requests count
																		loadPendingRequestsCount();
																	} else if (user.role === "DONOR") {
																		const donorNavItems = document.querySelectorAll("#donorNav");
																		donorNavItems.forEach((nav) => nav.classList.remove("hidden"));
																	}
																} else {
																	console.warn("[DEBUG] No user data found in cache");
																}
															}, 500);
														})();
													});
												</script>

</html>