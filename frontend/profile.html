<!DOCTYPE html>
<html class="light" lang="en">

<head>
	<meta charset="utf-8" />
	<meta content="width=device-width, initial-scale=1.0" name="viewport" />
	<title>Organization Profile</title>
	<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
	<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
	<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
	<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
	<link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
	
	<!-- Backend URL Configuration -->
	<script src="./config.js"></script>
	<script src="./set-base-url.js"></script>
	<script src="./modal-utils.js"></script>
	
	<link rel="stylesheet" href="styles/main.css" />
	
	<script>
		tailwind.config = {
			theme: {
				extend: {
					colors: {
						primary: "#137fec",
						secondary: "#f59e0b",
						accent: "#10b981",
						dark: "#1f2937",
						"background-light": "#f6f7f8",
						"background-dark": "#101922",
					},
					fontFamily: {
						display: ["Manrope", "sans-serif"],
						sans: ["Inter", "sans-serif"],
					},
					borderRadius: { DEFAULT: "0.25rem", lg: "0.5rem", xl: "0.75rem", full: "9999px" },
				},
			},
		};
	</script>
	
	<style>
		.fade-slide-enter {
			opacity: 0;
			transform: translateY(20px);
		}
		.fade-slide-enter-active {
			opacity: 1;
			transform: translateY(0);
			transition: all 0.4s ease;
		}
		.fade-slide-leave {
			opacity: 1;
			transform: translateY(0);
		}
		.fade-slide-leave-active {
			opacity: 0;
			transform: translateY(20px);
			transition: all 0.3s ease;
		}
		.completeness-bar {
			background: linear-gradient(90deg, #10b981 var(--completion), #e5e7eb var(--completion));
			transition: background 0.3s ease;
		}
	</style>
</head>

<body class="bg-background-light font-display text-slate-800">
	<!-- Nav Start -->
	<div id="nav-placeholder"></div>
	<!-- Nav End -->
	
	<div class="mt-20 relative flex min-h-screen w-full flex-col group/design-root">
		<div class="layout-container flex h-full grow flex-col">
			<main class="flex-1 p-4 sm:p-6 lg:p-8">
				<div class="mx-auto max-w-6xl space-y-8">
					
					<!-- Header with Status -->
					<div class="rounded-xl border border-slate-200 bg-white p-6">
						<div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-6">
							<div class="flex-1">
								<h1 id="userOrgName" class="text-3xl font-bold text-blue-900">Loading...</h1>
								<div class="mt-3 flex items-center gap-3">
									<div id="statusBadge" class="inline-flex items-center gap-2 rounded-full bg-yellow-100 px-3 py-1 text-sm font-medium text-yellow-700">
										<span class="size-2 rounded-full bg-yellow-500"></span>
										<span id="statusText">Pending Approval</span>
									</div>
									<p id="statusMessage" class="text-sm text-slate-600">Your account is pending approval. Complete your profile to proceed.</p>
								</div>
							</div>
							<button id="logoutBtn" class="rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white transition-colors hover:bg-red-700">
								<i class="fas fa-sign-out-alt mr-2"></i>Logout
							</button>
						</div>
					</div>

					<!-- Profile Completeness Indicator -->
					<div class="rounded-xl border border-slate-200 bg-white p-6">
						<h2 class="text-lg font-bold text-blue-900 mb-4">Profile Completion</h2>
						<div class="space-y-3">
							<div class="flex items-center justify-between">
								<p class="text-sm font-medium text-slate-700">Overall Progress</p>
								<p id="completionPercent" class="text-sm font-semibold text-primary">0%</p>
							</div>
							<div class="h-3 w-full rounded-full bg-slate-200 overflow-hidden">
								<div id="completionBar" class="completeness-bar h-full bg-green-500" style="--completion: 0%;"></div>
							</div>
							<ul id="completionChecklist" class="mt-4 space-y-2 text-sm">
								<li class="flex items-center gap-2"><span id="check-org" class="text-xl">☐</span> <span>Organization details filled</span></li>
								<li class="flex items-center gap-2"><span id="check-logo" class="text-xl">☐</span> <span>Logo uploaded</span></li>
								<li class="flex items-center gap-2"><span id="check-docs" class="text-xl">☐</span> <span>Required documents uploaded</span></li>
								<li class="flex items-center gap-2"><span id="check-contact" class="text-xl">☐</span> <span>Contact information verified</span></li>
								<li class="flex items-center gap-2"><span id="check-security" class="text-xl">☐</span> <span>Phone number for recovery added</span></li>
							</ul>
						</div>
					</div>

					<!-- Two Column Layout -->
					<div class="grid lg:grid-cols-3 gap-8">
						
						<!-- Left Column: Basic Info & Logo -->
						<div class="lg:col-span-1 space-y-6">
							
						<!-- Logo Card -->
						<div class="rounded-xl border border-slate-200 bg-white p-6">
							<h3 class="text-lg font-bold text-blue-900 mb-4">Organization Logo</h3>
							<div class="relative shrink-0 group mb-4">
								<div id="orgLogo" class="bg-center bg-no-repeat aspect-square bg-cover rounded-lg size-40 bg-slate-100 border border-slate-200 flex items-center justify-center">
									<i class="fas fa-image text-4xl text-slate-400"></i>
								</div>
								<div id="logoUploadBtn" class="absolute inset-0 flex items-center justify-center bg-black/50 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer">
									<span class="material-symbols-outlined text-white" style="font-size: 40px;">photo_camera</span>
								</div>
								<input type="file" id="logoFileInput" accept="image/*" style="display:none;" />
							</div>
							<p class="text-xs text-slate-500">Hover over logo to upload or change</p>
						</div>							<!-- Account Info Card -->
							<div class="rounded-xl border border-slate-200 bg-white p-6">
								<h3 class="text-lg font-bold text-blue-900 mb-4">Account Information</h3>
								<div class="space-y-3">
									<div>
										<p class="text-xs font-medium text-slate-500 uppercase">Account Created</p>
										<p id="createdAt" class="text-sm font-medium text-slate-900">-</p>
									</div>
									<div>
										<p class="text-xs font-medium text-slate-500 uppercase">Last Login</p>
										<p id="lastLogin" class="text-sm font-medium text-slate-900">-</p>
									</div>
									<div>
										<p class="text-xs font-medium text-slate-500 uppercase">Email Verified</p>
										<p id="emailVerified" class="text-sm font-medium text-slate-900">
											<span id="emailVerifiedStatus" class="inline-flex items-center gap-1">
												<i class="fas fa-circle-check text-green-500"></i> Yes
											</span>
										</p>
									</div>
								</div>
							</div>

						</div>

						<!-- Right Column: Forms & Details -->
						<div class="lg:col-span-2 space-y-6">
							
							<!-- Organization Details Form -->
							<div class="rounded-xl border border-slate-200 bg-white p-6">
								<h3 class="text-lg font-bold text-blue-900 mb-4">Organization Details</h3>
								<form id="orgProfileForm" class="space-y-4">
									<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
										<label class="flex flex-col">
											<p class="text-sm font-medium pb-2 text-slate-800">Organization Name *</p>
											<input id="orgNameInput" type="text" class="form-input w-full rounded-lg border border-slate-300 bg-white px-4 py-2 text-slate-900 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="Enter organization name" required />
										</label>
										<label class="flex flex-col">
											<p class="text-sm font-medium pb-2 text-slate-800">Organization Type *</p>
										<select id="orgTypeSelect" class="form-select w-full rounded-lg border border-slate-300 bg-white px-4 py-2 text-slate-900 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/50" required>
											<option value="">Select type...</option>
											<option value="NGO">Non-Governmental Organization (NGO)</option>
											<option value="GOVERNMENT_AGENCY">Government Agency</option>
											<option value="PRIVATE_COMPANY">Private Company/Corporation</option>
											<option value="INTERNATIONAL_ORG">International Organization</option>
											<option value="FOUNDATION">Foundation/Trust</option>
											<option value="COMMUNITY_GROUP">Community-Based Organization</option>
											<option value="ACADEMIC_INSTITUTION">Academic Institution</option>
											<option value="HEALTHCARE_PROVIDER">Healthcare Provider</option>
											<option value="DONOR_AGENCY">Donor/Funding Agency</option>
											<option value="OTHER">Other</option>
										</select>
										</label>
									</div>

									<div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
										<label class="flex flex-col">
											<p class="text-sm font-medium pb-2 text-slate-800">Primary Email *</p>
											<input id="orgEmailInput" type="email" class="form-input w-full rounded-lg border border-slate-300 bg-white px-4 py-2 text-slate-900 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="email@organization.com" required />
										</label>
									<label class="flex flex-col">
										<p class="text-sm font-medium pb-2 text-slate-800">Phone Number * <span class="text-xs text-slate-500">(For account recovery)</span></p>
										<input id="orgPhoneInput" type="tel" class="form-input w-full rounded-lg border border-slate-300 bg-white px-4 py-2 text-slate-900 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="+254712345678" required />
									</label>
									</div>

									<label class="flex flex-col">
										<p class="text-sm font-medium pb-2 text-slate-800">Physical Address</p>
										<input id="orgAddressInput" type="text" class="form-input w-full rounded-lg border border-slate-300 bg-white px-4 py-2 text-slate-900 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="Street address" />
									</label>

									<label class="flex flex-col">
										<p class="text-sm font-medium pb-2 text-slate-800">Organization Description</p>
										<textarea id="orgDescInput" class="form-input w-full rounded-lg border border-slate-300 bg-white px-4 py-2 text-slate-900 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="Brief description of your organization" rows="4"></textarea>
									</label>

									<div id="formErrorMessage" class="hidden rounded-lg bg-red-50 border border-red-200 p-3 text-sm text-red-700"></div>
									<div id="formSuccessMessage" class="hidden rounded-lg bg-green-50 border border-green-200 p-3 text-sm text-green-700"></div>

									<div class="flex justify-end pt-4 gap-3">
										<button type="button" id="cancelBtn" class="rounded-lg border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 transition-colors hover:bg-slate-50">
											Cancel
										</button>
										<button id="saveBtn" type="submit" class="inline-flex items-center justify-center rounded-lg bg-blue-600 px-5 py-2 text-sm font-semibold text-white transition-colors hover:bg-blue-700">
											<span id="saveBtnText">Save Changes</span>
											<span id="saveBtnLoading" class="hidden ml-2"><i class="fas fa-spinner fa-spin"></i></span>
										</button>
									</div>
								</form>
							</div>

							<!-- Account Recovery Section -->
							<div class="rounded-xl border border-slate-200 bg-white p-6">
								<h3 class="text-lg font-bold text-blue-900 mb-4">Account Recovery</h3>
								<div class="space-y-4">
									<div>
										<p class="text-sm text-slate-600 mb-3">Your phone number is used to recover your account if you lose access to your email.</p>
										<div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
											<i class="fas fa-phone text-primary text-lg"></i>
											<div>
												<p class="text-sm font-medium text-slate-900" id="displayPhoneNumber">Not set</p>
												<p class="text-xs text-slate-600">Recovery phone number</p>
											</div>
										</div>
									</div>
									<div>
										<p class="text-sm text-slate-600 mb-3">We use email OTP to verify your identity. No password needed!</p>
										<div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg border border-green-200">
											<i class="fas fa-envelope text-green-600 text-lg"></i>
											<div>
												<p class="text-sm font-medium text-slate-900">Email OTP Authentication</p>
												<p class="text-xs text-slate-600">Your email receives a one-time password for login</p>
											</div>
										</div>
									</div>
								</div>
							</div>

						</div>

					</div>

					<!-- Required Documents Section -->
					<div class="rounded-xl border border-slate-200 bg-white p-6">
					<h3 class="text-lg font-bold text-blue-900 mb-4">Required Documents</h3>
					
					<div id="documentsList" class="space-y-4">
							<!-- Document items will be added dynamically -->
						</div>

						<div id="noDocumentsMsg" class="text-center py-8 text-slate-500">
							<i class="fas fa-file text-2xl mb-2"></i>
							<p>No documents uploaded yet</p>
						</div>
					</div>

					<!-- Recent Activity Section -->
					<div class="rounded-xl border border-slate-200 bg-white p-6">
						<h3 class="text-lg font-bold text-blue-900 mb-4">Recent Activity</h3>
						<div class="flow-root">
							<ul id="activityList" class="-mb-8 space-y-1">
								<!-- Activity items will be added dynamically -->
							</ul>
						</div>
					</div>

					<!-- Support Section -->
					<div class="rounded-xl border border-slate-200 bg-white p-6">
						<h3 class="text-lg font-bold text-blue-900 mb-4">Help & Support</h3>
						<div class="grid sm:grid-cols-2 gap-4">
							<a href="/faq.html" class="rounded-lg border border-slate-300 p-4 text-center transition-colors hover:bg-slate-50">
								<i class="fas fa-question-circle text-2xl text-primary mb-2"></i>
								<p class="font-medium text-slate-900">FAQ</p>
								<p class="text-xs text-slate-600">Frequently asked questions</p>
							</a>
							<a href="mailto:support@tujulishane.com" class="rounded-lg border border-slate-300 p-4 text-center transition-colors hover:bg-slate-50">
								<i class="fas fa-headset text-2xl text-primary mb-2"></i>
								<p class="font-medium text-slate-900">Support</p>
								<p class="text-xs text-slate-600">Contact our support team</p>
							</a>
						</div>
					</div>

				</div>
			</main>
		</div>
	</div>

	<!-- Scripts -->
	<script src="styles/authnav.js"></script>
	<script src="styles/loadNav.js"></script>
	<script src="auth.js"></script>

	<script>
		document.addEventListener("DOMContentLoaded", async function () {
			// Auth check
			if (!window.authManager || !authManager.isAuthenticated()) {
				window.location.href = "index.html";
				return;
			}

			// DOM Elements
			const elements = {
				userOrgName: document.getElementById('userOrgName'),
				statusBadge: document.getElementById('statusBadge'),
				statusText: document.getElementById('statusText'),
				statusMessage: document.getElementById('statusMessage'),
				logoutBtn: document.getElementById('logoutBtn'),
				
				orgLogo: document.getElementById('orgLogo'),
				logoUploadBtn: document.getElementById('logoUploadBtn'),
				logoFileInput: document.getElementById('logoFileInput'),
				
				createdAt: document.getElementById('createdAt'),
				lastLogin: document.getElementById('lastLogin'),
				emailVerifiedStatus: document.getElementById('emailVerifiedStatus'),
				
				orgNameInput: document.getElementById('orgNameInput'),
				orgEmailInput: document.getElementById('orgEmailInput'),
				orgPhoneInput: document.getElementById('orgPhoneInput'),
				orgAddressInput: document.getElementById('orgAddressInput'),
				orgDescInput: document.getElementById('orgDescInput'),
				orgTypeSelect: document.getElementById('orgTypeSelect'),
				
				orgProfileForm: document.getElementById('orgProfileForm'),
				saveBtn: document.getElementById('saveBtn'),
				saveBtnText: document.getElementById('saveBtnText'),
				saveBtnLoading: document.getElementById('saveBtnLoading'),
				cancelBtn: document.getElementById('cancelBtn'),
				formErrorMessage: document.getElementById('formErrorMessage'),
				formSuccessMessage: document.getElementById('formSuccessMessage'),
				
				completionBar: document.getElementById('completionBar'),
				completionPercent: document.getElementById('completionPercent'),
				activityList: document.getElementById('activityList'),
				documentsList: document.getElementById('documentsList'),
				noDocumentsMsg: document.getElementById('noDocumentsMsg'),
			};

			// Helper functions
			function setLoading(isLoading) {
				elements.saveBtn.disabled = isLoading;
				if (isLoading) {
					elements.saveBtnText.classList.add('hidden');
					elements.saveBtnLoading.classList.remove('hidden');
				} else {
					elements.saveBtnText.classList.remove('hidden');
					elements.saveBtnLoading.classList.add('hidden');
				}
			}

			function showMessage(type, message) {
				if (type === 'error') {
					elements.formErrorMessage.textContent = message;
					elements.formErrorMessage.classList.remove('hidden');
					elements.formSuccessMessage.classList.add('hidden');
				} else {
					elements.formSuccessMessage.textContent = message;
					elements.formSuccessMessage.classList.remove('hidden');
					elements.formErrorMessage.classList.add('hidden');
				}
				setTimeout(() => {
					elements.formErrorMessage.classList.add('hidden');
					elements.formSuccessMessage.classList.add('hidden');
				}, 5000);
			}

			function validateFile(file, maxSizeMB, allowedMimeTypes) {
				// Check file size (convert MB to bytes)
				if (file.size > maxSizeMB * 1024 * 1024) {
					return false;
				}
				// Check file type
				if (!allowedMimeTypes.includes(file.type)) {
					return false;
				}
				return true;
			}

			function validateFormInputs() {
				const errors = [];
				if (!elements.orgNameInput.value.trim()) errors.push('Organization name is required');
				if (!elements.orgTypeSelect.value) errors.push('Organization type is required');
				if (!elements.orgEmailInput.value.trim()) errors.push('Email is required');
				if (!elements.orgPhoneInput.value.trim()) errors.push('Phone number is required');
				
				// Basic email validation
				const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
				if (elements.orgEmailInput.value && !emailRegex.test(elements.orgEmailInput.value)) {
					errors.push('Please enter a valid email address');
				}
				
				// Basic phone validation (at least 10 digits)
				const phoneRegex = /^\+?[\d\s\-\(\)]{10,}$/;
				if (elements.orgPhoneInput.value && !phoneRegex.test(elements.orgPhoneInput.value.replace(/\s/g, ''))) {
					errors.push('Please enter a valid phone number');
				}

				return errors;
			}

			function updateCompleteness(org) {
				let completed = 0;
				const total = 5;

				// Check org details
				if (org.organizationName && org.organizationType) {
					completed++;
					document.getElementById('check-org').textContent = '✓';
				}

				// Check logo
				if (org.logoUrl) {
					completed++;
					document.getElementById('check-logo').textContent = '✓';
				}

				// Check documents (if required)
				if (org.documents && org.documents.length > 0) {
					completed++;
					document.getElementById('check-docs').textContent = '✓';
				}

				// Check contact
				if (org.email) {
					completed++;
					document.getElementById('check-contact').textContent = '✓';
				}

				// Check phone number for recovery
				if (org.phone) {
					completed++;
					document.getElementById('check-security').textContent = '✓';
				}

				const percent = Math.round((completed / total) * 100);
				elements.completionPercent.textContent = percent + '%';
				elements.completionBar.style.setProperty('--completion', percent + '%');
			}

			function renderActivityLog(org) {
				elements.activityList.innerHTML = '';
				const activities = [];

				if (org.createdAt) {
					activities.push({
						icon: 'person_add',
						title: 'Account created',
						date: new Date(org.createdAt)
					});
				}

				if (org.lastLogin) {
					activities.push({
						icon: 'login',
						title: 'Last login',
						date: new Date(org.lastLogin)
					});
				}

				if (org.lastProfileUpdate) {
					activities.push({
						icon: 'edit',
						title: 'Profile updated',
						date: new Date(org.lastProfileUpdate)
					});
				}

				if (activities.length === 0) {
					elements.activityList.innerHTML = '<li class="text-center text-slate-500 py-4">No recent activity</li>';
					return;
				}

				activities.sort((a, b) => b.date - a.date);

				activities.forEach((activity, index) => {
					const li = document.createElement('li');
					li.innerHTML = `
						<div class="relative pb-8 ${index === activities.length - 1 ? '' : ''}">
							${index !== activities.length - 1 ? '<span aria-hidden="true" class="absolute left-4 top-4 -ml-px h-full w-0.5 bg-slate-200"></span>' : ''}
							<div class="relative flex space-x-3">
								<div>
									<span class="h-8 w-8 rounded-full bg-slate-100 flex items-center justify-center ring-8 ring-white">
										<span class="material-symbols-outlined text-slate-500 text-lg">${activity.icon}</span>
									</span>
								</div>
								<div class="flex min-w-0 flex-1 justify-between space-x-4 pt-1.5">
									<div>
										<p class="text-sm text-slate-600">${activity.title}</p>
									</div>
									<div class="text-right text-sm whitespace-nowrap text-slate-500">
										<time>${activity.date.toLocaleString()}</time>
									</div>
								</div>
							</div>
						</div>
					`;
					elements.activityList.appendChild(li);
				});
			}

			function renderDocuments(org) {
				if (!org.documents || org.documents.length === 0) {
					elements.documentsList.innerHTML = '';
					elements.noDocumentsMsg.classList.remove('hidden');
					return;
				}

				elements.noDocumentsMsg.classList.add('hidden');
				elements.documentsList.innerHTML = org.documents.map(doc => `
					<div class="flex items-center justify-between p-4 border border-slate-200 rounded-lg hover:bg-slate-50 transition">
						<div class="flex items-center gap-3 flex-1">
							<i class="fas fa-file text-primary text-lg"></i>
							<div class="flex-1">
								<p class="font-medium text-slate-900">${doc.name || 'Document'}</p>
								<p class="text-xs text-slate-500">${new Date(doc.uploadedAt).toLocaleString()}</p>
							</div>
						</div>
						<div class="flex items-center gap-2">
							<span class="px-2 py-1 rounded text-xs font-medium ${
								doc.status === 'approved' ? 'bg-green-100 text-green-700' :
								doc.status === 'rejected' ? 'bg-red-100 text-red-700' :
								'bg-yellow-100 text-yellow-700'
							}">${doc.status || 'Pending'}</span>
							${doc.url ? `<a href="${doc.url}" target="_blank" class="text-primary hover:underline text-sm"><i class="fas fa-download"></i></a>` : ''}
						</div>
					</div>
				`).join('');
			}

			// Document and logo management disabled - handled by organization administrators
			// These functions are no longer available to regular users

			async function loadProfile() {
				setLoading(true);
				try {
					const response = await authManager.apiCall('/api/auth/profile', 'GET');
					if (!response.ok) {
						showMessage('error', 'Failed to load profile');
						setLoading(false);
						return;
					}

					const data = await response.json();
					const org = data.data || data; // Handle both wrapped and unwrapped responses

					if (!org) {
						showMessage('error', 'No profile data found');
						setLoading(false);
						return;
					}

					// Update header
					elements.userOrgName.textContent = org.organizationName || org.name || 'Organization';

					// Update status
					if (org.approvalStatus === 'APPROVED') {
						elements.statusBadge.className = 'inline-flex items-center gap-2 rounded-full bg-green-100 px-3 py-1 text-sm font-medium text-green-700';
						elements.statusText.textContent = 'Active';
						elements.statusMessage.textContent = 'Your account is active and approved.';
					} else if (org.approvalStatus === 'REJECTED') {
						elements.statusBadge.className = 'inline-flex items-center gap-2 rounded-full bg-red-100 px-3 py-1 text-sm font-medium text-red-700';
						elements.statusText.textContent = 'Rejected';
						elements.statusMessage.textContent = 'Your account was not approved. Contact support for more information.';
					} else {
						elements.statusBadge.className = 'inline-flex items-center gap-2 rounded-full bg-yellow-100 px-3 py-1 text-sm font-medium text-yellow-700';
						elements.statusText.textContent = 'Pending Approval';
						elements.statusMessage.textContent = 'Your account is pending approval. Complete your profile to expedite the process.';
					}

				// Update logo
				if (org.id) {
					// Try to load logo from backend
					elements.orgLogo.style.backgroundImage = `url('/api/organizations/${org.id}/logo')`;
					elements.orgLogo.innerHTML = '';
				}					// Update form fields
					elements.orgNameInput.value = org.organizationName || org.name || '';
					elements.orgEmailInput.value = org.email || '';
					elements.orgPhoneInput.value = org.phone || '';
					elements.orgAddressInput.value = org.address || '';
					elements.orgDescInput.value = org.description || '';
					if (org.organizationType) {
						Array.from(elements.orgTypeSelect.options).forEach(opt => {
							opt.selected = (opt.value === org.organizationType);
						});
					}

					// Update account info
					if (org.createdAt) {
						elements.createdAt.textContent = new Date(org.createdAt).toLocaleString();
					}
					if (org.lastLogin) {
						elements.lastLogin.textContent = new Date(org.lastLogin).toLocaleString();
					}

					// Update recovery phone number display
					const displayPhoneNumber = document.getElementById('displayPhoneNumber');
					if (displayPhoneNumber) {
						displayPhoneNumber.textContent = org.phone || 'Not set';
					}

					// Update completeness
					updateCompleteness(org);

					// Render activity log
					renderActivityLog(org);

					// Render documents
					renderDocuments(org);

				} catch (error) {
					console.error('Failed to load profile:', error);
					showMessage('error', 'Failed to load profile. Please try again.');
				} finally {
					setLoading(false);
				}
			}

			// Logo upload
			const logoUploadBtn = document.getElementById('logoUploadBtn');
			const logoFileInput = document.getElementById('logoFileInput');

			if (logoUploadBtn && logoFileInput) {
				logoUploadBtn.addEventListener('click', () => logoFileInput.click());

				logoFileInput.addEventListener('change', function (e) {
					const file = e.target.files[0];
					if (file) {
						// Validate file
						if (!validateFile(file, 10, ['image/jpeg', 'image/png', 'image/jpg', 'image/webp'])) {
							showMessage('error', 'Invalid logo. Only JPG, PNG, WebP allowed (Max 10MB).');
							return;
						}

						// Preview
						const reader = new FileReader();
						reader.onload = function (ev) {
							elements.orgLogo.style.backgroundImage = `url('${ev.target.result}')`;
							elements.orgLogo.innerHTML = '';
						};
						reader.readAsDataURL(file);
					}
				});
			}

			// Document upload disabled - managed during registration and by administrators
			// (Regular users cannot manage documents after registration)

			// Form submission
			elements.orgProfileForm.addEventListener('submit', async function (e) {
				e.preventDefault();
				
				// Validate form inputs
				const validationErrors = validateFormInputs();
				if (validationErrors.length > 0) {
					showMessage('error', validationErrors.join(', '));
					return;
				}

				setLoading(true);

				try {
					// Get organization ID from profile data
					const response = await authManager.apiCall('/api/auth/profile', 'GET');
					if (!response.ok) {
						showMessage('error', 'Failed to load organization information.');
						return;
					}

					const data = await response.json();
					const org = data.data || data;
					
					if (!org || !org.id) {
						showMessage('error', 'Organization not found. Please log in again.');
						return;
					}

					// Create FormData for multipart submission
					const formData = new FormData();
					formData.append('name', elements.orgNameInput.value);
					formData.append('organizationType', elements.orgTypeSelect.value);
					formData.append('description', elements.orgDescInput.value);
					formData.append('contactEmail', elements.orgEmailInput.value);
					formData.append('contactPhone', elements.orgPhoneInput.value);
					formData.append('address', elements.orgAddressInput.value);
					
					// Add logo file if selected
					const logoFileInput = document.getElementById('logoFileInput');
					if (logoFileInput && logoFileInput.files.length > 0) {
						formData.append('logo', logoFileInput.files[0]);
					}

					const updateResponse = await authManager.apiCall(`/api/organizations/${org.id}/update-with-logo`, 'POST', formData, { isFormData: true });
					if (updateResponse.ok) {
						showMessage('success', 'Profile updated successfully!');
						await loadProfile();
					} else {
						showMessage('error', 'Failed to update profile. Please try again.');
					}
				} catch (error) {
					console.error('Error updating profile:', error);
					showMessage('error', 'Error updating profile. Please try again.');
				} finally {
					setLoading(false);
				}
			});

			// Cancel button
			elements.cancelBtn.addEventListener('click', async () => {
				await loadProfile();
				showMessage('success', 'Changes discarded.');
			});

			// Logout
			elements.logoutBtn.addEventListener('click', () => {
				authManager.logout();
				window.location.href = 'index.html';
			});

			// Load profile on page load
			loadProfile();
		});
	</script>
</body>

</html>
